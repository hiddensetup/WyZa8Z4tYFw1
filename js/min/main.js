"use strict";!function(e){var t,i,s,a,n,o,r,l,c,d,u,h,g,p,m,f,v="2.28",b=!1,_=!1,y=!1,w=[!1,!1],S=!1,x=[],k=!1,A=!1,$=[9999999,""],T=document.title,C={},B=e(window).width()<555,E=new Date,j="",I=!1,L="undefined",D=!0,M=6e4*(new Date).getTimezoneOffset(),R=!1,N=30;e.fn.extend({manualExpandTextarea:function(){var t=this[0];t.style.height="auto",t.style.maxHeight="25px",window.getComputedStyle(t),t.style.height=(t.scrollHeight>350?350:t.scrollHeight)+"px",t.style.maxHeight="",e(t).trigger("textareaChanged")},autoExpandTextarea:function(){var t=this[0];t.addEventListener("input",(function(i){e(t).manualExpandTextarea()}),!1)}}),function(){String.prototype.autoLink=function(){var e,t,i;return i=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|]+)/gi,e=arguments.length>0?[].slice.call(arguments,0)[0]:{},t=function(){var t=[];for(var i in e)"callback"!==i&&t.push(" "+i+"='"+e[i]+"'");return t.join("")}(),this.replace(i,(function(i,s,a){if(a.match(/maps.google.com/g)){var n=a.match(/q=([\d.-]+),([\d.-]+)/);return n?"<iframe width='270' height='270' frameborder='0'  style='margin:0px -21px -4px -7px; border-radius:4px; border: 0; width: auto;' src='https://maps.google.com/maps?q="+n[1]+","+n[2]+"&amp;output=embed'></iframe>":"<iframe width='270' height='270' frameborder='0' style='border:0;' src='https://maps.google.com/maps?q=-00.000000,-00.000000&amp;output=embed'></iframe>"}return s+("function"==typeof e.callback?e.callback(a):"")+"<a href='"+a+"'"+t+">"+a+"</a>"+("function"==typeof e.callback?"":" ")}))}}.call(this);var U={ajax:function(t,i=!1){t["login-cookie"]=this.loginCookie(),!("user_id"in t)&&G()&&(t.user_id=G().id),"language"in t||typeof SB_LANG==L||(t.language=SB_LANG),R&&(t.cloud=R),e.ajax({method:"POST",url:SB_AJAX_URL,data:t}).done((e=>{let s;if(Array.isArray(e))s=e;else try{s=JSON.parse(e)}catch(i){return V.is_busy_update=!1,V.busy(!1),void U.error(e.length>500?e.substr(0,500)+"... Check the console for more details.":e,`SBF.ajax.${t.function}`)}"success"==s[0]?i&&i(s[1]):U.errorValidation(s)?i&&i(s):(b&&"security-error"==s[1]&&setTimeout((()=>{U.reset()}),1e3),V.is_busy_update=!1,V.busy(!1),U.error(s[1]+(U.null(s[2])?"":"\nFunction name: "+s[2])+(U.null(s[3])?"":"\nError message: "+("string"==typeof s[3]?s[3]:"error"in s[3]&&"message"in s[3].error?`${s[3].error.message} in function '${s[3].error.function}'`:s[3])),`SBF.ajax.${t.function}`))}))},cors:function(e="GET",t,i){let s=new XMLHttpRequest;if("withCredentials"in s)s.open(e,t,!0);else{if(typeof XDomainRequest==L)return!1;s=new XDomainRequest,s.open(e,t)}s.onload=function(){i(s.responseText)},s.onerror=function(){return!1},s.send()},upload:function(e,t){R&&e.append("cloud",R),jQuery.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:e,type:"POST",success:function(e){t(e)}})},getHostname:function(e){return new URL(e).hostname.replace("www.","")},limitText:function(e,t){let i=null!=e?e.slice(0,t):"";return i.length>t-1?i+"...":i},UTC:function(e){return new Date(e).getTime()-M},null:function(e){return typeof e===L||null===e||"null"===e||!1===e||!(e.length>0||"number"==typeof e||typeof e.length==L)||e===L},deactivateAll:function(){i.find(".sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul").sbActive(!1)},deselectAll:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getURL:function(e=!1,t=!1){if(0==t&&(t=location.search),0==e){for(var i=t.split("?").pop().split("&"),s={},a=0;a<i.length;a++){var n=i[a].split("=");s[n[0]]=U.escape(n[1])}return s}return t.indexOf("?")>0&&(t=t.substr(0,t.indexOf("?"))),U.escape(decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(t)||[,""])[1].replace(/\+/g,"%20")||""))},URL:function(){return window.location.href.substr(0,window.location.href.indexOf("?"))},stringToSlug:function(e){e=(e=e.trim()).toLowerCase();for(var t="åàáãäâèéëêìíïîòóöôùúüûñç·/_,:;",i=0;i<30;i++)e=e.replace(new RegExp(t.charAt(i),"g"),"aaaaaaeeeeiiiioooouuuunc------".charAt(i));return e.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g,"")},slugToString:function(e){return(e=e.replace(/_/g," ").replace(/-/g," ")).charAt(0).toUpperCase()+e.slice(1)},random:function(){let e="";for(var t=5;t>0;--t)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return e},isAgent:function(e){return"agent"==e||"admin"==e||"bot"==e},beautifyTime:function(e,t=!1,i=!1){let s;if("0000-00-00 00:00:00"==e)return"";if(e.indexOf("-")>0){let t=e.split(/[- :]/);s=new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])}else{let t=e.split(/[. :]/);s=new Date(t[2],t[1]-1,t[0],t[3],t[4],t[5])}let a=new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate(),s.getHours(),s.getMinutes(),s.getSeconds())),n=Math.round((new Date-a)/864e5)*(i?-1:1),o=[F("Sunday"),F("Monday"),F("Tuesday"),F("Wednesday"),F("Thursday"),F("Friday"),F("Saturday")],r=a.toLocaleTimeString(navigator.language,{hour:"2-digit",minute:"2-digit",hour12:!1});return n<1?t?`<span>${F("Today")}</span> <span>${r}</span>`:`<span style="text-transform: uppercase;" data-today>${r}</span>`:n<3?`<span>${o[a.getDay()]}</span>${t?` <span>${r}</span>`:""}`:`<span>${a.toLocaleDateString()}</span>${t?` <span>${r}</span>`:""}`},unix:function(e){let t=e.split(/[- :]/);return Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5])},getLocationTimeString:function(e,t){if("timezone"in e){let i={};i.timezone=e.timezone.value,i.country="country"in e?e.country.value:i.timezone.split("/")[0].replace(/_/g," "),i.city="city"in e?e.city.value:i.timezone.split("/")[1].replace(/_/g," "),U.cors("GET","https://worldtimeapi.org/api/timezone/"+i.timezone,(function(e){if(e=JSON.parse(e),U.null(e)||!U.null(e.error))U.error(e,"SBF.getLocationTimeString()"),t(responseonSuccess);else{let s=e.datetime.replace("T"," ");t(`${new Date(s.substr(0,s.indexOf("."))).toLocaleString([],{hour:"2-digit",minute:"2-digit"})} ${F("in")} ${i.city?i.city:""}${i.country?", "+i.country:""}`)}}))}},dateDB:function(e){return"now"==e?((e=(new Date).toISOString().replace("T"," ")).indexOf(".")>0&&(e=e.substr(0,e.indexOf("."))),e):`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`},localTime:function(e,t){return 0!=e?U.getTimezoneOffset(t)==(new Date).getTimezoneOffset()?e:moment(e).format("MM/DD/YYYY hh:mm A"):""},getTimezoneOffset:function(e){let t=new Date,i=t.toLocaleString("en-US",{timeZone:e}),s=new Date(i),a=new Date(t.getTime()),n=Math.round((s.getTime()-a.getTime())/6e4);return t.getTimezoneOffset()-n},updateUsersActivity:function(e,t,i){O.active?i(O.online_ids.includes(t)?"online":"offline"):U.ajax({function:"update-users-last-activity",user_id:e,return_user_id:t},(e=>{i("online"===e?"online":"offline")}))},search:function(e,t){(e=e.toLowerCase())!=a?(clearTimeout(y),y=setTimeout((function(){a=e,t()}),200)):i.find(".sb-search-btn i").sbLoading(!1)},searchClear:function(t,i){e(t).next().val()&&(e(t).next().val(""),i())},error:function(e,t){if(!b||!SBAdmin.is_logout)throw e instanceof Error&&(e=e.message),"."==e[e.length-1]&&(e=e.slice(0,-1)),e.includes("Routin.bot error")&&(e=e.replace("Routin.bot error ","").replace("]:","]")),b&&e&&!t.includes("update-users-last-activity")&&!t.startsWith("security-error")&&SBAdmin.dialog(`[Error] [${t}] ${e}. Check the console for more details.`,"info"),i.find(".sb-loading").sbLoading(!1),U.event("SBError",{message:e,function_name:t}),new Error(`Routin.bot error [${t}]: ${e}.`)},errorValidation:function(e,t=!0){return Array.isArray(e)&&"validation-error"===e[0]&&(!0===t||e[1]==t)},loginForm:function(t,i=!1,s=!1){if(!(t=e(t)).sbLoading()){i=!1===i?t.closest(".sb-rich-login"):e(i);let a=e.trim(i.find("#email input").val()),n=e.trim(i.find("#password input").val());""==a||""==n?i.find(".sb-info").html(F("Please insert email and password.")).sbActive(!0):(U.ajax({function:"login",email:a,password:n},(e=>{if(e&&Array.isArray(e))if(!b&&this.isAgent(e[0].user_type))J.showErrorMessage(i,"You cannot sign in as an agent."),V.scrollBottom();else{let t=new P(e[0]);t.set("conversation_id",!!V.conversation&&V.conversation.id),this.loginCookie(e[1]),this.event("SBLoginForm",t),s&&s(e)}else i.find(".sb-info").html(F("Invalid email or password.")).sbActive(!0),b||V.scrollBottom();t.sbLoading(!1)})),i.find(".sb-info").html("").sbActive(!1),t.sbLoading(!0))}},loginCookie:function(e=!1){if(!1===e)return this.cookie("sb-login")?this.cookie("sb-login"):q("login");C.cloud?q("login",e):this.cookie("sb-login",e,2,"set")},login:function(e="",t="",i="",s="",a=!1){U.ajax({function:"login",email:e,password:t,user_id:i,token:s},(e=>!(0==e||!Array.isArray(e))&&(this.loginCookie(e[1]),a&&a(e),!0)))},logout:function(e=!0){V.stopRealTime(),this.cookie("sb-login","","",!1),q("open-conversation",""),q("login",""),V.conversations=!1,G(!1),typeof sb_beams_client!==L&&sb_beams_client.stop(),U.ajax({function:"logout"},(()=>{U.event("SBLogout"),e&&setTimeout((()=>{location.reload()}),500)}))},activeUser:function(){return G()},getReply:function(e){return new RegExp("^([{,+,0-9,}]+[@s.whatsapp.net])").test(e)},getActiveUser:function(e=!1,t){let i=X.login();!i&&(q("wp-login")||q("whmcs-login")||q("perfex-login")||q("aecommerce-login"))&&(this.cookie("sb-login","","","delete"),G(!1),q("login","")),U.ajax({function:"get-active-user",db:e,login_app:JSON.stringify(i),user_token:U.getURL("token")},(e=>{if(!e)return t(),!1;if("cookie"in e&&U.loginCookie(e.cookie),"user_type"in e)if(!b&&U.isAgent(e.user_type)){let e="Cierra sesión o utiliza otro navegador para  ver el botón de chat o iniciar sesión como usuario registrado. Puedes deslogearte escribiendo SBF.reset() en la consola del navegador.";q("double-login-alert")||(q("double-login-alert",!0),alert(e)),console.warn("Routin.bot: "+e),U.event("SBDoubleLoginError")}else G(new P(e,"phone"in e?{phone:e.phone}:{})),O.start(),i&&q(i[1]+"-login",!0),t(),U.event("SBActiveUserLoaded",e)}))},reset:function(){let e=["sb-login","sb-cloud","sb-dialogflow-disabled"];for(var t=0;t<e.length;t++)this.cookie(e[t],"",0,!1);try{localStorage.removeItem("routin-storage")}catch(e){}this.logout()},lightbox:function(s){let a=e(b?i:t).find(".sb-lightbox-media");a.sbActive(!0).find(" > div").html(s),b&&(SBAdmin.open_popup=a)},storage:function(e,t=L){try{if(typeof localStorage==L)return!1}catch(e){return!1}let i=localStorage.getItem("routin-storage");if(i=null===i?{}:JSON.parse(i),t===L)return e in i&&i[e];t?i[e]=t:delete i[e],localStorage.setItem("routin-storage",JSON.stringify(i))},storageTime:function(e,t=!1){if(!1!==t)return 0==q(e)||E.getTime()-q(e)>36e5*t;q(e,E.getTime())},cookie:function(e,t=!1,i=!1,s="get",a=!1){let n="https:"==location.protocol?"SameSite=None;Secure;":"",o=window[b?"SB_ADMIN_SETTINGS":"CHAT_SETTINGS"],r=o&&o["cookie-domain"]?"domain="+o["cookie-domain"]+";":"";if("get"==s){if(!D)return this.storage(e);let t=document.cookie.split(";");for(var l=0;l<t.length;l++){for(var c=t[l];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(e)){let t=c.substring(e.length+1,c.length);return!this.null(t)&&t}}return!1}if("set"==s)if(D){let s=new Date;s.setTime(s.getTime()+i*(a?1:86400)*1e3),document.cookie=e+"="+t+";expires="+s.toUTCString()+";path=/;"+n+r}else this.storage(e,t);else this.cookie(e)&&(D?document.cookie=e+"="+t+";expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;"+n+r:this.storage(e,""))},setting:function(e){return typeof C!==L&&e in C&&C[e]},get_select_setting:function(){const e=[{name:"rate-and-review",id:"rate-review",type:"one"},{name:"label-names",id:"label-names",type:"one"},{name:"whatsapp-cloud",id:"cloud-active",type:"one"}];o&&U.ajax({function:"get-select-setting",setting:e},(e=>{g=e;U.admin_set("rate-and-review")}))},admin_set:function(e=!1){return!!g&&(e?!(0===Object.keys(g).length||!g.hasOwnProperty(e))&&g[e]:g)},get_value:function(e){return e instanceof Array&&e.length>0?e[0]:e},shortcode:function(e){return H.shortcode(e)},event:function(t,i){e(document).trigger(t,i);let s=b?typeof SB_ADMIN_SETTINGS!==L&&SB_ADMIN_SETTINGS.webhooks:C.webhooks,a={SBSMSSent:"sms-sent",SBLoginForm:"login",SBRegistrationForm:"registration",SBUserDeleted:"user-deleted",SBEmailSent:"email-sent",SBNewMessagesReceived:"new-message",SBNewConversationReceived:"new-conversation",SBActiveConversationStatusUpdated:"conversation-status-updated",SBMessageDeleted:"message-deleted",SBRichMessageSubmit:"rich-message",SBNewEmailAddress:"new-email-address"};if(s&&t in a){if(!0!==s&&(Array.isArray(s)||(s=s.replace(/ /g,"").split(",")),!s.includes(a[t])))return;U.ajax({function:"webhooks",function_name:t,parameters:i})}},translate:function(e){if(!b&&U.null(C)||b&&typeof SB_TRANSLATIONS===L)return e;let t=b?SB_TRANSLATIONS:C.translations;return t&&e in t?""==t[e]?e:t[e]:e},escape:function(e){return e?e.replaceAll("<script","&lt;script").replaceAll("</script","&lt;/script").replaceAll("javascript:","").replaceAll("onclick=","").replaceAll("onerror=",""):e},visibilityChange:function(e=""){"hidden"==e?(b||V.stopRealTime(),V.tab_active=!1):(G()&&!b&&V.startRealTime(),V.tab_active=!0,clearInterval(S),document.title=T)},settingsStringToArray:function(e){if(this.null(e))return[];let t=[];e=e.split(",");for(var i=0;i<e.length;i++){let s=e[i].split(":");t[s[0]]="false"!=s[1]&&("true"==s[1]||s[1])}return t},openWindow:function(e,t=550,i=350){let s=screen.width/2-t/2,a=screen.height/2-i/2;return window.open(e,"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+t+",height="+i+", top="+a+", left="+s),!1},convertUTCDateToLocalDate:function(e,t=0){return e=new Date(e),e=new Date(e.getTime()+36e5*t),new Date(e.getTime()+-1*M)},loadResource:function(e,t=!1){let i=document.getElementsByTagName("head")[0],s=document.createElement(t?"script":"link");t?s.src=e+"?v="+v:(s.id="routin",s.rel="stylesheet",s.type="text/css",s.href=e+"?v="+v,s.media="all"),i.appendChild(s)},uploadResponse:function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1]){let e="The file you are trying to upload has an extension that is not allowed.";b?SBAdmin.dialog(e,"info"):alert(e)}else if(e(s).hasClass("sb-input-image"))e(s).find(".image").attr("data-value","").css("background-image",""),setTimeout((()=>{e(s).find(".image").attr("data-value",t[1]).css("background-image",`url("${t[1]}?v=${U.random()}")`).append('<i class="bi-x-lg"></i>'),s=!1}),500);else{let e=t[1].substr(t[1].lastIndexOf("/")+1),i="";const s=/\.(jpg|jpeg|png|gif|bmp|)$/.test(t[1].toLowerCase()),a=/\.(mp3|ogg)$/.test(t[1].toLowerCase()),n=/\.(docx|pptx|xlsx|doc|ppt|xls)$/.test(t[1].toLowerCase());i=s?`<div data-name="${e}" data-value="${t[1]}" data-id="${t[2]}">\n                                    <img style="border-radius: .4rem; width: 33px; vertical-align: middle;object-fit:cover;" src="${t[1]}" width="30" height="30">\n                                     ${e}<i class="bi-x-lg"></i>\n                                  </div>`:a?`<div style="display:flex;flex-direction:row;align-items: center;" data-name="${e}" data-value="${t[1]}" data-id="${t[2]}">\n                                    <audio controls style="max-width: 100%; max-height: 33px; border-radius: var(--chat-rounded-size-6);">\n                                      <source src="${t[1]}" type="audio/${t[1].split(".").pop()}">\n                                      Your browser does not support the audio element.\n                                    </audio>\n                                    <i class="bi-x-lg"></i>\n                                  </div>`:n?`<div data-name="${e}" data-value="${t[1]}" data-id="${t[2]}">\n                                    <i class="bi bi-file-earmark-text-fill" style="font-size:1.89rem; color: var(--chat-text-primary)"></i>\n                                     <i class="bi-x-lg"></i>\n                                  </div>`:`<div data-name="${e}" data-value="${t[1]}" data-id="${t[2]}">\n                                     ${e}<i class="bi-x-lg"></i>\n                                  </div>`,o.find(".sb-attachments").append(i),V.activateBar()}else U.error(t[1],"sb-upload-files.change");this.busy=function(e){}},debounce:function(e,t,i=500){t in x||(x[t]=!0,e(),setTimeout((()=>{delete x[t]}),i))}},O={channels:{},channels_presence:[],active:!1,pusher:!1,started:!1,pusher_beams:!1,initialized:!1,online_ids:[],init_push_notifications:!1,sw:!1,init:function(t=!1){if(O.active){if(this.pusher)return!t||t();if(!t)return;e(window).one("SBPusherInit",(()=>{t()})),this.initialized=!0,e.getScript("https://js.pusher.com/7.0/pusher.min.js",(()=>{this.pusher=new Pusher(b?SB_ADMIN_SETTINGS["pusher-key"]:C["pusher-key"],{cluster:b?SB_ADMIN_SETTINGS["pusher-cluster"]:C["pusher-cluster"],authEndpoint:STMBX_URL+"/include/pusher.php",auth:{params:{login:U.loginCookie()}}}),U.event("SBPusherInit")}))}},initPushNotifications:function(){(G()||b)&&e.getScript("https://js.pusher.com/beams/1.0/push-notifications-cdn.js",(()=>{window.navigator.serviceWorker.ready.then((e=>{this.pusher_beams=new PusherPushNotifications.Client({instanceId:b?SB_ADMIN_SETTINGS["push-notifications-id"]:C["push-notifications-id"],serviceWorkerRegistration:e}),this.pusher_beams.start().then((e=>e.getDeviceId())).then((e=>console.log("Successfully registered with Beams. Device ID:",e))).then((()=>this.pusher_beams.setDeviceInterests(b?[SB_ACTIVE_AGENT.id,"agents"]:[G().id,"users"]))).catch(console.error),this.init_push_notifications=!1}))}))},initServiceWorker:function(){"serviceWorker"in navigator&&(navigator.serviceWorker.register(b||"undefined"!=typeof SB_CLOUD_SW?STMBX_URL+"/sw.js?v="+v:C["push-notifications-url"]+"?v="+v).then((e=>{e.update(),this.sw=e})).catch((function(e){console.warn(e)})),navigator.serviceWorker.onmessage=function(e){b?e.data.conversation_id?(SBAdmin.conversations.openConversation(e.data.conversation_id,e.data.user_id),SBAdmin.conversations.update()):e.data.user_id&&(SBAdmin.profile.show(e.data.user_id),V.audio.play()):"sb-open-chat"==e.data&&V.open()})},start:function(){b||this.started||!G()||(this.active&&this.init((()=>{this.event("client-typing",(e=>{e.user_id==V.agent_id&&V.conversation&&e.conversation_id==V.conversation.id&&(V.typing(-1,"start"),clearTimeout(y),y=setTimeout((()=>{V.typing(-1,"stop")}),1e3))})),this.event("new-message",(e=>{!e||!G()||U.null(e.conversation_id)||G().getConversationByID(e.conversation_id)||V.conversation&&V.conversation.id==e.conversation_id?V.update():V.updateConversations()})),this.presence(1,(()=>{this.started=!0,V.automations.run_all()}))})),C["push-notifications"]&&(typeof Notification!=L&&"granted"==Notification.permission?this.initPushNotifications():this.init_push_notifications=!0))},subscribe:function(e,t=!1){if(!this.pusher)return this.init((()=>{this.subscribe(e,t)}));e=this.cloudChannelRename(e);let i=this.pusher.subscribe(e);i.bind("pusher:subscription_error",(e=>console.log(e))),i.bind("pusher:subscription_succeeded",(()=>{this.channels[e]=i,t&&t()}))},event:function(e,t,i="private-user-"+G().id){if(!this.pusher)return this.init((()=>{this.event(e,t,i)}));let s=i;(i=this.cloudChannelRename(i))in this.channels?(this.channels[i].unbind(e),this.channels[i].bind(e,(e=>{t(e)}))):this.subscribe(s,(()=>{this.event(e,t,s)}))},trigger:function(e,t={},i="private-user-"+G().id){if(0==e.indexOf("client-"))return this.channels[this.cloudChannelRename(i)].trigger(e,t);U.ajax({function:"pusher-trigger",channel:i,event:e,data:t},(e=>e))},presence:function(e=1,t){if(!this.pusher)return this.init((()=>{this.presence()}));let i=this.pusher.subscribe(this.cloudChannelRename("presence-"+e));i.bind("pusher:subscription_succeeded",(i=>{if(i.count>98)return this.subscribe(e+1);i.each((e=>{this.presenceCheck(e)&&this.online_ids.push(e.id)})),V.updateUsersActivity(),t&&t()})),i.bind("pusher:subscription_error",(e=>console.log(e))),i.bind("pusher:member_added",(e=>{this.presenceCheck(e)&&this.presenceAdd(e.id),b&&SBAdmin.users.onlineUserNotification(e)})),i.bind("pusher:member_removed",(e=>{this.presenceRemove(e.id)})),this.channels_presence.push(i)},presenceCheck:function(e){let t=U.isAgent(e.info.user_type);return(b&&!t||!b&&t)&&!this.online_ids.includes(e.id)},presenceAdd:function(e){typeof e==L||this.online_ids.includes(e)||(this.online_ids.push(e),this.presenceUpdateAdmin(e),V.updateUsersActivity())},presenceRemove:function(e){if(typeof e==L)return;let t=this.online_ids.indexOf(e);-1!==t?(this.online_ids.splice(t,1),this.presenceUpdateAdmin(e),V.updateUsersActivity()):b&&i.find(`.sb-conversation-busy[data-agent="${e}"]`).remove()},presenceUnsubscribe:function(){for(var e=0;e<this.channels_presence.length;e++)this.channels_presence[e].unsubscribe(this.cloudChannelRename("presence-"+(e+1)))},presenceUpdateAdmin:function(e){b&&(i.find(".sb-area-users.sb-active").length&&SBAdmin.users.update(),G()&&G().id==e&&SBAdmin.users.updateUsersActivity())},pushNotification:function(e){let t=b?SB_ACTIVE_AGENT.profile_image:G().image;U.ajax({function:"push-notification",title:b?SB_ACTIVE_AGENT.full_name:G().name,message:(new z).strip(e),icon:t.indexOf("user.svg")>0?C["notifications-icon"]:t,interests:V.getRecipientUserID(),conversation_id:0!=V.conversation&&V.conversation.id},(e=>e))},cloudChannelRename:function(e){return C.cloud||b&&SB_ADMIN_SETTINGS.cloud?e+"-"+(b?SB_ADMIN_SETTINGS.cloud.cloud_user_id:C.cloud.cloud_user_id):e}};function q(e,t=L){return U.storage(e,t)}function F(e){return U.translate(e)}function G(e=-1){if(-1===e)return window.sb_current_user;window.sb_current_user=e}window.SBF=U,window.SBPusher=O,window.sb_current_user=!1,e.fn.sbActive=function(t=-1){return-1===t?e(this).hasClass("sb-active"):(e(this).setClass("sb-active",t),this)},e.fn.sbLoading=function(t="check"){return"check"==t?e(this).hasClass("sb-loading"):(e(this).setClass("sb-loading",t),this)},e.fn.sbTogglePopup=function(t=!1){let s=!0;return b&&(SBAdmin.open_popup=!1),e(this).sbActive()?(e(this).sbActive(!1),i.removeClass("sb-popup-active"),s=!1):(i.addClass("sb-popup-active"),i.find(".sb-popup").sbActive(!1),t&&(e(this).css("left","325.6px"),e(this).sbActive(!0)),b&&setTimeout((()=>{SBAdmin.open_popup=this}),500),U.deselectAll()),s},e.fn.sbUploadFiles=function(t){let i=e(this).prop("files");for(var s=0;s<i.length;s++){let e=i[s],a=new FormData;a.append("file",e),U.upload(a,t)}e(this).value=""},e.fn.setProfile=function(t=!1,i=!1){return U.null(t)&&(t=G()?G().name:""),U.null(i)&&(i=G()?G().image:STMBX_URL+"/media/user.svg"),e(this).find("img").attr("src",i),e(this).find(".sb-name").html(t),this},e.fn.setClass=function(t,i=!0){return i?e(this).addClass(t):e(this).removeClass(t),this};class P{constructor(e={},t={}){this.details=e,this.extra=t,this.conversations=[],this.processArray(e)}get id(){return""==this.get("id")?this.get("user_id"):this.get("id")}get type(){return this.get("user_type")}get name(){return"first_name"in this.details?this.details.first_name+(this.details.last_name?" "+this.details.last_name:""):""}get nameBeautified(){return"last_name"in this.details&&"#"!=this.details.last_name.charAt(0)?this.name:C["visitor-default-name"]}get image(){return this.get("profile_image")}get language(){let e=this.getExtra("language");return e||(e=this.getExtra("browser_language")),e?e.value.toLowerCase():""}get(e){return e in this.details&&!U.null(this.details[e])?this.details[e]:""}getExtra(e){return e in this.extra&&!U.null(this.extra[e])?this.extra[e]:""}set(e,t){this.details[e]=t}setExtra(e,t){this.extra[e]=t}processArray(e){if(e&&"details"in e){for(var t=0;t<e.details.length;t++)this.setExtra(e.details[t].slug,e.details[t]);delete e.details,this.details=e}}update(e){this.id?U.ajax({function:"get-user",user_id:this.id,extra:!0},(t=>{this.processArray(t),e()})):U.error("Missing user ID","SBUser.update")}getConversations(e=!1,t){this.id?U.ajax({function:"get-user-conversations",user_id:this.id,exclude_id:t,agent:U.isAgent(this.type)},(t=>{let i=[];for(var s=0;s<t.length;s++){let e=t[s].conversation_status_code;if(3!=e||!C["close-chat"]){let a=new W([new z(t[s])],{id:t[s].conversation_id,conversation_status_code:e,department:t[s].department,agent_id:t[s].agent_id,title:t[s].title});i.push(a)}}this.conversations=i,e&&e(i)})):U.error("Missing user ID","SBUser.getConversations")}getConversationsCode(e=!1){let t="",i=V.conversation?V.conversation.id:-1;e||(e=this.conversations);for(var s=0;s<e.length;s++)e[s]instanceof W?t+=`<li ${i==e[s].id?'class="sb-active" ':""}data-conversation-status="${e[s].get("conversation_status_code")}" data-conversation-id="${e[s].id}" data-department="${e[s].get("department")}">${e[s].getCode()}</li>`:U.error("Conversation not of type SBConversation","SBUser.getConversationsCode");return t}getFullConversation(t=!1,i=!1,s=30,a=30){!1!==t?U.ajax({function:"get-conversation",conversation_id:t,load_chat:s,limit:a},(t=>{let s=[];if(t){if("agent-not-authorized"===t)return void(window.location.href=U.URL());for(var a=0;a<t.messages.length;a++)(f=t.total_rows)<=N&&setTimeout((()=>e(".sb-conversation").find(".load-more").hide()),300),t.messages[a].total_rows=t.total_rows,s.push(new z(t.messages[a]))}i&&i(new W(s,!!t&&t.details))})):U.error("Missing conversation ID","SBUser.getFullConversation")}getConversationByID(e,t=!1){for(var i=0;i<this.conversations.length;i++)if(this.conversations[i].id==e)return t?i:this.conversations[i];return!1}addConversation(e){if(e instanceof W){let i=e.id,s=!0;for(var t=0;t<this.conversations.length;t++)if(this.conversations[t].id==i){this.conversations[t]=e,s=!1;break}return s&&this.conversations.unshift(e),s}U.error("Conversation not of type SBConversation","SBUser.addConversation")}removeConversation(e){let t=this.getConversationByID(e,!0);!1!==t&&this.conversations.splice(t,1)}getLastConversation(){return!this.isConversationsEmpty()&&this.conversations[this.conversations.length-1]}isConversationsEmpty(){return 0==this.conversations.length}isExtraEmpty(){return 0===Object.keys(this.extra).length&&this.extra.constructor===Object}delete(e){this.id?U.ajax({function:"delete-user",user_id:this.id},(()=>(U.event("SBUserDeleted",this.id),console.log("delte user"),e(),!0))):U.error("Missing user ID","SBUser.delete")}}window.SBUser=P;class z{constructor(e={}){this.details=e,this.linksData="","first_name"in this.details&&(this.details.full_name=this.details.first_name+" "+this.details.last_name),e.message_status_code&&(e.status_code=e.message_status_code),delete e.message_status_code,delete e.source,delete e.extra,delete e.title,delete e.tags,delete e.labels,delete e.agent_id,delete e.department;let t=this.get("payload");if(t)try{var i=JSON.parse(this.get("payload").replace("\\'","'"));t=i&&"object"==typeof i?i:{}}catch(e){t={}}else t={};this.set("payload",t)}get id(){return this.get("id")}get attachments(){return U.null(this.details.attachments)?[]:JSON.parse(this.details.attachments)}get message(){return this.get("message")}get(e){return e in this.details&&!U.null(this.details[e])?this.details[e]:""}set(e,t){this.details[e]=t}payload(e=!1,t=!1){let i=this.get("payload");if(!1!==e&&!1!==t)i[e]=t,this.set("payload",i);else if(!1!==e)return e in i?i.key:"id"in i&&i.id==e&&i;return i}getLoad(){return N}setLoad(e){N=e}getCode(t=!1){let i=U.isAgent(this.details.user_type),s=b?SBAdmin.conversations.messageMenu(i):"",a=t?this.get("translation"):!this.message&&"preview"in this.payload?this.payload.preview:this.message,n=this.attachments,o="",r="",l=b&&SB_ADMIN_SETTINGS["show-profile-images"]||!b&&(i&&!C["hide-agents-thumb"]||!i&&C["display-users-thumb"])?`<div class="sb-thumb"><img loading="lazy" src="${this.details.profile_image}"><div class="sb-tooltip"><div>${this.details.full_name}</div></div></div>`:"",c=(i?"sb-right":"")+(""==l?"":" sb-thumb-active"),d="";if(!a&&!n.length)return"";const u=this.payload();if(u.latitude&&u.longitude)u.latitude,u.longitude;let h=new RegExp("^([{,+0-9]+[@s.whatsapp.net])").test(a);if(i&&!h){let e=a.match(/\[.+?\]/g)||[],t=!1,i=e.length;for(var g=0;g<i;g++){let i=H.shortcode(e[g]),s=H.generate(i[1],i[0]);s&&("["!=a.charAt(0)&&(s=s.replace("sb-rich-message","sb-rich-message sb-margin-top")),"]"!=a.charAt(a.length-1)&&(s=s.replace("sb-rich-message","sb-rich-message sb-margin-bottom")),a=a.replace(e[g],"{{RM}}"),a=this.render(a).replace("{{RM}}",s),t=!0,d=`data-type="${i[0]}"`)}t&&(c+=" sb-rich-cnt",i>1&&(d='data-type="multiple"')),i||(a=this.render(a))}else a=this.render(a);if(n.length){o='<div style="padding-top: 0px" class="sb-message-attachments">';for(g=0;g<n.length;g++){let e=n[g][1];if(/.jpg|.jpeg|.png|.webp|.gif/.test(e)){let t=e.includes(".webp")?"box-shadow:none;width: 100px;":"width: auto; height: auto;";r+=`<div style="display:flex;margin-bottom: 6px;flex-wrap: wrap;flex-direction: column;" class="sb-image${e.includes(".png")?" sb-image-png":""}"><img style="object-fit: cover; border-radius: 8px; ${t}" loading="lazy" src="${e}" /></div>`}else"oga"===n.toString().substr(n.length-4)||"mp3"===n.toString().substr(n.length-4)||"ogg"===n.toString().substr(n.length-4)||"amr"===n.toString().substr(n.length-4)?r+=`<audio controls style="max-width:100%;border-radius:8px;margin-bottom: 8px;background:#f1f3f4;"><source src="${e}" type="audio/mpeg"></audio></a>`:"mp4"===n.toString().substr(n.length-4)?r+=`<video width="auto" controls style="object-fit: cover;width:100%;border-radius:var(--chat-rounded-size-8);"><source src="${e}"  type="video/mp4"></video></a>`:r+=""+(e?`<a rel="noopener" style="padding-right: var(--chat-spacing-size-1-4);text-decoration:none;padding-left: var(--chat-spacing-size-5);" target="_blank" class="sb-message" href="${e}"><i class="bi-file-text"></i> ${n[g][0]}</a>`:" ")}o+="</div>"}var p="";if(a.includes("〚")){var m=G().name,f=G().getExtra("phone").value,v="";if(Number(f)>0)if(a.includes(f))a=a.replace(f,m);else{var _=a.indexOf("}");a=a.substring(_+1),v="alt"}else if(f=e(document).find("body > div > main > div.sb-active.sb-area-conversations > div > div.sb-user-details.sb-top > div.sb-scroll-area > div.sb-profile-list.sb-profile-list-conversation > ul > li:nth-child(8) > label").innerText,a.includes(f))a=a.replace(f,m);else{_=a.indexOf("}");a=a.substring(_+1),v="alt"}a=a.replace(/<br\s*\/?>/,""),a=a.replace("〚","alt"==v?"<div id='sb-reply-to-alt'><strong id='sb-reply-top-name-alt'>Tú</strong><br>":`<div id='sb-reply-to'><strong id='sb-reply-top-name'>${m}</strong><br>`),a=a.replace("〛","</div><p style='padding: 0px 4px; margin:0px; cursor:pointer;'>"),a=a.replace(/\|(?=\n)/,"</div>"),a=a.replace(/<p\s*\/?>\s*<p\s*\/?>/g,""),a=a.replace("{",""),a=a.replace("@s.whatsapp.net}",""),a.startsWith(m)&&(a=a.substring(m.length).trim()),p=`<div data-id="${this.details.id}" ${d} class="sb-shadow-conversation ${c}">${l}\n              <div class="sb-cnt" style="min-width:80px; max-width:100%; padding:4px 4px;">\n                <div class="sb-message" data-value="${this.linksData?encodeURI(this.linksData.message):encodeURI(a)}">\n                  ${r}\n                  <div style="max-width:30rem; margin:0px; text-align:start; cursor:pointer;" class="readThis">\n                    ${this.linksData?this.linksData.message:a.replace(/\|/g," ")}\n                  </div>\n                </div>\n                ${o}\n                <div class="menu-bubble">\n                  <div class="events"></div>\n                  <div class="sb-time">\n                    ${U.beautifyTime(this.details.creation_time,!0)}\n                  </div>\n                </div>\n              </div>\n              ${s}\n            </div>`}else p=`<div data-id="${this.details.id}" ${d}  class="sb-shadow-conversation ${c}"  style="transition: 0.3s all">${l}\n        <div class="server-response"> <i class="bi-check2-all"></i></div>\n\t\t\t\t  <div class="sb-cnt" style="width:fit-content;margin:6px;">\n                 \n\t\t\t\t  <div class="sb-message" data-value="${this.linksData?encodeURIComponent(this.linksData.message):encodeURIComponent(a)}">\n\t\t\t\t  ${r}\n\t\t\t\t \n\t\t\t\t  <div style="padding-right: var(--chat-spacing-size-1-4);text-decoration:none;padding-left: var(--chat-spacing-size-5);">\n\t\t\t\t\t${this.linksData?this.linksData.message:a.replace(/\|/g," ")}\n\t\t\t\t  </div>\n\t\t\t\t</div>\n\t\t\t\t${o}<div class="menu-bubble"><div class="sb-time">${U.beautifyTime(this.details.creation_time,!0)}</div></div>\n\t\t\t\t  </div>\n\t\t\t\t  ${s}\n\t\t\t\t</div>\n\t\t\t\n\t\t\t  `;return p}render(e=!1){!1===e&&(e=""+this.details.message);let t=e.length,i=(e=(e=e.replace(/- /g,'<li style="margin-left:5px;margin-right:0px">')+"</li>").replace(/(?:\r\n|\r|\n)/g,"<br>")).match(/```([\s\S]+?)```/g)||[];for(var s=0;s<i.length;s++){let t=`{{code_placeholder_${s}}}`;e=e.replace(i[s],t)}let a=e.match(/`([^`]+)`/g)||[];for(s=0;s<a.length;s++){let t=`{{inline_code_placeholder_${s}}}`;e=e.replace(a[s],t)}e=(e=(e=e.replace(/(?<!\*)\*(.*?)\*(?!\*)/g,"<strong>$1</strong>")).replace(/(^|\s)\_([^\_]+)\_/g,"$1<em>$2</em>")).replace(/(<li>\s*)?~([^~]+)~/g,(function(e,t,i){return t?`<li>${t}<del>${i}</del>`:`<del>${i}</del>`})),((6==t||5==t)&&e.startsWith("&#x")||t<3&&e.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/))&&(e=`<span class="emoji-large">${e}</span>`),e.includes("http")&&(e=e.autoLink({target:"_blank"}));for(s=0;s<a.length;s++){let t=`{{inline_code_placeholder_${s}}}`;e=e.replace(t,`<p style="font-family: monospace;">${a[s].substring(1,a[s].length-1)}</p>`)}for(s=0;s<i.length;s++){let t=`{{code_placeholder_${s}}}`;e=e.replace(t,`<code>${i[s].substring(3,i[s].length-3)}</code>`)}return e.replace(/&amp;lt;/g,"&lt;")}strip(e=!1){!1===e&&(e=""+this.details.message);return e=e.replace(/https:\/\/maps\.google\.com\/.*\b/g,(e=>`<i class="bi-send" style="vertical-align:middle;padding-left:10px;"></i> <span style="color: #2196F3;">${F("Location")}</span>`))}}window.SBMessage=z;class W{constructor(e,t){this.details=U.null(t)?{}:t,Array.isArray(e)?(this.messages=[],e.length&&(e[0]instanceof z?this.messages=e:U.error("Messages not of type SBMessage","SBConversation.constructor"))):U.error("Message array not of type Array","SBConversation.constructor")}get id(){return""==this.get("id")?this.get("conversation_id"):this.get("id")}get(e){if(e in this.details&&!U.null(this.details[e]))return this.details[e];if("title"==e){if(!U.null(this.details.first_name))return this.details.first_name+" "+this.details.last_name;if(this.messages.length)return this.messages[0].get("full_name")}return""}set(e,t){this.details[e]=t}getMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages[t].set("index",t),this.messages[t];return!1}getLastMessage(){for(var e=this.messages.length-1;e>-1;e--)if(this.messages[e].message||this.messages[e].attachments.length)return this.messages[e];return!1}getLastUserMessage(e=!1,t=!1){!1===e&&(e=this.messages.length-1);for(var i=e;i>-1;i--){let e=this.messages[i],s=e.get("user_type");if((e.message||e.attachments.length)&&(!t&&!U.isAgent(s)||!0===t&&("agent"==s||"admin"==s)||"bot"==t&&"bot"==s||"no-bot"==t&&"bot"!=s||"all"==t&&U.isAgent(s)))return this.messages[i].set("index",i-1),this.messages[i]}return!1}getUserMessages(e="user"){let t=[],i="user"==e?["visitor","lead","user"]:"agents"==e?["agent","admin"]:["bot"];for(var s=0;s<this.messages.length;s++)i.includes(this.messages[s].get("user_type"))&&t.push(this.messages[s]);return t}updateMessage(e,t){if(t instanceof z){for(var i=0;i<this.messages.length;i++)if(this.messages[i].id==e)return this.messages[i]=t,!0}else U.error("Message not of type SBMessage","SBConversation.updateMessage");return!1}addMessages(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]instanceof z&&this.messages.push(e[t]);else e instanceof z?this.messages.push(e):U.error("Messages not of type SBMessage","SBConversation.addMessages()");return this}getCode(){let e=this.messages.length;if(e){let t=this.messages[e-1],i=t.message;if(!1!==i.indexOf("[")){let e=i.match(/\[.+?\]/g)||[];if(e.length){let t=H.shortcode(e[0]);i=i.replace(e[0],F(U.null(t[1].message)?U.null(t[1].title)?"":t[1].title:t[1].message))}}if(U.getReply(i)){const e=i.indexOf("}");i=i.substring(e+1)}let s=this.get("title");return(!s||_&&C["tickets-conversations-title-user"])&&(s=U.isAgent(t.get("user_type"))?t.get("full_name"):F("You")),`<div class="sb-conversation-item" data-user-id="${t.get("user_id")}"><img loading="lazy" src="${t.get("profile_image")}"><div><span class="sb-name">${s}</span><span class="sb-time">${U.beautifyTime(t.get("creation_time"))}</span></div><div class="sb-message">${i.length>114?i.substr(0,114)+" ...":i}</div></div>`}return""}deleteMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages.splice(t,1),!0;return!1}searchMessages(e,t=!1){let i=[];for(var s=0;s<this.messages.length;s++){let a=this.messages[s].message;(t&&a==e||!t&&a.includes(e))&&i.push[messages[s]]}return i}getAttachments(){let e=[];for(var t=0;t<this.messages.length;t++){let s=this.messages[t].attachments;for(var i=0;i<s.length;i++){let a=s[i][1];e.push([s[i][0],a,a.substr(a.lastIndexOf(".")+1),this.messages[t].id])}}return e}}window.SBConversation=W;var V={rich_messages_list:["chips","buttons","select","inputs","table","list"],emoji_options:{range:0,range_limit:47,list:[],list_now:[],touch:!1},initialized:!1,editor_listening:!1,conversation:!1,load_message:[],is_busy:!1,is_busy_update:!1,is_busy_populate:!1,chat_open:!1,real_time:!1,agent_id:-1,agent_online:!1,user_online:!1,expanded:!1,main_header:!0,start_header:!1,desktop_notifications:!1,flash_notifications:!1,id_last_message:0,id_last_message_conversation:0,datetime_last_message_conversation:"2000-01-01 00:00:00",audio:!1,audio_out:!1,tab_active:!0,notifications:[],typing_settings:{typing:!1,sent:!1,timeout:!1},email_sent:!1,dashboard:!1,articles:!1,articles_categories:!1,skip:!1,queue_interval:!1,departments:!1,default_department:null,default_agent:null,default_tags:null,offline_message_set:!1,setActiveAgent:function(t){let i=e(".sb-admin").find(".sb-area-conversations").find("#conversation-agent"),s=i.find(`[data-id="${t}"]`);V.conversation.set("agent_id",t),i.find(" > p").attr("data-value",s.data("value")).html(s.html()).next().sbActive(!1),"agent"!=SB_ACTIVE_AGENT.user_type||SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&!t||(conversations_admin_list_ul.find(`[data-conversation-id="${V.conversation.id}"]`).remove(),SBConversations.clickFirst()),t&&V.showResponse("Agent assigned. The agent has been notified.")},assignAgent:function(e,t,i=!1){U.ajax({function:"update-conversation-agent",conversation_id:e,agent_id:t,message:V.conversation.getLastMessage().message},(e=>{i&&i(e)}))},assignAgent:function(e,t,i=!1){U.ajax({function:"update-conversation-agent",conversation_id:e,agent_id:t,message:V.conversation.getLastMessage().message},(e=>{i&&i(e)}))},showResponse:function(t,i=!1){let s=e(".sb-admin");s.find(".sb-area-conversations");var a=s.find(".sb-info-card");i?"error"==i?a.addClass("sb-info-card-error"):a.addClass("sb-info-card-info"):(a.removeClass("sb-info-card-error sb-info-card-warning sb-info-card-info"),clearTimeout(y),y=setTimeout((()=>{a.sbActive(!1)}),5e3)),a.html(`<h3>${F(t)}</h3>`).sbActive(!0)},sendMessage:function(t=-1,i="",s=[],a=!1,l=!1,c=!1){let d=m&&X.dialogflow.active(),u=!1;if(null!=V.conversation.id&&G().getFullConversation(V.conversation.id,(e=>{e.details.agent_id!=SB_ACTIVE_AGENT.id&&V.assignAgent(V.conversation.id,SB_ACTIVE_AGENT.id,(()=>{V.setActiveAgent(SB_ACTIVE_AGENT.id)}))})),!G()&&!b)return void this.addUserAndLogin((()=>this.sendMessage(t,i,s,a,l)),!0);if(!this.conversation){let e=!b&&G().getLastConversation();if(!e||"new-conversation"==j||V.default_department&&V.default_department!=e.get("department")||V.default_agent&&V.default_agent!=e.get("agent_id"))return void this.newConversation(c,t,"",[],b&&SB_ACTIVE_AGENT.department?SB_ACTIVE_AGENT.department:null,null,(()=>this.sendMessage(t,i,s,a,l)));this.openConversation(e.id),this.setConversation(e),j=!1}this.calculateLabelDateFirst(),-1==t&&(t=b?SB_ACTIVE_AGENT.id:G().id);let h=t!=p;if(!i&&!s.length){i=r.val().trim();o.find(".sb-attachments > div").each((function(){s.push([e(this).attr("data-name"),e(this).attr("data-value"),e(this).attr("data-id")])})),b&&SBAdmin.must_translate&&(X.dialogflow.translate([i],G().language,(e=>{e.length&&(l?l["original-message"]=i:l={"original-message":i},e[0].translatedText&&(i=e[0].translatedText)),this.sendMessage(t,i,s,a,l,c)})),u=!0)}if(this.busy(!0),h&&(r.val("").css("height",""),o.find(".sb-attachments").html("")),this.activateBar(!1),!u)if(!1===c&&t==p&&(c="skip"),b||!h||d||(c=2),i||s.length||l){let e={user_id:t,user:G(),conversation_id:this.conversation.id,conversation:this.conversation,conversation_status_code:c,message:i,attachments:s};U.ajax({function:"send-message",user_id:t,conversation_id:this.conversation.id,message:i,attachments:s,conversation_status_code:c,queue:!b&&C.queue&&h,payload:l,recipient_id:!!b&&G().id},(n=>{b||t!=p||(this.dashboard?this.updateConversations():this.chat_open||this.updateNotifications("add",this.conversation.id)),(b&&!this.user_online||!b&&!this.agent_online)&&this.update(),b||!h||m||(this.followUp(),this.offlineMessage()),!b&&h&&(!l||"sb-human-takeover"!=l.id&&U.null(l["skip-dialogflow"]))&&X.dialogflow.message(i,s),h&&C["language-detection"]&&this.conversation&&i.split(" ").length>1&&!U.storage("language-detection-completed")&&(U.ajax({function:"google-language-detection-update-user",user_id:t,string:i,token:X.dialogflow.token}),U.storage("language-detection-completed",!0)),!this.articles||b||!C.articles||C["office-hours"]||this.isInitDashboard()||setTimeout((()=>{this.conversation&&(this.sendMessage(p,"[articles]"),this.scrollBottom(),this.articles=!1)}),5e3),n.queue&&this.queue(this.conversation.id),e.message_id=n.id,U.event("SBMessageSent",e),_&&SBTickets.onMessageSent(),a&&a(e),n.notifications.length&&U.event("SBNotificationsSent",n.notifications),this.skip&&(this.skip=!1),this.busy(!1)})),h&&(i=U.escape(i),n.append(new z({id:"sending",profile_image:b?SB_ACTIVE_AGENT.profile_image:G().image,full_name:G().name,creation_time:"0000-00-00 00:00:00",message:i,user_type:b?"agent":"user"}).getCode().replace('<div class="sb-time"></div>',`<div class="sb-time">${F("Sending")}<i></i></div>`)),this.dashboard||this.scrollBottom()),(this.audio&&!b&&this.chat_open&&h&&["a","aa"].includes(C["chat-sound"])||b&&"a"==SB_ADMIN_SETTINGS.sounds)&&this.audio_out.play()}else this.busy(!1)},sendBotMessage:function(e="",t=[]){return X.dialogflow.message(e,t)},updateMessage:function(e,t=""){U.ajax({function:"update-message",message_id:e,message:t})},sendEmail:function(e,t,i=!1){let s=i?G().id:this.getRecipientUserID();if(!b&&!isNaN(s)&&this.agent_online)return!1;U.ajax({function:"create-email",recipient_id:s,sender_name:b?i?SB_ACTIVE_AGENT.full_name:G().name:i?C["bot-name"]:G().name,sender_profile_image:b?i?SB_ACTIVE_AGENT.profile_image:G().name:i?C["bot-image"]:G().image,message:e,attachments:t,department:!!this.conversation&&this.conversation.get("department"),conversation_id:!!this.conversation&&this.conversation.id},(()=>{U.event("SBEmailSent",{recipient_id:s,message:e,attachments:t})}))},sendSMS:function(e){let t=this.getRecipientUserID();if(!b&&!isNaN(t)&&this.agent_online)return!1;U.ajax({function:"send-sms",to:t,message:e,conversation_id:!!this.conversation&&this.conversation.id},(t=>{"sent"==t.status||"queued"==t.status?U.event("SBSMSSent",{recipient_id:this.getRecipientUserID(),message:e,response:t}):t.message&&U.error(t.message,"SBChat.sendSMS")}))},desktopNotification:function(e,t,i,s=!1,a=!1){if("granted"!==Notification.permission)Notification.requestPermission();else{let n=t.replace(/\*(.*?)\*/g,"‎*$1*‎").replace(/_(.*?)_/g,"‎_$1_‎").replace(/~(.*?)~/g,"‎~$1~‎").replace(/```(.*?)```/g,"‎```\n$1\n```‎").replace(/`(.*?)`/g,"‎`$1`‎").replace(/^([{,+,0-9,}]+[@s.whatsapp.net])/g,"‎$1");n||(n="📄"),O.sw.showNotification(e,{body:(new z).strip(n),icon:i.indexOf("user.svg")>0?C["notifications-icon"]:i}).onclick=()=>{b?s?(SBAdmin.conversations.openConversation(s,0==a?G().id:a),SBAdmin.conversations.update()):a&&SBAdmin.profile.show(a):this.start(),window.focus()}}},updateNote:function(e,t,i,s=!1){U.ajax({function:"update-note",conversation_id:e,note_id:t,status:i},(e=>{this.busy=!1,s&&s(e)}))},getRecipientUserID:function(){return b?G().id:this.lastAgent(!1)?this.lastAgent(!1).user_id:U.null(this.conversation.get("agent_id"))?U.null(this.conversation.get("department"))?"agents":"department-"+this.conversation.get("department"):this.conversation.get("agent_id")},submit:function(){this.is_busy||(this.sendMessage(),C["cron-email-piping-active"]&&(setInterval((function(){U.ajax({function:"email-piping"})}),6e4),C["cron-email-piping-active"]=!1),O.init_push_notifications&&O.initPushNotifications())},initChat:function(){b||U.getActiveUser(!0,(()=>{let e=!1!==G(),t=!!e&&G().type;if(_||!C.popup.active||q("popup")||B&&C["popup-mobile-hidden"]||this.popup(),V.automations.run_all(),_||!C.privacy||C["registration-required"]||q("privacy-approved")){if(typeof Notification!==L&&!C["push-notifications-users"]&&("all"==C["desktop-notifications"]||"users"==C["desktop-notifications"]||b&&"agents"==C["desktop-notifications"])&&(this.desktop_notifications=!0),("all"==C["flash-notifications"]||"users"==C["flash-notifications"]||b&&"agents"==C["flash-notifications"])&&(this.flash_notifications=!0),this.registration(!0)&&!_)return this.registration(),void(!e&&C["visitors-registration"]&&this.addUserAndLogin());e||!(C["visitors-registration"]||C.subscribe||_)||_&&C["tickets-registration-required"]?!this.conversation&&e?this.populateConversations():this.finalizeInit():this.addUserAndLogin((()=>{this.welcome(),this.finalizeInit()})),C["header-name"]&&e&&"user"==t&&!_&&l.find(".sb-title").html(`${F("Hello")} ${G().nameBeautified}!`),this.welcome(),O.active||setInterval((()=>{this.updateConversations(),this.updateUsersActivity()}),10200),this.scrollBottom(!0)}else this.privacy()}))},finalizeInit:function(){this.initialized||(t.attr("style",""),b||_||(this.isInitDashboard()&&this.showDashboard(),!B&&window.innerHeight<760&&t.find(" > .sb-body").css("max-height",window.innerHeight-130+"px")),this.initialized=!0,b||(G()&&!this.registration(!0)&&(q("open-conversation")&&this.openConversation(q("open-conversation")),U.getURL("conversation")&&this.openConversation(U.getURL("conversation"))),(!this.chat_open&&(!B&&q("chat-open")||"open"==U.getURL("chat"))||U.getURL("conversation"))&&setTimeout((()=>{this.start()}),500),C["timetable-type"]&&V.offlineMessage(),C["queue-human-takeover"]&&X.dialogflow.humanTakeoverActive()&&(C.queue=!0)),_&&SBTickets.init(),U.event("SBInit"))},start:function(){this.initialized&&(this.populate(),this.headerAgent(),this.updateUsersActivity(),this.startRealTime(),this.chat_open=!0,this.popup(!0),this.conversation&&this.updateNotifications("remove",this.conversation.id),t.sbActive(!0),e("body").addClass("sb-chat-open"),"open"==C["welcome-trigger"]&&this.welcome(),this.calculateLabelDates())},open:function(i=!0){i&&!this.chat_open?(this.start(),this.chat_open=!0,this.startRealTime(),t.sbActive(!0),e("body").addClass("sb-chat-open"),q("chat-open",!0),B&&history.pushState({"chat-open":!0},"",""),U.event("SBChatOpen")):!i&&this.chat_open&&(t.sbActive(!1),this.stopRealTime(),this.chat_open=!1,q("chat-open",!1),e("body").removeClass("sb-chat-open"),U.event("SBChatClose"))},openConversation:function(e){G().getFullConversation(e,(t=>{if(!t.id)return q("open-conversation",""),!1;this.setConversation(t),this.hideDashboard(),this.populate(),this.main_header=!1,q("queue")==e&&this.queue(e),(this.chat_open||_)&&this.updateNotifications("remove",e),_&&SBTickets.activateConversation(t),q("open-conversation",e),U.event("SBConversationOpen",t)}))},loadUpdate:function(t){let i=t.length,s="",a=[],n=!1;this.calculateLabelDateFirst();for(var o=0;o<i;o++)if(!a.includes(t[o].details.id)){let e=new z(t[o].details),i=(e.payload(),U.beautifyTime(e.get("creation_time")));i!=n&&(s+=`<div class="sb-label-date">${i}</div>`,n=i),s+=e.getCode(),a.push(e.id)}e(".sb-list .sb-label-date:nth-child(2)").after(s),e(".sb-list .sb-label-date:nth-child(2)").remove(),this.dashboard||this.calculateLabelDates()},update:function(){if(this.conversation){if(this.is_busy_update)return;let e=this.conversation.getLastMessage(),t=!1;U.ajax({function:"get-new-messages",conversation_id:this.conversation.id,datetime:this.datetime_last_message_conversation,last_id:this.id_last_message_conversation},(i=>{let s=i.length;if(this.is_busy_update=!1,this.conversation&&Array.isArray(i)&&s>0&&(!e||e.id!=i[s-1].id||e.message!=i[s-1].message||e.payload!=i[s-1].payload||e.attachments!=i[s-1].attachments)){let e="",r=[],l=[],c=!1;this.calculateLabelDateFirst();for(var a=0;a<s;a++)if(!l.includes(i[a].id)){let s=new z(i[a]),d=s.payload();if(this.id_last_message_conversation=s.id,this.datetime_last_message_conversation=s.get("creation_time"),!["boolean","string"].includes(typeof d)){if("event"in d){let e=d.event;if(("delete-message"==e&&!1!==this.conversation.getMessage(s.id)||!b&&""==s.message&&!s.attachments.length)&&this.deleteMessage(s.id),X.dialogflow.active()||"conversation-status-update-3"!=e&&"conversation-status-update-4"!=e&&"activate-bot"!=e||(X.dialogflow.active("activate"),c=!0),C["close-chat"]&&"conversation-status-update-3"==e)return void this.closeChat(!1)}"human-takeover"in d&&C["queue-human-takeover"]&&(C.queue=!0,V.queue(V.conversation.id))}if(this.conversation.getMessage(i[a].id))this.conversation.updateMessage(s.id,s),n.find(`[data-id="${s.id}"]`).replaceWith(s.getCode()),t=!0;else{this.conversation.addMessages(s);let t=V.conversation.getLastUserMessage(!1,!0);if(t&&s.details.user_id!=t?.get("user_id")&&"[rating]"==t?.get("message")){const e=1==s.details.message?"positive":"negative",i=U.get_value(U.admin_set("rate-and-review")["rate-reply"]);var o={conversation_id:V.conversation.id,agent_id:t?t.get("user_id"):p,user_id:G().id,source:this.conversation.get("source"),message:s.details.message,rating:"positive"==e?1:-1};let a={"rich-messages":{}},n=U.random()+s.details.id;a["rich-messages"][n]={type:"rating",result:o};let r={function:"set-rating",payload:a,settings:o,message_id:t.id,message:i};1!=s.details.message&&2!=s.details.message||U.ajax(r,(e=>{"tk"!=this.conversation.get("source")&&V.sendMessage(SB_ACTIVE_AGENT.id,i)}))}e+=s.getCode()}r.push(s),l.push(s.id)}n.append(e);let d=this.conversation.getLastMessage(),u=d.get("user_type"),h=U.isAgent(u);!b&&h&&"bot"!=u&&(this.chat_open&&(-1==d.message.indexOf("sb-rich-success")&&this.setConversationStatus(0),C.follow.active&&clearTimeout(y)),c||X.dialogflow.active(!1)),q("queue")==this.conversation.id&&h&&"bot"!=u&&this.queue("clear"),n.find('[data-id="sending"]').remove(),this.headerAgent(),this.dashboard||t||(this.scrollBottom(),setTimeout((()=>{this.scrollBottom()}),300)),!this.dashboard&&this.chat_open||this.updateNotifications("add",this.conversation.id),this.typing(-1,"stop"),this.busy(!1),!this.audio||1==s&&U.null(r[0].message)&&U.null(r[0].attachments)||!(!b&&this.chat_open&&(h||"bot"==u)&&["aa","ia"].includes(C["chat-sound"])||b&&!U.isAgent(u)&&["a","i","ic"].includes(SB_ADMIN_SETTINGS.sounds))||this.audio.play(),U.event("SBNewMessagesReceived",r),_&&SBTickets.onNewMessageReceived(r[0])}})),this.is_busy_update=!0,setTimeout((()=>{this.is_busy_update=!1}),5e3)}else this.updateConversations()},updateConversations:function(){G()&&U.ajax({function:"get-new-user-conversations",datetime:this.id_last_message},(e=>{if(e.length){this.id_last_message=e[0].id;for(var i=0;i<e.length;i++){let t=e[i].conversation_id,s=new z(e[i]),a=e[i].conversation_status_code,n=new W([s],{id:t,conversation_status_code:a,department:e[i].department,title:e[i].title}),o=G().addConversation(n);e[i].user_id==G().id||this.conversation.id==t&&this.chat_open||(this.updateNotifications("add",t),C["auto-open"]&&this.start());let r=s.payload();if("boolean"!=typeof r&&"event"in r){if("open-chat"==r.event&&(B?this.open(!1):((this.conversation.id!=t||this.dashboard)&&this.openConversation(t),setTimeout((()=>{this.open()}),500))),""==s.message&&!s.attachments.length)continue}this.tab_active||(this.desktop_notifications&&V.desktopNotification(s.get("full_name"),s.message,s.get("profile_image")),this.flash_notifications&&this.flashNotification(),!this.audio||!["a","aa","i"].includes(C["chat-sound"])||this.chat_open&&this.tab_active&&!this.dashboard||U.null(s.message)&&U.null(s.attachments)||this.audio.play()),o&&(U.event("SBNewConversationReceived",n),_&&SBTickets.onNewConversationReceived(n))}t.find(".sb-user-conversations").html(G().getConversationsCode()),t.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",t.find(".sb-user-conversations > li").length>3)}}))},populate:function(){if(this.conversation){let t="",i=n.find(" > .sb-notify-message"),s=!1;for(var e=0;e<this.conversation.messages.length;e++){let i=this.conversation.messages[e],a=U.beautifyTime(i.get("creation_time"));a!=s&&(t+=`<div class="sb-label-date">${a}</div>`,s=a),t+=i.getCode()}n.html((i.length?i[0].outerHTML:"")+t),this.dashboard||(this.scrollBottom(),this.calculateLabelDates())}else G()&&!G().isConversationsEmpty()&&(C["disable-dashboard"]?this.openConversation(G().conversations[0].id):this.showDashboard())},populateConversations:function(e=!1){!this.is_busy_populate&&G()&&(this.is_busy_populate=!0,setTimeout((()=>{this.is_busy_populate=!1}),5e3),G().getConversations((i=>{let s=i.length;if(s){let e=Date.now();this.id_last_message=i[0].messages[0].id;for(var a=0;a<s;a++)1!=i[a].get("conversation_status_code")||this.conversation&&this.conversation.id==i[a].id||this.updateNotifications("add",i[a].id),e-U.UTC(i[a].messages[0].get("creation_time"))<6e3&&this.open();t.removeClass("sb-no-conversations"),t.find(".sb-user-conversations").html(G().getConversationsCode()),t.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",t.find(".sb-user-conversations > li").length>3)}this.initialized&&"open-conversation"!=j||1!=s||this.isInitDashboard()||q("open-conversation")||(this.openConversation(G().conversations[0].id),"open-conversation"==j&&(j="")),e&&e(i),this.finalizeInit()})))},newConversation:function(e,i=-1,s="",a=[],n=null,o=null,r=!1,l=selectedSource){G()&&U.ajax({function:"new-conversation",status_code:e,title:_?t.find(".sb-ticket-title input").val():null,department:U.null(n)?this.default_department:n,agent_id:U.null(o)?this.default_agent:o,tags:this.default_tags,source:l},(t=>{if(U.errorValidation(t,"user-not-found"))return void this.addUserAndLogin((()=>{this.newConversation(e,i,s,a,n,o,r)}));let l=new W([],t.details);this.setConversation(l),this.sendMessage(i,s,a),G().conversations.push(l),r&&r(l)}))},setConversation:function(e){e instanceof W?(this.conversation=e,this.id_last_message_conversation=this.conversation.getLastMessage()?this.conversation.getLastMessage().id:0,this.datetime_last_message_conversation=0==this.conversation.getLastMessage()?"2000-01-01 00:00:00":this.conversation.getLastMessage().get("creation_time"),e.id!=this.conversation.id&&this.queue(e.id),q("open-conversation",e.id),U.event("SBActiveConversationChanged",e)):U.error("Value not of type SBConversation","SBChat.setConversation")},getDepartmentCode(e,t){if(this.departments)if("all"==e){let e="";for(var i in this.departments)this.getDepartmentCode(this.departments[i].id,(t=>{e+=t}));t(e)}else t(`<div data-color="${this.departments[e].color}">${""==this.departments[e].image?"<span></span>":`<img loading="lazy" src="${this.departments[e].image}" />`}<div>${this.departments[e].name}<div></div>`);else U.ajax({function:"get-departments"},(i=>{i&&(this.departments=i,this.getDepartmentCode(e,t))}))},startRealTime:function(){O.active||(this.stopRealTime(),this.real_time=setInterval((()=>{this.update(),this.typing(b?G()?G().id:-1:this.agent_id,"check")}),1e3))},stopRealTime:function(){clearInterval(this.real_time)},updateUsersActivity:function(){G()&&U.updateUsersActivity(G().id,this.agent_id,(t=>{this.typing_settings.typing||("online"==t||this.agent_id==p?(e(c).addClass("sb-status-online").html(F("Online")),this.agent_online=this.agent_id!=p):(e(c).removeClass("sb-status-online").html(F("Away")),this.agent_online=!1))}))},busy:function(e){o.find(".sb-loader").sbActive(e),this.is_busy=e,U.event("SBBusy",e)},headerAgent:function(){if(!b&&!_&&!this.dashboard&&this.conversation&&(-1==this.agent_id||this.conversation.getLastMessage()&&U.isAgent(this.conversation.getLastMessage().get("user_type"))&&this.conversation.getLastMessage().get("user_id")!=this.agent_id)){let e=this.lastAgent();e&&(this.agent_id=e.user_id,this.headerReset(),l.addClass("sb-header-agent").attr("data-agent-id",this.agent_id).html(`<div class="sb-dashboard-btn bi-chevron-left"></div><div class="sb-profile"><img loading="lazy" src="${e.profile_image}" /><div><span class="sb-name">${e.full_name}</span><span class="sb-status">${F("Away")}</span></div><i class="sb-icon bi-x-lg ${!B&&C["close-chat"]?"sb-close-chat":"sb-responsive-close-btn"}"></i></div><div class="sb-label-date-top"></div>`),c=l.find(".sb-status"),this.updateUsersActivity(),h=l.find(".sb-label-date-top"),U.storageTime("header-animation",1)&&this.headerAnimation())}},headerReset:function(){0==this.start_header&&(this.start_header=[l.html(),l.attr("class")]),l.removeClass("sb-header-main sb-header-brand sb-header-agent sb-header-minimal"),this.main_header=!1},headerAnimation:function(){l.addClass("sb-header-animation"),setTimeout((()=>{l.removeClass("sb-header-animation")}),8e3),U.storageTime("header-animation")},lastAgent:function(e=!0){let t=!1;if(this.conversation){let i=this.conversation.getLastUserMessage(!1,!e||"all");i&&(t={user_id:i.get("user_id"),full_name:i.get("full_name"),profile_image:i.get("profile_image")})}return t},scrollBottom:function(e=!1){A=!1,setTimeout((()=>{A=!0}),1e3),setTimeout((()=>{u.scrollTop(e?0:u[0].scrollHeight),this.scrollHeader()}),300)},isBottom:function(){return u[0].scrollTop===u[0].scrollHeight-u[0].offsetHeight},scrollHeader:function(){if(this.main_header&&this.dashboard){let e=u.scrollTop();e>-1&&e<1e3&&l.find(".sb-content").css({opacity:1-e/500,top:e/10*-1+"px"})}},showDashboard:function(){b||_||(t.addClass("sb-dashboard-active"),l.removeClass("sb-header-agent"),this.hidePanel(),this.start_header&&l.html(this.start_header[0]).addClass(this.start_header[1]),u.find(" > div").sbActive(!1),t.find(".sb-dashboard").sbActive(!0),this.populateConversations(),this.conversation=!1,this.agent_id=-1,this.stopRealTime(),this.dashboard=!0,this.main_header=!0,this.scrollBottom(!0),U.event("SBDashboard"))},hideDashboard:function(){b||_||(n.sbActive(!0),t.removeClass("sb-dashboard-active").find(".sb-dashboard").sbActive(!1),this.dashboard=!1,this.headerAgent(),this.scrollHeader(0),this.chat_open&&this.startRealTime(),U.event("SBDashboardClosed"))},showPanel:function(e,i){if(_)return SBTickets.showPanel(e,i);let s=u.find(" > .sb-panel-"+e);s.length&&(u.find(" > div").sbActive(!1),s.sbActive(!0),this.start_header||(this.start_header=[l.html(),l.attr("class")]),l.attr("class","sb-header sb-header-panel").html(`${F(i)}<div class="sb-dashboard-btn bi-x-lg"></div>`),t.addClass("sb-panel-active"),this.dashboard=!0),U.event("SBPanelActive",e)},hidePanel:function(){t.removeClass("sb-panel-active"),l.removeClass("sb-header-panel")},clear:function(){this.conversation=!1,n.html("")},updateNotifications:function(e="add",i){if("add"!=e||this.notifications.includes(i)||(this.notifications.push(i),!this.dashboard&&this.conversation&&this.conversation.id!=i&&this.headerAnimation()),"remove"==e)for(var s=0;s<this.notifications.length;s++)if(this.notifications[s]==i){this.notifications.splice(s,1),0!=this.conversation.get("conversation_status_code")&&["1","2",1,2].includes(this.conversation.get("conversation_status_code"))&&this.setConversationStatus(0);break}let a=this.notifications.length;t.find(".sb-chat-btn span").attr("data-count",a).html(a>-1?a:0),U.event("SBNotificationsUpdate",{action:e,conversation_id:i})},setConversationStatus:function(e){return!!this.conversation&&(U.ajax({function:"update-conversation-status",conversation_id:this.conversation.id,status_code:e},(()=>{this.conversation.set("conversation_status_code",e),U.event("SBActiveConversationStatusUpdated",{conversation_id:this.conversation.id,status_code:e})})),!0)},typing:function(t=-1,i="check"){if(this.conversation){let s=this.agent_online||b&&this.user_online;if("check"==i&&!O.active&&-1!=t&&t!=p&&s)U.ajax({function:"is-typing",user_id:t,conversation_id:this.conversation.id},(e=>{e&&!this.typing_settings.typing?this.typing(-1,"start"):!e&&this.typing_settings.typing&&this.typing(-1,"stop")}));else if("set"==i&&s){let e=this.conversation.get("source");e&&(e="fb"==e?[e,G().getExtra("facebook-id").value,this.conversation.get("extra")]:"tw"==e&&[e,G().getExtra("twitter-id").value]),O.active?U.debounce((()=>{O.trigger("client-typing",{user_id:b?SB_ACTIVE_AGENT.id:G().id,conversation_id:this.conversation.id}),e&&U.ajax({function:"set-typing",source:e})}),"#2"):this.typing_settings.sent?(clearTimeout(this.typing_settings.timeout),this.typing_settings.timeout=setTimeout((()=>{U.ajax({function:"set-typing",user_id:t,conversation_id:-1},(()=>{this.typing_settings.sent=!1}))}),2e3)):(this.typing_settings.sent=!0,U.ajax({function:"set-typing",user_id:t,conversation_id:this.conversation.id,source:e}),this.typing(t,"set"))}else if("start"==i||"stop"==i){let t="start"==i;if(!b&&c)if(t)e(c).addClass("sb-status-typing").html(F("Typing"));else{let t=this.agent_online||this.agent_id==p;e(c).removeClass("sb-status-typing").html(F(t?"Online":"Away")),t&&e(c).addClass("sb-status-online")}this.typing_settings.typing=t,U.event("SBTyping",t)}}},categoryEmoji:function(e){let t=this.emoji_options.list;if("all"==e)this.emoji_options.list_now=t;else{this.emoji_options.list_now=[];for(var i=0;i<t.length;i++)t[i].category.startsWith(e)&&this.emoji_options.list_now.push(t[i])}this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()},mouseWheelEmoji:function(e){let t=this.emoji_options.range;(function(e){let t=e.originalEvent.wheelDelta;return typeof t==L&&(t=e.originalEvent.deltaY),typeof t==L&&(t=-1*e.originalEvent.detail),t})(e)>0||B&&typeof e.originalEvent.changedTouches!==L&&this.emoji_options.touch<e.originalEvent.changedTouches[0].clientY?t-=t<1?0:1:t+=t>this.emoji_options.range_limit?0:1,d.find(".sb-emoji-bar > div").sbActive(!1).eq(t).sbActive(!0),this.emoji_options.range=t,this.populateEmoji(t),e.preventDefault()},insertEmoji:function(t){t.indexOf(".svg")>0&&(t=e.parseHTML(t)[0].alt),this.insertText(t),d.sbTogglePopup()},showEmoji:function(e){d.sbTogglePopup(e)&&(b||d.css({left:o.offset().left+(_?68:20),top:o.offset().top-window.scrollY-(_?o.height()-330:304)}),""==d.find(".sb-emoji-list > ul").html()&&jQuery.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"emoji"}}).done((e=>{this.emoji_options.list=JSON.parse(e),this.emoji_options.list_now=this.emoji_options.list,this.populateEmoji(0),this.populateEmojiBar()})),U.deselectAll())},populateEmoji:function(e){let t="",i=B?42:48,s=e*i+i,a=this.emoji_options.list_now;s>a.length&&(s=a.length),this.emoji_options.range_limit=a.length/i-1,this.emoji_options.range=e;for(var n=e*i;n<s;n++)t+=`<li>${a[n].char}</li>`;d.find(".sb-emoji-list").html(`<ul>${t}</ul>`)},populateEmojiBar:function(){let e='<div class="sb-active"></div>',t=B?42:49;for(var i=0;i<this.emoji_options.list_now.length/t-1;i++)e+="<div></div>";this.emoji_options.range=0,d.find(".sb-emoji-bar").html(e)},clickEmojiBar:function(t){let i=e(t).index();this.populateEmoji(i),this.emoji_options.range=i,d.find(".sb-emoji-bar > div").sbActive(!1).eq(i).sbActive(!0)},searchEmoji:function(e){U.search(e,(()=>{if(e.length>1){let i=this.emoji_options.list,s=[];for(var t=0;t<i.length;t++)(i[t].category.toLowerCase().includes(e)||i[t].name.toLowerCase().includes(e))&&s.push(i[t]);this.emoji_options.list_now=s}else this.emoji_options.list_now=this.emoji_options.list;this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()}))},textareaChange:function(t){let i=e(t).val();b&&SBAdmin.conversations.savedReplies(t,i),i?(this.typing(b&&!O.active?SB_ACTIVE_AGENT.id:G().id,"set"),this.activateBar()):this.activateBar(!1)},insertText:function(t){let i=e(r.get(0)),s=0;if(this.dashboard)return!1;if("selectionStart"in i.get(0))s=i.get(0).selectionStart;else if("selection"in document){i.focus();let e=document.selection.createRange();var a=document.selection.createRange().text.length;e.moveStart("character",-i.value.length),s=e.text.length-a}i.val(i.val().substr(0,s)+t+i.val().substr(s)),i.focus(),i.manualExpandTextarea(),this.activateBar()},enabledAutoExpand:function(){r.length&&r.autoExpandTextarea()},privacy:function(){U.ajax({function:"get-block-setting",value:"privacy"},(e=>{u.append(`<div class="sb-privacy sb-init-form" data-decline="${e.decline}"><div class="sb-title">${e.title}</div><div class="sb-text">${e.message}</div>`+(e.link?`<a target="_blank" href="${e.link}">${e["link-name"]}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${e["btn-approve"]}</a><a class="sb-btn sb-decline">${e["btn-decline"]}</a></div></div>`),this.finalizeInit(),U.event("SBPrivacy")})),this.dashboard||this.showDashboard(),this.dashboard=!0,t.addClass("sb-init-form-active")},popup:function(e=!1,i=!1){if(e){let e=t.find(".sb-popup-message"),i=e.attr("data-id");return q("popup"+(U.null(i)?"":i),!0),void e.remove()}setTimeout((()=>{this.chat_open||(0==i&&(i=C.popup),t.find(".sb-popup-message").remove(),t.append(`<div data-id="${"id"in i?i.id:""}" class="sb-popup-message">`+("image"in i&&i.image?`<img loading="lazy" src="${i.image}" />`:"")+("title"in i&&i.title?`<div class="sb-top">${i.title}</div>`:"")+`<div class="sb-text">${i.message}</div><div class="bi-x-lg"></div></div>`),U.event("SBPopup",i))}),1e3)},followUp:function(){this.followUpCheck()&&(y&&clearTimeout(y),y=setTimeout((()=>{if(this.followUpCheck()){let e=C.follow;this.sendMessage(p,`[email id="sb-follow-up-form" title="${e.title}" message="${e.message}" placeholder="${e.placeholder}" name="${e.name}" last-name="${e["last-name"]}" phone="${e.phone}" phone-required="${e["phone-required"]}" success="${e.success}"]`),this.scrollBottom(),U.storageTime("email"),U.event("SBFollowUp")}}),U.null(C.follow.delay)?C["office-hours"]||I?15e3:X.dialogflow.active()?8e3:5e3:parseInt(C.follow.delay)))},followUpCheck:function(){return!b&&this.conversation&&C.follow.active&&G()&&!G().get("email")&&U.storageTime("email",24)&&(C["office-hours"]||!C.follow["disable-office-hours"])},welcome:function(){"open"==C["welcome-trigger"]&&!this.chat_open||!C["office-hours"]&&C["welcome-disable-office-hours"]||!C.welcome||q("welcome")||!G()||U.ajax({function:"get-block-setting",value:"welcome"},(e=>{setTimeout((()=>{C["dialogflow-welcome"]&&(!1===this.conversation?this.newConversation(3,-1,"",[],null,null,(function(){X.dialogflow.welcome(e.open,e.sound)})):X.dialogflow.welcome(e.open,e.sound)),this.sendMessage(p,e.message,[],!1,!1,3),e.open&&this.start(),e.sound&&this.audio.play(),this.skip=!0,U.event("SBWelcomeMessage")}),parseInt(_?0:C["welcome-delay"])),q("welcome",!0)}))},offlineMessage:function(){if(!b&&!this.offline_message_set&&C.timetable&&(!C["office-hours"]||!I&&!C["timetable-disable-agents"])&&U.storageTime("timetable",1)){let e=C["timetable-message"];switch(C["timetable-type"]){case"header":e[0]&&l.find(".sb-title").html(e[0]),l.find(".sb-text").html(e[1]),this.offline_message_set=!0;break;case"info":n.prepend(`<div class="sb-notify-message sb-rich-cnt">\n              <div class="server-response"> <i class="bi-check2-all"></i></div>\n              <div class="sb-cnt"><div class="sb-message">${e[0]?`<strong>${e[0]}</strong> `:""}${e[1]}</div></div></div>`),t.addClass("sb-notify-active"),this.offline_message_set=!0;break;default:setTimeout((()=>{this.conversation&&(this.sendMessage(p,C["timetable-hide"]?`${e[0]?`*${e[0]}*\n`:""}${e[1]}`:"[timetable]"),this.scrollBottom(),this.offline_message_set=!0,U.storageTime("timetable"))}),5e3)}}},deleteMessage:function(e){U.ajax({function:"delete-message",message_id:e},(()=>{this.conversation&&this.conversation.deleteMessage(e),n.find(`[data-id="${e}"]`).remove(),this.update(),console.log("chat",e),U.event("SBMessageDeleted",e)}))},registration:function(e=!1,i=C["registration-required"]){if(e)return C["registration-required"]&&(!C["registration-offline"]||!I)&&(!C["registration-timetable"]||!C["office-hours"])&&(!1===G()||["visitor","lead"].includes(G().type));u.append(H.generate({},C["registration-link"]?"login":i,"sb-init-form")),this.dashboard||this.showDashboard(),this.dashboard=!0,this.finalizeInit(),t.addClass("sb-init-form-active")},activateBar:function(e=!0){o.find(".sb-bar").sbActive(e)},addUserAndLogin:function(e=!1,t=!1){let i=typeof SB_DEFAULT_USER!=L?SB_DEFAULT_USER:{};i.user_type=t?"lead":"visitor",U.ajax({function:"add-user-and-login",settings:i,settings_extra:i.extra},(t=>{U.loginCookie(t[1]),G(new P(t[0])),O.start(),O.active||V.automations.run_all(),e&&e(t)}))},isInitDashboard:function(){return C["init-dashboard"]||G()&&G().conversations.length>1},uploadResponse:function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1]){let e="The file you are trying to upload has an extension that is not allowed.";b?SBAdmin.dialog(e,"info"):alert(e)}else if(e(s).hasClass("sb-input-image"))e(s).find(".image").attr("data-value","").css("background-image",""),setTimeout((()=>{e(s).find(".image").attr("data-value",t[1]).css("background-image",`url("${t[1]}?v=${U.random()}")`).append('<i class="bi-x-lg"></i>'),s=!1}),500);else{let e=t[1].substr(t[1].lastIndexOf("/")+1),i="";const s=/\.(jpg|jpeg|png|)$/.test(t[1].toLowerCase()),a=/\.(mp3|ogg)$/.test(t[1].toLowerCase()),n=/\.(docx|pptx|xlsx|doc|ppt|xls)$/.test(t[1].toLowerCase());i=s?`<div data-name="${e}" data-value="${t[1]}" data-id="${t[2]}">\n                                <img style="border-radius: .4rem; width: 33px; vertical-align: middle;object-fit:cover;" src="${t[1]}" width="30" height="30">\n                                <i class="bi-x-lg"></i>\n                              </div>`:a?`<div style="display:flex;flex-direction:row;align-items: center;" data-name="${e}" data-value="${t[1]}" data-id="${t[2]}">\n                                <audio controls style="max-width: 100%; max-height: 33px; border-radius: var(--chat-rounded-size-6);">\n                                  <source src="${t[1]}" type="audio/${t[1].split(".").pop()}">\n                                  Your browser does not support the audio element.\n                                </audio>\n                                <i class="bi-x-lg"></i>\n                              </div>`:n?`<div data-name="${e}" data-value="${t[1]}" data-id="${t[2]}">\n                                <i class="bi bi-file-earmark-text-fill" style="font-size:1.8rem"></i>\n                                 <i class="bi-x-lg"></i>\n                              </div>`:`<div data-name="${e}" data-value="${t[1]}" data-id="${t[2]}">\n          <i class="bi bi-file-earmark-text-fill" style="font-size:1.89rem; color: var(--chat-text-primary)"></i>\n           <i class="bi-x-lg"></i>\n        </div`,o.find(".sb-attachments").append(i),V.activateBar()}else U.error(t[1],"sb-upload-files.change");this.busy(!1)},closeChat:function(e=!0){let i=this.conversation.id;function s(){t.find(`li[data-conversation-id="${i}"]`).remove(),j="new-conversation",V.clear(),q("open-conversation",""),G().removeConversation(i),C["disable-dashboard"]||V.showDashboard()}V.clear(),e?U.ajax({function:"update-conversation-status",conversation_id:i,status_code:3},(()=>{s()})):s()},automations:{history:[],busy:[],scroll_position_intervals:{},timeout_queue:[],run_all:function(){let t=C.automations;for(var i=0;i<t.length;i++){let n=t[i],o=n.conditions,r=0==o.length,l=!1,c=!1,d=!1;for(var s=0;s<o.length;s++){let t=o[s][1];switch(r=!1,o[s][0]){case"browsing_time":r=!0,l=t;break;case"scroll_position":r=!0,c=t;break;case"include_urls":case"exclude_urls":case"referring":let i="referring"==o[s][0]?document.referrer:window.location.href,n=o[s][2].split(","),u="exclude_urls"!=o[s][0];u||(r=!0),i=i.replace("https://","").replace("http://","").replace("www.","");for(var a=0;a<n.length;a++)if(n[a]=e.trim(n[a].replace("https://","").replace("http://","").replace("www.","")),"contains"==t&&-1!=i.indexOf(n[a])||"does-not-contain"==t&&-1==i.indexOf(n[a])||"is-exactly"==t&&n[a]==i||"is-not"==t&&n[a]!=i){r=u;break}break;case"custom_variable":let h=t.split("=");h[0]in window&&window[h[0]]==h[1]&&(r=!0);break;case"returning_visitor":case"user_type":case"cities":case"languages":case"countries":r=G(),d=!0;break;case"user_phone":r=G()&&!U.null(G().getExtra("phone"));break;case"user_email":r=G()&&!U.null(G().get("email"));break;default:r=!0}if(!r)break}["messages","emails","sms"].includes(n.type)&&!G()&&(r=!1),r&&(d?n.id in this.busy||(U.ajax({function:"automations-validate",automation:n},(e=>{!1!==e&&this.run_all_final(n,c,l),delete this.busy[n.id]})),this.busy[n.id]=!0):this.run_all_final(n,c,l))}},run_all_final:function(t,i,s){i?this.scroll_position_intervals[t.id]=setInterval((()=>{e(window).scrollTop()>parseInt(i)&&(s?setTimeout((()=>{this.run(t)}),1e3*parseInt(s)):this.run(t),clearInterval(this.scroll_position_intervals[t.id]))}),1e3):s?this.timeout_queue.includes(t.id)||(setTimeout((()=>{this.run(t)}),1e3*parseInt(s)),this.timeout_queue.push(t.id)):this.run(t)},run:function(e){if(!this.history.includes(e.id))switch(e.type){case"messages":case"emails":case"sms":if((!O.active||O.started)&&!(e.id in this.busy)){if("messages"==e.type&&V.chat_open){let e=!!V.conversation&&V.conversation.getLastUserMessage(!1,"no-bot");if(e&&Date.now()-6e5<U.unix(e.get("creation_time")))return}U.ajax({function:"automations-run",automation:e},(t=>{!1!==t&&(this.history.push(e.id),"messages"!=e.type||O.active||V.updateConversations()),delete this.busy[e.id]})),this.busy[e.id]=!0}break;case"popups":q("popup"+e.id)||setTimeout((()=>{if(V.chat_open){if(e.fallback){let t=!!V.conversation&&V.conversation.getLastUserMessage(!1,"no-bot");(!t||Date.now()-6e5>U.unix(t.get("creation_time")))&&(V.sendMessage(p,(U.null(e.title)?"":`*${e.title}*\n`)+e.message,[],!1,!1,0),q("popup"+e.id,!0),this.history.push(e.id))}}else V.popup(!1,{id:e.id,image:e.profile_image,title:e.title,message:e.message}),this.history.push(e.id)}),1e3);break;case"design":e.background&&l.css("background-image",`url("${e.background}")`),e.brand&&l.find(".sb-brand img").attr("src",e.brand),e.title&&l.find(".sb-title").html(e.title),e.message&&l.find(".sb-text").html(e.message),e.icon&&t.find(".sb-chat-btn .sb-icon").attr("src",e.icon),(e.color_1||e.color_2||e.color_3)&&U.ajax({function:"chat-css",color_1:e.color_1,color_2:e.color_2,color_3:e.color_3},(e=>{i.append(`<style>${e}</style>`)})),this.history.push(e.id);break;case"more":let s={};e.department&&(V.default_department=e.department,s={function:"update-conversation-department",department:e.department}),e.agent&&(V.default_agent=e.agent,s={function:"update-conversation-agent",agent_id:e.agent}),e.tags&&(e.tags=e.tags.split(","),V.default_tags=e.tags,s={function:"update-tags",tags:e.tags,add:!0}),V.conversation.id&&(e.tags||e.agent||e.department)&&(s.conversation_id=V.conversation.id,U.ajax(s))}}},flashNotification:function(){clearInterval(S),S=setInterval((function(){document.title=document.title==T?F("New message..."):T}),2e3)},calculateLabelDates:function(){(b||this.chat_open)&&(k=n.find(".sb-label-date"))},calculateLabelDateFirst:function(){this.conversation.messages.length||n.append(`<div class="sb-label-date"><span>${F("Today")}</span></div>`)}};window.SBChat=V;var H={rich_messsages:{email:"",button:"",video:"",si:'<div class="sb-btn">Sí</div>',no:'<div class="sb-btn">No</div>',image:"",chips:'<div style="margin: 8px;" class="sb-buttons">[options]</div>',buttons:'<div class="sb-buttons">[options]</div>',select:'<div class="sb-select"><p></p><ul>[options]</ul></div>',list:'<div class="sb-text-list">[values]</div>',"list-image":'<div class="sb-image-list">[values]</div>',table:"<table><tbody>[header][values]</tbody></table>",inputs:'<div class="sb-form">[values]</div>',rating:'<div class="sb-rating"><span>[label]</span></div>',card:'<div class="sb-card">[settings]</div>',share:'<div class="sb-social-buttons">[settings]</div>',slider:'<div class="sb-slider"><div>[items]</div></div><div class="sb-slider-arrow bi-chevron-left[class]"></div><div class="sb-slider-arrow bi-chevron-right sb-active[class]"></div>',"slider-images":'<div class="sb-slider sb-slider-images"><div>[items]</div></div><div class="sb-slider-arrow bi-chevron-left[class]"></div><div class="sb-slider-arrow bi-chevron-right sb-active[class]"></div>',phone:""},cache:{},generate:function(i,s,a=""){let n,o=!0,r="id"in i?i.id:U.random(),l=new z({});s in this.rich_messsages?n=this.rich_messsages[s]:s in this.cache?n=this.cache[s]:b||!U.null(C)&&"rich-messages"in C&&C["rich-messages"].includes(s)?("id"in i||(r=s),n='<div class="sb-rich-loading sb-loading"></div>',U.ajax({function:"get-rich-message",name:s,settings:i},(e=>{e=l.render(this.initInputs(e)),"timetable"==s&&(e=this.timetable(e)),t.find(`.sb-rich-message[id="${r}"]`).html(`<div class="sb-content">${e}</div>`),this.cache[s]=e,V.scrollBottom(V.dashboard)})),o=!1):n=`[${s}]`;let c="disabled"in i;if(o){let t,a="",o=U.get_value(U.admin_set("rate-and-review")["rate-review"]);switch(s){case"button":n=i.link&&i.style?`<a href="${i.link.replace(/<i>/g,"_").replace(/<\/i>/g,"_")}"${"target"in i?' target="_blank"':""} class="sb-rich-btn sb-btn${"link"==i.style?"-text":""}">${F(i.name)}</a>`:i.yes&&i.no?"si"===i.yes&&"no"===i.no?`${H.rich_messsages.yes}${H.rich_messsages.no}`:"yes"===i.yes&&"no"===i.no?`${H.rich_messsages.no}${H.rich_messsages.yes}`:`<button class="sb-rich-btn sb-btn">${F(i.name)}</button>`:`<button class="sb-rich-btn sb-btn">${F(i.name)}</button>`;break;case"rating":n=n.replace("[label]",F(U.null(i.label)?F(o):i.label).replace(/\n/g,"<br>")).replace("[success-negative]",U.null(i["success-negative"])?"":F(i["success-negative"])).replace("[positive]",F(U.null(i["label-positive"])?"Helpful":i["label-positive"])).replace("[negative]",F(U.null(i["label-negative"])?"Not helpful":i["label-negative"]));break;case"email":let r=[],l=G().get("email"),u="#"==G().get("last_name").charAt(0);"true"==i.name&&r.push(["first_name","true"==i["last-name"]?"First name":"Name",u?"":"true"==i["last-name"]?G().get("first_name"):G().name,"text",!0]),"true"==i["last-name"]&&r.push(["last_name","Last name",u?"":G().get("last_name"),"text",!0]);for(var d=0;d<r.length;d++)n+=`<div id="${r[d][0]}" data-type="text" class="sb-input sb-input-text"><span class="${""==r[d][2]?"":"sb-active sb-filled"}">${F(r[d][1])}</span><input value="${r[d][2]}" autocomplete="false" type="${r[d][3]}" ${r[d][4]?"required":""}></div>`;if("true"==i.phone){let e=G().getExtra("phone"),t=b?[]:C["phone-codes"],s="";if(1===t.length)s=`<input disabled value="${t[0]}">`;else{for(d=0;d<t.length;d++)s+=`<option value="+${t[d]}">+${t[d]}</option>`;s=`<select style='color:black!important;'><option value="">+00</option>${s}</select>`}n+=`<div id="phone" data-type="select-input" class="sb-input sb-input-select-input"><span class="${""==e?"":"sb-active sb-filled"}">${F("Phone")}</span><div>${s}</div><input value="${b?"":e}" pattern="[0-9]+" autocomplete="false" type="tel" ${"false"!=i["phone-required"]?"required":""}></div>`}n+=`<div id="email" data-type="email" class="sb-input sb-input-btn"><span class="${""==l?"":"sb-active sb-filled"}">${F(U.null(i.placeholder)?"Email":i.placeholder)}</span><input value="${l}" autocomplete="off" type="email" required><div class="sb-submit bi-chevron-right"></div></div>`;break;case"image":n=`<div class="sb-image"><img loading="lazy" src="${i.url}"></div>`;break;case"video":n=`<iframe loading="lazy"${"height"in i?` height="${i.height}"`:""} src="${"youtube"==i.type?"//www.youtube.com/embed/":"//player.vimeo.com/video/"}${i.id}" allowfullscreen></iframe>`;break;case"select":t=i.options.split(",");for(d=0;d<t.length;d++)a+=`<li data-value="${U.stringToSlug(t[d])}">${F(t[d])}</li>`;n=n.replace("[options]",a);break;case"chips":case"buttons":t=i.options.split(",");for(d=0;d<t.length;d++)a+=`<div class="sb-btn sb-submit">${F(t[d])}</div>`;n=n.replace("[options]",a);break;case"list":t=i.values.split(",");let h="list"==s,g=h&&t.length&&t[0].indexOf(":")>0;h&&!g&&(n=n.replace("sb-text-list","sb-text-list sb-text-list-single"));for(d=0;d<t.length;d++)a+=g?`<div><div>${F(t[d].split(":")[0])}</div><div>${F(t[d].split(":")[1])}</div></div>`:`<div>${e.trim(F(t[d]))}</div>`;n=n.replace("[values]",a);break;case"list-image":t=i.values.split(",");for(d=0;d<t.length;d++){let e=t[d].replace("://","///").split(":");a+=`<div><div class="sb-thumb" style="background-image:url('${e[0].replace("///","://")}')"></div><div class="sb-list-title">${e[1]}</div><div>${e[2]}</div></div>`}n=n.replace("[values]",a);break;case"table":t=i.header.split(","),a+="<tr>";for(d=0;d<t.length;d++)a+=`<th>${t[d]}</th>`;a+="</tr>",n=n.replace("[header]",a),a="",t=i.values.split(",");for(d=0;d<t.length;d++){let e=t[d].split(":");a+="<tr>";for(d=0;d<e.length;d++)a+=`<td>${e[d]}</td>`;a+="</tr>"}n=n.replace("[values]",a);break;case"inputs":t=i.values.split(",");for(d=0;d<t.length;d++)c&&""==t[d]||(a+=`<div id="${U.stringToSlug(t[d])}" data-type="text" class="sb-input sb-input-text"><span>${F(t[d])}</span><input autocomplete="false" type="text" required></div>`);a+='<div class="sb-btn sb-submit">'+F("button"in i?i.button:"Send now")+"</div>",n=n.replace("[values]",a);break;case"card":a=`${"image"in i?`<div class="sb-card-img" style="background-image:url('${i.image}')"></div>`:""}<div class="sb-card-header">${i.header}</div>${"extra"in i?`<div class="sb-card-extra">${i.extra}</div>`:""}${"description"in i?`<div class="sb-card-description">${i.description}</div>`:""}${"link"in i?`<a class="sb-card-btn" href="${i.link}"${"target"in i?' target="_blank"':""}>${F(i["link-text"])}</a>`:""}`,n=n.replace("[settings]",a);break;case"share":let p="channels"in i?i.channels.replace(/ /g,"").split(","):["fb","tw","li","wa","pi"],m="";for(d=0;d<p.length;d++){switch(p[d]){case"fb":m="www.facebook.com/sharer.php?u=";break;case"tw":m="twitter.com/intent/tweet?url=";break;case"li":m="www.linkedin.com/sharing/share-offsite/?url=";break;case"wa":m="web.whatsapp.com/send?text=";break;case"pi":m="www.pinterest.com/pin/create/button/?url="}a+=`<div class="sb-${p[d]} sb-icon-social-${p[d]}" data-link="https://${m}${i.link}"></div>`}n=n.replace("[settings]",a);break;case"slider":let f=0;for(d=1;d<16&&"header-"+d in i;d++)a+=`<div>${"image-"+d in i?`<div class="sb-card-img" style="background-image:url('${i["image-"+d]}')"></div>`:""}<div class="sb-card-header">${i["header-"+d]}</div>${"extra-"+d in i?`<div class="sb-card-extra">${i["extra-"+d]}</div>`:""}${"description-"+d in i?`<div class="sb-card-description">${i["description-"+d]}</div>`:""}${"link-"+d in i?`<a class="sb-card-btn" href="${i["link-"+d]}"${"target"in i?' target="_blank"':""}>${F(i["link-text-"+d])}</a>`:""}</div>`,f++;n=n.replace("[items]",a).replace(/\[class\]/g,1==f?" sb-hide":"");break;case"slider-images":if("images"in i){let e=i.images.split(",");for(d=0;d<e.length;d++)a+=`<div class="sb-card-img" data-value="${e[d]}" style="background-image:url('${e[d]}')"></div>`;n=n.replace(/\[class\]/g,1==e.length?" sb-hide":"")}n=n.replace("[items]",a);break;default:n=`[${s}]`}}return`<div id="${r}" data-type="${s}"${c?'disabled="true"':""}${"settings"in i?` data-settings="${i.settings}"`:""} class="sb-rich-message sb-rich-${s} ${a}">`+("title"in i?`<div class="sb-top">s${l.render(F(i.title))}</div>`:"")+("message"in i?`<div class="sb-text">${l.render(F(i.message))}</div>`:"")+`<div class="sb-content">${n}</div><div data-success="${"success"in i?i.success.replace(/"/g,""):""}" class="sb-info"></div></div>`},submit:function(i,s,a){if(!b&&!function(t){return!!e(t).sbLoading()||(e(t).sbLoading(!0),!1)}(a)&&!this.is_busy){let o="",r="",l={},c=e(i).find("[data-success]").length?e(i).find("[data-success]").attr("data-success"):"",d=e(i).closest(".sb-rich-message").attr("id"),u=e(i).closest("[data-id]").attr("data-id"),h="",g={"rich-messages":{}},f=0==G()?{profile_image:["",""],first_name:["",""],last_name:["",""],email:["",""],password:["",""],user_type:["",""]}:{profile_image:[G().image,""],first_name:[G().get("first_name"),""],last_name:[G().get("last_name"),""],email:[G().get("email"),""],password:["",""],user_type:["",""]},v={},b=e(a),_="",y=!1,w=!1!==V.conversation,S={},x={};if(U.null(u))u=-1;else{let e=V.conversation.getMessage(u);h=e.message,g=e.payload(),"rich-messages"in g||(g["rich-messages"]={})}switch(e(a).hasClass("sb-btn")||e(a).hasClass("sb-select")||e(a).hasClass("sb-submit")||(b=e(a).closest(".sb-btn,.sb-select")),e(i).find(".sb-info").html("").sbActive(!1),s){case"email":let t="last_name"in v;v=J.getAll(i),"first_name"in v&&(f.user_type=["user",""],t||(f.last_name=["",""])),"phone"in v&&(S={phone:[v.phone[0],"Phone"]}),e.extend(f,v),o="Please fill in all required fields and make sure the email is valid.",c&&(c=F(c).replace("{user_email}",f.email[0]).replace("{user_name_}",f.first_name[0]+(t?" "+f.last_name[0]:""))),g["rich-messages"][d]={type:s,result:v},g.event="update-user",l={function:"update-user-and-message",settings:f,settings_extra:S,payload:g},y={settings:f,settings_extra:S};break;case"registration":if(S=J.getAll(i.find(".sb-form-extra")),e.extend(f,J.getAll(i.find(".sb-form-main"))),x=e.extend({},f),c&&(c=F(c)),C["registration-details"]){for(var n in c+='[list values="',f){let e=f[n][0].replace(/:|,/g,"");e&&("profile_image"==n&&(e=e.substr(e.lastIndexOf("/")+1)),"password"!=n&&"password-check"!=n||(e="********",x[n]="********"),c+=""==f[n][1]?"":`${F(f[n][1].replace(/:|,/g,""))}:${e},`)}for(var n in S)S[n][0]&&(c+=`${F(S[n][1].replace(/:|,/g,""))}:${S[n][0].replace(/:|,/g,"")},`);c=c.slice(0,-1)+'"]'}f.user_type=["user",""],g["rich-messages"][d]={type:s,result:{user:x,extra:S}},g.event="update-user",l={function:G()?"update-user-and-message":"add-user-and-login",settings:f,settings_extra:S,payload:g},o=J.getRegistrationErrorMessage(i),y={settings:f,settings_extra:S};break;case"rating":let r=e(a).attr("data-rating"),u=V.conversation.getLastUserMessage(!1,!0);c=`${F(""==c?F("Thank you for your feedback!"):c)}`,v={conversation_id:V.conversation.id,agent_id:u?u.get("user_id"):p,user_id:G().id,message:i.find("textarea").val(),rating:"positive"==r?1:-1},g["rich-messages"][d]={type:s,result:v},l={function:"set-rating",payload:g,settings:v},_=r;break;case"chips":case"select":case"buttons":v=U.escape(e(a).html()),c=""==c?c:F(c)+` *${v}*`,g["rich-messages"][d]={type:s,result:v},l={function:"update-message",payload:g},_=v,"chips"==s&&(V.sendMessage(G().id,v,[],!1,{id:d,event:"chips-click",result:v},"sb-human-takeover"==d&&0==b.index()&&2),"sb-human-takeover"==d&&0==e(a).index()&&X.dialogflow.humanTakeover(),e(a).closest(".sb-content").remove());break;case"inputs":if(v=J.getAll(i),o="All fields are required.",c){for(var n in c=F(c)+' [list values="',v)c+=`${F(v[n][1].replace(/:|,/g,""))}:${v[n][0].replace(/:|,/g,"")},`;c=c.slice(0,-1)+'"]'}g["rich-messages"][d]={type:s,result:v},l={function:"update-message",payload:g},y={settings:v}}if(r=h.substr(h.indexOf("["+s)),r=r.substr(0,r.indexOf("]")+1),o&&J.errors(i))return J.showErrorMessage(i,o),b.sbLoading(!1),(V.dashboard||w&&V.conversation.getLastMessage().id==u)&&V.scrollBottom(),!1;if(!c&&"registration"!=s){let e=this.shortcode(r),t="title"in e[1]?`title="${e[1].title}"`:"",i="message"in e[1]?`message="${e[1].message}"`:"",a="";if(["inputs","email"].includes(s)){for(var n in v)a+=v[n][0]+",";a=`values="${a.slice(0,-1)}"`}else a=`options="${v}"`;c=`[${"email"==s?"inputs":s} ${t} ${i} ${a} disabled="true"]`}-1!=u&&e.extend(l,{message_id:u,message:h?h.replace(r,c):c,payload:g}),U.ajax(l,(n=>{if(0==n||U.errorValidation(n))J.showErrorMessage(i,J.getRegistrationErrorMessage(n,"response")),V.dashboard&&V.scrollBottom(),b.sbLoading(!1);else{switch(s){case"email":for(var o in f)G().set(o,f[o][0]);for(var o in S)G().setExtra(o,S[o][0]);U.loginCookie(n[1]),"sb-subscribe-form"==d&&U.ajax({function:"subscribe-email",email:G().get("email")}),V.automations.run_all(),U.event("SBNewEmailAddress",{id:d,name:G().name,email:G().get("email")});break;case"registration":if(U.loginCookie(n[1]),f.id=[n[0].id],G()){for(var o in f)G().set(o,f[o][0]);for(var o in S)G().setExtra(o,S[o][0]);V.automations.run_all()}else{for(var o in G(new P(n[0])),S)G().setExtra(o,S[o][0]);O.start(),V.initChat(),C["init-dashboard"]&&t.find(".sb-departments-list").length||!c||V.sendMessage(p,c,[],!1,!1,3)}V.dashboard&&(t.removeClass("sb-init-form-active"),e(i).remove(),V.isInitDashboard()||V.hideDashboard()),delete this.cache.registration,setTimeout((()=>{U.event("SBRegistrationForm",{id:d,conversation_id:!!V.conversation&&V.conversation.id,user:f,extra:g["rich-messages"][d].result.extra})}),5e3)}-1==u?e(a).closest(".sb-rich-message").html(c):"type"in g&&"close-message"==g.type||m||V.setConversationStatus(2),["login","chips","rating"].includes(s)||!C["dialogflow-send-user-details"]&&["email","registration"].includes(s)||X.dialogflow.message(`${d}${_?"|"+_:""}`,[],!1,y),!C["slack-active"]||m&&!X.dialogflow.humanTakeoverActive()||V.slackMessage(G().id,G().name,G().image,c),O.active&&V.update(),"registration"!=s&&"email"!=s&&U.event("SBRichMessageSubmit",{result:n,data:g["rich-messages"][d],id:d})}}))}},shortcode:function(t){if(t.indexOf(" ")<0)return[t.slice(1,-1),{}];let i={},s=t.substr(1,t.indexOf(" ")-1),a=(t=t.slice(1,-1).substr(s.length+1)).split('" ');for(var n=0;n<a.length;n++)if(a[n].includes("=")){let t=[a[n].substr(0,a[n].indexOf("=")),a[n].substr(a[n].indexOf("=")+2)];i[e.trim(t[0])]=t[1].replace(/"/g,"")}return[s,i]},initInputs:function(t){return(t=e(e.parseHTML("<div>"+t+"</div>"))).find(".sb-input input").each((function(){e(this).val()&&e(this).siblings().addClass("sb-active sb-filled")})),t.html()},timetable:function(t){let i=e(e.parseHTML(`<div>${t}</div>`)),s=i.find("[data-offset]").attr("data-offset");s=U.null(s)?0:parseInt(s);let a="";return i.find("[data-time]").each((function(){let t=e(this).attr("data-time").split("|");for(var i=0;i<t.length;i++){if("closed"==t[i]){a+="Closed";break}if(t[i]){let e=t[i].split(":"),n=U.convertUTCDateToLocalDate(`01/01/2000 ${e[0]}:${e[1]}`,s);a+=n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+(0==i||2==i?" (to) ":1==i&&t[i+1]?"\n":"")}}a+="\n"})),a+="Time zone "+Intl.DateTimeFormat().resolvedOptions().timeZone,a},sliderChange:function(e,t="left"){let i=n.find(`#${e}`);if(i.length&&!i.hasClass("sb-moving")){let e=i.find(".sb-slider > div > div"),s=e.eq(0),a=Math.ceil(s.closest(".sb-slider").width()),n="right"==t?-1:1,o=parseFloat(parseFloat(parseFloat(s.css("margin-left"))+a*n).toFixed(2))+-.5*n,r=a*(e.length-1)*-1;o<1&&o>=r&&(s.css("margin-left",o+"px"),i.addClass("sb-moving"),setTimeout((()=>{i.removeClass("sb-moving")}),1200)),i.find(".bi-chevron-right").sbActive(!(r>o-15&&r<o+15)),i.find(".bi-chevron-left").sbActive(o<-10)}}},J={getAll:function(t){let i={};return e(t).find(".sb-input[id]").each(((t,s)=>{i[e(s).attr("id")]=this.get(s)})),i},get:function(t){let i=(t=e(t)).data("type"),s=F(U.escape(t.find(" > span").html()));switch(i){case"image":let e=t.find(".image").attr("data-value");return[U.null(e)?"":e,s];case"select":return[U.escape(t.find("select").val()),s];case"select-input":let i=t.find("select,input[disabled]"),a=i.val();return[U.escape((i.is("select")||i.is("input")?a:t.find("> div").html())+t.find('input[type="tel"]').val()),s];default:let n=t.find("input");return[U.escape(n.length?n.val():t.find("[data-value]").attr("data-value")),s]}},set:function(t,i){if((t=e(t)).length){switch(t.data("type")){case"image":""==i?t.find(".image").removeAttr("data-value").removeAttr("style"):t.find(".image").attr("data-value",i).css("background-image",`url("${i}")`);break;case"select":t.find("select").val(i);break;default:t.find("input,textarea").val(i)}return!0}return!1},clear:function(t){e(t).find(".sb-input,.sb-input-setting").each(((t,i)=>{this.set(i,""),e(i).find("input, select, textarea").removeClass("sb-error")})),this.set(e(t).find("#user_type"),"lead")},errors:function(t){let i=!1,s=e(t).find("input, select, textarea").removeClass("sb-error");return s.each((function(t){let a=e.trim(e(this).val()),n=e(this).attr("type"),o=e(this).prop("required");(o&&""==a||(o||a)&&("password"==n&&(a.length<8||s.length>t+1&&"password"==s.eq(t+1).attr("type")&&s.eq(t+1).val()!=a)||"email"==n&&(a.indexOf("@")<0||a.indexOf(".")<0||/;|:|\/|\\|,|#|"|!|=|\+|\*|{|}|[|]|£|\$|€|~|'|>|<|\^|&/.test(a))||"tel"==n&&a&&(""==e(this).parent().find("select").val()||isNaN(a)||a.includes("+")||a.length<5)))&&(i=!0,e(this).addClass("sb-error"))})),s=e(t).find("[data-required]").removeClass("sb-error"),s.each((function(){U.null(e(this).attr("data-value"))&&(e(this).addClass("sb-error"),i=!0)})),i},showErrorMessage:function(t,i){e(t).find(".sb-info").html(F(i)).sbActive(!0),clearTimeout(y),y=setTimeout((function(){e(t).find(".sb-info").sbActive(!1)}),2500)},showSuccessMessage:function(t,i){e(t).find(".sb-info").remove(),e(t).addClass("sb-success").find(".sb-content").html(`<div class="sb-text">${i}</div>`)},getRegistrationErrorMessage(t,i="validation"){if("response"==i)return U.errorValidation(t,"duplicate-email")?"This email is already in use. Please use another email.":U.errorValidation(t,"duplicate-phone")?"This phone number is already in use. Please use another number.":"Error. Please check your information and try again.";let s=e(t).find("#last_name").length?"First name, last name":"Name",a=e(t).find("#phone [required]").length?", phone number":"",n=e(t).find("#email").length?", email":"",o=e(t).find("#password").length?", and a password (8 character minimum)":"";return`${s}${n}${a}${o} ${n+a+o==""?"is":"are"} required.`}};window.SBForm=J;var X={login:function(){return this.is("wp")&&typeof SB_WP_ACTIVE_USER!=L&&"wp"==C["wp-users-system"]?[[SB_WP_ACTIVE_USER,typeof SB_WP_AVATAR!=L?SB_WP_AVATAR:""],"wp"]:typeof SB_PERFEX_ACTIVE_USER!=L?[[SB_PERFEX_ACTIVE_USER,SB_PERFEX_CONTACT_ID],"perfex"]:typeof SB_WHMCS_ACTIVE_USER!=L?[SB_WHMCS_ACTIVE_USER,"whmcs"]:typeof SB_AECOMMERCE_ACTIVE_USER!=L?[SB_AECOMMERCE_ACTIVE_USER,"aecommerce"]:typeof SB_DEFAULT_USER!=L&&[SB_DEFAULT_USER,"default"]},is:function(e){return b?SBAdmin.apps.is(e):"wordpress"==e||"wp"==e?C.wp:e in C&&C[e]},wordpress:{ajax:function(t,i,s=!1){typeof SB_WP_AJAX_URL!=L&&e.ajax({method:"POST",url:SB_WP_AJAX_URL,data:e.extend({action:"sb_wp_ajax",type:t},i)}).done((e=>{s&&s(e)}))}},dialogflow:{token:q("dialogflow-token"),typing_enabled:!1,project_id:!1,message:function(e="",t=[],i=!1,s=!1){if(this.active()){let a=X.dialogflow.humanTakeoverActive();a&&!this.typing_enabled||(y=setTimeout((()=>{V.typing(-1,"start"),setTimeout((()=>{V.typing(-1,"stop")}),1e4)}),1e3)),setTimeout((()=>{U.ajax({function:"dialogflow-message",conversation_id:!!V.conversation&&V.conversation.id,message:e,attachments:t,parameters:s,token:this.token,dialogflow_language:q("dialogflow-language")?q("dialogflow-language"):SB_LANG,project_id:this.project_id},(t=>{if(!1!==t){if("human_takeover"in t)return V.offlineMessage(),V.followUp(),this.active(!1);if("language_detection"in t&&!q("dialogflow-language")&&q("dialogflow-language",[t.language_detection]),!U.errorValidation(t)){let s="queryResult"in t.response&&t.response.queryResult,n=s&&("input.unknown"==s.action||"match"in s&&"NO_MATCH"==s.match.matchType),o="messages"in t&&Array.isArray(t.messages)?t.messages:[];if(V.typing(-1,"stop"),clearTimeout(y),this.token!=t.token&&(this.token=t.token,q("dialogflow-token",t.token)),n?a&&(this.typing_enabled=!1):this.typing_enabled=!0,s){if("action"in s){let e=s.action;"end"==e&&this.active(!1),U.event("SBBotAction",e)}for(var i=0;i<o.length;i++){if("payload"in o[i]){let e=["human-takeover","redirect","transcript","department","agent","send-email","disable-bot","rich-message"],t=o[i].payload;if(U.null(t)&&(t=[]),e[0]in t&&!0===t[e[0]]&&this.humanTakeover(),e[1]in t&&setTimeout((function(){"new-window"in t&&t["new-window"]?window.open(t[e[1]]):document.location=t[e[1]]}),500),e[4]in t&&V.showArticles(t[e[4]]),e[5]in t&&t[e[5]]&&U.ajax({function:"transcript",conversation_id:V.conversation.id,type:"txt"},(i=>{"email"==t[e[5]]&&G().get("email")?V.sendEmail("message"in t?t.message:"",[[i,i]],!0):window.open(i)})),e[6]in t&&U.ajax({function:"update-conversation-department",conversation_id:V.conversation.id,department:t[e[6]],message:V.conversation.getLastUserMessage().message}),e[7]in t&&U.ajax({function:"update-conversation-agent",conversation_id:V.conversation.id,agent_id:t[e[7]],message:V.conversation.getLastUserMessage().message}),e[8]in t){let i=t[e[8]];V.sendEmail(i.message,i.attachments,"active_user"==i.recipient)}e[9]in t&&(this.active(!1),U.cookie("sb-dialogflow-disabled",!0,300,"set",!0)),e[10]in t&&V.sendMessage(p,t[e[10]]),U.event("SBBotPayload",t)}q("dialogflow-language")||!("languageCode"in s)||SB_LANG&&s.languageCode==SB_LANG[0]||q("dialogflow-language",[s.languageCode])}if("diagnosticInfo"in s){let e=s.diagnosticInfo;"end_conversation"in e&&e.end_conversation&&this.active(!1)}}U.event("SBBotMessage",{response:t,message:e})}}}))}),!1!==i?i:0==C["bot-delay"]?2e3:parseInt(C["bot-delay"]))}},active:function(e=!0){let t="human-takeover-"+V.conversation.id;return!1===e?(U.storageTime(t),!1):("activate"==e&&(U.cookie("sb-dialogflow-disabled",0,0,"delete"),U.storage(t,"")),C["dialogflow-active"]&&!b&&!U.cookie("sb-dialogflow-disabled")&&(U.storageTime(t,240)||!V.agent_online)&&(!C["bot-office-hours"]||!C["office-hours"]))},welcome:function(e=!1,t=!1){U.ajax({function:"dialogflow-message",message:"",conversation_id:V.conversation.id,token:this.token,event:"Welcome",dialogflow_language:q("dialogflow-language")?q("dialogflow-language"):SB_LANG},(()=>{e&&V.start(),t&&V.audio.play()}))},humanTakeover:function(){U.ajax({function:"dialogflow-human-takeover",conversation_id:V.conversation.id},(()=>{V.offlineMessage(),V.followUp(),this.active(!1),C["queue-human-takeover"]&&(C.queue=!0,V.queue(V.conversation.id))}))},humanTakeoverActive:function(){return!U.storageTime("human-takeover-"+(V.conversation?V.conversation.id:q("open-conversation")),240)},translate:function(e,t,i){U.ajax({function:"google-translate",strings:e,language_code:t,token:this.token},(e=>{this.token=e[1],i(e[0])}))}}};function Y(){function a(){setTimeout((()=>{e(".bi-arrow-up-circle-fill").removeClass("sb-hide")}),500)}(t=e(".sb-admin, .sb-chat, .sb-tickets")).length&&typeof SB_AJAX_URL!=L?(n=t.find(".sb-list"),o=t.find(".sb-editor"),r=o.find("textarea"),u=t.find(b||_?".sb-list":"> div > .sb-scroll-area"),h=t.find(".sb-label-date-top"),l=u.find(".sb-header"),d=o.find(".sb-emoji"),c=_?t.find(".sb-profile-agent .sb-status"):null,V.enabledAutoExpand(),V.audio=t.find("#sb-audio").get(0),V.audio_out=t.find("#sb-audio-out").get(0),U.cookie("sb-check","ok",1,"set"),"ok"!=U.cookie("sb-check")?(D=!1,console.warn("Routin.bot: cookies not available.")):U.cookie("sb-check",!1,!1,!1),b?U.event("SBReady"):(U.ajax({function:"get-front-settings",current_url:window.location.href},(t=>{C=t,typeof SB_LOCAL_SETTINGS!=L&&e.extend(C,SB_LOCAL_SETTINGS),p=C["bot-id"],m=C["dialogflow-human-takeover"],I=C["agents-online"],O.active=C.pusher,typeof SB_REGISTRATION_REQUIRED!=L&&(C["registration-required"]=SB_REGISTRATION_REQUIRED,C["tickets-registration-required"]=SB_REGISTRATION_REQUIRED),typeof SB_ARTICLES_PAGE!=L&&SB_ARTICLES_PAGE&&V.initArticlesPage(),_&&C["tickets-manual-init"]||(!_||C["tickets-manual-init"])&&(C["chat-manual-init"]||C["disable-offline"]&&!I||C["disable-office-hours"]&&!C["office-hours"]||C["chat-login-init"]&&!X.login())||V.initChat(),C.cron&&setTimeout((function(){U.ajax({function:"cron-jobs"})}),1e4),C["cron-email-piping"]&&setTimeout((function(){U.ajax({function:"email-piping"})}),8e3),C["push-notifications-users"]&&O.initServiceWorker(),_&&(C["tickets-default-department"]&&(V.default_department=C["tickets-default-department"]),C["dialogflow-disable-tickets"]&&(C["dialogflow-active"]=!1)),U.event("SBReady")})),V.audio&&(V.audio.volume=.6),V.audio_out&&(V.audio_out.volume=.6)),e(o).on("keydown","textarea",(function(e){if(13==e.which&&(!_||C["tickets-enter-button"])&&(!b||!e.ctrlKey&&!e.shiftKey))return V.submit(),e.preventDefault,!1;b&&13==e.which&&e.ctrlKey&&V.insertText("\n")})),e(t).on("keydown",".sb-dashboard-articles input",(function(t){13==t.which&&e(this).next().click()})),typeof SB_DEFAULT_DEPARTMENT!==L&&(V.default_department=SB_DEFAULT_DEPARTMENT),typeof SB_DEFAULT_AGENT!==L&&(V.default_agent=SB_DEFAULT_AGENT),typeof SB_DIALOGFLOW_TAGS!==L&&(V.default_tags=SB_DEFAULT_TAGS),typeof SB_DIALOGFLOW_AGENT!==L&&(X.dialogflow.project_id=SB_DIALOGFLOW_AGENT)):U.event("SBReady"),document.addEventListener("visibilitychange",(function(){U.visibilityChange(document.visibilityState)}),!1),e(t).on("click",(function(){V.tab_active||U.visibilityChange()})),i=t,b&&(t=t.find(".sb-conversation")),e(u).on("scroll",(function(){let t=u.scrollTop(),i=k.length;if(V.scrollHeader(),A&&(h.sbActive(!0),clearTimeout(w[0]),w[0]=setTimeout((()=>{h.sbActive(!1)}),1500)),i)if(V.isBottom())h.html(e(k[i-1]).html());else for(var s=0;s<i;s++){let i=k[s].getBoundingClientRect().top;if(i>100&&i<150){let i=e(k[$[0]>t&&s>0?s-1:s]).html();i!=$[1]&&(h.html(i),$[1]=i);break}}$[0]=t})),e(n).on("click",".sb-menu-btn",(function(){let t=e(this).parent().find(".sb-menu"),i=e(t).sbActive();U.deactivateAll(),i||(e(t).sbActive(!0),U.deselectAll(),b&&(SBAdmin.open_popup=t))})),B&&(e(o).on("click",".sb-textarea",(function(){t.addClass("sb-header-hidden"),e(this).find("textarea").focus(),V.isBottom()&&(V.scrollBottom(),setTimeout((()=>{V.scrollBottom()}),200))})),e(o).on("focusout",".sb-textarea",(function(){setTimeout((()=>{t.removeClass("sb-header-hidden")}),300)})),e(o).on("click",".sb-submit",(function(){r.blur()})),window.addEventListener("popstate",(function(){V.chat_open&&V.open(!1)}))),e(n).on("click",".sb-menu li",(function(){e(this).parent().sbActive(!1)})),e(t).on("click","#load-more",(function(){let t=new z;N+=30,console.log("set",C),t.setLoad(N),e(this).text(""),e(this).sbLoading(!0),e(this).attr("id",""),G().getFullConversation(V.conversation.id,(t=>{e(this).sbLoading(!1),e(this).html('<i style="font-size:1.2rem" class="bi-arrow-up-circle"></i>'),e(this).attr("id","load-more"),V.loadUpdate(t.messages)}),t.getLoad()),f<=t.getLoad()&&e(".load-more").hide()})),e(o).on("click",".sb-submit",(function(){V.submit()})),e("body").on("click",".sb-chat-btn,.sb-responsive-close-btn,#sb-open-chat,.sb-open-chat",(function(){V.open(!V.chat_open)})),e(t).on("click",".sb-dashboard-btn",(function(){V.showDashboard(),u.find(" > .sb-panel-articles > .sb-article").length&&V.showArticles(),q("open-conversation",0),j=!1})),e("#template-form").on("submit",(function(s){s.preventDefault();const a=(new Metatemplate).payload("#template-form"),n={type:a.type,to:G().getExtra("phone").value,template_name:a.template_name,language:a.language,variables:a.variables,image_url:a.image_url};console.log("Payload:",n);const o=e("#send-meta-template");o.sbLoading(!0),U.ajax({function:"whatsapp-send-meta-template",payload:n},(s=>{o.sbLoading(!1),s?.error&&s.error.message?J.showErrorMessage(e(".sb-admin").find(".sb-send-template-box"),s.error.message):s&&(V.sendMessage(-1,`*~Registro de contacto*, {agent_name} \n\n ${a.BodyTemplate}`,!1),V.showResponse(`${a.BodyTemplate}`),e(b?i:t).find(".sb-lightbox-media, .sb-lightbox-overlay, .sb-send-template-box").sbActive(!1)),console.log("temp",s)}))})),U.get_select_setting(),e(t).on("click",".sb-user-conversations li",(function(){V.openConversation(e(this).attr("data-conversation-id"))})),e(t).on("click",".sb-btn-new-conversation,.sb-departments-list > div,.sb-agents-list > div",(function(){let t=e(this).data("id");U.null(t)||(e(this).parent().hasClass("sb-departments-list")?V.default_department=parseInt(t):V.default_agent=parseInt(t)),j="new-conversation",V.clear(),V.hideDashboard()})),e(t).on("click",".sb-btn-all-conversations",(function(){t.find(".sb-dashboard-conversations").removeClass("sb-conversations-hidden")})),e(o).on("click",".bi-paperclip",(function(){V.is_busy||(o.find(".sb-upload-files").val("").click(),o.find(".bi-arrow-up-circle-fill").removeClass("sb-hide"),console.log("to upload file"))})),e(o).on("click",".sb-attachments > div > i",(function(t){return e(this).parent().remove(),""==r.val()&&0==o.find(".sb-attachments > div").length&&V.activateBar(!1),t.preventDefault(),!1})),e(o).on("change",".sb-upload-files",(function(t){V.busy(!0),e(this).sbUploadFiles((function(e){V.uploadResponse(e)})),U.event("SBAttachments")})),e(o).on("dragover",(function(t){e(this).addClass("sb-drag"),clearTimeout(y),t.preventDefault(),t.stopPropagation(),a()})),e(o).on("dragleave",(function(t){y=setTimeout((()=>{e(this).removeClass("sb-drag"),a()}),200),t.preventDefault(),t.stopPropagation()})),e(o).on("drop",(function(t){let i=t.originalEvent.dataTransfer.files;if(t.preventDefault(),t.stopPropagation(),i.length>0)for(var s=0;s<i.length;++s){let e=new FormData;e.append("file",i[s]),U.upload(e,(function(e){V.uploadResponse(e)}))}return e(this).removeClass("sb-drag"),!1})),e(t).on("click",".sb-btn-all-articles:not([onclick])",(function(){V.showArticles()})),e(t).on("click",".sb-articles > div:not(.sb-title)",(function(){V.showArticles(e(this).attr("data-id"))})),e(t).on("click",".sb-dashboard-articles .sb-input-btn .sb-submit-articles",(function(){V.searchArticles(e(this).parent().find("input").val(),this,e(this).parent().next())})),e(i).on("click",".sb-article [data-rating]",(function(){V.articleRatingOnClick(this)})),e(n).on("click",".sb-rich-button a",(function(t){let i=e(this).attr("href");if(0===i.indexOf("#")&&0===i.indexOf("#article-"))return V.showArticles(i.replace("#article-","")),t.preventDefault(),!1})),e(i).on("click",".sb-lightbox-media > i",(function(){return i.find(".sb-lightbox-media").sbActive(!1),b&&(SBAdmin.open_popup=!1),!1})),e(t).on("click",".sb-image",(function(){U.lightbox(e(this).html())})),e(t).on("click",".sb-slider-images .sb-card-img",(function(){U.lightbox(`<img loading="lazy" src="${e(this).attr("data-value")}" />`)})),e(t).on("click",".sb-image",(function(){U.lightbox(e(this).html())})),e(t).on("click",".sb-slider-images .sb-card-img",(function(){U.lightbox(`<img loading="lazy" src="${e(this).attr("data-value")}" />`)})),e(document).on("SBConversationLoaded",(function(){q("queue")&&V.queue(q("queue"))})),e(o).on("click",".bi-emoji-grin",(function(){V.showEmoji(this)})),e(d).on("click",".sb-emoji-list li",(function(t){V.insertEmoji(e(this).html()),B&&clearTimeout(y)})),e(d).find(".sb-emoji-list").on("touchend",(function(e){y=setTimeout((()=>{V.mouseWheelEmoji(e)}),50)})),e(d).find(".sb-emoji-list").on("mousewheel DOMMouseScroll",(function(e){V.mouseWheelEmoji(e)})),e(d).find(".sb-emoji-list").on("touchstart",(function(e){V.emoji_options.touch=e.originalEvent.touches[0].clientY}),{passive:!0}),e(d).on("click",".sb-emoji-bar > div",(function(){V.clickEmojiBar(this)})),e(d).on("click",".sb-select li",(function(){V.categoryEmoji(e(this).data("value"))})),e(d).find(".sb-search-btn input").on("change keyup paste",(function(){V.searchEmoji(e(this).val())})),e(r).on("keyup",(function(){V.textareaChange(this)})),e(t).on("click",".sb-privacy .sb-approve",(function(){q("privacy-approved",!0),e(this).closest(".sb-privacy").remove(),t.removeClass("sb-init-form-active"),l.find(" > div").css({opacity:1,top:0}),V.initChat(),_?SBTickets.showPanel("new-ticket"):V.isInitDashboard()||V.hideDashboard()})),e(t).on("click",".sb-privacy .sb-decline",(function(){let t=e(this).closest(".sb-privacy");e(t).find(".sb-text").html(e(t).attr("data-decline")),e(t).find(".sb-decline").remove(),V.scrollBottom(!0)})),e(t).on("click",".sb-popup-message .bi-x-lg",(function(){V.popup(!0)})),e(t).on("click",".sb-rich-message .sb-submit,.sb-rich-message .sb-select ul li",(function(){let t=e(this).closest(".sb-rich-message");t[0].hasAttribute("disabled")||H.submit(t,t.attr("data-type"),this)})),e(t).on("click",".sb-rich-message .sb-input > span",(function(){e(this).sbActive(!0),e(this).siblings().focus()})),e(t).on("focus focusout click",".sb-rich-message .sb-input input,.sb-rich-message .sb-input select",(function(t){switch(t.type){case"focusin":case"focus":e(this).siblings().sbActive(!0);break;case"focusout":""==e(this).val()?e(this).siblings().sbActive(!1):e(this).siblings().addClass("sb-filled sb-active");break;case"click":e(this).siblings().removeClass("sb-filled")}})),e(t).on("click",".sb-slider-arrow",(function(){H.sliderChange(e(this).closest("[id]").attr("id"),e(this).hasClass("bi-chevron-right")?"right":"left")})),e(t).on("change",'.sb-rich-message [data-type="select"] select',(function(){e(this).siblings().sbActive(!0)})),e(t).on("click",'[data-type="select-input"] > div',(function(){e(this).prev().sbActive(!0),e(this).next().addClass("sb-focus")})),e(t).on("focusout",'[data-type="select-input"] input,[data-type="select-input"] select',(function(){let t=e(this).closest(".sb-input");t.find('input[type="tel"]').val()+t.find("select").val()==""&&t.find("span").sbActive(!1),t.find(".sb-focus").removeClass("sb-focus")})),e(t).on("click",".sb-rich-registration .sb-login-area",(function(){let i=t.hasClass("sb-init-form-active");e(this).closest(".sb-rich-registration").replaceWith(H.generate({},"login",i?"sb-init-form":"")),V.scrollBottom(i)})),e(t).on("click",".sb-rich-login .sb-registration-area",(function(){if(C["registration-link"])document.location=C["registration-link"];else{let i=t.hasClass("sb-init-form-active");e(this).closest(".sb-rich-login").replaceWith(H.generate({},"registration",i?"sb-init-form":"")),V.scrollBottom(i)}})),e(t).on("click",".sb-rich-login .sb-submit-login",(function(){U.loginForm(this,!1,(i=>{let s=e(this).closest(".sb-rich-login");if(G(new P(i[0])),s.hasClass("sb-init-form"))t.removeClass("sb-init-form-active"),s.remove(),j="open-conversation",V.initChat(),O.start(),V.isInitDashboard()||V.hideDashboard();else{s=s.closest("[data-id]");let e=V.conversation.getMessage(s.attr("data-id")),t=`${F("Logged in as")} *${G().name}*`;e.set("message",t),V.updateMessage(e.id,t),s.replaceWith(e.getCode()),O.started=!1,O.start()}}))})),e(n).on("click",".sb-social-buttons div",(function(){U.openWindow(e(this).attr("data-link"))})),e(t).on("click",".sb-close-chat",(function(){V.closeChat()})),e(i).on("click",".sb-search-btn > i",(function(){let t=e(this).parent(),s=e(t).sbActive();s&&(setTimeout((()=>{e(t).find("input").val("")}),50),setTimeout((()=>{e(t).find("input").trigger("change")}),550)),e(t).sbActive(!s),e(t).find("input").focus(),i.find(".sb-select ul").sbActive(!1)})),e(i).on("click",".sb-select",(function(){let t=e(this).find("ul"),s=t.hasClass("sb-active");e(i).find(".sb-select ul").sbActive(!1),t.setClass("sb-active",!s),b&&(SBAdmin.open_popup=!s&&this)})),e(i).on("click",".sb-select li",(function(){let t=e(this).closest(".sb-select"),i=e(this).data("value");var s=e(t).find(`[data-value="${i}"]`);e(t).find("li").sbActive(!1),e(t).find("p").attr("data-value",i).html(e(s).html()),e(s).sbActive(!0)})),e(i).on("click",".sb-input-image .image",(function(){s=e(this).parent(),o.find(".sb-upload-files").click()})),e(i).on("click",".sb-input-image .image > .bi-x-lg",(function(t){return e(this).parent().removeAttr("data-value").css("background-image",""),t.preventDefault(),!1}));e(i).on("click",'.sb-message.sb-location, .sb-message p a[href^="https://maps.google.com/"]',(function(t){t.preventDefault();let i=e(this).closest(".sb-location").attr("data-location"),s=e(this).attr("href");if(!i){const e=s.match(/\/\?q=([\d\.\-]+),([\d\.\-]+)/);e&&e.length>=3&&(i=e[1]+","+e[2])}if(i){const t='<iframe src="https://maps.google.com/maps?q='+i+'&output=embed"></iframe>';e(this).closest(".sb-message").html(t)}else window.open(s,"_blank")}))}window.SBApps=X,e(document).ready((function(){if((t=e(".sb-admin, .sb-admin-start")).length)return b=!0,void Y();let i,s,a=!1;if(typeof SB_INIT_URL!=L)SB_INIT_URL.indexOf(".js")<0&&(SB_INIT_URL+="/js/min/main.js"),i=SB_INIT_URL;else{let e=document.getElementsByTagName("script"),t=["min/main.js"];for(var n=0;n<e.length;n++){let s=e[n].src;if("routin"==e[n].id){i=s,a=a||i.includes("init.");break}for(var o=0;o<t.length;o++)if(s.includes("/c/js/"+t[o])){i=s,a=a||i.includes("init.");break}}}let r=U.getURL(!1,i);if("url"in r&&(i=r.url),typeof SB_DISABLED!=L&&SB_DISABLED)return;if(a)return void Y();(typeof SB_TICKETS!=L||"mode"in r&&"tickets"==r.mode)&&(_=!0,r.mode="tickets"),"cloud"in r&&(R=r.cloud);let l=i.lastIndexOf("main.js");s=i.substr(0,i.lastIndexOf("main.js")>0?i.lastIndexOf("main.js")-4:l-8);let c=s+"/include/init.php"+("lang"in r?"?lang="+r.lang:"")+("mode"in r?"&mode="+r.mode:"")+(R?"&cloud="+R:"");U.cors("GET",c.replace(".php&",".php?"),(t=>{let i="body";_&&e("#sb-tickets").length&&(i="#sb-tickets"),e(i).append(t),U.loadResource(s+"/css/"+(_?"tickets":"main")+".css"),_?e.getScript(s+"/apps/tickets/tickets"+(l?".min":"")+".js?v="+v,(()=>{Y()})):Y()}))}))}(jQuery);var selectedSource="tk";function updateSource(e){selectedSource=e,console.log("Selected Source:",selectedSource)}let isSpeechSynthesisActive=!1,utterance=null;function readText(e){if(!isSpeechSynthesisActive){let t="es-US",i=1,s=1.2;utterance=new SpeechSynthesisUtterance(e),utterance.lang=t,utterance.rate=i,utterance.pitch=s,utterance.onstart=function(){isSpeechSynthesisActive=!0},utterance.onend=function(){isSpeechSynthesisActive=!1},window.speechSynthesis.speak(utterance)}}$(document).on("click",'.sb-menu li[data-value="read-text"]',(function(e){e.stopPropagation();let t=$(this).closest(".sb-shadow-conversation").data("id");readText($('.sb-shadow-conversation[data-id="'+t+'"] .sb-message').text())})),window.addEventListener("beforeunload",(function(e){window.speechSynthesis.cancel(),isSpeechSynthesisActive=!1})),$(document).on("click",(function(e){window.speechSynthesis.cancel(),isSpeechSynthesisActive=!1}));