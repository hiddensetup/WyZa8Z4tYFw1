"use strict";!function(x){var k,i,e,s,f,d,u,a,n,o,r,l,t,A,T,N,c="2.28",C=!1,b=!1,_=!1,U=[!1,!1],O=!1,q=[],F=!1,G=!1,P=[9999999,""],z=document.title,$={},h=x(window).width()<555,W=new Date,g="",V=!1,p="undefined",H=!0,J=6e4*(new Date).getTimezoneOffset(),m=!1,X=30,B=(x.fn.extend({manualExpandTextarea:function(){var e=this[0];e.style.height="auto",e.style.maxHeight="25px",window.getComputedStyle(e),e.style.height=(350<e.scrollHeight?350:e.scrollHeight)+"px",e.style.maxHeight="",x(e).trigger("textareaChanged")},autoExpandTextarea:function(){var t=this[0];t.addEventListener("input",function(e){x(t).manualExpandTextarea()},!1)}}),!function(){String.prototype.autoLink=function(){var e=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|]+)/gi,a=0<arguments.length?[].slice.call(arguments,0)[0]:{},n=function(){var e,t=[];for(e in a)"callback"!==e&&t.push(" "+e+"='"+a[e]+"'");return t.join("")}();return this.replace(e,function(e,t,s){var i;return s.match(/maps.google.com/g)?(i=s.match(/q=([\d.-]+),([\d.-]+)/))?"<iframe width='270' height='270' frameborder='0' style='border-radius:4px; border: 0; width: auto;' src='https://maps.google.com/maps?q="+i[1]+","+i[2]+"&amp;output=embed'></iframe>":"<iframe width='270' height='270' frameborder='0' style='border:0;' src='https://maps.google.com/maps?q=-00.000000,-00.000000&amp;output=embed'></iframe>":t+("function"==typeof a.callback?a.callback(s):"")+"<a href='"+s+"'"+n+">"+s+"</a>"+("function"==typeof a.callback?"":" ")})}}.call(this),{ajax:function(s,i=!1){s["login-cookie"]=this.loginCookie(),"user_id"in s||!L()||(s.user_id=L().id),"language"in s||typeof SB_LANG==p||(s.language=SB_LANG),m&&(s.cloud=m),x.ajax({method:"POST",url:SB_AJAX_URL,data:s}).done(t=>{let e;if(Array.isArray(t))e=t;else try{e=JSON.parse(t)}catch(e){return D.is_busy_update=!1,D.busy(!1),void B.error(500<t.length?t.substr(0,500)+"... Check the console for more details.":t,"SBF.ajax."+s.function)}"success"==e[0]?i&&i(e[1]):B.errorValidation(e)?i&&i(e):(C&&"security-error"==e[1]&&setTimeout(()=>{B.reset()},1e3),D.is_busy_update=!1,D.busy(!1),B.error(e[1]+(B.null(e[2])?"":"\nFunction name: "+e[2])+(B.null(e[3])?"":"\nError message: "+("string"!=typeof e[3]&&"error"in e[3]&&"message"in e[3].error?`${e[3].error.message} in function '${e[3].error.function}'`:e[3])),"SBF.ajax."+s.function))})},cors:function(e="GET",t,s){let i=new XMLHttpRequest;if("withCredentials"in i)i.open(e,t,!0);else{if(typeof XDomainRequest==p)return!1;(i=new XDomainRequest).open(e,t)}i.onload=function(){s(i.responseText)},i.onerror=function(){return!1},i.send()},upload:function(e,t){m&&e.append("cloud",m),jQuery.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:e,type:"POST",success:function(e){t(e)}})},getHostname:function(e){return new URL(e).hostname.replace("www.","")},limitText:function(e,t){e=null!=e?e.slice(0,t):"";return e.length>t-1?e+"...":e},UTC:function(e){return new Date(e).getTime()-J},null:function(e){return typeof e===p||null===e||"null"===e||!1===e||!(0<e.length||"number"==typeof e||typeof e.length==p)||e===p},deactivateAll:function(){i.find(".sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul").sbActive(!1)},deselectAll:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getURL:function(e=!1,t=!1){if(0==t&&(t=location.search),0!=e)return 0<t.indexOf("?")&&(t=t.substr(0,t.indexOf("?"))),B.escape(decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(t)||[,""])[1].replace(/\+/g,"%20")||""));for(var s=t.split("?").pop().split("&"),i={},a=0;a<s.length;a++){var n=s[a].split("=");i[n[0]]=B.escape(n[1])}return i},URL:function(){return window.location.href.substr(0,window.location.href.indexOf("?"))},stringToSlug:function(e){e=(e=e.trim()).toLowerCase();for(var t="åàáãäâèéëêìíïîòóöôùúüûñç·/_,:;",s=0,i=t.length;s<i;s++)e=e.replace(new RegExp(t.charAt(s),"g"),"aaaaaaeeeeiiiioooouuuunc------".charAt(s));return e.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g,"")},slugToString:function(e){return(e=e.replace(/_/g," ").replace(/-/g," ")).charAt(0).toUpperCase()+e.slice(1)},random:function(){let e="";for(var t=5;0<t;--t)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return e},isAgent:function(e){return"agent"==e||"admin"==e||"bot"==e},beautifyTime:function(e,t=!1,s=!1){let i;var a,n;return"0000-00-00 00:00:00"==e?"":(i=0<e.indexOf("-")?(a=e.split(/[- :]/),new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5])):(a=e.split(/[. :]/),new Date(a[2],a[1]-1,a[0],a[3],a[4],a[5])),e=new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds())),a=Math.round((new Date-e)/864e5)*(s?-1:1),s=[j("Sunday"),j("Monday"),j("Tuesday"),j("Wednesday"),j("Thursday"),j("Friday"),j("Saturday")],n=e.toLocaleTimeString(navigator.language,{hour:"2-digit",minute:"2-digit",hour12:!1}),a<1?t?`<span>${j("Today")}</span> <span>${n}</span>`:`<span style="text-transform: uppercase;" data-today>${n}</span>`:a<3?`<span>${s[e.getDay()]}</span>`+(t?` <span>${n}</span>`:""):`<span>${e.toLocaleDateString()}</span>`+(t?` <span>${n}</span>`:""))},unix:function(e){e=e.split(/[- :]/);return Date.UTC(e[0],e[1]-1,e[2],e[3],e[4],e[5])},getLocationTimeString:function(e,s){if("timezone"in e){let t={};t.timezone=e.timezone.value,t.country="country"in e?e.country.value:t.timezone.split("/")[0].replace(/_/g," "),t.city="city"in e?e.city.value:t.timezone.split("/")[1].replace(/_/g," "),B.cors("GET","https://worldtimeapi.org/api/timezone/"+t.timezone,function(e){e=JSON.parse(e),B.null(e)||!B.null(e.error)?(B.error(e,"SBF.getLocationTimeString()"),s(responseonSuccess)):(e=e.datetime.replace("T"," "),s(`${new Date(e.substr(0,e.indexOf("."))).toLocaleString([],{hour:"2-digit",minute:"2-digit"})} ${j("in")} `+(t.city||"")+(t.country?", "+t.country:"")))})}},dateDB:function(e){return"now"==e?0<(e=(new Date).toISOString().replace("T"," ")).indexOf(".")?e.substr(0,e.indexOf(".")):e:`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${e.getMinutes()}:`+e.getSeconds()},localTime:function(e,t){return 0!=e?B.getTimezoneOffset(t)==(new Date).getTimezoneOffset()?e:moment(e).format("MM/DD/YYYY hh:mm A"):""},getTimezoneOffset:function(e){var t=new Date,e=t.toLocaleString("en-US",{timeZone:e}),e=new Date(e),s=new Date(t.getTime()),e=Math.round((e.getTime()-s.getTime())/6e4);return t.getTimezoneOffset()-e},updateUsersActivity:function(e,t,s){E.active?s(E.online_ids.includes(t)?"online":"offline"):B.ajax({function:"update-users-last-activity",user_id:e,return_user_id:t},e=>{s("online"===e?"online":"offline")})},search:function(e,t){(e=e.toLowerCase())==s?i.find(".sb-search-btn i").sbLoading(!1):(clearTimeout(_),_=setTimeout(function(){s=e,t()},200))},searchClear:function(e,t){x(e).next().val()&&(x(e).next().val(""),t())},error:function(e,t){if(!C||!SBAdmin.is_logout)throw(e="."==(e=e instanceof Error?e.message:e)[e.length-1]?e.slice(0,-1):e).includes("Steambox error")&&(e=e.replace("Steambox error ","").replace("]:","]")),C&&e&&!t.includes("update-users-last-activity")&&!t.startsWith("security-error")&&SBAdmin.dialog(`[Error] [${t}] ${e}. Check the console for more details.`,"info"),i.find(".sb-loading").sbLoading(!1),B.event("SBError",{message:e,function_name:t}),new Error(`Steambox error [${t}]: ${e}.`)},errorValidation:function(e,t=!0){return Array.isArray(e)&&"validation-error"===e[0]&&(!0===t||e[1]==t)},loginForm:function(s,i=!1,a=!1){var e,t;(s=x(s)).sbLoading()||(i=!1===i?s.closest(".sb-rich-login"):x(i),e=x.trim(i.find("#email input").val()),t=x.trim(i.find("#password input").val()),""==e||""==t?i.find(".sb-info").html(j("Please insert email and password.")).sbActive(!0):(B.ajax({function:"login",email:e,password:t},e=>{var t;e&&Array.isArray(e)?!C&&this.isAgent(e[0].user_type)?(M.showErrorMessage(i,"You cannot sign in as an agent."),D.scrollBottom()):((t=new I(e[0])).set("conversation_id",!!D.conversation&&D.conversation.id),this.loginCookie(e[1]),this.event("SBLoginForm",t),a&&a(e)):(i.find(".sb-info").html(j("Invalid email or password.")).sbActive(!0),C||D.scrollBottom()),s.sbLoading(!1)}),i.find(".sb-info").html("").sbActive(!1),s.sbLoading(!0)))},loginCookie:function(e=!1){if(!1===e)return this.cookie("sb-login")?this.cookie("sb-login"):y("login");$.cloud?y("login",e):this.cookie("sb-login",e,2,"set")},login:function(e="",t="",s="",i="",a=!1){B.ajax({function:"login",email:e,password:t,user_id:s,token:i},e=>!(0==e||!Array.isArray(e)||(this.loginCookie(e[1]),a&&a(e),0)))},logout:function(e=!0){D.stopRealTime(),this.cookie("sb-login","","",!1),y("open-conversation",""),y("login",""),L(D.conversations=!1),typeof sb_beams_client!==p&&sb_beams_client.stop(),B.ajax({function:"logout"},()=>{B.event("SBLogout"),e&&setTimeout(()=>{location.reload()},500)})},activeUser:function(){return L()},getReply:function(e){return new RegExp("^([{,+,0-9,}]+[@s.whatsapp.net])").test(e)},getActiveUser:function(e=!1,s){let i=R.login();!i&&(y("wp-login")||y("whmcs-login")||y("perfex-login")||y("aecommerce-login"))&&(this.cookie("sb-login","","","delete"),L(!1),y("login","")),B.ajax({function:"get-active-user",db:e,login_app:JSON.stringify(i),user_token:B.getURL("token")},e=>{if(!e)return s(),!1;var t;"cookie"in e&&B.loginCookie(e.cookie),"user_type"in e&&(!C&&B.isAgent(e.user_type)?(t="Cierra sesión o utiliza otro navegador para  ver el botón de chat o iniciar sesión como usuario registrado. Puedes deslogearte escribiendo SBF.reset() en la consola del navegador.",y("double-login-alert")||(y("double-login-alert",!0),alert(t)),console.warn("Steambox: "+t),B.event("SBDoubleLoginError")):(L(new I(e,"phone"in e?{phone:e.phone}:{})),E.start(),i&&y(i[1]+"-login",!0),s(),B.event("SBActiveUserLoaded",e)))})},reset:function(){for(var e=["sb-login","sb-cloud","sb-dialogflow-disabled"],t=0;t<e.length;t++)this.cookie(e[t],"",0,!1);try{localStorage.removeItem("steambox-storage")}catch(e){}this.logout()},lightbox:function(e){var t=x(C?i:k).find(".sb-lightbox-media");t.sbActive(!0).find(" > div").html(e),C&&(SBAdmin.open_popup=t)},storage:function(e,t=p){try{if(typeof localStorage==p)return!1}catch(e){return!1}let s=localStorage.getItem("steambox-storage");if(s=null===s?{}:JSON.parse(s),t===p)return e in s&&s[e];t?s[e]=t:delete s[e],localStorage.setItem("steambox-storage",JSON.stringify(s))},storageTime:function(e,t=!1){if(!1!==t)return 0==y(e)||W.getTime()-y(e)>36e5*t;y(e,W.getTime())},cookie:function(e,t=!1,s=!1,i="get",a=!1){var n="https:"==location.protocol?"SameSite=None;Secure;":"",o=window[C?"SB_ADMIN_SETTINGS":"CHAT_SETTINGS"],o=o&&o["cookie-domain"]?"domain="+o["cookie-domain"]+";":"";if("get"==i){if(!H)return this.storage(e);for(var r=document.cookie.split(";"),l=0;l<r.length;l++){for(var c,d=r[l];" "==d.charAt(0);)d=d.substring(1);if(0==d.indexOf(e))return c=d.substring(e.length+1,d.length),!this.null(c)&&c}return!1}"set"==i?H?((i=new Date).setTime(i.getTime()+s*(a?1:86400)*1e3),document.cookie=e+"="+t+";expires="+i.toUTCString()+";path=/;"+n+o):this.storage(e,t):this.cookie(e)&&(H?document.cookie=e+"="+t+";expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;"+n+o:this.storage(e,""))},setting:function(e){return typeof $!==p&&e in $&&$[e]},get_select_setting:function(){d&&B.ajax({function:"get-select-setting",setting:[{name:"rate-and-review",id:"rate-review",type:"one"},{name:"label-names",id:"label-names",type:"one"},{name:"whatsapp-cloud",id:"cloud-active",type:"one"}]},e=>{t=e;B.admin_set("rate-and-review")})},admin_set:function(e=!1){return!!t&&(e?!(0===Object.keys(t).length||!t.hasOwnProperty(e))&&t[e]:t)},get_value:function(e){return e instanceof Array&&0<e.length?e[0]:e},shortcode:function(e){return S.shortcode(e)},event:function(e,t){x(document).trigger(e,t);let s=C?typeof SB_ADMIN_SETTINGS!==p&&SB_ADMIN_SETTINGS.webhooks:$.webhooks;var i={SBSMSSent:"sms-sent",SBLoginForm:"login",SBRegistrationForm:"registration",SBUserDeleted:"user-deleted",SBEmailSent:"email-sent",SBNewMessagesReceived:"new-message",SBNewConversationReceived:"new-conversation",SBActiveConversationStatusUpdated:"conversation-status-updated",SBMessageDeleted:"message-deleted",SBRichMessageSubmit:"rich-message",SBNewEmailAddress:"new-email-address"};s&&e in i&&(!0!==s&&!(s=Array.isArray(s)?s:s.replace(/ /g,"").split(",")).includes(i[e])||B.ajax({function:"webhooks",function_name:e,parameters:t}))},translate:function(e){var t;return!C&&B.null($)||C&&typeof SB_TRANSLATIONS===p||!((t=C?SB_TRANSLATIONS:$.translations)&&e in t)||""==t[e]?e:t[e]},escape:function(e){return e&&e.replaceAll("<script","&lt;script").replaceAll("</script","&lt;/script").replaceAll("javascript:","").replaceAll("onclick=","").replaceAll("onerror=","")},visibilityChange:function(e=""){"hidden"==e?(C||D.stopRealTime(),D.tab_active=!1):(L()&&!C&&D.startRealTime(),D.tab_active=!0,clearInterval(O),document.title=z)},settingsStringToArray:function(e){if(this.null(e))return[];var t=[];e=e.split(",");for(var s=0;s<e.length;s++){var i=e[s].split(":");t[i[0]]="false"!=i[1]&&("true"==i[1]||i[1])}return t},openWindow:function(e,t=550,s=350){var i=screen.width/2-t/2,a=screen.height/2-s/2;return window.open(e,"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+t+",height="+s+", top="+a+", left="+i),!1},convertUTCDateToLocalDate:function(e,t=0){return e=new Date(e),e=new Date(e.getTime()+36e5*t),new Date(e.getTime()+-1*J)},loadResource:function(e,t=!1){var s=document.getElementsByTagName("head")[0],i=document.createElement(t?"script":"link");t?i.src=e+"?v="+c:(i.id="steambox",i.rel="stylesheet",i.type="text/css",i.href=e+"?v="+c,i.media="all"),s.appendChild(i)},uploadResponse:function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1]){var s="The file you are trying to upload has an extension that is not allowed.";C?SBAdmin.dialog(s,"info"):alert(s)}else if(x(e).hasClass("sb-input-image"))x(e).find(".image").attr("data-value","").css("background-image",""),setTimeout(()=>{x(e).find(".image").attr("data-value",t[1]).css("background-image",`url("${t[1]}?v=${B.random()}")`).append('<i class="bi-x-lg"></i>'),e=!1},500);else{s=t[1].substr(t[1].lastIndexOf("/")+1);let e="";var i=/\.(jpg|jpeg|png|gif|bmp|)$/.test(t[1].toLowerCase()),a=/\.(mp3|ogg)$/.test(t[1].toLowerCase()),n=/\.(docx|pptx|xlsx|doc|ppt|xls)$/.test(t[1].toLowerCase());e=i?`<div data-name="${s}" data-value="${t[1]}" data-id="${t[2]}">
                                    <img style="border-radius: .4rem; width: 33px; vertical-align: middle;" src="${t[1]}" width="30" height="30">
                                     ${s}<i class="bi-x-lg"></i>
                                  </div>`:a?`<div style="display:flex;flex-direction:row;align-items: center;" data-name="${s}" data-value="${t[1]}" data-id="${t[2]}">
                                    <audio controls style="max-width: 100%; max-height: 33px; border-radius: var(--chat-rounded-size-6);">
                                      <source src="${t[1]}" type="audio/${t[1].split(".").pop()}">
                                      Your browser does not support the audio element.
                                    </audio>
                                    <i class="bi-x-lg"></i>
                                  </div>`:n?`<div data-name="${s}" data-value="${t[1]}" data-id="${t[2]}">
                                    <i class="bi bi-file-earmark-text-fill" style="font-size:1.89rem; color: var(--chat-text-primary)"></i>
                                     <i class="bi-x-lg"></i>
                                  </div>`:`<div data-name="${s}" data-value="${t[1]}" data-id="${t[2]}">
                                     ${s}<i class="bi-x-lg"></i>
                                  </div>`,d.find(".sb-attachments").append(e),D.activateBar()}else B.error(t[1],"sb-upload-files.change");this.busy=function(e){}},debounce:function(e,t,s=500){t in q||(q[t]=!0,e(),setTimeout(()=>{delete q[t]},s))}}),E={channels:{},channels_presence:[],active:!1,pusher:!1,started:!1,pusher_beams:!1,initialized:!1,online_ids:[],init_push_notifications:!1,sw:!1,init:function(e=!1){if(E.active){if(this.pusher)return!e||e();e&&(x(window).one("SBPusherInit",()=>{e()}),this.initialized=!0,x.getScript("https://js.pusher.com/7.0/pusher.min.js",()=>{this.pusher=new Pusher((C?SB_ADMIN_SETTINGS:$)["pusher-key"],{cluster:(C?SB_ADMIN_SETTINGS:$)["pusher-cluster"],authEndpoint:STMBX_URL+"/include/pusher.php",auth:{params:{login:B.loginCookie()}}}),B.event("SBPusherInit")}))}},initPushNotifications:function(){(L()||C)&&x.getScript("https://js.pusher.com/beams/1.0/push-notifications-cdn.js",()=>{window.navigator.serviceWorker.ready.then(e=>{this.pusher_beams=new PusherPushNotifications.Client({instanceId:(C?SB_ADMIN_SETTINGS:$)["push-notifications-id"],serviceWorkerRegistration:e}),this.pusher_beams.start().then(e=>e.getDeviceId()).then(e=>console.log("Successfully registered with Beams. Device ID:",e)).then(()=>this.pusher_beams.setDeviceInterests(C?[SB_ACTIVE_AGENT.id,"agents"]:[L().id,"users"])).catch(console.error),this.init_push_notifications=!1})})},initServiceWorker:function(){"serviceWorker"in navigator&&(navigator.serviceWorker.register(C||"undefined"!=typeof SB_CLOUD_SW?STMBX_URL+"/sw.js?v="+c:$["push-notifications-url"]+"?v="+c).then(e=>{e.update(),this.sw=e}).catch(function(e){console.warn(e)}),navigator.serviceWorker.onmessage=function(e){C?e.data.conversation_id?(SBAdmin.conversations.openConversation(e.data.conversation_id,e.data.user_id),SBAdmin.conversations.update()):e.data.user_id&&(SBAdmin.profile.show(e.data.user_id),D.audio.play()):"sb-open-chat"==e.data&&D.open()})},start:function(){C||this.started||!L()||(this.active&&this.init(()=>{this.event("client-typing",e=>{e.user_id==D.agent_id&&D.conversation&&e.conversation_id==D.conversation.id&&(D.typing(-1,"start"),clearTimeout(_),_=setTimeout(()=>{D.typing(-1,"stop")},1e3))}),this.event("new-message",e=>{!e||!L()||B.null(e.conversation_id)||L().getConversationByID(e.conversation_id)||D.conversation&&D.conversation.id==e.conversation_id?D.update():D.updateConversations()}),this.presence(1,()=>{this.started=!0,D.automations.run_all()})}),$["push-notifications"]&&(typeof Notification!=p&&"granted"==Notification.permission?this.initPushNotifications():this.init_push_notifications=!0))},subscribe:function(e,t=!1){if(!this.pusher)return this.init(()=>{this.subscribe(e,t)});e=this.cloudChannelRename(e);let s=this.pusher.subscribe(e);s.bind("pusher:subscription_error",e=>console.log(e)),s.bind("pusher:subscription_succeeded",()=>{this.channels[e]=s,t&&t()})},event:function(e,t,s="private-user-"+L().id){if(!this.pusher)return this.init(()=>{this.event(e,t,s)});let i=s;(s=this.cloudChannelRename(s))in this.channels?(this.channels[s].unbind(e),this.channels[s].bind(e,e=>{t(e)})):this.subscribe(i,()=>{this.event(e,t,i)})},trigger:function(e,t={},s="private-user-"+L().id){if(0==e.indexOf("client-"))return this.channels[this.cloudChannelRename(s)].trigger(e,t);B.ajax({function:"pusher-trigger",channel:s,event:e,data:t},e=>e)},presence:function(t=1,s){if(!this.pusher)return this.init(()=>{this.presence()});var e=this.pusher.subscribe(this.cloudChannelRename("presence-"+t));e.bind("pusher:subscription_succeeded",e=>{if(98<e.count)return this.subscribe(t+1);e.each(e=>{this.presenceCheck(e)&&this.online_ids.push(e.id)}),D.updateUsersActivity(),s&&s()}),e.bind("pusher:subscription_error",e=>console.log(e)),e.bind("pusher:member_added",e=>{this.presenceCheck(e)&&this.presenceAdd(e.id),C&&SBAdmin.users.onlineUserNotification(e)}),e.bind("pusher:member_removed",e=>{this.presenceRemove(e.id)}),this.channels_presence.push(e)},presenceCheck:function(e){var t=B.isAgent(e.info.user_type);return(C&&!t||!C&&t)&&!this.online_ids.includes(e.id)},presenceAdd:function(e){typeof e==p||this.online_ids.includes(e)||(this.online_ids.push(e),this.presenceUpdateAdmin(e),D.updateUsersActivity())},presenceRemove:function(e){var t;typeof e!=p&&(-1!==(t=this.online_ids.indexOf(e))?(this.online_ids.splice(t,1),this.presenceUpdateAdmin(e),D.updateUsersActivity()):C&&i.find(`.sb-conversation-busy[data-agent="${e}"]`).remove())},presenceUnsubscribe:function(){for(var e=0;e<this.channels_presence.length;e++)this.channels_presence[e].unsubscribe(this.cloudChannelRename("presence-"+(e+1)))},presenceUpdateAdmin:function(e){C&&(i.find(".sb-area-users.sb-active").length&&SBAdmin.users.update(),L())&&L().id==e&&SBAdmin.users.updateUsersActivity()},pushNotification:function(e){var t=C?SB_ACTIVE_AGENT.profile_image:L().image;B.ajax({function:"push-notification",title:C?SB_ACTIVE_AGENT.full_name:L().name,message:(new w).strip(e),icon:0<t.indexOf("user.svg")?$["notifications-icon"]:t,interests:D.getRecipientUserID(),conversation_id:0!=D.conversation&&D.conversation.id},e=>e)},cloudChannelRename:function(e){return $.cloud||C&&SB_ADMIN_SETTINGS.cloud?e+"-"+(C?SB_ADMIN_SETTINGS:$).cloud.cloud_user_id:e}};function y(e,t=p){return B.storage(e,t)}function j(e){return B.translate(e)}function L(e=-1){if(-1===e)return window.sb_current_user;window.sb_current_user=e}window.SBF=B,window.SBPusher=E,window.sb_current_user=!1,x.fn.sbActive=function(e=-1){return-1===e?x(this).hasClass("sb-active"):(x(this).setClass("sb-active",e),this)},x.fn.sbLoading=function(e="check"){return"check"==e?x(this).hasClass("sb-loading"):(x(this).setClass("sb-loading",e),this)},x.fn.sbTogglePopup=function(e=!1){let t=!0;return C&&(SBAdmin.open_popup=!1),x(this).sbActive()?(x(this).sbActive(!1),i.removeClass("sb-popup-active"),t=!1):(i.addClass("sb-popup-active"),i.find(".sb-popup").sbActive(!1),e&&(x(this).css("left","325.6px"),x(this).sbActive(!0)),C&&setTimeout(()=>{SBAdmin.open_popup=this},500),B.deselectAll()),t},x.fn.sbUploadFiles=function(e){for(var t=x(this).prop("files"),s=0;s<t.length;s++){var i=t[s],a=new FormData;a.append("file",i),B.upload(a,e)}x(this).value=""},x.fn.setProfile=function(e=!1,t=!1){return B.null(e)&&(e=L()?L().name:""),B.null(t)&&(t=L()?L().image:STMBX_URL+"/media/user.svg"),x(this).find("img").attr("src",t),x(this).find(".sb-name").html(e),this},x.fn.setClass=function(e,t=!0){return t?x(this).addClass(e):x(this).removeClass(e),this};class I{constructor(e={},t={}){this.details=e,this.extra=t,this.conversations=[],this.processArray(e)}get id(){return""==this.get("id")?this.get("user_id"):this.get("id")}get type(){return this.get("user_type")}get name(){return"first_name"in this.details?this.details.first_name+(this.details.last_name?" "+this.details.last_name:""):""}get nameBeautified(){return"last_name"in this.details&&"#"!=this.details.last_name.charAt(0)?this.name:$["visitor-default-name"]}get image(){return this.get("profile_image")}get language(){let e=this.getExtra("language");return(e=e||this.getExtra("browser_language"))?e.value.toLowerCase():""}get(e){return e in this.details&&!B.null(this.details[e])?this.details[e]:""}getExtra(e){return e in this.extra&&!B.null(this.extra[e])?this.extra[e]:""}set(e,t){this.details[e]=t}setExtra(e,t){this.extra[e]=t}processArray(e){if(e&&"details"in e){for(var t=0;t<e.details.length;t++)this.setExtra(e.details[t].slug,e.details[t]);delete e.details,this.details=e}}update(t){this.id?B.ajax({function:"get-user",user_id:this.id,extra:!0},e=>{this.processArray(e),t()}):B.error("Missing user ID","SBUser.update")}getConversations(a=!1,e){this.id?B.ajax({function:"get-user-conversations",user_id:this.id,exclude_id:e,agent:B.isAgent(this.type)},e=>{for(var t=[],s=0;s<e.length;s++){var i=e[s].conversation_status_code;3==i&&$["close-chat"]||(i=new v([new w(e[s])],{id:e[s].conversation_id,conversation_status_code:i,department:e[s].department,agent_id:e[s].agent_id,title:e[s].title}),t.push(i))}this.conversations=t,a&&a(t)}):B.error("Missing user ID","SBUser.getConversations")}getConversationsCode(e=!1){let t="";var s=D.conversation?D.conversation.id:-1;e=e||this.conversations;for(var i=0;i<e.length;i++)e[i]instanceof v?t+=`<li ${s==e[i].id?'class="sb-active" ':""}data-conversation-status="${e[i].get("conversation_status_code")}" data-conversation-id="${e[i].id}" data-department="${e[i].get("department")}">${e[i].getCode()}</li>`:B.error("Conversation not of type SBConversation","SBUser.getConversationsCode");return t}getFullConversation(e=!1,i=!1,t=30,s=30){!1!==e?B.ajax({function:"get-conversation",conversation_id:e,load_chat:t,limit:s},e=>{var t=[];if(e){if("agent-not-authorized"===e)return void(window.location.href=B.URL());for(var s=0;s<e.messages.length;s++)(N=e.total_rows)<=X&&setTimeout(()=>x(".sb-conversation").find(".load-more").hide(),300),e.messages[s].total_rows=e.total_rows,t.push(new w(e.messages[s]))}i&&i(new v(t,!!e&&e.details))}):B.error("Missing conversation ID","SBUser.getFullConversation")}getConversationByID(e,t=!1){for(var s=0;s<this.conversations.length;s++)if(this.conversations[s].id==e)return t?s:this.conversations[s];return!1}addConversation(t){if(t instanceof v){var s=t.id;let e=!0;for(var i=0;i<this.conversations.length;i++)if(this.conversations[i].id==s){this.conversations[i]=t,e=!1;break}return e&&this.conversations.unshift(t),e}B.error("Conversation not of type SBConversation","SBUser.addConversation")}removeConversation(e){e=this.getConversationByID(e,!0);!1!==e&&this.conversations.splice(e,1)}getLastConversation(){return!this.isConversationsEmpty()&&this.conversations[this.conversations.length-1]}isConversationsEmpty(){return 0==this.conversations.length}isExtraEmpty(){return 0===Object.keys(this.extra).length&&this.extra.constructor===Object}delete(e){this.id?B.ajax({function:"delete-user",user_id:this.id},()=>(B.event("SBUserDeleted",this.id),console.log("delte user"),e(),!0)):B.error("Missing user ID","SBUser.delete")}}window.SBUser=I;class w{constructor(e={}){this.details=e,this.linksData="","first_name"in this.details&&(this.details.full_name=this.details.first_name+" "+this.details.last_name),e.message_status_code&&(e.status_code=e.message_status_code),delete e.message_status_code,delete e.source,delete e.extra,delete e.title,delete e.tags,delete e.labels,delete e.agent_id,delete e.department;let t=this.get("payload");if(t)try{var s=JSON.parse(this.get("payload").replace("\\'","'"));t=s&&"object"==typeof s?s:{}}catch(e){t={}}else t={};this.set("payload",t)}get id(){return this.get("id")}get attachments(){return B.null(this.details.attachments)?[]:JSON.parse(this.details.attachments)}get message(){return this.get("message")}get(e){return e in this.details&&!B.null(this.details[e])?this.details[e]:""}set(e,t){this.details[e]=t}payload(e=!1,t=!1){var s=this.get("payload");if(!1!==e&&!1!==t)s[e]=t,this.set("payload",s);else if(!1!==e)return e in s?s.key:"id"in s&&s.id==e&&s;return s}getLoad(){return X}setLoad(e){X=e}getCode(e=!1){var t=B.isAgent(this.details.user_type),s=C?SBAdmin.conversations.messageMenu(t):"";let i=e?this.get("translation"):!this.message&&"preview"in this.payload?this.payload.preview:this.message;var a=this.attachments;let n="",o="";e=C&&SB_ADMIN_SETTINGS["show-profile-images"]||!C&&(t&&!$["hide-agents-thumb"]||!t&&$["display-users-thumb"])?`<div class="sb-thumb"><img loading="lazy" src="${this.details.profile_image}"><div class="sb-tooltip"><div>${this.details.full_name}</div></div></div>`:"";let r=(t?"sb-right":"")+(e?" sb-thumb-active":""),l="";if(!i&&!a.length)return"";var c=this.payload();c.latitude&&c.longitude&&(c.latitude,c.longitude);c=new RegExp("^([{,+0-9]+[@s.whatsapp.net])").test(i);if(t&&!c){var d=i.match(/\[.+?\]/g)||[];let t=!1;for(var u=d.length,h=0;h<u;h++){var g=S.shortcode(d[h]);let e=S.generate(g[1],g[0]);e&&("["!=i.charAt(0)&&(e=e.replace("sb-rich-message","sb-rich-message sb-margin-top")),"]"!=i.charAt(i.length-1)&&(e=e.replace("sb-rich-message","sb-rich-message sb-margin-bottom")),i=i.replace(d[h],"{{RM}}"),i=this.render(i).replace("{{RM}}",e),t=!0,l=`data-type="${g[0]}"`)}t&&(r+=" sb-rich-cnt",1<u)&&(l='data-type="multiple"'),u||(i=this.render(i))}else i=this.render(i);if(a.length){n='<div style="padding-top: 0px" class="sb-message-attachments">';for(h=0;h<a.length;h++){var p=a[h][1];/.jpg|.jpeg|.png|.webp|.gif/.test(p)||(a[h][1].endsWith(".pdf")&&555<window.innerWidth?o+=`<embed src="${p}" type="application/pdf" style="width:100%;height:500px;" />`:"oga"===a.toString().substr(a.length-4)||"mp3"===a.toString().substr(a.length-4)||"ogg"===a.toString().substr(a.length-4)||"amr"===a.toString().substr(a.length-4)?o+=`<audio controls style="max-width:100%;border-radius:8px;margin-bottom: 8px;background:#f1f3f4;"><source src="${p}" type="audio/mpeg"></audio></a>`:"mp4"===a.toString().substr(a.length-4)?o+=`<video width="auto" controls style="object-fit: cover;width:100%;border-radius:var(--chat-rounded-size-8);"><source src="${p}"  type="video/mp4"></video></a>`:o+=p?`<a rel="noopener" style="padding-right: var(--chat-spacing-size-1-4);text-decoration:none;padding-left: var(--chat-spacing-size-5);" target="_blank" class="sb-message" href="${p}"><i class="bi-file-text"></i> ${a[h][0]}</a>`:" ")}n+="</div>"}var m,v;return i.includes("〚")?(t=L().name,c=L().getExtra("phone").value,v=Number(c),m="",i=(i=(i=(i=(i=(i=(i=(0<v||(c=x(document).find("body > div > main > div.sb-active.sb-area-conversations > div > div.sb-user-details.sb-top > div.sb-scroll-area > div.sb-profile-list.sb-profile-list-conversation > ul > li:nth-child(8) > label").innerText),i.includes(c)?i.replace(c,t):(v=i.indexOf("}"),m="alt","<bold id='sb-reply-top-name-alt'> ~Tú  </bold>"+(i=i.substring(v+1))))).replace("〚","alt"==m?"<div id='sb-reply-to-alt'>":"<div id='sb-reply-to' >")).replace("〛",`</div><p class="copyTextOnClick" style='padding: 0px 4px;margin:0px;cursor:pointer;'>`)).replace(/\|(?=\n)/,"</div>")).replace(/<p\s*\/?>\s*<p\s*\/?>/g,"")).replace("{","<b id='sb-reply-top-name'> ~")).replace("@s.whatsapp.net}","</b>"),`<div data-id="${this.details.id}" ${l} class="sb-shadow-conversation ${r}">${e}
                          <div class="sb-cnt" style="min-width:80px;max-width:100%;padding:4px 4px;">
                          <div class="sb-message" data-value="${this.linksData?encodeURI(this.linksData.message):encodeURI(i)}">
            ${o}
            <div style="max-width:30rem;margin:0px;text-align:start;margin:0px;cursor:pointer;" class="readThis copyTextOnClick">
                                  ${this.linksData?this.linksData.message:i.replace(/\|/g," ")}
                                  </div>
                              </div>
                             ${n}
                              <div class="menu-bubble">
                                  <div class="events"></div><div class="sb-time">
                                  ${B.beautifyTime(this.details.creation_time,!0)}
                                  </div></div>
                          </div>${s}</div>`):`<div data-id="${this.details.id}" ${l}  class="sb-shadow-conversation ${r}"  style="transition: 0.3s all">${e}
        <div class="server-response"> <i class="bi-check2-all"></i></div>
				  <div class="sb-cnt" style="width:fit-content;margin:6px;">
                 
				  <div class="sb-message" data-value="${this.linksData?encodeURIComponent(this.linksData.message):encodeURIComponent(i)}">
				  ${o}
				 
				  <div style="padding-right: var(--chat-spacing-size-1-4);text-decoration:none;padding-left: var(--chat-spacing-size-5);" class="copyTextOnClick">
					${this.linksData?this.linksData.message:i.replace(/\|/g," ")}
				  </div>
				</div>
				${n}<div class="menu-bubble"><div class="sb-time">${B.beautifyTime(this.details.creation_time,!0)}</div></div>
				  </div>
				  ${s}
				</div>
				<script>
        function copyTextToClipboard(t){navigator.clipboard.writeText(t).then((()=>{})).catch((t=>{}))}function attachCopyEventListeners(){document.querySelectorAll(".copyTextOnClick").forEach((t=>{t.addEventListener("click",(()=>{copyTextToClipboard(""+t.innerText.trim().replace(/_s+_/g,"")+"\\n")}))}))}attachCopyEventListeners();
				</script>
			  `}render(e=!1){for(var t=(e=!1===e?""+this.details.message:e).length,s=(e=e.replace(/(?:\r\n|\r|\n)/g,"<br>")).match(/```([\s\S]+?)```/g)||[],i=0;i<s.length;i++)e=e.replace(s[i],`{{code_placeholder_${i}}}`);for(var a=e.match(/`([^`]+)`/g)||[],i=0;i<a.length;i++)e=e.replace(a[i],`{{inline_code_placeholder_${i}}}`);e=(e=(e=e.replace(/(?<!\*)\*(.*?)\*(?!\*)/g,"<strong>$1</strong>")).replace(/(^|\s)\_([^\_]+)\_/g,"$1<em>$2</em>")).replace(/(^|\s)\~([^\s\~]+)\~(?=\s|$)/g,"$1<del>$2</del>");for(var n=["cede","ubbed","udada","ucced"],i=0;i<n.length;i++)e=e.replaceAll(n[i],"SBR"+i);e=e.replace(/u([0-9a-f]{4,5})/im,"&#x$1;");for(i=0;i<n.length;i++)e=e.replaceAll("SBR"+i,n[i]);(e=(6==t||5==t)&&e.startsWith("&#x")||t<3&&e.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/)?`<span class="emoji-large">${e}</span>`:e).includes("http")&&(e=e.autoLink({target:"_blank"}));for(i=0;i<a.length;i++)e=e.replace(`{{inline_code_placeholder_${i}}}`,`<pre>${a[i].substring(1,a[i].length-1)}</pre>`);for(i=0;i<s.length;i++)e=e.replace(`{{code_placeholder_${i}}}`,`<code>${s[i].substring(3,s[i].length-3)}</code>`);return e.replace(/&amp;lt;/g,"&lt;")}strip(e=!1){return e=(e=!1===e?""+this.details.message:e).replace(/https:\/\/maps\.google\.com\/.*\b/g,e=>`<i class="bi-send" style="vertical-align:middle;padding-left:10px;"></i> <span style="color: #2196F3;">${j("Location")}</span>`)}}window.SBMessage=w;class v{constructor(e,t){this.details=B.null(t)?{}:t,Array.isArray(e)?(this.messages=[],e.length&&(e[0]instanceof w?this.messages=e:B.error("Messages not of type SBMessage","SBConversation.constructor"))):B.error("Message array not of type Array","SBConversation.constructor")}get id(){return""==this.get("id")?this.get("conversation_id"):this.get("id")}get(e){if(e in this.details&&!B.null(this.details[e]))return this.details[e];if("title"==e){if(!B.null(this.details.first_name))return this.details.first_name+" "+this.details.last_name;if(this.messages.length)return this.messages[0].get("full_name")}return""}set(e,t){this.details[e]=t}getMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages[t].set("index",t),this.messages[t];return!1}getLastMessage(){for(var e=this.messages.length-1;-1<e;e--)if(this.messages[e].message||this.messages[e].attachments.length)return this.messages[e];return!1}getLastUserMessage(e=!1,t=!1){for(var s=e=!1===e?this.messages.length-1:e;-1<s;s--){var i=this.messages[s],a=i.get("user_type");if((i.message||i.attachments.length)&&(!t&&!B.isAgent(a)||!0===t&&("agent"==a||"admin"==a)||"bot"==t&&"bot"==a||"no-bot"==t&&"bot"!=a||"all"==t&&B.isAgent(a)))return this.messages[s].set("index",s-1),this.messages[s]}return!1}getUserMessages(e="user"){for(var t=[],s="user"==e?["visitor","lead","user"]:"agents"==e?["agent","admin"]:["bot"],i=0;i<this.messages.length;i++)s.includes(this.messages[i].get("user_type"))&&t.push(this.messages[i]);return t}updateMessage(e,t){if(t instanceof w){for(var s=0;s<this.messages.length;s++)if(this.messages[s].id==e)return this.messages[s]=t,!0}else B.error("Message not of type SBMessage","SBConversation.updateMessage");return!1}addMessages(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]instanceof w&&this.messages.push(e[t]);else e instanceof w?this.messages.push(e):B.error("Messages not of type SBMessage","SBConversation.addMessages()");return this}getCode(){var s=this.messages.length;if(s){var i,a,s=this.messages[s-1];let e=s.message,t=(!1!==e.indexOf("[")&&(a=e.match(/\[.+?\]/g)||[]).length&&(i=S.shortcode(a[0]),e=e.replace(a[0],j(B.null(i[1].message)?B.null(i[1].title)?"":i[1].title:i[1].message))),B.getReply(e)&&(a=e.indexOf("}"),e=e.substring(a+1)),this.get("title"));return(!t||b&&$["tickets-conversations-title-user"])&&(t=B.isAgent(s.get("user_type"))?s.get("full_name"):j("You")),`<div class="sb-conversation-item" data-user-id="${s.get("user_id")}"><img loading="lazy" src="${s.get("profile_image")}"><div><span class="sb-name">${t}</span><span class="sb-time">${B.beautifyTime(s.get("creation_time"))}</span></div><div class="sb-message">${114<e.length?e.substr(0,114)+" ...":e}</div></div>`}return""}deleteMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages.splice(t,1),!0;return!1}searchMessages(e,t=!1){for(var s=[],i=0;i<this.messages.length;i++){var a=this.messages[i].message;(t&&a==e||!t&&a.includes(e))&&s.push[messages[i]]}return s}getAttachments(){for(var e=[],t=0;t<this.messages.length;t++)for(var s=this.messages[t].attachments,i=0;i<s.length;i++){var a=s[i][1];e.push([s[i][0],a,a.substr(a.lastIndexOf(".")+1),this.messages[t].id])}return e}}window.SBConversation=v;var D={rich_messages_list:["chips","buttons","select","inputs","table","list"],emoji_options:{range:0,range_limit:47,list:[],list_now:[],touch:!1},initialized:!1,editor_listening:!1,conversation:!1,load_message:[],is_busy:!1,is_busy_update:!1,is_busy_populate:!1,chat_open:!1,real_time:!1,agent_id:-1,agent_online:!1,user_online:!1,expanded:!1,main_header:!0,start_header:!1,desktop_notifications:!1,flash_notifications:!1,id_last_message:0,id_last_message_conversation:0,datetime_last_message_conversation:"2000-01-01 00:00:00",audio:!1,audio_out:!1,tab_active:!0,notifications:[],typing_settings:{typing:!1,sent:!1,timeout:!1},email_sent:!1,dashboard:!1,articles:!1,articles_categories:!1,skip:!1,queue_interval:!1,departments:!1,default_department:null,default_agent:null,default_tags:null,offline_message_set:!1,setActiveAgent:function(e){var t=x(".sb-admin").find(".sb-area-conversations").find("#conversation-agent"),s=t.find(`[data-id="${e}"]`);D.conversation.set("agent_id",e),t.find(" > p").attr("data-value",s.data("value")).html(s.html()).next().sbActive(!1),"agent"!=SB_ACTIVE_AGENT.user_type||SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&!e||(conversations_admin_list_ul.find(`[data-conversation-id="${D.conversation.id}"]`).remove(),SBConversations.clickFirst()),e&&D.showResponse("Agent assigned. The agent has been notified.")},assignAgent:function(e,t,s=!1){B.ajax({function:"update-conversation-agent",conversation_id:e,agent_id:t,message:D.conversation.getLastMessage().message},e=>{s&&s(e)})},assignAgent:function(e,t,s=!1){B.ajax({function:"update-conversation-agent",conversation_id:e,agent_id:t,message:D.conversation.getLastMessage().message},e=>{s&&s(e)})},showResponse:function(e,t=!1){var s=x(".sb-admin"),i=(s.find(".sb-area-conversations"),s.find(".sb-info-card"));t?"error"==t?i.addClass("sb-info-card-error"):i.addClass("sb-info-card-info"):(i.removeClass("sb-info-card-error sb-info-card-warning sb-info-card-info"),clearTimeout(_),_=setTimeout(()=>{i.sbActive(!1)},5e3)),i.html(`<h3>${j(e)}</h3>`).sbActive(!0)},sendMessage:function(i=-1,a="",n=[],o=!1,r=!1,l=!1){var e=T&&R.dialogflow.active();let t=!1;if(null!=D.conversation.id&&L().getFullConversation(D.conversation.id,e=>{e.details.agent_id!=SB_ACTIVE_AGENT.id&&D.assignAgent(D.conversation.id,SB_ACTIVE_AGENT.id,()=>{D.setActiveAgent(SB_ACTIVE_AGENT.id)})}),L()||C){if(!this.conversation){var c=!C&&L().getLastConversation();if(!c||"new-conversation"==g||D.default_department&&D.default_department!=c.get("department")||D.default_agent&&D.default_agent!=c.get("agent_id"))return void this.newConversation(l,i,"",[],C&&SB_ACTIVE_AGENT.department?SB_ACTIVE_AGENT.department:null,null,()=>this.sendMessage(i,a,n,o,r));this.openConversation(c.id),this.setConversation(c),g=!1}this.calculateLabelDateFirst();let s=(i=-1==i?(C?SB_ACTIVE_AGENT:L()).id:i)!=A;if(a||n.length||(a=u.val().trim(),d.find(".sb-attachments > div").each(function(){n.push([x(this).attr("data-name"),x(this).attr("data-value"),x(this).attr("data-id")])}),C&&SBAdmin.must_translate&&(R.dialogflow.translate([a],L().language,e=>{e.length&&(r?r["original-message"]=a:r={"original-message":a},e[0].translatedText)&&(a=e[0].translatedText),this.sendMessage(i,a,n,o,r,l)}),t=!0)),this.busy(!0),s&&(u.val("").css("height",""),d.find(".sb-attachments").html("")),this.activateBar(!1),!t)if(!1===l&&i==A&&(l="skip"),C||!s||e||(l=2),a||n.length||r){let t={user_id:i,user:L(),conversation_id:this.conversation.id,conversation:this.conversation,conversation_status_code:l,message:a,attachments:n};B.ajax({function:"send-message",user_id:i,conversation_id:this.conversation.id,message:a,attachments:n,conversation_status_code:l,queue:!C&&$.queue&&s,payload:r,recipient_id:!!C&&L().id},e=>{C||i!=A||(this.dashboard?this.updateConversations():this.chat_open||this.updateNotifications("add",this.conversation.id)),(C&&!this.user_online||!C&&!this.agent_online)&&this.update(),C||!s||T||(this.followUp(),this.offlineMessage()),!C&&s&&(!r||"sb-human-takeover"!=r.id&&B.null(r["skip-dialogflow"]))&&R.dialogflow.message(a,n),s&&$["language-detection"]&&this.conversation&&1<a.split(" ").length&&!B.storage("language-detection-completed")&&(B.ajax({function:"google-language-detection-update-user",user_id:i,string:a,token:R.dialogflow.token}),B.storage("language-detection-completed",!0)),!this.articles||C||!$.articles||$["office-hours"]||this.isInitDashboard()||setTimeout(()=>{this.conversation&&(this.sendMessage(A,"[articles]"),this.scrollBottom(),this.articles=!1)},5e3),e.queue&&this.queue(this.conversation.id),t.message_id=e.id,B.event("SBMessageSent",t),b&&SBTickets.onMessageSent(),o&&o(t),e.notifications.length&&B.event("SBNotificationsSent",e.notifications),this.skip&&(this.skip=!1),this.busy(!1)}),s&&(a=B.escape(a),f.append(new w({id:"sending",profile_image:C?SB_ACTIVE_AGENT.profile_image:L().image,full_name:L().name,creation_time:"0000-00-00 00:00:00",message:a,user_type:C?"agent":"user"}).getCode().replace('<div class="sb-time"></div>',`<div class="sb-time">${j("Sending")}<i></i></div>`)),this.dashboard||this.scrollBottom()),(this.audio&&!C&&this.chat_open&&s&&["a","aa"].includes($["chat-sound"])||C&&"a"==SB_ADMIN_SETTINGS.sounds)&&this.audio_out.play()}else this.busy(!1)}else this.addUserAndLogin(()=>this.sendMessage(i,a,n,o,r),!0)},sendBotMessage:function(e="",t=[]){return R.dialogflow.message(e,t)},updateMessage:function(e,t=""){B.ajax({function:"update-message",message_id:e,message:t})},sendEmail:function(e,t,s=!1){let i=s?L().id:this.getRecipientUserID();if(!C&&!isNaN(i)&&this.agent_online)return!1;B.ajax({function:"create-email",recipient_id:i,sender_name:C?s?SB_ACTIVE_AGENT.full_name:L().name:s?$["bot-name"]:L().name,sender_profile_image:C?s?SB_ACTIVE_AGENT.profile_image:L().name:s?$["bot-image"]:L().image,message:e,attachments:t,department:!!this.conversation&&this.conversation.get("department"),conversation_id:!!this.conversation&&this.conversation.id},()=>{B.event("SBEmailSent",{recipient_id:i,message:e,attachments:t})})},sendSMS:function(t){var e=this.getRecipientUserID();if(!C&&!isNaN(e)&&this.agent_online)return!1;B.ajax({function:"send-sms",to:e,message:t,conversation_id:!!this.conversation&&this.conversation.id},e=>{"sent"==e.status||"queued"==e.status?B.event("SBSMSSent",{recipient_id:this.getRecipientUserID(),message:t,response:e}):e.message&&B.error(e.message,"SBChat.sendSMS")})},desktopNotification:function(t,s,i,a=!1,n=!1){if("granted"!==Notification.permission)Notification.requestPermission();else{let e=s.replace(/\*(.*?)\*/g,"‎*$1*‎").replace(/_(.*?)_/g,"‎_$1_‎").replace(/~(.*?)~/g,"‎~$1~‎").replace(/```(.*?)```/g,"‎```\n$1\n```‎").replace(/`(.*?)`/g,"‎`$1`‎").replace(/^([{,+,0-9,}]+[@s.whatsapp.net])/g,"‎$1");e=e||"📄",E.sw.showNotification(t,{body:(new w).strip(e),icon:0<i.indexOf("user.svg")?$["notifications-icon"]:i}).onclick=()=>{C?a?(SBAdmin.conversations.openConversation(a,0==n?L().id:n),SBAdmin.conversations.update()):n&&SBAdmin.profile.show(n):this.start(),window.focus()}}},updateNote:function(e,t,s,i=!1){B.ajax({function:"update-note",conversation_id:e,note_id:t,status:s},e=>{this.busy=!1,i&&i(e)})},getRecipientUserID:function(){return C?L().id:this.lastAgent(!1)?this.lastAgent(!1).user_id:B.null(this.conversation.get("agent_id"))?B.null(this.conversation.get("department"))?"agents":"department-"+this.conversation.get("department"):this.conversation.get("agent_id")},submit:function(){this.is_busy||(this.sendMessage(),$["cron-email-piping-active"]&&(setInterval(function(){B.ajax({function:"email-piping"})},6e4),$["cron-email-piping-active"]=!1),E.init_push_notifications&&E.initPushNotifications())},initChat:function(){C||B.getActiveUser(!0,()=>{var e=!1!==L(),t=e&&L().type;b||!$.popup.active||y("popup")||h&&$["popup-mobile-hidden"]||this.popup(),D.automations.run_all(),b||!$.privacy||$["registration-required"]||y("privacy-approved")?(typeof Notification!==p&&!$["push-notifications-users"]&&("all"==$["desktop-notifications"]||"users"==$["desktop-notifications"]||C&&"agents"==$["desktop-notifications"])&&(this.desktop_notifications=!0),("all"==$["flash-notifications"]||"users"==$["flash-notifications"]||C&&"agents"==$["flash-notifications"])&&(this.flash_notifications=!0),this.registration(!0)&&!b?(this.registration(),!e&&$["visitors-registration"]&&this.addUserAndLogin()):(e||!($["visitors-registration"]||$.subscribe||b)||b&&$["tickets-registration-required"]?!this.conversation&&e?this.populateConversations():this.finalizeInit():this.addUserAndLogin(()=>{this.welcome(),this.finalizeInit()}),$["header-name"]&&e&&"user"==t&&!b&&a.find(".sb-title").html(`${j("Hello")} ${L().nameBeautified}!`),this.welcome(),E.active||setInterval(()=>{this.updateConversations(),this.updateUsersActivity()},10200),this.scrollBottom(!0))):this.privacy()})},finalizeInit:function(){this.initialized||(k.attr("style",""),C||b||(this.isInitDashboard()&&this.showDashboard(),!h&&window.innerHeight<760&&k.find(" > .sb-body").css("max-height",window.innerHeight-130+"px")),this.initialized=!0,C||(L()&&!this.registration(!0)&&(y("open-conversation")&&this.openConversation(y("open-conversation")),B.getURL("conversation"))&&this.openConversation(B.getURL("conversation")),(!this.chat_open&&(!h&&y("chat-open")||"open"==B.getURL("chat"))||B.getURL("conversation"))&&setTimeout(()=>{this.start()},500),$["timetable-type"]&&D.offlineMessage(),$["queue-human-takeover"]&&R.dialogflow.humanTakeoverActive()&&($.queue=!0)),b&&SBTickets.init(),B.event("SBInit"))},start:function(){this.initialized&&(this.populate(),this.headerAgent(),this.updateUsersActivity(),this.startRealTime(),this.chat_open=!0,this.popup(!0),this.conversation&&this.updateNotifications("remove",this.conversation.id),k.sbActive(!0),x("body").addClass("sb-chat-open"),"open"==$["welcome-trigger"]&&this.welcome(),this.calculateLabelDates())},open:function(e=!0){e&&!this.chat_open?(this.start(),this.chat_open=!0,this.startRealTime(),k.sbActive(!0),x("body").addClass("sb-chat-open"),y("chat-open",!0),h&&history.pushState({"chat-open":!0},"",""),B.event("SBChatOpen")):!e&&this.chat_open&&(k.sbActive(!1),this.stopRealTime(),y("chat-open",this.chat_open=!1),x("body").removeClass("sb-chat-open"),B.event("SBChatClose"))},openConversation:function(t){L().getFullConversation(t,e=>{if(!e.id)return y("open-conversation",""),!1;this.setConversation(e),this.hideDashboard(),this.populate(),this.main_header=!1,y("queue")==t&&this.queue(t),(this.chat_open||b)&&this.updateNotifications("remove",t),b&&SBTickets.activateConversation(e),y("open-conversation",t),B.event("SBConversationOpen",e)})},loadUpdate:function(e){var t=e.length;let s="";var i=[];let a=!1;this.calculateLabelDateFirst();for(var n,o,r=0;r<t;r++)i.includes(e[r].details.id)||((n=new w(e[r].details)).payload(),(o=B.beautifyTime(n.get("creation_time")))!=a&&(s+=`<div class="sb-label-date">${o}</div>`,a=o),s+=n.getCode(),i.push(n.id));x(".sb-list .sb-label-date:nth-child(2)").after(s),x(".sb-list .sb-label-date:nth-child(2)").remove(),this.dashboard||this.calculateLabelDates()},update:function(){if(this.conversation){if(!this.is_busy_update){let e=this.conversation.getLastMessage(),v=!1;B.ajax({function:"get-new-messages",conversation_id:this.conversation.id,datetime:this.datetime_last_message_conversation,last_id:this.id_last_message_conversation},s=>{var i=s.length;if(this.is_busy_update=!1,this.conversation&&Array.isArray(s)&&0<i&&(!e||e.id!=s[i-1].id||e.message!=s[i-1].message||e.payload!=s[i-1].payload||e.attachments!=s[i-1].attachments)){let e="";var a=[],n=[];let t=!1;this.calculateLabelDateFirst();for(var o=0;o<i;o++)if(!n.includes(s[o].id)){var r=new w(s[o]),l=r.payload();if(this.id_last_message_conversation=r.id,this.datetime_last_message_conversation=r.get("creation_time"),!["boolean","string"].includes(typeof l)){if("event"in l){var c=l.event;if(("delete-message"==c&&!1!==this.conversation.getMessage(r.id)||!C&&""==r.message&&!r.attachments.length)&&this.deleteMessage(r.id),R.dialogflow.active()||"conversation-status-update-3"!=c&&"conversation-status-update-4"!=c&&"activate-bot"!=c||(R.dialogflow.active("activate"),t=!0),$["close-chat"]&&"conversation-status-update-3"==c)return void this.closeChat(!1)}"human-takeover"in l&&$["queue-human-takeover"]&&($.queue=!0,D.queue(D.conversation.id))}if(this.conversation.getMessage(s[o].id))this.conversation.updateMessage(r.id,r),f.find(`[data-id="${r.id}"]`).replaceWith(r.getCode()),v=!0;else{this.conversation.addMessages(r);c=D.conversation.getLastUserMessage(!1,!0);if(c&&r.details.user_id!=c?.get("user_id")&&"[rating]"==c?.get("message")){l=1==r.details.message?"positive":"negative";const m=B.get_value(B.admin_set("rate-and-review")["rate-reply"]);var l={conversation_id:D.conversation.id,agent_id:c?c.get("user_id"):A,user_id:L().id,source:this.conversation.get("source"),message:r.details.message,rating:"positive"==l?1:-1},d={"rich-messages":{}},u=B.random()+r.details.id,u=(d["rich-messages"][u]={type:"rating",result:l},{function:"set-rating",payload:d,settings:l,message_id:c.id,message:m});1!=r.details.message&&2!=r.details.message||B.ajax(u,e=>{"tk"!=this.conversation.get("source")&&D.sendMessage(SB_ACTIVE_AGENT.id,m)})}e+=r.getCode()}a.push(r),n.push(r.id)}f.append(e);var h=this.conversation.getLastMessage(),g=h.get("user_type"),p=B.isAgent(g);!C&&p&&"bot"!=g&&(this.chat_open&&(-1==h.message.indexOf("sb-rich-success")&&this.setConversationStatus(0),$.follow.active)&&clearTimeout(_),t||R.dialogflow.active(!1)),y("queue")==this.conversation.id&&p&&"bot"!=g&&this.queue("clear"),f.find('[data-id="sending"]').remove(),this.headerAgent(),this.dashboard||v||(this.scrollBottom(),setTimeout(()=>{this.scrollBottom()},300)),!this.dashboard&&this.chat_open||this.updateNotifications("add",this.conversation.id),this.typing(-1,"stop"),this.busy(!1),!this.audio||1==i&&B.null(a[0].message)&&B.null(a[0].attachments)||!(!C&&this.chat_open&&(p||"bot"==g)&&["aa","ia"].includes($["chat-sound"])||C&&!B.isAgent(g)&&["a","i","ic"].includes(SB_ADMIN_SETTINGS.sounds))||this.audio.play(),B.event("SBNewMessagesReceived",a),b&&SBTickets.onNewMessageReceived(a[0])}}),this.is_busy_update=!0,setTimeout(()=>{this.is_busy_update=!1},5e3)}}else this.updateConversations()},updateConversations:function(){L()&&B.ajax({function:"get-new-user-conversations",datetime:this.id_last_message},e=>{if(e.length){this.id_last_message=e[0].id;for(var t=0;t<e.length;t++){var s=e[t].conversation_id,i=new w(e[t]),a=e[t].conversation_status_code,a=new v([i],{id:s,conversation_status_code:a,department:e[t].department,title:e[t].title}),n=L().addConversation(a),o=(e[t].user_id==L().id||this.conversation.id==s&&this.chat_open||(this.updateNotifications("add",s),$["auto-open"]&&this.start()),i.payload());if("boolean"!=typeof o&&"event"in o)if("open-chat"==o.event&&(h?this.open(!1):(this.conversation.id==s&&!this.dashboard||this.openConversation(s),setTimeout(()=>{this.open()},500))),""==i.message&&!i.attachments.length)continue;this.tab_active||(this.desktop_notifications&&D.desktopNotification(i.get("full_name"),i.message,i.get("profile_image")),this.flash_notifications&&this.flashNotification(),!this.audio)||!["a","aa","i"].includes($["chat-sound"])||this.chat_open&&this.tab_active&&!this.dashboard||B.null(i.message)&&B.null(i.attachments)||this.audio.play(),n&&(B.event("SBNewConversationReceived",a),b)&&SBTickets.onNewConversationReceived(a)}k.find(".sb-user-conversations").html(L().getConversationsCode()),k.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",3<k.find(".sb-user-conversations > li").length)}})},populate:function(){if(this.conversation){let e="";var s=f.find(" > .sb-notify-message");let t=!1;for(var i=0;i<this.conversation.messages.length;i++){var a=this.conversation.messages[i],n=B.beautifyTime(a.get("creation_time"));n!=t&&(e+=`<div class="sb-label-date">${n}</div>`,t=n),e+=a.getCode()}f.html((s.length?s[0].outerHTML:"")+e),this.dashboard||(this.scrollBottom(),this.calculateLabelDates())}else L()&&!L().isConversationsEmpty()&&($["disable-dashboard"]?this.openConversation(L().conversations[0].id):this.showDashboard())},populateConversations:function(a=!1){!this.is_busy_populate&&L()&&(this.is_busy_populate=!0,setTimeout(()=>{this.is_busy_populate=!1},5e3),L().getConversations(e=>{var t=e.length;if(t){var s=Date.now();this.id_last_message=e[0].messages[0].id;for(var i=0;i<t;i++)1!=e[i].get("conversation_status_code")||this.conversation&&this.conversation.id==e[i].id||this.updateNotifications("add",e[i].id),s-B.UTC(e[i].messages[0].get("creation_time"))<6e3&&this.open();k.removeClass("sb-no-conversations"),k.find(".sb-user-conversations").html(L().getConversationsCode()),k.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",3<k.find(".sb-user-conversations > li").length)}this.initialized&&"open-conversation"!=g||1!=t||this.isInitDashboard()||y("open-conversation")||(this.openConversation(L().conversations[0].id),"open-conversation"==g&&(g="")),a&&a(e),this.finalizeInit()}))},newConversation:function(t,s=-1,i="",a=[],n=null,o=null,r=!1,e=selectedSource){L()&&B.ajax({function:"new-conversation",status_code:t,title:b?k.find(".sb-ticket-title input").val():null,department:B.null(n)?this.default_department:n,agent_id:B.null(o)?this.default_agent:o,tags:this.default_tags,source:e},e=>{B.errorValidation(e,"user-not-found")?this.addUserAndLogin(()=>{this.newConversation(t,s,i,a,n,o,r)}):(e=new v([],e.details),this.setConversation(e),this.sendMessage(s,i,a),L().conversations.push(e),r&&r(e))})},setConversation:function(e){e instanceof v?(this.conversation=e,this.id_last_message_conversation=this.conversation.getLastMessage()?this.conversation.getLastMessage().id:0,this.datetime_last_message_conversation=0==this.conversation.getLastMessage()?"2000-01-01 00:00:00":this.conversation.getLastMessage().get("creation_time"),e.id!=this.conversation.id&&this.queue(e.id),y("open-conversation",e.id),B.event("SBActiveConversationChanged",e)):B.error("Value not of type SBConversation","SBChat.setConversation")},getDepartmentCode(t,s){if(this.departments)if("all"==t){let t="";for(var e in this.departments)this.getDepartmentCode(this.departments[e].id,e=>{t+=e});s(t)}else s(`<div data-color="${this.departments[t].color}">${""==this.departments[t].image?"<span></span>":`<img loading="lazy" src="${this.departments[t].image}" />`}<div>${this.departments[t].name}<div></div>`);else B.ajax({function:"get-departments"},e=>{e&&(this.departments=e,this.getDepartmentCode(t,s))})},startRealTime:function(){E.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update(),this.typing(C?L()?L().id:-1:this.agent_id,"check")},1e3))},stopRealTime:function(){clearInterval(this.real_time)},updateUsersActivity:function(){L()&&B.updateUsersActivity(L().id,this.agent_id,e=>{this.typing_settings.typing||("online"==e||this.agent_id==A?(x(n).addClass("sb-status-online").html(j("Online")),this.agent_online=this.agent_id!=A):(x(n).removeClass("sb-status-online").html(j("Away")),this.agent_online=!1))})},busy:function(e){d.find(".sb-loader").sbActive(e),this.is_busy=e,B.event("SBBusy",e)},headerAgent:function(){var e;C||b||this.dashboard||!this.conversation||!(-1==this.agent_id||this.conversation.getLastMessage()&&B.isAgent(this.conversation.getLastMessage().get("user_type"))&&this.conversation.getLastMessage().get("user_id")!=this.agent_id)||(e=this.lastAgent())&&(this.agent_id=e.user_id,this.headerReset(),a.addClass("sb-header-agent").attr("data-agent-id",this.agent_id).html(`<div class="sb-dashboard-btn bi-arrow-right-left"></div><div class="sb-profile"><img loading="lazy" src="${e.profile_image}" /><div><span class="sb-name">${e.full_name}</span><span class="sb-status">${j("Away")}</span></div><i class="sb-icon bi-x-lg ${!h&&$["close-chat"]?"sb-close-chat":"sb-responsive-close-btn"}"></i></div><div class="sb-label-date-top"></div>`),n=a.find(".sb-status"),this.updateUsersActivity(),l=a.find(".sb-label-date-top"),B.storageTime("header-animation",1))&&this.headerAnimation()},headerReset:function(){0==this.start_header&&(this.start_header=[a.html(),a.attr("class")]),a.removeClass("sb-header-main sb-header-brand sb-header-agent sb-header-minimal"),this.main_header=!1},headerAnimation:function(){a.addClass("sb-header-animation"),setTimeout(()=>{a.removeClass("sb-header-animation")},8e3),B.storageTime("header-animation")},lastAgent:function(e=!0){let t=!1;return t=this.conversation&&(e=this.conversation.getLastUserMessage(!1,!e||"all"))?{user_id:e.get("user_id"),full_name:e.get("full_name"),profile_image:e.get("profile_image")}:t},scrollBottom:function(e=!1){G=!1,setTimeout(()=>{G=!0},1e3),setTimeout(()=>{r.scrollTop(e?0:r[0].scrollHeight),this.scrollHeader()},300)},isBottom:function(){return r[0].scrollTop===r[0].scrollHeight-r[0].offsetHeight},scrollHeader:function(){var e;this.main_header&&this.dashboard&&-1<(e=r.scrollTop())&&e<1e3&&a.find(".sb-content").css({opacity:1-e/500,top:e/10*-1+"px"})},showDashboard:function(){C||b||(k.addClass("sb-dashboard-active"),a.removeClass("sb-header-agent"),this.hidePanel(),this.start_header&&a.html(this.start_header[0]).addClass(this.start_header[1]),r.find(" > div").sbActive(!1),k.find(".sb-dashboard").sbActive(!0),this.populateConversations(),this.conversation=!1,this.agent_id=-1,this.stopRealTime(),this.dashboard=!0,this.main_header=!0,this.scrollBottom(!0),B.event("SBDashboard"))},hideDashboard:function(){C||b||(f.sbActive(!0),k.removeClass("sb-dashboard-active").find(".sb-dashboard").sbActive(!1),this.dashboard=!1,this.headerAgent(),this.scrollHeader(0),this.chat_open&&this.startRealTime(),B.event("SBDashboardClosed"))},showPanel:function(e,t){if(b)return SBTickets.showPanel(e,t);var s=r.find(" > .sb-panel-"+e);s.length&&(r.find(" > div").sbActive(!1),s.sbActive(!0),this.start_header||(this.start_header=[a.html(),a.attr("class")]),a.attr("class","sb-header sb-header-panel").html(j(t)+'<div class="sb-dashboard-btn bi-x-lg"></div>'),k.addClass("sb-panel-active"),this.dashboard=!0),B.event("SBPanelActive",e)},hidePanel:function(){k.removeClass("sb-panel-active"),a.removeClass("sb-header-panel")},clear:function(){this.conversation=!1,f.html("")},updateNotifications:function(e="add",t){if("add"!=e||this.notifications.includes(t)||(this.notifications.push(t),!this.dashboard&&this.conversation&&this.conversation.id!=t&&this.headerAnimation()),"remove"==e)for(var s=0;s<this.notifications.length;s++)if(this.notifications[s]==t){this.notifications.splice(s,1),0!=this.conversation.get("conversation_status_code")&&["1","2",1,2].includes(this.conversation.get("conversation_status_code"))&&this.setConversationStatus(0);break}var i=this.notifications.length;k.find(".sb-chat-btn span").attr("data-count",i).html(-1<i?i:0),B.event("SBNotificationsUpdate",{action:e,conversation_id:t})},setConversationStatus:function(e){return!!this.conversation&&(B.ajax({function:"update-conversation-status",conversation_id:this.conversation.id,status_code:e},()=>{this.conversation.set("conversation_status_code",e),B.event("SBActiveConversationStatusUpdated",{conversation_id:this.conversation.id,status_code:e})}),!0)},typing:function(t=-1,e="check"){if(this.conversation){var s=this.agent_online||C&&this.user_online;if("check"==e&&!E.active&&-1!=t&&t!=A&&s)B.ajax({function:"is-typing",user_id:t,conversation_id:this.conversation.id},e=>{e&&!this.typing_settings.typing?this.typing(-1,"start"):!e&&this.typing_settings.typing&&this.typing(-1,"stop")});else if("set"==e&&s){let e=this.conversation.get("source");e=e&&("fb"==e?[e,L().getExtra("facebook-id").value,this.conversation.get("extra")]:"tw"==e&&[e,L().getExtra("twitter-id").value]),E.active?B.debounce(()=>{E.trigger("client-typing",{user_id:(C?SB_ACTIVE_AGENT:L()).id,conversation_id:this.conversation.id}),e&&B.ajax({function:"set-typing",source:e})},"#2"):this.typing_settings.sent?(clearTimeout(this.typing_settings.timeout),this.typing_settings.timeout=setTimeout(()=>{B.ajax({function:"set-typing",user_id:t,conversation_id:-1},()=>{this.typing_settings.sent=!1})},2e3)):(this.typing_settings.sent=!0,B.ajax({function:"set-typing",user_id:t,conversation_id:this.conversation.id,source:e}),this.typing(t,"set"))}else"start"!=e&&"stop"!=e||(s="start"==e,!C&&n&&(s?x(n).addClass("sb-status-typing").html(j("Typing")):(e=this.agent_online||this.agent_id==A,x(n).removeClass("sb-status-typing").html(j(e?"Online":"Away")),e&&x(n).addClass("sb-status-online"))),this.typing_settings.typing=s,B.event("SBTyping",s))}},categoryEmoji:function(e){var t=this.emoji_options.list;if("all"==e)this.emoji_options.list_now=t;else{this.emoji_options.list_now=[];for(var s=0;s<t.length;s++)t[s].category.startsWith(e)&&this.emoji_options.list_now.push(t[s])}this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()},mouseWheelEmoji:function(e){let t=this.emoji_options.range;0<function(e){let t=e.originalEvent.wheelDelta;return t=typeof(t=typeof t==p?e.originalEvent.deltaY:t)==p?-1*e.originalEvent.detail:t}(e)||h&&typeof e.originalEvent.changedTouches!==p&&this.emoji_options.touch<e.originalEvent.changedTouches[0].clientY?t-=t<1?0:1:t+=t>this.emoji_options.range_limit?0:1,o.find(".sb-emoji-bar > div").sbActive(!1).eq(t).sbActive(!0),this.emoji_options.range=t,this.populateEmoji(t),e.preventDefault()},insertEmoji:function(e){0<e.indexOf(".svg")&&(e=x.parseHTML(e)[0].alt),this.insertText(e),o.sbTogglePopup()},showEmoji:function(e){o.sbTogglePopup(e)&&(C||o.css({left:d.offset().left+(b?68:20),top:d.offset().top-window.scrollY-(b?d.height()-330:304)}),""==o.find(".sb-emoji-list > ul").html()&&jQuery.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"emoji"}}).done(e=>{this.emoji_options.list=JSON.parse(e),this.emoji_options.list_now=this.emoji_options.list,this.populateEmoji(0),this.populateEmojiBar()}),B.deselectAll())},populateEmoji:function(e){let t="";var s=h?42:48;let i=e*s+s;var a=this.emoji_options.list_now;i>a.length&&(i=a.length),this.emoji_options.range_limit=a.length/s-1;for(var n=(this.emoji_options.range=e)*s;n<i;n++)t+=`<li>${a[n].char}</li>`;o.find(".sb-emoji-list").html(`<ul>${t}</ul>`)},populateEmojiBar:function(){let e='<div class="sb-active"></div>';for(var t=h?42:49,s=0;s<this.emoji_options.list_now.length/t-1;s++)e+="<div></div>";this.emoji_options.range=0,o.find(".sb-emoji-bar").html(e)},clickEmojiBar:function(e){e=x(e).index();this.populateEmoji(e),this.emoji_options.range=e,o.find(".sb-emoji-bar > div").sbActive(!1).eq(e).sbActive(!0)},searchEmoji:function(i){B.search(i,()=>{if(1<i.length){for(var e=this.emoji_options.list,t=[],s=0;s<e.length;s++)(e[s].category.toLowerCase().includes(i)||e[s].name.toLowerCase().includes(i))&&t.push(e[s]);this.emoji_options.list_now=t}else this.emoji_options.list_now=this.emoji_options.list;this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()})},textareaChange:function(e){var t=x(e).val();C&&SBAdmin.conversations.savedReplies(e,t),t?(this.typing((C&&!E.active?SB_ACTIVE_AGENT:L()).id,"set"),this.activateBar()):this.activateBar(!1)},insertText:function(e){var t,s,i=x(u.get(0));let a=0;if(this.dashboard)return!1;"selectionStart"in i.get(0)?a=i.get(0).selectionStart:"selection"in document&&(i.focus(),t=document.selection.createRange(),s=document.selection.createRange().text.length,t.moveStart("character",-i.value.length),a=t.text.length-s),i.val(i.val().substr(0,a)+e+i.val().substr(a)),i.focus(),i.manualExpandTextarea(),this.activateBar()},enabledAutoExpand:function(){u.length&&u.autoExpandTextarea()},privacy:function(){B.ajax({function:"get-block-setting",value:"privacy"},e=>{r.append(`<div class="sb-privacy sb-init-form" data-decline="${e.decline}"><div class="sb-title">${e.title}</div><div class="sb-text">${e.message}</div>`+(e.link?`<a target="_blank" href="${e.link}">${e["link-name"]}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${e["btn-approve"]}</a><a class="sb-btn sb-decline">${e["btn-decline"]}</a></div></div>`),this.finalizeInit(),B.event("SBPrivacy")}),this.dashboard||this.showDashboard(),this.dashboard=!0,k.addClass("sb-init-form-active")},popup:function(e=!1,t=!1){var s;e?(s=(e=k.find(".sb-popup-message")).attr("data-id"),y("popup"+(B.null(s)?"":s),!0),e.remove()):setTimeout(()=>{this.chat_open||(0==t&&(t=$.popup),k.find(".sb-popup-message").remove(),k.append(`<div data-id="${"id"in t?t.id:""}" class="sb-popup-message">`+("image"in t&&t.image?`<img loading="lazy" src="${t.image}" />`:"")+("title"in t&&t.title?`<div class="sb-top">${t.title}</div>`:"")+`<div class="sb-text">${t.message}</div><div class="bi-x-lg"></div></div>`),B.event("SBPopup",t))},1e3)},followUp:function(){this.followUpCheck()&&(_&&clearTimeout(_),_=setTimeout(()=>{var e;this.followUpCheck()&&(e=$.follow,this.sendMessage(A,`[email id="sb-follow-up-form" title="${e.title}" message="${e.message}" placeholder="${e.placeholder}" name="${e.name}" last-name="${e["last-name"]}" phone="${e.phone}" phone-required="${e["phone-required"]}" success="${e.success}"]`),this.scrollBottom(),B.storageTime("email"),B.event("SBFollowUp"))},B.null($.follow.delay)?$["office-hours"]||V?15e3:R.dialogflow.active()?8e3:5e3:parseInt($.follow.delay)))},followUpCheck:function(){return!C&&this.conversation&&$.follow.active&&L()&&!L().get("email")&&B.storageTime("email",24)&&($["office-hours"]||!$.follow["disable-office-hours"])},welcome:function(){"open"==$["welcome-trigger"]&&!this.chat_open||!$["office-hours"]&&$["welcome-disable-office-hours"]||!$.welcome||y("welcome")||!L()||B.ajax({function:"get-block-setting",value:"welcome"},e=>{setTimeout(()=>{$["dialogflow-welcome"]&&(!1===this.conversation?this.newConversation(3,-1,"",[],null,null,function(){R.dialogflow.welcome(e.open,e.sound)}):R.dialogflow.welcome(e.open,e.sound)),this.sendMessage(A,e.message,[],!1,!1,3),e.open&&this.start(),e.sound&&this.audio.play(),this.skip=!0,B.event("SBWelcomeMessage")},parseInt(b?0:$["welcome-delay"])),y("welcome",!0)})},offlineMessage:function(){if(!C&&!this.offline_message_set&&$.timetable&&(!$["office-hours"]||!V&&!$["timetable-disable-agents"])&&B.storageTime("timetable",1)){let e=$["timetable-message"];switch($["timetable-type"]){case"header":e[0]&&a.find(".sb-title").html(e[0]),a.find(".sb-text").html(e[1]),this.offline_message_set=!0;break;case"info":f.prepend(`<div class="sb-notify-message sb-rich-cnt">
              <div class="server-response"> <i class="bi-check2-all"></i></div>
              <div class="sb-cnt"><div class="sb-message">${e[0]?`<strong>${e[0]}</strong> `:""}${e[1]}</div></div></div>`),k.addClass("sb-notify-active"),this.offline_message_set=!0;break;default:setTimeout(()=>{this.conversation&&(this.sendMessage(A,$["timetable-hide"]?(e[0]?`*${e[0]}*
`:"")+e[1]:"[timetable]"),this.scrollBottom(),this.offline_message_set=!0,B.storageTime("timetable"))},5e3)}}},deleteMessage:function(e){B.ajax({function:"delete-message",message_id:e},()=>{this.conversation&&this.conversation.deleteMessage(e),f.find(`[data-id="${e}"]`).remove(),this.update(),console.log("chat",e),B.event("SBMessageDeleted",e)})},registration:function(e=!1,t=$["registration-required"]){if(e)return $["registration-required"]&&(!$["registration-offline"]||!V)&&(!$["registration-timetable"]||!$["office-hours"])&&(!1===L()||["visitor","lead"].includes(L().type));r.append(S.generate({},$["registration-link"]?"login":t,"sb-init-form")),this.dashboard||this.showDashboard(),this.dashboard=!0,this.finalizeInit(),k.addClass("sb-init-form-active")},activateBar:function(e=!0){d.find(".sb-bar").sbActive(e)},addUserAndLogin:function(t=!1,e=!1){var s=typeof SB_DEFAULT_USER!=p?SB_DEFAULT_USER:{};s.user_type=e?"lead":"visitor",B.ajax({function:"add-user-and-login",settings:s,settings_extra:s.extra},e=>{B.loginCookie(e[1]),L(new I(e[0])),E.start(),E.active||D.automations.run_all(),t&&t(e)})},isInitDashboard:function(){return $["init-dashboard"]||L()&&1<L().conversations.length},uploadResponse:function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1]){var s="The file you are trying to upload has an extension that is not allowed.";C?SBAdmin.dialog(s,"info"):alert(s)}else if(x(e).hasClass("sb-input-image"))x(e).find(".image").attr("data-value","").css("background-image",""),setTimeout(()=>{x(e).find(".image").attr("data-value",t[1]).css("background-image",`url("${t[1]}?v=${B.random()}")`).append('<i class="bi-x-lg"></i>'),e=!1},500);else{s=t[1].substr(t[1].lastIndexOf("/")+1);let e="";var i=/\.(jpg|jpeg|png|)$/.test(t[1].toLowerCase()),a=/\.(mp3|ogg)$/.test(t[1].toLowerCase()),n=/\.(docx|pptx|xlsx|doc|ppt|xls)$/.test(t[1].toLowerCase());e=i?`<div data-name="${s}" data-value="${t[1]}" data-id="${t[2]}">
                                <img style="border-radius: .4rem; width: 33px; vertical-align: middle;" src="${t[1]}" width="30" height="30">
                                <i class="bi-x-lg"></i>
                              </div>`:a?`<div style="display:flex;flex-direction:row;align-items: center;" data-name="${s}" data-value="${t[1]}" data-id="${t[2]}">
                                <audio controls style="max-width: 100%; max-height: 33px; border-radius: var(--chat-rounded-size-6);">
                                  <source src="${t[1]}" type="audio/${t[1].split(".").pop()}">
                                  Your browser does not support the audio element.
                                </audio>
                                <i class="bi-x-lg"></i>
                              </div>`:n?`<div data-name="${s}" data-value="${t[1]}" data-id="${t[2]}">
                                <i class="bi bi-file-earmark-text-fill" style="font-size:1.8rem"></i>
                                 <i class="bi-x-lg"></i>
                              </div>`:`<div data-name="${s}" data-value="${t[1]}" data-id="${t[2]}">
          <i class="bi bi-file-earmark-text-fill" style="font-size:1.89rem; color: var(--chat-text-primary)"></i>
           <i class="bi-x-lg"></i>
        </div`,d.find(".sb-attachments").append(e),D.activateBar()}else B.error(t[1],"sb-upload-files.change");this.busy(!1)},closeChat:function(e=!0){let t=this.conversation.id;function s(){k.find(`li[data-conversation-id="${t}"]`).remove(),g="new-conversation",D.clear(),y("open-conversation",""),L().removeConversation(t),$["disable-dashboard"]||D.showDashboard()}D.clear(),e?B.ajax({function:"update-conversation-status",conversation_id:t,status_code:3},()=>{s()}):s()},automations:{history:[],busy:[],scroll_position_intervals:{},timeout_queue:[],run_all:function(){for(var e=$.automations,o=0;o<e.length;o++){let t=e[o];var r=t.conditions;let s=0==r.length,i=!1,a=!1,n=!1;for(var l=0;l<r.length;l++){var c=r[l][1];switch(s=!1,r[l][0]){case"browsing_time":s=!0,i=c;break;case"scroll_position":s=!0,a=c;break;case"include_urls":case"exclude_urls":case"referring":let e="referring"==r[l][0]?document.referrer:window.location.href;var d=r[l][2].split(","),u="exclude_urls"!=r[l][0];u||(s=!0),e=e.replace("https://","").replace("http://","").replace("www.","");for(var h=0;h<d.length;h++)if(d[h]=x.trim(d[h].replace("https://","").replace("http://","").replace("www.","")),"contains"==c&&-1!=e.indexOf(d[h])||"does-not-contain"==c&&-1==e.indexOf(d[h])||"is-exactly"==c&&d[h]==e||"is-not"==c&&d[h]!=e){s=u;break}break;case"custom_variable":var g=c.split("=");g[0]in window&&window[g[0]]==g[1]&&(s=!0);break;case"returning_visitor":case"user_type":case"cities":case"languages":case"countries":s=L(),n=!0;break;case"user_phone":s=L()&&!B.null(L().getExtra("phone"));break;case"user_email":s=L()&&!B.null(L().get("email"));break;default:s=!0}if(!s)break}(s=["messages","emails","sms"].includes(t.type)&&!L()?!1:s)&&(n?t.id in this.busy||(B.ajax({function:"automations-validate",automation:t},e=>{!1!==e&&this.run_all_final(t,a,i),delete this.busy[t.id]}),this.busy[t.id]=!0):this.run_all_final(t,a,i))}},run_all_final:function(e,t,s){t?this.scroll_position_intervals[e.id]=setInterval(()=>{x(window).scrollTop()>parseInt(t)&&(s?setTimeout(()=>{this.run(e)},1e3*parseInt(s)):this.run(e),clearInterval(this.scroll_position_intervals[e.id]))},1e3):s?this.timeout_queue.includes(e.id)||(setTimeout(()=>{this.run(e)},1e3*parseInt(s)),this.timeout_queue.push(e.id)):this.run(e)},run:function(t){if(!this.history.includes(t.id))switch(t.type){case"messages":case"emails":case"sms":if((!E.active||E.started)&&!(t.id in this.busy)){if("messages"==t.type&&D.chat_open){var s=!!D.conversation&&D.conversation.getLastUserMessage(!1,"no-bot");if(s&&Date.now()-6e5<B.unix(s.get("creation_time")))return}B.ajax({function:"automations-run",automation:t},e=>{!1!==e&&(this.history.push(t.id),"messages"!=t.type||E.active||D.updateConversations()),delete this.busy[t.id]}),this.busy[t.id]=!0}break;case"popups":y("popup"+t.id)||setTimeout(()=>{var e;D.chat_open?t.fallback&&(!(e=!!D.conversation&&D.conversation.getLastUserMessage(!1,"no-bot"))||Date.now()-6e5>B.unix(e.get("creation_time")))&&(D.sendMessage(A,(B.null(t.title)?"":`*${t.title}*
`)+t.message,[],!1,!1,0),y("popup"+t.id,!0),this.history.push(t.id)):(D.popup(!1,{id:t.id,image:t.profile_image,title:t.title,message:t.message}),this.history.push(t.id))},1e3);break;case"design":t.background&&a.css("background-image",`url("${t.background}")`),t.brand&&a.find(".sb-brand img").attr("src",t.brand),t.title&&a.find(".sb-title").html(t.title),t.message&&a.find(".sb-text").html(t.message),t.icon&&k.find(".sb-chat-btn .sb-icon").attr("src",t.icon),(t.color_1||t.color_2||t.color_3)&&B.ajax({function:"chat-css",color_1:t.color_1,color_2:t.color_2,color_3:t.color_3},e=>{i.append(`<style>${e}</style>`)}),this.history.push(t.id);break;case"more":let e={};t.department&&(D.default_department=t.department,e={function:"update-conversation-department",department:t.department}),t.agent&&(D.default_agent=t.agent,e={function:"update-conversation-agent",agent_id:t.agent}),t.tags&&(t.tags=t.tags.split(","),D.default_tags=t.tags,e={function:"update-tags",tags:t.tags,add:!0}),D.conversation.id&&(t.tags||t.agent||t.department)&&(e.conversation_id=D.conversation.id,B.ajax(e))}}},flashNotification:function(){clearInterval(O),O=setInterval(function(){document.title=document.title==z?j("New message..."):z},2e3)},calculateLabelDates:function(){(C||this.chat_open)&&(F=f.find(".sb-label-date"))},calculateLabelDateFirst:function(){this.conversation.messages.length||f.append(`<div class="sb-label-date"><span>${j("Today")}</span></div>`)}},S=(window.SBChat=D,{rich_messsages:{email:"",button:"",video:"",si:'<div class="sb-btn">Sí</div>',no:'<div class="sb-btn">No</div>',image:"",chips:'<div style="margin: 8px;" class="sb-buttons">[options]</div>',buttons:'<div class="sb-buttons">[options]</div>',select:'<div class="sb-select"><p></p><ul>[options]</ul></div>',list:'<div class="sb-text-list">[values]</div>',"list-image":'<div class="sb-image-list">[values]</div>',table:"<table><tbody>[header][values]</tbody></table>",inputs:'<div class="sb-form">[values]</div>',rating:'<div class="sb-rating"><span>[label]</span></div>',card:'<div class="sb-card">[settings]</div>',share:'<div class="sb-social-buttons">[settings]</div>',slider:'<div class="sb-slider"><div>[items]</div></div><div class="sb-slider-arrow bi-arrow-right-left[class]"></div><div class="sb-slider-arrow bi-arrow-right-circle sb-active[class]"></div>',"slider-images":'<div class="sb-slider sb-slider-images"><div>[items]</div></div><div class="sb-slider-arrow bi-arrow-right-left[class]"></div><div class="sb-slider-arrow bi-arrow-right-circle sb-active[class]"></div>',phone:""},cache:{},generate:function(a,n,e=""){let o,t=!0,s="id"in a?a.id:B.random(),i=new w({});n in this.rich_messsages?o=this.rich_messsages[n]:n in this.cache?o=this.cache[n]:C||!B.null($)&&"rich-messages"in $&&$["rich-messages"].includes(n)?("id"in a||(s=n),o='<div class="sb-rich-loading sb-loading"></div>',B.ajax({function:"get-rich-message",name:n,settings:a},e=>{e=i.render(this.initInputs(e)),"timetable"==n&&(e=this.timetable(e)),k.find(`.sb-rich-message[id="${s}"]`).html(`<div class="sb-content">${e}</div>`),this.cache[n]=e,D.scrollBottom(D.dashboard)}),t=!1):o=`[${n}]`;var r="disabled"in a;if(t){let s,i="";var l=B.get_value(B.admin_set("rate-and-review")["rate-review"]);switch(n){case"button":o=a.link&&a.style?`<a href="${a.link.replace(/<i>/g,"_").replace(/<\/i>/g,"_")}"${"target"in a?' target="_blank"':""} class="sb-rich-btn sb-btn${"link"==a.style?"-text":""}">${j(a.name)}</a>`:a.yes&&a.no?"si"===a.yes&&"no"===a.no?""+S.rich_messsages.yes+S.rich_messsages.no:"yes"===a.yes&&"no"===a.no?""+S.rich_messsages.no+S.rich_messsages.yes:`<button class="sb-rich-btn sb-btn">${j(a.name)}</button>`:`<button class="sb-rich-btn sb-btn">${j(a.name)}</button>`;break;case"rating":o=o.replace("[label]",j(B.null(a.label)?j(l):a.label).replace(/\n/g,"<br>")).replace("[success-negative]",B.null(a["success-negative"])?"":j(a["success-negative"])).replace("[positive]",j(B.null(a["label-positive"])?"Helpful":a["label-positive"])).replace("[negative]",j(B.null(a["label-negative"])?"Not helpful":a["label-negative"]));break;case"email":var c=[],d=L().get("email"),u="#"==L().get("last_name").charAt(0);"true"==a.name&&c.push(["first_name","true"==a["last-name"]?"First name":"Name",u?"":"true"==a["last-name"]?L().get("first_name"):L().name,"text",!0]),"true"==a["last-name"]&&c.push(["last_name","Last name",u?"":L().get("last_name"),"text",!0]);for(var h=0;h<c.length;h++)o+=`<div id="${c[h][0]}" data-type="text" class="sb-input sb-input-text"><span class="${""==c[h][2]?"":"sb-active sb-filled"}">${j(c[h][1])}</span><input value="${c[h][2]}" autocomplete="false" type="${c[h][3]}" ${c[h][4]?"required":""}></div>`;if("true"==a.phone){var u=L().getExtra("phone"),g=C?[]:$["phone-codes"];let e="";if(1===g.length)e=`<input disabled value="${g[0]}">`;else{for(h=0;h<g.length;h++)e+=`<option value="+${g[h]}">+${g[h]}</option>`;e=`<select style='color:black!important;'><option value="">+00</option>${e}</select>`}o+=`<div id="phone" data-type="select-input" class="sb-input sb-input-select-input"><span class="${""==u?"":"sb-active sb-filled"}">${j("Phone")}</span><div>${e}</div><input value="${C?"":u}" pattern="[0-9]+" autocomplete="false" type="tel" ${"false"!=a["phone-required"]?"required":""}></div>`}o+=`<div id="email" data-type="email" class="sb-input sb-input-btn"><span class="${""==d?"":"sb-active sb-filled"}">${j(B.null(a.placeholder)?"Email":a.placeholder)}</span><input value="${d}" autocomplete="off" type="email" required><div class="sb-submit bi-arrow-right-circle"></div></div>`;break;case"image":o=`<div class="sb-image"><img loading="lazy" src="${a.url}"></div>`;break;case"video":o=`<iframe loading="lazy"${"height"in a?` height="${a.height}"`:""} src="${"youtube"==a.type?"//www.youtube.com/embed/":"//player.vimeo.com/video/"}${a.id}" allowfullscreen></iframe>`;break;case"select":s=a.options.split(",");for(h=0;h<s.length;h++)i+=`<li data-value="${B.stringToSlug(s[h])}">${j(s[h])}</li>`;o=o.replace("[options]",i);break;case"chips":case"buttons":s=a.options.split(",");for(h=0;h<s.length;h++)i+=`<div class="sb-btn sb-submit">${j(s[h])}</div>`;o=o.replace("[options]",i);break;case"list":s=a.values.split(",");var u="list"==n,p=u&&s.length&&0<s[0].indexOf(":");u&&!p&&(o=o.replace("sb-text-list","sb-text-list sb-text-list-single"));for(h=0;h<s.length;h++)i+=p?`<div><div>${j(s[h].split(":")[0])}</div><div>${j(s[h].split(":")[1])}</div></div>`:`<div>${x.trim(j(s[h]))}</div>`;o=o.replace("[values]",i);break;case"list-image":s=a.values.split(",");for(h=0;h<s.length;h++){var m=s[h].replace("://","///").split(":");i+=`<div><div class="sb-thumb" style="background-image:url('${m[0].replace("///","://")}')"></div><div class="sb-list-title">${m[1]}</div><div>${m[2]}</div></div>`}o=o.replace("[values]",i);break;case"table":s=a.header.split(","),i+="<tr>";for(h=0;h<s.length;h++)i+=`<th>${s[h]}</th>`;i+="</tr>",o=o.replace("[header]",i),i="",s=a.values.split(",");for(h=0;h<s.length;h++){var v=s[h].split(":");i+="<tr>";for(h=0;h<v.length;h++)i+=`<td>${v[h]}</td>`;i+="</tr>"}o=o.replace("[values]",i);break;case"inputs":s=a.values.split(",");for(h=0;h<s.length;h++)r&&""==s[h]||(i+=`<div id="${B.stringToSlug(s[h])}" data-type="text" class="sb-input sb-input-text"><span>${j(s[h])}</span><input autocomplete="false" type="text" required></div>`);i+='<div class="sb-btn sb-submit">'+j("button"in a?a.button:"Send now")+"</div>",o=o.replace("[values]",i);break;case"card":i=`${"image"in a?`<div class="sb-card-img" style="background-image:url('${a.image}')"></div>`:""}<div class="sb-card-header">${a.header}</div>`+("extra"in a?`<div class="sb-card-extra">${a.extra}</div>`:"")+("description"in a?`<div class="sb-card-description">${a.description}</div>`:"")+("link"in a?`<a class="sb-card-btn" href="${a.link}"${"target"in a?' target="_blank"':""}>${j(a["link-text"])}</a>`:""),o=o.replace("[settings]",i);break;case"share":var f="channels"in a?a.channels.replace(/ /g,"").split(","):["fb","tw","li","wa","pi"];let e="";for(h=0;h<f.length;h++){switch(f[h]){case"fb":e="www.facebook.com/sharer.php?u=";break;case"tw":e="twitter.com/intent/tweet?url=";break;case"li":e="www.linkedin.com/sharing/share-offsite/?url=";break;case"wa":e="web.whatsapp.com/send?text=";break;case"pi":e="www.pinterest.com/pin/create/button/?url="}i+=`<div class="sb-${f[h]} sb-icon-social-${f[h]}" data-link="https://${e}${a.link}"></div>`}o=o.replace("[settings]",i);break;case"slider":let t=0;for(h=1;h<16&&"header-"+h in a;h++)i+=`<div>${"image-"+h in a?`<div class="sb-card-img" style="background-image:url('${a["image-"+h]}')"></div>`:""}<div class="sb-card-header">${a["header-"+h]}</div>${"extra-"+h in a?`<div class="sb-card-extra">${a["extra-"+h]}</div>`:""}${"description-"+h in a?`<div class="sb-card-description">${a["description-"+h]}</div>`:""}${"link-"+h in a?`<a class="sb-card-btn" href="${a["link-"+h]}"${"target"in a?' target="_blank"':""}>${j(a["link-text-"+h])}</a>`:""}</div>`,t++;o=o.replace("[items]",i).replace(/\[class\]/g,1==t?" sb-hide":"");break;case"slider-images":if("images"in a){for(var b=a.images.split(","),h=0;h<b.length;h++)i+=`<div class="sb-card-img" data-value="${b[h]}" style="background-image:url('${b[h]}')"></div>`;o=o.replace(/\[class\]/g,1==b.length?" sb-hide":"")}o=o.replace("[items]",i);break;default:o=`[${n}]`}}return`<div id="${s}" data-type="${n}"${r?'disabled="true"':""}${"settings"in a?` data-settings="${a.settings}"`:""} class="sb-rich-message sb-rich-${n} ${e}">`+("title"in a?`<div class="sb-top">s${i.render(j(a.title))}</div>`:"")+("message"in a?`<div class="sb-text">${i.render(j(a.message))}</div>`:"")+`<div class="sb-content">${o}</div><div data-success="${"success"in a?a.success.replace(/"/g,""):""}" class="sb-info"></div></div>`},submit:function(p,m,v){if(!C&&!function(e){if(x(e).sbLoading())return 1;x(e).sbLoading(!0)}(v)&&!this.is_busy){let e="",t="",s={},i=x(p).find("[data-success]").length?x(p).find("[data-success]").attr("data-success"):"",a=x(p).closest(".sb-rich-message").attr("id"),n=x(p).closest("[data-id]").attr("data-id"),o="",r={"rich-messages":{}},l=0==L()?{profile_image:["",""],first_name:["",""],last_name:["",""],email:["",""],password:["",""],user_type:["",""]}:{profile_image:[L().image,""],first_name:[L().get("first_name"),""],last_name:[L().get("last_name"),""],email:[L().get("email"),""],password:["",""],user_type:["",""]},c={},d=x(v),u="",h=!1;var f=!1!==D.conversation;let g={};var b={};switch(B.null(n)?n=-1:(S=D.conversation.getMessage(n),o=S.message,"rich-messages"in(r=S.payload())||(r["rich-messages"]={})),x(v).hasClass("sb-btn")||x(v).hasClass("sb-select")||x(v).hasClass("sb-submit")||(d=x(v).closest(".sb-btn,.sb-select")),x(p).find(".sb-info").html("").sbActive(!1),m){case"email":var _="last_name"in c;"first_name"in(c=M.getAll(p))&&(l.user_type=["user",""],_||(l.last_name=["",""])),"phone"in c&&(g={phone:[c.phone[0],"Phone"]}),x.extend(l,c),e="Please fill in all required fields and make sure the email is valid.",i=i&&j(i).replace("{user_email}",l.email[0]).replace("{user_name_}",l.first_name[0]+(_?" "+l.last_name[0]:"")),r["rich-messages"][a]={type:m,result:c},r.event="update-user",s={function:"update-user-and-message",settings:l,settings_extra:g,payload:r},h={settings:l,settings_extra:g};break;case"registration":if(g=M.getAll(p.find(".sb-form-extra")),x.extend(l,M.getAll(p.find(".sb-form-main"))),b=x.extend({},l),i=i&&j(i),$["registration-details"]){for(var y in i+='[list values="',l){let e=l[y][0].replace(/:|,/g,"");e&&("profile_image"==y&&(e=e.substr(e.lastIndexOf("/")+1)),"password"!=y&&"password-check"!=y||(e="********",b[y]="********"),i+=""==l[y][1]?"":`${j(l[y][1].replace(/:|,/g,""))}:${e},`)}for(var y in g)g[y][0]&&(i+=`${j(g[y][1].replace(/:|,/g,""))}:${g[y][0].replace(/:|,/g,"")},`);i=i.slice(0,-1)+'"]'}l.user_type=["user",""],r["rich-messages"][a]={type:m,result:{user:b,extra:g}},r.event="update-user",s={function:L()?"update-user-and-message":"add-user-and-login",settings:l,settings_extra:g,payload:r},e=M.getRegistrationErrorMessage(p),h={settings:l,settings_extra:g};break;case"rating":var _=x(v).attr("data-rating"),w=D.conversation.getLastUserMessage(!1,!0);i=""+j(""==i?j("Thank you for your feedback!"):i),c={conversation_id:D.conversation.id,agent_id:w?w.get("user_id"):A,user_id:L().id,message:p.find("textarea").val(),rating:"positive"==_?1:-1},r["rich-messages"][a]={type:m,result:c},s={function:"set-rating",payload:r,settings:c},u=_;break;case"chips":case"select":case"buttons":c=B.escape(x(v).html()),i=""==i?i:j(i)+` *${c}*`,r["rich-messages"][a]={type:m,result:c},s={function:"update-message",payload:r},u=c,"chips"==m&&(D.sendMessage(L().id,c,[],!1,{id:a,event:"chips-click",result:c},"sb-human-takeover"==a&&0==d.index()&&2),"sb-human-takeover"==a&&0==x(v).index()&&R.dialogflow.humanTakeover(),x(v).closest(".sb-content").remove());break;case"inputs":if(c=M.getAll(p),e="All fields are required.",i){for(var y in i=j(i)+' [list values="',c)i+=`${j(c[y][1].replace(/:|,/g,""))}:${c[y][0].replace(/:|,/g,"")},`;i=i.slice(0,-1)+'"]'}r["rich-messages"][a]={type:m,result:c},s={function:"update-message",payload:r},h={settings:c}}if(t=(t=o.substr(o.indexOf("["+m))).substr(0,t.indexOf("]")+1),e&&M.errors(p))return M.showErrorMessage(p,e),d.sbLoading(!1),(D.dashboard||f&&D.conversation.getLastMessage().id==n)&&D.scrollBottom(),!1;if(!i&&"registration"!=m){var S=this.shortcode(t),f="title"in S[1]?`title="${S[1].title}"`:"",S="message"in S[1]?`message="${S[1].message}"`:"";let e="";if(["inputs","email"].includes(m)){for(var y in c)e+=c[y][0]+",";e=`values="${e.slice(0,-1)}"`}else e=`options="${c}"`;i=`[${"email"==m?"inputs":m} ${f} ${S} ${e} disabled="true"]`}-1!=n&&x.extend(s,{message_id:n,message:o?o.replace(t,i):i,payload:r}),B.ajax(s,e=>{if(0==e||B.errorValidation(e))M.showErrorMessage(p,M.getRegistrationErrorMessage(e,"response")),D.dashboard&&D.scrollBottom(),d.sbLoading(!1);else{switch(m){case"email":for(var t in l)L().set(t,l[t][0]);for(var t in g)L().setExtra(t,g[t][0]);B.loginCookie(e[1]),"sb-subscribe-form"==a&&B.ajax({function:"subscribe-email",email:L().get("email")}),D.automations.run_all(),B.event("SBNewEmailAddress",{id:a,name:L().name,email:L().get("email")});break;case"registration":if(B.loginCookie(e[1]),l.id=[e[0].id],L()){for(var t in l)L().set(t,l[t][0]);for(var t in g)L().setExtra(t,g[t][0]);D.automations.run_all()}else{for(var t in L(new I(e[0])),g)L().setExtra(t,g[t][0]);E.start(),D.initChat(),$["init-dashboard"]&&k.find(".sb-departments-list").length||!i||D.sendMessage(A,i,[],!1,!1,3)}D.dashboard&&(k.removeClass("sb-init-form-active"),x(p).remove(),D.isInitDashboard()||D.hideDashboard()),delete this.cache.registration,setTimeout(()=>{B.event("SBRegistrationForm",{id:a,conversation_id:!!D.conversation&&D.conversation.id,user:l,extra:r["rich-messages"][a].result.extra})},5e3)}-1==n?x(v).closest(".sb-rich-message").html(i):"type"in r&&"close-message"==r.type||T||D.setConversationStatus(2),["login","chips","rating"].includes(m)||!$["dialogflow-send-user-details"]&&["email","registration"].includes(m)||R.dialogflow.message(""+a+(u?"|"+u:""),[],!1,h),!$["slack-active"]||T&&!R.dialogflow.humanTakeoverActive()||D.slackMessage(L().id,L().name,L().image,i),E.active&&D.update(),"registration"!=m&&"email"!=m&&B.event("SBRichMessageSubmit",{result:e,data:r["rich-messages"][a],id:a})}})}},shortcode:function(e){if(e.indexOf(" ")<0)return[e.slice(1,-1),{}];for(var t,s={},i=e.substr(1,e.indexOf(" ")-1),a=(e=e.slice(1,-1).substr(i.length+1)).split('" '),n=0;n<a.length;n++)a[n].includes("=")&&(t=[a[n].substr(0,a[n].indexOf("=")),a[n].substr(a[n].indexOf("=")+2)],s[x.trim(t[0])]=t[1].replace(/"/g,""));return[i,s]},initInputs:function(e){return(e=x(x.parseHTML("<div>"+e+"</div>"))).find(".sb-input input").each(function(){x(this).val()&&x(this).siblings().addClass("sb-active sb-filled")}),e.html()},timetable:function(e){e=x(x.parseHTML(`<div>${e}</div>`));let i=e.find("[data-offset]").attr("data-offset"),a=(i=B.null(i)?0:parseInt(i),"");return e.find("[data-time]").each(function(){for(var e,t=x(this).attr("data-time").split("|"),s=0;s<t.length;s++){if("closed"==t[s]){a+="Closed";break}t[s]&&(e=t[s].split(":"),e=B.convertUTCDateToLocalDate(`01/01/2000 ${e[0]}:`+e[1],i),a+=e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+(0==s||2==s?" (to) ":1==s&&t[s+1]?"\n":""))}a+="\n"}),a+="Time zone "+Intl.DateTimeFormat().resolvedOptions().timeZone},sliderChange:function(e,t="left"){let s=f.find("#"+e);var i,a;s.length&&!s.hasClass("sb-moving")&&(i=(e=s.find(".sb-slider > div > div")).eq(0),a=Math.ceil(i.closest(".sb-slider").width()),t="right"==t?-1:1,t=parseFloat(parseFloat(parseFloat(i.css("margin-left"))+a*t).toFixed(2))+-.5*t,a=a*(e.length-1)*-1,t<1&&a<=t&&(i.css("margin-left",t+"px"),s.addClass("sb-moving"),setTimeout(()=>{s.removeClass("sb-moving")},1200)),s.find(".bi-arrow-right-circle").sbActive(!(t-15<a&&a<t+15)),s.find(".bi-arrow-right-left").sbActive(t<-10))}}),M={getAll:function(e){let s={};return x(e).find(".sb-input[id]").each((e,t)=>{s[x(t).attr("id")]=this.get(t)}),s},get:function(e){var t=(e=x(e)).data("type"),s=j(B.escape(e.find(" > span").html()));switch(t){case"image":var i=e.find(".image").attr("data-value");return[B.null(i)?"":i,s];case"select":return[B.escape(e.find("select").val()),s];case"select-input":var i=e.find("select,input[disabled]"),a=i.val();return[B.escape((i.is("select")||i.is("input")?a:e.find("> div").html())+e.find('input[type="tel"]').val()),s];default:i=e.find("input");return[B.escape(i.length?i.val():e.find("[data-value]").attr("data-value")),s]}},set:function(e,t){if((e=x(e)).length){switch(e.data("type")){case"image":""==t?e.find(".image").removeAttr("data-value").removeAttr("style"):e.find(".image").attr("data-value",t).css("background-image",`url("${t}")`);break;case"select":e.find("select").val(t);break;default:e.find("input,textarea").val(t)}return!0}return!1},clear:function(e){x(e).find(".sb-input,.sb-input-setting").each((e,t)=>{this.set(t,""),x(t).find("input, select, textarea").removeClass("sb-error")}),this.set(x(e).find("#user_type"),"lead")},errors:function(e){let a=!1,n=x(e).find("input, select, textarea").removeClass("sb-error");return n.each(function(e){var t=x.trim(x(this).val()),s=x(this).attr("type"),i=x(this).prop("required");(i&&""==t||(i||t)&&("password"==s&&(t.length<8||n.length>e+1&&"password"==n.eq(e+1).attr("type")&&n.eq(e+1).val()!=t)||"email"==s&&(t.indexOf("@")<0||t.indexOf(".")<0||/;|:|\/|\\|,|#|"|!|=|\+|\*|{|}|[|]|£|\$|€|~|'|>|<|\^|&/.test(t))||"tel"==s&&t&&(""==x(this).parent().find("select").val()||isNaN(t)||t.includes("+")||t.length<5)))&&(a=!0,x(this).addClass("sb-error"))}),(n=x(e).find("[data-required]").removeClass("sb-error")).each(function(){B.null(x(this).attr("data-value"))&&(x(this).addClass("sb-error"),a=!0)}),a},showErrorMessage:function(e,t){x(e).find(".sb-info").html(j(t)).sbActive(!0),clearTimeout(_),_=setTimeout(function(){x(e).find(".sb-info").sbActive(!1)},2500)},showSuccessMessage:function(e,t){x(e).find(".sb-info").remove(),x(e).addClass("sb-success").find(".sb-content").html(`<div class="sb-text">${t}</div>`)},getRegistrationErrorMessage(e,t="validation"){var s;return"response"==t?B.errorValidation(e,"duplicate-email")?"This email is already in use. Please use another email.":B.errorValidation(e,"duplicate-phone")?"This phone number is already in use. Please use another number.":"Error. Please check your information and try again.":(t=x(e).find("#last_name").length?"First name, last name":"Name",s=x(e).find("#phone [required]").length?", phone number":"",t+(t=x(e).find("#email").length?", email":"")+s+(e=x(e).find("#password").length?", and a password (8 character minimum)":"")+` ${t+s+e==""?"is":"are"} required.`)}},R=(window.SBForm=M,{login:function(){return this.is("wp")&&typeof SB_WP_ACTIVE_USER!=p&&"wp"==$["wp-users-system"]?[[SB_WP_ACTIVE_USER,typeof SB_WP_AVATAR!=p?SB_WP_AVATAR:""],"wp"]:typeof SB_PERFEX_ACTIVE_USER!=p?[[SB_PERFEX_ACTIVE_USER,SB_PERFEX_CONTACT_ID],"perfex"]:typeof SB_WHMCS_ACTIVE_USER!=p?[SB_WHMCS_ACTIVE_USER,"whmcs"]:typeof SB_AECOMMERCE_ACTIVE_USER!=p?[SB_AECOMMERCE_ACTIVE_USER,"aecommerce"]:typeof SB_DEFAULT_USER!=p&&[SB_DEFAULT_USER,"default"]},is:function(e){return C?SBAdmin.apps.is(e):"wordpress"==e||"wp"==e?$.wp:e in $&&$[e]},wordpress:{ajax:function(e,t,s=!1){typeof SB_WP_AJAX_URL!=p&&x.ajax({method:"POST",url:SB_WP_AJAX_URL,data:x.extend({action:"sb_wp_ajax",type:e},t)}).done(e=>{s&&s(e)})}},dialogflow:{token:y("dialogflow-token"),typing_enabled:!1,project_id:!1,message:function(r="",e=[],t=!1,s=!1){if(this.active()){let o=R.dialogflow.humanTakeoverActive();o&&!this.typing_enabled||(_=setTimeout(()=>{D.typing(-1,"start"),setTimeout(()=>{D.typing(-1,"stop")},1e4)},1e3)),setTimeout(()=>{B.ajax({function:"dialogflow-message",conversation_id:!!D.conversation&&D.conversation.id,message:r,attachments:e,parameters:s,token:this.token,dialogflow_language:y("dialogflow-language")?y("dialogflow-language"):SB_LANG,project_id:this.project_id},e=>{if(!1!==e){if("human_takeover"in e)return D.offlineMessage(),D.followUp(),this.active(!1);if("language_detection"in e&&!y("dialogflow-language")&&y("dialogflow-language",[e.language_detection]),!B.errorValidation(e)){var t="queryResult"in e.response&&e.response.queryResult,s=t&&("input.unknown"==t.action||"match"in t&&"NO_MATCH"==t.match.matchType),i="messages"in e&&Array.isArray(e.messages)?e.messages:[];if(D.typing(-1,"stop"),clearTimeout(_),this.token!=e.token&&(this.token=e.token,y("dialogflow-token",e.token)),s?o&&(this.typing_enabled=!1):this.typing_enabled=!0,t){"action"in t&&("end"==(s=t.action)&&this.active(!1),B.event("SBBotAction",s));for(var a,n=0;n<i.length;n++){if("payload"in i[n]){let t=["human-takeover","redirect","transcript","department","agent","send-email","disable-bot","rich-message"],s=i[n].payload;B.null(s)&&(s=[]),t[0]in s&&!0===s[t[0]]&&this.humanTakeover(),t[1]in s&&setTimeout(function(){"new-window"in s&&s["new-window"]?window.open(s[t[1]]):document.location=s[t[1]]},500),t[4]in s&&D.showArticles(s[t[4]]),t[5]in s&&s[t[5]]&&B.ajax({function:"transcript",conversation_id:D.conversation.id,type:"txt"},e=>{"email"==s[t[5]]&&L().get("email")?D.sendEmail("message"in s?s.message:"",[[e,e]],!0):window.open(e)}),t[6]in s&&B.ajax({function:"update-conversation-department",conversation_id:D.conversation.id,department:s[t[6]],message:D.conversation.getLastUserMessage().message}),t[7]in s&&B.ajax({function:"update-conversation-agent",conversation_id:D.conversation.id,agent_id:s[t[7]],message:D.conversation.getLastUserMessage().message}),t[8]in s&&(a=s[t[8]],D.sendEmail(a.message,a.attachments,"active_user"==a.recipient)),t[9]in s&&(this.active(!1),B.cookie("sb-dialogflow-disabled",!0,300,"set",!0)),t[10]in s&&D.sendMessage(A,s[t[10]]),B.event("SBBotPayload",s)}y("dialogflow-language")||!("languageCode"in t)||SB_LANG&&t.languageCode==SB_LANG[0]||y("dialogflow-language",[t.languageCode])}"diagnosticInfo"in t&&"end_conversation"in(s=t.diagnosticInfo)&&s.end_conversation&&this.active(!1)}B.event("SBBotMessage",{response:e,message:r})}}})},!1!==t?t:0==$["bot-delay"]?2e3:parseInt($["bot-delay"]))}},active:function(e=!0){var t="human-takeover-"+D.conversation.id;return!1===e?(B.storageTime(t),!1):("activate"==e&&(B.cookie("sb-dialogflow-disabled",0,0,"delete"),B.storage(t,"")),$["dialogflow-active"]&&!C&&!B.cookie("sb-dialogflow-disabled")&&(B.storageTime(t,240)||!D.agent_online)&&(!$["bot-office-hours"]||!$["office-hours"]))},welcome:function(e=!1,t=!1){B.ajax({function:"dialogflow-message",message:"",conversation_id:D.conversation.id,token:this.token,event:"Welcome",dialogflow_language:y("dialogflow-language")?y("dialogflow-language"):SB_LANG},()=>{e&&D.start(),t&&D.audio.play()})},humanTakeover:function(){B.ajax({function:"dialogflow-human-takeover",conversation_id:D.conversation.id},()=>{D.offlineMessage(),D.followUp(),this.active(!1),$["queue-human-takeover"]&&($.queue=!0,D.queue(D.conversation.id))})},humanTakeoverActive:function(){return!B.storageTime("human-takeover-"+(D.conversation?D.conversation.id:y("open-conversation")),240)},translate:function(e,t,s){B.ajax({function:"google-translate",strings:e,language_code:t,token:this.token},e=>{this.token=e[1],s(e[0])})}}});function Y(){function t(){setTimeout(()=>{x(".bi-arrow-up-circle-fill").removeClass("sb-hide")},500)}(k=x(".sb-admin, .sb-chat, .sb-tickets")).length&&typeof SB_AJAX_URL!=p?(f=k.find(".sb-list"),d=k.find(".sb-editor"),u=d.find("textarea"),r=k.find(C||b?".sb-list":"> div > .sb-scroll-area"),l=k.find(".sb-label-date-top"),a=r.find(".sb-header"),o=d.find(".sb-emoji"),n=b?k.find(".sb-profile-agent .sb-status"):null,D.enabledAutoExpand(),D.audio=k.find("#sb-audio").get(0),D.audio_out=k.find("#sb-audio-out").get(0),B.cookie("sb-check","ok",1,"set"),"ok"!=B.cookie("sb-check")?(H=!1,console.warn("Steambox: cookies not available.")):B.cookie("sb-check",!1,!1,!1),C?B.event("SBReady"):(B.ajax({function:"get-front-settings",current_url:window.location.href},e=>{$=e,typeof SB_LOCAL_SETTINGS!=p&&x.extend($,SB_LOCAL_SETTINGS),A=$["bot-id"],T=$["dialogflow-human-takeover"],V=$["agents-online"],E.active=$.pusher,typeof SB_REGISTRATION_REQUIRED!=p&&($["registration-required"]=SB_REGISTRATION_REQUIRED,$["tickets-registration-required"]=SB_REGISTRATION_REQUIRED),typeof SB_ARTICLES_PAGE!=p&&SB_ARTICLES_PAGE&&D.initArticlesPage(),b&&$["tickets-manual-init"]||(!b||$["tickets-manual-init"])&&($["chat-manual-init"]||$["disable-offline"]&&!V||$["disable-office-hours"]&&!$["office-hours"]||$["chat-login-init"]&&!R.login())||D.initChat(),$.cron&&setTimeout(function(){B.ajax({function:"cron-jobs"})},1e4),$["cron-email-piping"]&&setTimeout(function(){B.ajax({function:"email-piping"})},8e3),$["push-notifications-users"]&&E.initServiceWorker(),b&&($["tickets-default-department"]&&(D.default_department=$["tickets-default-department"]),$["dialogflow-disable-tickets"])&&($["dialogflow-active"]=!1),B.event("SBReady")}),D.audio&&(D.audio.volume=.6),D.audio_out&&(D.audio_out.volume=.6)),x(d).on("keydown","textarea",function(e){if(13==e.which&&(!b||$["tickets-enter-button"])&&(!C||!e.ctrlKey&&!e.shiftKey))return D.submit(),e.preventDefault,!1;C&&13==e.which&&e.ctrlKey&&D.insertText("\n")}),x(k).on("keydown",".sb-dashboard-articles input",function(e){13==e.which&&x(this).next().click()}),typeof SB_DEFAULT_DEPARTMENT!==p&&(D.default_department=SB_DEFAULT_DEPARTMENT),typeof SB_DEFAULT_AGENT!==p&&(D.default_agent=SB_DEFAULT_AGENT),typeof SB_DIALOGFLOW_TAGS!==p&&(D.default_tags=SB_DEFAULT_TAGS),typeof SB_DIALOGFLOW_AGENT!==p&&(R.dialogflow.project_id=SB_DIALOGFLOW_AGENT)):B.event("SBReady"),document.addEventListener("visibilitychange",function(){B.visibilityChange(document.visibilityState)},!1),x(k).on("click",function(){D.tab_active||B.visibilityChange()}),i=k,C&&(k=k.find(".sb-conversation")),x(r).on("scroll",function(){var e=r.scrollTop(),t=F.length;if(D.scrollHeader(),G&&(l.sbActive(!0),clearTimeout(U[0]),U[0]=setTimeout(()=>{l.sbActive(!1)},1500)),t)if(D.isBottom())l.html(x(F[t-1]).html());else for(var s=0;s<t;s++){var i=F[s].getBoundingClientRect().top;if(100<i&&i<150){i=x(F[P[0]>e&&0<s?s-1:s]).html();i!=P[1]&&(l.html(i),P[1]=i);break}}P[0]=e}),x(f).on("click",".sb-menu-btn",function(){var e=x(this).parent().find(".sb-menu"),t=x(e).sbActive();B.deactivateAll(),t||(x(e).sbActive(!0),B.deselectAll(),C&&(SBAdmin.open_popup=e))}),h&&(x(d).on("click",".sb-textarea",function(){k.addClass("sb-header-hidden"),x(this).find("textarea").focus(),D.isBottom()&&(D.scrollBottom(),setTimeout(()=>{D.scrollBottom()},200))}),x(d).on("focusout",".sb-textarea",function(){setTimeout(()=>{k.removeClass("sb-header-hidden")},300)}),x(d).on("click",".sb-submit",function(){u.blur()}),window.addEventListener("popstate",function(){D.chat_open&&D.open(!1)})),x(f).on("click",".sb-menu li",function(){x(this).parent().sbActive(!1)}),x(k).on("click","#load-more",function(){var e=new w;X+=30,console.log("set",$),e.setLoad(X),x(this).text(""),x(this).sbLoading(!0),x(this).attr("id",""),L().getFullConversation(D.conversation.id,e=>{x(this).sbLoading(!1),x(this).html('<i style="font-size:1.2rem" class="bi-arrow-up-circle"></i>'),x(this).attr("id","load-more"),D.loadUpdate(e.messages)},e.getLoad()),N<=e.getLoad()&&x(".load-more").hide()}),x(d).on("click",".sb-submit",function(){D.submit()}),x("body").on("click",".sb-chat-btn,.sb-responsive-close-btn,#sb-open-chat,.sb-open-chat",function(){D.open(!D.chat_open)}),x(k).on("click",".sb-dashboard-btn",function(){D.showDashboard(),r.find(" > .sb-panel-articles > .sb-article").length&&D.showArticles(),y("open-conversation",0),g=!1}),x("#template-form").on("submit",function(e){e.preventDefault();const t=(new Metatemplate).payload("#template-form");e={type:t.type,to:L().getExtra("phone").value,template_name:t.template_name,language:t.language,variables:t.variables};const s=x("#send-meta-template");s.sbLoading(!0),B.ajax({function:"whatsapp-send-meta-template",payload:e},e=>{s.sbLoading(!1),e?.error&&e.error.message?M.showErrorMessage(x(".sb-admin").find(".sb-send-template-box"),e.error.message):e&&(D.sendMessage(-1,`*~Registro de contacto*, {agent_name} 

 `+t.BodyTemplate,!1),D.showResponse(""+t.BodyTemplate),x(C?i:k).find(".sb-lightbox-media, .sb-lightbox-overlay, .sb-send-template-box").sbActive(!1))})}),B.get_select_setting(),x(k).on("click",".sb-user-conversations li",function(){D.openConversation(x(this).attr("data-conversation-id"))}),x(k).on("click",".sb-btn-new-conversation,.sb-departments-list > div,.sb-agents-list > div",function(){var e=x(this).data("id");B.null(e)||(x(this).parent().hasClass("sb-departments-list")?D.default_department=parseInt(e):D.default_agent=parseInt(e)),g="new-conversation",D.clear(),D.hideDashboard()}),x(k).on("click",".sb-btn-all-conversations",function(){k.find(".sb-dashboard-conversations").removeClass("sb-conversations-hidden")}),x(d).on("click",".bi-paperclip",function(){D.is_busy||(d.find(".sb-upload-files").val("").click(),d.find(".bi-arrow-up-circle-fill").removeClass("sb-hide"),console.log("to upload file"))}),x(d).on("click",".sb-attachments > div > i",function(e){return x(this).parent().remove(),""==u.val()&&0==d.find(".sb-attachments > div").length&&D.activateBar(!1),e.preventDefault(),!1}),x(d).on("change",".sb-upload-files",function(e){D.busy(!0),x(this).sbUploadFiles(function(e){D.uploadResponse(e)}),B.event("SBAttachments")}),x(i).on("dragover",function(e){x(this).addClass("sb-drag"),clearTimeout(_),e.preventDefault(),e.stopPropagation(),t()}),x(i).on("dragleave",function(e){_=setTimeout(()=>{x(this).removeClass("sb-drag"),t()},200),e.preventDefault(),e.stopPropagation()}),x(i).on("drop",function(e){var t=e.originalEvent.dataTransfer.files;if(e.preventDefault(),e.stopPropagation(),0<t.length)for(var s=0;s<t.length;++s){var i=new FormData;i.append("file",t[s]),B.upload(i,function(e){D.uploadResponse(e)})}return x(this).removeClass("sb-drag"),!1}),x(k).on("click",".sb-btn-all-articles:not([onclick])",function(){D.showArticles()}),x(k).on("click",".sb-articles > div:not(.sb-title)",function(){D.showArticles(x(this).attr("data-id"))}),x(k).on("click",".sb-dashboard-articles .sb-input-btn .sb-submit-articles",function(){D.searchArticles(x(this).parent().find("input").val(),this,x(this).parent().next())}),x(i).on("click",".sb-article [data-rating]",function(){D.articleRatingOnClick(this)}),x(f).on("click",".sb-rich-button a",function(e){var t=x(this).attr("href");if(0===t.indexOf("#")&&0===t.indexOf("#article-"))return D.showArticles(t.replace("#article-","")),e.preventDefault(),!1}),x(i).on("click",".sb-lightbox-media > i",function(){return i.find(".sb-lightbox-media").sbActive(!1),C&&(SBAdmin.open_popup=!1),!1}),x(k).on("click",".sb-image",function(){B.lightbox(x(this).html())}),x(k).on("click",".sb-slider-images .sb-card-img",function(){B.lightbox(`<img loading="lazy" src="${x(this).attr("data-value")}" />`)}),x(k).on("click",".sb-image",function(){B.lightbox(x(this).html())}),x(k).on("click",".sb-slider-images .sb-card-img",function(){B.lightbox(`<img loading="lazy" src="${x(this).attr("data-value")}" />`)}),x(document).on("SBConversationLoaded",function(){y("queue")&&D.queue(y("queue"))}),x(d).on("click",".bi-emoji-grin",function(){D.showEmoji(this)}),x(o).on("click",".sb-emoji-list li",function(e){D.insertEmoji(x(this).html()),h&&clearTimeout(_)}),x(o).find(".sb-emoji-list").on("touchend",function(e){_=setTimeout(()=>{D.mouseWheelEmoji(e)},50)}),x(o).find(".sb-emoji-list").on("mousewheel DOMMouseScroll",function(e){D.mouseWheelEmoji(e)}),x(o).find(".sb-emoji-list").on("touchstart",function(e){D.emoji_options.touch=e.originalEvent.touches[0].clientY},{passive:!0}),x(o).on("click",".sb-emoji-bar > div",function(){D.clickEmojiBar(this)}),x(o).on("click",".sb-select li",function(){D.categoryEmoji(x(this).data("value"))}),x(o).find(".sb-search-btn input").on("change keyup paste",function(){D.searchEmoji(x(this).val())}),x(u).on("keyup",function(){D.textareaChange(this)}),x(k).on("click",".sb-privacy .sb-approve",function(){y("privacy-approved",!0),x(this).closest(".sb-privacy").remove(),k.removeClass("sb-init-form-active"),a.find(" > div").css({opacity:1,top:0}),D.initChat(),b?SBTickets.showPanel("new-ticket"):D.isInitDashboard()||D.hideDashboard()}),x(k).on("click",".sb-privacy .sb-decline",function(){var e=x(this).closest(".sb-privacy");x(e).find(".sb-text").html(x(e).attr("data-decline")),x(e).find(".sb-decline").remove(),D.scrollBottom(!0)}),x(k).on("click",".sb-popup-message .bi-x-lg",function(){D.popup(!0)}),x(k).on("click",".sb-rich-message .sb-submit,.sb-rich-message .sb-select ul li",function(){var e=x(this).closest(".sb-rich-message");e[0].hasAttribute("disabled")||S.submit(e,e.attr("data-type"),this)}),x(k).on("click",".sb-rich-message .sb-input > span",function(){x(this).sbActive(!0),x(this).siblings().focus()}),x(k).on("focus focusout click",".sb-rich-message .sb-input input,.sb-rich-message .sb-input select",function(e){switch(e.type){case"focusin":case"focus":x(this).siblings().sbActive(!0);break;case"focusout":""==x(this).val()?x(this).siblings().sbActive(!1):x(this).siblings().addClass("sb-filled sb-active");break;case"click":x(this).siblings().removeClass("sb-filled")}}),x(k).on("click",".sb-slider-arrow",function(){S.sliderChange(x(this).closest("[id]").attr("id"),x(this).hasClass("bi-arrow-right-circle")?"right":"left")}),x(k).on("change",'.sb-rich-message [data-type="select"] select',function(){x(this).siblings().sbActive(!0)}),x(k).on("click",'[data-type="select-input"] > div',function(){x(this).prev().sbActive(!0),x(this).next().addClass("sb-focus")}),x(k).on("focusout",'[data-type="select-input"] input,[data-type="select-input"] select',function(){var e=x(this).closest(".sb-input");e.find('input[type="tel"]').val()+e.find("select").val()==""&&e.find("span").sbActive(!1),e.find(".sb-focus").removeClass("sb-focus")}),x(k).on("click",".sb-rich-registration .sb-login-area",function(){var e=k.hasClass("sb-init-form-active");x(this).closest(".sb-rich-registration").replaceWith(S.generate({},"login",e?"sb-init-form":"")),D.scrollBottom(e)}),x(k).on("click",".sb-rich-login .sb-registration-area",function(){var e;$["registration-link"]?document.location=$["registration-link"]:(e=k.hasClass("sb-init-form-active"),x(this).closest(".sb-rich-login").replaceWith(S.generate({},"registration",e?"sb-init-form":"")),D.scrollBottom(e))}),x(k).on("click",".sb-rich-login .sb-submit-login",function(){B.loginForm(this,!1,e=>{let t=x(this).closest(".sb-rich-login");var s;L(new I(e[0])),t.hasClass("sb-init-form")?(k.removeClass("sb-init-form-active"),t.remove(),g="open-conversation",D.initChat(),E.start(),D.isInitDashboard()||D.hideDashboard()):(t=t.closest("[data-id]"),e=D.conversation.getMessage(t.attr("data-id")),s=`${j("Logged in as")} *${L().name}*`,e.set("message",s),D.updateMessage(e.id,s),t.replaceWith(e.getCode()),E.started=!1,E.start())})}),x(f).on("click",".sb-social-buttons div",function(){B.openWindow(x(this).attr("data-link"))}),x(k).on("click",".sb-close-chat",function(){D.closeChat()}),x(i).on("click",".sb-search-btn > i",function(){let e=x(this).parent();var t=x(e).sbActive();t&&(setTimeout(()=>{x(e).find("input").val("")},50),setTimeout(()=>{x(e).find("input").trigger("change")},550)),x(e).sbActive(!t),x(e).find("input").focus(),i.find(".sb-select ul").sbActive(!1)}),x(i).on("click",".sb-select",function(){var e=x(this).find("ul"),t=e.hasClass("sb-active");x(i).find(".sb-select ul").sbActive(!1),e.setClass("sb-active",!t),C&&(SBAdmin.open_popup=!t&&this)}),x(i).on("click",".sb-select li",function(){var e=x(this).closest(".sb-select"),t=x(this).data("value"),s=x(e).find(`[data-value="${t}"]`);x(e).find("li").sbActive(!1),x(e).find("p").attr("data-value",t).html(x(s).html()),x(s).sbActive(!0)}),x(i).on("click",".sb-input-image .image",function(){e=x(this).parent(),d.find(".sb-upload-files").click()}),x(i).on("click",".sb-input-image .image > .bi-x-lg",function(e){return x(this).parent().removeAttr("data-value").css("background-image",""),e.preventDefault(),!1});x(i).on("click",'.sb-message.sb-location, .sb-message p a[href^="https://maps.google.com/"]',function(e){e.preventDefault();let t=x(this).closest(".sb-location").attr("data-location");var s,e=x(this).attr("href");t||(s=e.match(/\/\?q=([\d\.\-]+),([\d\.\-]+)/))&&3<=s.length&&(t=s[1]+","+s[2]),t?(s='<iframe src="https://maps.google.com/maps?q='+t+'&output=embed"></iframe>',x(this).closest(".sb-message").html(s)):window.open(e,"_blank")})}window.SBApps=R,x(document).ready(function(){if((k=x(".sb-admin, .sb-admin-start")).length)C=!0,Y();else{let e,i,t=!1;if(typeof SB_INIT_URL!=p)SB_INIT_URL.indexOf(".js")<0&&(SB_INIT_URL+="/js/min/main.js"+c),e=SB_INIT_URL;else for(var s=document.getElementsByTagName("script"),a=["init.js","main.js","min/init.min.js","min/main.js"],n=0;n<s.length;n++){var o=s[n].src;if("steambox"==s[n].id){e=o,t=t||e.includes("init.");break}for(var r=0;r<a.length;r++)if(o.includes("/c/js/"+a[r])){e=o,t=t||e.includes("init.");break}}var l=B.getURL(!1,e);if("url"in l&&(e=l.url),typeof SB_DISABLED==p||!SB_DISABLED)if(t)Y();else{(typeof SB_TICKETS!=p||"mode"in l&&"tickets"==l.mode)&&(b=!0,l.mode="tickets"),"cloud"in l&&(m=l.cloud);let s=e.lastIndexOf("main.js");l=(i=e.substr(0,0<e.lastIndexOf("main.js")?e.lastIndexOf("main.js")-4:s-8))+"/include/init.php"+("lang"in l?"?lang="+l.lang:"")+("mode"in l?"&mode="+l.mode:"")+(m?"&cloud="+m:"");B.cors("GET",l.replace(".php&",".php?"),e=>{let t="body";b&&x("#sb-tickets").length&&(t="#sb-tickets"),x(t).append(e),B.loadResource(i+"/css/"+(b?"tickets":"main")+".css"),b?x.getScript(i+"/apps/tickets/tickets"+(s?".min":"")+".js?v="+c,()=>{Y()}):Y()})}}})}(jQuery);var selectedSource="tk";function updateSource(e){selectedSource=e,console.log("Selected Source:",selectedSource)}let isSpeechSynthesisActive=!1,utterance=null;function readText(e){isSpeechSynthesisActive||((utterance=new SpeechSynthesisUtterance(e)).lang="es-US",utterance.rate=1,utterance.pitch=1.2,utterance.onstart=function(){isSpeechSynthesisActive=!0},utterance.onend=function(){isSpeechSynthesisActive=!1},window.speechSynthesis.speak(utterance))}$(document).on("click",'.sb-menu li[data-value="read-text"]',function(e){e.stopPropagation();e=$(this).closest(".sb-shadow-conversation").data("id");readText($('.sb-shadow-conversation[data-id="'+e+'"] .sb-message').text())}),window.addEventListener("beforeunload",function(e){window.speechSynthesis.cancel(),isSpeechSynthesisActive=!1}),$(document).on("click",function(e){window.speechSynthesis.cancel(),isSpeechSynthesisActive=!1});