"use strict";function showContent(){var e=document.getElementById("overlay"),t=document.documentElement;e.style.display="none",t.style.animation="fade-in .1s ease-in"}function initLoadingAnimation(){var e=document.getElementById("overlay");document.getElementById("loader");e.style.animation="load 1.6s ease-out",e.addEventListener("animationend",function(){showContent()})}function ExtraButton(){document.getElementById("CstBtn").classList.toggle("show")}!function(S){var d,s,y,q,_,P,O,z,H,u,p,V,o,l,h,r,g,f,b,W,X,v,e,m,J,x,Y,Z,Q,i,K,n,ee,w=[],te=!1,ae=!1,B=!1,ie=1,se=1,k={},ne=1,oe=1,C=S(window).width()<555,A={last:0,header:!0,always_hidden:!1},re="localhost"===location.hostname||"127.0.0.1"===location.hostname,le=new Date,ce=!1,a=!0,de=!1,ue="undefined",c=!1,pe=!1,t=!1,he=["Abierto","Presupuesto","Consulta","Contactado","Visitado","Calificado","Confirmado","Pendiente","Resuelto","Pagado","VIP","Descartado","NA"];function T(e,t=!1){var a=d.find(".sb-info-card");t?"error"===t?(a.addClass("sb-info-card-error"),i=setTimeout(()=>{a.sbActive(!1)},4e3)):"warning"===t?(a.addClass("sb-info-card-warning"),i=setTimeout(()=>{a.sbActive(!1)},3e3)):a.addClass("sb-info-card-info"):(a.removeClass("sb-info-card-error sb-info-card-warning sb-info-card-info"),clearTimeout(i),i=setTimeout(()=>{a.sbActive(!1)},1500)),a.html(`<h3>${E(e)}</h3>`).sbActive(!0)}function $(e){if(typeof e==ue)return window.sb_current_user;window.sb_current_user=e}function F(e,t,a=!1,i="",s="",n=!1){let o=d.find(".sb-dialog-box").attr("data-type",t);var r=o.find("p");o.attr("id",i).setClass("sb-scroll-area",n).css("height",n?parseInt(S(window).height())-200+"px":""),o.find(".sb-title").html(s),r.html(("alert"==t?'<strong style="font-size: var(--chat-text-size-1-1);color: var(--chat-text-primary">'+E("Are you sure?")+"</strong> ":"")+E(e)),o.sbActive(!0).css({"margin-top":o.outerHeight()/-2+"px","margin-left":o.outerWidth()/-2+"px"}),ee.sbActive(!0),K=a,setTimeout(()=>{G.open_popup=o},500)}function L(e=!1,t=!0){d.find(".sb-loading-global").sbActive(e),t&&(ee.sbActive(e),S("body").setClass("sb-lightbox-active",e))}function I(e){if(S(e).sbLoading())return 1;S(e).sbLoading(!0)}function E(e){return SB_TRANSLATIONS&&e in SB_TRANSLATIONS?SB_TRANSLATIONS[e]:e}function ge(e,t){var a=(e=S(e)).find("> div, > ul");a.css({height:"","max-height":""}),e.hasClass("sb-collapse")&&S(a).prop("scrollHeight")>t&&(e.sbActive(!0).attr("data-height",t),e.find(".bi-chevron-down").remove(),e.append(`<a class="sb-btn-text bi-chevron-down">${E("View more")}</a>`),a.css({height:t+"px","max-height":t+"px"}))}function fe(e,t){let a=S(e).parent().find("i"),i=S(e).val();a.sbLoading()||SBF.search(i,()=>{a.sbLoading(!0),t(i,a)})}function be(e,t=!1,a=0){if(t)return S(e).scrollTop()+S(e).innerHeight()>=S(e)[0].scrollHeight-1;S(e).scrollTop(S(e)[0].scrollHeight-a)}function ve(e){window.history.pushState("","",e)}function me(){return SB_ADMIN_SETTINGS.cloud?"&cloud="+SB_ADMIN_SETTINGS.cloud.token:""}function Se(e=!1){t||(!1===c?(c=!0,S.getScript(STMBX_URL+"/vendor/editorjs.js",()=>{Se(e)})):(ye(),t=!0,c=new EditorJS({data:"string"==typeof e?{time:Date.now(),blocks:[e?{id:"sb",type:"raw",data:{html:e}}:{id:"sb",type:"paragraph",data:{text:""}}]}:e,i18n:{messages:{ui:{blockTunes:{toggler:{"Click to tune":E("Click to tune")}},inlineToolbar:{converter:{"Convert to":E("Convert to")}},toolbar:{toolbox:{Add:E("Add")}}},toolNames:{Text:E("Text"),Heading:E("Heading"),List:E("List"),Image:E("Image"),Code:E("Code"),"Raw HTML":E("Raw HTML"),Bold:E("Bold"),Italic:E("Italic"),Link:E("Link")},tools:{list:{Ordered:E("Ordered"),Unordered:E("Unordered")}},blockTunes:{delete:{Delete:E("Delete")},moveUp:{"Move up":E("Move up")},moveDown:{"Move down":E("Move down")}}}},tools:{list:{class:List,inlineToolbar:!0},image:{class:ImageTool,config:{uploader:{uploadByFile(e){let a=new FormData;return a.append("file",e),new Promise(t=>{S.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:a,type:"POST",success:function(e){"success"==(e=JSON.parse(e))[0]?t({success:1,file:{url:e[1]}}):console.log(e)}})})}}}},header:Header,code:CodeTool,raw:RawTool},onReady:()=>{t=!1},minHeight:50})))}function ye(){typeof c.destroy!==ue&&(c.destroy(),c=!1)}S.fn.sbLanguageSwitcher=function(e=[],t="",a=!1){let i=`<div class="sb-language-switcher" data-source="${t}">`,s=[],n=S(this).hasClass("sb-language-switcher-cnt")?S(this):S(this).find(".sb-language-switcher-cnt");for(var o=0;o<e.length;o++)s.includes(e[o])||(i+=`<span ${a==e[o]?'class="sb-active" ':""}data-language="${e[o]}"><i class="bi-x-lg"></i><img src="${STMBX_URL}/media/flags/${e[o].toLowerCase()}.png" /></span>`,s.push(e[o]));return n.find(".sb-language-switcher").remove(),n.append(i+`<i data-sb-tooltip="${E("Add translation")}" class="bi-plus-lg"></i></div>`),n.sbInitTooltips(),this},S.fn.sbShowLightbox=function(e=!1,t=""){function a(){var e=S(this),t=e.outerHeight()/-2-25;e.css({"margin-top":t+"px","margin-left":e.outerWidth()/-2+"px"})}return d.find(".sb-lightbox").sbActive(!1),ee.sbActive(!0),S(this).sbActive(!0),e?S(this).addClass("sb-popup-lightbox").attr("data-action",t):(a.call(this),S(window).on("resize",function(){a.call(this)})),S("body").addClass("sb-lightbox-active"),setTimeout(()=>{G.open_popup=this},300),this.preventDefault,this};var M={dialogflow:{intents:!(S.fn.sbHideLightbox=function(){return S(this).find(".sb-lightbox,.sb-popup-lightbox").sbActive(!1).removeClass("sb-popup-lightbox").removeAttr("data-action"),ee.sbActive(!1),S("body").removeClass("sb-lightbox-active"),G.open_popup=!1,this}),token:SBF.storage("dialogflow-token"),smart_reply_data:!1,smartReply:function(e){SBF.ajax({function:"dialogflow-smart-reply",message:e,smart_reply_data:this.smart_reply_data||{conversation_id:SBChat.conversation.id},token:this.token,dialogflow_language:[$().language?$().language:"en"],language_detection:SB_ADMIN_SETTINGS["smart-reply-language-detection"]&&SBChat.conversation&&!SBChat.conversation.getLastUserMessage(!1,!0)&&(!SB_ADMIN_SETTINGS["smart-reply-language-detection-bot"]||!SBChat.conversation.getLastUserMessage(!1,"bot"))},e=>{var t=e.suggestions;let a="";var i=y.find(".sb-conversation .sb-list"),i=i[0].scrollTop===i[0].scrollHeight-i[0].offsetHeight,s=!(!SBChat.conversation||!SBChat.conversation.getLastMessage())&&SBChat.conversation.getLastMessage().message;e.token&&this.token!=e.token&&(this.token=e.token,SBF.storage("dialogflow-token",e.token));for(var n=0;n<t.length;n++)t[n]!=s&&(a+=`<span>${t[n]}</span>`);this.smart_reply_data=e.smart_reply,V.html(a),i&&SBChat.scrollBottom()})},smartReplyUpdate:function(e,t="agent"){SBF.ajax({function:"dialogflow-smart-reply-update",message:e,smart_reply_data:this.smart_reply_data||{conversation_id:SBChat.conversation.id},token:this.token,dialogflow_language:[$().language],user_type:t})},showCreateIntentBox:function(e){let t="";e=SBChat.conversation.getMessage(e);let a=e.message;if(SBF.isAgent(e.get("user_type")))t=0==(t=(t=SBChat.conversation.getLastUserMessage(e.get("index")))&&t.payload("sb-human-takeover")?SBChat.conversation.getLastUserMessage(t.get("index")):t)?"":t.message;else{t=a;for(var i=SBChat.conversation.messages,s=e.get("index");s<i.length;s++)if(["agent","admin"].includes(i[s].get("user_type"))){a=i[s].message;break}}!1===this.intents&&SBF.ajax({function:"dialogflow-get-intents"},e=>{let t="";if(Array.isArray(e)){for(var a=0;a<e.length;a++)t+=`<option value="${e[a].name}">${e[a].displayName}</option>`;p.find("#sb-intents-select").append(t),this.intents=e}else this.intents=[]}),p.attr("data-message-id",e.id),p.find(".sb-type-text:not(.sb-first)").remove(),p.find(".sb-type-text input").val(t),p.find("textarea").val(a),p.find("#sb-intents-select").val(""),p.find(".sb-search-btn").sbActive(!1).find("input").val(""),this.searchIntents(""),p.sbShowLightbox()},submitIntent:function(i){if(!I(i)){let e=[];var t=p.find("textarea").val();let a=p.find("#sb-intents-select").val();p.find(".sb-type-text input").each(function(){S(this).val()&&e.push(S(this).val())}),""==t&&!a||0==e.length?(SBForm.showErrorMessage(p,"Please insert the bot response and at least one user expression."),S(i).sbLoading(!1)):SBF.ajax({function:""==a?"dialogflow-create-intent":"dialogflow-update-intent",expressions:e,response:t,agent_language:p.find(".sb-dialogflow-languages select").val(),conversation_id:SBChat.conversation.id,intent_name:a},t=>{if(S(i).sbLoading(!1),!0===t)d.sbHideLightbox(),T(""==a?"Intent created":"Intent updated");else{let e="Error";"error"in t&&"message"in t.error&&(e=t.error.message),SBForm.showErrorMessage(p,e)}})}},searchIntents:function(l){l=l.toLowerCase(),SBF.search(l,()=>{var t=!(1<l.length);let a=t?`<option value="">${E("New Intent")}</option>`:"";for(var i=this.intents,s=0;s<i.length;s++){let e=t||i[s].displayName.toLowerCase().includes(l);if(!e&&"trainingPhrases"in i[s])for(var n=i[s].trainingPhrases,o=0;o<n.length;o++){for(var r=0;r<n[o].parts.length;r++)if(n[o].parts[r].text.toLowerCase().includes(l)){e=!0;break}if(e)break}e&&(a+=`<option value="${i[s].name}">${i[s].displayName}</option>`)}p.find("#sb-intents-select").html(a).change()})},previewIntent:function(e){let t="";for(var a=0;a<this.intents.length;a++)if(this.intents[a].name==e){var i="trainingPhrases"in this.intents[a]?this.intents[a].trainingPhrases:[],s=i.length;if(1<s){for(var n=0;n<s;n++)for(var o=0;o<i[n].parts.length&&(t+=`<span>${i[n].parts[o].text}</span>`,15!=o);o++);F(t,"info",!1,"intent-preview-box","",10<s)}break}},translate:function(e,t,a){e.length&&SBF.ajax({function:"google-translate",strings:e,language_code:t,token:this.token},e=>{if(this.token=e[1],!Array.isArray(e[0]))return SBF.error(JSON.stringify(e[0]),"SBApps.dialogflow.translate"),!1;a(e[0])})}},messenger:{check:function(e){return["fb","ig"].includes(e.get("source"))},send:function(e,t,a="",i=[],s,n=!1){SBF.ajax({function:"messenger-send-message",psid:e,facebook_page_id:t,message:a,attachments:i,metadata:s},e=>{n&&n(e)})}},whatsmeow:{check:function(e){return"ww"==e.get("source")},send:function(e,t="",a=[],i=!1,s=!1,n){SBF.ajax({function:"whatsmeow-send-message",to:e,message:t,attachments:a,phone_id:i},e=>{s&&s(e)})},activeUserPhone:function(e=$()){return!!e.getExtra("phone")&&e.getExtra("phone").value.replace("+","")}},waweb:{check:function(e){return"wx"==e.get("source")},send:function(e,t="",a=[],i=!1,s=!1,n){SBF.ajax({function:"waweb-send-message",to:e,message:t,attachments:a,phone_id:i},e=>{s&&s(e)})},activeUserPhone:function(e=$()){return!!e.getExtra("phone")&&e.getExtra("phone").value.replace("+","")}},whatsapp:{check:function(e){return"wa"==e.get("source")},send:function(e,t="",a=[],i=!1,s=!1){SBF.ajax({function:"whatsapp-send-message",to:e,message:t,attachments:a,phone_id:i},e=>{s&&s(e)})},activeUserPhone:function(e=$()){return!!e.getExtra("phone")&&e.getExtra("phone").value.replace("+","")}},telegram:{check:function(e){return"tg"==e.get("source")},send:function(e,t="",a=[],i=!1){SBF.ajax({function:"telegram-send-message",chat_id:e,message:t,attachments:a},e=>{i&&i(e)})}},gbm:{token:!1,check:function(e){return"bm"==e.get("source")},send:function(e,t="",a=[],i=!1){SBF.ajax({function:"gbm-send-message",google_conversation_id:e,message:t,attachments:a,token:this.token},e=>{i&&i(e),this.token=e[2]})}},twitter:{check:function(e){return"tw"==e.get("source")},send:function(e,t="",a=[],i=!1){SBF.ajax({function:"twitter-send-message",twitter_id:e,message:t,attachments:a},e=>{i&&i(e)})}},is:function(e){if(typeof SB_VERSIONS!=ue)switch(e){case"gbm":case"twitter":case"telegram":case"messenger":case"whatsapp":case"waweb":case"whatsmeow":case"dialogflow":case"sb":return!0}return!1}},R={init:!1,save:function(a){if(!I(a)){let o={},r={};switch(f.find(" > .sb-tab > .sb-nav .sb-active").attr("id")){case"tab-articles":this.articles.save(e=>{T(!0===e?"Articles and categories saved":e),S(a).sbLoading(!1)});break;case"tab-automations":let t=m.find(".sb-active").attr("data-id");R.automations.save(e=>{T(!0===e?"Automations saved":e),R.automations.populate(),m.find(`[data-id="${t}"]`).click(),S(a).sbLoading(!1)});break;case"tab-translations":this.translations.updateActive(),SBF.ajax({function:"save-translations",translations:JSON.stringify(this.translations.to_update)},()=>{T("Translations saved"),S(a).sbLoading(!1)});break;default:f.find(".sb-setting").each((e,t)=>{var a=this.get(t),i=S(t).data("setting");if(a[0])if(typeof i!=ue){let e=!1;if(S(t).find("[data-language]").length){var s=S(t).find("[data-language].sb-active");if(e=a[0]in this.translations.originals&&this.translations.originals[a[0]],this.translations.save(t,!!s.length&&s.attr("data-language")),e&&"string"!=typeof e)for(var n in e)e[n]=[e[n],a[1][n][1]]}i in o||(o[i]={}),o[i][a[0]]=[e||a[1],a[2]]}else r[a[0]]=[a[1],a[2]]}),SBF.ajax({function:"save-settings",settings:JSON.stringify(r),external_settings:o,external_settings_translations:this.translations.translations},()=>{T("Settings saved"),S(a).sbLoading(!1),setTimeout(()=>{location.reload()},600)})}}},initPlugins:function(){f.find("textarea").each(function(){S(this).autoExpandTextarea(),S(this).manualExpandTextarea()}),f.find("[data-setting] .sb-language-switcher-cnt").each(function(){S(this).sbLanguageSwitcher(R.translations.getLanguageCodes(S(this).closest("[data-setting]").attr("id")),"settings")})},initColorPicker:function(e=!1){S(e||f).find(".sb-type-color input").colorPicker({renderCallback:function(e,t){S(e.context).closest(".input").find("input").css("background-color",e.text)}})},initHTML:function(t){if("slack-agents"in t){let e="";for(var a in t["slack-agents"][0])e+=`<div data-id="${a}"><select><option value="${t["slack-agents"][0][a]}"></option></select></div>`;f.find("#slack-agents .input").html(e)}},get:function(n){var o=(n=S(n)).attr("id"),r=n.data("type");n.attr("value");switch(r){case"upload":case"range":case"number":case"text":case"password":case"color":return[o,n.find("input").val(),r];case"textarea":return[o,n.find("textarea").val(),r];case"select":return[o,n.find("select").val(),r];case"checkbox":return[o,n.find("input").is(":checked"),r];case"radio":let e=n.find("input:checked").val();return[o,e=SBF.null(e)?"":e,r];case"upload-image":let t=n.find(".image").attr("data-value");return[o,t=SBF.null(t)?"":t,r];case"multi-input":let a={};return n.find(".input > div").each((e,t)=>{t=this.get(t);t[0]&&(a[t[0]]=[t[1],t[2]])}),[o,a,r];case"select-images":return[o,n.find(".input > .sb-active").data("value"),r];case"repeater":return[o,this.repeater("get",n.find(".repeater-item"),""),r];case"double-select":let i={};return n.find(".input > div").each(function(){var e=S(this).find("select").val();-1!=e&&(i[S(this).attr("data-id")]=[e])}),[o,i,r];case"select-checkbox":return[o,n.find(".sb-select-checkbox input:checked").map(function(){return S(this).attr("id")}).get(),r];case"timetable":let s={};return n.find(".sb-timetable > [data-day]").each(function(){var e=S(this).attr("data-day");let a=[];S(this).find("> div > div").each(function(){var e=S(this).html(),t=S(this).attr("data-value");SBF.null(t)?a.push(["",""]):"closed"==t?a.push(["closed","Closed"]):a.push([t,e])}),s[e]=a}),[o,s,r];case"color-palette":return[o,n.attr("data-value"),r]}return["","",""]},set:function(e,t){var a=S(t)[1],i=S(t)[0];switch(e="#"+e,a){case"color":case"upload":case"number":case"text":case"password":f.find(e+" input").val(i);break;case"textarea":f.find(e+" textarea").val(i);break;case"select":f.find(e+" select").val(i);break;case"checkbox":f.find(e+" input").prop("checked","false"!=i&&i);break;case"radio":f.find(e+` input[value="${i}"]`).prop("checked",!0);break;case"upload-image":i&&f.find(e+" .image").attr("data-value",i).css("background-image",`url("${i}")`);break;case"multi-input":for(var s in i)this.set(s,i[s]);break;case"range":var n=i;f.find(e+" input").val(n),f.find(e+" .range-value").html(n);break;case"select-images":f.find(e+" .input > div").sbActive(!1),f.find(e+` .input > [data-value="${i}"]`).sbActive(!0);break;case"select-checkbox":for(var o=0;o<i.length;o++)f.find(`input[id="${i[o]}"]`).prop("checked",!0);f.find(e+" .sb-select-checkbox-input").val(i.join(", "));break;case"repeater":n=this.repeater("set",i,f.find(e+" .repeater-item:last-child"));n&&f.find(e+" .sb-repeater").html(n);break;case"double-select":for(var s in i)f.find(e+` .input > [data-id="${s}"] select`).val(i[s]);break;case"timetable":for(var s in i)for(var r=f.find(e+` [data-day="${s}"] > div > div`),o=0;o<r.length;o++)S(r[o]).attr("data-value",i[s][o][0]).html(i[s][o][1]);break;case"color-palette":i&&f.find(e).attr("data-value",i)}},repeater:function(e,t,a){if(a=S(a).html(),"set"==e){var i="";if(0<t.length){S(a).find(".bi-x-lg").remove();for(var s=0;s<t.length;s++){var n,o=S(S.parseHTML(`<div>${a}</div>`));for(n in t[s])this.setInput(o.find(`[data-id="${n}"]`),t[s][n]);i+=`<div class="repeater-item">${o.html()}<i class="bi-x-lg"></i></div>`}}return i}if("get"==e){let e=[],i=this;return S(t).each(function(){let t={},a=!0;S(this).find("[data-id]").each(function(){var e=i.getInput(this);a&&e&&"hidden"!=S(this).attr("type")&&"auto-id"!=S(this).attr("data-type")&&(a=!1),t[S(this).attr("data-id")]=e}),a||e.push(t)}),e}},repeaterAdd:function(e){let a=S(e).parent();(e=S(S.parseHTML(`<div>${a.find(".repeater-item:last-child").html()}</div>`))).find("[data-id]").each(function(){if(R.resetInput(this),"auto-id"==S(this).data("type")){let t=1;a.find('[data-type="auto-id"]').each(function(){var e=parseInt(S(this).val());e>t&&(t=e)}),S(this).attr("value",t+1)}}),a.find(".sb-repeater").append(`<div class="repeater-item">${e.html()}</div>`)},repeaterDelete:function(e){e=S(e).parent();1<e.parent().find(".repeater-item").length?e.remove():e.find("[data-id]").each((e,t)=>{this.resetInput(t)})},setInput:function(e,t){var a;t=S.trim(t),(e=S(e)).is("select")?e.find(`option[value="${t}"]`).attr("selected",""):e.is(":checkbox")&&t&&"false"!=t?e.attr("checked",""):e.is("textarea")?e.html(t):(a=e.is("div"))||e.is("i")||e.is("li")?(e.attr("data-value",t),a&&e.hasClass("image")&&e.css("background-image",t?`url("${t}")`:"")):e.attr("value",t)},getInput:function(e){var t;return(e=S(e)).is(":checkbox")?e.is(":checked"):e.is("div")||e.is("i")||e.is("li")?(t=e.attr("data-value"),SBF.null(t)?"":t):e.val()},resetInput:function(e){(e=S(e)).is("select")?e.val("").find("[selected]").removeAttr("selected"):e.is("checkbox")&&value?e.removeAttr("checked").prop("checked",!1):e.is("textarea")?e.html(""):e.removeAttr("value").removeAttr("style").removeAttr("data-value").val("")},getSettingObject:function(e){return S(e)[0].hasAttribute("data-setting")?S(e):S(e).closest("[data-setting]")},articles:{categories:[],articles:[],translations:{},get:function(t,e=!1,a=!0){SBF.ajax({function:"get-articles",categories:e,articles_language:"all",full:a},e=>{t(e)})},save:function(t=!1){if(this.updateActiveArticle(),c)if(pe)pe=!1;else if(this.activeID()&&-1!=this.activeID())return void(pe=t);b.find(".sb-new-category-cnt input").each((e,t)=>{var a=S.trim(S(t).val());a&&this.categories.push({id:SBF.random(),title:a}),S(t).parents().eq(1).remove()}),this.categories.length&&this.categories.sort(function(e,t){return e.title.localeCompare(t.title)}),SBF.ajax({function:"save-articles",articles:this.articles,translations:this.translations,categories:this.categories.length?this.categories:"delete_all"},e=>{b.find(".sb-menu-wide .sb-active").click(),b.find(`.sb-nav [data-id="${this.activeID()}"]`).click(),this.updateSelect(),t&&t(e)}),M.is("dialogflow")&&SBF.ajax({function:"dialogflow-knowledge",articles:this.articles})},show:function(e=!1,t=!1,a=!1){let i=[-1,"","","",""];this.updateActiveArticle(),this.hide(!1);var s=a?a in this.translations?this.translations[a]:[]:this.articles;!1===e&&(e=this.activeID());for(var n=0;n<s.length;n++)if(s[n].id==e){i=[e,s[n].title,s[n].content,s[n].link,SBF.null(s[n].categories)?[""]:s[n].categories,SBF.null(s[n].parent_category)?"":s[n].parent_category,s[n].editor_js],t&&(S(t).siblings().sbActive(!1),S(t).sbActive(!0));break}W.val(""),X.val(i[5]);for(n=0;n<i[4].length;n++)W.eq(n).val(i[4][n]);b.sbLanguageSwitcher(this.getTranslations(e),"articles",a),b.find(".sb-content").attr("data-id",i[0]),b.find(".sb-article-title input").val(i[1]),b.find(".sb-article-link input").val(i[3]),b.find("#sb-article-id").html(`ID <span>${i[0]}</span>`),c||b.find("#editorjs").length?Se(i[6]||i[2]):b.find(".sb-article-content textarea").val(i[2])},add:function(){var e=b.find(".sb-nav > ul"),t=SBF.random();this.updateActiveArticle(),this.articles.push({id:t,title:"",content:"",link:"",categories:[]}),this.hide(!1),e.find(".sb-active").sbActive(!1),e.find(".sb-no-results").remove(),e.append(`<li class="sb-active" data-id="${t}">${E("Article")} ${e.find("li").length+1}<i class="bi-trash"></i></li>`),b.find("input, textarea, select").val(""),b.find(".sb-content").attr("data-id",t),b.sbLanguageSwitcher([],"articles"),Se()},addCategory:function(){b.find('[data-type="categories"] .sb-no-results').remove(),b.find(".sb-new-category-cnt").append('<div class="sb-input-setting sb-type-text"><div><input type="text"></div></div>')},delete:function(e,t=!1){var a,i=S(e).closest(".sb-nav").find(" > ul"),s=S(e).parent(),n=s.attr("data-id");for(a in this[t?"categories":"articles"].splice(s.index(),1),this.hide(),1<i.find("li").length?S(e).parent().remove():i.html(`<li class="sb-no-results">${E("No results found.")}</li>`),this.translations)for(var o=0;o<this.translations[a].length;o++)this.translations[a][o].id===n&&this.translations[a].splice(o,1);t||ye()},populate:function(t=!1,a=!1){if(!1===t&&(t=a?this.categories:this.articles),Array.isArray(t)){let e="";if(a?this.categories=t:this.articles=t,t.length)for(var i=0;i<t.length;i++)e+=`<li data-id="${t[i].id}">${a?"<span>"+t[i].id+"</span>":""}${t[i].title}<i class="bi-trash${a?" sb-category":""}"></i></li>`;else e=`<li class="sb-no-results">${E("No results found.")}</li>`;b.find(".sb-add-category,.sb-new-category-cnt").sbActive(a),b.find(".sb-add-article").sbActive(!a),b.find(".sb-nav").attr("data-type",a?"categories":"articles"),b.find(".sb-nav > ul").html(e),this.hide()}else SBF.error(t,"SBSettings.articles.populate")},updateActiveArticle:function(){var a=this.activeID();if(-1!=a){var i=b.find(".sb-language-switcher [data-language].sb-active").attr("data-language");let t=i?i in this.translations?this.translations[i]:[]:this.articles,e=[];W.each(function(){S(this).val()&&e.push(S(this).val())});for(var s=0;s<t.length;s++)if(t[s].id==a){article={id:a,title:b.find(".sb-article-title input").val(),content:b.find(".sb-article-content textarea").val(),link:b.find(".sb-article-link input").val(),categories:e,parent_category:X.val()},c&&typeof c.save!==ue?c.save().then(e=>{article.editor_js=e,article.content=function(e){let t="";return e.map(e=>{switch(e.type){case"header":t+=`<h${e.data.level}>${e.data.text}</h${e.data.level}>`;break;case"paragraph":t+=`<p>${e.data.text}</p>`;break;case"image":t+=`<img class="img-fluid" src="${e.data.file.url}" title="${e.data.caption}" /><em>${e.data.caption}</em>`;break;case"list":t+='<ul class="sb-ul-'+e.data.style+'">',e.data.items.forEach(function(e){t+=`<li>${e}</li>`}),t+="</ul>";break;case"code":t+=`<code>${e.data.code}</code>`;break;case"raw":t+=`<div class="bxc-raw-html">${e.data.html}</div>`}}),t}(e.blocks),t[s]=article,pe&&this.save(pe)}).catch(e=>{console.log(e)}):t[s]=article,SBF.null(article.title)&&this.delete(b.find(`.sb-nav [data-id="${a}"] i`));break}}},updateSelect:function(){let e=[];var t=X.val();let a='<option value=""></option>';W.each(function(){e.push(S(this).val())});for(var i=0;i<this.categories.length;i++)a+=`<option value="${this.categories[i].id}">${this.categories[i].title}</option>`;W.html(a),X.html(a),X.val(t);for(i=0;i<e.length;i++)W.eq(i).val(e[i])},addTranslation:function(e=!1,t){if(!1===e&&(e=this.activeID()),this.getTranslations(e).includes(e))return console.warn("Article translation already in array.");t in this.translations||(this.translations[t]=[]),this.translations[t].push({id:e,title:"",content:"",link:"",categories:[]})},getTranslations:function(e=!1){var t,a=[];for(t in!1===e&&(e=this.activeID()),this.translations)for(var i=this.translations[t],s=0;s<i.length;s++)if(i[s].id==e){a.push(t);break}return a},deleteTranslation:function(e=!1,t){if(!1===e&&(e=this.activeID()),t in this.translations)for(var a=this.translations[t],i=0;i<a.length;i++)if(a[i].id==e)return this.translations[t].splice(i,1),!0;return!1},activeID:function(){return b.find(".sb-content").attr("data-id")},hide:function(e=!0){b.find(".sb-content").setClass("sb-hide",e)}},automations:{items:{messages:[],emails:[],sms:[],popups:[],design:[],more:[]},translations:{},conditions:{datetime:["Date time",["Is between","Is exactly"],"dd/mm/yyy hh:mm - dd/mm/yyy hh:mm"],repeat:["Repeat",["Every day","Every week","Every month","Every year"]],browsing_time:["Browsing time",[],"seconds"],scroll_position:["Scroll position",[],"px"],include_urls:["Include URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],exclude_urls:["Exclude URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],referring:["Referring URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],user_type:["User type",["Is visitor","Is lead","Is user","Is not visitor","Is not lead","Is not user"]],returning_visitor:["Returning visitor",["First time visitor","Returning visitor"]],countries:["Countries",[],"Country codes separated by commas"],languages:["Languages",[],"Language codes separated by commas"],cities:["Cities",[],"Cities separated by commas"],custom_variable:["Custom variable",[],"variable=value"]},get:function(t){SBF.ajax({function:"automations-get"},e=>{this.items=e[0],this.translations=Array.isArray(e[1])&&!e[1].length?{}:e[1],t(e)})},save:function(t=!1){this.updateActiveItem(),SBF.ajax({function:"automations-save",automations:this.items,translations:this.translations},e=>{t&&t(e)})},show:function(e=!1,t=!1){this.updateActiveItem();var a=t?t in this.translations?this.translations[t]:[]:this.items,i=v.find(" > .sb-tab > .sb-content");for(r in!1===e&&(e=this.activeID()),this.hide(!1),a)for(var s=0;s<a[r].length;s++){var n=a[r][s],o=n.conditions;if(n.id==e){for(var r in J.html(""),n){var l=i.find(`[data-id="${r}"]`);l.hasClass("image")?(l.css("background-image",`url(${n[r]})`).attr("data-value",n[r]),""==n[r]&&l.removeAttr("data-value")):"checkbox"==l.attr("type")?l.prop("checked",n[r]):l.val(n[r])}if(o)for(var r in o){this.addCondition();var c=J.find(" > div:last-child");c.find("select").val(o[r][0]),this.updateCondition(c.find("select")),c.find(" > div").eq(1).find("select,input").val(o[r][1]),2<o[r].length&&c.find(" > div").eq(2).find("input").val(o[r][2])}return J.parent().setClass("sb-hide",t),i.sbLanguageSwitcher(this.getTranslations(e),"automations",t),!0}}return!1},add:function(){var e=SBF.random(),t=E("Item")+" "+(m.find("li:not(.sb-no-results)").length+1);this.updateActiveItem(),this.items[this.activeType()].push(this.itemArray(this.activeType(),e,t)),this.hide(!1),m.find(".sb-active").sbActive(!1),m.find(".sb-no-results").remove(),m.append(`<li class="sb-active" data-id="${e}">${t}<i class="bi-trash"></i></li>`),v.find(".sb-automation-values").find("input, textarea").val(""),v.sbLanguageSwitcher([],"automations"),J.html("")},delete:function(e){this.items[this.activeType()].splice(S(e).parent().index(),1),S(e).parent().remove(),this.hide(),0==this.items[this.activeType()].length&&m.html(`<li class="sb-no-results">${E("No results found.")}</li>`)},populate:function(e=!1){!1===e&&(e=this.activeType());let t="";var a=this.items[e];if(this.updateActiveItem(),a.length)for(var i=0;i<a.length;i++)t+=`<li data-id="${a[i].id}">${a[i].name}<i class="bi-trash"></i></li>`;else t=`<li class="sb-no-results">${E("No results found.")}</li>`;switch(m.html(t),t="",e){case"emails":t=`<h2>${E("Subject")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="subject" type="text"></div></div>`;break;case"popups":t=`<h2>${E("Title")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="title" type="text"></div></div><h2>${E("Profile image")}</h2><div data-type="upload-image" class="sb-input-setting sb-type-upload-image"><div class="input"><div data-id="profile_image" class="image"><i class="bi-x-lg"></i></div></div></div><h2>${E("Message fallback")}</h2><div class="sb-input-setting sb-type-checkbox"><div><input data-id="fallback" type="checkbox"></div></div>`;break;case"design":t=`<h2>${E("Header title")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="title" type="text"></div></div>`;for(i=1;i<4;i++)t+=`<h2>${E((1==i?"Primary":2==i?"Secondary":"Tertiary")+" color")}</h2><div data-type="color" class="sb-input-setting sb-type-color"><div class="input"><input data-id="color_${i}" type="text"><i class="sb-close bi-x-lg"></i></div></div>`;for(i=1;i<4;i++)t+=`<h2>${E(1==i?"Header background image":2==i?"Header brand image":"Chat button icon")}</h2><div data-type="upload-image" class="sb-input-setting sb-type-upload-image"><div class="input"><div data-id="${1==i?"background":2==i?"brand":"icon"}" class="image"><i class="bi-x-lg"></i></div></div></div>`;break;case"more":t=`<h2>${E("Department ID")}</h2><div class="sb-input-setting sb-type-number"><div><input data-id="department" type="number"></div></div><h2>${E("Agent ID")}</h2><div class="sb-input-setting sb-type-number"><div><input data-id="agent" type="number"></div></div><h2>${E("Tags")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="tags" type="text"></div></div>`}v.find(".sb-automation-extra").html(t),v.attr("data-automation-type",e),R.initColorPicker(v),this.hide()},updateActiveItem:function(){var e=this.activeID();if(e){var a=v.find(".sb-language-switcher [data-language].sb-active").attr("data-language"),i=this.activeType();let t=a?a in this.translations?this.translations[a][i]:[]:this.items[i];for(var s=J.find(" > div"),n=0;n<t.length;n++)if(t[n].id==e){t[n]={id:e,conditions:[]},v.find(".sb-automation-values").find('input,textarea,[data-type="upload-image"] .image').each(function(){t[n][S(this).attr("data-id")]=S(this).hasClass("image")&&S(this)[0].hasAttribute("data-value")?S(this).attr("data-value"):"checkbox"==S(this).attr("type")?S(this).is(":checked"):S(this).val()}),s.each(function(){let e=[];S(this).find("input,select").each(function(){e.push(S(this).val())}),e[0]&&e[1]&&(2==e.length||e[2])&&t[n].conditions.push(e)}),SBF.null(t[n].name)&&this.delete(m.find(`[data-id="${e}"] i`));break}}},addCondition:function(){J.append(`<div><div class="sb-input-setting sb-type-select sb-condition-1"><select>${this.getAvailableConditions()}</select></div></div>`)},updateCondition:function(t){S(t).parent().siblings().remove();var a=S(t).parents().eq(1);if(S(t).val()){var i=this.conditions[S(t).val()];let e="";if(i[1].length){e='<div class="sb-input-setting sb-type-select sb-condition-2"><select>';for(var s=0;s<i[1].length;s++)e+=`<option value="${SBF.stringToSlug(i[1][s])}">${E(i[1][s])}</option>`;e+="</select></div>"}a.append(e+(2<i.length?`<div class="sb-input-setting sb-type-text"><input placeholder="${E(i[2])}" type="text"></div>`:"")),a.siblings().find(".sb-condition-1 select").each(function(){var e=S(this).val();S(this).html(R.automations.getAvailableConditions(e)),S(this).val(e)})}else a.remove()},getAvailableConditions:function(e=""){let t='<option value=""></option>',a=[];for(var i in J.find(".sb-condition-1 select").each(function(){a.push(S(this).val())}),this.conditions)a.includes(i)&&i!=e||(t+=`<option value="${i}">${E(this.conditions[i][0])}</option>`);return t},addTranslation:function(e=!1,t=!1,a){if(!1===e&&(e=this.activeID()),!1===t&&(t=this.activeType()),this.getTranslations(e).includes(e))return console.warn("Automation translation already in array.");a in this.translations||(this.translations[a]={messages:[],emails:[],sms:[],popups:[],design:[]}),t in this.translations[a]||(this.translations[a][t]=[]),this.translations[a][t].push(this.itemArray(t,e))},getTranslations:function(e=!1){var t,a=[];for(t in!1===e&&(e=this.activeID()),this.translations){var i,s=this.translations[t];for(i in s)for(var n=s[i],o=0;o<n.length;o++)if(n[o].id==e){a.push(t);break}}return a},deleteTranslation:function(e=!1,t){if(!1===e&&(e=this.activeID()),t in this.translations){var a,i=this.translations[t];for(a in i)for(var s=i[a],n=0;n<s.length;n++)if(s[n].id==e)return this.translations[t][a].splice(n,1),!0}return!1},activeID:function(){var e=m.find(".sb-active");return!!e.length&&e.attr("data-id")},activeType:function(){return e.find("li.sb-active").data("value")},itemArray:function(e,t,a="",i=""){return S.extend({id:t,name:a,message:i},"emails"==e?{subject:""}:"popups"==e?{title:"",profile_image:""}:"design"==e?{title:"",color_1:"",color_2:"",color_3:"",background:"",brand:"",icon:""}:{})},hide:function(e=!0){v.find(" > .sb-tab > .sb-content").setClass("sb-hide",e)}},translations:{translations:{},originals:{},to_update:{},add:function(e){var t=R.getSettingObject(Q),a=t.attr("id"),i=Q.find("[data-language].sb-active");this.save(t,!!i.length&&i.attr("data-language")),t.find('textarea,input[type="text"]').val(""),this.save(t,e),Q.remove(),t.sbLanguageSwitcher(this.getLanguageCodes(a),"settings",e)},delete:function(e,t){var a=(e=R.getSettingObject(e)).attr("id");delete this.translations[t][a],e.find(`.sb-language-switcher [data-language="${t}"]`).remove(),this.activate(e)},activate:function(e,t=!1){var a=(e=R.getSettingObject(e)).attr("id"),i=(t?this.translations[t]:this.originals)[a];if("string"==typeof i)e.find("input, textarea").val(i);else for(var s in i)e.find("#"+s).find("input, textarea").val("string"==typeof i[s]?i[s]:i[s][0])},updateActive:function(){var e=f.find(".sb-translations-list");let a={front:{},admin:{},"admin/js":{},"admin/settings":{}};var t=e.attr("data-value");if(!SBF.null(t)){for(var i in a)e.find(' > [data-area="'+i+'"] .sb-input-setting:not(.sb-new-translation)').each(function(){a[i][S(this).find("label").html()]=S(this).find("input").val()}),e.find('> [data-area="'+i+'"] .sb-new-translation').each(function(){var e=S(this).find("input:first-child").val(),t=S(this).find("input:last-child").val();e&&t&&(a[i][e]=t)});this.to_update[t]=a}},save:function(e,t=!1){e=R.getSettingObject(e);let a={};var i=S(e).attr("id");"multi-input"==e.data("type")?e.find(".multi-input-textarea,.multi-input-text").each(function(){a[S(this).attr("id")]=S(this).find("input, textarea").val()}):a=e.find("input, textarea").val(),t?(t in this.translations||(this.translations[t]={}),this.translations[t][i]=a):this.originals[i]=a},load:function(o){let r=f.find(".sb-translations > .sb-content");r.find(" > .sb-hide").removeClass("sb-hide"),this.updateActive(),SBF.ajax({function:"get-translation",language_code:o},e=>{o in this.to_update&&(e=this.to_update[o]);let t="";for(var a=["front","admin","admin/js","admin/settings"],i=0;i<a.length;i++){var s,n=e[a[i]];for(s in t+=`<div${i?"":' class="sb-active"'} data-area="${a[i]}">`,n)t+=`<div class="sb-input-setting sb-type-text"><label>${s}</label><div><input type="text" value="${n[s]}"></div></div>`;t+="</div>"}r.find(".sb-translations-list").attr("data-value",o).html(t),r.find(".sb-menu-wide li").sbActive(!1).eq(0).sbActive(!0),r.sbLoading(!1)}),r.sbLoading(!0)},getLanguageCodes:function(e){var t,a=[];for(t in this.translations)e in this.translations[t]&&a.push(t);return a}}},N={chart:!1,active_report:!1,initChart:function(e,t="line",n=1){let o=[];var a,i=[],s=["#0eacb2","#299fb1","#4492b0","#5d86ae","#7379ac","#867cae","#9b70ad","#b06bae","#c465af","#d65fb1"];for(a in e)o.push(e[a][0]),i.push(a);if("line"!=t&&6<o.length)for(var r=0;r<o.length;r++)s.push("hsl(210, "+Math.floor(100*Math.random())+"%, "+Math.floor(100*Math.random())+"%)");this.chart&&this.chart.destroy(),this.chart=new Chart(x.find("canvas"),{type:t,data:{labels:i,datasets:[{data:o,backgroundColor:"line"==t?"#d4e7e952":s,borderColor:"line"==t?"#5c00ff":s,borderWidth:1}]},options:{legend:{display:!1},scales:{yAxes:[{ticks:{callback:function(e,t,a){return 1!=n&&2==n?new Date(1e3*e).toISOString().substr(11,8):e},beginAtZero:!0}}],xAxes:[{ticks:{beginAtZero:!0}}]},tooltips:{callbacks:{label:function(e,t){var a=e.index,i=t.datasets[0].data[a];switch(n){case 1:return i;case 2:return new Date(1e3*o[a]).toISOString().substr(11,8);case 3:return i+"%";case 4:var s=x.find(".sb-table tbody tr").eq(a).find("td");return s.eq(0).text()+" "+s.eq(1).text()}}},displayColors:!1}}})},initTable:function(e,t,a=!1){let i="<thead><tr>";for(var s,n=t[Object.keys(t)[0]].length-1,o=[],r=0;r<e.length;r++)i+=`<th>${e[r]}</th>`;for(s in i+="</tr></thead><tbody>",t)0!=t[s][n]&&o.push([s,t[s][n]]);a&&o.reverse();for(r=0;r<o.length;r++)i+=`<tr><td><div>${o[r][0]}</div></td><td>${o[r][1]}</td></tr>`;i+="</tbody>",x.find("table").html(i)},initReport:function(e=!1,t=!1){let n=x.find(".sb-tab > .sb-content");t=SBF.null(t)?[!1,!1]:t.split(" - "),n.sbLoading(!0),e&&(this.active_report=e),this.active_report&&this.getData(this.active_report,t[0],t[1],s=>{0==s?n.addClass("sb-no-results-active"):(n.removeClass("sb-no-results-active"),"status-client"==this.active_report?(n.addClass("sb-results-active"),n.find("#"+this.active_report).attr("style","display:block!important"),n.find(".sb-reports-tags .sb-tags").html(""),he.forEach(e=>{let t=e;e=s.data.filter(e=>e.label==t);let i="";e.map(t=>{let a="";s.extra.map(e=>{e.user_id==t.user_id&&(a+=`<li class="add-user agent-name-tags">${e.first_name}</li>`)}),i+=`<div class="sb-responsive-tags">${t.first_name} ${t.last_name}<section class="flex-agents">${a}</section></div>`});var a=S('<div style="min-width: 180px;max-width: 554px;" class="sb-tags-details sb-hide"></div>');""!==i.trim()&&a.removeClass("sb-hide"),a.append(`<div>
								<h4 class="title-tags tags-${t}">
									<div>
										<i class="sb-icon bi-kanban-fill tags-${t}"></i>
									</div>
									<div class="white-title-elements">
										${t.toUpperCase()}(${e.length})
									</div>
									<div>
										<div class="arrow-down-tags white-title-elements">
											<i class="bi-check-lg"></i>
										</div>
									</div>
								</h4>
							</div>
							<div style="overflow: scroll;max-height: 420px;">${i}</div>`),n.find(".sb-reports-tags .sb-tags").append(a)})):(n.removeClass("sb-results-active"),n.find("#status-client").attr("style","display:none!important")),s.chart_type&&(this.initChart(s.data,s.chart_type,s.label_type),this.initTable(s.table,s.data,s["table-inverse"])),x.find(".sb-reports-title").html(s.title),x.find(".sb-reports-text").html(s.description),x.find(".bi-chevron-down").remove(),C||ge(x.find(".sb-collapse"),x.find("canvas").outerHeight()-135)),n.sbLoading(!1)})},getData:function(e,t=!1,a=!1,i){SBF.ajax({function:"reports",name:e,date_start:t,date_end:a},e=>{i(e)})},initDatePicker:function(){var e={ranges:{},applyClass:"reports-datepicker",locale:{format:"DD/MM/YYYY",separator:" - ",applyClass:"reports-datepicker",applyLabel:E("Apply"),cancelLabel:E("Cancel"),fromLabel:E("From"),toLabel:E("To"),weekLabel:E("W"),daysOfWeek:[E("Su"),E("Mo"),E("Tu"),E("We"),E("Th"),E("Fr"),E("Sa")],monthNames:[E("January"),E("February"),E("March"),E("April"),E("May"),E("June"),E("July"),E("August"),E("September"),E("October"),E("November"),E("December")],firstDay:1},showCustomRangeLabel:!1,alwaysShowCalendars:!0,autoApply:!0};e.ranges[E("Today")]=[moment(),moment()],e.ranges[E("Yesterday")]=[moment().subtract(1,"days"),moment().subtract(1,"days")],e.ranges[E("Last 3 Days")]=[moment().subtract(2,"days"),moment()],e.ranges[E("Last 5 Days")]=[moment().subtract(4,"days"),moment()],e.ranges[E("Last 7 Days")]=[moment().subtract(6,"days"),moment()],e.ranges[E("Last 15 Days")]=[moment().subtract(14,"days"),moment()],e.ranges[E("This Month")]=[moment().startOf("month"),moment().endOf("month")],x.find("#sb-date-picker").daterangepicker(e).val("")}},D={real_time:null,datetime_last_user:"2000-01-01 00:00:00",sorting:["creation_time","DESC"],user_types:["visitor","lead","user"],user_main_fields:["id","first_name","last_name","email","password","profile_image","user_type","creation_time","token","last_activity","department"],search_query:"",init:!1,busy:!1,table_extra:!1,history:[],filter:function(e){this.user_types=e="all"==e?["visitor","lead","user"]:"agent"==e?["agent","admin"]:[e],this.loading(),oe=ne=1;var t="online"==e[0]?["get-online-users",SB_ACTIVE_AGENT.id,this.sorting[0]]:["get-users",-1,this.sorting];SBF.ajax({function:t[0],sorting:t[2],user_types:e,search:this.search_query,extra:this.table_extra},e=>{this.populate(e),this.loading(!1)})},sort:function(e,t="DESC"){this.sorting=[e,t],this.loading(),oe=ne=1,SBF.ajax({function:"get-users",sorting:this.sorting,user_types:this.user_types,search:this.search_query,extra:this.table_extra},e=>{this.populate(e),this.loading(!1),console.log("Sorting completed successfully:",e)})},search:function(e){fe(e,(t,a)=>{oe=ne=1,SBF.ajax({function:1<t.length?"search-users":"get-users",search:t,user_types:this.user_types,sorting:this.sorting,extra:this.table_extra},e=>{this.user_types=["lead"],this.populate(e),this.search_query=t,S(a).sbLoading(!1),h.find("li").sbActive(!1).eq(0).sbActive(!0)})})},populate:function(e){let t="";var a=e.length;if(a)for(var i=0;i<a;i++)t+=this.getRow(new SBUser(e[i],e[i].extra));else t=`<p class="sb-no-results">${E("No users found.")}</p>`;l.parent().scrollTop(0),l.find("tbody").html(t),this.user_types.includes("agent")&&SBF.ajax({function:"get-online-users",agents:!0},e=>{let t=[];for(var a=0;a<e.length;a++)t.push(e[a].id);l.find("[data-user-id]").each(function(){S(this).find(".sb-td-profile").addClass("sb-"+(t.includes(S(this).attr("data-user-id"))?"online":"offline"))})})},update:function(){if(!this.busy){let n=["user","visitor","lead","agent"],o=n.includes(this.user_types[0])&&""==this.search_query,r=h.find(".sb-active").data("type");"online"==r?this.filter(r):(this.busy=!0,SBF.ajax({function:"get-new-users",datetime:this.datetime_last_user},t=>{var a=t.length;if(this.busy=!1,0<a){let e="";for(var i=0;i<a;i++){var s=new SBUser(t[i]);k[s.id]=s,this.updateMenu("add",s.type),o&&(e+=this.getRow(s))}if(o&&(l.find("tbody").prepend(e),n.includes(r))){let e="";for(i=0;i<n.length;i++)e+=n[i]==r?"":`[data-user-type="${n[i]}"],`;l.find(e.slice(0,-1)).remove()}this.datetime_last_user=t[0].creation_time}}))}},getRow:function(t,e){if(t instanceof SBUser){let e="";for(var a=0;a<this.table_extra.length;a++){var i=this.table_extra[a];e+=`<td class="sb-td-${i}">${this.user_main_fields.includes(i)?t.get(i):t.getExtra(i)}</td>`}return`<tr data-user-id="${t.id}" data-user-type="${t.type}"><td><input type="checkbox" /></td><td class="sb-td-profile"><a class="sb-profile"><img loading="lazy" src="${t.image}" class="sb-tags tags-${t.details.label}" style="max-width: 27px;max-height: 27px;padding: 2px;border:none;" /><span style="margin:0px 1px">${25<t.name.length?t.name.slice(0,25)+"...":t.name}</span></a></td>${e}<td style="overflow: hidden;max-width: 80px;text-overflow: ellipsis;overflow-wrap: break-word;" class="sb-td-email"class="sb-td-email">${t.get("email")}</td><td class="sb-td-ut">${E(t.type)}</td><td>${SBF.beautifyTime(t.get("last_activity"),!0)}</td><td>${SBF.beautifyTime(t.get("creation_time"),!0)}</td></tr>`}return SBF.error("User not of type SBUser","SBUsers.getRow"),!1},updateRow:function(e){var t,a,i=l.find(`[data-user-id="${e.id}"]`);i.length?(t=h.find(".sb-active").data("type"))===e.type||"admin"===e.type&&"agent"===t||"all"===t?(t=this.getRow(e),i.replaceWith(t),this.updateTagsLabel(e)):(t=d.find(`[data-type="${"admin"===e.type?"agent":e.type}"] span`),a=parseInt(t.attr("data-count")),t.html(a+1).attr("data-count",a+1),i.remove()):l.find("tbody").append(this.getRow(e))},updateTagsLabel:function(e){S(`[data-user-id="${e.id}"] .sb-tags`).removeClass().addClass("sb-tags tags-"+e.details.label)},updateMenu:function(e="all",t=!1){let a=["all","user","agent","lead","visitor"];"all"==e?SBF.ajax({function:"count-users"},e=>{for(var t=0;t<a.length;t++)this.updateMenuItem("set",a[t],e[a[t]])}):this.updateMenuItem(e,t)},updateMenuItem:function(e="set",t=!1,a=1){var t=h.find(`[data-type="${t}"] span`),i=["user","lead","visitor","agent"];"set"!==e&&(a=parseInt(t.attr("data-count"))+("add"===e?1:-1)),t.html(`<span style="vertical-align: sub;color: var(--chat-text-primary); font-weight:bold;">(${a})</span>`).attr("data-count",a);for(let e=a=0;e<i.length;e++)a+=parseInt(h.find(`[data-type="${i[e]}"] span`).attr("data-count"));h.find('[data-type="all"] span').html(`<span style="vertical-align: sub;color: var(--color-red); font-weight:bold;">(${a})</span>`).attr("data-count",a)},delete:function(t){this.loading(),Array.isArray(t)?SBF.ajax({function:"delete-users",user_ids:t},()=>{for(var e=0;e<t.length;e++)delete k[t[e]],l.find(`[data-user-id="${t[e]}"]`).remove(),_.find(`[data-user-id="${t[e]}"]`).remove();0==l.find("[data-user-id]").length&&this.filter(h.find(".sb-active").data("type")),T("Users deleted"),this.updateMenu(),this.loading(!1)}):k[t].delete(()=>{var e=_.find(`[data-user-id="${t}"]`);$().id==t&&$(!1),e.sbActive()&&(SBChat.conversation=!1,setTimeout(()=>{U.clickFirst()},300)),delete k[t],l.find(`[data-user-id="${t}"]`).remove(),e.remove(),d.sbHideLightbox(),T("User deleted"),this.updateMenu(),this.loading(!1)})},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update()},1e4))},stopRealTime:function(){clearInterval(this.real_time)},loading:function(e=!0){var t=o.find(".sb-loading-table");e?t.sbActive(!0):t.sbActive(!1)},csv:function(){SBF.ajax({function:"csv-users"},e=>{var e=JSON.parse(e),t=atob(e.file),t=new Blob([t],{type:"data:application/octet-stream;base64"}),a=document.createElement("a");a.href=window.URL.createObjectURL(t),a.download=e.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a)})},updateUsersActivity:function(){SBF.updateUsersActivity(a?SB_ACTIVE_AGENT.id:-1,$()?$().id:-1,function(e){D.setActiveUserStatus("online"==e)})},setActiveAgentStatus:function(e=!0){var t=e?"online":"offline";a=e,s.find('[data-value="status"]').html(E(SBF.slugToString(t))).attr("class","sb-"+t),SBPusher.active&&(e?SBPusher.presence():SBPusher.presenceUnsubscribe()),SB_ADMIN_SETTINGS.reports_disabled||SBF.ajax({function:"reports-update",name:t})},setActiveUserStatus:function(e=!0){var t=y.find(".sb-conversation .sb-top > .sb-labels");t.find(".sb-status-online").remove(),e&&t.prepend(`<span class="sb-status-online">${E("Online")}</span>`),SBChat.user_online=e},onlineUserNotification:function(e){var t,a,i=SB_ADMIN_SETTINGS["online-users-notification"];i&&(t=e.info.first_name+" "+e.info.last_name,a=this.userProfileImage(e.info.profile_image),SB_ADMIN_SETTINGS["push-notifications"]&&"id"in e.info&&!this.history.includes(e.info.id)?SBF.ajax({function:"push-notification",title:i,message:t,icon:a,interests:SB_ACTIVE_AGENT.id,user_id:e.info.id}):U.desktop_notifications&&SBChat.desktopNotification(i,t,a,!1,e.info.id),this.history.push(e.info.id))},userProfileImage:function(e){return!e||e.indexOf("user.svg")?SB_ADMIN_SETTINGS["notifications-icon"]:e}},U={real_time:null,datetime_last_conversation:"2000-01-01 00:00:00",user_typing:!1,desktop_notifications:!1,flash_notifications:!1,busy:!1,is_search:!1,menu_count_ajax:!1,chat_tops:[{}],open:function(e=-1,t){-1!=e&&this.openConversation(e,t),d.sbHideLightbox(),s.find(".sb-admin-nav a").sbActive(!1).parent().find("#sb-conversations").sbActive(!0),d.find(" > main > div").sbActive(!1),y.sbActive(!0).find(".sb-board").removeClass("sb-no-conversation"),this.startRealTime()},openConversation:function(t,e=!1,b=!0){if(!1===e&&t)SBF.ajax({function:"get-user-from-conversation",conversation_id:t},e=>{SBF.null(e.id)?SBF.error("Conversation not found","SBAdmin.openConversation"):this.openConversation(t,e.id,b)});else{let g=y.find(".sb-conversation .sb-list");var a=SBF.null(k[e])||!("email"in k[e].details);let f=y.find(`[data-conversation-id="${t}"]`);g.html(""),g.sbLoading(!0),a?($(new SBUser({id:e})),$().update(()=>{k[e]=$(),this.updateUserDetails()})):($(k[e]),this.updateCurrentURL()),SBPusher.active&&(SBPusher.event("client-typing",e=>{e.user_id==$().id&&(U.typing(!0),clearTimeout(n),n=setTimeout(()=>{U.typing(!1)},1e3))}),SBPusher.event("new-message",()=>{SBChat.update()}),SBPusher.event("agent-active-conversation-changed",e=>{e.previous_conversation_id==t&&y.find(".sb-conversation-busy").remove()},"agents"),SBPusher.event("init",e=>{U.updateCurrentURL(e.current_url)}),SBPusher.event("message-status-update",e=>{SBChat.conversation&&SBChat.conversation.updateMessagesStatus(e.message_ids)})),SB_ADMIN_SETTINGS["smart-reply"]&&V.html(""),_.find("li").sbActive(!1),f.sbActive(!0),-1!=t?$().getFullConversation(t,t=>{let e=t.get("conversation_status_code");var a=P.eq(0),i=a.find(".sb-active").attr("data-value"),s=(SBChat.setConversation(t),SBChat.populate(),this.setReadIcon(e),y.find(".sb-conversation-busy").remove(),this.updateUserDetails(),t.get("profile_image")),n=t.get("first_name"),o=S(window).width();let r;r=o<555?18<n.length?n.slice(0,18)+"...":n:27<n.length?n.slice(0,27)+"...":n;n=$().getExtra("phone").value,s=`
    <span style="padding-right:5px;" class="open-profile-name">
        <img src="${s}" class="top-image-profile">
        <span class="routin-top-content">Editar</span>
    </span> 
    <span style="margin: 0px 10px 0px 0px;">${r}</span>
    <span class="additional-info">${n?`<a alt="Call from your Phone" href="tel:${n}"><i class="styling-caller bi ${o<555?"bi-telephone-fill":"bi-skype"}"></i></a>`:""}</span>

`;y.find(".sb-top > a").html(s);let l=!1;if(y.find(".sb-top > a > span").on("click",function(){var e=S(this).next(".additional-info");l?e.hide():e.show(),l=!l}),y.find(".open-profile-name").on("click",function(){j.showEdit($())}),S(".sb-list").prepend('<div class="load-more"><span id="load-more" ><i style="vertical-align:middle;font-size: var(--chat-text-size-1-0);" class="bi-arrow-up-circle"></i> </div>'),G.must_translate=SB_ADMIN_SETTINGS.translation&&$().language&&SB_ADMIN_SETTINGS["active-agent-language"]!=$().language,G.must_translate){var c=[];let i=[],s=[];for(var d=0;d<t.messages.length;d++){var u=t.messages[d];"bot"!=u.get("user_type")&&u.message&&(c.push(u.message),i.push(u.id),s.push(u.get("user_type")))}c.length&&M.dialogflow.translate(c,SB_ADMIN_SETTINGS["active-agent-language"],e=>{if(e)for(var t=0;t<e.length;t++){var a=SBChat.conversation.getMessage(i[t]);a&&(a.set("translation",e[t].translatedText),g.find(`[data-id="${i[t]}"]`).replaceWith(a.getCode(!0)),g.find(`[data-id="${i[t]}"] .sb-menu`).prepend(`<li data-value="original">${E(SBF.isAgent(s[t])?"View translation":"View original message")}</li>`))}})}var n=y.find("#conversation-department"),s=(n.length&&(o=n.find(`[data-id="${t.get("department")}"]`),n.find(" > p").attr("data-value",o.data("value")).html(o.html())),y.find("#conversation-agent")),o=(s.length&&(n=s.find(`[data-id="${t.get("agent_id")}"]`),s.find(" > p").attr("data-value",n.data("id")).html(n.html())),[1,2].includes(e)?e=0:e,i==e||6==i||S(q).find(".sb-search-btn").sbActive()||(a.find(`[data-value="${e}"]`).click(),a.find("ul").sbActive(!1)),C&&this.mobileOpenConversation(),f.length||i!=e&&(0!=i||1!=e&&6!=e)&&(6!=i||0!=e)||_.prepend(U.getListCode(t).replace("<li",'<li class="sb-active"')),f.sbActive(!0),b&&this.scrollTo(),t.get("busy"));if(o&&y.find(".sb-editor > .sb-agent-label").html(`<span data-agent="${o.id}" style="border-radius: 10px 10px 0px 0px;position: absolute;bottom: calc(100% - -1px);background: #006eff;color: #ffffff;padding: 4px 10px;font-size: var(--chat-text-size-9);left: 4px;right: 4px;text-align: center;"><b>${o.first_name} ${o.last_name}</b> ${E("was viewing the conversation.")} <i class="bi-check-all" style="vertical-align: middle;"></i></span>`),this.tags.update(t.details.tags),this.notes.update(t.details.notes),this.attachments(),SB_ADMIN_SETTINGS["smart-reply"]){let e=t.getLastUserMessage();V.html(""),(e=e&&e.payload("sb-human-takeover")?t.getLastUserMessage(e.get("index")):e)&&(M.dialogflow.smart_reply_data=!1,M.dialogflow.smartReply(e.message))}for(d=t.messages.length-1;0<d;d--){var p=t.messages[d].get("payload");let e=!1;if(p&&"rich-messages"in p)for(var h in p["rich-messages"]){h=p["rich-messages"][h];if("rating"==h.type){y.find(".sb-profile-list > ul").append(`<li data-id="rating"><i class="sb-icon bi-${1==h.result.rating?"hand-thumbs-up-fill":"hand-thumbs-down-fill"}"></i><span>${E("User rating")}</span></li>`),e=!0;break}}if(e)break}$().getConversations(function(e){y.find(".sb-user-conversations").html($().getConversationsCode(e))}),g.sbLoading(!1)}):(SBChat.clear(),_.find("li").sbActive(!1),g.sbLoading(!1)),a||this.updateUserDetails(),y.find(".sb-board").removeClass("sb-no-conversation"),D.updateUsersActivity(),this.startRealTime(),SBF.getURL("conversation")!=t&&ve("?conversation="+t)}},populate:function(e,t,a){this.openConversation(e,t,a)},populateList:function(e){let t="",a=(w=[],e);a=a.sort(function(e,t){return new Date(t.creation_time).getTime()-new Date(e.creation_time).getTime()});for(var i=0;i<a.length;i++)t+=this.getListCode(a[i]),w.push(a[i]);0===a.length&&(t=`<p class="sb-no-results">${E("No conversations found.")}</p>`),_.html(t),_.css({position:"relative",bottom:"15px"}),this.positionList(),this.updateMenu(),SBF.event("SBAdminConversationsLoaded",{conversations:e})},positionList(){var e=Array.from(document.querySelectorAll("ul.sorting-by-last-message li"));let s=0;e.sort((e,t)=>{e=parseInt(e.getAttribute("data-time"));return parseInt(t.getAttribute("data-time"))-e}),e.forEach((e,t)=>{var a=e.offsetHeight,i=e.getAttribute("data-conversation-id");this.chat_tops[0][i]=e.getAttribute("data-time"),e.style.cssText=`
      position: relative;
      width: -webkit-fill-available;
      width: -moz-available;
      order: ${t}; // Use flexbox order for positioning
    `,s+=a,e.parentNode.appendChild(e)});e=document.querySelector("ul.sorting-by-last-message");e.style.display="flex",e.style.flexDirection="column"},update:function(){var e;this.busy||0!=P.eq(0).find("p").attr("data-value")||(this.busy=!0,SBF.ajax({function:"get-new-conversations",datetime:this.datetime_last_conversation},n=>{if(this.busy=!1,n.length){let t="",a="";var o=SBChat.conversation?SBChat.conversation.id:-1;let i,s=!1;var r=[];this.datetime_last_conversation=n[0].creation_time;for(var l=0;l<n.length;l++)if(!r.includes(n[l].conversation_id)){var c=n[l],d=c.conversation_status_code,u=c.user_id,p=c.conversation_id,h=o==p;let e=this.getListCode(c,null);var g=_.find(`[data-conversation-id="${p}"]`),f=g.index(),b=g.length,v=SBF.null(n[l].payload)?{}:JSON.parse(n[l].payload),m=c.message;40<m.length&&(m=m.substring(0,40)+"...",c.message=m),h?(e=e.replace("<li",'<li class="sb-active"'),b?(c.message&&g.replaceWith(e),w[f].conversation_status_code=d,this.setReadIcon(d)):s=!0):b&&(w[f]=c,_.find(`[data-conversation-id="${p}"]`).remove()),u in k||(k[u]=new SBUser({id:u,first_name:c.first_name,last_name:c.last_name,profile_image:c.profile_image,user_type:c.user_type})),h&&b||(2==d?(t+=e,w.unshift(c)):0!=d&&1!=d||(0==(i=_.find('[data-conversation-status="2"]').last()).length?t+=e:(w.splice(i.index()+1,0,c),a+=e)),u==$().id&&$().getConversations(function(e){y.find(".sb-user-conversations").html($().getConversationsCode(e))}),SBF.event("SBAdminNewConversation",{conversation:c})),$()&&("event"in v&&"update-user"==v.event||k[u].type!=c.user_type)&&$().update(()=>{this.updateUserDetails(),k[$().id]=$()}),""==c.message&&""==c.attachments||U.newMsgTop(n[l],"add"),SBChat.tab_active||2!=c.conversation_status_code||SBF.isAgent(c.message_user_type)&&!("preview"in v)||SBF.null(c.message)&&SBF.null(c.attachments)&&!("preview"in v)||(this.desktop_notifications&&(m=[c.first_name+" "+c.last_name,D.userProfileImage(c.profile_image)],g=("preview"in v?v.preview:"notfimy").replace(/@s\.whatsapp\.net/g,"").replace(/\*(.*?)\*/g,"*$1*").replace(/_(.*?)_/g,"_$1_").replace(/~(.*?)~/g,"~$1~").replace(/```(.*?)```/g,"```\n$1\n```").replace(/`(.*?)`/g,"`$1`").replace(/(.*?)/g,"$1").replace(/\{agent_name\}/g,'<i class="bi-people-fill"></i>'),SBChat.desktopNotification(m[0],g,m[1],p,u)),this.flash_notifications&&SBChat.flashNotification(),SBChat.audio&&["a","c","ic","ag"].includes(SB_ADMIN_SETTINGS.sounds)&&SBChat.audio.play()),r.push(p)}t&&_.prepend(t),a&&S(a).insertAfter(i),s&&this.scrollTo(),this.positionList(),this.updateMenu()}}),(SB_ADMIN_SETTINGS["assign-conversation-to-agent"]||SB_ACTIVE_AGENT.department)&&(e=_.find(" > li").map(function(){return S(this).attr("data-conversation-id")}).get()).length&&SBF.ajax({function:"check-conversations-assignment",conversations_ids:e,agent_id:!!SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&SB_ACTIVE_AGENT.id,department:SB_ACTIVE_AGENT.department},e=>{if(e)for(var t=0;t<e.length;t++)_.find(`[data-conversation-id="${e[t]}"]`).remove()}))},updateMenu:function(){var t=_.find('[data-conversation-status="2"]').length,a=P.eq(0);const i=a.find(" > a").find(" > p span");if(100==t||this.menu_count_ajax){var a=a.find("li.sb-active").data("value");this.menu_count_ajax=!0,SBF.ajax({function:"count-conversations",status_code:0==a?2:a},e=>i.html(`(${e})`))}else{let e=document.getElementById("floatingElement");e||((e=document.createElement("div")).id="floatingElement",e.style.cssText="position: relative; top: 10px; margin: auto; display: flex; justify-content: center; z-index: 33;",(a=document.createElement("small")).className="notif",a.style.cssText="font-size: medium; padding: 6px 10px; border-radius: 30px;",e.appendChild(a),document.getElementById("sb-conversations").appendChild(e)),e.querySelector(".notif").textContent=t,e.style.visibility=0===t?"hidden":"visible"}},messageMenu:function(e){var t=`<li style="padding: 6px 15px; line-height:20px" data-value="read-text"> <i class="bi-volume-up-fill"></i> ${E("Leer")}</li>`;return`
				<i class="sb-menu-btn bi-three-dots"></i>
				<ul style="right: 0rem;padding: .4rem;" class="message-menu sb-menu">
					${d&&!SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS["allow-agent-delete-message"]||SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS["allow-supervisor-delete-message"]?`<li style="padding: 6px 15px; line-height:20px" data-value="delete"><i class="bi-trash"></i> ${E("Delete")}</li><hr>`:""}
					${t}
				</ul>`},updateUserDetails(){var e,t;$()&&(e=S(".sb-top > a"),t=15<(t=$().name).length?t.slice(0,15)+"...":t,e.find("span").eq(1).html(t),y.find(".sb-user-details .sb-profile").setProfile(),j.populate($(),y.find(".sb-profile-list")))},setReadIcon(e){var t=2==e;y.find('.sb-top [data-value="read"],.sb-top [data-value="unread"]').sbActive([0,1,2].includes(parseInt(e))).attr("data-value",t?"read":"unread").attr("data-sb-tooltip",E(t?"Mark as read":"Mark as unread")).parent().find("i").attr("class",t?"bi-check-lg":"bi-check-all")},getListCode:function(e,t){var a;e instanceof SBConversation&&(a=e.getLastMessage(),e={...e,...a});let i=e.message;40<(i=i.replace(/- /g," ").replace(/[\[\]"\,}]/g,"").replace(/[{,+0-9]+@s\.whatsapp\.net/g,"").replace(/\{agent_name\}/g,'<i class="bi-people-fill"></i>').replace(/\[buttons\s+options="([^"]+)"\s+message="([^"]+)"\]/g,'<i class="bi-file-text" data-options="$1" data-message="$2"></i>').replace(/\[card[^\]]*\]/g,'<i class="bi-file-text"></i>').replace(//g,"").replace(//g,"  ").replace(/(\*[^*]+\*)/g,function(e){return`<strong>${e.slice(1,-1)}</strong>`}).replace(/(_[^_]+_)/g,function(e){return`<em>${e.slice(1,-1)}</em>`}).replace(/(`[^`]+`)/g,function(e){return`<code>${e.slice(1,-1)}</code>`}).replace(/~([^~]+)~/g,function(e){return`<del>${e.slice(1,-1)}</del>`}).replace(/(\*[^*]+\*)/g,function(e){return`<strong>${e.slice(1,-1)}</strong>`})).length&&(a=i.split(" "),i=a.slice(0,5).join(" ")+(5<a.length?"...":"")),!i&&e.attachments&&(s=(a=JSON.parse(e.attachments)).filter(e=>/\.(jpg|jpeg|png|webp|mp4)\b/g.test(e)),n=a.filter(e=>/\.(docx?|xlsx?|pdf)\b/g.test(e)),a=a.filter(e=>/\.(mp3|ogg)\b/g.test(e)),s=0<s.length?`<i class="bi-box"></i> ${E("Media")}: `+(1<s.length?"+"+(s.length-1):s.length):"",n=0<n.length?`<i class="bi-file-text"></i> ${E("Doc")}: `+(1<n.length?"+"+(n.length-1):n.length):"",a=0<a.length?`<i class="bi-mic-fill vertical-align"></i> ${E("Voice")}: `+(1<a.length?"+"+(a.length-1):a.length):"",i=[s,n,a].filter(Boolean).join(" "));var s=(new SBMessage).strip(i).replace(/_/g," "),n=!SBF.null(e.title);return`
          <li data-user-id="${e.user_id}" data-conversation-id="${e.conversation_id}" data-time="${new Date(e.creation_time).getTime()}" data-conversation-status="${t}" ${e.conversation_source?`data-conversation-source="${e.conversation_source}"`:""}>
              <small class="source-conversation-icon">
                  <img id="conversation-source-icon" class="source-buttons" src="../media/apps/${e.conversation_source}.svg">
              </small>
              <div class="sb-profile client-status">
                  <img class="client-icon-status sb-icon tags-${e.label} bi-kanban-fill loading="lazy" src="${e.profile_image}">
                  <h3 class="sb-name${n?" sb-custom-name":""}">${n?e.title:e.first_name+" "+e.last_name}</h3>
                  <div class="sb-info-conversations" style="min-width: 60px;text-align:right;flex: auto;font-size: .75rem;letter-spacing: .3px;margin: -2px 0px;">
                      ${SBF.beautifyTime(e.creation_time)}
                  </div>
              </div>
              <div>
                  <a class="phone-number" style="color:inherit">${e.phone}</a>
              </div>
              <p class="message-received" style="max-width:calc(100% - 145px);">${s}</p>
              <div class="conversation-bar">
                  <div class="no-read-icon sb-hide" style="margin: 0px 1px;">
                      <svg width="20" height="20" viewBox="0 0 24.5 24.5" xmlns="http://www.w3.org/2000/svg" class="icon flat-color">
                          <circle cx="12" cy="12" r="10" class="check-circle"/>
                          <path d="M11 16a1 1 0 0 1-.71-.29l-3-3a1 1 0 1 1 1.42-1.42l2.29 2.3 4.29-4.3a1 1 0 0 1 1.42 1.42l-5 5A1 1 0 0 1 11 16Z" class="check-inside"/>
                      </svg>
                  </div>
              </div>
          </li>
      `},newMsgTop(e=!1,t){document.querySelectorAll("ul.sorting-by-last-message li");var a=S(".sb-scroll-area");e&&((w=this.getUniqueChat(w,"user_id")).slice().sort((e,t)=>new Date(t.creation_time).getTime()-new Date(e.creation_time).getTime()).forEach((e,t)=>{S(`.sorting-by-last-message li[data-conversation-id='${e.conversation_id}']`).attr("style",`
				  transition: all .5s ease;
          webkit-transition: all .5s ease;
				  width:-webkit-fill-available;width:-moz-available;
          
				`)}),0<a.scrollTop())&&"add"===t&&requestAnimationFrame(()=>this.newMsgTop(e,t))},getUniqueChat:function(e,a){let i=[];return e.filter(function(t){i.findIndex(e=>e[a]==t[a])<=-1&&i.push(t)}),i},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update(),this.updateCurrentURL()},1e4),SBChat.startRealTime())},stopRealTime:function(){clearInterval(this.real_time),SBChat.stopRealTime()},timeZoneList:function(){Intl.supportedValuesOf("timeZone");var e=document.querySelector("#zones"),t=Intl.DateTimeFormat().resolvedOptions().timeZone;if(Intl.supportedValuesOf){e.innerHTML+="";for(const i of Intl.supportedValuesOf("timeZone"))e.innerHTML+=`<option ${t==i?"selected":""}>${i}</option>`}else{var a=new Option("Your browser does not support Intl.supportedValuesOf().",null,!0,!0);a.disabled=!0,e.options.add(a)}},transcript:function(e,t=!1){if(!("email"!=t||$()&&$().get("email")))return!1;SBF.ajax({function:"transcript",conversation_id:e},e=>{"email"==t?SBChat.sendEmail(SB_ADMIN_SETTINGS["transcript-message"],[[e,e]],!0):window.open(e)})},typing:function(e){e?(SBChat.user_online||D.setActiveUserStatus(!0),this.user_typing||(y.find(".sb-conversation .sb-top > .sb-labels").append('<span class="sb-status-typing" style="font-size: var(--chat-text-size-7);">'+E("Typing")+"</span>"),this.user_typing=!0)):this.user_typing&&(y.find(".sb-conversation .sb-top .sb-status-typing").remove(),this.user_typing=!1)},scrollTo:function(){var e=_.find(".sb-active"),e=e.length?e[0].offsetTop:0;_.parent().scrollTop(e-(C?120:70))},search:function(e){e&&fe(e,(e,t)=>{(se=1)<e.length?SBF.ajax({function:"search-conversations",search:e},e=>{U.populateList(e),S(t).sbLoading(!1),this.scrollTo(),this.is_search=!0}):(e=U.filters(),ie=1,SBF.ajax({function:"get-conversations",status_code:e[0],tag:e[3]},e=>{U.populateList(e),S(t).sbLoading(!1),this.is_search=!1}))})},updateCurrentURL:function(e=!1){e?this.ucurl(e):SBChat.user_online&&$()&&$().getExtra("current_url")&&SBF.ajax({function:"current-url"},e=>{e&&this.ucurl(e)})},ucurl(e){var t=$().getExtra("current_url");e=e.replace("https://","").replace("http://","").replace("www.","").replace(/\/$/,""),y.find('.sb-profile-list [data-id="current_url"] label').attr("data-value",e).html(e),t&&(t.value=e,$().setExtra("current_url",t))},assignDepartment:function(e,t,a){SBF.ajax({function:"update-conversation-department",conversation_id:e,department:t,message:SBChat.conversation.getLastMessage().message},e=>{a(e)})},assignAgent:function(e,t,a=!1){SBF.ajax({function:"update-conversation-agent",conversation_id:e,agent_id:t,status_code:6,message:SBChat.conversation.getLastMessage().message},e=>{a&&a(e)})},setActiveDepartment:function(e){var t,a;SBChat.conversation&&SBChat.conversation.get("department")==e||(a=(t=y.find("#conversation-department")).find(`[data-id="${e}"]`),t.find(" > p").attr("data-value",a.data("value")).html(a.html()).next().sbActive(!1),SBChat.conversation.set("department",e),"agent"==SB_ACTIVE_AGENT.user_type&&SB_ACTIVE_AGENT.department&&SB_ACTIVE_AGENT.department!=e&&(_.find(`[data-conversation-id="${SBChat.conversation.id}"]`).remove(),U.clickFirst()),T("Department updated. The agents have been notified."))},setActiveAgent:function(e){var t=y.find("#conversation-agent"),a=t.find(`[data-id="${e}"]`);SBChat.conversation.set("agent_id",e),t.find(" > p").attr("data-value",a.data("value")).html(a.html()).next().sbActive(!1),"agent"!=SB_ACTIVE_AGENT.user_type||SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&!e||(_.find(`[data-conversation-id="${SBChat.conversation.id}"]`).remove(),U.clickFirst()),e&&T("Agent assigned. The agent has been notified.")},mobileOpenConversation:function(){y.find(".sb-admin-list").sbActive(!1),y.find(".sb-conversation").sbActive(!0),s.addClass("sb-hide")},mobileCloseConversation:function(){_.find("li.sb-active").sbActive(!1),y.find(".sb-admin-list").sbActive(!0),y.find(".sb-conversation").sbActive(!1),s.removeClass("sb-hide"),window.history.replaceState({},document.title,SBF.URL())},clickFirst:function(){_.find("li:first-child").length?(_.find("li:first-child").click(),U.scrollTo()):y.find(".sb-board").addClass("sb-no-conversation")},savedReplies:function(e,t){var a=t.charAt(e.selectionStart-1);if("/"==a&&(SBChat.editor_listening=!0),SBChat.editor_listening&&" "==a){var i=t.substr(t.lastIndexOf("/")+1).replace(" ","");SBChat.editor_listening=!1;for(var s=0;s<B.length;s++)if(B[s]["reply-name"]==i)return void S(e).val(t.substr(0,t.lastIndexOf("/"))+B[s]["reply-text"])}},attachments:function(){if(H.length){var t=SBChat.conversation.getAttachments();let e="";for(var a=0;a<t.length;a++){var i=t[a][0].slice(0,20);e+=`<a href="${t[a][1]}" class="bg-attachment" target="_blank"><i class="sb-icon bi-file-earmark-arrow-down"></i>${i+"..."} </a>`}S(H).html(""==e?"":`<h3>${E("Attachments")}</h3><div class="sb-list-items sb-list-links sb-list-icon">${e}</div>`),ge(H,160)}},filters:function(){for(var e=[],t=0;t<P.length;t++)e.push(P.eq(t).find("li.sb-active").data("value"));return(e[1]||e[3])&&(e[0]="all"),e},notes:{busy:!1,add:function(e,t,a,i,s=!1){let n=S("#alertdate").val();var o,r=S("#zones").val();n=""!=n&&(SBF.getTimezoneOffset(r)==(new Date).getTimezoneOffset()?n:new Date(n).toUTCString()),-1<navigator.userAgent.indexOf("Firefox")&&((o=new Date(n)).setHours(o.getHours()-3),n=""!=n&&(SBF.getTimezoneOffset(r)==(new Date).getTimezoneOffset()?moment.utc(n).format():new Date(n).toUTCString())),SBF.ajax({function:"add-note",conversation_id:e,user_id:t,name:a,message:i,alert:n,time_zone:r,status:!n},e=>{s&&s(e),S("#alertdate").val("")})},update:function(t,a=!1){if(O.length){let e="";for(var i=O.find(" > div"),s=0;s<t.length;s++){var n=t[s];e+=`<div data-id="${n.id}"><span class="sb-note-title">${n.name} ${SB_ACTIVE_AGENT.id==n.user_id?'<i class="sb-delete-note bi-x-lg"></i>':""}</span>${n.alert||n.time_zone?`<small class="note-alert-text" style="margin: 0px 6px;">${n.alert?SBF.localTime(n.alert,n.time_zone):""}${null!=n.time_zone?" "+n.time_zone:""}</small>`:""}<span class="note-content">${n.message}</span></div>`}a?i.append(e):i.html(e),i.attr("style","display: flex; flex-direction: column-reverse;"),O.find(".bi-chevron-down").remove(),ge(O,155),this.busy=!1}},delete:function(e,t,a=!1){this.busy||(this.busy=!0,SBF.ajax({function:"delete-note",conversation_id:e,note_id:t},e=>{this.busy=!1,a&&a(e)}))},readmore:function(e,t){return e.length<=t?(S(".dots").hide(),e):e.slice(0,t)+`<span class="more" style="display:none">${e.slice(t,e.length)}</span><span class="dots">...</span>`}},tags:{busy:!1,list:!1,update:function(t){if(z.length){let e="";for(var a=z.find(" > div"),i=0;i<t.length;i++)e+=`<span>${t[i]}</span>`;a.html(e),this.busy=!1}},getAll:function(e=[]){let t="";for(var a=0;a<this.list.length;a++)e.includes(this.list[a])||(t+=`<span>${this.list[a]}</span>`);return t}},showDirectMessageBox:function(e,t=[]){var a="email"==e;SBForm.clear(u),u.find(".sb-direct-message-users").val(t.length?t.join(","):""),u.find(".sb-bottom > div").html(""),u.find(".sb-top-bar > div:first-child").html(E("Broadcast "+("sms"==e?"text message":e))),u.find(".sb-loading").sbLoading(!1),u.find(".sb-direct-message-subject").sbActive(a).find("input").attr("required",a),u.attr("data-type",e),"email"!==e&&"sms"!==e?(u.find(".sb-selector").removeClass("sb-hide"),(new Metatemplate).init("#user-template-form"),"template"===u.find(".sb-select").val()&&u.find(".sb-select").val(null)):(u.find(".sb-selector").addClass("sb-hide"),S(".sb-bulk-sender").addClass("sb-hide"),S(".sb-direct-message-hide").removeClass("sb-hide")),u.find(".sb-select").on("change",function(){S(this).find(".active-bulk-sender").is(":selected")?(S(".sb-bulk-sender").removeClass("sb-hide"),S(".sb-direct-message-hide").addClass("sb-hide")):(u.find(".sb-selector").addClass("sb-hide"),S(".sb-bulk-sender").addClass("sb-hide"),S(".sb-direct-message-hide").removeClass("sb-hide"))}),u.sbShowLightbox()}},j={getAll:function(e){return SBForm.getAll(e)},get:function(e){return SBForm.get(e)},set:function(e,t){return SBForm.set(e,t)},getUserExtra:function(t){SBF.ajax({function:"get-user-extra",user_id:t},e=>{this.getUserExtra(t,response)})},show:function(a){L(),$(new SBUser({id:a})),$().update(()=>{this.populate($(),r.find(".sb-profile-list")),r.find(".sb-profile").setProfile(),$().getConversations(e=>{var t=$().type;SBF.isAgent(t)&&this.agentData(),r.find(".sb-user-conversations").html($().getConversationsCode(e)),r.find(".sb-top-bar [data-value]").sbActive(!1),SBF.null($().get("email"))||r.find(".sb-top-bar [data-value=email]").sbActive(!0),$().getExtra("phone")&&SB_ADMIN_SETTINGS.sms&&r.find(".sb-top-bar [data-value=sms]").sbActive(!0),this.boxClasses(r,t),r.attr("data-user-id",$().id).sbShowLightbox(),L(!1,!1),SBF.event("SBProfileBoxOpened",{user_id:a})}),k[a]=$(),SBF.getURL("user")!=a&&ve("?user="+a)})},showEdit:function(t){if(!(t instanceof SBUser))return SBF.error("User not of type SBUser","SBUsers.showEdit"),!1;{var a=g.find("#password input"),i=t.type,s=g.find("#user_type select");g.removeClass("sb-user-new").attr("data-user-id",t.id),g.find(".sb-top-bar .sb-save").html('<i class="bi-check-lg"></i>'+E("Save changes")),g.find(".sb-profile").setProfile(),g.find(".sb-custom-detail").remove(),g.find("input,select,textara").removeClass("sb-error");let e="";var n,o=g.find(".sb-additional-details [id]").map(function(){return this.id}).get().concat(["facebook-id","ip","os","current_url","country_code","browser_language","browser"]);for(n in t.extra)o.includes(n)||(e+=`<div id="${n}" data-type="text" class="sb-input sb-custom-detail"><span>${E(t.extra[n].name)}</span><input type="text"></div>`);g.find(".sb-additional-details .sb-edit-box").append(e),this.populateEdit(t,g),this.updateRequiredFields(i),"admin"==SB_ACTIVE_AGENT.user_type&&SBF.isAgent(i)&&s.html(`<option value="agent">${E("Agent")}</option><option value="admin"${"admin"==i?" selected":""}>${E("Admin")}</option>`),a.val()&&a.val("********"),this.boxClasses(g,i),g.sbShowLightbox(),SBF.event("SBProfileEditBoxOpened",{user_id:t.id})}},populate:function(i,s){var e,t,a=["first_name","last_name","password","profile_image"];let n="";for(o in s.hasClass("sb-profile-list")&&SBChat.conversation&&(e=SBChat.conversation.get("source"),t=SBChat.conversation.get("label"),n=this.profileRow("conversation-id",SBChat.conversation.id,E("Conversation ID")),SBF.null(t)?n+=this.profileRow("conversation-label","Unknown",E("Label")):n+=this.profileRow("conversation-label",t,E("Client status")),SBF.null(e)?n+=this.profileRow("conversation-source","Unknown"):n+=this.profileRow("conversation-source",{fb:"Facebook",ww:"Whatsmeow",wx:"waweb",wa:"WhatsApp",tm:"Text message",ig:"Instagram",tg:"Telegram",tk:"Tickets",wc:"WeChat",em:"Email",tw:"Twitter",bm:"Google"}[e]||e,E("Source"))),"admin"!=SB_ACTIVE_AGENT.user_type&&a.push("token"),i.details)a.includes(o)||(n+=this.profileRow(o,i.get(o)));if(i.isExtraEmpty())SBF.ajax({function:"get-user-extra",user_id:i.id},e=>{for(var t=1;t<e.length;t++){var a=e[t].slug;i.setExtra(a,e[t]),n+=this.profileRow(a,e[t].value,e[t].name)}s.html(`<ul>${n}</ul>`),ge(s,56)});else{for(var o in i.extra){var r=i.getExtra(o);n+=this.profileRow(o,r.value,r.name)}s.html(`<h3 class="sb-user-details-info">${E("User information")}</h3><ul>${n}</ul>`),ge(s,56)}S("#change-conversation-source").change(function(e){const t=e.target.value;e=`${STMBX_URL}/media/apps/${t}.svg`,S("#conversation-source-icon").attr("src",e),SBF.ajax({function:"update-conversation-source",conversation_id:SBChat.conversation.id,source:t},e=>{T("Required reload"),SBChat.update(),S("#change-conversation-source").val(t)}),e="sb-icon bi-"+t;S('.sb-profile-list [data-id="conversation-source"] i').attr("class",e)}),S("#change-conversation-labels").change(function(e){var t,a;"Unknown"!==e.target.value&&(t=e.target.options[e.target.selectedIndex].text,a="sb-icon bi-kanban-fill tags-"+e.target.value,S('.sb-profile-list [data-id="conversation-label"] i').attr("class",a),S(`[data-user-id="${$().id}"] .bi-kanban-fill`).attr("class",a),S(`[data-user-id="${$().id}"] #label-name`).text(t)),j.updateLabel(e.target.value)}),S("#CstBtn a").click(function(e){var t=S(this).attr("id"),a=E(SBF.admin_set("label-names")[t]+" "),i="sb-icon bi-kanban-fill tags-"+t;S('.sb-profile-list [data-id="conversation-label"] i').attr("class",i),S(`[data-user-id="${$().id}"] .bi-kanban-fill`).attr("class",i),S(`[data-user-id="${$().id}"] #label-name`).text(a),j.updateLabelUI(t,a,i),j.updateLabel(t)})},updateLabelUI:function(e,t,a){S(`[data-user-id="${$().id}"] .bi-kanban-fill`).attr("class",a),S(`[data-user-id="${$().id}"] #label-name`).text(t)},getLabel:function(e){SBF.ajax({function:"get-clientStatus-conversations",conversation_id:SBChat.conversation.id,label:e},e=>{"status-client"==N.active_report&&N.initReport("status-client")})},updateLabel:function(e){SBF.ajax({function:"update-clientStatus-conversations",conversation_id:SBChat.conversation.id,label:e},e=>{"status-client"==N.active_report&&N.initReport("status-client")})},profileRow:function(e,a,t=e){if(""==a)return"";var i={id:"person-vcard","conversation-label":"tag","conversation-source":"tickets","conversation-id":"person-vcard",full_name:"person-bounding-box",email:"envelope",phone:"phone",user_type:"person-bounding-box",last_activity:"calendar",creation_time:"calendar",token:"shuffle",currency:"currency-exchange",location:"pin-map",country:"flag",address:"app",city:"app",postal_code:"app",os:"person-workspace",current_url:"radar",timezone:"clock"};let s=`<i class="sb-icon bi-${e in i?i[e]:"app"}"></i>`,n,o=!1;switch(e){case"last_activity":case"creation_time":a=SBF.beautifyTime(a);break;case"user_type":a=SBF.slugToString(a);break;case"country_code":case"language":case"browser_language":s=`<img src="${STMBX_URL}/media/flags/${a.toLowerCase()}.png" />`;break;case"browser":(n=a.toLowerCase()).includes("chrome")?o="chrome":n.includes("edge")?o="edge":n.includes("firefox")?o="firefox":n.includes("opera")?o="opera":n.includes("safari")&&(o="safari");break;case"os":(n=a.toLowerCase()).includes("windows")?o="windows":n.includes("mac")||n.includes("apple")||n.includes("ipad")||n.includes("iphone")?o="apple":n.includes("android")?o="android":n.includes("linux")?o="linux":n.includes("ubuntu")&&(o="ubuntu");break;case"conversation-source":case"browser":case"os":case"conversation-source":o=a.toLowerCase(),a=`<select disabled style="background: transparent;border-color: transparent;" id="change-conversation-source">
                                <option  value="tk" ${"Tickets"==a?"selected":""} value>Live Chat</option>
                                <option value="ww" ${"Whatsmeow"==a?"selected":""} value>WhatsApp QR</option>
                                <option value="wx" ${"waweb"==a?"selected":""} value>WhatsApp Web</option>                                
                                <option value="wa" ${"WhatsApp"==a?"selected":""} value>WhatsApp API</option>
                                <option   hidden value="tg" ${"Telegram"==a?"selected":""} value>Telegram</option>
                                <option  hidden value="bm" ${"Google"==a?"selected":""} value>Google</option>
                                <option  hidden value="tm" ${"Text message"==a?"selected":""} value>Text message</option>
                                <option hidden value="un" ${"Unknown"==a?"selected":""} value>Facebook</option>                                
                                <option hidden value="ig" ${"Instagram"==a?"selected":""} value>Instagram</option>
                                <option hidden value="wc" ${"WeChat"==a?"selected":""} value>WeChat</option>
                                <option hidden value="em" ${"Email"==a?"selected":""} value>Email</option>
                                <option  hidden value="tw" ${"Twitter"==a?"selected":""} value>Twitter</option>
                             </select>`,o&&"Unknown"!==a&&(s=`<img src="${STMBX_URL}/media/${"conversation-source"==e?"apps":"devices"}/${o}.svg" />`);break;case"conversation-label":var r=a,l=he;let t="";Array.isArray(l)&&l.forEach(function(e){t+=`<option value="${e}" ${a===e?"selected":""}>${E(SBF.get_value(e)+" ")}</option>`});l=`class="sb-icon bi-kanban-fill tags-${r}"`;a=`<select style="background: transparent; border-color: transparent;" id="change-conversation-labels">
								<option value='unknown'>${E("Client status")}</option> ${t} </select>`,s=`<i ${l}></i>`}return`<li data-id="${e}">${s}<span>${E(SBF.slugToString(t))}</span><label style="overflow-wrap: break-word">${a}</label></li>`},populateEdit:function(i,e){e.find(".sb-details .sb-input").each((e,t)=>{this.set(t,i.details[S(t).attr("id")])}),e.find(".sb-additional-details .sb-input").each((e,t)=>{var a=S(t).attr("id");a in i.extra?this.set(t,i.extra[a].value):this.set(t,"")})},clear:function(e){SBForm.clear(e)},errors:function(e){return SBForm.errors(e.find(".sb-details"))},showErrorMessage:function(e,t){SBForm.showErrorMessage(e,t)},agentData:function(){let s=`<div class="sb-title">${E("Feedback rating")}</div><div class="sb-rating-area sb-loading"></div>`,n=r.find(".sb-agent-area");n.html(s),SBF.ajax({function:"get-rating"},e=>{var t,a,i;s=0==e[0]&&0==e[1]?`<p class="sb-no-results">${E("No ratings yet.")}</p>`:(t=e[0]+e[1],a=100*e[0]/t,i=100*e[1]/t,`<div><div>${E("Helpful")}</div><span data-count="${e[0]}" style="width: ${Math.round(2*a)}px"></span><div>${a.toFixed(2)} %</div></div><div><div>${E("Not helpful")}</div><span data-count="${e[1]}" style="width: ${Math.round(2*i)}px"></span><div>${i.toFixed(2)} %</div></div><p class="sb-rating-count">${t} ${E("Ratings")}</p>`),n.find(".sb-rating-area").html(s).sbLoading(!1)})},boxClasses:function(e,t=!1){S(e).removeClass("sb-type-admin sb-type-agent sb-type-lead sb-type-user sb-type-visitor").addClass(`${0!=t?"sb-type-"+t:""} sb-agent-`+SB_ACTIVE_AGENT.user_type)},updateRequiredFields:function(e){var t=SBF.isAgent(e);g.find("#password input").prop("required",t),g.find("#email input").prop(t||"user"==e||"lead"==e)}},G={dialog:F,open_popup:!1,must_translate:!1,is_logout:!1,conversations:U,users:D,settings:R,profile:j,apps:M};function _e(){SBF.ajax({function:"get-conversations"},e=>{0==e.length&&y.find(".sb-board").addClass("sb-no-conversation"),U.populateList(e),C&&y.find(".sb-admin-list").sbActive(!0),SBF.getURL("conversation")?(y.sbActive()||s.find(".sb-admin-nav #sb-conversations").click(),U.openConversation(SBF.getURL("conversation"))):C||SBF.getURL("user")||SBF.getURL("setting")||SBF.getURL("report")||SBF.getURL("area")&&"conversations"!=SBF.getURL("area")||U.clickFirst(),U.startRealTime(),U.datetime_last_conversation=SB_ADMIN_SETTINGS["now-db"],L(!1)}),SBPusher.initServiceWorker(),SB_ADMIN_SETTINGS["push-notifications"]&&SBPusher.initPushNotifications()}window.SBAdmin=G,S(document).ready(function(){if(d=S(".sb-admin"),s=d.find("> .sb-header"),y=d.find(".sb-area-conversations"),q=y.find(".sb-admin-list"),_=q.find(".sb-scroll-area ul"),P=q.find(".sb-select"),o=d.find(".sb-area-users"),l=o.find(".sb-table-users"),h=o.find(".sb-menu-users"),r=d.find(".sb-profile-box"),g=d.find(".sb-profile-edit-box"),f=d.find(".sb-area-settings"),v=f.find(".sb-automations-area"),J=v.find(".sb-conditions"),e=v.find(" > .sb-select"),m=v.find(" > .sb-tab > .sb-nav > ul"),x=d.find(".sb-area-reports"),b=f.find(".sb-articles-area"),W=b.find(".sb-article-categories select"),X=b.find(".sb-article-parent-category select"),te=y.find(".sb-replies"),ae=y.find(".sb-status-chat"),ee=d.find(".sb-lightbox-overlay"),typeof STMBX_URL!=ue&&STMBX_URL.substr(0,STMBX_URL.indexOf("-content")-3),O=y.find(".sb-panel-notes"),z=y.find(".sb-panel-tags"),H=y.find(".sb-panel-attachments"),u=d.find(".sb-direct-message-box"),p=d.find(".sb-dialogflow-intent-box"),V=y.find(".sb-editor > .sb-suggestions"),window.onpopstate=function(){d.sbHideLightbox(),C&&y.sbActive()&&y.find(".sb-conversation").sbActive()&&U.mobileCloseConversation(),SBF.getURL("user")?(o.sbActive()||s.find(".sb-admin-nav #sb-users").click(),j.show(SBF.getURL("user"))):SBF.getURL("area")?s.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click():SBF.getURL("conversation")?(y.sbActive()||s.find(".sb-admin-nav #sb-conversations").click(),U.openConversation(SBF.getURL("conversation"))):SBF.getURL("setting")?(f.sbActive()||s.find(".sb-admin-nav #sb-settings").click(),f.find("#tab-"+SBF.getURL("setting")).click()):SBF.getURL("report")&&(x.sbActive()||s.find(".sb-admin-nav #sb-reports").click(),x.find("#"+SBF.getURL("report")).click())},SBF.getURL("area")&&setTimeout(()=>{s.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click()},300),typeof SB_ADMIN_SETTINGS==ue){let i=d.find(".sb-intall");void S(d).on("click",".sb-submit-installation",function(){if(!I(this)){let a=!1;var e=i.find("#first-name").length;if(SBForm.errors(i))a=e?"All fields are required. Minimum password length is 8 characters. Be sure you have entered a valid email.":"All fields are required.";else if(e&&i.find("#password input").val()!=i.find("#password-check input").val())a="The passwords do not match.";else{let t=window.location.href.replace("/admin","").replace(".php","").replace(/#$|\/$/,"");t.includes("?")&&(t=t.substr(0,t.indexOf("?"))),S.ajax({method:"POST",url:t+"/include/ajax.php",data:{function:"installation",details:S.extend(SBForm.getAll(i),{url:t})}}).done(e=>{if(0!=(e=JSON.parse(e))){if(!0===(e=e[1]))return void setTimeout(()=>{window.location.href=t+"?refresh=true"},1e3);switch(e){case"connection-error":a="Routin.bot cannot connect to the database. Please check the database information and try again.";break;case"missing-details":a="Missing database details! Please check the database information and try again.";break;case"missing-url":a="We cannot get the plugin URL.";break;default:a=e}}else a=e;!1!==a&&(SBForm.showErrorMessage(i,a),S("html, body").animate({scrollTop:0},500)),S(this).sbLoading(!1)})}!1!==a&&(SBForm.showErrorMessage(i,a),S("html, body").animate({scrollTop:0},500),S(this).sbLoading(!1))}})}else{var n;d.length&&(L(),d.removeAttr("style"),(window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||document.referrer.includes("android-app://"))&&d.addClass("sb-pwa"),re&&typeof caches!==ue&&caches.delete("sb-pwa-cache"),d.find(" > .sb-rich-login").length||(SB_ADMIN_SETTINGS.pusher?(SBPusher.active=!0,SBPusher.init(()=>{SBPusher.presence(1,()=>{D.updateUsersActivity()}),SBPusher.event("update-conversations",()=>{U.update(),SBChat.update()},"agents"),SBPusher.event("set-agent-status",e=>{e.agent_id==SB_ACTIVE_AGENT.id&&D.setActiveAgentStatus("online"==e.status)},"agents"),_e()})):(_e(),setInterval(function(){D.updateUsersActivity()},1e4)),D.table_extra=l.find("th[data-extra]").map(function(){return S(this).attr("data-field")}).get(),S(window).on("beforeunload",function(){$()&&SBF.ajax({function:"on-close"})}),S(window).keydown(function(e){var t=e.which;let a=!1;if([13,27,46].includes(t)){if(d.find(".sb-dialog-box").sbActive()){var i=d.find(".sb-dialog-box");switch(t){case 46:case 27:i.find(".sb-cancel").click();break;case 32:case 13:i.find("info"!=i.attr("data-type")?".sb-confirm":".sb-close").click()}a=!0}else if([46].includes(t)&&y.sbActive()){if(y.find(".sb-editor textarea").is(":focus"))return;var s=y.find(" > div > .sb-conversation");s.find('.sb-top [data-value="'+(3==s.attr("data-conversation-status")?"delete":"archive")+'"]').click(),a=!0}else[46,27].includes(t)&&(d.find(".sb-lightbox").sbActive()?(d.sbHideLightbox(),a=!0):(s=d.find(".sb-search-btn.sb-active")).length&&(s.find("i").click(),a=!0));a&&e.preventDefault()}}),S(document).on("click keydown mousemove",function(){SBF.debounce(function(){SBChat.tab_active||SBF.visibilityChange(),SBChat.tab_active=!0,clearTimeout(de),de=setTimeout(()=>{SBChat.tab_active=!1},1e4)},"#3",8e3)}),n=0,document.onpaste=function(e){var t,a,i,s,e=e.clipboardData.items[0];0===e.type.indexOf("image")&&((t=new FileReader).onload=function(e){},a=new FormData,i=`screenshot-${n++}.png`,s=e.getAsFile(),a.append("fname",i),a.append("file",s),jQuery.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:a,type:"POST",success:function(e){SBF.uploadResponse(e)}}),t.readAsDataURL(e.getAsFile()))},S(document).ready(function(){S(s).on("click",".help-center",function(){d.find(".sb-updates-box").sbShowLightbox()})}),typeof Notification===ue||"all"!=SB_ADMIN_SETTINGS["desktop-notifications"]&&"agents"!=SB_ADMIN_SETTINGS["desktop-notifications"]||SB_ADMIN_SETTINGS["push-notifications"]||(U.desktop_notifications=!0),"all"!=SB_ADMIN_SETTINGS["flash-notifications"]&&"agents"!=SB_ADMIN_SETTINGS["flash-notifications"]||(U.flash_notifications=!0),le.getDate()!=SBF.storage("admin-clean")&&setTimeout(function(){SBF.ajax({function:"cron-jobs"}),SBF.storage("admin-clean",le.getDate())},1e4),S(d).on("click",".bi-chevron-down",function(){var e=S(this).sbActive(),t=e?S(this).parent().data("height")+"px":"";S(this).html(E(e?"View more":"Close")),S(this).parent().find("> div, > ul").css({height:t,"max-height":t}),S(this).sbActive(!e)}),S(d).on("click",".sb-popup-close",function(){d.sbHideLightbox()}),d&&(S(document).on("click",function(e){S(e.target).closest(".sb-menu-mobile").length||(S(".sb-menu-mobile > i").removeClass("sb-active"),S(".open-profile").removeClass("sb-hide"))}),S(d).on("click",".sb-menu-mobile > i",function(){S(this).toggleClass("sb-active"),G.open_popup=S(this).parent()}),S(d).on("click",".sb-menu-mobile a",function(){S(this).closest(".sb-menu-mobile").find(" > i").sbActive(!1)}),S(d).on("click",".sb-menu-wide,.sb-nav",function(){S(this).toggleClass("sb-active")}),S(d).on("click",".sb-menu-wide > ul > li, .sb-nav > ul > li",function(e){var t=S(this).parent().parent();return t.find("li").sbActive(!1),t.find("> div:not(.sb-menu-wide):not(.sb-btn)").html(S(this).html()),t.sbActive(!1),t.find("> .sb-menu-wide").length&&t.closest(".sb-scroll-area").scrollTop(t.next()[0].offsetTop-(d.hasClass("sb-header-hidden")?70:130)),e.preventDefault(),!1}),S(d).find(".sb-admin-list .sb-scroll-area, main > div > .sb-scroll-area,.sb-area-settings > .sb-tab > .sb-scroll-area,.sb-area-reports > .sb-tab > .sb-scroll-area").on("scroll",function(){var e=S(this).scrollTop();A.last<e-10&&A.header?(d.addClass("sb-header-hidden"),A.header=!1):e+10<A.last&&!A.header&&!A.always_hidden&&(d.removeClass("sb-header-hidden"),A.header=!0),A.last=e}),S(d).on("click",".sb-search-btn i, .sb-filter-btn i",function(){S(this).parent().sbActive()?(S(".sb-top").css("top","+=0px"),S(this).parent().hasClass("sb-filter-btn")&&S(".sb-search-btn, .inbox, .non-hover").addClass("sb-hide"),S(this).hasClass("bi-search")?S(this).removeClass("bi-search").addClass("bi-x-lg"):S(this).hasClass("bi-x-lg")?S(this).removeClass("bi-x-lg").addClass("bi-filter"):S(this).hasClass("bi-filter")&&S(this).removeClass("bi-filter").addClass("bi-filter-circle")):(A.always_hidden=!1,_.parent().scrollTop()<10&&(d.removeClass("sb-header-hidden"),S(this).parent().hasClass("sb-filter-btn")&&S(".sb-search-btn, .inbox, .non-hover").removeClass("sb-hide"),S(this).hasClass("bi-filter-circle")?S(this).removeClass("bi-filter-circle").addClass("bi-filter"):S(this).hasClass("bi-filter")?S(this).removeClass("bi-filter").addClass("bi-x-lg"):S(this).hasClass("bi-x-lg")&&S(this).removeClass("bi-x-lg").addClass("bi-search")))}),S(d).on("click","#open-modal-button",function(){console.log("open",d.find(".sb-send-template-box")),d.find(".sb-send-template-box").sbShowLightbox()}),S(d).on("click","#meta-broadcast-button",function(){console.log("open"),d.find(".meta-broadcast-box").sbShowLightbox()}),S(d).on("click",".sb-top .sb-btn-back",function(){U.mobileCloseConversation()}),S(window).width()<555&&S(l).find("th:first-child").html(E("Order by")),S(l).on("click","th:first-child",function(){S(this).parent().toggleClass("sb-active")})),S(y).on("click","> .sb-btn-collapse, .collapse",function(){S(this).toggleClass("sb-active"),y.find(S(this).hasClass("sb-left")?".sb-admin-list":".sb-top").toggleClass("sb-active")}),S(y).on("click",".sb-conversation",function(){S(".sb-admin-list, .sb-btn-collapse.sb-left.bi-arrow-left-short.sb-active").removeClass("sb-active")}),S(y).on("click",".sb-list, .sb-editor",function(){S(".sb-admin-list, .sb-btn-collapse.sb-left.bi-arrow-left-short.sb-active").removeClass("sb-active"),S(".sb-user-details.sb-top.sb-active, .sb-top.sb-active").removeClass("sb-active")}),S(s).on("click"," .sb-admin-nav a",function(){var e=S(this).attr("id");switch(s.find(".sb-admin-nav a").sbActive(!1),d.find(" > main > div").sbActive(!1),d.find("."+S(this).attr("id").replace("sb-","sb-area-")).sbActive(!0),S(this).sbActive(!0),SBF.deactivateAll(),e){case"sb-conversations":C||SBF.getURL("conversation")||U.clickFirst(),U.update(),U.startRealTime(),D.stopRealTime();break;case"sb-users":D.startRealTime(),U.stopRealTime(),D.init||(L(),oe=ne=1,SBF.ajax({function:"get-users",user_types:["user","visitor","lead"],extra:D.table_extra},e=>{D.populate(e),D.updateMenu(),D.init=!0,D.datetime_last_user=SBF.dateDB("now"),L(!1)}));break;case"sb-settings":R.init||(L(),SBF.ajax({function:"get-all-settings"},e=>{if(e){var t,a=e["external-settings-translations"];for(t in R.initHTML(e),R.translations.translations=Array.isArray(a)&&!a.length?{}:a,delete e["external-settings-translations"],e)R.set(t,e[t])}R.initPlugins(),L(!(R.init=!0))})),D.stopRealTime(),U.stopRealTime();break;case"sb-reports":x.sbLoading()&&S.getScript(STMBX_URL+"/vendor/moment.min.js",()=>{S.getScript(STMBX_URL+"/vendor/daterangepicker.min.js",()=>{S.getScript(STMBX_URL+"/vendor/chart.min.js",()=>{N.initDatePicker(),N.initReport("conversations"),x.sbLoading(!1)})})}),D.stopRealTime(),U.stopRealTime()}var e=e.substr(3),t=SBF.getURL("area");"reports"==e&&S("#"+N.active_report).click(),t!=e&&("conversations"==e&&!SBF.getURL("conversation")||"users"==e&&!SBF.getURL("user")||"settings"==e&&!SBF.getURL("setting")||"reports"==e&&!SBF.getURL("report"))&&ve("?area="+e)}),S(s).on("click",".sb-profile",function(){S(this).next().toggleClass("sb-active")}),S(s).on("click",'[data-value="logout"],.logout',function(){G.is_logout=!0,SBF.ajax({function:"on-close"}),D.stopRealTime(),U.stopRealTime(),SBF.logout()}),S(s).on("click",'[data-value="edit-profile"],.edit-profile',function(){L();let e=new SBUser({id:SB_ACTIVE_AGENT.id});e.update(()=>{$(e),y.find(".sb-board").addClass("sb-no-conversation"),_.find(".sb-active").sbActive(!1),j.showEdit(e)})}),S(s).on("click",'[data-value="status"]',function(){D.setActiveAgentStatus(!S(this).hasClass("sb-online"))}),S(s).find(".sb-account").setProfile(SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image),S(_).on("click","li",function(){(new SBMessage).setLoad(30),U.openConversation(S(this).attr("data-conversation-id"),S(this).attr("data-user-id"),!1),SBF.deactivateAll()}),S(d).on("click",".sb-user-conversations li",function(){U.openConversation(S(this).attr("data-conversation-id"),$().id,S(this).attr("data-conversation-status"))}),S(y).on("click",".sb-top ul a",function(){let t=-1,e="The conversation will be ",a=S(this).attr("data-value");document.querySelectorAll("ul.sorting-by-last-message li");let i=SBChat.conversation.id;switch(a){case"inbox":t=0,e+="restored.";break;case"archive":e+="archived.",t=3;break;case"follow-up":e+="assigned for follow-up.",t=6;break;case"delete":e+="moved to the Bot container. Bot flow restarted.",t=4;break;case"empty-trash":t=5,e="The bot will permanently delete all conversations in the container, including their messages.";break;case"transcript":U.transcript(i,S(this).attr("data-action"));break;case"read":t=0,e+="marked as read.";break;case"unread":t=2,e+="marked as unread."}-1!=t&&F(e,"alert",function(){SBF.ajax({function:"update-conversation-status",conversation_id:i,status_code:t},()=>{if([0,3,4,6].includes(t))for(var e=0;e<w.length;e++)if(w[e].conversation_id==i){w[e].conversation_status_code=t;break}SB_ADMIN_SETTINGS["close-message"]&&3==t&&(SBF.ajax({function:"close-message",conversation_id:i,bot_id:SB_ADMIN_SETTINGS["bot-id"]}),SB_ADMIN_SETTINGS["close-message-transcript"])&&U.transcript(i,"email"),[0,2].includes(t)&&(_.find(".sb-active").attr("data-conversation-status",t),U.setReadIcon(t)),"inbox"!=a&&[0,2].includes(t)||(P.eq(0).find("li.sb-active").click(),P.eq(0).find("ul").sbActive(!1)),M.is("slack")&&[3,4].includes(t)&&SBF.ajax({function:"archive-slack-channels",conversation_user_id:SBChat.conversation.get("user_id")})}),SBChat.conversation&&SBChat.conversation.id==i&&SBChat.conversation.set("conversation_status_code",t)})}),S(function(){S(y).on("click",'ul.sorting-by-last-message li[data-conversation-status="2"]',function(){var e=S(this).attr("data-conversation-id");SBF.ajax({function:"update-conversation-status",conversation_id:e,status_code:0},function(){S(this).attr("data-conversation-status",0),_.find(".sb-active").attr("data-conversation-status",0),U.setReadIcon(0)});var e=S(this).find(".sb-name.span-profile-detail"),t=e.text();20<t.length&&e.text(t.slice(0,17)+"...")}),S(y).on("click",".sb-top .open-profile",function(){S([y.find(".sb-user-details"),this]).toggleClass("sb-active")})}),SBF.ajax({function:"saved-replies"},e=>{let t=`<p class="sb-no-results">${E("No saved replies found. Add new saved replies via Settings > Admin")}</p>`;if(Array.isArray(e)&&0<e.length&&e[0]["reply-name"]){t="",B=e;for(var a=0;a<e.length;a++)t+=`<li><div>${"/"+e[a]["reply-name"]}</div><div>${e[a]["reply-text"]}</div></li>`}te.find(".sb-replies-list > ul").html(t).sbLoading(!1)}),S(y).on("click","#load-saved-replies",function(){te.sbTogglePopup(this)}),S(te).on("click",".sb-replies-list li",function(){SBChat.insertText(S(this).find("div:last-child").html()),SBF.deactivateAll(),d.removeClass("sb-popup-active")}),S(te).on("input",".sb-search-btn input",function(){let i=S(this).val().toLowerCase();SBF.search(i,()=>{let e="";for(var t=!(1<i.length),a=0;a<B.length;a++)(t||B[a]["reply-name"].toLowerCase().includes(i)||B[a]["reply-text"].toLowerCase().includes(i))&&(e+=`<li><div>${B[a]["reply-name"]}</div><div>${B[a]["reply-text"]}</div></li>`);te.find(".sb-replies-list > ul").html(e)})}),S(y).on("click","#set-status",function(){ae.sbTogglePopup(this)}),S(q).find(".sb-scroll-area").on("scroll",function(){if(!ce&&!U.is_search&&be(this,!0)&&se){let e=y.find(".sb-admin-list");var t=U.filters();ce=!0,e.append('<div class="sb-loading-global sb-loading"></div>'),SBF.ajax({function:"get-conversations",pagination:ie,status_code:t[0],user_type:"agent",department:t[1],source:t[2],tag:t[3]},t=>{if(setTimeout(()=>{ce=!1},500),se=t.length,t.sort(function(e,t){return new Date(t.creation_time).getTime()-new Date(e.creation_time).getTime()}),se){let e="";for(var a=0;a<se;a++)e+=U.getListCode(t[a],"append"),w.push(t[a]);ie++,_.append(e),U.positionList(),be(this,!1,1e3)}e.find(" > .sb-loading").remove(),SBF.event("SBAdminConversationsLoaded",{conversations:t})})}}),S(document).on("SBMessageDeleted",function(){var e=SBChat.conversation.getLastMessage();0!=e?(e.details.conversation_id,new Date(e.details.creation_time).getTime(),U.newMsgTop(e.details,"add"),_.find("li.sb-active p").html(e.message),_.find("li.sb-active .sb-profile .sb-time").html(e.details.creation_time)):(U.newMsgTop({conversation_id:SBChat.conversation.id},"deleted"),_.find("li.sb-active").remove(),U.clickFirst(),U.scrollTo())}),S(document).on("SBMessageSent",function(e,t){let a=t.conversation_id;var i=_.find(`[data-conversation-id="${a}"]`);let s=E("Error. Message not sent to");var n=t.conversation,o=t.user,i=(t.message&&i.find("p").html(t.message),-1!=t.conversation_status_code&&(i.attr("data-conversation-status",t.conversation_status_code),U.updateMenu()),M.messenger.check(n)&&M.messenger.send(o.getExtra("facebook-id").value,n.get("extra"),t.message,t.attachments,t.message_id,e=>{e&&"error"in e&&F(s+" Messenger: "+e.error.message,"info")}),SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"])),i=(M.whatsapp.check(n)&&M.whatsapp.send(M.whatsapp.activeUserPhone(o),"[rating]"===t.message?i:t.message,t.attachments,n.get("extra"),e=>{e&&!e.error?T("<i class='bi-wind'></i> Message ent successfully"):T("<i class='bi-send-exclamation'></i> Message could not be sent to API Cloud","warning")},e=>{T("<i class='bi-info-circle'></i> Failed to send message. Please try again later","warning"),console.error("Error sending message to WhatsApp:",e)}),SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"])),i=(M.whatsmeow.check(n)&&(t.message_id,"[rating]"==t.message&&(t.message=i),M.whatsmeow.send(M.whatsapp.activeUserPhone(o),t.message,t.attachments,n.get("extra"),e=>{e.status?T("<i class='bi-whatsapp'></i> Message Sent to WhatsApp mobile"):T("<i class='bi-send-exclamation'></i> Message could not be sent. Please check your connection. ","warning")},e=>{T("<i class='bi-info-circle'></i> Error with WhatsApp API. Please check your connection. ","error")})),SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"]));M.waweb.check(n)&&(t.message_id,"[rating]"==t.message&&(t.message=i),M.waweb.send(M.whatsapp.activeUserPhone(o),t.message,t.attachments,n.get("extra"),e=>{e.status?T("<i class='bi-whatsapp'></i> Message Sent to WhatsApp mobile"):T("<i class='bi-send-exclamation'></i> Message could not be sent. Please check your connection. ","warning")},e=>{T("<i class='bi-info-circle'></i> Error with WhatsApp API. Please check your connection. ","error")})),M.telegram.check(n)&&("[rating]"==t.message&&(t.message=i),M.telegram.send(n.get("extra"),t.message,t.attachments,e=>{"ok"in e&&e.ok||F(s+" Telegram: "+JSON.stringify(e),"info")})),M.twitter.check(n)&&("[rating]"==t.message&&(t.message=i),M.twitter.send(o.getExtra("twitter-id").value,t.message,t.attachments,e=>{!e||"event"in e?1<t.attachments.length&&T("Only the first attachment was sent to Twitter.","info"):F(JSON.stringify(e),"info")})),M.gbm.check(n)&&("[rating]"==t.message&&(t.message=i),M.gbm.send(o.getExtra("gbm-id").value,t.message,t.attachments,e=>{e[0]&&"error"in e[0]&&F(s+" Google: "+e[0].error.message,"info")})),SB_ADMIN_SETTINGS["smart-reply"]&&V.html(""),SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&SBF.null(n.get("agent_id"))&&U.assignAgent(a,SB_ACTIVE_AGENT.id,()=>{SBChat.conversation.id==a&&(SBChat.conversation.set("agent_id",SB_ACTIVE_AGENT.id),S(y).find("#conversation-agent > p").attr("data-value",SB_ACTIVE_AGENT.id).html(SB_ACTIVE_AGENT.full_name))})}),S(document).on("SBNewMessagesReceived",function(e,i){var s=i.get("payload");let n=y.find(".sb-conversation");var t=SBF.isAgent(i.get("user_type"));if(setTimeout(function(){n.find(".sb-top .sb-status-typing").remove()},300),SB_ADMIN_SETTINGS["smart-reply"]&&(t?SB_ADMIN_SETTINGS["smart-reply-agent-assistant"]&&M.dialogflow.smartReplyUpdate(i.message):M.dialogflow.smartReply(i.message)),G.must_translate){let t=SBChat.conversation.getMessage(i.id),a=n.find(`[data-id="${i.id}"]`);var o="original-message"in s&&s["original-message"];o?(t.set("translation",o),a.replaceWith(t.getCode(!0)),n.find(`[data-id="${i.id}"] .sb-menu`).prepend(`<li data-value="original">${E("View translation")}</li>`)):i.message&&M.dialogflow.translate([i.message],SB_ADMIN_SETTINGS["active-agent-language"],e=>{e&&(t.set("translation",e[0].translatedText),a.replaceWith(t.getCode(!0)),n.find(`[data-id="${i.id}"] .sb-menu`).prepend(`<li data-value="original">${E("View original message")}</li>`))})}if("queryResult"in s&&"fulfillmentMessages"in s.queryResult)for(var a=s.queryResult.fulfillmentMessages,r=0;r<a.length;r++)if("payload"in a[r]){var l=a[r].payload;if("department"in l){U.setActiveDepartment(l.department);break}if("agent"in l){U.setActiveAgent(l.agent);break}}"ErrorCode"in s&&F("Error. Message not sent to WhatsApp. Error message: "+s.ErrorMessage,"info"),"whatsapp-fallback"in s&&T("Message sent as text message."+("whatsapp-template-fallback"in s?" The user has been notified via WhatsApp Template notification.":"")),"whatsapp-template-fallback"in s&&!("whatsapp-fallback"in s)&&T("The user has been notified via WhatsApp Template notification."),t||SBChat.conversation.id!=i.get("conversation_id")||SBChat.user_online||D.setActiveUserStatus(),U.update()}),S(document).on("SBNewConversationCreated",function(){U.update()}),S(document).on("SBEmailSent",function(){T("The user has been notified by email.")}),S(document).on("SBSMSSent",function(){T("The user has been notified by text message.")}),S(document).on("SBNotificationsSent",function(e,t){T(`The user has been notified by email${t.includes("sms")?" and text message":""}.`)}),S(document).on("SBTyping",function(e,t){U.typing(t)}),S(q).on("input",".sb-search-btn input",function(){U.search(this)}),S(y).on("click",".sb-admin-list .sb-search-btn i",function(){SBF.searchClear(this,()=>{U.search(S(this).next())}),S(".non-hover, .sb-filter-btn").toggleClass("sb-hide"),S("#hideOnSearchClick").toggleClass("sb-hide")}),S(".bi-search").click(function(){S("#hideOnSearchClick li:first-child").toggleClass("sb-invisible").find("div").toggle(),S("#hideOnSearchClick li:nth-child(2)").toggleClass("sb-invisible").css("margin-right",function(e,t){return"80px"===t?"0px":"80px"})}),S(y).on("click",".sb-admin-list .sb-select li",function(){let a=_.parent();I(a)||setTimeout(()=>{let t=U.filters();se=ie=1,SBF.ajax({function:"get-conversations",status_code:t[0],department:t[1],agent:SB_ACTIVE_AGENT.id,source:t[2],tag:t[3]},e=>{U.populateList(e),y.find(".sb-conversation").attr("data-conversation-status",t[0]),e.length?C||(SBChat.conversation?(e=_.find(`[data-conversation-id="${SBChat.conversation.id}"]`)).length?e.sbActive(!0):t[0]==SBChat.conversation.get("conversation_status_code")&&_.prepend(U.getListCode(SBChat.conversation).replace("<li",'<li class="sb-active"')):(U.clickFirst(),U.scrollTo())):(y.find(".sb-board").addClass("sb-no-conversation"),SBChat.conversation=!1),a.sbLoading(!1)})},100)}),S(y).on("click",".sb-user-details .sb-scroll-area div.sb-profile",function(){var e=_.find(".sb-active").attr("data-user-id");$().id!=e&&$(k[e]),j.show($().id)}),S(d).on("click",'.sb-profile-list [data-id="location"]',function(){F('<iframe src="https://maps.google.com/maps?q='+S(this).find("label").html().replace(", ","+")+'&output=embed"></iframe>',"map")}),S(d).on("click",'.sb-profile-list [data-id="address"], .sb-profile-list [data-id="city"], .sb-profile-list [data-id="country"]',function(){let e="",t="",a="";"address"===S(this).data("id")?(e=S(this).find("label").text(),t=S('.sb-profile-list [data-id="city"] label').text(),a=S('.sb-profile-list [data-id="country"] label').text()):"city"===S(this).data("id")?(e=S('.sb-profile-list [data-id="address"] label').text(),t=S(this).find("label").text(),a=S('.sb-profile-list [data-id="country"] label').text()):"country"===S(this).data("id")&&(e=S('.sb-profile-list [data-id="address"] label').text(),t=S('.sb-profile-list [data-id="city"] label').text(),a=S(this).find("label").text()),F(`<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(`${e}, ${t}, `+a)}&output=embed"></iframe>`,"map")}),S(d).on("click",'.sb-profile-list [data-id="timezone"]',function(){SBF.getLocationTimeString($().extra,e=>{L(!1),F(e,"info")})}),S(d).on("click",'.sb-profile-list [data-id="current_url"]',function(){var e=S(this).find("label");window.open(SBF.null(e.attr("data-value"))?e.html():e.attr("data-value"))}),S(d).on("click",'.sb-profile-list [data-id="conversation-source"]',function(e){var t=S(this).find("option:selected").html().toLowerCase();"whatsapp"!=t&&"whatsmeow"!=t&&"waweb"!=t||$().getExtra("phone")}),S(y).on("click",'.sb-menu [data-value="bot"]',function(){M.dialogflow.showCreateIntentBox(S(this).closest("[data-id]").attr("data-id"))}),S(p).on("click",'.sb-intent-add [data-value="add"]',function(){p.find("> div > .sb-type-text").last().after('<div class="sb-input-setting sb-type-text"><input type="text"></div>')}),S(p).on("click",'.sb-intent-add [data-value="previous"],.sb-intent-add [data-value="next"]',function(){for(var e=p.find(".sb-first input"),t=e.val(),a="next"==S(this).attr("data-value"),i=SBChat.conversation.getUserMessages(),s=i.length,n=0;n<s;n++)if(i[n].message==t&&(a&&n<s-1||!a&&0<n)){n+=a?1:-1,e.val(i[n].message),p.attr("data-message-id",i[n].id);break}}),S(p).on("click",".sb-send",function(){M.dialogflow.submitIntent(this)}),S(p).on("input",".sb-search-btn input",function(){M.dialogflow.searchIntents(S(this).val())}),S(p).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{M.dialogflow.searchIntents(S(this).val())})}),S(p).on("click","#sb-intent-preview",function(){M.dialogflow.previewIntent(p.find("#sb-intents-select").val())}),S(p).on("change","#sb-intents-select",function(){p.find(".sb-bot-response").css("opacity",S(this).val()?.5:1)}),S(y).on("click","#conversation-department li",function(e){let t=S(this).parent().parent();return S(this).data("value")==t.find(" > p").attr("data-value")||(SBChat.conversation?t.sbLoading()||F(`${E("All agents assigned to the new department will be notified. The new department will be")} ${S(this).html()}.`,"alert",()=>{let e=S(this).data("id");t.sbLoading(!0),U.assignDepartment(SBChat.conversation.id,e,()=>{U.setActiveDepartment(e),t.sbLoading(!1),t.find(" > p").attr("data-value",e)})}):S(this).parent().sbActive(!1),e.preventDefault(),!1)}),S(y).on("click","#conversation-agent li",function(e){let t=S(this).parent().parent(),a=S(this).data("id");return a==t.find(" > p").attr("data-value")||a==SB_ACTIVE_AGENT.id||(SBChat.conversation?t.sbLoading()||F(`${E("The new agent will be")} ${S(this).html()}.`,"alert",()=>{t.sbLoading(!0),U.assignAgent(SBChat.conversation.id,a,()=>{U.setActiveAgent(a),SBChat.conversation.set("conversation_status_code",6);var e=_.find(`[data-conversation-id="${SBChat.conversation.id}"]`),e=(e.attr("data-conversation-status","6"),e.find(".sb-status")),e=(e.length&&e.attr("data-sb-status","6"),w.findIndex(e=>e.id===SBChat.conversation.id));-1!==e&&(w[e].conversation_status_code=6),U.update(),U.updateMenu(),y.find(".sb-conversation-details").sbActive()&&U.updateConversationDetails(),t.sbLoading(!1)})}):S(t).addClass("sb-active sb-responsive-absolute-position"),e.preventDefault(),!1)}),O.on("click","> i",function(e){return d.find(".sb-notes-box").sbShowLightbox(),S.getScript("https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js").done(()=>{i()}).fail(()=>{S.getScript(STMBX_URL+"/vendor/moment.min.js",()=>{i()})}),e.preventDefault(),!1}),O.on("click",".sb-delete-note",function(){let t=S(this).parents().eq(1);U.notes.delete(SBChat.conversation.id,t.attr("data-id"),e=>{!0===e?t.remove():SBF.error(e)})}),O.on("click",".sb-note-contain",function(){var e=S(this).find(".note-content .more"),t=S(this).find(".note-content .dots");"none"==e.css("display")?e.show():e.hide(),"none"==e.css("display")?t.show():t.hide()}),S(d).on("click",".sb-add-note",function(){let t=S(this).parent().parents().eq(1).find("textarea"),a=t.val();0==a.length?SBForm.showErrorMessage(d.find(".sb-notes-box"),"Please write something..."):I(this)||U.notes.add(SBChat.conversation.id,SB_ACTIVE_AGENT.id,SB_ACTIVE_AGENT.full_name,a,e=>{Number.isInteger(e)?(S(this).sbLoading(!1),d.sbHideLightbox(),U.notes.update([{id:e,conversation_id:SBChat.conversation.id,user_id:SB_ACTIVE_AGENT.id,name:SB_ACTIVE_AGENT.full_name,message:a,alert:S("#alertdate").val(),time_zone:S("#zones").val(),status:!1}],!0),t.val(""),T("New note successfully added."),i()):SBForm.showErrorMessage(e)})}),z.on("click","> i",function(e){let t=S(d).find(".sb-tags-box"),a=t.find(".sb-tags-cnt"),i="",s=SBChat.conversation.details.tags,n='<i id="sb-add-tag" class="bi-plus-lg sb-btn-icon"></i>';for(var o=0;o<s.length;o++)i+=`<span class="sb-active">${s[o]}</span>`;return U.tags.list?a.html(i+U.tags.getAll(s)+n):(t.sbLoading(!0),SBF.ajax({function:"get-tags"},e=>{U.tags.list=e,a.html(i+U.tags.getAll(s)+n),t.sbLoading(!1)})),t.sbShowLightbox(),e.preventDefault(),!1}),S(document).on("click","#tags-container.tagged > span",function(){let t=S(this);t.text();var e=SBChat.conversation.id;SBF.ajax({function:"update-tags",conversation_id:e,tags:[null]},e=>{T(!0===e[0]?"The bot is deleting tags in database...":e),!0===e[0]&&(t.remove(),S(".sb-tags-box .sb-tags-cnt span.sb-active").remove())})}),S(d).on("click",".sb-tags-cnt > span",function(){S(this).toggleClass("sb-active")}),S(d).on("click","#sb-add-tag",function(){S('<input type="text">').insertBefore(this)}),S(d).on("click","#sb-save-tags",function(){if(!I(this)){let a=d.find(".sb-tags-box").find("span.sb-active,input").map(function(){return S(this).is("span")?S(this).html():S(this).val()}).toArray(),i=SBChat.conversation.id;SBF.ajax({function:"update-tags",conversation_id:i,tags:a},e=>{var t;S(this).sbLoading(!1),U.tags.list=e[1],!0===e[0]&&(U.tags.update(a),SBChat.conversation)&&i==SBChat.conversation.id&&(t=U.filters()[3],SBChat.conversation.set("tags",a),t)&&!a.includes(t)&&(_.find(`[data-conversation-id="${i}"]`).remove(),U.clickFirst()),d.sbHideLightbox(),T(!0===e[0]?"Tags have been successfully updated.":e)})}}),S(V).on("click","span",function(){SBChat.insertText(S(this).html()),V.html("")}),S(y).on("click",".sb-list .sb-menu > li",function(){let e=S(this).closest("[data-id]"),t=e.attr("data-id");var a=SBChat.conversation.getMessage(t).get("user_type"),i=S(this).attr("data-value");switch(i){case"delete":SBChat.user_online?SBF.ajax({function:"update-message",message_id:t,message:"",attachments:[],payload:{event:"delete-message"}},()=>{SBChat.conversation.deleteMessage(t),e.remove()}):SBChat.deleteMessage(t);break;case"translation":case"original":var s="translation"==i,n=SBF.isAgent(a);e.replaceWith(SBChat.conversation.getMessage(t).getCode(s)),y.find(`[data-id="${t}"] .sb-menu`).prepend(`<li data-value="${s?"original":"translation"}">${E(n&&!s||!n&&s?"View original message":"View translation")}</li>`)}}),S(y).on("click",".sb-filter-btn i",function(){S(this).parent().toggleClass("sb-active")}),SBF.getURL("user")&&(s.find(".sb-admin-nav #sb-users").click(),setTimeout(()=>{j.show(SBF.getURL("user"))},500)),S(l).on("click","th :checkbox",function(){l.find("td :checkbox").prop("checked",S(this).prop("checked"))}),S(l).on("click",":checkbox",function(){var e=o.find('[data-value="delete"]');l.find("td input:checked").length?e.removeAttr("style"):e.hide()}),S(h).on("click","li",function(){D.filter(S(this).data("type"))}),S(o).on("input",".sb-search-btn input",function(){D.search(this)}),S(o).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{D.search(S(this).next())})}),S(l).on("click","th:not(:first-child)",function(){var e=S(this).hasClass("sb-order-asc")?"DESC":"ASC";S(this).toggleClass("sb-order-asc"),S(this).siblings().sbActive(!1),S(this).sbActive(!0),D.sort(S(this).data("field"),e)}),S(l).parent().on("scroll",function(){!ce&&!D.search_query&&be(this,!0)&&oe&&(ce=!0,o.append('<div class="sb-loading-global sb-loading sb-loading-pagination"></div>'),SBF.ajax({function:"get-users",pagination:ne,sorting:D.sorting,user_types:D.user_types,search:D.search_query,extra:D.table_extra},t=>{if(setTimeout(()=>{ce=!1},500),oe=t.length){let e="";for(var a=0;a<oe;a++){var i=new SBUser(t[a],t[a].extra);e+=D.getRow(i),k[i.id]=i}ne++,l.find("tbody").append(e),be(this,!1,1e3)}o.find(" > .sb-loading-pagination").remove()}))}),S(g).on("click",".sb-delete",function(){F("This user will be deleted permanently including all linked data, conversations, and messages.","alert",function(){D.delete($().id)})}),S(l).on("click","td:not(:first-child)",function(){j.show(S(this).parent().attr("data-user-id"))}),S(r).on("click",".sb-top-bar .sb-edit",function(){j.showEdit($())}),S(o).on("click",".sb-new-user",function(){g.addClass("sb-user-new"),g.find(".sb-top-bar .sb-profile span").html(E("Add new user")),g.find(".sb-top-bar .sb-save").html('<i class="bi-check-lg"></i>'+E("Add user")),g.find("input,select,textara").removeClass("sb-error"),"admin"==SB_ACTIVE_AGENT.user_type&&g.find("#user_type").find("select").html(`<option value="lead">${E("Lead")}</option><option value="agent">${E("Agent")}</option><option value="admin">${E("Admin")}</option>`),j.clear(g),j.boxClasses(g),j.updateRequiredFields("user"),g.sbShowLightbox()}),S(g).on("click",".sb-save",function(){if(!I(this)){let t=!!g.hasClass("sb-user-new"),a=g.attr("data-user-id");var e=j.getAll(g.find(".sb-details")),i=j.getAll(g.find(".sb-additional-details"));j.errors(g)?(j.showErrorMessage(g,SBF.isAgent(g.find("#user_type :selected").val())?"First name, last name, password and a valid email are required. Minimum password length is 8 characters.":g.hasClass("sb-user-new")?"First name, last name, and a valid email are required.":`First name and last name ${"user"==e.user_type[0]||"lead"==e.user_type[0]?"email":""} are required.`),S(this).sbLoading(!1)):SBF.ajax({function:t?"add-user":"update-user",user_id:a,settings:e,settings_extra:i},e=>{SBF.errorValidation(e,"duplicate-email")||SBF.errorValidation(e,"duplicate-phone")?(j.showErrorMessage(g,`This ${SBF.errorValidation(e,"duplicate-email")?"email":"phone number"} is already in use.`),S(this).sbLoading(!1)):(t&&(a=e,$(new SBUser({id:a}))),$().update(()=>{k[a]=$(),t?(j.clear(g),D.update()):(D.updateRow($()),y.sbActive()&&U.updateUserDetails(),a==SB_ACTIVE_AGENT.id&&(SBF.loginCookie(e[1]),SB_ACTIVE_AGENT.full_name=$().name,SB_ACTIVE_AGENT.profile_image=$().image,s.find(".sb-account").setProfile())),S(this).sbLoading(!1),g.find(".sb-profile").setProfile(),T(t?"New user added":"User updated"),d.sbHideLightbox()}),SBF.event("SBUserUpdated",{new_user:t,user_id:a}))})}}),S(".sb-area-users").on("click","#csv_contacts",function(){S("#csvimport").click()}),S("#csvimport").on("change",function(e){var t=new FormData;t.append("csv",this.files[0]),t.append("function","csv-users-add"),event.preventDefault(),S.ajax({url:STMBX_URL+"/include/ajax.php",method:"POST",data:t,dataType:"json",contentType:!1,cache:!1,processData:!1,success:function(e){T(e.success),S("#csvimport").val("")},error:function(e,t,a){SBF.error("csv-users-add",a),S("#csvimport").val("")}})}),S(g).on("change","#user_type",function(){var e=S(this).find("option:selected").val();j.boxClasses(g,e),j.updateRequiredFields(e)}),S(r).on("click",".sb-user-conversations li",function(){U.open(S(this).attr("data-conversation-id"),S(this).find("[data-user-id]").attr("data-user-id"))}),S(r).on("click",".sb-start-qr-conversation",function(){U.open(-1,$().id),U.openConversation(-1,$().id),C&&U.mobileOpenConversation()}),S(r).on("click",".sb-start-tk-conversation",function(){U.open(-1,$().id),U.openConversation(-1,$().id),C&&U.mobileOpenConversation()}),S(r).on("click",".sb-start-conversation",function(){U.open(-1,$().id),U.openConversation(-1,$().id),C&&U.mobileOpenConversation(),SBChat.sendMessage(-1,!1,!1,!1),d.find(".sb-send-template-box").sbShowLightbox()}),S(r).on("click",".sb-top-bar [data-value]",function(){U.showDirectMessageBox(S(this).attr("data-value"),[$().id])}),S(o).on("click",".sb-top-bar [data-value]",function(){var e=S(this).data("value");let t=[];switch(l.find("tr").each(function(){S(this).find('td input[type="checkbox"]').is(":checked")&&t.push(S(this).attr("data-user-id"))}),e){case"message":case"email":case"sms":U.showDirectMessageBox(e,t);break;case"csv":D.csv();break;case"delete":if(t.includes(SB_ACTIVE_AGENT.id))return T("You cannot delete yourself.","error");F("The bot will delete all selected users and their related data, conversations, and messages permanently.","alert",()=>{D.delete(t),S(this).hide(),l.find("th:first-child input").prop("checked",!1)})}}),S(d).on("change",".sb-select",function(){console.log("sb-select change event triggered");var e=S(this).val();S(this).closest(".sb-direct-message-box").attr("data-type",e)}),S(d).on("click",".sb-send-direct-message",function(e){console.log("sb-send-direct-message click event triggered"),e.preventDefault();let i=S(this).closest(".sb-direct-message-box"),s=i.attr("data-type"),n=i.find(".sb-direct-message-subject input").val(),o=i.find("textarea").val(),r=i.find(".sb-direct-message-users").val().replace(/ /g,""),t=null;if(console.log("Type:",s),console.log("Subject:",n),console.log("Message:",o),console.log("User IDs:",r),"template"===s&&(t=(new Metatemplate).payload("#user-template-form"),console.log("Payload:",t)),!I(this))if("message"==s&&SBF.ajax({function:"direct-message",user_ids:r,message:o},e=>{S(this).sbLoading(!1);let t=SB_ADMIN_SETTINGS["notify-user-email"],a=SB_ADMIN_SETTINGS["sms-active-users"];if(SBF.errorValidation(e))return SBForm.showErrorMessage(i,"An error has occurred. Please make sure all user ids are correct.");(t||a)&&SBF.ajax({function:"get-users-with-details",user_ids:r,details:t&&a?["email","phone"]:[t?"email":"phone"]},e=>{t&&e.email.length?c(e.email,o,0,a?e.phone:[],"email",n):a&&e.phone.length?c(e.phone,o,0,[],"sms"):d.sbHideLightbox()}),T(SBF.slugToString(s)+" sent to all users.")}),"template"==s)console.log("Sending messages..."),SBF.ajax({function:"direct-message",user_ids:r,message:o,template:"template"===s,payload:t},e=>{if(console.log("Direct message response:",e),S(this).sbLoading(!1),SBF.errorValidation(e))return console.log("Error validation occurred"),SBForm.showErrorMessage(i,"An error has occurred. Please make sure all user IDs are correct.");if(e.template_phone)c(e.template_phone,t.BodyTemplate,0,[],"template");else{let t=SB_ADMIN_SETTINGS["notify-user-email"],a=SB_ADMIN_SETTINGS["sms-active-users"];(t||a)&&(console.log("Getting users with details..."),SBF.ajax({function:"get-users-with-details",user_ids:r,details:t&&a?["email","phone"]:[t?"email":"phone"]},e=>{console.log("Users with details response:",e),t&&e.email.length?c(e.email,o,0,a?e.phone:[],"email",n):a&&e.phone.length?c(e.phone,o,0,[],"sms"):d.sbHideLightbox()})),T(SBF.slugToString(s)+" sent to all users.")}});else{console.log("Type is not 'message', getting users with details...");let t="email"==s?"email":"phone";SBF.ajax({function:"get-users-with-details",user_ids:r,details:[t]},e=>{if(console.log("Users with details response:",e),!e[t].length)return S(this).sbLoading(!1),SBForm.showErrorMessage(i,"No users found.");c(e[t],o,0,[],"email"==s?"custom-email":"sms",n)})}}),SBF.getURL("setting")&&(s.find(".sb-admin-nav #sb-settings").click(),setTimeout(()=>{f.find("#tab-"+SBF.getURL("setting")).click()},300)),S(f).on("click"," > .sb-tab > .sb-nav [id]",function(){var e=S(this).attr("id").substr(4);SBF.getURL("setting")!=e&&ve("?setting="+e)}),S(f).on("click",'[data-type="upload-image"] .image',function(){Y=this,d.find(".sb-upload-form-admin .sb-upload-files").click()}),S(f).on("click",'[data-type="upload-image"] .image > i',function(e){return S(this).parent().removeAttr("data-value").css("background-image",""),e.preventDefault(),!1}),S(f).on("click",".sb-repeater-add",function(){R.repeaterAdd(this)}),S(f).on("click",".repeater-item > i",function(){R.repeaterDelete(this)}),R.initColorPicker(),S(f).find('[data-type="color"]').focusout(function(){let e=S(this).closest(".input-color"),t=e.find("input").val();setTimeout(function(){e.find("input").val(""),e.find(".color-preview").css("background-color",t)},300),R.set(S(this).attr("id"),t)}),S(f).on("click",".sb-type-color .input i",function(e){S(this).parent().find("input").removeAttr("style").val("")}),S(f).on("click",".sb-color-palette span",function(){var e=S(this).hasClass("sb-active");S(this).closest(".sb-repeater").find(".sb-active").sbActive(!1),S(this).sbActive(!e)}),S(f).on("click",".sb-color-palette ul li",function(){S(this).parent().parent().attr("data-value",S(this).data("value")).find("span").sbActive(!1)}),S(f).on("click",'[data-type="select-images"] .input > div',function(){S(this).siblings().sbActive(!1),S(this).sbActive(!0)}),S(f).on("click",".sb-select-checkbox-input",function(){S(this).toggleClass("sb-active")}),S(f).on("click",".sb-select-checkbox input",function(){var e=S(this).closest("[data-type]");e.find(".sb-select-checkbox-input").val(R.get(e)[1].join(", "))}),S(f).on("click",".sb-save-changes",function(){R.save(this)}),S(f).on("change",'#user-additional-fields [data-id="extra-field-slug"], #saved-replies [data-id="reply-name"], [data-id="rich-message-name"]',function(){S(this).val(SBF.stringToSlug(S(this).val()))}),S(f).on("click","#timetable-utc input",function(){""==S(this).val()&&S(this).val(Math.round(le.getTimezoneOffset()/60))}),S(f).on("click","#test-email-user .sb-btn, #test-email-agent .sb-btn",function(){var e=S(this).parent().find("input").val();e&&0<e.indexOf("@")&&!I(this)&&SBF.ajax({function:"send-test-email",to:e,email_type:"test-email-user"==S(this).parent().parent().attr("id")?"user":"agent"},()=>{F("Email successfully sent. Check your emails!","info"),S(this).sbLoading(!1)})}),S(f).on("click",".sb-timetable > div > div > div",function(){var e=S(this).closest(".sb-timetable"),t=S(this).sbActive();S(e).find(".sb-active").sbActive(!1),t?S(this).sbActive(!1).find(".sb-custom-select").remove():(t=S(e).find("> .sb-custom-select").html(),S(e).find(" > div .sb-custom-select").remove(),S(this).append(`<div class="sb-custom-select">${t}</div>`).sbActive(!0))}),S(f).on("click",".sb-timetable .sb-custom-select span",function(){var e=[S(this).html(),S(this).attr("data-value")];S(this).closest(".sb-timetable").find("> div > div > .sb-active").html(e[0]).attr("data-value",e[1]),S(this).parent().sbActive(!1)}),S(f).on("click","#system-requirements a",function(e){let a=d.find(".sb-requirements-box"),i="";return SBF.ajax({function:"system-requirements"},e=>{for(var t in e)i+=`<div class="sb-input"><span>${E(SBF.slugToString(t))}</span><div${e[t]?' class="sb-green"':""}>${e[t]?E("Success"):E("Error")}</div></div>`;L(!1),a.find(".sb-main").html(i),a.sbShowLightbox()}),a.sbActive(!1),L(!0),e.preventDefault(),!1}),S(f).on("click","#sb-path a",function(e){return SBF.ajax({function:"path"},e=>{F(e,"info")}),e.preventDefault(),!1}),S(f).on("click","#delete-leads a",function(e){return S(this).sbLoading()||F("All leads, including all the linked conversations and messages, will be deleted permanently.","alert",()=>{S(this).sbLoading(!0),SBF.ajax({function:"delete-leads"},()=>{F("Leads and conversations successfully deleted.","info"),S(this).sbLoading(!1)})}),e.preventDefault(),!1}),S(f).on("click","#dialogflow-smart-reply-generate a",function(e){if(!I(this))return SBF.ajax({function:"dialogflow-smart-reply-generate-conversations-data"},e=>{F("Conversations data successfully generated. Folder: "+e,"info"),S(this).sbLoading(!1)}),e.preventDefault(),!1}),S(f).on("click","#sb-export-settings a",function(e){if(!I(this))return SBF.ajax({function:"export-settings"},e=>{window.open(e),F(E("For security reasons, delete the settings file after downloading it. Close this window to automatically delete it. File location:")+`<pre>${e}</pre>`,"info",!1,"sb-export-settings-close","Settings exported"),S(this).sbLoading(!1)}),e.preventDefault(),!1}),S(f).on("click","#sb-import-settings a",function(e){if(!I(this))return Y=this,Z=e=>{SBF.ajax({function:"import-settings",file_url:e},e=>{e?T("Settings successfully imported. Reload the admin area to apply the new settings."):F(e,"info"),S(this).sbLoading(!1)}),Z=!1},d.find(".sb-upload-form-admin .sb-upload-files").click(),e.preventDefault(),!1}),S(d).on("click","#sb-export-settings-close .sb-close",function(){SBF.ajax({function:"delete-file",path:d.find(".sb-dialog-box p pre").html()})}),S(f).on("click","#whatsmeow-go-start .sb-btn",function(e){t(e,"start")}),S(f).on("click","#whatsmeow-go-restart .sb-btn",function(e){t(e,"restart")}),S(f).on("click","#waweb-go-start .sb-btn",function(e){a(e,"start")}),S(f).on("click","#waweb-go-restart .sb-btn",function(e){a(e,"restart")}),S(document).ready(function(){S(document).on("click","#get-templates-api .sb-btn",function(e){e.preventDefault(),S.ajax({type:"GET",url:STMBX_URL+"/include/templates.php",success:function(e){F("Meta's WhatsApp Business API Cloud templates loaded successfully.","info")},error:function(e,t,a){F("Meta Business Manager configuration incomplete. Please provide the Business Manager User ID, save, and retry.","info")}})})}),S(f).on("click","#whatsapp-twilio-btn .sb-btn, #sms-btn .sb-btn, #wechat-btn .sb-btn, #twitter-callback .sb-btn, #gbm-webhook .sb-btn",function(e){var t=S(this).closest("[id]").attr("id");return F(`<code style=" margin: auto; word-break: break-word; text-align: center; font-size: .9rem; ">${STMBX_URL+("sms-btn"==t?"/include/api.php":"/apps/"+("wechat-btn"==t?"wechat":"twitter-callback"==t?"twitter":"gbm-webhook"==t?"gbm":"whatsapp")+"/post.php")+me().replace("&","?")}</code>`,"info"),!1}),S(f).on("click","#telegram-button .sb-btn",function(e){var t=f.find("#telegram-token input").val().trim();return e.preventDefault(),!(!t||I(this)||(SBF.ajax({function:"telegram-synchronization",token:t,cloud_token:me()},()=>{F("Telegram Synchronization completed.","info"),S(this).sbLoading(!1)}),1))}),S(f).on("click","#whatsapp-test-template .sb-btn",function(e){e.preventDefault();e=S(this).parent().find("input").val();if(e&&!I(this))return SBF.ajax({function:"whatsapp-send-template",phone:e},e=>{F(e&&("error"in e?e.error.message:"Message sent, check your WhatsApp!"),"info"),S(this).sbLoading(!1)}),!1}),S(f).on("click","#twitter-subscribe .sb-btn",function(e){return e.preventDefault(),I(this)||SBF.ajax({function:"twitter-subscribe",cloud_token:me()},e=>{F(!0===e?"Synchronization completed.":JSON.stringify(e),"info"),S(this).sbLoading(!1)}),!1}),S(f).on("click","#email-piping-sync a",function(e){I(this)||(SBF.ajax({function:"email-piping",force:!0},e=>{F(!0===e?"Syncronization completed.":e,"info"),S(this).sbLoading(!1)}),e.preventDefault())}),S(f).on("click","#tab-automations",function(){R.automations.get(()=>{R.automations.populate(),L(!1)},!0),L()}),S(v).on("click",".sb-add-condition",function(){R.automations.addCondition()}),S(v).on("change",".sb-condition-1 select",function(){R.automations.updateCondition(this)}),S(e).on("click","li",function(){R.automations.populate(S(this).data("value"))}),S(m).on("click","li",function(){R.automations.show(S(this).attr("data-id"))}),S(v).on("click",".sb-add-automation",function(){R.automations.add()}),S(m).on("click","li i",function(){F("The automation will be deleted permanently.","alert",()=>{R.automations.delete(this)})}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("recordButton");var t=document.getElementById("stopButton");const a=document.querySelector(".bi-arrow-up-circle-fill"),i=document.querySelector(".sb-textarea > textarea"),s=document.querySelector(".sb-textarea"),n=document.querySelector(".bi-mic-fill");let o=!0;const r=()=>{o=!0,s.style.visibility="visible"};a.addEventListener("click",()=>{e.style.visibility="visible",a.style.visibility="hidden",r(),n.style.visibility="visible"}),i.addEventListener("input",()=>{""===i.value.trim()?(a.style.visibility="hidden",e.style.visibility="visible"):(a.style.visibility="visible",e.style.visibility="hidden"),r()}),e.addEventListener("click",()=>{n.style.visibility="hidden",o=!o,s.style.visibility=o?"visible":"hidden",setTimeout(()=>{a.style.visibility="visible"},500)}),t.addEventListener("click",()=>{n.style.visibility="visible",r(),setTimeout(()=>{a.style.visibility="visible"},500)})}),S(x).on("click",".sb-nav [id]",function(){var e=S(this).attr("id");N.active_report=!1,x.find("#sb-date-picker").val(""),x.attr("class","sb-area-reports sb-active sb-report-"+e),N.initReport(S(this).attr("id")),SBF.getURL("report")!=e&&ve("?report="+e)}),S(x).on("change","#sb-date-picker",function(){N.initReport(!1,S(this).val())}),SBF.getURL("report")&&(x.sbActive()||s.find(".sb-admin-nav #sb-reports").click(),setTimeout(()=>{x.find("#"+SBF.getURL("report")).click()},500)),S(d).on("click",".sb-language-switcher > i",function(){let e=S(this).parent(),t=e.find("[data-language]").map(function(){return S(this).attr("data-language")}).get(),a=d.find(".sb-languages-box"),i="";for(var s in t.push("en"),SB_LANGUAGE_CODES)t.includes(s)||(i+=`<div data-language="${s}"><img src="${STMBX_URL}/media/flags/${s}.png" />${E(SB_LANGUAGE_CODES[s])}</div>`);Q=e,a.attr("data-source",e.attr("data-source")),a.find(".sb-main").html(i),a.sbShowLightbox()}),S(d).on("click",".sb-language-switcher img",function(){var e=S(this).parent(),t=e.sbActive(),a=!t&&e.attr("data-language");switch(e.parent().attr("data-source")){case"articles":R.articles.show(!1,!1,a);break;case"automations":R.automations.show(!1,a);break;case"settings":var i=e.parent().find("[data-language].sb-active");R.translations.save(e,t?e.attr("data-language"):!!i.length&&i.attr("data-language")),R.translations.activate(e,a)}e.siblings().sbActive(!1),e.sbActive(!t)}),S(d).on("click",".sb-language-switcher span > i",function(){let e=S(this).parent(),t=e.attr("data-language");F(E("The {T} translation will be deleted.").replace("{T}",E(SB_LANGUAGE_CODES[t])),"alert",()=>{switch(e.parent().attr("data-source")){case"articles":R.articles.deleteTranslation(!1,t),R.articles.show();break;case"automations":R.automations.deleteTranslation(!1,t),R.automations.show();break;case"settings":R.translations.delete(e,t)}e.remove()})}),S(d).on("click",".sb-languages-box [data-language]",function(){var e=S(this).parents().eq(1),t=S(this).attr("data-language");switch(e.attr("data-source")){case"articles":R.articles.addTranslation(!1,t),R.articles.show(!1,!1,t);break;case"automations":R.automations.addTranslation(!1,!1,t),R.automations.show(!1,t);break;case"settings":R.translations.add(t)}d.sbHideLightbox()}),S(d).on("click",".sb-lightbox .sb-top-bar .sb-close",function(){d.sbHideLightbox()}),S(d).on("click",".sb-lightbox .sb-info",function(){S(this).sbActive(!1)}),S(d).on("click",".sb-dialog-box a",function(){var e=S(this).closest(".sb-lightbox");S(this).hasClass("sb-confirm")&&K(),1==d.find(".sb-lightbox.sb-active").length&&ee.sbActive(!1),G.open_popup=!1,e.sbActive(!1)}),S(d).on("click",".sb-menu-wide li, .sb-nav li",function(){S(this).siblings().sbActive(!1),S(this).sbActive(!0)}),S(d).on("click",".sb-nav:not(.sb-nav-only) li:not(.sb-tab-nav-title)",function(){var e=S(this).closest(".sb-tab"),t=S(e).find(" > .sb-content > div").sbActive(!1).eq(S(this).parent().find("li:not(.sb-tab-nav-title)").index(this));t.sbActive(!0),t.find("textarea").each(function(){S(this).autoExpandTextarea(),S(this).manualExpandTextarea()}),e.find(".sb-scroll-area").scrollTop(0)}),S(d).on("change",".sb-upload-form-admin .sb-upload-files",function(e){S(this).sbUploadFiles(function(e){"success"==(e=JSON.parse(e))[0]?("upload-image"==S(Y).closest("[data-type]").data("type")&&S(Y).attr("data-value",e[1]).css("background-image",`url("${e[1]}")`),Z&&Z(e[1])):console.log(e[1])})}),S(d).on("click",".sb-accordion > div > span",function(e){var t=S(this).parent(),a=S(t).sbActive();S(e.target).is("span")&&(t.siblings().sbActive(!1),t.sbActive(!a))}),S(d).on("mousedown",function(e){var t;!S(G.open_popup).length||(t=S(G.open_popup)).is(e.target)||0!==t.has(e.target).length||["sb-btn-saved-replies","bi-emoji-grin"].includes(S(e.target).attr("class"))||(t.hasClass("sb-popup")?t.sbTogglePopup():t.hasClass("sb-select")?t.find("ul").sbActive(!1):t.hasClass("sb-menu-mobile")?t.find("i").sbActive(!1):t.hasClass("sb-menu")?t.sbActive(!1):d.sbHideLightbox(),G.open_popup=!1)})))}function i(){var e=moment();e.local(),S("#alertdate").val(e.format("MM/DD/YY hh:mm A")),U.timeZoneList()}function c(a,i,s=0,n=[],o,r=!1){let l="custom-email"==o?["send-custom-email","emails"," users with an email","direct-emails"]:"sms"==o?["whatsmeow-send-message","waweb-send-message","messages"," with a phone number","direct-sms"]:["create-email","emails"," with an email",!1];l="template"==o?["whatsapp-send-meta-template","template","users a phone number","direct-messages"]:l;var e=(new Metatemplate).payload("#user-template-form"),e=(e.to=a[s],"template"==o?{function:l[0],payload:e}:{function:l[0],to:a[s].value,recipient_id:a[s].id,sender_name:SB_ACTIVE_AGENT.full_name,sender_profile_image:SB_ACTIVE_AGENT.profile_image,subject:r,message:i,template:!1});SBF.ajax(e,e=>{var t=a.length;if(u.find(".sb-bottom > div").html(`${E("Sending")} ${l[1]}... ${s+1} / `+t),e||console.warn(e),!e?.error)return s<t-1?c(a,i,s+1,n,o,r):(n.length?c(n,i,0,[],"sms",!1):(d.sbHideLightbox(),l[3]&&SBF.ajax({function:"reports-update",name:l[3],value:i+" | "+t})),void T(1==t?"Message sent":`${SBF.slugToString(l[1])} sent to all users${l[2]}.`));132e3==e?.error.code||100==e?.error.code?SBForm.showErrorMessage(u,""+e?.error.message):F(""+e?.error.message,"info"),console.warn(e)})}function t(e,t){e.preventDefault();let i=f.find("#whatsmeow-go-qr input").val(),s="start"===t?"/include/get_ww.php?qrurl=":"/include/reset_ww.php";"start"===t?(S("#qr_loading1").show(),fetch(STMBX_URL+s+i).then(e=>{if(e.ok)return e.text();throw new Error("Network response was not ok")}).then(e=>{try{var t=JSON.parse(e);if(t.error)SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"warning");else if(t.image){let e="data:image/png;base64,"+t.image;var a=S("#qr_image1");a.length?a.fadeOut(500,function(){S(this).attr("src",e).fadeIn(500)}):(S("#whatsmeow-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image1" src="${e}" onerror="this.style.display='none';$('#qr_loading1').show();" />`),S("#whatsmeow-go .sb-setting-content").append('<div id="qr_loading1" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>')),S("#qr_loading1").hide()}}catch(e){if(!(e instanceof SyntaxError))throw e;console.error("Response is not JSON, assuming it's an image blob."),fetch(STMBX_URL+s+i).then(e=>{if(e.ok)return e.blob();throw new Error("Network response was not ok")}).then(e=>{let t=URL.createObjectURL(e);e=S("#qr_image1");e.length?e.fadeOut(500,function(){S(this).attr("src",t).fadeIn(500)}):(S("#whatsmeow-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image1" src="${t}" onerror="this.style.display='none';$('#qr_loading1').show();" />`),S("#whatsmeow-go .sb-setting-content").append('<div id="qr_loading1" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>'))}).catch(e=>{console.error("Error during fetch:",e),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")})}}).catch(e=>{console.error("Error during fetch:",e),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}).finally(()=>{S("#qr_loading1").hide()})):"restart"===t&&(console.log("Restarting..."),S.ajax({url:s,method:"GET",data:{qrurl:i},dataType:"json",success:function(e){console.log("Restart successful. Response:",e),SBChat.showResponse('<i style="var(--color-red)" class="bi bi-telephone-x"></i> Disconnecting from WhatsApp...');e=S("#qr_image1");e.length&&e.fadeOut(500,function(){S(this).remove()})},error:function(e){console.error("Restart error. Response:",e.responseText),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}}))}function a(e,t){e.preventDefault();var e=f.find("#waweb-go-qr input").val(),a="start"===t?"/include/get_wx.php?qrurl=":"/include/reset_wx.php";"start"===t?(S("#qr_loading2").show(),fetch(STMBX_URL+a+e).then(e=>{if(e.ok)return e.text();throw new Error("Network response was not ok")}).then(e=>{try{var t=JSON.parse(e);if(t.error)console.error("Error in JSON response:",t.error),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"warning");else if(t.image){let e="data:image/png;base64,"+t.image;var a=S("#qr_image2");a.length?a.fadeOut(500,function(){S(this).attr("src",e).fadeIn(500)}):(S("#waweb-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image2" src="${e}" onerror="this.style.display='none';$('#qr_loading2').show();" />`),S("#waweb-go .sb-setting-content").append('<div id="qr_loading2" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>')),S("#qr_loading2").hide()}}catch(e){console.error("Error parsing JSON response:",e),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}}).catch(e=>{console.error("Error during fetch:",e),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}).finally(()=>{S("#qr_loading2").hide()})):"restart"===t&&S.ajax({url:a,method:"GET",data:{qrurl:e},dataType:"json",success:function(e){console.log("Restart successful. Response:",e),SBChat.showResponse('<i style="var(--color-red)" class="bi bi-telephone-x"></i> Disconnecting from WhatsApp...');e=S("#qr_image2");e.length&&e.fadeOut(500,function(){S(this).remove()})},error:function(e){console.error("Restart error. Response:",e.responseText),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}})}})}(jQuery),function(e,t){"object"==typeof exports?module.exports=t(e):"function"==typeof define&&define.amd?define("colors",[],function(){return t(e)}):e.Colors=t(e)}(this,function(e,c){function n(e,t,a,i,s){if("string"==typeof t){t=k.txt2color(t);B[a=t.type]=t[a],s=s!==c?s:t.alpha}else if(t)for(var n in t)e[a][n]=r(t[n]/y[a][n][1],0,1);return s!==c&&(e.alpha=r(+s,0,1)),o(a,i?e:c)}function o(e,t){var a,i,s=t||B,n=k,o=w.options,r=y,l=s.RND,c="",d={hsl:"hsv",rgb:e},u=l.rgb;if("alpha"!==e){for(var p in r)if(!r[p][p])for(c in e!==p&&(i=d[p]||"rgb",s[p]=n[i+"2"+p](s[i])),l[p]||(l[p]={}),a=s[p])l[p][c]=x(a[c]*r[p][c][1]);u=l.rgb,s.HEX=n.RGB2HEX(u),s.equivalentGrey=o.grey.r*s.rgb.r+o.grey.g*s.rgb.g+o.grey.b*s.rgb.b,s.webSave=f=v(u,51),s.webSmart=b=v(u,17),s.saveColor=u.r===f.r&&u.g===f.g&&u.b===f.b?"web save":u.r===b.r&&u.g===b.g&&u.b===b.b?"web smart":"",s.hueRGB=k.hue2RGB(s.hsv.h),t&&(s.background=(f=u,b=s.rgb,t=s.alpha,g=w.options.grey,(h={}).RGB={r:f.r,g:f.g,b:f.b},h.rgb={r:b.r,g:b.g,b:b.b},h.alpha=t,h.equivalentGrey=x(g.r*f.r+g.g*f.g+g.b*f.b),h.rgbaMixBlack=S(b,{r:0,g:0,b:0},t,1),h.rgbaMixWhite=S(b,{r:1,g:1,b:1},t,1),h.rgbaMixBlack.luminance=m(h.rgbaMixBlack,!0),h.rgbaMixWhite.luminance=m(h.rgbaMixWhite,!0),w.options.customBG&&(h.rgbaMixCustom=S(b,w.options.customBG,t,1),h.rgbaMixCustom.luminance=m(h.rgbaMixCustom,!0),w.options.customBG.luminance=m(w.options.customBG,!0)),h))}var h,g=s.rgb,f=s.alpha,b="luminance",t=s.background;return(h=S(g,{r:0,g:0,b:0},f,1))[b]=m(h,!0),s.rgbaMixBlack=h,(h=S(g,{r:1,g:1,b:1},f,1))[b]=m(h,!0),s.rgbaMixWhite=h,o.customBG&&((h=S(g,t.rgbaMixCustom,f,1))[b]=m(h,!0),h.WCAG2Ratio=(g=h[b],f=t.rgbaMixCustom[b],x(100*(f<=g?(g+.05)/(f+.05):(f+.05)/(g+.05)))/100),(s.rgbaMixBGMixCustom=h).luminanceDelta=_.abs(h[b]-t.rgbaMixCustom[b]),h.hueDelta=(f=t.rgbaMixCustom,g=h,255*(_.max(f.r-g.r,g.r-f.r)+_.max(f.g-g.g,g.g-f.g)+_.max(f.b-g.b,g.b-f.b))/765)),s.RGBLuminance=m(u),s.HUELuminance=m(s.hueRGB),o.convertCallback&&o.convertCallback(s,e),s}function v(e,t){var a,i,s={},n=t/2;for(i in e)a=e[i]%t,s[i]=e[i]+(n<a?t-a:-a);return s}function m(e,t){for(var t=t?1:255,a=[e.r/t,e.g/t,e.b/t],e=w.options.luminance,i=a.length;i--;)a[i]=a[i]<=.03928?a[i]/12.92:_.pow((a[i]+.055)/1.055,2.4);return e.r*a[0]+e.g*a[1]+e.b*a[2]}function S(e,t,a,i){var s,n={},o=a!==c?a:1,r=i!==c?i:1,l=o+r*(1-o);for(s in e)n[s]=(e[s]*o+t[s]*r*(1-o))/l;return n.a=l,n}function r(e,t,a){return a<e?a:e<t?t:e}function t(e){this.colors={RND:{}},this.options={color:"rgba(0,0,0,0)",grey:l,luminance:d,valueRanges:y};var t,a=this,i=e||{},s=a.options;for(t in u(a),i)i[t]!==c&&(s[t]=i[t]);e=s.customBG,s.customBG="string"==typeof e?k.txt2color(e).rgb:e,B=n(a.colors,s.color,c,!0)}var y={rgb:{r:[0,255],g:[0,255],b:[0,255]},hsv:{h:[0,360],s:[0,100],v:[0,100]},hsl:{h:[0,360],s:[0,100],l:[0,100]},alpha:{alpha:[0,1]},HEX:{HEX:[0,16777215]}},_=e.Math,x=_.round,w={},B={},l={r:.298954,g:.586434,b:.114612},d={r:.2126,g:.7152,b:.0722},u=function(e){w!==e&&(B=(w=e).colors)},k=(t.prototype.setColor=function(e,t,a){return u(this),e?n(this.colors,e,t,c,a):(a!==c&&(this.colors.alpha=r(a,0,1)),o(t))},t.prototype.setCustomBackground=function(e){return u(this),this.options.customBG="string"==typeof e?k.txt2color(e).rgb:e,n(this.colors,c,"rgb")},t.prototype.saveAsBackground=function(){return u(this),n(this.colors,c,"rgb",!0)},t.prototype.toString=function(e,t){return k.color2text((e||"rgb").toLowerCase(),this.colors,t)},{txt2color:function(e){var t,a={},e=e.replace(/(?:#|\)|%)/g,"").split("("),i=(e[1]||"").split(/,\s*/),s=e[1]?e[0].substr(0,3):"rgb";if(a.type=s,a[s]={},e[1])for(var n=3;n--;)t=s[n]||s.charAt(n),a[s][t]=+i[n]/y[s][t][1];else a.rgb=k.HEX2rgb(e[0]);return a.alpha=i[3]?+i[3]:1,a},color2text:function(e,t,a){var i=!1!==a&&x(100*t.alpha)/100,a="number"==typeof i&&!1!==a&&(a||1!==i),s=t.RND.rgb,n=t.RND.hsl,o="hex"===e&&a,r="hex"===e&&!o,s="rgb"===e||o?s.r+", "+s.g+", "+s.b:r?"#"+t.HEX:n.h+", "+n.s+"%, "+n.l+"%";return r?s:(o?"rgb":e)+(a?"a":"")+"("+s+(a?", "+i:"")+")"},RGB2HEX:function(e){return((e.r<16?"0":"")+e.r.toString(16)+(e.g<16?"0":"")+e.g.toString(16)+(e.b<16?"0":"")+e.b.toString(16)).toUpperCase()},HEX2rgb:function(e){return{r:("0x"+(e=e.split(""))[0]+e[e[3]?1:0])/255,g:("0x"+e[e[3]?2:1]+(e[3]||e[1]))/255,b:("0x"+(e[4]||e[2])+(e[5]||e[2]))/255}},hue2RGB:function(e){var e=6*e,t=~~e%6,e=6==e?0:e-t;return{r:x(255*[1,1-e,0,0,e,1][t]),g:x(255*[e,1,1,1-e,0,0][t]),b:x(255*[0,0,e,1,1,1-e][t])}},rgb2hsv:function(e){var t,a=e.r,i=e.g,e=e.b,s=0;return i<e&&(i=e+(e=i,0),s=-1),t=e,a<i&&(a=i+(i=a,0),s=-2/6-s,t=_.min(i,e)),t=a-t,{h:(a?t/a:0)<1e-15?B&&B.hsl&&B.hsl.h||0:t?_.abs(s+(i-e)/(6*t)):0,s:a?t/a:B&&B.hsv&&B.hsv.s||0,v:a}},hsv2rgb:function(e){var t=6*e.h,a=e.s,e=e.v,i=~~t,t=t-i,s=e*(1-a),n=e*(1-t*a),t=e*(1-(1-t)*a),a=i%6;return{r:[e,n,s,s,t,e][a],g:[t,e,e,n,s,s][a],b:[s,s,t,e,e,n][a]}},hsv2hsl:function(e){var t=(2-e.s)*e.v,a=e.s*e.v,a=e.s?t<1?t?a/t:0:a/(2-t):0;return{h:e.h,s:e.v||a?a:B&&B.hsl&&B.hsl.s||0,l:t/2}},rgb2hsl:function(e,t){e=k.rgb2hsv(e);return k.hsv2hsl(t?e:B.hsv=e)},hsl2rgb:function(e){var t=6*e.h,a=e.s,e=e.l,a=e<.5?e*(1+a):e+a-a*e,e=e+e-a,i=~~t,t=a*(a?(a-e)/a:0)*(t-i),s=e+t,t=a-t,i=i%6;return{r:[a,t,e,e,s,a][i],g:[s,a,a,t,e,e][i],b:[e,e,s,a,a,t][i]}}});return t}),function(a,i){"object"==typeof exports?module.exports=i(a,require("jquery"),require("colors")):"function"==typeof define&&define.amd?define(["jquery","colors"],function(e,t){return i(a,e,t)}):i(a,a.jQuery,a.Colors)}(this,function(n,o,t,f){function r(e){return e.value||e.getAttribute("value")||o(e).css("background-color")||"#FFF"}function a(e){return(e=e.originalEvent&&e.originalEvent.touches?e.originalEvent.touches[0]:e).originalEvent?e.originalEvent:e}function l(e){return o(e.find(m.doRender)[0]||e[0])}function s(e){var t=o(this),a=t.offset(),i=o(n),s=m.gap;e?((S=l(t))._colorMode=S.data("colorMode"),g.$trigger=t,(y||(o("head")[m.cssPrepend?"prepend":"append"]('<style type="text/css" id="tinyColorPickerStyles">'+(m.css||".cp-color-picker{position:absolute;overflow:hidden;padding:6px 6px 0;background-color:#444;color:#bbb;font-family:Arial,Helvetica,sans-serif;font-size: var(--chat-text-size-8);font-weight:400;cursor:default;border-radius:5px}.cp-color-picker>div{position:relative;overflow:hidden}.cp-xy-slider{float:left;height:128px;width:128px;margin-bottom:6px;background:linear-gradient(to right,#FFF,rgba(255,255,255,0))}.cp-white{height:100%;width:100%;background:linear-gradient(rgba(0,0,0,0),#000)}.cp-xy-cursor{position:absolute;top:0;width:10px;height:10px;margin:-5px;border:1px solid #fff;border-radius:100%;box-sizing:border-box}.cp-z-slider{float:right;margin-left:6px;height:128px;width:20px;background:linear-gradient(red 0,#f0f 17%,#00f 33%,#0ff 50%,#0f0 67%,#ff0 83%,red 100%)}.cp-z-cursor{position:absolute;margin-top:-4px;width:100%;border:4px solid #fff;border-color:transparent #fff;box-sizing:border-box}.cp-alpha{clear:both;width:100%;height:16px;margin:6px 0;background:linear-gradient(to right,#444,rgba(0,0,0,0))}.cp-alpha-cursor{position:absolute;margin-left:-4px;height:100%;border:4px solid #fff;border-color:#fff transparent;box-sizing:border-box}")+(m.cssAddon||"")+"</style>"),o('<div class="cp-color-picker"><div class="cp-z-slider"><div class="cp-z-cursor"></div></div><div class="cp-xy-slider"><div class="cp-white"></div><div class="cp-xy-cursor"></div></div><div class="cp-alpha"><div class="cp-alpha-cursor"></div></div></div>').css({margin:m.margin}).appendTo("body").show(0,function(){g.$UI=y=o(this),I=m.GPU&&y.css("perspective")!==f,_=o(".cp-z-slider",this),x=o(".cp-xy-slider",this),w=o(".cp-xy-cursor",this),B=o(".cp-z-cursor",this),k=o(".cp-alpha",this),C=o(".cp-alpha-cursor",this),m.buildCallback.call(g,y),y.prepend("<div>").children().eq(0).css("width",y.children().eq(0).width()),y._width=this.offsetWidth,y._height=this.offsetHeight}).hide())).css(m.positionCallback.call(g,t)||{left:(y._left=a.left)-(0<(y._left+=y._width-(i.scrollLeft()+i.width()))+s?y._left+s:0),top:(y._top=a.top+t.outerHeight())-(0<(y._top+=y._height-(i.scrollTop()+i.height()))+s?y._top+s:0)}).show(m.animationSpeed,function(){!0!==e&&(k.toggle(!!m.opacity)._width=k.width(),x._width=x.width(),x._height=x.height(),_._height=_.height(),v.setColor(r(S[0])),p(!0))}).off(".tcp").on(F,".cp-xy-slider,.cp-z-slider,.cp-alpha",c)):g.$trigger&&o(y).hide(m.animationSpeed,function(){p(!1),g.$trigger=null}).off(".tcp")}function c(e){var t=this.className.replace(/cp-(.*?)(?:\s*|$)/,"$1").replace("-","_");1<(e.button||e.which)||(e.preventDefault&&e.preventDefault(),e.returnValue=!1,S._offset=o(this).offset(),(t="xy_slider"===t?i:"z_slider"===t?d:u)(e),p(),A.on(L,function(){A.off(".tcp")}).on($,function(e){t(e),p()}))}function i(e){var e=a(e),t=e.pageX-S._offset.left,e=e.pageY-S._offset.top;v.setColor({s:t/x._width*100,v:100-e/x._height*100},"hsv")}function d(e){e=a(e).pageY-S._offset.top;v.setColor({h:360-e/_._height*360},"hsv")}function u(e){e=(a(e).pageX-S._offset.left)/k._width;v.setColor({},"rgb",e)}function p(e){var t=v.colors,a=t.hueRGB,i=(t.RND.rgb,t.RND.hsl,m.dark),s=m.light,n=v.toString(S._colorMode,m.forceAlpha),o=.22<t.HUELuminance?i:s,r=.22<t.rgbaMixBlack.luminance?i:s,l=(1-t.hsv.h)*_._height,c=t.hsv.s*x._width,d=(1-t.hsv.v)*x._height,u=t.alpha*k._width,p=I?"translate3d":"",h=S[0].value,g=S[0].hasAttribute("value")&&""===h&&e!==f;x._css={backgroundColor:"rgb("+a.r+","+a.g+","+a.b+")"},w._css={transform:p+"("+c+"px, "+d+"px, 0)",left:I?"":c,top:I?"":d,borderColor:.22<t.RGBLuminance?i:s},B._css={transform:p+"(0, "+l+"px, 0)",top:I?"":l,borderColor:"transparent "+o},k._css={backgroundColor:"#"+t.HEX},C._css={transform:p+"("+u+"px, 0, 0)",left:I?"":u,borderColor:r+" transparent"},S._css={backgroundColor:g?"":n,color:g?"":.22<t.rgbaMixBGMixCustom.luminance?i:s},S.text=!g&&h!==n?n:"",e!==f?b(e):E(b)}function b(e){x.css(x._css),w.css(w._css),B.css(B._css),k.css(k._css),C.css(C._css),m.doRender&&S.css(S._css),S.text&&S.val(S.text),m.renderCallback.call(g,S,"boolean"==typeof e?e:f)}function h(e){m=(v=this.color=new t(e)).options,g=this}var g,v,m,S,y,_,x,w,B,k,C,A=o(document),T=o(),$="touchmove.tcp mousemove.tcp pointermove.tcp",F="touchstart.tcp mousedown.tcp pointerdown.tcp",L="touchend.tcp mouseup.tcp pointerup.tcp",I=!1,E=n.requestAnimationFrame||n.webkitRequestAnimationFrame||function(e){e()};h.prototype={render:p,toggle:s},o.fn.colorPicker=function(i){function e(){}var t=this;return i=o.extend({animationSpeed:150,GPU:!0,doRender:!0,customBG:"#FFF",opacity:!0,renderCallback:e,buildCallback:e,positionCallback:e,body:document.body,scrollResize:!0,gap:4,dark:"#222",light:"#DDD"},i),!g&&i.scrollResize&&o(n).on("resize.tcp scroll.tcp",function(){g.$trigger&&g.toggle.call(g.$trigger[0],!0)}),T=T.add(this),this.colorPicker=g||new h(i),this.options=i,o(i.body).off(".tcp").on(F,function(e){-1===T.add(y).add(o(y).find(e.target)).index(e.target)&&s()}),this.on("focusin.tcp click.tcp",function(e){g.color.options=o.extend(g.color.options,m=t.options),s.call(this,e)}).on("change.tcp",function(){v.setColor(this.value||"#FFF"),t.colorPicker.render(!0)}).each(function(){var e=r(this),t=e.split("("),a=l(o(this));a.data("colorMode",t[1]?t[0].substr(0,3):"HEX").attr("readonly",m.preventFocus),i.doRender&&a.css({"background-color":e,color:function(){return.22<v.setColor(e).rgbaMixBGMixCustom.luminance?i.dark:i.light}})})},o.fn.colorPicker.destroy=function(){o("*").off(".tcp"),g.toggle(!1),T=o()}}),window.addEventListener("load",function(){initLoadingAnimation()}),document.addEventListener("click",e=>{var t,a;e.target.classList.contains("settings-button")?(a=(t=e.target.closest(".sb-setting")).querySelector(".active")).classList.contains("sb-hide")?(a.classList.remove("sb-hide"),t.querySelector(".input").classList.remove("sb-hide")):(a.classList.add("sb-hide"),t.querySelector(".input").classList.add("sb-hide")):e.target.classList.contains("sb-revert")&&((a=e.target.closest(".sb-setting")).querySelector(".active").classList.add("sb-hide"),a.querySelector(".input").classList.add("sb-hide"))}),window.onclick=function(e){if(!e.target.matches(".cst-btn"))for(var t=document.getElementsByClassName("cstdown-content"),a=0;a<t.length;a++){var i=t[a];i.classList.contains("show")&&i.classList.remove("show")}};