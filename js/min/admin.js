"use strict";function showContent(){var t=document.getElementById("overlay"),e=document.documentElement;t.style.display="none",e.style.animation="fade-in .1s ease-in"}function initLoadingAnimation(){var t=document.getElementById("overlay");document.getElementById("loader");t.style.animation="load 1.6s ease-out",t.addEventListener("animationend",function(){showContent()})}function ExtraButton(){document.getElementById("CstBtn").classList.toggle("show")}!function(S){var d,a,y,q,_,P,O,z,H,u,h,V,o,l,p,r,g,f,b,W,X,v,t,m,J,x,Y,Z,Q,s,K,n,tt,w=[],et=!1,it=!1,B=!1,st=1,at=1,k={},nt=1,ot=1,C=S(window).width()<555,A={last:0,header:!0,always_hidden:!1},rt="localhost"===location.hostname||"127.0.0.1"===location.hostname,lt=new Date,ct=!1,i=!0,dt=!1,ut="undefined",c=!1,ht=!1,e=!1,pt=["Abierto","Presupuesto","Consulta","Contactado","Visitado","Calificado","Confirmado","Pendiente","Resuelto","Pagado","VIP","Descartado","NA"];function T(t,e=!1){var i=d.find(".sb-info-card");e?"error"===e?(i.addClass("sb-info-card-error"),s=setTimeout(()=>{i.sbActive(!1)},4e3)):"warning"===e?(i.addClass("sb-info-card-warning"),s=setTimeout(()=>{i.sbActive(!1)},3e3)):i.addClass("sb-info-card-info"):(i.removeClass("sb-info-card-error sb-info-card-warning sb-info-card-info"),clearTimeout(s),s=setTimeout(()=>{i.sbActive(!1)},1500)),i.html(`<h3>${I(t)}</h3>`).sbActive(!0)}function $(t){if(typeof t==ut)return window.sb_current_user;window.sb_current_user=t}function F(t,e,i=!1,s="",a="",n=!1){let o=d.find(".sb-dialog-box").attr("data-type",e);var r=o.find("p");o.attr("id",s).setClass("sb-scroll-area",n).css("height",n?parseInt(S(window).height())-200+"px":""),o.find(".sb-title").html(a),r.html(("alert"==e?'<strong style="font-size: var(--chat-text-size-1-1);color: var(--chat-text-primary">'+I("Are you sure?")+"</strong> ":"")+I(t)),o.sbActive(!0).css({"margin-top":o.outerHeight()/-2+"px","margin-left":o.outerWidth()/-2+"px"}),tt.sbActive(!0),K=i,setTimeout(()=>{G.open_popup=o},500)}function L(t=!1,e=!0){d.find(".sb-loading-global").sbActive(t),e&&(tt.sbActive(t),S("body").setClass("sb-lightbox-active",t))}function E(t){if(S(t).sbLoading())return 1;S(t).sbLoading(!0)}function I(t){return SB_TRANSLATIONS&&t in SB_TRANSLATIONS?SB_TRANSLATIONS[t]:t}function gt(t,e){var i=(t=S(t)).find("> div, > ul");i.css({height:"","max-height":""}),t.hasClass("sb-collapse")&&S(i).prop("scrollHeight")>e&&(t.sbActive(!0).attr("data-height",e),t.find(".bi-chevron-down").remove(),t.append(`<a class="sb-btn-text bi-chevron-down">${I("View more")}</a>`),i.css({height:e+"px","max-height":e+"px"}))}function ft(t,e){let i=S(t).parent().find("i"),s=S(t).val();i.sbLoading()||SBF.search(s,()=>{i.sbLoading(!0),e(s,i)})}function bt(t,e=!1,i=0){if(e)return S(t).scrollTop()+S(t).innerHeight()>=S(t)[0].scrollHeight-1;S(t).scrollTop(S(t)[0].scrollHeight-i)}function vt(t){window.history.pushState("","",t)}function mt(){return SB_ADMIN_SETTINGS.cloud?"&cloud="+SB_ADMIN_SETTINGS.cloud.token:""}function St(t=!1){e||(!1===c?(c=!0,S.getScript(STMBX_URL+"/vendor/editorjs.js",()=>{St(t)})):(yt(),e=!0,c=new EditorJS({data:"string"==typeof t?{time:Date.now(),blocks:[t?{id:"sb",type:"raw",data:{html:t}}:{id:"sb",type:"paragraph",data:{text:""}}]}:t,i18n:{messages:{ui:{blockTunes:{toggler:{"Click to tune":I("Click to tune")}},inlineToolbar:{converter:{"Convert to":I("Convert to")}},toolbar:{toolbox:{Add:I("Add")}}},toolNames:{Text:I("Text"),Heading:I("Heading"),List:I("List"),Image:I("Image"),Code:I("Code"),"Raw HTML":I("Raw HTML"),Bold:I("Bold"),Italic:I("Italic"),Link:I("Link")},tools:{list:{Ordered:I("Ordered"),Unordered:I("Unordered")}},blockTunes:{delete:{Delete:I("Delete")},moveUp:{"Move up":I("Move up")},moveDown:{"Move down":I("Move down")}}}},tools:{list:{class:List,inlineToolbar:!0},image:{class:ImageTool,config:{uploader:{uploadByFile(t){let i=new FormData;return i.append("file",t),new Promise(e=>{S.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:i,type:"POST",success:function(t){"success"==(t=JSON.parse(t))[0]?e({success:1,file:{url:t[1]}}):console.log(t)}})})}}}},header:Header,code:CodeTool,raw:RawTool},onReady:()=>{e=!1},minHeight:50})))}function yt(){typeof c.destroy!==ut&&(c.destroy(),c=!1)}S.fn.sbLanguageSwitcher=function(t=[],e="",i=!1){let s=`<div class="sb-language-switcher" data-source="${e}">`,a=[],n=S(this).hasClass("sb-language-switcher-cnt")?S(this):S(this).find(".sb-language-switcher-cnt");for(var o=0;o<t.length;o++)a.includes(t[o])||(s+=`<span ${i==t[o]?'class="sb-active" ':""}data-language="${t[o]}"><i class="bi-x-lg"></i><img src="${STMBX_URL}/media/flags/${t[o].toLowerCase()}.png" /></span>`,a.push(t[o]));return n.find(".sb-language-switcher").remove(),n.append(s+`<i data-sb-tooltip="${I("Add translation")}" class="bi-plus-lg"></i></div>`),this},S.fn.sbShowLightbox=function(t=!1,e=""){function i(){var t=S(this),e=t.outerHeight()/-2-25;t.css({"margin-top":e+"px","margin-left":t.outerWidth()/-2+"px"})}return d.find(".sb-lightbox").sbActive(!1),tt.sbActive(!0),S(this).sbActive(!0),t?S(this).addClass("sb-popup-lightbox").attr("data-action",e):(i.call(this),S(window).on("resize",function(){i.call(this)})),S("body").addClass("sb-lightbox-active"),setTimeout(()=>{G.open_popup=this},300),this.preventDefault,this},S.fn.sbHideLightbox=function(){return S(this).find(".sb-lightbox,.sb-popup-lightbox").sbActive(!1).removeClass("sb-popup-lightbox").removeAttr("data-action"),tt.sbActive(!1),S("body").removeClass("sb-lightbox-active"),G.open_popup=!1,this};var M={dialogflow:{intents:!(S.fn.sbInitTooltips=function(){return S(this).find("[data-sb-tooltip]").each(function(){var t=this.getBoundingClientRect().top<window.innerHeight/2?"n":"w";S(this).miniTip({content:S(this).attr("data-sb-tooltip"),anchor:t,delay:100})})}),token:SBF.storage("dialogflow-token"),smart_reply_data:!1,smartReply:function(t){SBF.ajax({function:"dialogflow-smart-reply",message:t,smart_reply_data:this.smart_reply_data||{conversation_id:SBChat.conversation.id},token:this.token,dialogflow_language:[$().language?$().language:"en"],language_detection:SB_ADMIN_SETTINGS["smart-reply-language-detection"]&&SBChat.conversation&&!SBChat.conversation.getLastUserMessage(!1,!0)&&(!SB_ADMIN_SETTINGS["smart-reply-language-detection-bot"]||!SBChat.conversation.getLastUserMessage(!1,"bot"))},t=>{var e=t.suggestions;let i="";var s=y.find(".sb-conversation .sb-list"),s=s[0].scrollTop===s[0].scrollHeight-s[0].offsetHeight,a=!(!SBChat.conversation||!SBChat.conversation.getLastMessage())&&SBChat.conversation.getLastMessage().message;t.token&&this.token!=t.token&&(this.token=t.token,SBF.storage("dialogflow-token",t.token));for(var n=0;n<e.length;n++)e[n]!=a&&(i+=`<span>${e[n]}</span>`);this.smart_reply_data=t.smart_reply,V.html(i),s&&SBChat.scrollBottom()})},smartReplyUpdate:function(t,e="agent"){SBF.ajax({function:"dialogflow-smart-reply-update",message:t,smart_reply_data:this.smart_reply_data||{conversation_id:SBChat.conversation.id},token:this.token,dialogflow_language:[$().language],user_type:e})},showCreateIntentBox:function(t){let e="";t=SBChat.conversation.getMessage(t);let i=t.message;if(SBF.isAgent(t.get("user_type")))e=0==(e=(e=SBChat.conversation.getLastUserMessage(t.get("index")))&&e.payload("sb-human-takeover")?SBChat.conversation.getLastUserMessage(e.get("index")):e)?"":e.message;else{e=i;for(var s=SBChat.conversation.messages,a=t.get("index");a<s.length;a++)if(["agent","admin"].includes(s[a].get("user_type"))){i=s[a].message;break}}!1===this.intents&&SBF.ajax({function:"dialogflow-get-intents"},t=>{let e="";if(Array.isArray(t)){for(var i=0;i<t.length;i++)e+=`<option value="${t[i].name}">${t[i].displayName}</option>`;h.find("#sb-intents-select").append(e),this.intents=t}else this.intents=[]}),h.attr("data-message-id",t.id),h.find(".sb-type-text:not(.sb-first)").remove(),h.find(".sb-type-text input").val(e),h.find("textarea").val(i),h.find("#sb-intents-select").val(""),h.find(".sb-search-btn").sbActive(!1).find("input").val(""),this.searchIntents(""),h.sbShowLightbox()},submitIntent:function(s){if(!E(s)){let t=[];var e=h.find("textarea").val();let i=h.find("#sb-intents-select").val();h.find(".sb-type-text input").each(function(){S(this).val()&&t.push(S(this).val())}),""==e&&!i||0==t.length?(SBForm.showErrorMessage(h,"Please insert the bot response and at least one user expression."),S(s).sbLoading(!1)):SBF.ajax({function:""==i?"dialogflow-create-intent":"dialogflow-update-intent",expressions:t,response:e,agent_language:h.find(".sb-dialogflow-languages select").val(),conversation_id:SBChat.conversation.id,intent_name:i},e=>{if(S(s).sbLoading(!1),!0===e)d.sbHideLightbox(),T(""==i?"Intent created":"Intent updated");else{let t="Error";"error"in e&&"message"in e.error&&(t=e.error.message),SBForm.showErrorMessage(h,t)}})}},searchIntents:function(l){l=l.toLowerCase(),SBF.search(l,()=>{var e=!(1<l.length);let i=e?`<option value="">${I("New Intent")}</option>`:"";for(var s=this.intents,a=0;a<s.length;a++){let t=e||s[a].displayName.toLowerCase().includes(l);if(!t&&"trainingPhrases"in s[a])for(var n=s[a].trainingPhrases,o=0;o<n.length;o++){for(var r=0;r<n[o].parts.length;r++)if(n[o].parts[r].text.toLowerCase().includes(l)){t=!0;break}if(t)break}t&&(i+=`<option value="${s[a].name}">${s[a].displayName}</option>`)}h.find("#sb-intents-select").html(i).change()})},previewIntent:function(t){let e="";for(var i=0;i<this.intents.length;i++)if(this.intents[i].name==t){var s="trainingPhrases"in this.intents[i]?this.intents[i].trainingPhrases:[],a=s.length;if(1<a){for(var n=0;n<a;n++)for(var o=0;o<s[n].parts.length&&(e+=`<span>${s[n].parts[o].text}</span>`,15!=o);o++);F(e,"info",!1,"intent-preview-box","",10<a)}break}},translate:function(t,e,i){t.length&&SBF.ajax({function:"google-translate",strings:t,language_code:e,token:this.token},t=>{if(this.token=t[1],!Array.isArray(t[0]))return SBF.error(JSON.stringify(t[0]),"SBApps.dialogflow.translate"),!1;i(t[0])})}},messenger:{check:function(t){return["fb","ig"].includes(t.get("source"))},send:function(t,e,i="",s=[],a,n=!1){SBF.ajax({function:"messenger-send-message",psid:t,facebook_page_id:e,message:i,attachments:s,metadata:a},t=>{n&&n(t)})}},whatsmeow:{check:function(t){return"ww"==t.get("source")},send:function(t,e="",i=[],s=!1,a=!1,n){SBF.ajax({function:"whatsmeow-send-message",to:t,message:e,attachments:i,phone_id:s},t=>{a&&a(t)})},activeUserPhone:function(t=$()){return!!t.getExtra("phone")&&t.getExtra("phone").value.replace("+","")}},waweb:{check:function(t){return"wx"==t.get("source")},send:function(t,e="",i=[],s=!1,a=!1,n){SBF.ajax({function:"waweb-send-message",to:t,message:e,attachments:i,phone_id:s},t=>{a&&a(t)})},activeUserPhone:function(t=$()){return!!t.getExtra("phone")&&t.getExtra("phone").value.replace("+","")}},whatsapp:{check:function(t){return"wa"==t.get("source")},send:function(t,e="",i=[],s=!1,a=!1){SBF.ajax({function:"whatsapp-send-message",to:t,message:e,attachments:i,phone_id:s},t=>{a&&a(t)})},activeUserPhone:function(t=$()){return!!t.getExtra("phone")&&t.getExtra("phone").value.replace("+","")}},telegram:{check:function(t){return"tg"==t.get("source")},send:function(t,e="",i=[],s=!1){SBF.ajax({function:"telegram-send-message",chat_id:t,message:e,attachments:i},t=>{s&&s(t)})}},gbm:{token:!1,check:function(t){return"bm"==t.get("source")},send:function(t,e="",i=[],s=!1){SBF.ajax({function:"gbm-send-message",google_conversation_id:t,message:e,attachments:i,token:this.token},t=>{s&&s(t),this.token=t[2]})}},twitter:{check:function(t){return"tw"==t.get("source")},send:function(t,e="",i=[],s=!1){SBF.ajax({function:"twitter-send-message",twitter_id:t,message:e,attachments:i},t=>{s&&s(t)})}},is:function(t){if(typeof SB_VERSIONS!=ut)switch(t){case"gbm":case"twitter":case"telegram":case"messenger":case"whatsapp":case"waweb":case"whatsmeow":case"dialogflow":case"sb":return!0}return!1}},R={init:!1,save:function(i){if(!E(i)){let o={},r={};switch(f.find(" > .sb-tab > .sb-nav .sb-active").attr("id")){case"tab-articles":this.articles.save(t=>{T(!0===t?"Articles and categories saved":t),S(i).sbLoading(!1)});break;case"tab-automations":let e=m.find(".sb-active").attr("data-id");R.automations.save(t=>{T(!0===t?"Automations saved":t),R.automations.populate(),m.find(`[data-id="${e}"]`).click(),S(i).sbLoading(!1)});break;case"tab-translations":this.translations.updateActive(),SBF.ajax({function:"save-translations",translations:JSON.stringify(this.translations.to_update)},()=>{T("Translations saved"),S(i).sbLoading(!1)});break;default:f.find(".sb-setting").each((t,e)=>{var i=this.get(e),s=S(e).data("setting");if(i[0])if(typeof s!=ut){let t=!1;if(S(e).find("[data-language]").length){var a=S(e).find("[data-language].sb-active");if(t=i[0]in this.translations.originals&&this.translations.originals[i[0]],this.translations.save(e,!!a.length&&a.attr("data-language")),t&&"string"!=typeof t)for(var n in t)t[n]=[t[n],i[1][n][1]]}s in o||(o[s]={}),o[s][i[0]]=[t||i[1],i[2]]}else r[i[0]]=[i[1],i[2]]}),SBF.ajax({function:"save-settings",settings:JSON.stringify(r),external_settings:o,external_settings_translations:this.translations.translations},()=>{T("Settings saved"),S(i).sbLoading(!1),setTimeout(()=>{location.reload()},600)})}}},initPlugins:function(){f.find("textarea").each(function(){S(this).autoExpandTextarea(),S(this).manualExpandTextarea()}),f.find("[data-setting] .sb-language-switcher-cnt").each(function(){S(this).sbLanguageSwitcher(R.translations.getLanguageCodes(S(this).closest("[data-setting]").attr("id")),"settings")})},initColorPicker:function(t=!1){S(t||f).find(".sb-type-color input").colorPicker({renderCallback:function(t,e){S(t.context).closest(".input").find("input").css("background-color",t.text)}})},initHTML:function(e){if("slack-agents"in e){let t="";for(var i in e["slack-agents"][0])t+=`<div data-id="${i}"><select><option value="${e["slack-agents"][0][i]}"></option></select></div>`;f.find("#slack-agents .input").html(t)}},get:function(n){var o=(n=S(n)).attr("id"),r=n.data("type");n.attr("value");switch(r){case"upload":case"range":case"number":case"text":case"password":case"color":return[o,n.find("input").val(),r];case"textarea":return[o,n.find("textarea").val(),r];case"select":return[o,n.find("select").val(),r];case"checkbox":return[o,n.find("input").is(":checked"),r];case"radio":let t=n.find("input:checked").val();return[o,t=SBF.null(t)?"":t,r];case"upload-image":let e=n.find(".image").attr("data-value");return[o,e=SBF.null(e)?"":e,r];case"multi-input":let i={};return n.find(".input > div").each((t,e)=>{e=this.get(e);e[0]&&(i[e[0]]=[e[1],e[2]])}),[o,i,r];case"select-images":return[o,n.find(".input > .sb-active").data("value"),r];case"repeater":return[o,this.repeater("get",n.find(".repeater-item"),""),r];case"double-select":let s={};return n.find(".input > div").each(function(){var t=S(this).find("select").val();-1!=t&&(s[S(this).attr("data-id")]=[t])}),[o,s,r];case"select-checkbox":return[o,n.find(".sb-select-checkbox input:checked").map(function(){return S(this).attr("id")}).get(),r];case"timetable":let a={};return n.find(".sb-timetable > [data-day]").each(function(){var t=S(this).attr("data-day");let i=[];S(this).find("> div > div").each(function(){var t=S(this).html(),e=S(this).attr("data-value");SBF.null(e)?i.push(["",""]):"closed"==e?i.push(["closed","Closed"]):i.push([e,t])}),a[t]=i}),[o,a,r];case"color-palette":return[o,n.attr("data-value"),r]}return["","",""]},set:function(t,e){var i=S(e)[1],s=S(e)[0];switch(t="#"+t,i){case"color":case"upload":case"number":case"text":case"password":f.find(t+" input").val(s);break;case"textarea":f.find(t+" textarea").val(s);break;case"select":f.find(t+" select").val(s);break;case"checkbox":f.find(t+" input").prop("checked","false"!=s&&s);break;case"radio":f.find(t+` input[value="${s}"]`).prop("checked",!0);break;case"upload-image":s&&f.find(t+" .image").attr("data-value",s).css("background-image",`url("${s}")`);break;case"multi-input":for(var a in s)this.set(a,s[a]);break;case"range":var n=s;f.find(t+" input").val(n),f.find(t+" .range-value").html(n);break;case"select-images":f.find(t+" .input > div").sbActive(!1),f.find(t+` .input > [data-value="${s}"]`).sbActive(!0);break;case"select-checkbox":for(var o=0;o<s.length;o++)f.find(`input[id="${s[o]}"]`).prop("checked",!0);f.find(t+" .sb-select-checkbox-input").val(s.join(", "));break;case"repeater":n=this.repeater("set",s,f.find(t+" .repeater-item:last-child"));n&&f.find(t+" .sb-repeater").html(n);break;case"double-select":for(var a in s)f.find(t+` .input > [data-id="${a}"] select`).val(s[a]);break;case"timetable":for(var a in s)for(var r=f.find(t+` [data-day="${a}"] > div > div`),o=0;o<r.length;o++)S(r[o]).attr("data-value",s[a][o][0]).html(s[a][o][1]);break;case"color-palette":s&&f.find(t).attr("data-value",s)}},repeater:function(t,e,i){if(i=S(i).html(),"set"==t){var s="";if(0<e.length){S(i).find(".bi-x-lg").remove();for(var a=0;a<e.length;a++){var n,o=S(S.parseHTML(`<div>${i}</div>`));for(n in e[a])this.setInput(o.find(`[data-id="${n}"]`),e[a][n]);s+=`<div class="repeater-item">${o.html()}<i class="bi-x-lg"></i></div>`}}return s}if("get"==t){let t=[],s=this;return S(e).each(function(){let e={},i=!0;S(this).find("[data-id]").each(function(){var t=s.getInput(this);i&&t&&"hidden"!=S(this).attr("type")&&"auto-id"!=S(this).attr("data-type")&&(i=!1),e[S(this).attr("data-id")]=t}),i||t.push(e)}),t}},repeaterAdd:function(t){let i=S(t).parent();(t=S(S.parseHTML(`<div>${i.find(".repeater-item:last-child").html()}</div>`))).find("[data-id]").each(function(){if(R.resetInput(this),"auto-id"==S(this).data("type")){let e=1;i.find('[data-type="auto-id"]').each(function(){var t=parseInt(S(this).val());t>e&&(e=t)}),S(this).attr("value",e+1)}}),i.find(".sb-repeater").append(`<div class="repeater-item">${t.html()}</div>`)},repeaterDelete:function(t){t=S(t).parent();1<t.parent().find(".repeater-item").length?t.remove():t.find("[data-id]").each((t,e)=>{this.resetInput(e)})},setInput:function(t,e){var i;e=S.trim(e),(t=S(t)).is("select")?t.find(`option[value="${e}"]`).attr("selected",""):t.is(":checkbox")&&e&&"false"!=e?t.attr("checked",""):t.is("textarea")?t.html(e):(i=t.is("div"))||t.is("i")||t.is("li")?(t.attr("data-value",e),i&&t.hasClass("image")&&t.css("background-image",e?`url("${e}")`:"")):t.attr("value",e)},getInput:function(t){var e;return(t=S(t)).is(":checkbox")?t.is(":checked"):t.is("div")||t.is("i")||t.is("li")?(e=t.attr("data-value"),SBF.null(e)?"":e):t.val()},resetInput:function(t){(t=S(t)).is("select")?t.val("").find("[selected]").removeAttr("selected"):t.is("checkbox")&&value?t.removeAttr("checked").prop("checked",!1):t.is("textarea")?t.html(""):t.removeAttr("value").removeAttr("style").removeAttr("data-value").val("")},getSettingObject:function(t){return S(t)[0].hasAttribute("data-setting")?S(t):S(t).closest("[data-setting]")},articles:{categories:[],articles:[],translations:{},get:function(e,t=!1,i=!0){SBF.ajax({function:"get-articles",categories:t,articles_language:"all",full:i},t=>{e(t)})},save:function(e=!1){if(this.updateActiveArticle(),c)if(ht)ht=!1;else if(this.activeID()&&-1!=this.activeID())return void(ht=e);b.find(".sb-new-category-cnt input").each((t,e)=>{var i=S.trim(S(e).val());i&&this.categories.push({id:SBF.random(),title:i}),S(e).parents().eq(1).remove()}),this.categories.length&&this.categories.sort(function(t,e){return t.title.localeCompare(e.title)}),SBF.ajax({function:"save-articles",articles:this.articles,translations:this.translations,categories:this.categories.length?this.categories:"delete_all"},t=>{b.find(".sb-menu-wide .sb-active").click(),b.find(`.sb-nav [data-id="${this.activeID()}"]`).click(),this.updateSelect(),e&&e(t)}),M.is("dialogflow")&&SBF.ajax({function:"dialogflow-knowledge",articles:this.articles})},show:function(t=!1,e=!1,i=!1){let s=[-1,"","","",""];this.updateActiveArticle(),this.hide(!1);var a=i?i in this.translations?this.translations[i]:[]:this.articles;!1===t&&(t=this.activeID());for(var n=0;n<a.length;n++)if(a[n].id==t){s=[t,a[n].title,a[n].content,a[n].link,SBF.null(a[n].categories)?[""]:a[n].categories,SBF.null(a[n].parent_category)?"":a[n].parent_category,a[n].editor_js],e&&(S(e).siblings().sbActive(!1),S(e).sbActive(!0));break}W.val(""),X.val(s[5]);for(n=0;n<s[4].length;n++)W.eq(n).val(s[4][n]);b.sbLanguageSwitcher(this.getTranslations(t),"articles",i),b.find(".sb-content").attr("data-id",s[0]),b.find(".sb-article-title input").val(s[1]),b.find(".sb-article-link input").val(s[3]),b.find("#sb-article-id").html(`ID <span>${s[0]}</span>`),c||b.find("#editorjs").length?St(s[6]||s[2]):b.find(".sb-article-content textarea").val(s[2])},add:function(){var t=b.find(".sb-nav > ul"),e=SBF.random();this.updateActiveArticle(),this.articles.push({id:e,title:"",content:"",link:"",categories:[]}),this.hide(!1),t.find(".sb-active").sbActive(!1),t.find(".sb-no-results").remove(),t.append(`<li class="sb-active" data-id="${e}">${I("Article")} ${t.find("li").length+1}<i class="bi-trash"></i></li>`),b.find("input, textarea, select").val(""),b.find(".sb-content").attr("data-id",e),b.sbLanguageSwitcher([],"articles"),St()},addCategory:function(){b.find('[data-type="categories"] .sb-no-results').remove(),b.find(".sb-new-category-cnt").append('<div class="sb-input-setting sb-type-text"><div><input type="text"></div></div>')},delete:function(t,e=!1){var i,s=S(t).closest(".sb-nav").find(" > ul"),a=S(t).parent(),n=a.attr("data-id");for(i in this[e?"categories":"articles"].splice(a.index(),1),this.hide(),1<s.find("li").length?S(t).parent().remove():s.html(`<li class="sb-no-results">${I("No results found.")}</li>`),this.translations)for(var o=0;o<this.translations[i].length;o++)this.translations[i][o].id===n&&this.translations[i].splice(o,1);e||yt()},populate:function(e=!1,i=!1){if(!1===e&&(e=i?this.categories:this.articles),Array.isArray(e)){let t="";if(i?this.categories=e:this.articles=e,e.length)for(var s=0;s<e.length;s++)t+=`<li data-id="${e[s].id}">${i?"<span>"+e[s].id+"</span>":""}${e[s].title}<i class="bi-trash${i?" sb-category":""}"></i></li>`;else t=`<li class="sb-no-results">${I("No results found.")}</li>`;b.find(".sb-add-category,.sb-new-category-cnt").sbActive(i),b.find(".sb-add-article").sbActive(!i),b.find(".sb-nav").attr("data-type",i?"categories":"articles"),b.find(".sb-nav > ul").html(t),this.hide()}else SBF.error(e,"SBSettings.articles.populate")},updateActiveArticle:function(){var i=this.activeID();if(-1!=i){var s=b.find(".sb-language-switcher [data-language].sb-active").attr("data-language");let e=s?s in this.translations?this.translations[s]:[]:this.articles,t=[];W.each(function(){S(this).val()&&t.push(S(this).val())});for(var a=0;a<e.length;a++)if(e[a].id==i){article={id:i,title:b.find(".sb-article-title input").val(),content:b.find(".sb-article-content textarea").val(),link:b.find(".sb-article-link input").val(),categories:t,parent_category:X.val()},c&&typeof c.save!==ut?c.save().then(t=>{article.editor_js=t,article.content=function(t){let e="";return t.map(t=>{switch(t.type){case"header":e+=`<h${t.data.level}>${t.data.text}</h${t.data.level}>`;break;case"paragraph":e+=`<p>${t.data.text}</p>`;break;case"image":e+=`<img class="img-fluid" src="${t.data.file.url}" title="${t.data.caption}" /><em>${t.data.caption}</em>`;break;case"list":e+='<ul class="sb-ul-'+t.data.style+'">',t.data.items.forEach(function(t){e+=`<li>${t}</li>`}),e+="</ul>";break;case"code":e+=`<code>${t.data.code}</code>`;break;case"raw":e+=`<div class="bxc-raw-html">${t.data.html}</div>`}}),e}(t.blocks),e[a]=article,ht&&this.save(ht)}).catch(t=>{console.log(t)}):e[a]=article,SBF.null(article.title)&&this.delete(b.find(`.sb-nav [data-id="${i}"] i`));break}}},updateSelect:function(){let t=[];var e=X.val();let i='<option value=""></option>';W.each(function(){t.push(S(this).val())});for(var s=0;s<this.categories.length;s++)i+=`<option value="${this.categories[s].id}">${this.categories[s].title}</option>`;W.html(i),X.html(i),X.val(e);for(s=0;s<t.length;s++)W.eq(s).val(t[s])},addTranslation:function(t=!1,e){if(!1===t&&(t=this.activeID()),this.getTranslations(t).includes(t))return console.warn("Article translation already in array.");e in this.translations||(this.translations[e]=[]),this.translations[e].push({id:t,title:"",content:"",link:"",categories:[]})},getTranslations:function(t=!1){var e,i=[];for(e in!1===t&&(t=this.activeID()),this.translations)for(var s=this.translations[e],a=0;a<s.length;a++)if(s[a].id==t){i.push(e);break}return i},deleteTranslation:function(t=!1,e){if(!1===t&&(t=this.activeID()),e in this.translations)for(var i=this.translations[e],s=0;s<i.length;s++)if(i[s].id==t)return this.translations[e].splice(s,1),!0;return!1},activeID:function(){return b.find(".sb-content").attr("data-id")},hide:function(t=!0){b.find(".sb-content").setClass("sb-hide",t)}},automations:{items:{messages:[],emails:[],sms:[],popups:[],design:[],more:[]},translations:{},conditions:{datetime:["Date time",["Is between","Is exactly"],"dd/mm/yyy hh:mm - dd/mm/yyy hh:mm"],repeat:["Repeat",["Every day","Every week","Every month","Every year"]],browsing_time:["Browsing time",[],"seconds"],scroll_position:["Scroll position",[],"px"],include_urls:["Include URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],exclude_urls:["Exclude URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],referring:["Referring URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],user_type:["User type",["Is visitor","Is lead","Is user","Is not visitor","Is not lead","Is not user"]],returning_visitor:["Returning visitor",["First time visitor","Returning visitor"]],countries:["Countries",[],"Country codes separated by commas"],languages:["Languages",[],"Language codes separated by commas"],cities:["Cities",[],"Cities separated by commas"],custom_variable:["Custom variable",[],"variable=value"]},get:function(e){SBF.ajax({function:"automations-get"},t=>{this.items=t[0],this.translations=Array.isArray(t[1])&&!t[1].length?{}:t[1],e(t)})},save:function(e=!1){this.updateActiveItem(),SBF.ajax({function:"automations-save",automations:this.items,translations:this.translations},t=>{e&&e(t)})},show:function(t=!1,e=!1){this.updateActiveItem();var i=e?e in this.translations?this.translations[e]:[]:this.items,s=v.find(" > .sb-tab > .sb-content");for(r in!1===t&&(t=this.activeID()),this.hide(!1),i)for(var a=0;a<i[r].length;a++){var n=i[r][a],o=n.conditions;if(n.id==t){for(var r in J.html(""),n){var l=s.find(`[data-id="${r}"]`);l.hasClass("image")?(l.css("background-image",`url(${n[r]})`).attr("data-value",n[r]),""==n[r]&&l.removeAttr("data-value")):"checkbox"==l.attr("type")?l.prop("checked",n[r]):l.val(n[r])}if(o)for(var r in o){this.addCondition();var c=J.find(" > div:last-child");c.find("select").val(o[r][0]),this.updateCondition(c.find("select")),c.find(" > div").eq(1).find("select,input").val(o[r][1]),2<o[r].length&&c.find(" > div").eq(2).find("input").val(o[r][2])}return J.parent().setClass("sb-hide",e),s.sbLanguageSwitcher(this.getTranslations(t),"automations",e),!0}}return!1},add:function(){var t=SBF.random(),e=I("Item")+" "+(m.find("li:not(.sb-no-results)").length+1);this.updateActiveItem(),this.items[this.activeType()].push(this.itemArray(this.activeType(),t,e)),this.hide(!1),m.find(".sb-active").sbActive(!1),m.find(".sb-no-results").remove(),m.append(`<li class="sb-active" data-id="${t}">${e}<i class="bi-trash"></i></li>`),v.find(".sb-automation-values").find("input, textarea").val(""),v.sbLanguageSwitcher([],"automations"),J.html("")},delete:function(t){this.items[this.activeType()].splice(S(t).parent().index(),1),S(t).parent().remove(),this.hide(),0==this.items[this.activeType()].length&&m.html(`<li class="sb-no-results">${I("No results found.")}</li>`)},populate:function(t=!1){!1===t&&(t=this.activeType());let e="";var i=this.items[t];if(this.updateActiveItem(),i.length)for(var s=0;s<i.length;s++)e+=`<li data-id="${i[s].id}">${i[s].name}<i class="bi-trash"></i></li>`;else e=`<li class="sb-no-results">${I("No results found.")}</li>`;switch(m.html(e),e="",t){case"emails":e=`<h2>${I("Subject")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="subject" type="text"></div></div>`;break;case"popups":e=`<h2>${I("Title")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="title" type="text"></div></div><h2>${I("Profile image")}</h2><div data-type="upload-image" class="sb-input-setting sb-type-upload-image"><div class="input"><div data-id="profile_image" class="image"><i class="bi-x-lg"></i></div></div></div><h2>${I("Message fallback")}</h2><div class="sb-input-setting sb-type-checkbox"><div><input data-id="fallback" type="checkbox"></div></div>`;break;case"design":e=`<h2>${I("Header title")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="title" type="text"></div></div>`;for(s=1;s<4;s++)e+=`<h2>${I((1==s?"Primary":2==s?"Secondary":"Tertiary")+" color")}</h2><div data-type="color" class="sb-input-setting sb-type-color"><div class="input"><input data-id="color_${s}" type="text"><i class="sb-close bi-x-lg"></i></div></div>`;for(s=1;s<4;s++)e+=`<h2>${I(1==s?"Header background image":2==s?"Header brand image":"Chat button icon")}</h2><div data-type="upload-image" class="sb-input-setting sb-type-upload-image"><div class="input"><div data-id="${1==s?"background":2==s?"brand":"icon"}" class="image"><i class="bi-x-lg"></i></div></div></div>`;break;case"more":e=`<h2>${I("Department ID")}</h2><div class="sb-input-setting sb-type-number"><div><input data-id="department" type="number"></div></div><h2>${I("Agent ID")}</h2><div class="sb-input-setting sb-type-number"><div><input data-id="agent" type="number"></div></div><h2>${I("Tags")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="tags" type="text"></div></div>`}v.find(".sb-automation-extra").html(e),v.attr("data-automation-type",t),R.initColorPicker(v),this.hide()},updateActiveItem:function(){var t=this.activeID();if(t){var i=v.find(".sb-language-switcher [data-language].sb-active").attr("data-language"),s=this.activeType();let e=i?i in this.translations?this.translations[i][s]:[]:this.items[s];for(var a=J.find(" > div"),n=0;n<e.length;n++)if(e[n].id==t){e[n]={id:t,conditions:[]},v.find(".sb-automation-values").find('input,textarea,[data-type="upload-image"] .image').each(function(){e[n][S(this).attr("data-id")]=S(this).hasClass("image")&&S(this)[0].hasAttribute("data-value")?S(this).attr("data-value"):"checkbox"==S(this).attr("type")?S(this).is(":checked"):S(this).val()}),a.each(function(){let t=[];S(this).find("input,select").each(function(){t.push(S(this).val())}),t[0]&&t[1]&&(2==t.length||t[2])&&e[n].conditions.push(t)}),SBF.null(e[n].name)&&this.delete(m.find(`[data-id="${t}"] i`));break}}},addCondition:function(){J.append(`<div><div class="sb-input-setting sb-type-select sb-condition-1"><select>${this.getAvailableConditions()}</select></div></div>`)},updateCondition:function(e){S(e).parent().siblings().remove();var i=S(e).parents().eq(1);if(S(e).val()){var s=this.conditions[S(e).val()];let t="";if(s[1].length){t='<div class="sb-input-setting sb-type-select sb-condition-2"><select>';for(var a=0;a<s[1].length;a++)t+=`<option value="${SBF.stringToSlug(s[1][a])}">${I(s[1][a])}</option>`;t+="</select></div>"}i.append(t+(2<s.length?`<div class="sb-input-setting sb-type-text"><input placeholder="${I(s[2])}" type="text"></div>`:"")),i.siblings().find(".sb-condition-1 select").each(function(){var t=S(this).val();S(this).html(R.automations.getAvailableConditions(t)),S(this).val(t)})}else i.remove()},getAvailableConditions:function(t=""){let e='<option value=""></option>',i=[];for(var s in J.find(".sb-condition-1 select").each(function(){i.push(S(this).val())}),this.conditions)i.includes(s)&&s!=t||(e+=`<option value="${s}">${I(this.conditions[s][0])}</option>`);return e},addTranslation:function(t=!1,e=!1,i){if(!1===t&&(t=this.activeID()),!1===e&&(e=this.activeType()),this.getTranslations(t).includes(t))return console.warn("Automation translation already in array.");i in this.translations||(this.translations[i]={messages:[],emails:[],sms:[],popups:[],design:[]}),e in this.translations[i]||(this.translations[i][e]=[]),this.translations[i][e].push(this.itemArray(e,t))},getTranslations:function(t=!1){var e,i=[];for(e in!1===t&&(t=this.activeID()),this.translations){var s,a=this.translations[e];for(s in a)for(var n=a[s],o=0;o<n.length;o++)if(n[o].id==t){i.push(e);break}}return i},deleteTranslation:function(t=!1,e){if(!1===t&&(t=this.activeID()),e in this.translations){var i,s=this.translations[e];for(i in s)for(var a=s[i],n=0;n<a.length;n++)if(a[n].id==t)return this.translations[e][i].splice(n,1),!0}return!1},activeID:function(){var t=m.find(".sb-active");return!!t.length&&t.attr("data-id")},activeType:function(){return t.find("li.sb-active").data("value")},itemArray:function(t,e,i="",s=""){return S.extend({id:e,name:i,message:s},"emails"==t?{subject:""}:"popups"==t?{title:"",profile_image:""}:"design"==t?{title:"",color_1:"",color_2:"",color_3:"",background:"",brand:"",icon:""}:{})},hide:function(t=!0){v.find(" > .sb-tab > .sb-content").setClass("sb-hide",t)}},translations:{translations:{},originals:{},to_update:{},add:function(t){var e=R.getSettingObject(Q),i=e.attr("id"),s=Q.find("[data-language].sb-active");this.save(e,!!s.length&&s.attr("data-language")),e.find('textarea,input[type="text"]').val(""),this.save(e,t),Q.remove(),e.sbLanguageSwitcher(this.getLanguageCodes(i),"settings",t)},delete:function(t,e){var i=(t=R.getSettingObject(t)).attr("id");delete this.translations[e][i],t.find(`.sb-language-switcher [data-language="${e}"]`).remove(),this.activate(t)},activate:function(t,e=!1){var i=(t=R.getSettingObject(t)).attr("id"),s=(e?this.translations[e]:this.originals)[i];if("string"==typeof s)t.find("input, textarea").val(s);else for(var a in s)t.find("#"+a).find("input, textarea").val("string"==typeof s[a]?s[a]:s[a][0])},updateActive:function(){var t=f.find(".sb-translations-list");let i={front:{},admin:{},"admin/js":{},"admin/settings":{}};var e=t.attr("data-value");if(!SBF.null(e)){for(var s in i)t.find(' > [data-area="'+s+'"] .sb-input-setting:not(.sb-new-translation)').each(function(){i[s][S(this).find("label").html()]=S(this).find("input").val()}),t.find('> [data-area="'+s+'"] .sb-new-translation').each(function(){var t=S(this).find("input:first-child").val(),e=S(this).find("input:last-child").val();t&&e&&(i[s][t]=e)});this.to_update[e]=i}},save:function(t,e=!1){t=R.getSettingObject(t);let i={};var s=S(t).attr("id");"multi-input"==t.data("type")?t.find(".multi-input-textarea,.multi-input-text").each(function(){i[S(this).attr("id")]=S(this).find("input, textarea").val()}):i=t.find("input, textarea").val(),e?(e in this.translations||(this.translations[e]={}),this.translations[e][s]=i):this.originals[s]=i},load:function(o){let r=f.find(".sb-translations > .sb-content");r.find(" > .sb-hide").removeClass("sb-hide"),this.updateActive(),SBF.ajax({function:"get-translation",language_code:o},t=>{o in this.to_update&&(t=this.to_update[o]);let e="";for(var i=["front","admin","admin/js","admin/settings"],s=0;s<i.length;s++){var a,n=t[i[s]];for(a in e+=`<div${s?"":' class="sb-active"'} data-area="${i[s]}">`,n)e+=`<div class="sb-input-setting sb-type-text"><label>${a}</label><div><input type="text" value="${n[a]}"></div></div>`;e+="</div>"}r.find(".sb-translations-list").attr("data-value",o).html(e),r.find(".sb-menu-wide li").sbActive(!1).eq(0).sbActive(!0),r.sbLoading(!1)}),r.sbLoading(!0)},getLanguageCodes:function(t){var e,i=[];for(e in this.translations)t in this.translations[e]&&i.push(e);return i}}},N={chart:!1,active_report:!1,initChart:function(t,e="line",n=1){let o=[];var i,s=[],a=["#0eacb2","#299fb1","#4492b0","#5d86ae","#7379ac","#867cae","#9b70ad","#b06bae","#c465af","#d65fb1"];for(i in t)o.push(t[i][0]),s.push(i);if("line"!=e&&6<o.length)for(var r=0;r<o.length;r++)a.push("hsl(210, "+Math.floor(100*Math.random())+"%, "+Math.floor(100*Math.random())+"%)");this.chart&&this.chart.destroy(),this.chart=new Chart(x.find("canvas"),{type:e,data:{labels:s,datasets:[{data:o,backgroundColor:"line"==e?"#d4e7e952":a,borderColor:"line"==e?"#5c00ff":a,borderWidth:1}]},options:{legend:{display:!1},scales:{yAxes:[{ticks:{callback:function(t,e,i){return 1!=n&&2==n?new Date(1e3*t).toISOString().substr(11,8):t},beginAtZero:!0}}],xAxes:[{ticks:{beginAtZero:!0}}]},tooltips:{callbacks:{label:function(t,e){var i=t.index,s=e.datasets[0].data[i];switch(n){case 1:return s;case 2:return new Date(1e3*o[i]).toISOString().substr(11,8);case 3:return s+"%";case 4:var a=x.find(".sb-table tbody tr").eq(i).find("td");return a.eq(0).text()+" "+a.eq(1).text()}}},displayColors:!1}}})},initTable:function(t,e,i=!1){let s="<thead><tr>";for(var a,n=e[Object.keys(e)[0]].length-1,o=[],r=0;r<t.length;r++)s+=`<th>${t[r]}</th>`;for(a in s+="</tr></thead><tbody>",e)0!=e[a][n]&&o.push([a,e[a][n]]);i&&o.reverse();for(r=0;r<o.length;r++)s+=`<tr><td><div>${o[r][0]}</div></td><td>${o[r][1]}</td></tr>`;s+="</tbody>",x.find("table").html(s)},initReport:function(t=!1,e=!1){let n=x.find(".sb-tab > .sb-content");e=SBF.null(e)?[!1,!1]:e.split(" - "),n.sbLoading(!0),t&&(this.active_report=t),this.active_report&&this.getData(this.active_report,e[0],e[1],a=>{0==a?n.addClass("sb-no-results-active"):(n.removeClass("sb-no-results-active"),"status-client"==this.active_report?(n.addClass("sb-results-active"),n.find("#"+this.active_report).attr("style","display:block!important"),n.find(".sb-reports-tags .sb-tags").html(""),pt.forEach(t=>{let e=t;t=a.data.filter(t=>t.label==e);let s="";t.map(e=>{let i="";a.extra.map(t=>{t.user_id==e.user_id&&(i+=`<li class="add-user agent-name-tags">${t.first_name}</li>`)}),s+=`<div class="sb-responsive-tags">${e.first_name} ${e.last_name}<section class="flex-agents">${i}</section></div>`});var i=S('<div style="min-width: 180px;max-width: 554px;" class="sb-tags-details sb-hide"></div>');""!==s.trim()&&i.removeClass("sb-hide"),i.append(`<div>
								<h4 class="title-tags tags-${e}">
									<div>
										<i class="sb-icon bi-kanban-fill tags-${e}"></i>
									</div>
									<div class="white-title-elements">
										${e.toUpperCase()}(${t.length})
									</div>
									<div>
										<div class="arrow-down-tags white-title-elements">
											<i class="bi-check-lg"></i>
										</div>
									</div>
								</h4>
							</div>
							<div style="overflow: scroll;max-height: 420px;">${s}</div>`),n.find(".sb-reports-tags .sb-tags").append(i)})):(n.removeClass("sb-results-active"),n.find("#status-client").attr("style","display:none!important")),a.chart_type&&(this.initChart(a.data,a.chart_type,a.label_type),this.initTable(a.table,a.data,a["table-inverse"])),x.find(".sb-reports-title").html(a.title),x.find(".sb-reports-text").html(a.description),x.find(".bi-chevron-down").remove(),C||gt(x.find(".sb-collapse"),x.find("canvas").outerHeight()-135)),n.sbLoading(!1)})},getData:function(t,e=!1,i=!1,s){SBF.ajax({function:"reports",name:t,date_start:e,date_end:i},t=>{s(t)})},initDatePicker:function(){var t={ranges:{},applyClass:"reports-datepicker",locale:{format:"DD/MM/YYYY",separator:" - ",applyClass:"reports-datepicker",applyLabel:I("Apply"),cancelLabel:I("Cancel"),fromLabel:I("From"),toLabel:I("To"),weekLabel:I("W"),daysOfWeek:[I("Su"),I("Mo"),I("Tu"),I("We"),I("Th"),I("Fr"),I("Sa")],monthNames:[I("January"),I("February"),I("March"),I("April"),I("May"),I("June"),I("July"),I("August"),I("September"),I("October"),I("November"),I("December")],firstDay:1},showCustomRangeLabel:!1,alwaysShowCalendars:!0,autoApply:!0};t.ranges[I("Today")]=[moment(),moment()],t.ranges[I("Yesterday")]=[moment().subtract(1,"days"),moment().subtract(1,"days")],t.ranges[I("Last 3 Days")]=[moment().subtract(2,"days"),moment()],t.ranges[I("Last 5 Days")]=[moment().subtract(4,"days"),moment()],t.ranges[I("Last 7 Days")]=[moment().subtract(6,"days"),moment()],t.ranges[I("Last 15 Days")]=[moment().subtract(14,"days"),moment()],t.ranges[I("This Month")]=[moment().startOf("month"),moment().endOf("month")],x.find("#sb-date-picker").daterangepicker(t).val("")}},D={real_time:null,datetime_last_user:"2000-01-01 00:00:00",sorting:["creation_time","DESC"],user_types:["visitor","lead","user"],user_main_fields:["id","first_name","last_name","email","password","profile_image","user_type","creation_time","token","last_activity","department"],search_query:"",init:!1,busy:!1,table_extra:!1,history:[],filter:function(t){this.user_types=t="all"==t?["visitor","lead","user"]:"agent"==t?["agent","admin"]:[t],this.loading(),ot=nt=1;var e="online"==t[0]?["get-online-users",SB_ACTIVE_AGENT.id,this.sorting[0]]:["get-users",-1,this.sorting];SBF.ajax({function:e[0],sorting:e[2],user_types:t,search:this.search_query,extra:this.table_extra},t=>{this.populate(t),this.loading(!1)})},sort:function(t,e="DESC"){this.sorting=[t,e],this.loading(),ot=nt=1,SBF.ajax({function:"get-users",sorting:this.sorting,user_types:this.user_types,search:this.search_query,extra:this.table_extra},t=>{this.populate(t),this.loading(!1),console.log("Sorting completed successfully:",t)})},search:function(t){ft(t,(e,i)=>{ot=nt=1,SBF.ajax({function:1<e.length?"search-users":"get-users",search:e,user_types:this.user_types,sorting:this.sorting,extra:this.table_extra},t=>{this.user_types=["lead"],this.populate(t),this.search_query=e,S(i).sbLoading(!1),p.find("li").sbActive(!1).eq(0).sbActive(!0)})})},populate:function(t){let e="";var i=t.length;if(i)for(var s=0;s<i;s++)e+=this.getRow(new SBUser(t[s],t[s].extra));else e=`<p class="sb-no-results">${I("No users found.")}</p>`;l.parent().scrollTop(0),l.find("tbody").html(e),this.user_types.includes("agent")&&SBF.ajax({function:"get-online-users",agents:!0},t=>{let e=[];for(var i=0;i<t.length;i++)e.push(t[i].id);l.find("[data-user-id]").each(function(){S(this).find(".sb-td-profile").addClass("sb-"+(e.includes(S(this).attr("data-user-id"))?"online":"offline"))})})},update:function(){if(!this.busy){let n=["user","visitor","lead","agent"],o=n.includes(this.user_types[0])&&""==this.search_query,r=p.find(".sb-active").data("type");"online"==r?this.filter(r):(this.busy=!0,SBF.ajax({function:"get-new-users",datetime:this.datetime_last_user},e=>{var i=e.length;if(this.busy=!1,0<i){let t="";for(var s=0;s<i;s++){var a=new SBUser(e[s]);k[a.id]=a,this.updateMenu("add",a.type),o&&(t+=this.getRow(a))}if(o&&(l.find("tbody").prepend(t),n.includes(r))){let t="";for(s=0;s<n.length;s++)t+=n[s]==r?"":`[data-user-type="${n[s]}"],`;l.find(t.slice(0,-1)).remove()}this.datetime_last_user=e[0].creation_time}}))}},getRow:function(e,t){if(e instanceof SBUser){let t="";for(var i=0;i<this.table_extra.length;i++){var s=this.table_extra[i];t+=`<td class="sb-td-${s}">${this.user_main_fields.includes(s)?e.get(s):e.getExtra(s)}</td>`}return`<tr data-user-id="${e.id}" data-user-type="${e.type}"><td><input type="checkbox" /></td><td class="sb-td-profile"><a class="sb-profile"><img loading="lazy" src="${e.image}" class="sb-tags tags-${e.details.label}" style="max-width: 27px;max-height: 27px;padding: 2px;border:none;" /><span style="margin:0px 1px">${25<e.name.length?e.name.slice(0,25)+"...":e.name}</span></a></td>${t}<td style="overflow: hidden;max-width: 80px;text-overflow: ellipsis;overflow-wrap: break-word;" class="sb-td-email"class="sb-td-email">${e.get("email")}</td><td class="sb-td-ut">${I(e.type)}</td><td>${SBF.beautifyTime(e.get("last_activity"),!0)}</td><td>${SBF.beautifyTime(e.get("creation_time"),!0)}</td></tr>`}return SBF.error("User not of type SBUser","SBUsers.getRow"),!1},updateRow:function(t){var e,i,s=l.find(`[data-user-id="${t.id}"]`);s.length?(e=p.find(".sb-active").data("type"))===t.type||"admin"===t.type&&"agent"===e||"all"===e?(e=this.getRow(t),s.replaceWith(e),this.updateTagsLabel(t)):(e=d.find(`[data-type="${"admin"===t.type?"agent":t.type}"] span`),i=parseInt(e.attr("data-count")),e.html(i+1).attr("data-count",i+1),s.remove()):l.find("tbody").append(this.getRow(t))},updateTagsLabel:function(t){S(`[data-user-id="${t.id}"] .sb-tags`).removeClass().addClass("sb-tags tags-"+t.details.label)},updateMenu:function(t="all",e=!1){let i=["all","user","agent","lead","visitor"];"all"==t?SBF.ajax({function:"count-users"},t=>{for(var e=0;e<i.length;e++)this.updateMenuItem("set",i[e],t[i[e]])}):this.updateMenuItem(t,e)},updateMenuItem:function(t="set",e=!1,i=1){var e=p.find(`[data-type="${e}"] span`),s=["user","lead","visitor","agent"];"set"!==t&&(i=parseInt(e.attr("data-count"))+("add"===t?1:-1)),e.html(`<span style="vertical-align: sub;color: var(--chat-text-primary); font-weight:bold;">(${i})</span>`).attr("data-count",i);for(let t=i=0;t<s.length;t++)i+=parseInt(p.find(`[data-type="${s[t]}"] span`).attr("data-count"));p.find('[data-type="all"] span').html(`<span style="vertical-align: sub;color: var(--color-red); font-weight:bold;">(${i})</span>`).attr("data-count",i)},delete:function(e){this.loading(),Array.isArray(e)?SBF.ajax({function:"delete-users",user_ids:e},()=>{for(var t=0;t<e.length;t++)delete k[e[t]],l.find(`[data-user-id="${e[t]}"]`).remove(),_.find(`[data-user-id="${e[t]}"]`).remove();0==l.find("[data-user-id]").length&&this.filter(p.find(".sb-active").data("type")),T("Users deleted"),this.updateMenu(),this.loading(!1)}):k[e].delete(()=>{var t=_.find(`[data-user-id="${e}"]`);$().id==e&&$(!1),t.sbActive()&&(SBChat.conversation=!1,setTimeout(()=>{U.clickFirst()},300)),delete k[e],l.find(`[data-user-id="${e}"]`).remove(),t.remove(),d.sbHideLightbox(),T("User deleted"),this.updateMenu(),this.loading(!1)})},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update()},1e4))},stopRealTime:function(){clearInterval(this.real_time)},loading:function(t=!0){var e=o.find(".sb-loading-table");t?e.sbActive(!0):e.sbActive(!1)},csv:function(){SBF.ajax({function:"csv-users"},t=>{var t=JSON.parse(t),e=atob(t.file),e=new Blob([e],{type:"data:application/octet-stream;base64"}),i=document.createElement("a");i.href=window.URL.createObjectURL(e),i.download=t.filename,document.body.appendChild(i),i.click(),document.body.removeChild(i)})},updateUsersActivity:function(){SBF.updateUsersActivity(i?SB_ACTIVE_AGENT.id:-1,$()?$().id:-1,function(t){D.setActiveUserStatus("online"==t)})},setActiveAgentStatus:function(t=!0){var e=t?"online":"offline";i=t,a.find('[data-value="status"]').html(I(SBF.slugToString(e))).attr("class","sb-"+e),SBPusher.active&&(t?SBPusher.presence():SBPusher.presenceUnsubscribe()),SB_ADMIN_SETTINGS.reports_disabled||SBF.ajax({function:"reports-update",name:e})},setActiveUserStatus:function(t=!0){var e=y.find(".sb-conversation .sb-top > .sb-labels");e.find(".sb-status-online").remove(),t&&e.prepend(`<span class="sb-status-online">${I("Online")}</span>`),SBChat.user_online=t},onlineUserNotification:function(t){var e,i,s=SB_ADMIN_SETTINGS["online-users-notification"];s&&(e=t.info.first_name+" "+t.info.last_name,i=this.userProfileImage(t.info.profile_image),SB_ADMIN_SETTINGS["push-notifications"]&&"id"in t.info&&!this.history.includes(t.info.id)?SBF.ajax({function:"push-notification",title:s,message:e,icon:i,interests:SB_ACTIVE_AGENT.id,user_id:t.info.id}):U.desktop_notifications&&SBChat.desktopNotification(s,e,i,!1,t.info.id),this.history.push(t.info.id))},userProfileImage:function(t){return!t||t.indexOf("user.svg")?SB_ADMIN_SETTINGS["notifications-icon"]:t}},U={real_time:null,datetime_last_conversation:"2000-01-01 00:00:00",user_typing:!1,desktop_notifications:!1,flash_notifications:!1,busy:!1,is_search:!1,menu_count_ajax:!1,chat_tops:[{}],open:function(t=-1,e){-1!=t&&this.openConversation(t,e),d.sbHideLightbox(),a.find(".sb-admin-nav a").sbActive(!1).parent().find("#sb-conversations").sbActive(!0),d.find(" > main > div").sbActive(!1),y.sbActive(!0).find(".sb-board").removeClass("sb-no-conversation"),this.startRealTime()},openConversation:function(e,t=!1,b=!0){if(!1===t&&e)SBF.ajax({function:"get-user-from-conversation",conversation_id:e},t=>{SBF.null(t.id)?SBF.error("Conversation not found","SBAdmin.openConversation"):this.openConversation(e,t.id,b)});else{let g=y.find(".sb-conversation .sb-list");var i=SBF.null(k[t])||!("email"in k[t].details);let f=y.find(`[data-conversation-id="${e}"]`);g.html(""),g.sbLoading(!0),i?($(new SBUser({id:t})),$().update(()=>{k[t]=$(),this.updateUserDetails()})):($(k[t]),this.updateCurrentURL()),SBPusher.active&&(SBPusher.event("client-typing",t=>{t.user_id==$().id&&(U.typing(!0),clearTimeout(n),n=setTimeout(()=>{U.typing(!1)},1e3))}),SBPusher.event("new-message",()=>{SBChat.update()}),SBPusher.event("agent-active-conversation-changed",t=>{t.previous_conversation_id==e&&y.find(".sb-conversation-busy").remove()},"agents"),SBPusher.event("init",t=>{U.updateCurrentURL(t.current_url)}),SBPusher.event("message-status-update",t=>{SBChat.conversation&&SBChat.conversation.updateMessagesStatus(t.message_ids)})),_.find("li").sbActive(!1),f.sbActive(!0),-1!=e?$().getFullConversation(e,e=>{let t=e.get("conversation_status_code");var i=P.eq(0),s=i.find(".sb-active").attr("data-value"),a=(SBChat.setConversation(e),SBChat.populate(),this.setReadIcon(t),y.find(".sb-conversation-busy").remove(),this.updateUserDetails(),e.get("profile_image")),n=e.get("first_name"),o=S(window).width();let r;r=o<555?18<n.length?n.slice(0,18)+"...":n:27<n.length?n.slice(0,27)+"...":n;n=$().getExtra("phone").value,a=`
    <span style="padding-right:5px;" class="open-profile-name">
        <img src="${a}" class="top-image-profile">
        <span class="routin-top-content">Editar</span>
    </span> 
    <span style="margin: 0px 10px 0px 0px;">${r}</span>`,n=`
    <span class="additional-info">${n?`<a alt="Call from your Phone" href="tel:${n}"><i class="styling-caller bi ${o<555?"bi-telephone-fill":"bi-skype"}"></i></a>`:""}
    </span>`;y.find(".sb-top > a.routin-top-tip").html(a),y.find(".sb-top > a.routin-calls-chat").html(n);let l=!1;if(y.find(".sb-top > a.routin-top-tip > span").on("click",function(){var t=S(this).next(".additional-info");l?t.hide():t.show(),l=!l}),S(".sb-list").prepend('<div class="load-more"><span id="load-more" ><i style="vertical-align:middle;font-size: var(--chat-text-size-1-0);" class="bi-arrow-up-circle"></i> </div>'),SB_ADMIN_SETTINGS["smart-reply"]&&V.html(""),G.must_translate=SB_ADMIN_SETTINGS.translation&&$().language&&SB_ADMIN_SETTINGS["active-agent-language"]!=$().language,G.must_translate){var c=[];let s=[],a=[];for(var d=0;d<e.messages.length;d++){var u=e.messages[d];"bot"!=u.get("user_type")&&u.message&&(c.push(u.message),s.push(u.id),a.push(u.get("user_type")))}c.length&&M.dialogflow.translate(c,SB_ADMIN_SETTINGS["active-agent-language"],t=>{if(t)for(var e=0;e<t.length;e++){var i=SBChat.conversation.getMessage(s[e]);i&&(i.set("translation",t[e].translatedText),g.find(`[data-id="${s[e]}"]`).replaceWith(i.getCode(!0)),g.find(`[data-id="${s[e]}"] .sb-menu`).prepend(`<li data-value="original">${I(SBF.isAgent(a[e])?"View translation":"View original message")}</li>`))}})}var o=y.find("#conversation-department"),n=(o.length&&(a=o.find(`[data-id="${e.get("department")}"]`),o.find(" > p").attr("data-value",a.data("value")).html(a.html())),y.find("#conversation-agent")),a=(n.length&&(o=n.find(`[data-id="${e.get("agent_id")}"]`),n.find(" > p").attr("data-value",o.data("id")).html(o.html())),[1,2].includes(t)?t=0:t,s==t||6==s||S(q).find(".sb-search-btn").sbActive()||(i.find(`[data-value="${t}"]`).click(),i.find("ul").sbActive(!1)),C&&this.mobileOpenConversation(),f.length||s!=t&&(0!=s||1!=t&&6!=t)&&(6!=s||0!=t)||_.prepend(U.getListCode(e).replace("<li",'<li class="sb-active"')),f.sbActive(!0),b&&this.scrollTo(),e.get("busy"));if(a&&y.find(".sb-editor > .sb-agent-label").html(`<span data-agent="${a.id}" style="border-radius: 10px 10px 0px 0px;position: absolute;bottom: calc(100% - -1px);background: #006eff;color: #ffffff;padding: 4px 10px;font-size: var(--chat-text-size-9);left: 4px;right: 4px;text-align: center;"><b>${a.first_name} ${a.last_name}</b> ${I("was viewing the conversation.")} <i class="bi-check-all" style="vertical-align: middle;"></i></span>`),this.tags.update(e.details.tags),this.notes.update(e.details.notes),this.attachments(),SB_ADMIN_SETTINGS["smart-reply"]){let t=e.getLastUserMessage();V.html(""),(t=t&&t.payload("sb-human-takeover")?e.getLastUserMessage(t.get("index")):t)&&(M.dialogflow.smart_reply_data=!1,M.dialogflow.smartReply(t.message))}for(d=e.messages.length-1;0<d;d--){var h=e.messages[d].get("payload");let t=!1;if(h&&"rich-messages"in h)for(var p in h["rich-messages"]){p=h["rich-messages"][p];if("rating"==p.type){y.find(".sb-profile-list > ul").append(`<li data-id="rating"><i class="sb-icon bi-${1==p.result.rating?"hand-thumbs-up-fill":"hand-thumbs-down-fill"}"></i><span>${I("User rating")}</span></li>`),t=!0;break}}if(t)break}$().getConversations(function(t){y.find(".sb-user-conversations").html($().getConversationsCode(t))}),g.sbLoading(!1)}):(SBChat.clear(),_.find("li").sbActive(!1),g.sbLoading(!1)),i||this.updateUserDetails(),y.find(".sb-board").removeClass("sb-no-conversation"),D.updateUsersActivity(),this.startRealTime(),SBF.getURL("conversation")!=e&&vt("?conversation="+e)}},positionList(){var t=document.querySelectorAll("ul.sorting-by-last-message li"),t=(Array.from(t).sort((t,e)=>new Date(e.getAttribute("data-time")).getTime()-new Date(t.getAttribute("data-time")).getTime()).forEach((t,e)=>{t.style.order=e}),document.querySelector("ul.sorting-by-last-message"));t.style.display="flex",t.style.flexDirection="column"},populate:function(t,e,i){this.openConversation(t,e,i)},populateList:function(t){let e="",i=(w=[],t);i=i.sort(function(t,e){return new Date(e.creation_time).getTime()-new Date(t.creation_time).getTime()});for(var s=0;s<i.length;s++)e+=this.getListCode(i[s]),w.push(i[s]);""==e&&(e=`<p class="sb-no-results">${I("No conversations found.")}</p>`),_.html(e),_.css("position","relative"),_.css("bottom","15px"),U.positionList(),this.updateMenu(),SBF.event("SBAdminConversationsLoaded",{conversations:t})},update:function(){var t;this.busy||0!=P.eq(0).find("p").attr("data-value")||(this.busy=!0,SBF.ajax({function:"get-new-conversations",datetime:this.datetime_last_conversation},n=>{if(this.busy=!1,n.length){let e="",i="";var o=SBChat.conversation?SBChat.conversation.id:-1;let s,a=!1;var r=[];this.datetime_last_conversation=n[0].creation_time,D.updateMenu();for(var l=0;l<n.length;l++)if(!r.includes(n[l].conversation_id)){var c=n[l],d=c.conversation_status_code,u=c.user_id,h=c.conversation_id,p=o==h;let t=this.getListCode(c,null);var g=_.find(`[data-conversation-id="${h}"]`),f=g.index(),b=g.length,v=SBF.null(n[l].payload)?{}:JSON.parse(n[l].payload),m=c.message;40<m.length&&(m=m.substring(0,40)+"...",c.message=m),p?(t=t.replace("<li",'<li class="sb-active"'),b?(c.message&&g.replaceWith(t),w[f].conversation_status_code=d,this.setReadIcon(d)):a=!0):b&&(w[f]=c,_.find(`[data-conversation-id="${h}"]`).remove()),u in k||(k[u]=new SBUser({id:u,first_name:c.first_name,last_name:c.last_name,profile_image:c.profile_image,user_type:c.user_type})),p&&b||(2==d?(e+=t,w.unshift(c)):0!=d&&1!=d||(0==(s=_.find('[data-conversation-status="2"]').last()).length?e+=t:(w.splice(s.index()+1,0,c),i+=t)),u==$().id&&$().getConversations(function(t){y.find(".sb-user-conversations").html($().getConversationsCode(t))}),SBF.event("SBAdminNewConversation",{conversation:c})),$()&&("event"in v&&"update-user"==v.event||k[u].type!=c.user_type)&&$().update(()=>{this.updateUserDetails(),k[$().id]=$()}),""==c.message&&""==c.attachments||(U.newMsgTop(n[l],"add"),_.find(`[data-conversation-id="${h}"]`).attr("data-time",c.creation_time),this.positionList(),D.update()),SBChat.tab_active||2!=c.conversation_status_code||SBF.isAgent(c.message_user_type)&&!("preview"in v)||SBF.null(c.message)&&SBF.null(c.attachments)&&!("preview"in v)||(this.desktop_notifications&&(m=[c.first_name+" "+c.last_name,D.userProfileImage(c.profile_image)],g="preview"in v?v.preview:"notfimy",f=processMessage(g),SBChat.desktopNotification(m[0],f,m[1],h,u)),this.flash_notifications&&SBChat.flashNotification(),SBChat.audio&&["a","c","ic","ag"].includes(SB_ADMIN_SETTINGS.sounds)&&SBChat.audio.play()),r.push(h)}e&&_.prepend(e),i&&S(i).insertAfter(s),a&&this.scrollTo(),this.updateMenu()}}),(SB_ADMIN_SETTINGS["assign-conversation-to-agent"]||SB_ACTIVE_AGENT.department)&&(t=_.find(" > li").map(function(){return S(this).attr("data-conversation-id")}).get()).length&&SBF.ajax({function:"check-conversations-assignment",conversations_ids:t,agent_id:!!SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&SB_ACTIVE_AGENT.id,department:SB_ACTIVE_AGENT.department},t=>{if(t)for(var e=0;e<t.length;e++)_.find(`[data-conversation-id="${t[e]}"]`).remove()}))},updateMenu:function(){var e=_.find('[data-conversation-status="2"]').length,i=P.eq(0);const s=i.find(" > a").find(" > p span");if(100==e||this.menu_count_ajax){var i=i.find("li.sb-active").data("value");this.menu_count_ajax=!0,SBF.ajax({function:"count-conversations",status_code:0==i?2:i},t=>s.html(`(${t})`))}else{let t=document.getElementById("floatingElement");t||((t=document.createElement("div")).id="floatingElement",t.style.cssText="position: relative; top: 10px; margin: auto; display: flex; justify-content: center; z-index: 33;",(i=document.createElement("small")).className="notif",i.style.cssText="font-size: medium; padding: 6px 10px; border-radius: 30px;",t.appendChild(i),document.getElementById("sb-conversations").appendChild(t)),t.querySelector(".notif").textContent=e,t.style.visibility=0===e?"hidden":"visible"}},messageMenu:function(t){var e=`<li style="padding: 6px 15px; line-height:20px" data-value="read-text"> <i class="bi-volume-up-fill"></i> ${I("Leer")}</li>`;return`
				<i class="sb-menu-btn bi-three-dots"></i>
				<ul style="right: 0rem;padding: .4rem;" class="message-menu sb-menu">
					${d&&!SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS["allow-agent-delete-message"]||SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS["allow-supervisor-delete-message"]?`<li style="padding: 6px 15px; line-height:20px" data-value="delete"><i class="bi-trash"></i> ${I("Delete")}</li><hr>`:""}
					${e}
				</ul>`},updateUserDetails(){var t,e;$()&&(t=S(".sb-top > a"),e=15<(e=$().name).length?e.slice(0,15)+"...":e,t.find("span").eq(1).html(e),y.find(".sb-user-details .sb-profile").setProfile(),j.populate($(),y.find(".sb-profile-list")))},setReadIcon(t){let e=2==t;y.find('.sb-top [data-value="read"], .sb-top [data-value="unread"]').sbActive([0,1,2].includes(parseInt(t))).attr("data-value",e?"read":"unread").attr("data-sb-tooltip",I(e?"Mark as unread":"Mark as read")).each(function(){S(this).find("i").attr("class",e?"i-details bi-check-lg":"i-details bi-check-all"),S(this).find("span").text(I(e?"Mark as unread":"Mark as read"))})},getListCode:function(t,e){var i;t instanceof SBConversation&&(o=t.getLastMessage(),t={...t,...o});let s=t.message;40<(s=processMessage(s)).length&&(o=s.split(" "),s=o.slice(0,5).join(" ")+(5<o.length?"...":"")),!s&&t.attachments&&(i=(o=JSON.parse(t.attachments)).filter(t=>/\.(jpg|jpeg|png|webp|mp4)\b/g.test(t)),n=o.filter(t=>/\.(docx?|xlsx?|pdf)\b/g.test(t)),o=o.filter(t=>/\.(mp3|ogg)\b/g.test(t)),i=0<i.length?`<i class="bi-box"></i> ${I("Media")}: `+(1<i.length?"+"+(i.length-1):i.length):"",n=0<n.length?`<i class="bi-file-text"></i> ${I("Doc")}: `+(1<n.length?"+"+(n.length-1):n.length):"",o=0<o.length?`<i class="bi-mic-fill vertical-align"></i> ${I("Voice")}: `+(1<o.length?"+"+(o.length-1):o.length):"",s=[i,n,o].filter(Boolean).join(" ")),t.payload.includes("preview")&&(i=JSON.parse(t.payload.replace("\\'","'")))&&"preview"in i&&(s=i.preview);const a={"*":"strong","~":"s","```":"code"};Object.keys(a).forEach(i=>{var t=new RegExp(`\\${i}(.*?)\\`+i,"g");s.includes(i)&&(s=s.replace(t,(t,e)=>`<${a[i]}>${e}</${a[i]}>`))}),SBF.null(e)&&(e=t.conversation_status_code);var n=(new SBMessage).strip(s).replace(/_/g," "),o=!SBF.null(t.title);return`
    <li data-user-id="${t.user_id}" data-conversation-id="${t.conversation_id}" data-time="${new Date(t.creation_time).getTime()}" data-conversation-status="${e}" ${t.conversation_source?` data-conversation-source="${t.conversation_source}"`:""}>
        <small style="visibility:hidden;" class="source-conversation-icon">
            <img id="conversation-source-icon" class="source-buttons" src="../media/apps/${t.conversation_source}.svg">
        </small>
        <div class="sb-profile client-status">
            <img  class="client-icon-status sb-icon tags-${t.label} bi-kanban-fill loading="lazy" src="${t.profile_image}">
            <h3 class="sb-name${o?" sb-custom-name":""}">${o?t.title:t.first_name+" "+t.last_name}</h3>
            <div class="sb-info-conversations" style="min-width: 60px;text-align:right;flex: auto;font-size: .75rem;letter-spacing: .3px;margin: -2px 0px;">
                ${SBF.beautifyTime(t.creation_time)}
            </div>
        </div>
        <div>
            <a class="phone-number" style="color:inherit">${t.phone}</a>
        </div>
        <p class="message-received" style="max-width:calc(100% - 145px);">${n}</p>
        <div class="conversation-bar">
            <div class="no-read-icon sb-hide" style="margin: 0px 1px;">
                <svg width="20" height="20" viewBox="0 0 24.5 24.5" xmlns="http://www.w3.org/2000/svg" class="icon flat-color">
                    <circle cx="12" cy="12" r="10" class="check-circle"/>
                    
                </svg>
            </div>
        </div>
    </li>
`},newMsgTop(t=!1,e){document.querySelectorAll("ul.sorting-by-last-message li");var i=S(".sb-scroll-area");t&&((w=this.getUniqueChat(w,"user_id")).slice().sort((t,e)=>new Date(e.creation_time).getTime()-new Date(t.creation_time).getTime()).forEach((t,e)=>{S(`.sorting-by-last-message li[data-conversation-id='${t.conversation_id}']`).attr("style",`
				  transition: all .5s ease;
          webkit-transition: all .5s ease;
				  width:-webkit-fill-available;width:-moz-available;
          
				`)}),0<i.scrollTop())&&"add"===e&&requestAnimationFrame(()=>this.newMsgTop(t,e))},getUniqueChat:function(t,i){let s=[];return t.filter(function(e){s.findIndex(t=>t[i]==e[i])<=-1&&s.push(e)}),s},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update(),this.updateCurrentURL()},1e4),SBChat.startRealTime())},stopRealTime:function(){clearInterval(this.real_time),SBChat.stopRealTime()},timeZoneList:function(){Intl.supportedValuesOf("timeZone");var t=document.querySelector("#zones"),e=Intl.DateTimeFormat().resolvedOptions().timeZone;if(Intl.supportedValuesOf){t.innerHTML+="";for(const s of Intl.supportedValuesOf("timeZone"))t.innerHTML+=`<option ${e==s?"selected":""}>${s}</option>`}else{var i=new Option("Your browser does not support Intl.supportedValuesOf().",null,!0,!0);i.disabled=!0,t.options.add(i)}},transcript:function(t,e=!1){if(!("email"!=e||$()&&$().get("email")))return!1;SBF.ajax({function:"transcript",conversation_id:t},t=>{"email"==e?SBChat.sendEmail(SB_ADMIN_SETTINGS["transcript-message"],[[t,t]],!0):window.open(t)})},typing:function(t){t?(SBChat.user_online||D.setActiveUserStatus(!0),this.user_typing||(y.find(".sb-conversation .sb-top > .sb-labels").append('<span class="sb-status-typing" style="font-size: var(--chat-text-size-7);">'+I("Typing")+"</span>"),this.user_typing=!0)):this.user_typing&&(y.find(".sb-conversation .sb-top .sb-status-typing").remove(),this.user_typing=!1)},scrollTo:function(){var t=_.find(".sb-active"),t=t.length?t[0].offsetTop:0;_.parent().scrollTop(t-(C?120:70))},search:function(t){t&&ft(t,(t,e)=>{(at=1)<t.length?SBF.ajax({function:"search-conversations",search:t},t=>{U.populateList(t),S(e).sbLoading(!1),this.scrollTo(),this.is_search=!0}):(t=U.filters(),st=1,SBF.ajax({function:"get-conversations",status_code:t[0],tag:t[3]},t=>{U.populateList(t),S(e).sbLoading(!1),this.is_search=!1}))})},updateCurrentURL:function(t=!1){t?this.ucurl(t):SBChat.user_online&&$()&&$().getExtra("current_url")&&SBF.ajax({function:"current-url"},t=>{t&&this.ucurl(t)})},ucurl(t){var e=$().getExtra("current_url");t=t.replace("https://","").replace("http://","").replace("www.","").replace(/\/$/,""),y.find('.sb-profile-list [data-id="current_url"] label').attr("data-value",t).html(t),e&&(e.value=t,$().setExtra("current_url",e))},assignDepartment:function(t,e,i){SBF.ajax({function:"update-conversation-department",conversation_id:t,department:e,message:SBChat.conversation.getLastMessage().message},t=>{i(t)})},assignAgent:function(t,e,i=!1){SBF.ajax({function:"update-conversation-agent",conversation_id:t,agent_id:e,status_code:6,message:SBChat.conversation.getLastMessage().message},t=>{i&&i(t)})},setActiveDepartment:function(t){var e,i;SBChat.conversation&&SBChat.conversation.get("department")==t||(i=(e=y.find("#conversation-department")).find(`[data-id="${t}"]`),e.find(" > p").attr("data-value",i.data("value")).html(i.html()).next().sbActive(!1),SBChat.conversation.set("department",t),"agent"==SB_ACTIVE_AGENT.user_type&&SB_ACTIVE_AGENT.department&&SB_ACTIVE_AGENT.department!=t&&(_.find(`[data-conversation-id="${SBChat.conversation.id}"]`).remove(),U.clickFirst()),T("Department updated. The agents have been notified."))},setActiveAgent:function(t){var e=y.find("#conversation-agent"),i=e.find(`[data-id="${t}"]`);SBChat.conversation.set("agent_id",t),e.find(" > p").attr("data-value",i.data("value")).html(i.html()).next().sbActive(!1),"agent"!=SB_ACTIVE_AGENT.user_type||SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&!t||(_.find(`[data-conversation-id="${SBChat.conversation.id}"]`).remove(),U.clickFirst()),t&&T("Agent assigned. The agent has been notified.")},mobileOpenConversation:function(){y.find(".sb-admin-list").sbActive(!1),y.find(".sb-conversation").sbActive(!0),a.addClass("sb-hide")},mobileCloseConversation:function(){_.find("li.sb-active").sbActive(!1),y.find(".sb-admin-list").sbActive(!0),y.find(".sb-conversation").sbActive(!1),a.removeClass("sb-hide"),window.history.replaceState({},document.title,SBF.URL())},clickFirst:function(){_.find("li:first-child").length?(_.find("li:first-child").click(),U.scrollTo()):y.find(".sb-board").addClass("sb-no-conversation")},savedReplies:function(t,e){var i=e.charAt(t.selectionStart-1);if("/"==i&&(SBChat.editor_listening=!0),SBChat.editor_listening&&" "==i){var s=e.substr(e.lastIndexOf("/")+1).replace(" ","");SBChat.editor_listening=!1;for(var a=0;a<B.length;a++)if(B[a]["reply-name"]==s)return void S(t).val(e.substr(0,e.lastIndexOf("/"))+B[a]["reply-text"])}},attachments:function(){if(H.length){var e=SBChat.conversation.getAttachments();let t="";for(var i=0;i<e.length;i++){var s=e[i][0].slice(0,20);t+=`<a href="${e[i][1]}" class="bg-attachment" target="_blank"><i class="sb-icon bi-file-earmark-arrow-down"></i>${s+"..."} </a>`}S(H).html(""==t?"":`<h3>${I("Attachments")}</h3><div class="sb-list-items sb-list-links sb-list-icon">${t}</div>`),gt(H,160)}},filters:function(){for(var t=[],e=0;e<P.length;e++)t.push(P.eq(e).find("li.sb-active").data("value"));return(t[1]||t[3])&&(t[0]="all"),t},notes:{busy:!1,add:function(t,e,i,s,a=!1){let n=S("#alertdate").val();var o,r=S("#zones").val();n=""!=n&&(SBF.getTimezoneOffset(r)==(new Date).getTimezoneOffset()?n:new Date(n).toUTCString()),-1<navigator.userAgent.indexOf("Firefox")&&((o=new Date(n)).setHours(o.getHours()-3),n=""!=n&&(SBF.getTimezoneOffset(r)==(new Date).getTimezoneOffset()?moment.utc(n).format():new Date(n).toUTCString())),SBF.ajax({function:"add-note",conversation_id:t,user_id:e,name:i,message:s,alert:n,time_zone:r,status:!n},t=>{a&&a(t),S("#alertdate").val("")})},update:function(e,i=!1){if(O.length){let t="";for(var s=O.find(" > div"),a=0;a<e.length;a++){var n=e[a];t+=`<div data-id="${n.id}"><span class="sb-note-title">${n.name} ${SB_ACTIVE_AGENT.id==n.user_id?'<i class="sb-delete-note bi-x-lg"></i>':""}</span>${n.alert||n.time_zone?`<small class="note-alert-text" style="margin: 0px 6px;">${n.alert?SBF.localTime(n.alert,n.time_zone):""}${null!=n.time_zone?" "+n.time_zone:""}</small>`:""}<span class="note-content">${n.message}</span></div>`}i?s.append(t):s.html(t),s.attr("style","display: flex; flex-direction: column-reverse;"),O.find(".bi-chevron-down").remove(),gt(O,155),this.busy=!1}},delete:function(t,e,i=!1){this.busy||(this.busy=!0,SBF.ajax({function:"delete-note",conversation_id:t,note_id:e},t=>{this.busy=!1,i&&i(t)}))},readmore:function(t,e){return t.length<=e?(S(".dots").hide(),t):t.slice(0,e)+`<span class="more" style="display:none">${t.slice(e,t.length)}</span><span class="dots">...</span>`}},tags:{busy:!1,list:!1,update:function(e){if(z.length){let t="";for(var i=z.find(" > div"),s=0;s<e.length;s++)t+=`<span>${e[s]}</span>`;i.html(t),this.busy=!1}},getAll:function(t=[]){let e="";for(var i=0;i<this.list.length;i++)t.includes(this.list[i])||(e+=`<span>${this.list[i]}</span>`);return e}},showDirectMessageBox:function(t,e=[]){var i="email"==t;SBForm.clear(u),u.find(".sb-direct-message-users").val(e.length?e.join(","):""),u.find(".sb-bottom > div").html(""),u.find(".sb-top-bar > div:first-child").html(I("Broadcast "+("sms"==t?"text message":t))),u.find(".sb-loading").sbLoading(!1),u.find(".sb-direct-message-subject").sbActive(i).find("input").attr("required",i),u.attr("data-type",t),"email"!==t&&"sms"!==t?(u.find(".sb-selector").removeClass("sb-hide"),(new Metatemplate).init("#user-template-form"),"template"===u.find(".sb-select").val()&&u.find(".sb-select").val(null)):(u.find(".sb-selector").addClass("sb-hide"),S(".sb-bulk-sender").addClass("sb-hide"),S(".sb-direct-message-hide").removeClass("sb-hide")),u.find(".sb-select").on("change",function(){S(this).find(".active-bulk-sender").is(":selected")?(S(".sb-bulk-sender").removeClass("sb-hide"),S(".sb-direct-message-hide").addClass("sb-hide")):(u.find(".sb-selector").addClass("sb-hide"),S(".sb-bulk-sender").addClass("sb-hide"),S(".sb-direct-message-hide").removeClass("sb-hide"))}),u.sbShowLightbox()}},j={getAll:function(t){return SBForm.getAll(t)},get:function(t){return SBForm.get(t)},set:function(t,e){return SBForm.set(t,e)},getUserExtra:function(e){SBF.ajax({function:"get-user-extra",user_id:e},t=>{this.getUserExtra(e,response)})},show:function(i){L(),$(new SBUser({id:i})),$().update(()=>{this.populate($(),r.find(".sb-profile-list")),r.find(".sb-profile").setProfile(),$().getConversations(t=>{var e=$().type;SBF.isAgent(e)&&this.agentData(),r.find(".sb-user-conversations").html($().getConversationsCode(t)),r.find(".sb-top-bar [data-value]").sbActive(!1),SBF.null($().get("email"))||r.find(".sb-top-bar [data-value=email]").sbActive(!0),$().getExtra("phone")&&SB_ADMIN_SETTINGS.sms&&r.find(".sb-top-bar [data-value=sms]").sbActive(!0),this.boxClasses(r,e),r.attr("data-user-id",$().id).sbShowLightbox(),L(!1,!1),SBF.event("SBProfileBoxOpened",{user_id:i})}),k[i]=$(),SBF.getURL("user")!=i&&vt("?user="+i)})},showEdit:function(e){if(!(e instanceof SBUser))return SBF.error("User not of type SBUser","SBUsers.showEdit"),!1;{var i=g.find("#password input"),s=e.type,a=g.find("#user_type select");g.removeClass("sb-user-new").attr("data-user-id",e.id),g.find(".sb-top-bar .sb-save").html('<i class="bi-check-lg"></i>'+I("Save changes")),g.find(".sb-profile").setProfile(),g.find(".sb-custom-detail").remove(),g.find("input,select,textarea").removeClass("sb-error");let t="";var n,o=g.find(".sb-additional-details [id]").map(function(){return this.id}).get().concat(["facebook-id","ip","os","current_url","country_code","browser_language","browser"]);for(n in e.extra)o.includes(n)||(t+=`<div id="${n}" data-type="text" class="sb-input sb-custom-detail"><span>${I(e.extra[n].name)}</span><input type="text"></div>`);g.find(".sb-additional-details .sb-edit-box").append(t),this.populateEdit(e,g),this.updateRequiredFields(s),"admin"==SB_ACTIVE_AGENT.user_type&&SBF.isAgent(s)&&a.html(`<option value="agent">${I("Agent")}</option><option value="admin"${"admin"==s?" selected":""}>${I("Admin")}</option>`),i.val()&&i.val("********"),this.boxClasses(g,s),g.sbShowLightbox(),SBF.event("SBProfileEditBoxOpened",{user_id:e.id})}},populate:function(s,a){var t,e,i=["first_name","last_name","password","profile_image"];let n="",o="";for(r in a.hasClass("sb-profile-list")&&SBChat.conversation&&(t=SBChat.conversation.get("source"),e=SBChat.conversation.get("label"),o+=this.profileRow("conversation-id",SBChat.conversation.id,I("Conversation ID")),SBF.null(e)?o+=this.profileRow("conversation-label","Unknown",I("Label"),!0):o+=this.profileRow("conversation-label",e,I("Client status"),!0),SBF.null(t)?o+=this.profileRow("conversation-source","Unknown","",!0):o+=this.profileRow("conversation-source",{fb:"Facebook",ww:"Whatsmeow",wx:"waweb",wa:"WhatsApp",tm:"Text message",ig:"Instagram",tg:"Telegram",tk:"Tickets",wc:"WeChat",em:"Email",tw:"Twitter",bm:"Google"}[t]||t,I("Source"),!0)),"admin"!=SB_ACTIVE_AGENT.user_type&&i.push("token"),s.details)i.includes(r)||(o+=this.profileRow(r,s.get(r)));if(s.isExtraEmpty())SBF.ajax({function:"get-user-extra",user_id:s.id},t=>{for(var e=1;e<t.length;e++){var i=t[e].slug;s.setExtra(i,t[e]),o+=this.profileRow(i,t[e].value,t[e].name)}a.html(`<h3 class="sb-user-details-info">${I("User information")}</h3><ul>${n}${o}</ul>`),gt(a,56)});else{for(var r in s.extra){var l=s.getExtra(r);"phone"===r?n+=this.profileRow(r,l.value,l.name):o+=this.profileRow(r,l.value,l.name)}a.html(`<h3 class="sb-user-details-info">${I("User information")}</h3><ul>${n}${o}</ul>`),gt(a,56)}S("#change-conversation-source").change(function(t){const e=t.target.value;t=`${STMBX_URL}/media/apps/${e}.svg`,S("#conversation-source-icon").attr("src",t),SBF.ajax({function:"update-conversation-source",conversation_id:SBChat.conversation.id,source:e},t=>{T("Required reload"),S("#change-conversation-source").val(e),U.update()}),t="sb-icon bi-"+e;S('.sb-profile-list [data-id="conversation-source"] i').attr("class",t)}),S("#change-conversation-labels").change(function(t){var e,i;"Unknown"!==t.target.value&&(e=t.target.options[t.target.selectedIndex].text,i="sb-icon bi-kanban-fill tags-"+t.target.value,S('.sb-profile-list [data-id="conversation-label"] i').attr("class",i),S(`[data-user-id="${$().id}"] .bi-kanban-fill`).attr("class",i),S(`[data-user-id="${$().id}"] #label-name`).text(e)),j.updateLabel(t.target.value)}),S("#CstBtn a").click(function(t){var e=S(this).attr("id"),i=I(SBF.admin_set("label-names")[e]+" "),s="sb-icon bi-kanban-fill tags-"+e;S('.sb-profile-list [data-id="conversation-label"] i').attr("class",s),S(`[data-user-id="${$().id}"] .bi-kanban-fill`).attr("class",s),S(`[data-user-id="${$().id}"] #label-name`).text(i),j.updateLabelUI(e,i,s),j.updateLabel(e)})},updateLabelUI:function(t,e,i){S(`[data-user-id="${$().id}"] #label-name`).text(e),S('.sb-profile-list [data-id="conversation-label"] i').attr("class",i),S(`[data-user-id="${$().id}"] .bi-kanban-fill`).attr("class",i)},getLabel:function(t){SBF.ajax({function:"get-clientStatus-conversations",conversation_id:SBChat.conversation.id,label:t},t=>{"status-client"==N.active_report&&N.initReport("status-client")})},updateLabel:function(t){SBF.ajax({function:"update-clientStatus-conversations",conversation_id:SBChat.conversation.id,label:t},t=>{"status-client"==N.active_report&&N.initReport("status-client")})},profileRow:function(t,i,e=t,s=!1){if(""==i)return"";var a={id:"person-vcard","conversation-label":"tag","conversation-source":"tickets","conversation-id":"person-vcard",full_name:"person-bounding-box",email:"envelope",phone:"phone",user_type:"person-bounding-box",last_activity:"calendar",creation_time:"calendar",token:"shuffle",currency:"currency-exchange",location:"pin-map",country:"flag",address:"app",city:"app",postal_code:"app",os:"person-workspace",current_url:"radar",timezone:"clock"};let n=`<i class="sb-icon bi-${t in a?a[t]:"app"}"></i>`,o,r=!1;switch(t){case"last_activity":case"creation_time":i=SBF.beautifyTime(i);break;case"user_type":i=SBF.slugToString(i);break;case"country_code":case"language":case"browser_language":n=`<img src="${STMBX_URL}/media/flags/${i.toLowerCase()}.png" />`;break;case"browser":(o=i.toLowerCase()).includes("chrome")?r="chrome":o.includes("edge")?r="edge":o.includes("firefox")?r="firefox":o.includes("opera")?r="opera":o.includes("safari")&&(r="safari");break;case"os":(o=i.toLowerCase()).includes("windows")?r="windows":o.includes("mac")||o.includes("apple")||o.includes("ipad")||o.includes("iphone")?r="apple":o.includes("android")?r="android":o.includes("linux")?r="linux":o.includes("ubuntu")&&(r="ubuntu");break;case"conversation-source":case"browser":case"os":r=i.toLowerCase(),i=`<select disabled style="display:none; background: transparent; border-color: transparent;" id="change-conversation-source">
            <option value="tk" ${"Tickets"==i?"selected":""}>Live Chat</option>
            <option value="ww" ${"Whatsmeow"==i?"selected":""}>WhatsApp QR</option>
            <option value="wx" ${"waweb"==i?"selected":""}>WhatsApp Web</option>
            <option value="wa" ${"WhatsApp"==i?"selected":""}>WhatsApp API</option>
            <option hidden value="tg" ${"Telegram"==i?"selected":""}>Telegram</option>
            <option hidden value="bm" ${"Google"==i?"selected":""}>Google</option>
            <option hidden value="tm" ${"Text message"==i?"selected":""}>Text message</option>
            <option hidden value="un" ${"Unknown"==i?"selected":""}>Facebook</option>
            <option hidden value="ig" ${"Instagram"==i?"selected":""}>Instagram</option>
            <option hidden value="wc" ${"WeChat"==i?"selected":""}>WeChat</option>
            <option hidden value="em" ${"Email"==i?"selected":""}>Email</option>
            <option hidden value="tw" ${"Twitter"==i?"selected":""}>Twitter</option>
          </select>`,r&&"Unknown"!==i&&(n=`<img style="visibility:hidden;" src="${STMBX_URL}/media/${"conversation-source"==t?"apps":"devices"}/${r}.svg" />`);break;case"conversation-label":var l=i,c=pt;let e="";Array.isArray(c)&&c.forEach(function(t){e+=`<option value="${t}" ${i===t?"selected":""}>${I(SBF.get_value(t)+" ")}</option>`});c=`class="sb-invisible sb-icon bi-kanban-fill tags-${l}"`;i=`<select style="visibility:hidden;background: transparent; border-color: transparent;" id="change-conversation-labels">
            <option value='unknown'>${I("Client status")}</option> ${e} </select>`,n=`<i ${c}></i>`}return`<li data-id="${t}">${n}<span ${s?'style="visibility: hidden;"':""}>${I(SBF.slugToString(e))}</span><label style="overflow-wrap: break-word">${i}</label></li>`},populateEdit:function(s,t){t.find(".sb-details .sb-input").each((t,e)=>{this.set(e,s.details[S(e).attr("id")])}),t.find(".sb-additional-details .sb-input").each((t,e)=>{var i=S(e).attr("id");i in s.extra?this.set(e,s.extra[i].value):this.set(e,"")})},clear:function(t){SBForm.clear(t)},errors:function(t){return SBForm.errors(t.find(".sb-details"))},showErrorMessage:function(t,e){SBForm.showErrorMessage(t,e)},agentData:function(){let a=`<div class="sb-title">${I("Feedback rating")}</div><div class="sb-rating-area sb-loading"></div>`,n=r.find(".sb-agent-area");n.html(a),SBF.ajax({function:"get-rating"},t=>{var e,i,s;a=0==t[0]&&0==t[1]?`<p class="sb-no-results">${I("No ratings yet.")}</p>`:(e=t[0]+t[1],i=100*t[0]/e,s=100*t[1]/e,`<div><div>${I("Helpful")}</div><span data-count="${t[0]}" style="width: ${Math.round(2*i)}px"></span><div>${i.toFixed(2)} %</div></div>
          <div><div>${I("Not helpful")}</div><span data-count="${t[1]}" style="width: ${Math.round(2*s)}px"></span><div>${s.toFixed(2)} %</div></div>
          <p class="sb-rating-count">${e} ${I("Ratings")}</p>`),n.find(".sb-rating-area").html(a).sbLoading(!1)})},boxClasses:function(t,e=!1){S(t).removeClass("sb-type-admin sb-type-agent sb-type-lead sb-type-user sb-type-visitor").addClass(`${0!=e?"sb-type-"+e:""} sb-agent-`+SB_ACTIVE_AGENT.user_type)},updateRequiredFields:function(t){var e=SBF.isAgent(t);g.find("#password input").prop("required",e),g.find("#email input").prop(e||"user"==t||"lead"==t)}},G={dialog:F,open_popup:!1,must_translate:!1,is_logout:!1,conversations:U,users:D,settings:R,profile:j,apps:M};function _t(){SBF.ajax({function:"get-conversations"},t=>{0==t.length&&y.find(".sb-board").addClass("sb-no-conversation"),U.populateList(t),C&&y.find(".sb-admin-list").sbActive(!0),SBF.getURL("conversation")?(y.sbActive()||a.find(".sb-admin-nav #sb-conversations").click(),U.openConversation(SBF.getURL("conversation"))):C||SBF.getURL("user")||SBF.getURL("setting")||SBF.getURL("report")||SBF.getURL("area")&&"conversations"!=SBF.getURL("area")||U.clickFirst(),U.startRealTime(),U.datetime_last_conversation=SB_ADMIN_SETTINGS["now-db"],L(!1)}),SBPusher.initServiceWorker(),SB_ADMIN_SETTINGS["push-notifications"]&&SBPusher.initPushNotifications()}window.SBAdmin=G,S(document).ready(function(){if(d=S(".sb-admin"),a=d.find("> .sb-header"),y=d.find(".sb-area-conversations"),q=y.find(".sb-admin-list"),_=q.find(".sb-scroll-area ul"),P=q.find(".sb-select"),o=d.find(".sb-area-users"),l=o.find(".sb-table-users"),p=o.find(".sb-menu-users"),r=d.find(".sb-profile-box"),g=d.find(".sb-profile-edit-box"),f=d.find(".sb-area-settings"),v=f.find(".sb-automations-area"),J=v.find(".sb-conditions"),t=v.find(" > .sb-select"),m=v.find(" > .sb-tab > .sb-nav > ul"),x=d.find(".sb-area-reports"),b=f.find(".sb-articles-area"),W=b.find(".sb-article-categories select"),X=b.find(".sb-article-parent-category select"),et=y.find(".sb-replies"),it=y.find(".sb-status-chat"),tt=d.find(".sb-lightbox-overlay"),typeof STMBX_URL!=ut&&STMBX_URL.substr(0,STMBX_URL.indexOf("-content")-3),O=y.find(".sb-panel-notes"),z=y.find(".sb-panel-tags"),H=y.find(".sb-panel-attachments"),u=d.find(".sb-direct-message-box"),h=d.find(".sb-dialogflow-intent-box"),V=y.find(".sb-editor > .sb-suggestions"),window.onpopstate=function(){d.sbHideLightbox(),C&&y.sbActive()&&y.find(".sb-conversation").sbActive()&&U.mobileCloseConversation(),SBF.getURL("user")?(o.sbActive()||a.find(".sb-admin-nav #sb-users").click(),j.show(SBF.getURL("user"))):SBF.getURL("area")?a.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click():SBF.getURL("conversation")?(y.sbActive()||a.find(".sb-admin-nav #sb-conversations").click(),U.openConversation(SBF.getURL("conversation"))):SBF.getURL("setting")?(f.sbActive()||a.find(".sb-admin-nav #sb-settings").click(),f.find("#tab-"+SBF.getURL("setting")).click()):SBF.getURL("report")&&(x.sbActive()||a.find(".sb-admin-nav #sb-reports").click(),x.find("#"+SBF.getURL("report")).click())},SBF.getURL("area")&&setTimeout(()=>{a.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click()},300),typeof SB_ADMIN_SETTINGS==ut){let s=d.find(".sb-intall");void S(d).on("click",".sb-submit-installation",function(){if(!E(this)){let i=!1;var t=s.find("#first-name").length;if(SBForm.errors(s))i=t?"All fields are required. Minimum password length is 8 characters. Be sure you have entered a valid email.":"All fields are required.";else if(t&&s.find("#password input").val()!=s.find("#password-check input").val())i="The passwords do not match.";else{let e=window.location.href.replace("/admin","").replace(".php","").replace(/#$|\/$/,"");e.includes("?")&&(e=e.substr(0,e.indexOf("?"))),S.ajax({method:"POST",url:e+"/include/ajax.php",data:{function:"installation",details:S.extend(SBForm.getAll(s),{url:e})}}).done(t=>{if(0!=(t=JSON.parse(t))){if(!0===(t=t[1]))return void setTimeout(()=>{window.location.href=e+"?refresh=true"},1e3);switch(t){case"connection-error":i="Routin.bot cannot connect to the database. Please check the database information and try again.";break;case"missing-details":i="Missing database details! Please check the database information and try again.";break;case"missing-url":i="We cannot get the plugin URL.";break;default:i=t}}else i=t;!1!==i&&(SBForm.showErrorMessage(s,i),S("html, body").animate({scrollTop:0},500)),S(this).sbLoading(!1)})}!1!==i&&(SBForm.showErrorMessage(s,i),S("html, body").animate({scrollTop:0},500),S(this).sbLoading(!1))}})}else{var n;d.length&&(L(),d.removeAttr("style"),(window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||document.referrer.includes("android-app://"))&&d.addClass("sb-pwa"),rt&&typeof caches!==ut&&caches.delete("sb-pwa-cache"),d.find(" > .sb-rich-login").length||(SB_ADMIN_SETTINGS.pusher?(SBPusher.active=!0,SBPusher.init(()=>{SBPusher.presence(1,()=>{D.updateUsersActivity()}),SBPusher.event("update-conversations",()=>{U.update(),SBChat.update()},"agents"),SBPusher.event("set-agent-status",t=>{t.agent_id==SB_ACTIVE_AGENT.id&&D.setActiveAgentStatus("online"==t.status)},"agents"),_t()})):(_t(),setInterval(function(){D.updateUsersActivity()},1e4)),D.table_extra=l.find("th[data-extra]").map(function(){return S(this).attr("data-field")}).get(),S(window).on("beforeunload",function(){$()&&SBF.ajax({function:"on-close"})}),S(window).keydown(function(t){var e=t.which;let i=!1;if([13,27,46].includes(e)){if(d.find(".sb-dialog-box").sbActive()){var s=d.find(".sb-dialog-box");switch(e){case 46:case 27:s.find(".sb-cancel").click();break;case 32:case 13:s.find("info"!=s.attr("data-type")?".sb-confirm":".sb-close").click()}i=!0}else if([46].includes(e)&&y.sbActive()){if(y.find(".sb-editor textarea").is(":focus"))return;var a=y.find(" > div > .sb-conversation");a.find('.sb-top [data-value="'+(3==a.attr("data-conversation-status")?"delete":"archive")+'"]').click(),i=!0}else[46,27].includes(e)&&(d.find(".sb-lightbox").sbActive()?(d.sbHideLightbox(),i=!0):(a=d.find(".sb-search-btn.sb-active")).length&&(a.find("i").click(),i=!0));i&&t.preventDefault()}}),S(document).on("click keydown mousemove",function(){SBF.debounce(function(){SBChat.tab_active||SBF.visibilityChange(),SBChat.tab_active=!0,clearTimeout(dt),dt=setTimeout(()=>{SBChat.tab_active=!1},1e4)},"#3",8e3)}),n=0,document.onpaste=function(t){var e,i,s,a,t=t.clipboardData.items[0];0===t.type.indexOf("image")&&((e=new FileReader).onload=function(t){},i=new FormData,s=`screenshot-${n++}.png`,a=t.getAsFile(),i.append("fname",s),i.append("file",a),jQuery.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:i,type:"POST",success:function(t){SBF.uploadResponse(t)}}),e.readAsDataURL(t.getAsFile()))},S(document).ready(function(){S(a).on("click",".help-center",function(){d.find(".sb-updates-box").sbShowLightbox()})}),typeof Notification===ut||"all"!=SB_ADMIN_SETTINGS["desktop-notifications"]&&"agents"!=SB_ADMIN_SETTINGS["desktop-notifications"]||SB_ADMIN_SETTINGS["push-notifications"]||(U.desktop_notifications=!0),"all"!=SB_ADMIN_SETTINGS["flash-notifications"]&&"agents"!=SB_ADMIN_SETTINGS["flash-notifications"]||(U.flash_notifications=!0),lt.getDate()!=SBF.storage("admin-clean")&&setTimeout(function(){SBF.ajax({function:"cron-jobs"}),SBF.storage("admin-clean",lt.getDate())},1e4),S(d).on("click",".bi-chevron-down",function(){var t=S(this).sbActive(),e=t?S(this).parent().data("height")+"px":"";S(this).html(I(t?"View more":"Close")),S(this).parent().find("> div, > ul").css({height:e,"max-height":e}),S(this).sbActive(!t)}),S(d).on("click",".sb-popup-close",function(){d.sbHideLightbox()}),d&&(S(document).on("click",function(t){S(t.target).closest(".sb-menu-mobile").length||(S(".sb-menu-mobile > i").removeClass("sb-active"),S(".open-profile").removeClass("sb-hide"))}),S(d).on("click",".sb-menu-mobile > i",function(){S(this).toggleClass("sb-active"),G.open_popup=S(this).parent()}),S(d).on("click",".sb-menu-mobile a",function(){S(this).closest(".sb-menu-mobile").find(" > i").sbActive(!1)}),S(d).on("click",".sb-menu-wide,.sb-nav",function(){S(this).toggleClass("sb-active")}),S(d).on("click",".sb-menu-wide > ul > li, .sb-nav > ul > li",function(t){var e=S(this).parent().parent();return e.find("li").sbActive(!1),e.find("> div:not(.sb-menu-wide):not(.sb-btn)").html(S(this).html()),e.sbActive(!1),e.find("> .sb-menu-wide").length&&e.closest(".sb-scroll-area").scrollTop(e.next()[0].offsetTop-(d.hasClass("sb-header-hidden")?70:130)),t.preventDefault(),!1}),S(d).find(".sb-admin-list .sb-scroll-area, main > div > .sb-scroll-area,.sb-area-settings > .sb-tab > .sb-scroll-area,.sb-area-reports > .sb-tab > .sb-scroll-area").on("scroll",function(){var t=S(this).scrollTop();A.last<t-10&&A.header?(d.addClass("sb-header-hidden"),A.header=!1):t+10<A.last&&!A.header&&!A.always_hidden&&(d.removeClass("sb-header-hidden"),A.header=!0),A.last=t}),S(d).on("click",".sb-search-btn i, .sb-filter-btn i",function(){S(this).parent().sbActive()?(S(".sb-top").css("top","+=0px"),S(this).parent().hasClass("sb-filter-btn")&&S(".sb-search-btn, .inbox, .non-hover").addClass("sb-hide"),S(this).hasClass("bi-search")?S(this).removeClass("bi-search").addClass("bi-x-lg"):S(this).hasClass("bi-x-lg")?S(this).removeClass("bi-x-lg").addClass("bi-filter"):S(this).hasClass("bi-filter")&&S(this).removeClass("bi-filter").addClass("bi-filter-circle")):(A.always_hidden=!1,_.parent().scrollTop()<10&&(d.removeClass("sb-header-hidden"),S(this).parent().hasClass("sb-filter-btn")&&S(".sb-search-btn, .inbox, .non-hover").removeClass("sb-hide"),S(this).hasClass("bi-filter-circle")?S(this).removeClass("bi-filter-circle").addClass("bi-filter"):S(this).hasClass("bi-filter")?S(this).removeClass("bi-filter").addClass("bi-x-lg"):S(this).hasClass("bi-x-lg")&&S(this).removeClass("bi-x-lg").addClass("bi-search")))}),S(d).on("click","#open-modal-button",function(){console.log("open",d.find(".sb-send-template-box")),d.find(".sb-send-template-box").sbShowLightbox()}),S(d).on("click","#meta-broadcast-button",function(){console.log("open"),d.find(".meta-broadcast-box").sbShowLightbox()}),S(d).on("click",".sb-top .sb-btn-back",function(){U.mobileCloseConversation()}),S(document).ready(function(){var t=S(l),e=t.find("th:first-child"),i=t.find("tr");function s(){S(window).width()<555?(e.addClass("sb-invisible"),e.css("margin","-20px"),i.addClass("sb-active")):(e.removeClass("sb-invisible"),e.css("margin",""),i.removeClass("sb-active"))}s(),S(window).resize(s)}),S(l).on("click","th:first-child",function(){S(this).parent().toggleClass("sb-active")})),S(y).on("click","> .sb-btn-collapse, .collapse",function(){S(this).toggleClass("sb-active"),y.find(S(this).hasClass("sb-left")?".sb-admin-list":".sb-top").toggleClass("sb-active")}),S(y).on("click",".sb-conversation",function(){S(".sb-admin-list, .sb-btn-collapse.sb-left.bi-arrow-left-short.sb-active").removeClass("sb-active")}),S(y).on("click",".sb-list, .sb-editor",function(){S(".sb-admin-list, .sb-btn-collapse.sb-left.bi-arrow-left-short.sb-active").removeClass("sb-active"),S(".sb-user-details.sb-top.sb-active, .sb-top.sb-active").removeClass("sb-active")}),S(a).on("click"," .sb-admin-nav a",function(){var t=S(this).attr("id");switch(a.find(".sb-admin-nav a").sbActive(!1),d.find(" > main > div").sbActive(!1),d.find("."+S(this).attr("id").replace("sb-","sb-area-")).sbActive(!0),S(this).sbActive(!0),SBF.deactivateAll(),t){case"sb-conversations":C||SBF.getURL("conversation")||U.clickFirst(),U.update(),U.startRealTime(),D.stopRealTime();break;case"sb-users":D.startRealTime(),U.stopRealTime(),D.init||(L(),ot=nt=1,SBF.ajax({function:"get-users",user_types:["user","visitor","lead"],extra:D.table_extra},t=>{D.populate(t),D.updateMenu(),D.init=!0,D.datetime_last_user=SBF.dateDB("now"),L(!1)}));break;case"sb-settings":R.init||(L(),SBF.ajax({function:"get-all-settings"},t=>{if(t){var e,i=t["external-settings-translations"];for(e in R.initHTML(t),R.translations.translations=Array.isArray(i)&&!i.length?{}:i,delete t["external-settings-translations"],t)R.set(e,t[e])}R.initPlugins(),L(!(R.init=!0))})),D.stopRealTime(),U.stopRealTime();break;case"sb-reports":x.sbLoading()&&S.getScript(STMBX_URL+"/vendor/moment.min.js",()=>{S.getScript(STMBX_URL+"/vendor/daterangepicker.min.js",()=>{S.getScript(STMBX_URL+"/vendor/chart.min.js",()=>{N.initDatePicker(),N.initReport("conversations"),x.sbLoading(!1)})})}),D.stopRealTime(),U.stopRealTime()}var t=t.substr(3),e=SBF.getURL("area");"reports"==t&&S("#"+N.active_report).click(),e!=t&&("conversations"==t&&!SBF.getURL("conversation")||"users"==t&&!SBF.getURL("user")||"settings"==t&&!SBF.getURL("setting")||"reports"==t&&!SBF.getURL("report"))&&vt("?area="+t)}),S(a).on("click",".sb-profile",function(){S(this).next().toggleClass("sb-active")}),S(a).on("click",'[data-value="logout"],.logout',function(){G.is_logout=!0,SBF.ajax({function:"on-close"}),D.stopRealTime(),U.stopRealTime(),SBF.logout()}),S(a).on("click",'[data-value="edit-profile"],.edit-profile',function(){L();let t=new SBUser({id:SB_ACTIVE_AGENT.id});t.update(()=>{$(t),y.find(".sb-board").addClass("sb-no-conversation"),_.find(".sb-active").sbActive(!1),j.showEdit(t)})}),S(a).on("click",'[data-value="status"]',function(){D.setActiveAgentStatus(!S(this).hasClass("sb-online"))}),S(a).find(".sb-account").setProfile(SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image),S(_).on("click","li",function(){(new SBMessage).setLoad(30),U.openConversation(S(this).attr("data-conversation-id"),S(this).attr("data-user-id"),!1),SBF.deactivateAll()}),S(d).on("click",".sb-user-conversations li",function(){U.openConversation(S(this).attr("data-conversation-id"),$().id,S(this).attr("data-conversation-status"))}),S(y).on("click",".sb-top ul a",function(){let e=-1,t="The conversation will be ",i=S(this).attr("data-value");document.querySelectorAll("ul.sorting-by-last-message li");let s=SBChat.conversation.id;switch(i){case"inbox":e=0,t+="restored.";break;case"archive":t+="archived.",e=3;break;case"follow-up":t+="assigned for follow-up.",e=6;break;case"delete":t+="moved to the Bot container. Bot flow restarted.",e=4;break;case"empty-trash":e=5,t="The bot will permanently delete all conversations in the container, including their messages.";break;case"transcript":U.transcript(s,S(this).attr("data-action"));break;case"read":e=0,t+="marked as read.";break;case"unread":e=2,t+="marked as unread."}-1!=e&&F(t,"alert",function(){SBF.ajax({function:"update-conversation-status",conversation_id:s,status_code:e},()=>{if([0,3,4].includes(e))for(var t=0;t<w.length;t++)if(w[t].conversation_id==s){w[t].conversation_status_code=e;break}SB_ADMIN_SETTINGS["close-message"]&&3==e&&(SBF.ajax({function:"close-message",conversation_id:s,bot_id:SB_ADMIN_SETTINGS["bot-id"]}),SB_ADMIN_SETTINGS["close-message-transcript"])&&U.transcript(s,"email"),[0,2].includes(e)&&(_.find(".sb-active").attr("data-conversation-status",e),U.setReadIcon(e)),"inbox"!=i&&[0,2].includes(e)||(P.eq(0).find("li.sb-active").click(),P.eq(0).find("ul").sbActive(!1)),M.is("slack")&&[3,4].includes(e)&&SBF.ajax({function:"archive-slack-channels",conversation_user_id:SBChat.conversation.get("user_id")})}),SBChat.conversation&&SBChat.conversation.id==s&&SBChat.conversation.set("conversation_status_code",e)})}),S(function(){S(y).on("click",'ul.sorting-by-last-message li[data-conversation-status="2"]',function(){var t=S(this).attr("data-conversation-id");SBF.ajax({function:"update-conversation-status",conversation_id:t,status_code:0},function(){S(this).attr("data-conversation-status",0),_.find(".sb-active").attr("data-conversation-status",0),U.setReadIcon(0)});var t=S(this).find(".sb-name.span-profile-detail"),e=t.text();20<e.length&&t.text(e.slice(0,17)+"...")}),S(y).on("click",".sb-top .open-profile",function(){S([y.find(".sb-user-details"),this]).toggleClass("sb-active")})}),SBF.ajax({function:"saved-replies"},t=>{let e=`<p class="sb-no-results">${I("No saved replies found. Add new saved replies via Settings > Admin")}</p>`;if(Array.isArray(t)&&0<t.length&&t[0]["reply-name"]){e="",B=t;for(var i=0;i<t.length;i++)e+=`<li><div>${"/"+t[i]["reply-name"]}</div><div>${t[i]["reply-text"]}</div></li>`}et.find(".sb-replies-list > ul").html(e).sbLoading(!1)}),S(y).on("click","#load-saved-replies",function(){et.sbTogglePopup(this)}),S(et).on("click",".sb-replies-list li",function(){SBChat.insertText(S(this).find("div:last-child").html()),SBF.deactivateAll(),d.removeClass("sb-popup-active")}),S(et).on("input",".sb-search-btn input",function(){let s=S(this).val().toLowerCase();SBF.search(s,()=>{let t="";for(var e=!(1<s.length),i=0;i<B.length;i++)(e||B[i]["reply-name"].toLowerCase().includes(s)||B[i]["reply-text"].toLowerCase().includes(s))&&(t+=`<li><div>${B[i]["reply-name"]}</div><div>${B[i]["reply-text"]}</div></li>`);et.find(".sb-replies-list > ul").html(t)})}),S(y).on("click","#set-status",function(){it.sbTogglePopup(this)}),S(q).find(".sb-scroll-area").on("scroll",function(){if(!ct&&!U.is_search&&bt(this,!0)&&at){let t=y.find(".sb-admin-list");var e=U.filters();ct=!0,t.append('<div class="sb-loading-global sb-loading"></div>'),SBF.ajax({function:"get-conversations",pagination:st,status_code:e[0],user_type:"agent",department:e[1],source:e[2],tag:e[3]},e=>{if(setTimeout(()=>{ct=!1},500),at=e.length,e.sort(function(t,e){return new Date(e.creation_time).getTime()-new Date(t.creation_time).getTime()}),at){let t="";for(var i=0;i<at;i++)t+=U.getListCode(e[i],"append"),w.push(e[i]);st++,_.append(t),U.positionList(),bt(this,!1,1e3)}t.find(" > .sb-loading").remove(),SBF.event("SBAdminConversationsLoaded",{conversations:e})})}}),S(document).on("SBMessageDeleted",function(){var t=SBChat.conversation.getLastMessage();0!=t?(t.details.conversation_id,new Date(t.details.creation_time).getTime(),U.newMsgTop(t.details,"add"),_.find("li.sb-active p").html(t.message),_.find("li.sb-active .sb-profile .sb-time").html(t.details.creation_time)):(U.newMsgTop({conversation_id:SBChat.conversation.id},"deleted"),_.find("li.sb-active").remove(),U.clickFirst(),U.scrollTo())}),S(document).on("SBMessageSent",function(t,e){let i=e.conversation_id;var s=_.find(`[data-conversation-id="${i}"]`);let a=I("Error. Message not sent to");var n=e.conversation,o=e.user,s=(e.message&&s.find("p").html(e.message),-1!=e.conversation_status_code&&(s.attr("data-conversation-status",e.conversation_status_code),U.updateMenu()),M.messenger.check(n)&&M.messenger.send(o.getExtra("facebook-id").value,n.get("extra"),e.message,e.attachments,e.message_id,t=>{t&&"error"in t&&F(a+" Messenger: "+t.error.message,"info")}),SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"])),s=(M.whatsapp.check(n)&&M.whatsapp.send(M.whatsapp.activeUserPhone(o),"[rating]"===e.message?s:e.message,e.attachments,n.get("extra"),t=>{t&&!t.error?T("<i class='bi-wind'></i> Message ent successfully"):T("<i class='bi-send-exclamation'></i> Message could not be sent to API Cloud","warning")},t=>{T("<i class='bi-info-circle'></i> Failed to send message. Please try again later","warning"),console.error("Error sending message to WhatsApp:",t)}),SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"])),s=(M.whatsmeow.check(n)&&(e.message_id,"[rating]"==e.message&&(e.message=s),M.whatsmeow.send(M.whatsapp.activeUserPhone(o),e.message,e.attachments,n.get("extra"),t=>{t.status?T("<i class='bi-whatsapp'></i> Message Sent to WhatsApp mobile"):T("<i class='bi-send-exclamation'></i> Message could not be sent. Please check your connection. ","warning")},t=>{T("<i class='bi-info-circle'></i> Error with WhatsApp API. Please check your connection. ","error")})),SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"]));M.waweb.check(n)&&(e.message_id,"[rating]"==e.message&&(e.message=s),M.waweb.send(M.whatsapp.activeUserPhone(o),e.message,e.attachments,n.get("extra"),t=>{t.status?T("<i class='bi-whatsapp'></i> Message Sent to WhatsApp mobile"):T("<i class='bi-send-exclamation'></i> Message could not be sent. Please check your connection. ","warning")},t=>{T("<i class='bi-info-circle'></i> Error with WhatsApp API. Please check your connection. ","error")})),M.telegram.check(n)&&("[rating]"==e.message&&(e.message=s),M.telegram.send(n.get("extra"),e.message,e.attachments,t=>{"ok"in t&&t.ok||F(a+" Telegram: "+JSON.stringify(t),"info")})),M.twitter.check(n)&&("[rating]"==e.message&&(e.message=s),M.twitter.send(o.getExtra("twitter-id").value,e.message,e.attachments,t=>{!t||"event"in t?1<e.attachments.length&&T("Only the first attachment was sent to Twitter.","info"):F(JSON.stringify(t),"info")})),M.gbm.check(n)&&("[rating]"==e.message&&(e.message=s),M.gbm.send(o.getExtra("gbm-id").value,e.message,e.attachments,t=>{t[0]&&"error"in t[0]&&F(a+" Google: "+t[0].error.message,"info")})),SB_ADMIN_SETTINGS["smart-reply"]&&V.html(""),SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&SBF.null(n.get("agent_id"))&&U.assignAgent(i,SB_ACTIVE_AGENT.id,()=>{SBChat.conversation.id==i&&(SBChat.conversation.set("agent_id",SB_ACTIVE_AGENT.id),S(y).find("#conversation-agent > p").attr("data-value",SB_ACTIVE_AGENT.id).html(SB_ACTIVE_AGENT.full_name))})}),S(document).on("SBNewMessagesReceived",function(t,s){var a=s.get("payload");let n=y.find(".sb-conversation");var e=SBF.isAgent(s.get("user_type"));if(setTimeout(function(){n.find(".sb-top .sb-status-typing").remove()},300),SB_ADMIN_SETTINGS["smart-reply"]&&(e?SB_ADMIN_SETTINGS["smart-reply-agent-assistant"]&&M.dialogflow.smartReplyUpdate(s.message):M.dialogflow.smartReply(s.message)),G.must_translate){let e=SBChat.conversation.getMessage(s.id),i=n.find(`[data-id="${s.id}"]`);var o="original-message"in a&&a["original-message"];o?(e.set("translation",o),i.replaceWith(e.getCode(!0)),n.find(`[data-id="${s.id}"] .sb-menu`).prepend(`<li data-value="original">${I("View translation")}</li>`)):s.message&&M.dialogflow.translate([s.message],SB_ADMIN_SETTINGS["active-agent-language"],t=>{t&&(e.set("translation",t[0].translatedText),i.replaceWith(e.getCode(!0)),n.find(`[data-id="${s.id}"] .sb-menu`).prepend(`<li data-value="original">${I("View original message")}</li>`))})}if("queryResult"in a&&"fulfillmentMessages"in a.queryResult)for(var i=a.queryResult.fulfillmentMessages,r=0;r<i.length;r++)if("payload"in i[r]){var l=i[r].payload;if("department"in l){U.setActiveDepartment(l.department);break}if("agent"in l){U.setActiveAgent(l.agent);break}}"ErrorCode"in a&&F("Error. Message not sent to WhatsApp. Error message: "+a.ErrorMessage,"info"),"whatsapp-fallback"in a&&T("Message sent as text message."+("whatsapp-template-fallback"in a?" The user has been notified via WhatsApp Template notification.":"")),"whatsapp-template-fallback"in a&&!("whatsapp-fallback"in a)&&T("The user has been notified via WhatsApp Template notification."),e||SBChat.conversation.id!=s.get("conversation_id")||SBChat.user_online||D.setActiveUserStatus(),U.update()}),S(document).on("SBNewConversationCreated",function(){U.update()}),S(document).on("SBEmailSent",function(){T("The user has been notified by email.")}),S(document).on("SBSMSSent",function(){T("The user has been notified by text message.")}),S(document).on("SBNotificationsSent",function(t,e){T(`The user has been notified by email${e.includes("sms")?" and text message":""}.`)}),S(document).on("SBTyping",function(t,e){U.typing(e)}),S(q).on("input",".sb-search-btn input",function(){U.search(this)}),S(y).on("click",".sb-admin-list .sb-search-btn i",function(){SBF.searchClear(this,()=>{U.search(S(this).next())}),S(".non-hover, .sb-filter-btn").toggleClass("sb-hide"),S("#hideOnSearchClick").toggleClass("sb-hide")}),S("#hideOnSearchClick li:first-child, #hideOnSearchClick li:nth-child(2)").addClass("transition-opacity"),S(".bi-search").click(function(){var t=S("#hideOnSearchClick li:first-child"),e=S("#hideOnSearchClick li:nth-child(2)");t.css("opacity",0==t.css("opacity")?1:0),e.toggleClass("sb-invisible").css("margin-right",function(t,e){return"-43px"===e?"0px":"-43px"})}),S(y).on("click",".sb-admin-list .sb-select li",function(){let i=_.parent();E(i)||setTimeout(()=>{let e=U.filters();at=st=1,SBF.ajax({function:"get-conversations",status_code:e[0],department:e[1],agent:SB_ACTIVE_AGENT.id,source:e[2],tag:e[3]},t=>{U.populateList(t),y.find(".sb-conversation").attr("data-conversation-status",e[0]),t.length?C||(SBChat.conversation?(t=_.find(`[data-conversation-id="${SBChat.conversation.id}"]`)).length?t.sbActive(!0):e[0]==SBChat.conversation.get("conversation_status_code")&&_.prepend(U.getListCode(SBChat.conversation).replace("<li",'<li class="sb-active"')):(U.clickFirst(),U.scrollTo())):(y.find(".sb-board").addClass("sb-no-conversation"),SBChat.conversation=!1),i.sbLoading(!1)})},100)}),S(y).on("click",".sb-user-details .sb-scroll-area div.sb-profile, .routin-top-tip",function(){let t;S(this).hasClass("sb-profile")?t=_.find(".sb-active").attr("data-user-id"):S(this).hasClass("routin-top-tip")&&(t=S(this).attr("data-user-id")),$().id!=t&&$(k[t]),j.show($().id)}),S(d).on("click",'.sb-profile-list [data-id="location"]',function(){F('<iframe src="https://maps.google.com/maps?q='+S(this).find("label").html().replace(", ","+")+'&output=embed"></iframe>',"map")}),S(d).on("click",'.sb-profile-list [data-id="address"], .sb-profile-list [data-id="city"], .sb-profile-list [data-id="country"]',function(){let t="",e="",i="";"address"===S(this).data("id")?(t=S(this).find("label").text(),e=S('.sb-profile-list [data-id="city"] label').text(),i=S('.sb-profile-list [data-id="country"] label').text()):"city"===S(this).data("id")?(t=S('.sb-profile-list [data-id="address"] label').text(),e=S(this).find("label").text(),i=S('.sb-profile-list [data-id="country"] label').text()):"country"===S(this).data("id")&&(t=S('.sb-profile-list [data-id="address"] label').text(),e=S('.sb-profile-list [data-id="city"] label').text(),i=S(this).find("label").text()),F(`<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(`${t}, ${e}, `+i)}&output=embed"></iframe>`,"map")}),S(d).on("click",'.sb-profile-list [data-id="timezone"]',function(){SBF.getLocationTimeString($().extra,t=>{L(!1),F(t,"info")})}),S(d).on("click",'.sb-profile-list [data-id="current_url"]',function(){var t=S(this).find("label");window.open(SBF.null(t.attr("data-value"))?t.html():t.attr("data-value"))}),S(d).on("click",'.sb-profile-list [data-id="conversation-source"]',function(t){var e=S(this).find("option:selected").html().toLowerCase();"whatsapp"!=e&&"whatsmeow"!=e&&"waweb"!=e||$().getExtra("phone")}),S(y).on("click",'.sb-menu [data-value="bot"]',function(){M.dialogflow.showCreateIntentBox(S(this).closest("[data-id]").attr("data-id"))}),S(h).on("click",'.sb-intent-add [data-value="add"]',function(){h.find("> div > .sb-type-text").last().after('<div class="sb-input-setting sb-type-text"><input type="text"></div>')}),S(h).on("click",'.sb-intent-add [data-value="previous"],.sb-intent-add [data-value="next"]',function(){for(var t=h.find(".sb-first input"),e=t.val(),i="next"==S(this).attr("data-value"),s=SBChat.conversation.getUserMessages(),a=s.length,n=0;n<a;n++)if(s[n].message==e&&(i&&n<a-1||!i&&0<n)){n+=i?1:-1,t.val(s[n].message),h.attr("data-message-id",s[n].id);break}}),S(h).on("click",".sb-send",function(){M.dialogflow.submitIntent(this)}),S(h).on("input",".sb-search-btn input",function(){M.dialogflow.searchIntents(S(this).val())}),S(h).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{M.dialogflow.searchIntents(S(this).val())})}),S(h).on("click","#sb-intent-preview",function(){M.dialogflow.previewIntent(h.find("#sb-intents-select").val())}),S(h).on("change","#sb-intents-select",function(){h.find(".sb-bot-response").css("opacity",S(this).val()?.5:1)}),S(y).on("click","#conversation-department li",function(t){let e=S(this).parent().parent();return S(this).data("value")==e.find(" > p").attr("data-value")||(SBChat.conversation?e.sbLoading()||F(`${I("All agents assigned to the new department will be notified. The new department will be")} ${S(this).html()}.`,"alert",()=>{let t=S(this).data("id");e.sbLoading(!0),U.assignDepartment(SBChat.conversation.id,t,()=>{U.setActiveDepartment(t),e.sbLoading(!1),e.find(" > p").attr("data-value",t)})}):S(this).parent().sbActive(!1),t.preventDefault(),!1)}),S(y).on("click","#conversation-agent li",function(t){let e=S(this).parent().parent(),i=S(this).data("id");return i==e.find(" > p").attr("data-value")||i==SB_ACTIVE_AGENT.id||(SBChat.conversation?e.sbLoading()||F(`${I("The new agent will be")} ${S(this).html()}.`,"alert",()=>{e.sbLoading(!0),U.assignAgent(SBChat.conversation.id,i,()=>{U.setActiveAgent(i),SBChat.conversation.set("conversation_status_code",6);var t=_.find(`[data-conversation-id="${SBChat.conversation.id}"]`),t=(t.attr("data-conversation-status","6"),t.find(".sb-status")),t=(t.length&&t.attr("data-sb-status","6"),w.findIndex(t=>t.id===SBChat.conversation.id));-1!==t&&(w[t].conversation_status_code=6),U.update(),U.updateMenu(),y.find(".sb-conversation-details").sbActive()&&U.updateConversationDetails(),e.sbLoading(!1)})}):S(e).addClass("sb-active sb-responsive-absolute-position"),t.preventDefault(),!1)}),O.on("click","> i",function(t){return d.find(".sb-notes-box").sbShowLightbox(),S.getScript("https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js").done(()=>{s()}).fail(()=>{S.getScript(STMBX_URL+"/vendor/moment.min.js",()=>{s()})}),t.preventDefault(),!1}),O.on("click",".sb-delete-note",function(){let e=S(this).parents().eq(1);U.notes.delete(SBChat.conversation.id,e.attr("data-id"),t=>{!0===t?e.remove():SBF.error(t)})}),O.on("click",".sb-note-contain",function(){var t=S(this).find(".note-content .more"),e=S(this).find(".note-content .dots");"none"==t.css("display")?t.show():t.hide(),"none"==t.css("display")?e.show():e.hide()}),S(d).on("click",".sb-add-note",function(){let e=S(this).parent().parents().eq(1).find("textarea"),i=e.val();0==i.length?SBForm.showErrorMessage(d.find(".sb-notes-box"),"Please write something..."):E(this)||U.notes.add(SBChat.conversation.id,SB_ACTIVE_AGENT.id,SB_ACTIVE_AGENT.full_name,i,t=>{Number.isInteger(t)?(S(this).sbLoading(!1),d.sbHideLightbox(),U.notes.update([{id:t,conversation_id:SBChat.conversation.id,user_id:SB_ACTIVE_AGENT.id,name:SB_ACTIVE_AGENT.full_name,message:i,alert:S("#alertdate").val(),time_zone:S("#zones").val(),status:!1}],!0),e.val(""),T("New note successfully added."),s()):SBForm.showErrorMessage(t)})}),z.on("click","> i",function(t){let e=S(d).find(".sb-tags-box"),i=e.find(".sb-tags-cnt"),s="",a=SBChat.conversation.details.tags,n='<i id="sb-add-tag" class="bi-plus-lg sb-btn-icon"></i>';for(var o=0;o<a.length;o++)s+=`<span class="sb-active">${a[o]}</span>`;return U.tags.list?i.html(s+U.tags.getAll(a)+n):(e.sbLoading(!0),SBF.ajax({function:"get-tags"},t=>{U.tags.list=t,i.html(s+U.tags.getAll(a)+n),e.sbLoading(!1)})),e.sbShowLightbox(),t.preventDefault(),!1}),S(document).on("click","#tags-container.tagged > span",function(){let e=S(this);e.text();var t=SBChat.conversation.id;SBF.ajax({function:"update-tags",conversation_id:t,tags:[null]},t=>{T(!0===t[0]?"The bot is deleting tags in database...":t),!0===t[0]&&(e.remove(),S(".sb-tags-box .sb-tags-cnt span.sb-active").remove())})}),S(d).on("click",".sb-tags-cnt > span",function(){S(this).toggleClass("sb-active")}),S(d).on("click","#sb-add-tag",function(){S('<input type="text">').insertBefore(this)}),S(d).on("click","#sb-save-tags",function(){if(!E(this)){let i=d.find(".sb-tags-box").find("span.sb-active,input").map(function(){return S(this).is("span")?S(this).html():S(this).val()}).toArray(),s=SBChat.conversation.id;SBF.ajax({function:"update-tags",conversation_id:s,tags:i},t=>{var e;S(this).sbLoading(!1),U.tags.list=t[1],!0===t[0]&&(U.tags.update(i),SBChat.conversation)&&s==SBChat.conversation.id&&(e=U.filters()[3],SBChat.conversation.set("tags",i),e)&&!i.includes(e)&&(_.find(`[data-conversation-id="${s}"]`).remove(),U.clickFirst()),d.sbHideLightbox(),T(!0===t[0]?"Tags have been successfully updated.":t)})}}),S(V).on("click","span",function(){SBChat.insertText(S(this).html()),V.html("")}),S(y).on("click",".sb-list .sb-menu > li",function(){let t=S(this).closest("[data-id]"),e=t.attr("data-id");var i=SBChat.conversation.getMessage(e).get("user_type"),s=S(this).attr("data-value");switch(s){case"delete":SBChat.user_online?SBF.ajax({function:"update-message",message_id:e,message:"",attachments:[],payload:{event:"delete-message"}},()=>{SBChat.conversation.deleteMessage(e),t.remove()}):SBChat.deleteMessage(e);break;case"translation":case"original":var a="translation"==s,n=SBF.isAgent(i);t.replaceWith(SBChat.conversation.getMessage(e).getCode(a)),y.find(`[data-id="${e}"] .sb-menu`).prepend(`<li data-value="${a?"original":"translation"}">${I(n&&!a||!n&&a?"View original message":"View translation")}</li>`)}}),S(y).on("click",".sb-filter-btn i",function(){S(this).parent().toggleClass("sb-active")}),SBF.getURL("user")&&(a.find(".sb-admin-nav #sb-users").click(),setTimeout(()=>{j.show(SBF.getURL("user"))},500)),S(l).on("click","th :checkbox",function(){l.find("td :checkbox").prop("checked",S(this).prop("checked"))}),S(l).on("click",":checkbox",function(){var t=o.find('[data-value="delete"]');l.find("td input:checked").length?t.removeAttr("style"):t.hide()}),S(p).on("click","li",function(){D.filter(S(this).data("type"))}),S(o).on("input",".sb-search-btn input",function(){D.search(this)}),S(o).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{D.search(S(this).next())})}),S(l).on("click","th:not(:first-child)",function(){var t=S(this).hasClass("sb-order-asc")?"DESC":"ASC";S(this).toggleClass("sb-order-asc"),S(this).siblings().sbActive(!1),S(this).sbActive(!0),D.sort(S(this).data("field"),t)}),S(l).parent().on("scroll",function(){!ct&&!D.search_query&&bt(this,!0)&&ot&&(ct=!0,o.append('<div class="sb-loading-global sb-loading sb-loading-pagination"></div>'),SBF.ajax({function:"get-users",pagination:nt,sorting:D.sorting,user_types:D.user_types,search:D.search_query,extra:D.table_extra},e=>{if(setTimeout(()=>{ct=!1},500),ot=e.length){let t="";for(var i=0;i<ot;i++){var s=new SBUser(e[i],e[i].extra);t+=D.getRow(s),k[s.id]=s}nt++,l.find("tbody").append(t),bt(this,!1,1e3)}o.find(" > .sb-loading-pagination").remove()}))}),S(g).on("click",".sb-delete",function(){F("This user will be deleted permanently including all linked data, conversations, and messages.","alert",function(){D.delete($().id)})}),S(l).on("click","td:not(:first-child)",function(){j.show(S(this).parent().attr("data-user-id"))}),S(r).on("click",".sb-top-bar .sb-edit",function(){j.showEdit($())}),S(o).on("click",".sb-new-user",function(){g.addClass("sb-user-new"),g.find(".sb-top-bar .sb-profile span").html(I("Add new user")),g.find(".sb-top-bar .sb-save").html('<i class="bi-check-lg"></i>'+I("Add user")),g.find("input,select,textara").removeClass("sb-error"),"admin"==SB_ACTIVE_AGENT.user_type&&g.find("#user_type").find("select").html(`<option value="lead">${I("Lead")}</option><option value="agent">${I("Agent")}</option><option value="admin">${I("Admin")}</option>`),j.clear(g),j.boxClasses(g),j.updateRequiredFields("user"),g.sbShowLightbox()}),S(g).on("click",".sb-save",function(){if(!E(this)){let e=!!g.hasClass("sb-user-new"),i=g.attr("data-user-id");var t=j.getAll(g.find(".sb-details")),s=j.getAll(g.find(".sb-additional-details"));j.errors(g)?(j.showErrorMessage(g,SBF.isAgent(g.find("#user_type :selected").val())?"First name, last name, password and a valid email are required. Minimum password length is 8 characters.":g.hasClass("sb-user-new")?"First name, last name, and a valid email are required.":`First name and last name ${"user"==t.user_type[0]||"lead"==t.user_type[0]?"email":""} are required.`),S(this).sbLoading(!1)):SBF.ajax({function:e?"add-user":"update-user",user_id:i,settings:t,settings_extra:s},t=>{SBF.errorValidation(t,"duplicate-email")||SBF.errorValidation(t,"duplicate-phone")?(j.showErrorMessage(g,`This ${SBF.errorValidation(t,"duplicate-email")?"email":"phone number"} is already in use.`),S(this).sbLoading(!1)):(e&&(i=t,$(new SBUser({id:i}))),$().update(()=>{k[i]=$(),e?(j.clear(g),D.update()):(D.updateRow($()),y.sbActive()&&U.updateUserDetails(),i==SB_ACTIVE_AGENT.id&&(SBF.loginCookie(t[1]),SB_ACTIVE_AGENT.full_name=$().name,SB_ACTIVE_AGENT.profile_image=$().image,a.find(".sb-account").setProfile())),S(this).sbLoading(!1),g.find(".sb-profile").setProfile(),T(e?"New user added":"User updated"),d.sbHideLightbox()}),SBF.event("SBUserUpdated",{new_user:e,user_id:i}))})}}),S(".sb-area-users").on("click","#csv_contacts",function(){S("#csvimport").click()}),S("#csvimport").on("change",function(t){var e=new FormData;e.append("csv",this.files[0]),e.append("function","csv-users-add"),event.preventDefault(),S.ajax({url:STMBX_URL+"/include/ajax.php",method:"POST",data:e,dataType:"json",contentType:!1,cache:!1,processData:!1,success:function(t){T(t.success),S("#csvimport").val("")},error:function(t,e,i){SBF.error("csv-users-add",i),S("#csvimport").val("")}})}),S(g).on("change","#user_type",function(){var t=S(this).find("option:selected").val();j.boxClasses(g,t),j.updateRequiredFields(t)}),S(r).on("click",".sb-user-conversations li",function(){U.open(S(this).attr("data-conversation-id"),S(this).find("[data-user-id]").attr("data-user-id"))}),S(r).on("click",".sb-start-qr-conversation",function(){U.open(-1,$().id),U.openConversation(-1,$().id),C&&U.mobileOpenConversation()}),S(r).on("click",".sb-start-tk-conversation",function(){U.open(-1,$().id),U.openConversation(-1,$().id),C&&U.mobileOpenConversation()}),S(r).on("click",".sb-start-conversation",function(){U.open(-1,$().id),U.openConversation(-1,$().id),C&&U.mobileOpenConversation(),SBChat.sendMessage(-1,!1,!1,!1),d.find(".sb-send-template-box").sbShowLightbox()}),S(r).on("click",".sb-top-bar [data-value]",function(){U.showDirectMessageBox(S(this).attr("data-value"),[$().id])}),S(o).on("click",".sb-top-bar [data-value]",function(){var t=S(this).data("value");let e=[];switch(l.find("tr").each(function(){S(this).find('td input[type="checkbox"]').is(":checked")&&e.push(S(this).attr("data-user-id"))}),t){case"message":case"email":case"sms":U.showDirectMessageBox(t,e);break;case"csv":D.csv();break;case"delete":if(e.includes(SB_ACTIVE_AGENT.id))return T("You cannot delete yourself.","error");F("The bot will delete all selected users and their related data, conversations, and messages permanently.","alert",()=>{D.delete(e),S(this).hide(),l.find("th:first-child input").prop("checked",!1)})}}),S(d).on("change",".sb-select",function(){console.log("sb-select change event triggered");var t=S(this).val();S(this).closest(".sb-direct-message-box").attr("data-type",t)}),S(d).on("click",".sb-send-direct-message",function(t){console.log("sb-send-direct-message click event triggered"),t.preventDefault();let s=S(this).closest(".sb-direct-message-box"),a=s.attr("data-type"),n=s.find(".sb-direct-message-subject input").val(),o=s.find("textarea").val(),r=s.find(".sb-direct-message-users").val().replace(/ /g,""),e=null;if(console.log("Type:",a),console.log("Subject:",n),console.log("Message:",o),console.log("User IDs:",r),"template"===a&&(e=(new Metatemplate).payload("#user-template-form"),console.log("Payload:",e)),!E(this))if("message"==a&&SBF.ajax({function:"direct-message",user_ids:r,message:o},t=>{S(this).sbLoading(!1);let e=SB_ADMIN_SETTINGS["notify-user-email"],i=SB_ADMIN_SETTINGS["sms-active-users"];if(SBF.errorValidation(t))return SBForm.showErrorMessage(s,"An error has occurred. Please make sure all user ids are correct.");(e||i)&&SBF.ajax({function:"get-users-with-details",user_ids:r,details:e&&i?["email","phone"]:[e?"email":"phone"]},t=>{e&&t.email.length?c(t.email,o,0,i?t.phone:[],"email",n):i&&t.phone.length?c(t.phone,o,0,[],"sms"):d.sbHideLightbox()}),T(SBF.slugToString(a)+" sent to all users.")}),"template"==a)console.log("Sending messages..."),SBF.ajax({function:"direct-message",user_ids:r,message:o,template:"template"===a,payload:e},t=>{if(console.log("Direct message response:",t),S(this).sbLoading(!1),SBF.errorValidation(t))return console.log("Error validation occurred"),SBForm.showErrorMessage(s,"An error has occurred. Please make sure all user IDs are correct.");if(t.template_phone)c(t.template_phone,e.BodyTemplate,0,[],"template");else{let e=SB_ADMIN_SETTINGS["notify-user-email"],i=SB_ADMIN_SETTINGS["sms-active-users"];(e||i)&&(console.log("Getting users with details..."),SBF.ajax({function:"get-users-with-details",user_ids:r,details:e&&i?["email","phone"]:[e?"email":"phone"]},t=>{console.log("Users with details response:",t),e&&t.email.length?c(t.email,o,0,i?t.phone:[],"email",n):i&&t.phone.length?c(t.phone,o,0,[],"sms"):d.sbHideLightbox()})),T(SBF.slugToString(a)+" sent to all users.")}});else{console.log("Type is not 'message', getting users with details...");let e="email"==a?"email":"phone";SBF.ajax({function:"get-users-with-details",user_ids:r,details:[e]},t=>{if(console.log("Users with details response:",t),!t[e].length)return S(this).sbLoading(!1),SBForm.showErrorMessage(s,"No users found.");c(t[e],o,0,[],"email"==a?"custom-email":"sms",n)})}}),SBF.getURL("setting")&&(a.find(".sb-admin-nav #sb-settings").click(),setTimeout(()=>{f.find("#tab-"+SBF.getURL("setting")).click()},300)),S(f).on("click"," > .sb-tab > .sb-nav [id]",function(){var t=S(this).attr("id").substr(4);SBF.getURL("setting")!=t&&vt("?setting="+t)}),S(f).on("click",'[data-type="upload-image"] .image',function(){Y=this,d.find(".sb-upload-form-admin .sb-upload-files").click()}),S(f).on("click",'[data-type="upload-image"] .image > i',function(t){return S(this).parent().removeAttr("data-value").css("background-image",""),t.preventDefault(),!1}),S(f).on("click",".sb-repeater-add",function(){R.repeaterAdd(this)}),S(f).on("click",".repeater-item > i",function(){R.repeaterDelete(this)}),R.initColorPicker(),S(f).find('[data-type="color"]').focusout(function(){let t=S(this).closest(".input-color"),e=t.find("input").val();setTimeout(function(){t.find("input").val(""),t.find(".color-preview").css("background-color",e)},300),R.set(S(this).attr("id"),e)}),S(f).on("click",".sb-type-color .input i",function(t){S(this).parent().find("input").removeAttr("style").val("")}),S(f).on("click",".sb-color-palette span",function(){var t=S(this).hasClass("sb-active");S(this).closest(".sb-repeater").find(".sb-active").sbActive(!1),S(this).sbActive(!t)}),S(f).on("click",".sb-color-palette ul li",function(){S(this).parent().parent().attr("data-value",S(this).data("value")).find("span").sbActive(!1)}),S(f).on("click",'[data-type="select-images"] .input > div',function(){S(this).siblings().sbActive(!1),S(this).sbActive(!0)}),S(f).on("click",".sb-select-checkbox-input",function(){S(this).toggleClass("sb-active")}),S(f).on("click",".sb-select-checkbox input",function(){var t=S(this).closest("[data-type]");t.find(".sb-select-checkbox-input").val(R.get(t)[1].join(", "))}),S(f).on("click",".sb-save-changes",function(){R.save(this)}),S(f).on("change",'#user-additional-fields [data-id="extra-field-slug"], #saved-replies [data-id="reply-name"], [data-id="rich-message-name"]',function(){S(this).val(SBF.stringToSlug(S(this).val()))}),S(f).on("click","#timetable-utc input",function(){""==S(this).val()&&S(this).val(Math.round(lt.getTimezoneOffset()/60))}),S(f).on("click","#test-email-user .sb-btn, #test-email-agent .sb-btn",function(){var t=S(this).parent().find("input").val();t&&0<t.indexOf("@")&&!E(this)&&SBF.ajax({function:"send-test-email",to:t,email_type:"test-email-user"==S(this).parent().parent().attr("id")?"user":"agent"},()=>{F("Email successfully sent. Check your emails!","info"),S(this).sbLoading(!1)})}),S(f).on("click",".sb-timetable > div > div > div",function(){var t=S(this).closest(".sb-timetable"),e=S(this).sbActive();S(t).find(".sb-active").sbActive(!1),e?S(this).sbActive(!1).find(".sb-custom-select").remove():(e=S(t).find("> .sb-custom-select").html(),S(t).find(" > div .sb-custom-select").remove(),S(this).append(`<div class="sb-custom-select">${e}</div>`).sbActive(!0))}),S(f).on("click",".sb-timetable .sb-custom-select span",function(){var t=[S(this).html(),S(this).attr("data-value")];S(this).closest(".sb-timetable").find("> div > div > .sb-active").html(t[0]).attr("data-value",t[1]),S(this).parent().sbActive(!1)}),S(f).on("click","#system-requirements a",function(t){let i=d.find(".sb-requirements-box"),s="";return SBF.ajax({function:"system-requirements"},t=>{for(var e in t)s+=`<div class="sb-input"><span>${I(SBF.slugToString(e))}</span><div${t[e]?' class="sb-green"':""}>${t[e]?I("Success"):I("Error")}</div></div>`;L(!1),i.find(".sb-main").html(s),i.sbShowLightbox()}),i.sbActive(!1),L(!0),t.preventDefault(),!1}),S(f).on("click","#sb-path a",function(t){return SBF.ajax({function:"path"},t=>{F(t,"info")}),t.preventDefault(),!1}),S(f).on("click","#delete-leads a",function(t){return S(this).sbLoading()||F("All leads, including all the linked conversations and messages, will be deleted permanently.","alert",()=>{S(this).sbLoading(!0),SBF.ajax({function:"delete-leads"},()=>{F("Leads and conversations successfully deleted.","info"),S(this).sbLoading(!1)})}),t.preventDefault(),!1}),S(f).on("click","#dialogflow-smart-reply-generate a",function(t){if(!E(this))return SBF.ajax({function:"dialogflow-smart-reply-generate-conversations-data"},t=>{F("Conversations data successfully generated. Folder: "+t,"info"),S(this).sbLoading(!1)}),t.preventDefault(),!1}),S(f).on("click","#sb-export-settings a",function(t){if(!E(this))return SBF.ajax({function:"export-settings"},t=>{window.open(t),F(I("For security reasons, delete the settings file after downloading it. Close this window to automatically delete it. File location:")+`<pre>${t}</pre>`,"info",!1,"sb-export-settings-close","Settings exported"),S(this).sbLoading(!1)}),t.preventDefault(),!1}),S(f).on("click","#sb-import-settings a",function(t){if(!E(this))return Y=this,Z=t=>{SBF.ajax({function:"import-settings",file_url:t},t=>{t?T("Settings successfully imported. Reload the admin area to apply the new settings."):F(t,"info"),S(this).sbLoading(!1)}),Z=!1},d.find(".sb-upload-form-admin .sb-upload-files").click(),t.preventDefault(),!1}),S(d).on("click","#sb-export-settings-close .sb-close",function(){SBF.ajax({function:"delete-file",path:d.find(".sb-dialog-box p pre").html()})}),S(f).on("click","#whatsmeow-go-start .sb-btn",function(t){e(t,"start")}),S(f).on("click","#whatsmeow-go-restart .sb-btn",function(t){e(t,"restart")}),S(f).on("click","#waweb-go-start .sb-btn",function(t){i(t,"start")}),S(f).on("click","#waweb-go-restart .sb-btn",function(t){i(t,"restart")}),S(document).ready(function(){S(document).on("click","#get-templates-api .sb-btn",function(t){t.preventDefault(),S.ajax({type:"GET",url:STMBX_URL+"/include/templates.php",success:function(t){F("Meta's WhatsApp Business API Cloud templates loaded successfully.","info")},error:function(t,e,i){F("Meta Business Manager configuration incomplete. Please provide the Business Manager User ID, save, and retry.","info")}})})}),S(f).on("click","#whatsapp-twilio-btn .sb-btn, #sms-btn .sb-btn, #wechat-btn .sb-btn, #twitter-callback .sb-btn, #gbm-webhook .sb-btn",function(t){var e=S(this).closest("[id]").attr("id");return F(`<code style=" margin: auto; word-break: break-word; text-align: center; font-size: .9rem; ">${STMBX_URL+("sms-btn"==e?"/include/api.php":"/apps/"+("wechat-btn"==e?"wechat":"twitter-callback"==e?"twitter":"gbm-webhook"==e?"gbm":"whatsapp")+"/post.php")+mt().replace("&","?")}</code>`,"info"),!1}),S(f).on("click","#telegram-button .sb-btn",function(t){var e=f.find("#telegram-token input").val().trim();return t.preventDefault(),!(!e||E(this)||(SBF.ajax({function:"telegram-synchronization",token:e,cloud_token:mt()},()=>{F("Telegram Synchronization completed.","info"),S(this).sbLoading(!1)}),1))}),S(f).on("click","#whatsapp-test-template .sb-btn",function(t){t.preventDefault();t=S(this).parent().find("input").val();if(t&&!E(this))return SBF.ajax({function:"whatsapp-send-template",phone:t},t=>{F(t&&("error"in t?t.error.message:"Message sent, check your WhatsApp!"),"info"),S(this).sbLoading(!1)}),!1}),S(f).on("click","#twitter-subscribe .sb-btn",function(t){return t.preventDefault(),E(this)||SBF.ajax({function:"twitter-subscribe",cloud_token:mt()},t=>{F(!0===t?"Synchronization completed.":JSON.stringify(t),"info"),S(this).sbLoading(!1)}),!1}),S(f).on("click","#email-piping-sync a",function(t){E(this)||(SBF.ajax({function:"email-piping",force:!0},t=>{F(!0===t?"Syncronization completed.":t,"info"),S(this).sbLoading(!1)}),t.preventDefault())}),S(f).on("click","#tab-automations",function(){R.automations.get(()=>{R.automations.populate(),L(!1)},!0),L()}),S(v).on("click",".sb-add-condition",function(){R.automations.addCondition()}),S(v).on("change",".sb-condition-1 select",function(){R.automations.updateCondition(this)}),S(t).on("click","li",function(){R.automations.populate(S(this).data("value"))}),S(m).on("click","li",function(){R.automations.show(S(this).attr("data-id"))}),S(v).on("click",".sb-add-automation",function(){R.automations.add()}),S(m).on("click","li i",function(){F("The automation will be deleted permanently.","alert",()=>{R.automations.delete(this)})}),document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("recordButton");var e=document.getElementById("stopButton");const i=document.querySelector(".bi-arrow-up-circle-fill"),s=document.querySelector(".sb-textarea > textarea"),a=document.querySelector(".sb-textarea"),n=document.querySelector(".bi-mic-fill");let o=!0;const r=()=>{o=!0,a.style.visibility="visible"};i.addEventListener("click",()=>{t.style.visibility="visible",i.style.visibility="hidden",r(),n.style.visibility="visible"}),s.addEventListener("input",()=>{""===s.value.trim()?(i.style.visibility="hidden",t.style.visibility="visible"):(i.style.visibility="visible",t.style.visibility="hidden"),r()}),t.addEventListener("click",()=>{n.style.visibility="hidden",o=!o,a.style.visibility=o?"visible":"hidden",setTimeout(()=>{i.style.visibility="visible"},500)}),e.addEventListener("click",()=>{n.style.visibility="visible",r(),setTimeout(()=>{i.style.visibility="visible"},500)})}),S(x).on("click",".sb-nav [id]",function(){var t=S(this).attr("id");N.active_report=!1,x.find("#sb-date-picker").val(""),x.attr("class","sb-area-reports sb-active sb-report-"+t),N.initReport(S(this).attr("id")),SBF.getURL("report")!=t&&vt("?report="+t)}),S(x).on("change","#sb-date-picker",function(){N.initReport(!1,S(this).val())}),SBF.getURL("report")&&(x.sbActive()||a.find(".sb-admin-nav #sb-reports").click(),setTimeout(()=>{x.find("#"+SBF.getURL("report")).click()},500)),S(d).on("click",".sb-language-switcher > i",function(){let t=S(this).parent(),e=t.find("[data-language]").map(function(){return S(this).attr("data-language")}).get(),i=d.find(".sb-languages-box"),s="";for(var a in e.push("en"),SB_LANGUAGE_CODES)e.includes(a)||(s+=`<div data-language="${a}"><img src="${STMBX_URL}/media/flags/${a}.png" />${I(SB_LANGUAGE_CODES[a])}</div>`);Q=t,i.attr("data-source",t.attr("data-source")),i.find(".sb-main").html(s),i.sbShowLightbox()}),S(d).on("click",".sb-language-switcher img",function(){var t=S(this).parent(),e=t.sbActive(),i=!e&&t.attr("data-language");switch(t.parent().attr("data-source")){case"articles":R.articles.show(!1,!1,i);break;case"automations":R.automations.show(!1,i);break;case"settings":var s=t.parent().find("[data-language].sb-active");R.translations.save(t,e?t.attr("data-language"):!!s.length&&s.attr("data-language")),R.translations.activate(t,i)}t.siblings().sbActive(!1),t.sbActive(!e)}),S(d).on("click",".sb-language-switcher span > i",function(){let t=S(this).parent(),e=t.attr("data-language");F(I("The {T} translation will be deleted.").replace("{T}",I(SB_LANGUAGE_CODES[e])),"alert",()=>{switch(t.parent().attr("data-source")){case"articles":R.articles.deleteTranslation(!1,e),R.articles.show();break;case"automations":R.automations.deleteTranslation(!1,e),R.automations.show();break;case"settings":R.translations.delete(t,e)}t.remove()})}),S(d).on("click",".sb-languages-box [data-language]",function(){var t=S(this).parents().eq(1),e=S(this).attr("data-language");switch(t.attr("data-source")){case"articles":R.articles.addTranslation(!1,e),R.articles.show(!1,!1,e);break;case"automations":R.automations.addTranslation(!1,!1,e),R.automations.show(!1,e);break;case"settings":R.translations.add(e)}d.sbHideLightbox()}),S(d).on("click",".sb-lightbox .sb-top-bar .sb-close",function(){d.sbHideLightbox()}),S(d).on("click",".sb-lightbox .sb-info",function(){S(this).sbActive(!1)}),S(d).on("click",".sb-dialog-box a",function(){var t=S(this).closest(".sb-lightbox");S(this).hasClass("sb-confirm")&&K(),1==d.find(".sb-lightbox.sb-active").length&&tt.sbActive(!1),G.open_popup=!1,t.sbActive(!1)}),S(d).on("click",".sb-menu-wide li, .sb-nav li",function(){S(this).siblings().sbActive(!1),S(this).sbActive(!0)}),S(d).on("click",".sb-nav:not(.sb-nav-only) li:not(.sb-tab-nav-title)",function(){var t=S(this).closest(".sb-tab"),e=S(t).find(" > .sb-content > div").sbActive(!1).eq(S(this).parent().find("li:not(.sb-tab-nav-title)").index(this));e.sbActive(!0),e.find("textarea").each(function(){S(this).autoExpandTextarea(),S(this).manualExpandTextarea()}),t.find(".sb-scroll-area").scrollTop(0)}),S(d).on("change",".sb-upload-form-admin .sb-upload-files",function(t){S(this).sbUploadFiles(function(t){"success"==(t=JSON.parse(t))[0]?("upload-image"==S(Y).closest("[data-type]").data("type")&&S(Y).attr("data-value",t[1]).css("background-image",`url("${t[1]}")`),Z&&Z(t[1])):console.log(t[1])})}),S(d).on("click",".sb-accordion > div > span",function(t){var e=S(this).parent(),i=S(e).sbActive();S(t.target).is("span")&&(e.siblings().sbActive(!1),e.sbActive(!i))}),S(d).on("mousedown",function(t){var e;!S(G.open_popup).length||(e=S(G.open_popup)).is(t.target)||0!==e.has(t.target).length||["sb-btn-saved-replies","bi-emoji-grin"].includes(S(t.target).attr("class"))||(e.hasClass("sb-popup")?e.sbTogglePopup():e.hasClass("sb-select")?e.find("ul").sbActive(!1):e.hasClass("sb-menu-mobile")?e.find("i").sbActive(!1):e.hasClass("sb-menu")?e.sbActive(!1):d.sbHideLightbox(),G.open_popup=!1)})))}function s(){var t=moment();t.local(),S("#alertdate").val(t.format("MM/DD/YY hh:mm A")),U.timeZoneList()}function c(i,s,a=0,n=[],o,r=!1){let l="custom-email"==o?["send-custom-email","emails"," users with an email","direct-emails"]:"sms"==o?["whatsmeow-send-message","waweb-send-message","messages"," with a phone number","direct-sms"]:["create-email","emails"," with an email",!1];l="template"==o?["whatsapp-send-meta-template","template","users a phone number","direct-messages"]:l;var t=(new Metatemplate).payload("#user-template-form"),t=(t.to=i[a],"template"==o?{function:l[0],payload:t}:{function:l[0],to:i[a].value,recipient_id:i[a].id,sender_name:SB_ACTIVE_AGENT.full_name,sender_profile_image:SB_ACTIVE_AGENT.profile_image,subject:r,message:s,template:!1});SBF.ajax(t,t=>{var e=i.length;if(u.find(".sb-bottom > div").html(`${I("Sending")} ${l[1]}... ${a+1} / `+e),t||console.warn(t),!t?.error)return a<e-1?c(i,s,a+1,n,o,r):(n.length?c(n,s,0,[],"sms",!1):(d.sbHideLightbox(),l[3]&&SBF.ajax({function:"reports-update",name:l[3],value:s+" | "+e})),void T(1==e?"Message sent":`${SBF.slugToString(l[1])} sent to all users${l[2]}.`));132e3==t?.error.code||100==t?.error.code?SBForm.showErrorMessage(u,""+t?.error.message):F(""+t?.error.message,"info"),console.warn(t)})}function e(t,e){t.preventDefault();let s=f.find("#whatsmeow-go-qr input").val(),a="start"===e?"/include/get_ww.php?qrurl=":"/include/reset_ww.php";"start"===e?(S("#qr_loading1").show(),fetch(STMBX_URL+a+s).then(t=>{if(t.ok)return t.text();throw new Error("Network response was not ok")}).then(t=>{try{var e=JSON.parse(t);if(e.error)SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"warning");else if(e.image){let t="data:image/png;base64,"+e.image;var i=S("#qr_image1");i.length?i.fadeOut(500,function(){S(this).attr("src",t).fadeIn(500)}):(S("#whatsmeow-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image1" src="${t}" onerror="this.style.display='none';$('#qr_loading1').show();" />`),S("#whatsmeow-go .sb-setting-content").append('<div id="qr_loading1" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>')),S("#qr_loading1").hide()}}catch(t){if(!(t instanceof SyntaxError))throw t;console.error("Response is not JSON, assuming it's an image blob."),fetch(STMBX_URL+a+s).then(t=>{if(t.ok)return t.blob();throw new Error("Network response was not ok")}).then(t=>{let e=URL.createObjectURL(t);t=S("#qr_image1");t.length?t.fadeOut(500,function(){S(this).attr("src",e).fadeIn(500)}):(S("#whatsmeow-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image1" src="${e}" onerror="this.style.display='none';$('#qr_loading1').show();" />`),S("#whatsmeow-go .sb-setting-content").append('<div id="qr_loading1" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>'))}).catch(t=>{console.error("Error during fetch:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")})}}).catch(t=>{console.error("Error during fetch:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}).finally(()=>{S("#qr_loading1").hide()})):"restart"===e&&(console.log("Restarting..."),S.ajax({url:a,method:"GET",data:{qrurl:s},dataType:"json",success:function(t){console.log("Restart successful. Response:",t),SBChat.showResponse('<i style="var(--color-red)" class="bi bi-telephone-x"></i> Disconnecting from WhatsApp...');t=S("#qr_image1");t.length&&t.fadeOut(500,function(){S(this).remove()})},error:function(t){console.error("Restart error. Response:",t.responseText),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}}))}function i(t,e){t.preventDefault();var t=f.find("#waweb-go-qr input").val(),i="start"===e?"/include/get_wx.php?qrurl=":"/include/reset_wx.php";"start"===e?(S("#qr_loading2").show(),fetch(STMBX_URL+i+t).then(t=>{if(t.ok)return t.text();throw new Error("Network response was not ok")}).then(t=>{try{var e=JSON.parse(t);if(e.error)console.error("Error in JSON response:",e.error),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"warning");else if(e.image){let t="data:image/png;base64,"+e.image;var i=S("#qr_image2");i.length?i.fadeOut(500,function(){S(this).attr("src",t).fadeIn(500)}):(S("#waweb-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image2" src="${t}" onerror="this.style.display='none';$('#qr_loading2').show();" />`),S("#waweb-go .sb-setting-content").append('<div id="qr_loading2" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>')),S("#qr_loading2").hide()}}catch(t){console.error("Error parsing JSON response:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}}).catch(t=>{console.error("Error during fetch:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}).finally(()=>{S("#qr_loading2").hide()})):"restart"===e&&S.ajax({url:i,method:"GET",data:{qrurl:t},dataType:"json",success:function(t){console.log("Restart successful. Response:",t),SBChat.showResponse('<i style="var(--color-red)" class="bi bi-telephone-x"></i> Disconnecting from WhatsApp...');t=S("#qr_image2");t.length&&t.fadeOut(500,function(){S(this).remove()})},error:function(t){console.error("Restart error. Response:",t.responseText),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}})}})}(jQuery),function(t,e){"object"==typeof exports?module.exports=e(t):"function"==typeof define&&define.amd?define("colors",[],function(){return e(t)}):t.Colors=e(t)}(this,function(t,c){function n(t,e,i,s,a){if("string"==typeof e){e=k.txt2color(e);B[i=e.type]=e[i],a=a!==c?a:e.alpha}else if(e)for(var n in e)t[i][n]=r(e[n]/y[i][n][1],0,1);return a!==c&&(t.alpha=r(+a,0,1)),o(i,s?t:c)}function o(t,e){var i,s,a=e||B,n=k,o=w.options,r=y,l=a.RND,c="",d={hsl:"hsv",rgb:t},u=l.rgb;if("alpha"!==t){for(var h in r)if(!r[h][h])for(c in t!==h&&(s=d[h]||"rgb",a[h]=n[s+"2"+h](a[s])),l[h]||(l[h]={}),i=a[h])l[h][c]=x(i[c]*r[h][c][1]);u=l.rgb,a.HEX=n.RGB2HEX(u),a.equivalentGrey=o.grey.r*a.rgb.r+o.grey.g*a.rgb.g+o.grey.b*a.rgb.b,a.webSave=f=v(u,51),a.webSmart=b=v(u,17),a.saveColor=u.r===f.r&&u.g===f.g&&u.b===f.b?"web save":u.r===b.r&&u.g===b.g&&u.b===b.b?"web smart":"",a.hueRGB=k.hue2RGB(a.hsv.h),e&&(a.background=(f=u,b=a.rgb,e=a.alpha,g=w.options.grey,(p={}).RGB={r:f.r,g:f.g,b:f.b},p.rgb={r:b.r,g:b.g,b:b.b},p.alpha=e,p.equivalentGrey=x(g.r*f.r+g.g*f.g+g.b*f.b),p.rgbaMixBlack=S(b,{r:0,g:0,b:0},e,1),p.rgbaMixWhite=S(b,{r:1,g:1,b:1},e,1),p.rgbaMixBlack.luminance=m(p.rgbaMixBlack,!0),p.rgbaMixWhite.luminance=m(p.rgbaMixWhite,!0),w.options.customBG&&(p.rgbaMixCustom=S(b,w.options.customBG,e,1),p.rgbaMixCustom.luminance=m(p.rgbaMixCustom,!0),w.options.customBG.luminance=m(w.options.customBG,!0)),p))}var p,g=a.rgb,f=a.alpha,b="luminance",e=a.background;return(p=S(g,{r:0,g:0,b:0},f,1))[b]=m(p,!0),a.rgbaMixBlack=p,(p=S(g,{r:1,g:1,b:1},f,1))[b]=m(p,!0),a.rgbaMixWhite=p,o.customBG&&((p=S(g,e.rgbaMixCustom,f,1))[b]=m(p,!0),p.WCAG2Ratio=(g=p[b],f=e.rgbaMixCustom[b],x(100*(f<=g?(g+.05)/(f+.05):(f+.05)/(g+.05)))/100),(a.rgbaMixBGMixCustom=p).luminanceDelta=_.abs(p[b]-e.rgbaMixCustom[b]),p.hueDelta=(f=e.rgbaMixCustom,g=p,255*(_.max(f.r-g.r,g.r-f.r)+_.max(f.g-g.g,g.g-f.g)+_.max(f.b-g.b,g.b-f.b))/765)),a.RGBLuminance=m(u),a.HUELuminance=m(a.hueRGB),o.convertCallback&&o.convertCallback(a,t),a}function v(t,e){var i,s,a={},n=e/2;for(s in t)i=t[s]%e,a[s]=t[s]+(n<i?e-i:-i);return a}function m(t,e){for(var e=e?1:255,i=[t.r/e,t.g/e,t.b/e],t=w.options.luminance,s=i.length;s--;)i[s]=i[s]<=.03928?i[s]/12.92:_.pow((i[s]+.055)/1.055,2.4);return t.r*i[0]+t.g*i[1]+t.b*i[2]}function S(t,e,i,s){var a,n={},o=i!==c?i:1,r=s!==c?s:1,l=o+r*(1-o);for(a in t)n[a]=(t[a]*o+e[a]*r*(1-o))/l;return n.a=l,n}function r(t,e,i){return i<t?i:t<e?e:t}function e(t){this.colors={RND:{}},this.options={color:"rgba(0,0,0,0)",grey:l,luminance:d,valueRanges:y};var e,i=this,s=t||{},a=i.options;for(e in u(i),s)s[e]!==c&&(a[e]=s[e]);t=a.customBG,a.customBG="string"==typeof t?k.txt2color(t).rgb:t,B=n(i.colors,a.color,c,!0)}var y={rgb:{r:[0,255],g:[0,255],b:[0,255]},hsv:{h:[0,360],s:[0,100],v:[0,100]},hsl:{h:[0,360],s:[0,100],l:[0,100]},alpha:{alpha:[0,1]},HEX:{HEX:[0,16777215]}},_=t.Math,x=_.round,w={},B={},l={r:.298954,g:.586434,b:.114612},d={r:.2126,g:.7152,b:.0722},u=function(t){w!==t&&(B=(w=t).colors)},k=(e.prototype.setColor=function(t,e,i){return u(this),t?n(this.colors,t,e,c,i):(i!==c&&(this.colors.alpha=r(i,0,1)),o(e))},e.prototype.setCustomBackground=function(t){return u(this),this.options.customBG="string"==typeof t?k.txt2color(t).rgb:t,n(this.colors,c,"rgb")},e.prototype.saveAsBackground=function(){return u(this),n(this.colors,c,"rgb",!0)},e.prototype.toString=function(t,e){return k.color2text((t||"rgb").toLowerCase(),this.colors,e)},{txt2color:function(t){var e,i={},t=t.replace(/(?:#|\)|%)/g,"").split("("),s=(t[1]||"").split(/,\s*/),a=t[1]?t[0].substr(0,3):"rgb";if(i.type=a,i[a]={},t[1])for(var n=3;n--;)e=a[n]||a.charAt(n),i[a][e]=+s[n]/y[a][e][1];else i.rgb=k.HEX2rgb(t[0]);return i.alpha=s[3]?+s[3]:1,i},color2text:function(t,e,i){var s=!1!==i&&x(100*e.alpha)/100,i="number"==typeof s&&!1!==i&&(i||1!==s),a=e.RND.rgb,n=e.RND.hsl,o="hex"===t&&i,r="hex"===t&&!o,a="rgb"===t||o?a.r+", "+a.g+", "+a.b:r?"#"+e.HEX:n.h+", "+n.s+"%, "+n.l+"%";return r?a:(o?"rgb":t)+(i?"a":"")+"("+a+(i?", "+s:"")+")"},RGB2HEX:function(t){return((t.r<16?"0":"")+t.r.toString(16)+(t.g<16?"0":"")+t.g.toString(16)+(t.b<16?"0":"")+t.b.toString(16)).toUpperCase()},HEX2rgb:function(t){return{r:("0x"+(t=t.split(""))[0]+t[t[3]?1:0])/255,g:("0x"+t[t[3]?2:1]+(t[3]||t[1]))/255,b:("0x"+(t[4]||t[2])+(t[5]||t[2]))/255}},hue2RGB:function(t){var t=6*t,e=~~t%6,t=6==t?0:t-e;return{r:x(255*[1,1-t,0,0,t,1][e]),g:x(255*[t,1,1,1-t,0,0][e]),b:x(255*[0,0,t,1,1,1-t][e])}},rgb2hsv:function(t){var e,i=t.r,s=t.g,t=t.b,a=0;return s<t&&(s=t+(t=s,0),a=-1),e=t,i<s&&(i=s+(s=i,0),a=-2/6-a,e=_.min(s,t)),e=i-e,{h:(i?e/i:0)<1e-15?B&&B.hsl&&B.hsl.h||0:e?_.abs(a+(s-t)/(6*e)):0,s:i?e/i:B&&B.hsv&&B.hsv.s||0,v:i}},hsv2rgb:function(t){var e=6*t.h,i=t.s,t=t.v,s=~~e,e=e-s,a=t*(1-i),n=t*(1-e*i),e=t*(1-(1-e)*i),i=s%6;return{r:[t,n,a,a,e,t][i],g:[e,t,t,n,a,a][i],b:[a,a,e,t,t,n][i]}},hsv2hsl:function(t){var e=(2-t.s)*t.v,i=t.s*t.v,i=t.s?e<1?e?i/e:0:i/(2-e):0;return{h:t.h,s:t.v||i?i:B&&B.hsl&&B.hsl.s||0,l:e/2}},rgb2hsl:function(t,e){t=k.rgb2hsv(t);return k.hsv2hsl(e?t:B.hsv=t)},hsl2rgb:function(t){var e=6*t.h,i=t.s,t=t.l,i=t<.5?t*(1+i):t+i-i*t,t=t+t-i,s=~~e,e=i*(i?(i-t)/i:0)*(e-s),a=t+e,e=i-e,s=s%6;return{r:[i,e,t,t,a,i][s],g:[a,i,i,e,t,t][s],b:[t,t,a,i,i,e][s]}}});return e}),function(i,s){"object"==typeof exports?module.exports=s(i,require("jquery"),require("colors")):"function"==typeof define&&define.amd?define(["jquery","colors"],function(t,e){return s(i,t,e)}):s(i,i.jQuery,i.Colors)}(this,function(n,o,e,f){function r(t){return t.value||t.getAttribute("value")||o(t).css("background-color")||"#FFF"}function i(t){return(t=t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches[0]:t).originalEvent?t.originalEvent:t}function l(t){return o(t.find(m.doRender)[0]||t[0])}function a(t){var e=o(this),i=e.offset(),s=o(n),a=m.gap;t?((S=l(e))._colorMode=S.data("colorMode"),g.$trigger=e,(y||(o("head")[m.cssPrepend?"prepend":"append"]('<style type="text/css" id="tinyColorPickerStyles">'+(m.css||".cp-color-picker{position:absolute;overflow:hidden;padding:6px 6px 0;background-color:#444;color:#bbb;font-family:Arial,Helvetica,sans-serif;font-size: var(--chat-text-size-8);font-weight:400;cursor:default;border-radius:5px}.cp-color-picker>div{position:relative;overflow:hidden}.cp-xy-slider{float:left;height:128px;width:128px;margin-bottom:6px;background:linear-gradient(to right,#FFF,rgba(255,255,255,0))}.cp-white{height:100%;width:100%;background:linear-gradient(rgba(0,0,0,0),#000)}.cp-xy-cursor{position:absolute;top:0;width:10px;height:10px;margin:-5px;border:1px solid #fff;border-radius:100%;box-sizing:border-box}.cp-z-slider{float:right;margin-left:6px;height:128px;width:20px;background:linear-gradient(red 0,#f0f 17%,#00f 33%,#0ff 50%,#0f0 67%,#ff0 83%,red 100%)}.cp-z-cursor{position:absolute;margin-top:-4px;width:100%;border:4px solid #fff;border-color:transparent #fff;box-sizing:border-box}.cp-alpha{clear:both;width:100%;height:16px;margin:6px 0;background:linear-gradient(to right,#444,rgba(0,0,0,0))}.cp-alpha-cursor{position:absolute;margin-left:-4px;height:100%;border:4px solid #fff;border-color:#fff transparent;box-sizing:border-box}")+(m.cssAddon||"")+"</style>"),o('<div class="cp-color-picker"><div class="cp-z-slider"><div class="cp-z-cursor"></div></div><div class="cp-xy-slider"><div class="cp-white"></div><div class="cp-xy-cursor"></div></div><div class="cp-alpha"><div class="cp-alpha-cursor"></div></div></div>').css({margin:m.margin}).appendTo("body").show(0,function(){g.$UI=y=o(this),E=m.GPU&&y.css("perspective")!==f,_=o(".cp-z-slider",this),x=o(".cp-xy-slider",this),w=o(".cp-xy-cursor",this),B=o(".cp-z-cursor",this),k=o(".cp-alpha",this),C=o(".cp-alpha-cursor",this),m.buildCallback.call(g,y),y.prepend("<div>").children().eq(0).css("width",y.children().eq(0).width()),y._width=this.offsetWidth,y._height=this.offsetHeight}).hide())).css(m.positionCallback.call(g,e)||{left:(y._left=i.left)-(0<(y._left+=y._width-(s.scrollLeft()+s.width()))+a?y._left+a:0),top:(y._top=i.top+e.outerHeight())-(0<(y._top+=y._height-(s.scrollTop()+s.height()))+a?y._top+a:0)}).show(m.animationSpeed,function(){!0!==t&&(k.toggle(!!m.opacity)._width=k.width(),x._width=x.width(),x._height=x.height(),_._height=_.height(),v.setColor(r(S[0])),h(!0))}).off(".tcp").on(F,".cp-xy-slider,.cp-z-slider,.cp-alpha",c)):g.$trigger&&o(y).hide(m.animationSpeed,function(){h(!1),g.$trigger=null}).off(".tcp")}function c(t){var e=this.className.replace(/cp-(.*?)(?:\s*|$)/,"$1").replace("-","_");1<(t.button||t.which)||(t.preventDefault&&t.preventDefault(),t.returnValue=!1,S._offset=o(this).offset(),(e="xy_slider"===e?s:"z_slider"===e?d:u)(t),h(),A.on(L,function(){A.off(".tcp")}).on($,function(t){e(t),h()}))}function s(t){var t=i(t),e=t.pageX-S._offset.left,t=t.pageY-S._offset.top;v.setColor({s:e/x._width*100,v:100-t/x._height*100},"hsv")}function d(t){t=i(t).pageY-S._offset.top;v.setColor({h:360-t/_._height*360},"hsv")}function u(t){t=(i(t).pageX-S._offset.left)/k._width;v.setColor({},"rgb",t)}function h(t){var e=v.colors,i=e.hueRGB,s=(e.RND.rgb,e.RND.hsl,m.dark),a=m.light,n=v.toString(S._colorMode,m.forceAlpha),o=.22<e.HUELuminance?s:a,r=.22<e.rgbaMixBlack.luminance?s:a,l=(1-e.hsv.h)*_._height,c=e.hsv.s*x._width,d=(1-e.hsv.v)*x._height,u=e.alpha*k._width,h=E?"translate3d":"",p=S[0].value,g=S[0].hasAttribute("value")&&""===p&&t!==f;x._css={backgroundColor:"rgb("+i.r+","+i.g+","+i.b+")"},w._css={transform:h+"("+c+"px, "+d+"px, 0)",left:E?"":c,top:E?"":d,borderColor:.22<e.RGBLuminance?s:a},B._css={transform:h+"(0, "+l+"px, 0)",top:E?"":l,borderColor:"transparent "+o},k._css={backgroundColor:"#"+e.HEX},C._css={transform:h+"("+u+"px, 0, 0)",left:E?"":u,borderColor:r+" transparent"},S._css={backgroundColor:g?"":n,color:g?"":.22<e.rgbaMixBGMixCustom.luminance?s:a},S.text=!g&&p!==n?n:"",t!==f?b(t):I(b)}function b(t){x.css(x._css),w.css(w._css),B.css(B._css),k.css(k._css),C.css(C._css),m.doRender&&S.css(S._css),S.text&&S.val(S.text),m.renderCallback.call(g,S,"boolean"==typeof t?t:f)}function p(t){m=(v=this.color=new e(t)).options,g=this}var g,v,m,S,y,_,x,w,B,k,C,A=o(document),T=o(),$="touchmove.tcp mousemove.tcp pointermove.tcp",F="touchstart.tcp mousedown.tcp pointerdown.tcp",L="touchend.tcp mouseup.tcp pointerup.tcp",E=!1,I=n.requestAnimationFrame||n.webkitRequestAnimationFrame||function(t){t()};p.prototype={render:h,toggle:a},o.fn.colorPicker=function(s){function t(){}var e=this;return s=o.extend({animationSpeed:150,GPU:!0,doRender:!0,customBG:"#FFF",opacity:!0,renderCallback:t,buildCallback:t,positionCallback:t,body:document.body,scrollResize:!0,gap:4,dark:"#222",light:"#DDD"},s),!g&&s.scrollResize&&o(n).on("resize.tcp scroll.tcp",function(){g.$trigger&&g.toggle.call(g.$trigger[0],!0)}),T=T.add(this),this.colorPicker=g||new p(s),this.options=s,o(s.body).off(".tcp").on(F,function(t){-1===T.add(y).add(o(y).find(t.target)).index(t.target)&&a()}),this.on("focusin.tcp click.tcp",function(t){g.color.options=o.extend(g.color.options,m=e.options),a.call(this,t)}).on("change.tcp",function(){v.setColor(this.value||"#FFF"),e.colorPicker.render(!0)}).each(function(){var t=r(this),e=t.split("("),i=l(o(this));i.data("colorMode",e[1]?e[0].substr(0,3):"HEX").attr("readonly",m.preventFocus),s.doRender&&i.css({"background-color":t,color:function(){return.22<v.setColor(t).rgbaMixBGMixCustom.luminance?s.dark:s.light}})})},o.fn.colorPicker.destroy=function(){o("*").off(".tcp"),g.toggle(!1),T=o()}}),window.addEventListener("load",function(){initLoadingAnimation()}),document.addEventListener("click",t=>{var e,i;t.target.classList.contains("settings-button")?(i=(e=t.target.closest(".sb-setting")).querySelector(".active")).classList.contains("sb-hide")?(i.classList.remove("sb-hide"),e.querySelector(".input").classList.remove("sb-hide")):(i.classList.add("sb-hide"),e.querySelector(".input").classList.add("sb-hide")):t.target.classList.contains("sb-revert")&&((i=t.target.closest(".sb-setting")).querySelector(".active").classList.add("sb-hide"),i.querySelector(".input").classList.add("sb-hide"))}),window.onclick=function(t){if(!t.target.matches(".cst-btn"))for(var e=document.getElementsByClassName("cstdown-content"),i=0;i<e.length;i++){var s=e[i];s.classList.contains("show")&&s.classList.remove("show")}};