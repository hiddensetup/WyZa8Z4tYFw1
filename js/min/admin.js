"use strict";function showContent(){var t=document.getElementById("overlay"),e=document.documentElement;t.style.display="none",e.style.animation="fade-in .1s ease-in"}function initLoadingAnimation(){var t=document.getElementById("overlay");document.getElementById("loader");t.style.animation="load 1.6s ease-out",t.addEventListener("animationend",function(){showContent()})}function ExtraButton(){document.getElementById("CstBtn").classList.toggle("show")}!function(k){var d,u,S,H,w,W,V,X,J,h,p,Y,g,f,b,v,m,_,x,Z,Q,y,K,B,tt,C,et,at,it,i,st,s,nt,A=[],ot=!1,rt=!1,T=!1,lt=1,ct=1,$={},dt=1,ut=1,L=k(window).width()<555,F={last:0,header:!0,always_hidden:!1},ht="localhost"===location.hostname||"127.0.0.1"===location.hostname,pt=new Date,gt=!1,a=!0,ft=!1,bt="undefined",o=!1,n=!1,e=!1,c=["Abierto","Presupuesto","Consulta","Contactado","Visitado","Calificado","Confirmado","Pendiente","Resuelto","Pagado","VIP","Descartado","NA"];function I(t,e=!1){var a=d.find(".sb-info-card");e?"error"===e?(a.addClass("sb-info-card-error"),i=setTimeout(()=>{a.sbActive(!1)},4e3)):"warning"===e?(a.addClass("sb-info-card-warning"),i=setTimeout(()=>{a.sbActive(!1)},3e3)):a.addClass("sb-info-card-info"):(a.removeClass("sb-info-card-error sb-info-card-warning sb-info-card-info"),clearTimeout(i),i=setTimeout(()=>{a.sbActive(!1)},1500)),a.html(`<h3>${D(t)}</h3>`).sbActive(!0)}function E(t){if(typeof t==bt)return window.sb_current_user;window.sb_current_user=t}function M(t,e,a=!1,i="",s="",n=!1){let o=d.find(".sb-dialog-box").attr("data-type",e);var r=o.find("p");o.attr("id",i).setClass("sb-scroll-area",n).css("height",n?parseInt(k(window).height())-200+"px":""),o.find(".sb-title").html(s),r.html(("alert"==e?'<strong style="font-size: var(--chat-text-size-1-1);color: var(--chat-text-primary">'+D("Are you sure?")+"</strong> ":"")+D(t)),o.sbActive(!0).css({"margin-top":o.outerHeight()/-2+"px","margin-left":o.outerWidth()/-2+"px"}),nt.sbActive(!0),st=a,setTimeout(()=>{z.open_popup=o},500)}function R(t=!1,e=!0){d.find(".sb-loading-global").sbActive(t),e&&(nt.sbActive(t),k("body").setClass("sb-lightbox-active",t))}function N(t){if(k(t).sbLoading())return 1;k(t).sbLoading(!0)}function D(t){return SB_TRANSLATIONS&&t in SB_TRANSLATIONS?SB_TRANSLATIONS[t]:t}function l(t,e){var a=(t=k(t)).find("> div, > ul");a.css({height:"","max-height":""}),t.hasClass("sb-collapse")&&k(a).prop("scrollHeight")>e&&(t.sbActive(!0).attr("data-height",e),t.find(".bi-chevron-down").remove(),t.append(`<a class="sb-btn-text bi-chevron-down">${D("View more")}</a>`),a.css({height:e+"px","max-height":e+"px"}))}function r(t,e){let a=k(t).parent().find("i"),i=k(t).val();a.sbLoading()||SBF.search(i,()=>{a.sbLoading(!0),e(i,a)})}function vt(t,e=!1,a=0){if(e)return k(t).scrollTop()+k(t).innerHeight()>=k(t)[0].scrollHeight-1;k(t).scrollTop(k(t)[0].scrollHeight-a)}function mt(t){window.history.pushState("","",t)}function St(){return SB_ADMIN_SETTINGS.cloud?"&cloud="+SB_ADMIN_SETTINGS.cloud.token:""}function wt(t=!1){e||(!1===o?(o=!0,k.getScript(STMBX_URL+"/vendor/editorjs.js",()=>{wt(t)})):(_t(),e=!0,o=new EditorJS({data:"string"==typeof t?{time:Date.now(),blocks:[t?{id:"sb",type:"raw",data:{html:t}}:{id:"sb",type:"paragraph",data:{text:""}}]}:t,i18n:{messages:{ui:{blockTunes:{toggler:{"Click to tune":D("Click to tune")}},inlineToolbar:{converter:{"Convert to":D("Convert to")}},toolbar:{toolbox:{Add:D("Add")}}},toolNames:{Text:D("Text"),Heading:D("Heading"),List:D("List"),Image:D("Image"),Code:D("Code"),"Raw HTML":D("Raw HTML"),Bold:D("Bold"),Italic:D("Italic"),Link:D("Link")},tools:{list:{Ordered:D("Ordered"),Unordered:D("Unordered")}},blockTunes:{delete:{Delete:D("Delete")},moveUp:{"Move up":D("Move up")},moveDown:{"Move down":D("Move down")}}}},tools:{list:{class:List,inlineToolbar:!0},image:{class:ImageTool,config:{uploader:{uploadByFile(t){let a=new FormData;return a.append("file",t),new Promise(e=>{k.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:a,type:"POST",success:function(t){"success"==(t=JSON.parse(t))[0]?e({success:1,file:{url:t[1]}}):console.log(t)}})})}}}},header:Header,code:CodeTool,raw:RawTool},onReady:()=>{e=!1},minHeight:50})))}function _t(){typeof o.destroy!==bt&&(o.destroy(),o=!1)}k.fn.miniTip=function(t){var x=k.extend({title:"",content:!1,delay:100,anchor:"n",event:"hover",fadeIn:100,fadeOut:300,aHide:!0,maxW:"250px",offset:4,stemOff:0,doHide:!1},t),y=(0==d.find("#miniTip").length&&d.append('<div id="miniTip" class="sb-tooltip"><div></div></div>'),d.find("#miniTip")),B=y.find("div");return x.doHide?(y.stop(!0,!0).fadeOut(x.fadeOut),!1):this.each(function(){var t,e,a,i,s,w=k(this),_=x.content||w.attr("title");""!=_&&void 0!==_&&(t=window.delay=!1,e=!0,x.content||w.removeAttr("title"),"hover"==x.event?(w.hover(function(){y.removeAttr("click"),e=!0,a.call(this)},function(){e=!1,i()}),x.aHide||y.hover(function(){t=!0},function(){t=!1,setTimeout(function(){e||y.attr("click")||i()},20)})):"click"==x.event&&(x.aHide=!0,w.click(function(){return y.attr("click","t"),y.data("last_target")!==w||"none"==y.css("display")?a.call(this):i(),y.data("last_target",w),k("html").unbind("click").click(function(t){"block"!=y.css("display")||k(t.target).closest("#miniTip").length||(k("html").unbind("click"),i())}),!1})),a=function(){x.show&&x.show.call(this,x),x.content&&""!=x.content&&(_=x.content),B.html(_),x.render&&x.render(y),y.hide().width("").width(y.width()).css("max-width",x.maxW);var t=w.is("area");if(t){var e,a=[],i=[],s=w.attr("coords").split(",");function n(t,e){return t-e}for(e=0;e<s.length;e++)a.push(s[e++]),i.push(s[e]);var o=k("img[usemap=\\#"+w.parent().attr("name")+"]").offset(),r=parseInt(o.left,10)+parseInt((parseInt(a.sort(n)[0],10)+parseInt(a.sort(n)[a.length-1],10))/2,10),o=parseInt(o.top,10)+parseInt((parseInt(i.sort(n)[0],10)+parseInt(i.sort(n)[i.length-1],10))/2,10)}else o=parseInt(w.offset().top,10),r=parseInt(w.offset().left,10);var l=t?0:parseInt(w.outerWidth(),10),t=t?0:parseInt(w.outerHeight(),10),c=y.outerWidth(),d=y.outerHeight(),u=Math.round(r+Math.round((l-c)/2)),h=Math.round(o+t+x.offset+8),p=Math.round(c-16)/2-parseInt(y.css("borderLeftWidth"),10),g=0,f=r+l+c+x.offset+8>parseInt(k(window).width(),10),b=c+x.offset+8>r,v=d+x.offset+8>o-k(window).scrollTop(),m=o+t+d+x.offset+8>parseInt(k(window).height()+k(window).scrollTop(),10),S=x.anchor;b||"e"==x.anchor&&!f?"w"!=x.anchor&&"e"!=x.anchor||(S="e",g=Math.round(d/2-8-parseInt(y.css("borderRightWidth"),10)),p=-8-parseInt(y.css("borderRightWidth"),10),u=r+l+x.offset+8,h=Math.round(o+t/2-d/2)):!f&&("w"!=x.anchor||b)||"w"!=x.anchor&&"e"!=x.anchor||(S="w",g=Math.round(d/2-8-parseInt(y.css("borderLeftWidth"),10)),p=c-parseInt(y.css("borderLeftWidth"),10),u=r-c-x.offset-8,h=Math.round(o+t/2-d/2)),m||"n"==x.anchor&&!v?"n"!=x.anchor&&"s"!=x.anchor||(S="n",g=d-parseInt(y.css("borderTopWidth"),10),h=o-(d+x.offset+8)):!v&&("s"!=x.anchor||m)||"n"!=x.anchor&&"s"!=x.anchor||(S="s",g=-8-parseInt(y.css("borderBottomWidth"),10),h=o+t+x.offset+8),"n"==x.anchor||"s"==x.anchor?r<c/2?(u=u<0?p+u:p,p=0):r+c/2>parseInt(k(window).width(),10)&&(u-=p,p*=2):v?(h+=g,g=0):m&&(h-=g,g*=2),delay&&clearTimeout(delay),delay=setTimeout(function(){y.css({"margin-left":u+"px","margin-top":h+"px"}).stop(!0,!0).fadeIn(x.fadeIn)},x.delay),y.attr("class","sb-tooltip "+S)},i=function(){(x.aHide||t)&&!x.aHide||(delay&&clearTimeout(delay),delay=setTimeout(function(){s()},x.delay))},s=function(){!x.aHide&&!t||x.aHide?(y.stop(!0,!0).fadeOut(x.fadeOut),x.hide&&x.hide.call(this)):setTimeout(function(){i()},200)})})},k.fn.sbLanguageSwitcher=function(t=[],e="",a=!1){let i=`<div class="sb-language-switcher" data-source="${e}">`,s=[],n=k(this).hasClass("sb-language-switcher-cnt")?k(this):k(this).find(".sb-language-switcher-cnt");for(var o=0;o<t.length;o++)s.includes(t[o])||(i+=`<span ${a==t[o]?'class="sb-active" ':""}data-language="${t[o]}"><i class="bi-x-lg"></i><img src="${STMBX_URL}/media/flags/${t[o].toLowerCase()}.png" /></span>`,s.push(t[o]));return n.find(".sb-language-switcher").remove(),n.append(i+`<i data-sb-tooltip="${D("Add translation")}" class="bi-plus-lg"></i></div>`),n.sbInitTooltips(),this},k.fn.sbShowLightbox=function(t=!1,e=""){function a(){var t=k(this),e=t.outerHeight()/-2-25;t.css({"margin-top":e+"px","margin-left":t.outerWidth()/-2+"px"})}return d.find(".sb-lightbox").sbActive(!1),nt.sbActive(!0),k(this).sbActive(!0),t?k(this).addClass("sb-popup-lightbox").attr("data-action",e):(a.call(this),k(window).on("resize",function(){a.call(this)})),k("body").addClass("sb-lightbox-active"),setTimeout(()=>{z.open_popup=this},300),this.preventDefault,this},k.fn.sbHideLightbox=function(){return k(this).find(".sb-lightbox,.sb-popup-lightbox").sbActive(!1).removeClass("sb-popup-lightbox").removeAttr("data-action"),nt.sbActive(!1),k("body").removeClass("sb-lightbox-active"),z.open_popup=!1,this};var U={dialogflow:{intents:!(k.fn.sbInitTooltips=function(){return k(this).find("[data-sb-tooltip]").each(function(){var t=this.getBoundingClientRect().top<window.innerHeight/2?"n":"w";k(this).miniTip({content:k(this).attr("data-sb-tooltip"),anchor:t,delay:100})})}),token:SBF.storage("dialogflow-token"),smart_reply_data:!1,smartReply:function(t){SBF.ajax({function:"dialogflow-smart-reply",message:t,smart_reply_data:this.smart_reply_data||{conversation_id:SBChat.conversation.id},token:this.token,dialogflow_language:[E().language?E().language:"en"],language_detection:SB_ADMIN_SETTINGS["smart-reply-language-detection"]&&SBChat.conversation&&!SBChat.conversation.getLastUserMessage(!1,!0)&&(!SB_ADMIN_SETTINGS["smart-reply-language-detection-bot"]||!SBChat.conversation.getLastUserMessage(!1,"bot"))},t=>{var e=t.suggestions;let a="";var i=S.find(".sb-conversation .sb-list"),i=i[0].scrollTop===i[0].scrollHeight-i[0].offsetHeight,s=!(!SBChat.conversation||!SBChat.conversation.getLastMessage())&&SBChat.conversation.getLastMessage().message;t.token&&this.token!=t.token&&(this.token=t.token,SBF.storage("dialogflow-token",t.token));for(var n=0;n<e.length;n++)e[n]!=s&&(a+=`<span>${e[n]}</span>`);this.smart_reply_data=t.smart_reply,Y.html(a),i&&SBChat.scrollBottom()})},smartReplyUpdate:function(t,e="agent"){SBF.ajax({function:"dialogflow-smart-reply-update",message:t,smart_reply_data:this.smart_reply_data||{conversation_id:SBChat.conversation.id},token:this.token,dialogflow_language:[E().language],user_type:e})},showCreateIntentBox:function(t){let e="";t=SBChat.conversation.getMessage(t);let a=t.message;if(SBF.isAgent(t.get("user_type")))e=0==(e=(e=SBChat.conversation.getLastUserMessage(t.get("index")))&&e.payload("sb-human-takeover")?SBChat.conversation.getLastUserMessage(e.get("index")):e)?"":e.message;else{e=a;for(var i=SBChat.conversation.messages,s=t.get("index");s<i.length;s++)if(["agent","admin"].includes(i[s].get("user_type"))){a=i[s].message;break}}!1===this.intents&&SBF.ajax({function:"dialogflow-get-intents"},t=>{let e="";if(Array.isArray(t)){for(var a=0;a<t.length;a++)e+=`<option value="${t[a].name}">${t[a].displayName}</option>`;p.find("#sb-intents-select").append(e),this.intents=t}else this.intents=[]}),p.attr("data-message-id",t.id),p.find(".sb-type-text:not(.sb-first)").remove(),p.find(".sb-type-text input").val(e),p.find("textarea").val(a),p.find("#sb-intents-select").val(""),p.find(".sb-search-btn").sbActive(!1).find("input").val(""),this.searchIntents(""),p.sbShowLightbox()},submitIntent:function(i){if(!N(i)){let t=[];var e=p.find("textarea").val();let a=p.find("#sb-intents-select").val();p.find(".sb-type-text input").each(function(){k(this).val()&&t.push(k(this).val())}),""==e&&!a||0==t.length?(SBForm.showErrorMessage(p,"Please insert the bot response and at least one user expression."),k(i).sbLoading(!1)):SBF.ajax({function:""==a?"dialogflow-create-intent":"dialogflow-update-intent",expressions:t,response:e,agent_language:p.find(".sb-dialogflow-languages select").val(),conversation_id:SBChat.conversation.id,intent_name:a},e=>{if(k(i).sbLoading(!1),!0===e)d.sbHideLightbox(),I(""==a?"Intent created":"Intent updated");else{let t="Error";"error"in e&&"message"in e.error&&(t=e.error.message),SBForm.showErrorMessage(p,t)}})}},searchIntents:function(l){l=l.toLowerCase(),SBF.search(l,()=>{var e=!(1<l.length);let a=e?`<option value="">${D("New Intent")}</option>`:"";for(var i=this.intents,s=0;s<i.length;s++){let t=e||i[s].displayName.toLowerCase().includes(l);if(!t&&"trainingPhrases"in i[s])for(var n=i[s].trainingPhrases,o=0;o<n.length;o++){for(var r=0;r<n[o].parts.length;r++)if(n[o].parts[r].text.toLowerCase().includes(l)){t=!0;break}if(t)break}t&&(a+=`<option value="${i[s].name}">${i[s].displayName}</option>`)}p.find("#sb-intents-select").html(a).change()})},previewIntent:function(t){let e="";for(var a=0;a<this.intents.length;a++)if(this.intents[a].name==t){var i="trainingPhrases"in this.intents[a]?this.intents[a].trainingPhrases:[],s=i.length;if(1<s){for(var n=0;n<s;n++)for(var o=0;o<i[n].parts.length&&(e+=`<span>${i[n].parts[o].text}</span>`,15!=o);o++);M(e,"info",!1,"intent-preview-box","",10<s)}break}},translate:function(t,e,a){t.length&&SBF.ajax({function:"google-translate",strings:t,language_code:e,token:this.token},t=>{if(this.token=t[1],!Array.isArray(t[0]))return SBF.error(JSON.stringify(t[0]),"SBApps.dialogflow.translate"),!1;a(t[0])})}},messenger:{check:function(t){return["fb","ig"].includes(t.get("source"))},send:function(t,e,a="",i=[],s,n=!1){SBF.ajax({function:"messenger-send-message",psid:t,facebook_page_id:e,message:a,attachments:i,metadata:s},t=>{n&&n(t)})}},whatsmeow:{check:function(t){return"ww"==t.get("source")},send:function(t,e="",a=[],i=!1,s=!1,n){SBF.ajax({function:"whatsmeow-send-message",to:t,message:e,attachments:a,phone_id:i},t=>{s&&s(t)})},activeUserPhone:function(t=E()){return!!t.getExtra("phone")&&t.getExtra("phone").value.replace("+","")}},waweb:{check:function(t){return"wx"==t.get("source")},send:function(t,e="",a=[],i=!1,s=!1,n){SBF.ajax({function:"waweb-send-message",to:t,message:e,attachments:a,phone_id:i},t=>{s&&s(t)})},activeUserPhone:function(t=E()){return!!t.getExtra("phone")&&t.getExtra("phone").value.replace("+","")}},whatsapp:{check:function(t){return"wa"==t.get("source")},send:function(t,e="",a=[],i=!1,s=!1){SBF.ajax({function:"whatsapp-send-message",to:t,message:e,attachments:a,phone_id:i},t=>{s&&s(t)})},activeUserPhone:function(t=E()){return!!t.getExtra("phone")&&t.getExtra("phone").value.replace("+","")}},telegram:{check:function(t){return"tg"==t.get("source")},send:function(t,e="",a=[],i=!1){SBF.ajax({function:"telegram-send-message",chat_id:t,message:e,attachments:a},t=>{i&&i(t)})}},gbm:{token:!1,check:function(t){return"bm"==t.get("source")},send:function(t,e="",a=[],i=!1){SBF.ajax({function:"gbm-send-message",google_conversation_id:t,message:e,attachments:a,token:this.token},t=>{i&&i(t),this.token=t[2]})}},twitter:{check:function(t){return"tw"==t.get("source")},send:function(t,e="",a=[],i=!1){SBF.ajax({function:"twitter-send-message",twitter_id:t,message:e,attachments:a},t=>{i&&i(t)})}},is:function(t){if(typeof SB_VERSIONS!=bt)switch(t){case"gbm":case"twitter":case"telegram":case"messenger":case"whatsapp":case"waweb":case"whatsmeow":case"dialogflow":case"sb":return!0}return!1}},j={init:!1,save:function(a){if(!N(a)){let o={},r={};switch(_.find(" > .sb-tab > .sb-nav .sb-active").attr("id")){case"tab-articles":this.articles.save(t=>{I(!0===t?"Articles and categories saved":t),k(a).sbLoading(!1)});break;case"tab-automations":let e=B.find(".sb-active").attr("data-id");j.automations.save(t=>{I(!0===t?"Automations saved":t),j.automations.populate(),B.find(`[data-id="${e}"]`).click(),k(a).sbLoading(!1)});break;case"tab-translations":this.translations.updateActive(),SBF.ajax({function:"save-translations",translations:JSON.stringify(this.translations.to_update)},()=>{I("Translations saved"),k(a).sbLoading(!1)});break;default:_.find(".sb-setting").each((t,e)=>{var a=this.get(e),i=k(e).data("setting");if(a[0])if(typeof i!=bt){let t=!1;if(k(e).find("[data-language]").length){var s=k(e).find("[data-language].sb-active");if(t=a[0]in this.translations.originals&&this.translations.originals[a[0]],this.translations.save(e,!!s.length&&s.attr("data-language")),t&&"string"!=typeof t)for(var n in t)t[n]=[t[n],a[1][n][1]]}i in o||(o[i]={}),o[i][a[0]]=[t||a[1],a[2]]}else r[a[0]]=[a[1],a[2]]}),SBF.ajax({function:"save-settings",settings:JSON.stringify(r),external_settings:o,external_settings_translations:this.translations.translations},()=>{I("Settings saved"),k(a).sbLoading(!1),setTimeout(()=>{location.reload()},600)})}}},initPlugins:function(){_.find("textarea").each(function(){k(this).autoExpandTextarea(),k(this).manualExpandTextarea()}),_.find("[data-setting] .sb-language-switcher-cnt").each(function(){k(this).sbLanguageSwitcher(j.translations.getLanguageCodes(k(this).closest("[data-setting]").attr("id")),"settings")})},initColorPicker:function(t=!1){k(t||_).find(".sb-type-color input").colorPicker({renderCallback:function(t,e){k(t.context).closest(".input").find("input").css("background-color",t.text)}})},initHTML:function(e){if("slack-agents"in e){let t="";for(var a in e["slack-agents"][0])t+=`<div data-id="${a}"><select><option value="${e["slack-agents"][0][a]}"></option></select></div>`;_.find("#slack-agents .input").html(t)}},get:function(n){var o=(n=k(n)).attr("id"),r=n.data("type");n.attr("value");switch(r){case"upload":case"range":case"number":case"text":case"password":case"color":return[o,n.find("input").val(),r];case"textarea":return[o,n.find("textarea").val(),r];case"select":return[o,n.find("select").val(),r];case"checkbox":return[o,n.find("input").is(":checked"),r];case"radio":let t=n.find("input:checked").val();return[o,t=SBF.null(t)?"":t,r];case"upload-image":let e=n.find(".image").attr("data-value");return[o,e=SBF.null(e)?"":e,r];case"multi-input":let a={};return n.find(".input > div").each((t,e)=>{e=this.get(e);e[0]&&(a[e[0]]=[e[1],e[2]])}),[o,a,r];case"select-images":return[o,n.find(".input > .sb-active").data("value"),r];case"repeater":return[o,this.repeater("get",n.find(".repeater-item"),""),r];case"double-select":let i={};return n.find(".input > div").each(function(){var t=k(this).find("select").val();-1!=t&&(i[k(this).attr("data-id")]=[t])}),[o,i,r];case"select-checkbox":return[o,n.find(".sb-select-checkbox input:checked").map(function(){return k(this).attr("id")}).get(),r];case"timetable":let s={};return n.find(".sb-timetable > [data-day]").each(function(){var t=k(this).attr("data-day");let a=[];k(this).find("> div > div").each(function(){var t=k(this).html(),e=k(this).attr("data-value");SBF.null(e)?a.push(["",""]):"closed"==e?a.push(["closed","Closed"]):a.push([e,t])}),s[t]=a}),[o,s,r];case"color-palette":return[o,n.attr("data-value"),r]}return["","",""]},set:function(t,e){var a=k(e)[1],i=k(e)[0];switch(t="#"+t,a){case"color":case"upload":case"number":case"text":case"password":_.find(t+" input").val(i);break;case"textarea":_.find(t+" textarea").val(i);break;case"select":_.find(t+" select").val(i);break;case"checkbox":_.find(t+" input").prop("checked","false"!=i&&i);break;case"radio":_.find(t+` input[value="${i}"]`).prop("checked",!0);break;case"upload-image":i&&_.find(t+" .image").attr("data-value",i).css("background-image",`url("${i}")`);break;case"multi-input":for(var s in i)this.set(s,i[s]);break;case"range":var n=i;_.find(t+" input").val(n),_.find(t+" .range-value").html(n);break;case"select-images":_.find(t+" .input > div").sbActive(!1),_.find(t+` .input > [data-value="${i}"]`).sbActive(!0);break;case"select-checkbox":for(var o=0;o<i.length;o++)_.find(`input[id="${i[o]}"]`).prop("checked",!0);_.find(t+" .sb-select-checkbox-input").val(i.join(", "));break;case"repeater":n=this.repeater("set",i,_.find(t+" .repeater-item:last-child"));n&&_.find(t+" .sb-repeater").html(n);break;case"double-select":for(var s in i)_.find(t+` .input > [data-id="${s}"] select`).val(i[s]);break;case"timetable":for(var s in i)for(var r=_.find(t+` [data-day="${s}"] > div > div`),o=0;o<r.length;o++)k(r[o]).attr("data-value",i[s][o][0]).html(i[s][o][1]);break;case"color-palette":i&&_.find(t).attr("data-value",i)}},repeater:function(t,e,a){if(a=k(a).html(),"set"==t){var i="";if(0<e.length){k(a).find(".bi-x-lg").remove();for(var s=0;s<e.length;s++){var n,o=k(k.parseHTML(`<div>${a}</div>`));for(n in e[s])this.setInput(o.find(`[data-id="${n}"]`),e[s][n]);i+=`<div class="repeater-item">${o.html()}<i class="bi-x-lg"></i></div>`}}return i}if("get"==t){let t=[],i=this;return k(e).each(function(){let e={},a=!0;k(this).find("[data-id]").each(function(){var t=i.getInput(this);a&&t&&"hidden"!=k(this).attr("type")&&"auto-id"!=k(this).attr("data-type")&&(a=!1),e[k(this).attr("data-id")]=t}),a||t.push(e)}),t}},repeaterAdd:function(t){let a=k(t).parent();(t=k(k.parseHTML(`<div>${a.find(".repeater-item:last-child").html()}</div>`))).find("[data-id]").each(function(){if(j.resetInput(this),"auto-id"==k(this).data("type")){let e=1;a.find('[data-type="auto-id"]').each(function(){var t=parseInt(k(this).val());t>e&&(e=t)}),k(this).attr("value",e+1)}}),a.find(".sb-repeater").append(`<div class="repeater-item">${t.html()}</div>`)},repeaterDelete:function(t){t=k(t).parent();1<t.parent().find(".repeater-item").length?t.remove():t.find("[data-id]").each((t,e)=>{this.resetInput(e)})},setInput:function(t,e){var a;e=k.trim(e),(t=k(t)).is("select")?t.find(`option[value="${e}"]`).attr("selected",""):t.is(":checkbox")&&e&&"false"!=e?t.attr("checked",""):t.is("textarea")?t.html(e):(a=t.is("div"))||t.is("i")||t.is("li")?(t.attr("data-value",e),a&&t.hasClass("image")&&t.css("background-image",e?`url("${e}")`:"")):t.attr("value",e)},getInput:function(t){var e;return(t=k(t)).is(":checkbox")?t.is(":checked"):t.is("div")||t.is("i")||t.is("li")?(e=t.attr("data-value"),SBF.null(e)?"":e):t.val()},resetInput:function(t){(t=k(t)).is("select")?t.val("").find("[selected]").removeAttr("selected"):t.is("checkbox")&&value?t.removeAttr("checked").prop("checked",!1):t.is("textarea")?t.html(""):t.removeAttr("value").removeAttr("style").removeAttr("data-value").val("")},getSettingObject:function(t){return k(t)[0].hasAttribute("data-setting")?k(t):k(t).closest("[data-setting]")},articles:{categories:[],articles:[],translations:{},get:function(e,t=!1,a=!0){SBF.ajax({function:"get-articles",categories:t,articles_language:"all",full:a},t=>{e(t)})},save:function(e=!1){if(this.updateActiveArticle(),o)if(n)n=!1;else if(this.activeID()&&-1!=this.activeID())return void(n=e);x.find(".sb-new-category-cnt input").each((t,e)=>{var a=k.trim(k(e).val());a&&this.categories.push({id:SBF.random(),title:a}),k(e).parents().eq(1).remove()}),this.categories.length&&this.categories.sort(function(t,e){return t.title.localeCompare(e.title)}),SBF.ajax({function:"save-articles",articles:this.articles,translations:this.translations,categories:this.categories.length?this.categories:"delete_all"},t=>{x.find(".sb-menu-wide .sb-active").click(),x.find(`.sb-nav [data-id="${this.activeID()}"]`).click(),this.updateSelect(),e&&e(t)}),U.is("dialogflow")&&SBF.ajax({function:"dialogflow-knowledge",articles:this.articles})},show:function(t=!1,e=!1,a=!1){let i=[-1,"","","",""];this.updateActiveArticle(),this.hide(!1);var s=a?a in this.translations?this.translations[a]:[]:this.articles;!1===t&&(t=this.activeID());for(var n=0;n<s.length;n++)if(s[n].id==t){i=[t,s[n].title,s[n].content,s[n].link,SBF.null(s[n].categories)?[""]:s[n].categories,SBF.null(s[n].parent_category)?"":s[n].parent_category,s[n].editor_js],e&&(k(e).siblings().sbActive(!1),k(e).sbActive(!0));break}Z.val(""),Q.val(i[5]);for(n=0;n<i[4].length;n++)Z.eq(n).val(i[4][n]);x.sbLanguageSwitcher(this.getTranslations(t),"articles",a),x.find(".sb-content").attr("data-id",i[0]),x.find(".sb-article-title input").val(i[1]),x.find(".sb-article-link input").val(i[3]),x.find("#sb-article-id").html(`ID <span>${i[0]}</span>`),o||x.find("#editorjs").length?wt(i[6]||i[2]):x.find(".sb-article-content textarea").val(i[2])},add:function(){var t=x.find(".sb-nav > ul"),e=SBF.random();this.updateActiveArticle(),this.articles.push({id:e,title:"",content:"",link:"",categories:[]}),this.hide(!1),t.find(".sb-active").sbActive(!1),t.find(".sb-no-results").remove(),t.append(`<li class="sb-active" data-id="${e}">${D("Article")} ${t.find("li").length+1}<i class="bi-trash"></i></li>`),x.find("input, textarea, select").val(""),x.find(".sb-content").attr("data-id",e),x.sbLanguageSwitcher([],"articles"),wt()},addCategory:function(){x.find('[data-type="categories"] .sb-no-results').remove(),x.find(".sb-new-category-cnt").append('<div class="sb-input-setting sb-type-text"><div><input type="text"></div></div>')},delete:function(t,e=!1){var a,i=k(t).closest(".sb-nav").find(" > ul"),s=k(t).parent(),n=s.attr("data-id");for(a in this[e?"categories":"articles"].splice(s.index(),1),this.hide(),1<i.find("li").length?k(t).parent().remove():i.html(`<li class="sb-no-results">${D("No results found.")}</li>`),this.translations)for(var o=0;o<this.translations[a].length;o++)this.translations[a][o].id===n&&this.translations[a].splice(o,1);e||_t()},populate:function(e=!1,a=!1){if(!1===e&&(e=a?this.categories:this.articles),Array.isArray(e)){let t="";if(a?this.categories=e:this.articles=e,e.length)for(var i=0;i<e.length;i++)t+=`<li data-id="${e[i].id}">${a?"<span>"+e[i].id+"</span>":""}${e[i].title}<i class="bi-trash${a?" sb-category":""}"></i></li>`;else t=`<li class="sb-no-results">${D("No results found.")}</li>`;x.find(".sb-add-category,.sb-new-category-cnt").sbActive(a),x.find(".sb-add-article").sbActive(!a),x.find(".sb-nav").attr("data-type",a?"categories":"articles"),x.find(".sb-nav > ul").html(t),this.hide()}else SBF.error(e,"SBSettings.articles.populate")},updateActiveArticle:function(){var a=this.activeID();if(-1!=a){var i=x.find(".sb-language-switcher [data-language].sb-active").attr("data-language");let e=i?i in this.translations?this.translations[i]:[]:this.articles,t=[];Z.each(function(){k(this).val()&&t.push(k(this).val())});for(var s=0;s<e.length;s++)if(e[s].id==a){article={id:a,title:x.find(".sb-article-title input").val(),content:x.find(".sb-article-content textarea").val(),link:x.find(".sb-article-link input").val(),categories:t,parent_category:Q.val()},o&&typeof o.save!==bt?o.save().then(t=>{article.editor_js=t,article.content=function(t){let e="";return t.map(t=>{switch(t.type){case"header":e+=`<h${t.data.level}>${t.data.text}</h${t.data.level}>`;break;case"paragraph":e+=`<p>${t.data.text}</p>`;break;case"image":e+=`<img class="img-fluid" src="${t.data.file.url}" title="${t.data.caption}" /><em>${t.data.caption}</em>`;break;case"list":e+='<ul class="sb-ul-'+t.data.style+'">',t.data.items.forEach(function(t){e+=`<li>${t}</li>`}),e+="</ul>";break;case"code":e+=`<code>${t.data.code}</code>`;break;case"raw":e+=`<div class="bxc-raw-html">${t.data.html}</div>`}}),e}(t.blocks),e[s]=article,n&&this.save(n)}).catch(t=>{console.log(t)}):e[s]=article,SBF.null(article.title)&&this.delete(x.find(`.sb-nav [data-id="${a}"] i`));break}}},updateSelect:function(){let t=[];var e=Q.val();let a='<option value=""></option>';Z.each(function(){t.push(k(this).val())});for(var i=0;i<this.categories.length;i++)a+=`<option value="${this.categories[i].id}">${this.categories[i].title}</option>`;Z.html(a),Q.html(a),Q.val(e);for(i=0;i<t.length;i++)Z.eq(i).val(t[i])},addTranslation:function(t=!1,e){if(!1===t&&(t=this.activeID()),this.getTranslations(t).includes(t))return console.warn("Article translation already in array.");e in this.translations||(this.translations[e]=[]),this.translations[e].push({id:t,title:"",content:"",link:"",categories:[]})},getTranslations:function(t=!1){var e,a=[];for(e in!1===t&&(t=this.activeID()),this.translations)for(var i=this.translations[e],s=0;s<i.length;s++)if(i[s].id==t){a.push(e);break}return a},deleteTranslation:function(t=!1,e){if(!1===t&&(t=this.activeID()),e in this.translations)for(var a=this.translations[e],i=0;i<a.length;i++)if(a[i].id==t)return this.translations[e].splice(i,1),!0;return!1},activeID:function(){return x.find(".sb-content").attr("data-id")},hide:function(t=!0){x.find(".sb-content").setClass("sb-hide",t)}},automations:{items:{messages:[],emails:[],sms:[],popups:[],design:[],more:[]},translations:{},conditions:{datetime:["Date time",["Is between","Is exactly"],"dd/mm/yyy hh:mm - dd/mm/yyy hh:mm"],repeat:["Repeat",["Every day","Every week","Every month","Every year"]],browsing_time:["Browsing time",[],"seconds"],scroll_position:["Scroll position",[],"px"],include_urls:["Include URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],exclude_urls:["Exclude URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],referring:["Referring URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],user_type:["User type",["Is visitor","Is lead","Is user","Is not visitor","Is not lead","Is not user"]],returning_visitor:["Returning visitor",["First time visitor","Returning visitor"]],countries:["Countries",[],"Country codes separated by commas"],languages:["Languages",[],"Language codes separated by commas"],cities:["Cities",[],"Cities separated by commas"],custom_variable:["Custom variable",[],"variable=value"]},get:function(e){SBF.ajax({function:"automations-get"},t=>{this.items=t[0],this.translations=Array.isArray(t[1])&&!t[1].length?{}:t[1],e(t)})},save:function(e=!1){this.updateActiveItem(),SBF.ajax({function:"automations-save",automations:this.items,translations:this.translations},t=>{e&&e(t)})},show:function(t=!1,e=!1){this.updateActiveItem();var a=e?e in this.translations?this.translations[e]:[]:this.items,i=y.find(" > .sb-tab > .sb-content");for(r in!1===t&&(t=this.activeID()),this.hide(!1),a)for(var s=0;s<a[r].length;s++){var n=a[r][s],o=n.conditions;if(n.id==t){for(var r in tt.html(""),n){var l=i.find(`[data-id="${r}"]`);l.hasClass("image")?(l.css("background-image",`url(${n[r]})`).attr("data-value",n[r]),""==n[r]&&l.removeAttr("data-value")):"checkbox"==l.attr("type")?l.prop("checked",n[r]):l.val(n[r])}if(o)for(var r in o){this.addCondition();var c=tt.find(" > div:last-child");c.find("select").val(o[r][0]),this.updateCondition(c.find("select")),c.find(" > div").eq(1).find("select,input").val(o[r][1]),2<o[r].length&&c.find(" > div").eq(2).find("input").val(o[r][2])}return tt.parent().setClass("sb-hide",e),i.sbLanguageSwitcher(this.getTranslations(t),"automations",e),!0}}return!1},add:function(){var t=SBF.random(),e=D("Item")+" "+(B.find("li:not(.sb-no-results)").length+1);this.updateActiveItem(),this.items[this.activeType()].push(this.itemArray(this.activeType(),t,e)),this.hide(!1),B.find(".sb-active").sbActive(!1),B.find(".sb-no-results").remove(),B.append(`<li class="sb-active" data-id="${t}">${e}<i class="bi-trash"></i></li>`),y.find(".sb-automation-values").find("input, textarea").val(""),y.sbLanguageSwitcher([],"automations"),tt.html("")},delete:function(t){this.items[this.activeType()].splice(k(t).parent().index(),1),k(t).parent().remove(),this.hide(),0==this.items[this.activeType()].length&&B.html(`<li class="sb-no-results">${D("No results found.")}</li>`)},populate:function(t=!1){!1===t&&(t=this.activeType());let e="";var a=this.items[t];if(this.updateActiveItem(),a.length)for(var i=0;i<a.length;i++)e+=`<li data-id="${a[i].id}">${a[i].name}<i class="bi-trash"></i></li>`;else e=`<li class="sb-no-results">${D("No results found.")}</li>`;switch(B.html(e),e="",t){case"emails":e=`<h2>${D("Subject")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="subject" type="text"></div></div>`;break;case"popups":e=`<h2>${D("Title")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="title" type="text"></div></div><h2>${D("Profile image")}</h2><div data-type="upload-image" class="sb-input-setting sb-type-upload-image"><div class="input"><div data-id="profile_image" class="image"><i class="bi-x-lg"></i></div></div></div><h2>${D("Message fallback")}</h2><div class="sb-input-setting sb-type-checkbox"><div><input data-id="fallback" type="checkbox"></div></div>`;break;case"design":e=`<h2>${D("Header title")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="title" type="text"></div></div>`;for(i=1;i<4;i++)e+=`<h2>${D((1==i?"Primary":2==i?"Secondary":"Tertiary")+" color")}</h2><div data-type="color" class="sb-input-setting sb-type-color"><div class="input"><input data-id="color_${i}" type="text"><i class="sb-close bi-x-lg"></i></div></div>`;for(i=1;i<4;i++)e+=`<h2>${D(1==i?"Header background image":2==i?"Header brand image":"Chat button icon")}</h2><div data-type="upload-image" class="sb-input-setting sb-type-upload-image"><div class="input"><div data-id="${1==i?"background":2==i?"brand":"icon"}" class="image"><i class="bi-x-lg"></i></div></div></div>`;break;case"more":e=`<h2>${D("Department ID")}</h2><div class="sb-input-setting sb-type-number"><div><input data-id="department" type="number"></div></div><h2>${D("Agent ID")}</h2><div class="sb-input-setting sb-type-number"><div><input data-id="agent" type="number"></div></div><h2>${D("Tags")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="tags" type="text"></div></div>`}y.find(".sb-automation-extra").html(e),y.attr("data-automation-type",t),j.initColorPicker(y),this.hide()},updateActiveItem:function(){var t=this.activeID();if(t){var a=y.find(".sb-language-switcher [data-language].sb-active").attr("data-language"),i=this.activeType();let e=a?a in this.translations?this.translations[a][i]:[]:this.items[i];for(var s=tt.find(" > div"),n=0;n<e.length;n++)if(e[n].id==t){e[n]={id:t,conditions:[]},y.find(".sb-automation-values").find('input,textarea,[data-type="upload-image"] .image').each(function(){e[n][k(this).attr("data-id")]=k(this).hasClass("image")&&k(this)[0].hasAttribute("data-value")?k(this).attr("data-value"):"checkbox"==k(this).attr("type")?k(this).is(":checked"):k(this).val()}),s.each(function(){let t=[];k(this).find("input,select").each(function(){t.push(k(this).val())}),t[0]&&t[1]&&(2==t.length||t[2])&&e[n].conditions.push(t)}),SBF.null(e[n].name)&&this.delete(B.find(`[data-id="${t}"] i`));break}}},addCondition:function(){tt.append(`<div><div class="sb-input-setting sb-type-select sb-condition-1"><select>${this.getAvailableConditions()}</select></div></div>`)},updateCondition:function(e){k(e).parent().siblings().remove();var a=k(e).parents().eq(1);if(k(e).val()){var i=this.conditions[k(e).val()];let t="";if(i[1].length){t='<div class="sb-input-setting sb-type-select sb-condition-2"><select>';for(var s=0;s<i[1].length;s++)t+=`<option value="${SBF.stringToSlug(i[1][s])}">${D(i[1][s])}</option>`;t+="</select></div>"}a.append(t+(2<i.length?`<div class="sb-input-setting sb-type-text"><input placeholder="${D(i[2])}" type="text"></div>`:"")),a.siblings().find(".sb-condition-1 select").each(function(){var t=k(this).val();k(this).html(j.automations.getAvailableConditions(t)),k(this).val(t)})}else a.remove()},getAvailableConditions:function(t=""){let e='<option value=""></option>',a=[];for(var i in tt.find(".sb-condition-1 select").each(function(){a.push(k(this).val())}),this.conditions)a.includes(i)&&i!=t||(e+=`<option value="${i}">${D(this.conditions[i][0])}</option>`);return e},addTranslation:function(t=!1,e=!1,a){if(!1===t&&(t=this.activeID()),!1===e&&(e=this.activeType()),this.getTranslations(t).includes(t))return console.warn("Automation translation already in array.");a in this.translations||(this.translations[a]={messages:[],emails:[],sms:[],popups:[],design:[]}),e in this.translations[a]||(this.translations[a][e]=[]),this.translations[a][e].push(this.itemArray(e,t))},getTranslations:function(t=!1){var e,a=[];for(e in!1===t&&(t=this.activeID()),this.translations){var i,s=this.translations[e];for(i in s)for(var n=s[i],o=0;o<n.length;o++)if(n[o].id==t){a.push(e);break}}return a},deleteTranslation:function(t=!1,e){if(!1===t&&(t=this.activeID()),e in this.translations){var a,i=this.translations[e];for(a in i)for(var s=i[a],n=0;n<s.length;n++)if(s[n].id==t)return this.translations[e][a].splice(n,1),!0}return!1},activeID:function(){var t=B.find(".sb-active");return!!t.length&&t.attr("data-id")},activeType:function(){return K.find("li.sb-active").data("value")},itemArray:function(t,e,a="",i=""){return k.extend({id:e,name:a,message:i},"emails"==t?{subject:""}:"popups"==t?{title:"",profile_image:""}:"design"==t?{title:"",color_1:"",color_2:"",color_3:"",background:"",brand:"",icon:""}:{})},hide:function(t=!0){y.find(" > .sb-tab > .sb-content").setClass("sb-hide",t)}},translations:{translations:{},originals:{},to_update:{},add:function(t){var e=j.getSettingObject(it),a=e.attr("id"),i=it.find("[data-language].sb-active");this.save(e,!!i.length&&i.attr("data-language")),e.find('textarea,input[type="text"]').val(""),this.save(e,t),it.remove(),e.sbLanguageSwitcher(this.getLanguageCodes(a),"settings",t)},delete:function(t,e){var a=(t=j.getSettingObject(t)).attr("id");delete this.translations[e][a],t.find(`.sb-language-switcher [data-language="${e}"]`).remove(),this.activate(t)},activate:function(t,e=!1){var a=(t=j.getSettingObject(t)).attr("id"),i=(e?this.translations[e]:this.originals)[a];if("string"==typeof i)t.find("input, textarea").val(i);else for(var s in i)t.find("#"+s).find("input, textarea").val("string"==typeof i[s]?i[s]:i[s][0])},updateActive:function(){var t=_.find(".sb-translations-list");let a={front:{},admin:{},"admin/js":{},"admin/settings":{}};var e=t.attr("data-value");if(!SBF.null(e)){for(var i in a)t.find(' > [data-area="'+i+'"] .sb-input-setting:not(.sb-new-translation)').each(function(){a[i][k(this).find("label").html()]=k(this).find("input").val()}),t.find('> [data-area="'+i+'"] .sb-new-translation').each(function(){var t=k(this).find("input:first-child").val(),e=k(this).find("input:last-child").val();t&&e&&(a[i][t]=e)});this.to_update[e]=a}},save:function(t,e=!1){t=j.getSettingObject(t);let a={};var i=k(t).attr("id");"multi-input"==t.data("type")?t.find(".multi-input-textarea,.multi-input-text").each(function(){a[k(this).attr("id")]=k(this).find("input, textarea").val()}):a=t.find("input, textarea").val(),e?(e in this.translations||(this.translations[e]={}),this.translations[e][i]=a):this.originals[i]=a},load:function(o){let r=_.find(".sb-translations > .sb-content");r.find(" > .sb-hide").removeClass("sb-hide"),this.updateActive(),SBF.ajax({function:"get-translation",language_code:o},t=>{o in this.to_update&&(t=this.to_update[o]);let e="";for(var a=["front","admin","admin/js","admin/settings"],i=0;i<a.length;i++){var s,n=t[a[i]];for(s in e+=`<div${i?"":' class="sb-active"'} data-area="${a[i]}">`,n)e+=`<div class="sb-input-setting sb-type-text"><label>${s}</label><div><input type="text" value="${n[s]}"></div></div>`;e+="</div>"}r.find(".sb-translations-list").attr("data-value",o).html(e),r.find(".sb-menu-wide li").sbActive(!1).eq(0).sbActive(!0),r.sbLoading(!1)}),r.sbLoading(!0)},getLanguageCodes:function(t){var e,a=[];for(e in this.translations)t in this.translations[e]&&a.push(e);return a}}},G={chart:!1,active_report:!1,initChart:function(t,e="line",n=1){let o=[];var a,i=[],s=["#0eacb2","#299fb1","#4492b0","#5d86ae","#7379ac","#867cae","#9b70ad","#b06bae","#c465af","#d65fb1"];for(a in t)o.push(t[a][0]),i.push(a);if("line"!=e&&6<o.length)for(var r=0;r<o.length;r++)s.push("hsl(210, "+Math.floor(100*Math.random())+"%, "+Math.floor(100*Math.random())+"%)");this.chart&&this.chart.destroy(),this.chart=new Chart(C.find("canvas"),{type:e,data:{labels:i,datasets:[{data:o,backgroundColor:"line"==e?"#d4e7e952":s,borderColor:"line"==e?"#5c00ff":s,borderWidth:1}]},options:{legend:{display:!1},scales:{yAxes:[{ticks:{callback:function(t,e,a){return 1!=n&&2==n?new Date(1e3*t).toISOString().substr(11,8):t},beginAtZero:!0}}],xAxes:[{ticks:{beginAtZero:!0}}]},tooltips:{callbacks:{label:function(t,e){var a=t.index,i=e.datasets[0].data[a];switch(n){case 1:return i;case 2:return new Date(1e3*o[a]).toISOString().substr(11,8);case 3:return i+"%";case 4:var s=C.find(".sb-table tbody tr").eq(a).find("td");return s.eq(0).text()+" "+s.eq(1).text()}}},displayColors:!1}}})},initTable:function(t,e,a=!1){let i="<thead><tr>";for(var s,n=e[Object.keys(e)[0]].length-1,o=[],r=0;r<t.length;r++)i+=`<th>${t[r]}</th>`;for(s in i+="</tr></thead><tbody>",e)0!=e[s][n]&&o.push([s,e[s][n]]);a&&o.reverse();for(r=0;r<o.length;r++)i+=`<tr><td><div>${o[r][0]}</div></td><td>${o[r][1]}</td></tr>`;i+="</tbody>",C.find("table").html(i)},initReport:function(t=!1,e=!1){let n=C.find(".sb-tab > .sb-content");e=SBF.null(e)?[!1,!1]:e.split(" - "),n.sbLoading(!0),t&&(this.active_report=t),this.active_report&&this.getData(this.active_report,e[0],e[1],s=>{0==s?n.addClass("sb-no-results-active"):(n.removeClass("sb-no-results-active"),"status-client"==this.active_report?(n.addClass("sb-results-active"),n.find("#"+this.active_report).attr("style","display:block!important"),n.find(".sb-reports-tags .sb-tags").html(""),c.forEach(t=>{let e=t;t=s.data.filter(t=>t.label==e);let i="";t.map(e=>{let a="";s.extra.map(t=>{t.user_id==e.user_id&&(a+=`<li class="add-user agent-name-tags">${t.first_name}</li>`)}),i+=`<div class="sb-responsive-tags">${e.first_name} ${e.last_name}<section class="flex-agents">${a}</section></div>`});var a=k('<div style="min-width: 180px;max-width: 554px;" class="sb-tags-details sb-hide"></div>');""!==i.trim()&&a.removeClass("sb-hide"),a.append(`<div>
								<h4 class="title-tags tags-${e}">
									<div>
										<i class="sb-icon bi-kanban-fill tags-${e}"></i>
									</div>
									<div class="white-title-elements">
										${e.toUpperCase()}(${t.length})
									</div>
									<div>
										<div class="arrow-down-tags white-title-elements">
											<i class="bi-check-lg"></i>
										</div>
									</div>
								</h4>
							</div>
							<div style="overflow: scroll;max-height: 420px;">${i}</div>`),n.find(".sb-reports-tags .sb-tags").append(a)})):(n.removeClass("sb-results-active"),n.find("#status-client").attr("style","display:none!important")),s.chart_type&&(this.initChart(s.data,s.chart_type,s.label_type),this.initTable(s.table,s.data,s["table-inverse"])),C.find(".sb-reports-title").html(s.title),C.find(".sb-reports-text").html(s.description),C.find(".bi-chevron-down").remove(),L||l(C.find(".sb-collapse"),C.find("canvas").outerHeight()-135)),n.sbLoading(!1)})},getData:function(t,e=!1,a=!1,i){SBF.ajax({function:"reports",name:t,date_start:e,date_end:a},t=>{i(t)})},initDatePicker:function(){var t={ranges:{},applyClass:"reports-datepicker",locale:{format:"DD/MM/YYYY",separator:" - ",applyClass:"reports-datepicker",applyLabel:D("Apply"),cancelLabel:D("Cancel"),fromLabel:D("From"),toLabel:D("To"),weekLabel:D("W"),daysOfWeek:[D("Su"),D("Mo"),D("Tu"),D("We"),D("Th"),D("Fr"),D("Sa")],monthNames:[D("January"),D("February"),D("March"),D("April"),D("May"),D("June"),D("July"),D("August"),D("September"),D("October"),D("November"),D("December")],firstDay:1},showCustomRangeLabel:!1,alwaysShowCalendars:!0,autoApply:!0};t.ranges[D("Today")]=[moment(),moment()],t.ranges[D("Yesterday")]=[moment().subtract(1,"days"),moment().subtract(1,"days")],t.ranges[D("Last 3 Days")]=[moment().subtract(2,"days"),moment()],t.ranges[D("Last 5 Days")]=[moment().subtract(4,"days"),moment()],t.ranges[D("Last 7 Days")]=[moment().subtract(6,"days"),moment()],t.ranges[D("Last 15 Days")]=[moment().subtract(14,"days"),moment()],t.ranges[D("This Month")]=[moment().startOf("month"),moment().endOf("month")],C.find("#sb-date-picker").daterangepicker(t).val("")}},q={real_time:null,datetime_last_user:"2000-01-01 00:00:00",sorting:["creation_time","DESC"],user_types:["visitor","lead","user"],user_main_fields:["id","first_name","last_name","email","password","profile_image","user_type","creation_time","token","last_activity","department"],search_query:"",init:!1,busy:!1,table_extra:!1,history:[],filter:function(t){this.user_types=t="all"==t?["visitor","lead","user"]:"agent"==t?["agent","admin"]:[t],this.loading(),ut=dt=1;var e="online"==t[0]?["get-online-users",SB_ACTIVE_AGENT.id,this.sorting[0]]:["get-users",-1,this.sorting];SBF.ajax({function:e[0],sorting:e[2],user_types:t,search:this.search_query,extra:this.table_extra},t=>{this.populate(t),this.loading(!1)})},sort:function(t,e="DESC"){this.sorting=[t,e],this.loading(),ut=dt=1,SBF.ajax({function:"get-users",sorting:this.sorting,user_types:this.user_types,search:this.search_query,extra:this.table_extra},t=>{this.populate(t),this.loading(!1),console.log("Sorting completed successfully:",t)})},search:function(t){r(t,(e,a)=>{ut=dt=1,SBF.ajax({function:1<e.length?"search-users":"get-users",search:e,user_types:this.user_types,sorting:this.sorting,extra:this.table_extra},t=>{this.user_types=["lead"],this.populate(t),this.search_query=e,k(a).sbLoading(!1),b.find("li").sbActive(!1).eq(0).sbActive(!0)})})},populate:function(t){let e="";var a=t.length;if(a)for(var i=0;i<a;i++)e+=this.getRow(new SBUser(t[i],t[i].extra));else e=`<p class="sb-no-results">${D("No users found.")}</p>`;f.parent().scrollTop(0),f.find("tbody").html(e),this.user_types.includes("agent")&&SBF.ajax({function:"get-online-users",agents:!0},t=>{let e=[];for(var a=0;a<t.length;a++)e.push(t[a].id);f.find("[data-user-id]").each(function(){k(this).find(".sb-td-profile").addClass("sb-"+(e.includes(k(this).attr("data-user-id"))?"online":"offline"))})})},update:function(){if(!this.busy){let n=["user","visitor","lead","agent"],o=n.includes(this.user_types[0])&&""==this.search_query,r=b.find(".sb-active").data("type");"online"==r?this.filter(r):(this.busy=!0,SBF.ajax({function:"get-new-users",datetime:this.datetime_last_user},e=>{var a=e.length;if(this.busy=!1,0<a){let t="";for(var i=0;i<a;i++){var s=new SBUser(e[i]);$[s.id]=s,this.updateMenu("add",s.type),o&&(t+=this.getRow(s))}if(o&&(f.find("tbody").prepend(t),n.includes(r))){let t="";for(i=0;i<n.length;i++)t+=n[i]==r?"":`[data-user-type="${n[i]}"],`;f.find(t.slice(0,-1)).remove()}this.datetime_last_user=e[0].creation_time}}))}},getRow:function(e,t){if(e instanceof SBUser){let t="";for(var a=0;a<this.table_extra.length;a++){var i=this.table_extra[a];t+=`<td class="sb-td-${i}">${this.user_main_fields.includes(i)?e.get(i):e.getExtra(i)}</td>`}return`<tr data-user-id="${e.id}" data-user-type="${e.type}"><td><input type="checkbox" /></td><td class="sb-td-profile"><a class="sb-profile"><img loading="lazy" src="${e.image}" class="sb-tags tags-${e.details.label}" style="max-width: 27px;max-height: 27px;padding: 2px;border:none;" /><span style="margin:0px 1px">${25<e.name.length?e.name.slice(0,25)+"...":e.name}</span></a></td>${t}<td style="overflow: hidden;max-width: 80px;text-overflow: ellipsis;overflow-wrap: break-word;" class="sb-td-email"class="sb-td-email">${e.get("email")}</td><td class="sb-td-ut">${D(e.type)}</td><td>${SBF.beautifyTime(e.get("last_activity"),!0)}</td><td>${SBF.beautifyTime(e.get("creation_time"),!0)}</td></tr>`}return SBF.error("User not of type SBUser","SBUsers.getRow"),!1},updateRow:function(t){var e,a,i=f.find(`[data-user-id="${t.id}"]`);i.length?(e=b.find(".sb-active").data("type"))===t.type||"admin"===t.type&&"agent"===e||"all"===e?(e=this.getRow(t),i.replaceWith(e),this.updateTagsLabel(t)):(e=d.find(`[data-type="${"admin"===t.type?"agent":t.type}"] span`),a=parseInt(e.attr("data-count")),e.html(a+1).attr("data-count",a+1),i.remove()):f.find("tbody").append(this.getRow(t))},updateTagsLabel:function(t){k(`[data-user-id="${t.id}"] .sb-tags`).removeClass().addClass("sb-tags tags-"+t.details.label)},updateMenu:function(t="all",e=!1){let a=["all","user","agent","lead","visitor"];"all"==t?SBF.ajax({function:"count-users"},t=>{for(var e=0;e<a.length;e++)this.updateMenuItem("set",a[e],t[a[e]])}):this.updateMenuItem(t,e)},updateMenuItem:function(t="set",e=!1,a=1){var e=b.find(`[data-type="${e}"] span`),i=["user","lead","visitor","agent"];"set"!==t&&(a=parseInt(e.attr("data-count"))+("add"===t?1:-1)),e.html(`<span style="vertical-align: sub;color: var(--chat-text-primary); font-weight:bold;">(${a})</span>`).attr("data-count",a);for(let t=a=0;t<i.length;t++)a+=parseInt(b.find(`[data-type="${i[t]}"] span`).attr("data-count"));b.find('[data-type="all"] span').html(`<span style="vertical-align: sub;color: var(--color-red); font-weight:bold;">(${a})</span>`).attr("data-count",a)},delete:function(e){this.loading(),Array.isArray(e)?SBF.ajax({function:"delete-users",user_ids:e},()=>{for(var t=0;t<e.length;t++)delete $[e[t]],f.find(`[data-user-id="${e[t]}"]`).remove(),w.find(`[data-user-id="${e[t]}"]`).remove();0==f.find("[data-user-id]").length&&this.filter(b.find(".sb-active").data("type")),I("Users deleted"),this.updateMenu(),this.loading(!1)}):$[e].delete(()=>{var t=w.find(`[data-user-id="${e}"]`);E().id==e&&E(!1),t.sbActive()&&(SBChat.conversation=!1,setTimeout(()=>{P.clickFirst()},300)),delete $[e],f.find(`[data-user-id="${e}"]`).remove(),t.remove(),d.sbHideLightbox(),I("User deleted"),this.updateMenu(),this.loading(!1)})},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update()},1e4))},stopRealTime:function(){clearInterval(this.real_time)},loading:function(t=!0){var e=g.find(".sb-loading-table");t?e.sbActive(!0):e.sbActive(!1)},csv:function(){SBF.ajax({function:"csv-users"},t=>{var t=JSON.parse(t),e=atob(t.file),e=new Blob([e],{type:"data:application/octet-stream;base64"}),a=document.createElement("a");a.href=window.URL.createObjectURL(e),a.download=t.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a)})},updateUsersActivity:function(){SBF.updateUsersActivity(a?SB_ACTIVE_AGENT.id:-1,E()?E().id:-1,function(t){q.setActiveUserStatus("online"==t)})},setActiveAgentStatus:function(t=!0){var e=t?"online":"offline";a=t,u.find('[data-value="status"]').html(D(SBF.slugToString(e))).attr("class","sb-"+e),SBPusher.active&&(t?SBPusher.presence():SBPusher.presenceUnsubscribe()),SB_ADMIN_SETTINGS.reports_disabled||SBF.ajax({function:"reports-update",name:e})},setActiveUserStatus:function(t=!0){var e=S.find(".sb-conversation .sb-top > .sb-labels");e.find(".sb-status-online").remove(),t&&e.prepend(`<span class="sb-status-online">${D("Online")}</span>`),SBChat.user_online=t},onlineUserNotification:function(t){var e,a,i=SB_ADMIN_SETTINGS["online-users-notification"];i&&(e=t.info.first_name+" "+t.info.last_name,a=this.userProfileImage(t.info.profile_image),SB_ADMIN_SETTINGS["push-notifications"]&&"id"in t.info&&!this.history.includes(t.info.id)?SBF.ajax({function:"push-notification",title:i,message:e,icon:a,interests:SB_ACTIVE_AGENT.id,user_id:t.info.id}):P.desktop_notifications&&SBChat.desktopNotification(i,e,a,!1,t.info.id),this.history.push(t.info.id))},userProfileImage:function(t){return!t||t.indexOf("user.svg")?SB_ADMIN_SETTINGS["notifications-icon"]:t}},P={real_time:null,datetime_last_conversation:"2000-01-01 00:00:00",user_typing:!1,desktop_notifications:!1,flash_notifications:!1,busy:!1,is_search:!1,menu_count_ajax:!1,chat_tops:[{}],open:function(t=-1,e){-1!=t&&this.openConversation(t,e),d.sbHideLightbox(),u.find(".sb-admin-nav a").sbActive(!1).parent().find("#sb-conversations").sbActive(!0),d.find(" > main > div").sbActive(!1),S.sbActive(!0).find(".sb-board").removeClass("sb-no-conversation"),this.startRealTime()},openConversation:function(e,t=!1,b=!0){if(!1===t&&e)SBF.ajax({function:"get-user-from-conversation",conversation_id:e},t=>{SBF.null(t.id)?SBF.error("Conversation not found","SBAdmin.openConversation"):this.openConversation(e,t.id,b)});else{let g=S.find(".sb-conversation .sb-list");var a=SBF.null($[t])||!("email"in $[t].details);let f=S.find(`[data-conversation-id="${e}"]`);g.html(""),g.sbLoading(!0),a?(E(new SBUser({id:t})),E().update(()=>{$[t]=E(),this.updateUserDetails()})):(E($[t]),this.updateCurrentURL()),SBPusher.active&&(SBPusher.event("client-typing",t=>{t.user_id==E().id&&(P.typing(!0),clearTimeout(s),s=setTimeout(()=>{P.typing(!1)},1e3))}),SBPusher.event("new-message",()=>{SBChat.update()}),SBPusher.event("agent-active-conversation-changed",t=>{t.previous_conversation_id==e&&S.find(".sb-conversation-busy").remove()},"agents"),SBPusher.event("init",t=>{P.updateCurrentURL(t.current_url)}),SBPusher.event("message-status-update",t=>{SBChat.conversation&&SBChat.conversation.updateMessagesStatus(t.message_ids)})),SB_ADMIN_SETTINGS["smart-reply"]&&Y.html(""),w.find("li").sbActive(!1),f.sbActive(!0),-1!=e?E().getFullConversation(e,e=>{let t=e.get("conversation_status_code");var a=W.eq(0),i=a.find(".sb-active").attr("data-value"),s=(SBChat.setConversation(e),SBChat.populate(),this.setReadIcon(t),S.find(".sb-conversation-busy").remove(),this.updateUserDetails(),e.get("profile_image")),n=e.get("first_name"),o=k(window).width();let r;r=o<555?18<n.length?n.slice(0,18)+"...":n:27<n.length?n.slice(0,27)+"...":n;n=E().getExtra("phone").value,s=`
    <span style="padding-right:5px;" class="open-profile-name">
        <img src="${s}" class="top-image-profile">
    </span> 
    <span style="margin: 0px 10px 0px 0px;">${r}</span>
    <span class="additional-info">${n?`<a alt="Call from your Phone" href="tel:${n}"><i class="styling-caller bi ${o<555?"bi-telephone-fill":"bi-skype"}"></i></a>`:""}</span>
`;S.find(".sb-top > a").html(s);let l=!1;if(S.find(".sb-top > a > span").on("click",function(){var t=k(this).next(".additional-info");l?t.hide():t.show(),l=!l}),S.find(".open-profile-name").on("click",function(){O.showEdit(E())}),k(".sb-list").prepend('<div class="load-more"><span id="load-more" ><i style="vertical-align:middle;font-size: var(--chat-text-size-1-0);" class="bi-arrow-up-circle"></i> </div>'),z.must_translate=SB_ADMIN_SETTINGS.translation&&E().language&&SB_ADMIN_SETTINGS["active-agent-language"]!=E().language,z.must_translate){var c=[];let i=[],s=[];for(var d=0;d<e.messages.length;d++){var u=e.messages[d];"bot"!=u.get("user_type")&&u.message&&(c.push(u.message),i.push(u.id),s.push(u.get("user_type")))}c.length&&U.dialogflow.translate(c,SB_ADMIN_SETTINGS["active-agent-language"],t=>{if(t)for(var e=0;e<t.length;e++){var a=SBChat.conversation.getMessage(i[e]);a&&(a.set("translation",t[e].translatedText),g.find(`[data-id="${i[e]}"]`).replaceWith(a.getCode(!0)),g.find(`[data-id="${i[e]}"] .sb-menu`).prepend(`<li data-value="original">${D(SBF.isAgent(s[e])?"View translation":"View original message")}</li>`))}})}var n=S.find("#conversation-department"),s=(n.length&&(o=n.find(`[data-id="${e.get("department")}"]`),n.find(" > p").attr("data-value",o.data("value")).html(o.html())),S.find("#conversation-agent")),o=(s.length&&(n=s.find(`[data-id="${e.get("agent_id")}"]`),s.find(" > p").attr("data-value",n.data("id")).html(n.html())),[1,2].includes(t)?t=0:t,i==t||6==i||k(H).find(".sb-search-btn").sbActive()||(a.find(`[data-value="${t}"]`).click(),a.find("ul").sbActive(!1)),L&&this.mobileOpenConversation(),f.length||i!=t&&(0!=i||1!=t&&6!=t)&&(6!=i||0!=t)||w.prepend(P.getListCode(e).replace("<li",'<li class="sb-active"')),f.sbActive(!0),b&&this.scrollTo(),e.get("busy"));if(o&&S.find(".sb-editor > .sb-agent-label").html(`<span data-agent="${o.id}" style="border-radius: 10px 10px 0px 0px;position: absolute;bottom: calc(100% - -1px);background: #006eff;color: #ffffff;padding: 4px 10px;font-size: var(--chat-text-size-9);left: 4px;right: 4px;text-align: center;"><b>${o.first_name} ${o.last_name}</b> ${D("was viewing the conversation.")} <i class="bi-check-all" style="vertical-align: middle;"></i></span>`),this.tags.update(e.details.tags),this.notes.update(e.details.notes),this.attachments(),SB_ADMIN_SETTINGS["smart-reply"]){let t=e.getLastUserMessage();Y.html(""),(t=t&&t.payload("sb-human-takeover")?e.getLastUserMessage(t.get("index")):t)&&(U.dialogflow.smart_reply_data=!1,U.dialogflow.smartReply(t.message))}for(d=e.messages.length-1;0<d;d--){var h=e.messages[d].get("payload");let t=!1;if(h&&"rich-messages"in h)for(var p in h["rich-messages"]){p=h["rich-messages"][p];if("rating"==p.type){S.find(".sb-profile-list > ul").append(`<li data-id="rating"><i class="sb-icon bi-${1==p.result.rating?"hand-thumbs-up-fill":"hand-thumbs-down-fill"}"></i><span>${D("User rating")}</span></li>`),t=!0;break}}if(t)break}E().getConversations(function(t){S.find(".sb-user-conversations").html(E().getConversationsCode(t))}),g.sbLoading(!1)}):(SBChat.clear(),w.find("li").sbActive(!1),g.sbLoading(!1)),a||this.updateUserDetails(),S.find(".sb-board").removeClass("sb-no-conversation"),q.updateUsersActivity(),this.startRealTime(),SBF.getURL("conversation")!=e&&mt("?conversation="+e)}},populate:function(t,e,a){this.openConversation(t,e,a)},populateList:function(t){let e="",a=(A=[],t);a=a.sort(function(t,e){return new Date(e.creation_time).getTime()-new Date(t.creation_time).getTime()});for(var i=0;i<a.length;i++)e+=this.getListCode(a[i]),A.push(a[i]);0===a.length&&(e=`<p class="sb-no-results">${D("No conversations found.")}</p>`),w.html(e),w.css({position:"relative",bottom:"15px"}),this.positionList(),this.updateMenu(),SBF.event("SBAdminConversationsLoaded",{conversations:t})},positionList(){var t=Array.from(document.querySelectorAll("ul.sorting-by-last-message li"));let s=0;t.sort((t,e)=>{t=parseInt(t.getAttribute("data-time"));return parseInt(e.getAttribute("data-time"))-t}),t.forEach((t,e)=>{var a=t.offsetHeight,i=t.getAttribute("data-conversation-id");this.chat_tops[0][i]=t.getAttribute("data-time"),t.style.cssText=`
      position: relative;
      width: -webkit-fill-available;
      width: -moz-available;
      order: ${e}; // Use flexbox order for positioning
    `,s+=a,t.parentNode.appendChild(t)});t=document.querySelector("ul.sorting-by-last-message");t.style.display="flex",t.style.flexDirection="column"},update:function(){var t;this.busy||0!=W.eq(0).find("p").attr("data-value")||(this.busy=!0,SBF.ajax({function:"get-new-conversations",datetime:this.datetime_last_conversation},n=>{if(this.busy=!1,n.length){let e="",a="";var o=SBChat.conversation?SBChat.conversation.id:-1;let i,s=!1;var r=[];this.datetime_last_conversation=n[0].creation_time;for(var l=0;l<n.length;l++)if(!r.includes(n[l].conversation_id)){var c=n[l],d=c.conversation_status_code,u=c.user_id,h=c.conversation_id,p=o==h;let t=this.getListCode(c,null);var g=w.find(`[data-conversation-id="${h}"]`),f=g.index(),b=g.length,v=SBF.null(n[l].payload)?{}:JSON.parse(n[l].payload),m=c.message;40<m.length&&(m=m.substring(0,40)+"...",c.message=m),p?(t=t.replace("<li",'<li class="sb-active"'),b?(c.message&&g.replaceWith(t),A[f].conversation_status_code=d,this.setReadIcon(d)):s=!0):b&&(A[f]=c,w.find(`[data-conversation-id="${h}"]`).remove()),u in $||($[u]=new SBUser({id:u,first_name:c.first_name,last_name:c.last_name,profile_image:c.profile_image,user_type:c.user_type})),p&&b||(2==d?(e+=t,A.unshift(c)):0!=d&&1!=d||(0==(i=w.find('[data-conversation-status="2"]').last()).length?e+=t:(A.splice(i.index()+1,0,c),a+=t)),u==E().id&&E().getConversations(function(t){S.find(".sb-user-conversations").html(E().getConversationsCode(t))}),SBF.event("SBAdminNewConversation",{conversation:c})),E()&&("event"in v&&"update-user"==v.event||$[u].type!=c.user_type)&&E().update(()=>{this.updateUserDetails(),$[E().id]=E()}),""==c.message&&""==c.attachments||P.newMsgTop(n[l],"add"),SBChat.tab_active||2!=c.conversation_status_code||SBF.isAgent(c.message_user_type)&&!("preview"in v)||SBF.null(c.message)&&SBF.null(c.attachments)&&!("preview"in v)||(this.desktop_notifications&&(m=[c.first_name+" "+c.last_name,q.userProfileImage(c.profile_image)],g=("preview"in v?v.preview:"notfimy").replace(/@s\.whatsapp\.net/g,"").replace(/\*(.*?)\*/g,"*$1*").replace(/_(.*?)_/g,"_$1_").replace(/~(.*?)~/g,"~$1~").replace(/```(.*?)```/g,"```\n$1\n```").replace(/`(.*?)`/g,"`$1`").replace(/(.*?)/g,"$1").replace(/\{agent_name\}/g,'<i class="bi-people-fill"></i>'),SBChat.desktopNotification(m[0],g,m[1],h,u)),this.flash_notifications&&SBChat.flashNotification(),SBChat.audio&&["a","c","ic","ag"].includes(SB_ADMIN_SETTINGS.sounds)&&SBChat.audio.play()),r.push(h)}e&&w.prepend(e),a&&k(a).insertAfter(i),s&&this.scrollTo(),this.positionList(),this.updateMenu()}}),(SB_ADMIN_SETTINGS["assign-conversation-to-agent"]||SB_ACTIVE_AGENT.department)&&(t=w.find(" > li").map(function(){return k(this).attr("data-conversation-id")}).get()).length&&SBF.ajax({function:"check-conversations-assignment",conversations_ids:t,agent_id:!!SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&SB_ACTIVE_AGENT.id,department:SB_ACTIVE_AGENT.department},t=>{if(t)for(var e=0;e<t.length;e++)w.find(`[data-conversation-id="${t[e]}"]`).remove()}))},updateMenu:function(){var e=w.find('[data-conversation-status="2"]').length,a=W.eq(0);const i=a.find(" > a").find(" > p span");if(100==e||this.menu_count_ajax){var a=a.find("li.sb-active").data("value");this.menu_count_ajax=!0,SBF.ajax({function:"count-conversations",status_code:0==a?2:a},t=>i.html(`(${t})`))}else{let t=document.getElementById("floatingElement");t||((t=document.createElement("div")).id="floatingElement",t.style.cssText="position: relative; top: 10px; margin: auto; display: flex; justify-content: center; z-index: 33;",(a=document.createElement("small")).className="notif",a.style.cssText="font-size: medium; padding: 6px 10px; border-radius: 30px;",t.appendChild(a),document.getElementById("sb-conversations").appendChild(t)),t.querySelector(".notif").textContent=e,t.style.visibility=0===e?"hidden":"visible"}},messageMenu:function(t){var e=`<li style="padding: 6px 15px; line-height:20px" data-value="read-text"> <i class="bi-volume-up-fill"></i> ${D("Leer")}</li>`;return`
				<i class="sb-menu-btn bi-three-dots"></i>
				<ul style="right: 0rem;padding: .4rem;" class="message-menu sb-menu">
					${d&&!SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS["allow-agent-delete-message"]||SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS["allow-supervisor-delete-message"]?`<li style="padding: 6px 15px; line-height:20px" data-value="delete"><i class="bi-trash"></i> ${D("Delete")}</li><hr>`:""}
					${e}
				</ul>`},updateUserDetails(){var t,e;E()&&(t=k(".sb-top > a"),e=15<(e=E().name).length?e.slice(0,15)+"...":e,t.find("span").eq(1).html(e),S.find(".sb-user-details .sb-profile").setProfile(),O.populate(E(),S.find(".sb-profile-list")))},setReadIcon(t){var e=2==t;S.find('.sb-top [data-value="read"],.sb-top [data-value="unread"]').sbActive([0,1,2].includes(parseInt(t))).attr("data-value",e?"read":"unread").attr("data-sb-tooltip",D(e?"Mark as read":"Mark as unread")).parent().sbInitTooltips().find("i").attr("class",e?"bi-check-lg":"bi-check-all")},getListCode:function(t,e){var a;t instanceof SBConversation&&(a=t.getLastMessage(),t={...t,...a});let i=t.message;40<(i=i.replace(/- /g," ").replace(/[\[\]"\,}]/g,"").replace(/[{,+0-9]+@s\.whatsapp\.net/g,"").replace(/\{agent_name\}/g,'<i class="bi-people-fill"></i>').replace(/\[buttons\s+options="([^"]+)"\s+message="([^"]+)"\]/g,'<i class="bi-file-text" data-options="$1" data-message="$2"></i>').replace(/\[card[^\]]*\]/g,'<i class="bi-file-text"></i>').replace(//g,"").replace(//g,"  ").replace(/(\*[^*]+\*)/g,function(t){return`<strong>${t.slice(1,-1)}</strong>`}).replace(/(_[^_]+_)/g,function(t){return`<em>${t.slice(1,-1)}</em>`}).replace(/(`[^`]+`)/g,function(t){return`<code>${t.slice(1,-1)}</code>`}).replace(/~([^~]+)~/g,function(t){return`<del>${t.slice(1,-1)}</del>`}).replace(/(\*[^*]+\*)/g,function(t){return`<strong>${t.slice(1,-1)}</strong>`})).length&&(a=i.split(" "),i=a.slice(0,5).join(" ")+(5<a.length?"...":"")),!i&&t.attachments&&(s=(a=JSON.parse(t.attachments)).filter(t=>/\.(jpg|jpeg|png|webp|mp4)\b/g.test(t)),n=a.filter(t=>/\.(docx?|xlsx?|pdf)\b/g.test(t)),a=a.filter(t=>/\.(mp3|ogg)\b/g.test(t)),s=0<s.length?`<i class="bi-box"></i> ${D("Media")}: `+(1<s.length?"+"+(s.length-1):s.length):"",n=0<n.length?`<i class="bi-file-text"></i> ${D("Doc")}: `+(1<n.length?"+"+(n.length-1):n.length):"",a=0<a.length?`<i class="bi-mic-fill vertical-align"></i> ${D("Voice")}: `+(1<a.length?"+"+(a.length-1):a.length):"",i=[s,n,a].filter(Boolean).join(" "));var s=(new SBMessage).strip(i).replace(/_/g," "),n=!SBF.null(t.title);return`
          <li data-user-id="${t.user_id}" data-conversation-id="${t.conversation_id}" data-time="${new Date(t.creation_time).getTime()}" data-conversation-status="${e}" ${t.conversation_source?`data-conversation-source="${t.conversation_source}"`:""}>
              <small class="source-conversation-icon">
                  <img id="conversation-source-icon" class="source-buttons" src="../media/apps/${t.conversation_source}.svg">
              </small>
              <div class="sb-profile client-status">
                  <img class="client-icon-status sb-icon tags-${t.label} bi-kanban-fill loading="lazy" src="${t.profile_image}">
                  <h3 class="sb-name${n?" sb-custom-name":""}">${n?t.title:t.first_name+" "+t.last_name}</h3>
                  <div class="sb-info-conversations" style="min-width: 60px;text-align:right;flex: auto;font-size: .75rem;letter-spacing: .3px;margin: -2px 0px;">
                      ${SBF.beautifyTime(t.creation_time)}
                  </div>
              </div>
              <div>
                  <a class="phone-number" style="color:inherit">${t.phone}</a>
              </div>
              <p class="message-received" style="max-width:calc(100% - 145px);">${s}</p>
              <div class="conversation-bar">
                  <div class="no-read-icon sb-hide" style="margin: 0px 1px;">
                      <svg width="20" height="20" viewBox="0 0 24.5 24.5" xmlns="http://www.w3.org/2000/svg" class="icon flat-color">
                          <circle cx="12" cy="12" r="10" class="check-circle"/>
                          <path d="M11 16a1 1 0 0 1-.71-.29l-3-3a1 1 0 1 1 1.42-1.42l2.29 2.3 4.29-4.3a1 1 0 0 1 1.42 1.42l-5 5A1 1 0 0 1 11 16Z" class="check-inside"/>
                      </svg>
                  </div>
              </div>
          </li>
      `},newMsgTop(t=!1,e){document.querySelectorAll("ul.sorting-by-last-message li");var a=k(".sb-scroll-area");t&&((A=this.getUniqueChat(A,"user_id")).slice().sort((t,e)=>new Date(e.creation_time).getTime()-new Date(t.creation_time).getTime()).forEach((t,e)=>{k(`.sorting-by-last-message li[data-conversation-id='${t.conversation_id}']`).attr("style",`
				  transition: all .5s ease;
          webkit-transition: all .5s ease;
				  width:-webkit-fill-available;width:-moz-available;
          
				`)}),0<a.scrollTop())&&"add"===e&&requestAnimationFrame(()=>this.newMsgTop(t,e))},getUniqueChat:function(t,a){let i=[];return t.filter(function(e){i.findIndex(t=>t[a]==e[a])<=-1&&i.push(e)}),i},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update(),this.updateCurrentURL()},1e4),SBChat.startRealTime())},stopRealTime:function(){clearInterval(this.real_time),SBChat.stopRealTime()},timeZoneList:function(){Intl.supportedValuesOf("timeZone");var t=document.querySelector("#zones"),e=Intl.DateTimeFormat().resolvedOptions().timeZone;if(Intl.supportedValuesOf){t.innerHTML+="";for(const i of Intl.supportedValuesOf("timeZone"))t.innerHTML+=`<option ${e==i?"selected":""}>${i}</option>`}else{var a=new Option("Your browser does not support Intl.supportedValuesOf().",null,!0,!0);a.disabled=!0,t.options.add(a)}},transcript:function(t,e=!1){if(!("email"!=e||E()&&E().get("email")))return!1;SBF.ajax({function:"transcript",conversation_id:t},t=>{"email"==e?SBChat.sendEmail(SB_ADMIN_SETTINGS["transcript-message"],[[t,t]],!0):window.open(t)})},typing:function(t){t?(SBChat.user_online||q.setActiveUserStatus(!0),this.user_typing||(S.find(".sb-conversation .sb-top > .sb-labels").append('<span class="sb-status-typing" style="font-size: var(--chat-text-size-7);">'+D("Typing")+"</span>"),this.user_typing=!0)):this.user_typing&&(S.find(".sb-conversation .sb-top .sb-status-typing").remove(),this.user_typing=!1)},scrollTo:function(){var t=w.find(".sb-active"),t=t.length?t[0].offsetTop:0;w.parent().scrollTop(t-(L?120:70))},search:function(t){t&&r(t,(t,e)=>{(ct=1)<t.length?SBF.ajax({function:"search-conversations",search:t},t=>{P.populateList(t),k(e).sbLoading(!1),this.scrollTo(),this.is_search=!0}):(t=P.filters(),lt=1,SBF.ajax({function:"get-conversations",status_code:t[0],tag:t[3]},t=>{P.populateList(t),k(e).sbLoading(!1),this.is_search=!1}))})},updateCurrentURL:function(t=!1){t?this.ucurl(t):SBChat.user_online&&E()&&E().getExtra("current_url")&&SBF.ajax({function:"current-url"},t=>{t&&this.ucurl(t)})},ucurl(t){var e=E().getExtra("current_url");t=t.replace("https://","").replace("http://","").replace("www.","").replace(/\/$/,""),S.find('.sb-profile-list [data-id="current_url"] label').attr("data-value",t).html(t),e&&(e.value=t,E().setExtra("current_url",e))},assignDepartment:function(t,e,a){SBF.ajax({function:"update-conversation-department",conversation_id:t,department:e,message:SBChat.conversation.getLastMessage().message},t=>{a(t)})},assignAgent:function(t,e,a=!1){SBF.ajax({function:"update-conversation-agent",conversation_id:t,agent_id:e,status_code:6,message:SBChat.conversation.getLastMessage().message},t=>{a&&a(t)})},setActiveDepartment:function(t){var e,a;SBChat.conversation&&SBChat.conversation.get("department")==t||(a=(e=S.find("#conversation-department")).find(`[data-id="${t}"]`),e.find(" > p").attr("data-value",a.data("value")).html(a.html()).next().sbActive(!1),SBChat.conversation.set("department",t),"agent"==SB_ACTIVE_AGENT.user_type&&SB_ACTIVE_AGENT.department&&SB_ACTIVE_AGENT.department!=t&&(w.find(`[data-conversation-id="${SBChat.conversation.id}"]`).remove(),P.clickFirst()),I("Department updated. The agents have been notified."))},setActiveAgent:function(t){var e=S.find("#conversation-agent"),a=e.find(`[data-id="${t}"]`);SBChat.conversation.set("agent_id",t),e.find(" > p").attr("data-value",a.data("value")).html(a.html()).next().sbActive(!1),"agent"!=SB_ACTIVE_AGENT.user_type||SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&!t||(w.find(`[data-conversation-id="${SBChat.conversation.id}"]`).remove(),P.clickFirst()),t&&I("Agent assigned. The agent has been notified.")},mobileOpenConversation:function(){S.find(".sb-admin-list").sbActive(!1),S.find(".sb-conversation").sbActive(!0),u.addClass("sb-hide")},mobileCloseConversation:function(){w.find("li.sb-active").sbActive(!1),S.find(".sb-admin-list").sbActive(!0),S.find(".sb-conversation").sbActive(!1),u.removeClass("sb-hide"),window.history.replaceState({},document.title,SBF.URL())},clickFirst:function(){w.find("li:first-child").length?(w.find("li:first-child").click(),P.scrollTo()):S.find(".sb-board").addClass("sb-no-conversation")},savedReplies:function(t,e){var a=e.charAt(t.selectionStart-1);if("/"==a&&(SBChat.editor_listening=!0),SBChat.editor_listening&&" "==a){var i=e.substr(e.lastIndexOf("/")+1).replace(" ","");SBChat.editor_listening=!1;for(var s=0;s<T.length;s++)if(T[s]["reply-name"]==i)return void k(t).val(e.substr(0,e.lastIndexOf("/"))+T[s]["reply-text"])}},attachments:function(){if(J.length){var e=SBChat.conversation.getAttachments();let t="";for(var a=0;a<e.length;a++){var i=e[a][0].slice(0,20);t+=`<a href="${e[a][1]}" class="bg-attachment" target="_blank"><i class="sb-icon bi-file-earmark-arrow-down"></i>${i+"..."} </a>`}k(J).html(""==t?"":`<h3>${D("Attachments")}</h3><div class="sb-list-items sb-list-links sb-list-icon">${t}</div>`),l(J,160)}},filters:function(){for(var t=[],e=0;e<W.length;e++)t.push(W.eq(e).find("li.sb-active").data("value"));return(t[1]||t[3])&&(t[0]="all"),t},notes:{busy:!1,add:function(t,e,a,i,s=!1){let n=k("#alertdate").val();var o,r=k("#zones").val();n=""!=n&&(SBF.getTimezoneOffset(r)==(new Date).getTimezoneOffset()?n:new Date(n).toUTCString()),-1<navigator.userAgent.indexOf("Firefox")&&((o=new Date(n)).setHours(o.getHours()-3),n=""!=n&&(SBF.getTimezoneOffset(r)==(new Date).getTimezoneOffset()?moment.utc(n).format():new Date(n).toUTCString())),SBF.ajax({function:"add-note",conversation_id:t,user_id:e,name:a,message:i,alert:n,time_zone:r,status:!n},t=>{s&&s(t),k("#alertdate").val("")})},update:function(e,a=!1){if(V.length){let t="";for(var i=V.find(" > div"),s=0;s<e.length;s++){var n=e[s];t+=`<div data-id="${n.id}"><span class="sb-note-title">${n.name} ${SB_ACTIVE_AGENT.id==n.user_id?'<i class="sb-delete-note bi-x-lg"></i>':""}</span>${n.alert||n.time_zone?`<small class="note-alert-text" style="margin: 0px 6px;">${n.alert?SBF.localTime(n.alert,n.time_zone):""}${null!=n.time_zone?" "+n.time_zone:""}</small>`:""}<span class="note-content">${n.message}</span></div>`}a?i.append(t):i.html(t),i.attr("style","display: flex; flex-direction: column-reverse;"),V.find(".bi-chevron-down").remove(),l(V,155),this.busy=!1}},delete:function(t,e,a=!1){this.busy||(this.busy=!0,SBF.ajax({function:"delete-note",conversation_id:t,note_id:e},t=>{this.busy=!1,a&&a(t)}))},readmore:function(t,e){return t.length<=e?(k(".dots").hide(),t):t.slice(0,e)+`<span class="more" style="display:none">${t.slice(e,t.length)}</span><span class="dots">...</span>`}},tags:{busy:!1,list:!1,update:function(e){if(X.length){let t="";for(var a=X.find(" > div"),i=0;i<e.length;i++)t+=`<span>${e[i]}</span>`;a.html(t),this.busy=!1}},getAll:function(t=[]){let e="";for(var a=0;a<this.list.length;a++)t.includes(this.list[a])||(e+=`<span>${this.list[a]}</span>`);return e}},showDirectMessageBox:function(t,e=[]){var a="email"==t;SBForm.clear(h),h.find(".sb-direct-message-users").val(e.length?e.join(","):""),h.find(".sb-bottom > div").html(""),h.find(".sb-top-bar > div:first-child").html(D("Broadcast "+("sms"==t?"text message":t))),h.find(".sb-loading").sbLoading(!1),h.find(".sb-direct-message-subject").sbActive(a).find("input").attr("required",a),h.attr("data-type",t),"email"!==t&&"sms"!==t?(h.find(".sb-selector").removeClass("sb-hide"),(new Metatemplate).init("#user-template-form"),"template"===h.find(".sb-select").val()&&h.find(".sb-select").val(null)):(h.find(".sb-selector").addClass("sb-hide"),k(".sb-bulk-sender").addClass("sb-hide"),k(".sb-direct-message-hide").removeClass("sb-hide")),h.find(".sb-select").on("change",function(){k(this).find(".active-bulk-sender").is(":selected")?(k(".sb-bulk-sender").removeClass("sb-hide"),k(".sb-direct-message-hide").addClass("sb-hide")):(h.find(".sb-selector").addClass("sb-hide"),k(".sb-bulk-sender").addClass("sb-hide"),k(".sb-direct-message-hide").removeClass("sb-hide"))}),h.sbShowLightbox()}},O={getAll:function(t){return SBForm.getAll(t)},get:function(t){return SBForm.get(t)},set:function(t,e){return SBForm.set(t,e)},getUserExtra:function(e){SBF.ajax({function:"get-user-extra",user_id:e},t=>{this.getUserExtra(e,response)})},show:function(a){R(),E(new SBUser({id:a})),E().update(()=>{this.populate(E(),v.find(".sb-profile-list")),v.find(".sb-profile").setProfile(),E().getConversations(t=>{var e=E().type;SBF.isAgent(e)&&this.agentData(),v.find(".sb-user-conversations").html(E().getConversationsCode(t)),v.find(".sb-top-bar [data-value]").sbActive(!1),SBF.null(E().get("email"))||v.find(".sb-top-bar [data-value=email]").sbActive(!0),E().getExtra("phone")&&SB_ADMIN_SETTINGS.sms&&v.find(".sb-top-bar [data-value=sms]").sbActive(!0),this.boxClasses(v,e),v.attr("data-user-id",E().id).sbShowLightbox(),R(!1,!1),SBF.event("SBProfileBoxOpened",{user_id:a})}),$[a]=E(),SBF.getURL("user")!=a&&mt("?user="+a)})},showEdit:function(e){if(!(e instanceof SBUser))return SBF.error("User not of type SBUser","SBUsers.showEdit"),!1;{var a=m.find("#password input"),i=e.type,s=m.find("#user_type select");m.removeClass("sb-user-new").attr("data-user-id",e.id),m.find(".sb-top-bar .sb-save").html('<i class="bi-check-lg"></i>'+D("Save changes")),m.find(".sb-profile").setProfile(),m.find(".sb-custom-detail").remove(),m.find("input,select,textara").removeClass("sb-error");let t="";var n,o=m.find(".sb-additional-details [id]").map(function(){return this.id}).get().concat(["facebook-id","ip","os","current_url","country_code","browser_language","browser"]);for(n in e.extra)o.includes(n)||(t+=`<div id="${n}" data-type="text" class="sb-input sb-custom-detail"><span>${D(e.extra[n].name)}</span><input type="text"></div>`);m.find(".sb-additional-details .sb-edit-box").append(t),this.populateEdit(e,m),this.updateRequiredFields(i),"admin"==SB_ACTIVE_AGENT.user_type&&SBF.isAgent(i)&&s.html(`<option value="agent">${D("Agent")}</option><option value="admin"${"admin"==i?" selected":""}>${D("Admin")}</option>`),a.val()&&a.val("********"),this.boxClasses(m,i),m.sbShowLightbox(),SBF.event("SBProfileEditBoxOpened",{user_id:e.id})}},populate:function(i,s){var t,e,a=["first_name","last_name","password","profile_image"];let n="";for(o in s.hasClass("sb-profile-list")&&SBChat.conversation&&(t=SBChat.conversation.get("source"),e=SBChat.conversation.get("label"),n=this.profileRow("conversation-id",SBChat.conversation.id,D("Conversation ID")),SBF.null(e)?n+=this.profileRow("conversation-label","Unknown",D("Label")):n+=this.profileRow("conversation-label",e,D("Client status")),SBF.null(t)?n+=this.profileRow("conversation-source","Unknown"):n+=this.profileRow("conversation-source",{fb:"Facebook",ww:"Whatsmeow",wx:"waweb",wa:"WhatsApp",tm:"Text message",ig:"Instagram",tg:"Telegram",tk:"Tickets",wc:"WeChat",em:"Email",tw:"Twitter",bm:"Google"}[t]||t,D("Source"))),"admin"!=SB_ACTIVE_AGENT.user_type&&a.push("token"),i.details)a.includes(o)||(n+=this.profileRow(o,i.get(o)));if(i.isExtraEmpty())SBF.ajax({function:"get-user-extra",user_id:i.id},t=>{for(var e=1;e<t.length;e++){var a=t[e].slug;i.setExtra(a,t[e]),n+=this.profileRow(a,t[e].value,t[e].name)}s.html(`<ul>${n}</ul>`),l(s,56)});else{for(var o in i.extra){var r=i.getExtra(o);n+=this.profileRow(o,r.value,r.name)}s.html(`<h3 class="sb-user-details-info">${D("User information")}</h3><ul>${n}</ul>`),l(s,56)}k("#change-conversation-source").change(function(t){const e=t.target.value;t=`${STMBX_URL}/media/apps/${e}.svg`,k("#conversation-source-icon").attr("src",t),SBF.ajax({function:"update-conversation-source",conversation_id:SBChat.conversation.id,source:e},t=>{I("Required reload"),SBChat.update(),k("#change-conversation-source").val(e)}),t="sb-icon bi-"+e;k('.sb-profile-list [data-id="conversation-source"] i').attr("class",t)}),k("#change-conversation-labels").change(function(t){var e,a;"Unknown"!==t.target.value&&(e=t.target.options[t.target.selectedIndex].text,a="sb-icon bi-kanban-fill tags-"+t.target.value,k('.sb-profile-list [data-id="conversation-label"] i').attr("class",a),k(`[data-user-id="${E().id}"] .bi-kanban-fill`).attr("class",a),k(`[data-user-id="${E().id}"] #label-name`).text(e)),O.updateLabel(t.target.value)}),k("#CstBtn a").click(function(t){var e=k(this).attr("id"),a=D(SBF.admin_set("label-names")[e]+" "),i="sb-icon bi-kanban-fill tags-"+e;k('.sb-profile-list [data-id="conversation-label"] i').attr("class",i),k(`[data-user-id="${E().id}"] .bi-kanban-fill`).attr("class",i),k(`[data-user-id="${E().id}"] #label-name`).text(a),O.updateLabelUI(e,a,i),O.updateLabel(e)})},updateLabelUI:function(t,e,a){k(`[data-user-id="${E().id}"] .bi-kanban-fill`).attr("class",a),k(`[data-user-id="${E().id}"] #label-name`).text(e)},getLabel:function(t){SBF.ajax({function:"get-clientStatus-conversations",conversation_id:SBChat.conversation.id,label:t},t=>{"status-client"==G.active_report&&G.initReport("status-client")})},updateLabel:function(t){SBF.ajax({function:"update-clientStatus-conversations",conversation_id:SBChat.conversation.id,label:t},t=>{"status-client"==G.active_report&&G.initReport("status-client")})},profileRow:function(t,a,e=t){if(""==a)return"";var i={id:"person-vcard","conversation-label":"tag","conversation-source":"tickets","conversation-id":"person-vcard",full_name:"person-bounding-box",email:"envelope",phone:"phone",user_type:"person-bounding-box",last_activity:"calendar",creation_time:"calendar",token:"shuffle",currency:"currency-exchange",location:"pin-map",country:"flag",address:"app",city:"app",postal_code:"app",os:"person-workspace",current_url:"radar",timezone:"clock"};let s=`<i class="sb-icon bi-${t in i?i[t]:"app"}"></i>`,n,o=!1;switch(t){case"last_activity":case"creation_time":a=SBF.beautifyTime(a);break;case"user_type":a=SBF.slugToString(a);break;case"country_code":case"language":case"browser_language":s=`<img src="${STMBX_URL}/media/flags/${a.toLowerCase()}.png" />`;break;case"browser":(n=a.toLowerCase()).includes("chrome")?o="chrome":n.includes("edge")?o="edge":n.includes("firefox")?o="firefox":n.includes("opera")?o="opera":n.includes("safari")&&(o="safari");break;case"os":(n=a.toLowerCase()).includes("windows")?o="windows":n.includes("mac")||n.includes("apple")||n.includes("ipad")||n.includes("iphone")?o="apple":n.includes("android")?o="android":n.includes("linux")?o="linux":n.includes("ubuntu")&&(o="ubuntu");break;case"conversation-source":case"browser":case"os":case"conversation-source":o=a.toLowerCase(),a=`<select disabled style="background: transparent;border-color: transparent;" id="change-conversation-source">
                                <option  value="tk" ${"Tickets"==a?"selected":""} value>Live Chat</option>
                                <option value="ww" ${"Whatsmeow"==a?"selected":""} value>WhatsApp QR</option>
                                <option value="wx" ${"waweb"==a?"selected":""} value>WhatsApp Web</option>                                
                                <option value="wa" ${"WhatsApp"==a?"selected":""} value>WhatsApp API</option>
                                <option   hidden value="tg" ${"Telegram"==a?"selected":""} value>Telegram</option>
                                <option  hidden value="bm" ${"Google"==a?"selected":""} value>Google</option>
                                <option  hidden value="tm" ${"Text message"==a?"selected":""} value>Text message</option>
                                <option hidden value="un" ${"Unknown"==a?"selected":""} value>Facebook</option>                                
                                <option hidden value="ig" ${"Instagram"==a?"selected":""} value>Instagram</option>
                                <option hidden value="wc" ${"WeChat"==a?"selected":""} value>WeChat</option>
                                <option hidden value="em" ${"Email"==a?"selected":""} value>Email</option>
                                <option  hidden value="tw" ${"Twitter"==a?"selected":""} value>Twitter</option>
                             </select>`,o&&"Unknown"!==a&&(s=`<img src="${STMBX_URL}/media/${"conversation-source"==t?"apps":"devices"}/${o}.svg" />`);break;case"conversation-label":var r=a,l=c;let e="";Array.isArray(l)&&l.forEach(function(t){e+=`<option value="${t}" ${a===t?"selected":""}>${D(SBF.get_value(t)+" ")}</option>`});l=`class="sb-icon bi-kanban-fill tags-${r}"`;a=`<select style="background: transparent; border-color: transparent;" id="change-conversation-labels">
								<option value='unknown'>${D("Client status")}</option> ${e} </select>`,s=`<i ${l}></i>`}return`<li data-id="${t}">${s}<span>${D(SBF.slugToString(e))}</span><label style="overflow-wrap: break-word">${a}</label></li>`},populateEdit:function(i,t){t.find(".sb-details .sb-input").each((t,e)=>{this.set(e,i.details[k(e).attr("id")])}),t.find(".sb-additional-details .sb-input").each((t,e)=>{var a=k(e).attr("id");a in i.extra?this.set(e,i.extra[a].value):this.set(e,"")})},clear:function(t){SBForm.clear(t)},errors:function(t){return SBForm.errors(t.find(".sb-details"))},showErrorMessage:function(t,e){SBForm.showErrorMessage(t,e)},agentData:function(){let s=`<div class="sb-title">${D("Feedback rating")}</div><div class="sb-rating-area sb-loading"></div>`,n=v.find(".sb-agent-area");n.html(s),SBF.ajax({function:"get-rating"},t=>{var e,a,i;s=0==t[0]&&0==t[1]?`<p class="sb-no-results">${D("No ratings yet.")}</p>`:(e=t[0]+t[1],a=100*t[0]/e,i=100*t[1]/e,`<div><div>${D("Helpful")}</div><span data-count="${t[0]}" style="width: ${Math.round(2*a)}px"></span><div>${a.toFixed(2)} %</div></div><div><div>${D("Not helpful")}</div><span data-count="${t[1]}" style="width: ${Math.round(2*i)}px"></span><div>${i.toFixed(2)} %</div></div><p class="sb-rating-count">${e} ${D("Ratings")}</p>`),n.find(".sb-rating-area").html(s).sbLoading(!1)})},boxClasses:function(t,e=!1){k(t).removeClass("sb-type-admin sb-type-agent sb-type-lead sb-type-user sb-type-visitor").addClass(`${0!=e?"sb-type-"+e:""} sb-agent-`+SB_ACTIVE_AGENT.user_type)},updateRequiredFields:function(t){var e=SBF.isAgent(t);m.find("#password input").prop("required",e),m.find("#email input").prop(e||"user"==t||"lead"==t)}},z={dialog:M,open_popup:!1,must_translate:!1,is_logout:!1,conversations:P,users:q,settings:j,profile:O,apps:U};function xt(){SBF.ajax({function:"get-conversations"},t=>{0==t.length&&S.find(".sb-board").addClass("sb-no-conversation"),P.populateList(t),L&&S.find(".sb-admin-list").sbActive(!0),SBF.getURL("conversation")?(S.sbActive()||u.find(".sb-admin-nav #sb-conversations").click(),P.openConversation(SBF.getURL("conversation"))):L||SBF.getURL("user")||SBF.getURL("setting")||SBF.getURL("report")||SBF.getURL("area")&&"conversations"!=SBF.getURL("area")||P.clickFirst(),P.startRealTime(),P.datetime_last_conversation=SB_ADMIN_SETTINGS["now-db"],R(!1)}),SBPusher.initServiceWorker(),SB_ADMIN_SETTINGS["push-notifications"]&&SBPusher.initPushNotifications()}window.SBAdmin=z,k(document).ready(function(){if(d=k(".sb-admin"),u=d.find("> .sb-header"),S=d.find(".sb-area-conversations"),H=S.find(".sb-admin-list"),w=H.find(".sb-scroll-area ul"),W=H.find(".sb-select"),g=d.find(".sb-area-users"),f=g.find(".sb-table-users"),b=g.find(".sb-menu-users"),v=d.find(".sb-profile-box"),m=d.find(".sb-profile-edit-box"),_=d.find(".sb-area-settings"),y=_.find(".sb-automations-area"),tt=y.find(".sb-conditions"),K=y.find(" > .sb-select"),B=y.find(" > .sb-tab > .sb-nav > ul"),C=d.find(".sb-area-reports"),x=_.find(".sb-articles-area"),Z=x.find(".sb-article-categories select"),Q=x.find(".sb-article-parent-category select"),ot=S.find(".sb-replies"),rt=S.find(".sb-status-chat"),nt=d.find(".sb-lightbox-overlay"),typeof STMBX_URL!=bt&&STMBX_URL.substr(0,STMBX_URL.indexOf("-content")-3),V=S.find(".sb-panel-notes"),X=S.find(".sb-panel-tags"),J=S.find(".sb-panel-attachments"),h=d.find(".sb-direct-message-box"),p=d.find(".sb-dialogflow-intent-box"),Y=S.find(".sb-editor > .sb-suggestions"),window.onpopstate=function(){d.sbHideLightbox(),L&&S.sbActive()&&S.find(".sb-conversation").sbActive()&&P.mobileCloseConversation(),SBF.getURL("user")?(g.sbActive()||u.find(".sb-admin-nav #sb-users").click(),O.show(SBF.getURL("user"))):SBF.getURL("area")?u.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click():SBF.getURL("conversation")?(S.sbActive()||u.find(".sb-admin-nav #sb-conversations").click(),P.openConversation(SBF.getURL("conversation"))):SBF.getURL("setting")?(_.sbActive()||u.find(".sb-admin-nav #sb-settings").click(),_.find("#tab-"+SBF.getURL("setting")).click()):SBF.getURL("report")&&(C.sbActive()||u.find(".sb-admin-nav #sb-reports").click(),C.find("#"+SBF.getURL("report")).click())},SBF.getURL("area")&&setTimeout(()=>{u.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click()},300),typeof SB_ADMIN_SETTINGS==bt){let i=d.find(".sb-intall");void k(d).on("click",".sb-submit-installation",function(){if(!N(this)){let a=!1;var t=i.find("#first-name").length;if(SBForm.errors(i))a=t?"All fields are required. Minimum password length is 8 characters. Be sure you have entered a valid email.":"All fields are required.";else if(t&&i.find("#password input").val()!=i.find("#password-check input").val())a="The passwords do not match.";else{let e=window.location.href.replace("/admin","").replace(".php","").replace(/#$|\/$/,"");e.includes("?")&&(e=e.substr(0,e.indexOf("?"))),k.ajax({method:"POST",url:e+"/include/ajax.php",data:{function:"installation",details:k.extend(SBForm.getAll(i),{url:e})}}).done(t=>{if(0!=(t=JSON.parse(t))){if(!0===(t=t[1]))return void setTimeout(()=>{window.location.href=e+"?refresh=true"},1e3);switch(t){case"connection-error":a="Routin.bot cannot connect to the database. Please check the database information and try again.";break;case"missing-details":a="Missing database details! Please check the database information and try again.";break;case"missing-url":a="We cannot get the plugin URL.";break;default:a=t}}else a=t;!1!==a&&(SBForm.showErrorMessage(i,a),k("html, body").animate({scrollTop:0},500)),k(this).sbLoading(!1)})}!1!==a&&(SBForm.showErrorMessage(i,a),k("html, body").animate({scrollTop:0},500),k(this).sbLoading(!1))}})}else if(d.length&&(R(),d.removeAttr("style"),(window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||document.referrer.includes("android-app://"))&&d.addClass("sb-pwa"),ht&&typeof caches!==bt&&caches.delete("sb-pwa-cache"),!d.find(" > .sb-rich-login").length)){SB_ADMIN_SETTINGS.pusher?(SBPusher.active=!0,SBPusher.init(()=>{SBPusher.presence(1,()=>{q.updateUsersActivity()}),SBPusher.event("update-conversations",()=>{P.update(),SBChat.update()},"agents"),SBPusher.event("set-agent-status",t=>{t.agent_id==SB_ACTIVE_AGENT.id&&q.setActiveAgentStatus("online"==t.status)},"agents"),xt()})):(xt(),setInterval(function(){q.updateUsersActivity()},1e4)),q.table_extra=f.find("th[data-extra]").map(function(){return k(this).attr("data-field")}).get(),k(window).on("beforeunload",function(){E()&&SBF.ajax({function:"on-close"})}),k(window).keydown(function(t){var e=t.which;let a=!1;if([13,27,46].includes(e)){if(d.find(".sb-dialog-box").sbActive()){var i=d.find(".sb-dialog-box");switch(e){case 46:case 27:i.find(".sb-cancel").click();break;case 32:case 13:i.find("info"!=i.attr("data-type")?".sb-confirm":".sb-close").click()}a=!0}else if([46].includes(e)&&S.sbActive()){if(S.find(".sb-editor textarea").is(":focus"))return;var s=S.find(" > div > .sb-conversation");s.find('.sb-top [data-value="'+(3==s.attr("data-conversation-status")?"delete":"archive")+'"]').click(),a=!0}else[46,27].includes(e)&&(d.find(".sb-lightbox").sbActive()?(d.sbHideLightbox(),a=!0):(s=d.find(".sb-search-btn.sb-active")).length&&(s.find("i").click(),a=!0));a&&t.preventDefault()}}),k(document).on("click keydown mousemove",function(){SBF.debounce(function(){SBChat.tab_active||SBF.visibilityChange(),SBChat.tab_active=!0,clearTimeout(ft),ft=setTimeout(()=>{SBChat.tab_active=!1},1e4)},"#3",8e3)});var n=0;document.onpaste=function(t){var e,a,i,s,t=t.clipboardData.items[0];0===t.type.indexOf("image")&&((e=new FileReader).onload=function(t){},a=new FormData,i=`screenshot-${n++}.png`,s=t.getAsFile(),a.append("fname",i),a.append("file",s),jQuery.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:a,type:"POST",success:function(t){SBF.uploadResponse(t)}}),e.readAsDataURL(t.getAsFile()))},k(document).ready(function(){k(u).on("click",".help-center",function(){d.find(".sb-updates-box").sbShowLightbox()})}),typeof Notification===bt||"all"!=SB_ADMIN_SETTINGS["desktop-notifications"]&&"agents"!=SB_ADMIN_SETTINGS["desktop-notifications"]||SB_ADMIN_SETTINGS["push-notifications"]||(P.desktop_notifications=!0),"all"!=SB_ADMIN_SETTINGS["flash-notifications"]&&"agents"!=SB_ADMIN_SETTINGS["flash-notifications"]||(P.flash_notifications=!0),pt.getDate()!=SBF.storage("admin-clean")&&setTimeout(function(){SBF.ajax({function:"cron-jobs"}),SBF.storage("admin-clean",pt.getDate())},1e4),k(d).on("click",".bi-chevron-down",function(){var t=k(this).sbActive(),e=t?k(this).parent().data("height")+"px":"";k(this).html(D(t?"View more":"Close")),k(this).parent().find("> div, > ul").css({height:e,"max-height":e}),k(this).sbActive(!t)}),k(d).on("click",".sb-popup-close",function(){d.sbHideLightbox()}),d&&(k(document).on("click",function(t){k(t.target).closest(".sb-menu-mobile").length||(k(".sb-menu-mobile > i").removeClass("sb-active"),k(".open-profile").removeClass("sb-hide"))}),k(d).on("click",".sb-menu-mobile > i",function(){k(this).toggleClass("sb-active"),z.open_popup=k(this).parent()}),k(d).on("click",".sb-menu-mobile a",function(){k(this).closest(".sb-menu-mobile").find(" > i").sbActive(!1)}),k(d).on("click",".sb-menu-wide,.sb-nav",function(){k(this).toggleClass("sb-active")}),k(d).on("click",".sb-menu-wide > ul > li, .sb-nav > ul > li",function(t){var e=k(this).parent().parent();return e.find("li").sbActive(!1),e.find("> div:not(.sb-menu-wide):not(.sb-btn)").html(k(this).html()),e.sbActive(!1),e.find("> .sb-menu-wide").length&&e.closest(".sb-scroll-area").scrollTop(e.next()[0].offsetTop-(d.hasClass("sb-header-hidden")?70:130)),t.preventDefault(),!1}),k(d).find(".sb-admin-list .sb-scroll-area, main > div > .sb-scroll-area,.sb-area-settings > .sb-tab > .sb-scroll-area,.sb-area-reports > .sb-tab > .sb-scroll-area").on("scroll",function(){var t=k(this).scrollTop();F.last<t-10&&F.header?(d.addClass("sb-header-hidden"),F.header=!1):t+10<F.last&&!F.header&&!F.always_hidden&&(d.removeClass("sb-header-hidden"),F.header=!0),F.last=t}),k(d).on("click",".sb-search-btn i, .sb-filter-btn i",function(){k(this).parent().sbActive()?(k(".sb-top").css("top","+=0px"),k(this).parent().hasClass("sb-filter-btn")&&k(".sb-search-btn, .inbox, .non-hover").addClass("sb-hide"),k(this).hasClass("bi-search")?k(this).removeClass("bi-search").addClass("bi-x-lg"):k(this).hasClass("bi-x-lg")?k(this).removeClass("bi-x-lg").addClass("bi-filter"):k(this).hasClass("bi-filter")&&k(this).removeClass("bi-filter").addClass("bi-filter-circle")):(F.always_hidden=!1,w.parent().scrollTop()<10&&(d.removeClass("sb-header-hidden"),k(this).parent().hasClass("sb-filter-btn")&&k(".sb-search-btn, .inbox, .non-hover").removeClass("sb-hide"),k(this).hasClass("bi-filter-circle")?k(this).removeClass("bi-filter-circle").addClass("bi-filter"):k(this).hasClass("bi-filter")?k(this).removeClass("bi-filter").addClass("bi-x-lg"):k(this).hasClass("bi-x-lg")&&k(this).removeClass("bi-x-lg").addClass("bi-search")))}),k(d).on("click","#open-modal-button",function(){console.log("open",d.find(".sb-send-template-box")),d.find(".sb-send-template-box").sbShowLightbox()}),k(d).on("click","#meta-broadcast-button",function(){console.log("open"),d.find(".meta-broadcast-box").sbShowLightbox()}),k(d).on("click",".sb-top .sb-btn-back",function(){P.mobileCloseConversation()}),k(window).width()<555&&k(f).find("th:first-child").html(D("Order by")),k(f).on("click","th:first-child",function(){k(this).parent().toggleClass("sb-active")})),k(S).on("click","> .sb-btn-collapse, .collapse",function(){k(this).toggleClass("sb-active"),S.find(k(this).hasClass("sb-left")?".sb-admin-list":".sb-top").toggleClass("sb-active")}),k(S).on("click",".sb-conversation",function(){k(".sb-admin-list, .sb-btn-collapse.sb-left.bi-arrow-left-short.sb-active").removeClass("sb-active")}),k(S).on("click",".sb-list, .sb-editor",function(){k(".sb-admin-list, .sb-btn-collapse.sb-left.bi-arrow-left-short.sb-active").removeClass("sb-active"),k(".sb-user-details.sb-top.sb-active, .sb-top.sb-active").removeClass("sb-active")}),k(u).on("click"," .sb-admin-nav a",function(){var t=k(this).attr("id");switch(u.find(".sb-admin-nav a").sbActive(!1),d.find(" > main > div").sbActive(!1),d.find("."+k(this).attr("id").replace("sb-","sb-area-")).sbActive(!0),k(this).sbActive(!0),SBF.deactivateAll(),t){case"sb-conversations":L||SBF.getURL("conversation")||P.clickFirst(),P.update(),P.startRealTime(),q.stopRealTime();break;case"sb-users":q.startRealTime(),P.stopRealTime(),q.init||(R(),ut=dt=1,SBF.ajax({function:"get-users",user_types:["user","visitor","lead"],extra:q.table_extra},t=>{q.populate(t),q.updateMenu(),q.init=!0,q.datetime_last_user=SBF.dateDB("now"),R(!1)}));break;case"sb-settings":j.init||(R(),SBF.ajax({function:"get-all-settings"},t=>{if(t){var e,a=t["external-settings-translations"];for(e in j.initHTML(t),j.translations.translations=Array.isArray(a)&&!a.length?{}:a,delete t["external-settings-translations"],t)j.set(e,t[e])}j.initPlugins(),R(!(j.init=!0))})),q.stopRealTime(),P.stopRealTime();break;case"sb-reports":C.sbLoading()&&k.getScript(STMBX_URL+"/vendor/moment.min.js",()=>{k.getScript(STMBX_URL+"/vendor/daterangepicker.min.js",()=>{k.getScript(STMBX_URL+"/vendor/chart.min.js",()=>{G.initDatePicker(),G.initReport("conversations"),C.sbLoading(!1)})})}),q.stopRealTime(),P.stopRealTime()}var t=t.substr(3),e=SBF.getURL("area");"reports"==t&&k("#"+G.active_report).click(),e!=t&&("conversations"==t&&!SBF.getURL("conversation")||"users"==t&&!SBF.getURL("user")||"settings"==t&&!SBF.getURL("setting")||"reports"==t&&!SBF.getURL("report"))&&mt("?area="+t)}),k(u).on("click",".sb-profile",function(){k(this).next().toggleClass("sb-active")}),k(u).on("click",'[data-value="logout"],.logout',function(){z.is_logout=!0,SBF.ajax({function:"on-close"}),q.stopRealTime(),P.stopRealTime(),SBF.logout()}),k(u).on("click",'[data-value="edit-profile"],.edit-profile',function(){R();let t=new SBUser({id:SB_ACTIVE_AGENT.id});t.update(()=>{E(t),S.find(".sb-board").addClass("sb-no-conversation"),w.find(".sb-active").sbActive(!1),O.showEdit(t)})}),k(u).on("click",'[data-value="status"]',function(){q.setActiveAgentStatus(!k(this).hasClass("sb-online"))}),k(u).find(".sb-account").setProfile(SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image),k(w).on("click","li",function(){(new SBMessage).setLoad(30),P.openConversation(k(this).attr("data-conversation-id"),k(this).attr("data-user-id"),!1),SBF.deactivateAll()}),k(d).on("click",".sb-user-conversations li",function(){P.openConversation(k(this).attr("data-conversation-id"),E().id,k(this).attr("data-conversation-status"))}),k(S).on("click",".sb-top ul a",function(){let e=-1,t="The conversation will be ",a=k(this).attr("data-value");document.querySelectorAll("ul.sorting-by-last-message li");let i=SBChat.conversation.id;switch(a){case"inbox":e=0,t+="restored.";break;case"archive":t+="archived.",e=3;break;case"follow-up":t+="assigned for follow-up.",e=6;break;case"delete":t+="moved to the Bot container. Bot flow restarted.",e=4;break;case"empty-trash":e=5,t="The bot will permanently delete all conversations in the container, including their messages.";break;case"transcript":P.transcript(i,k(this).attr("data-action"));break;case"read":e=0,t+="marked as read.";break;case"unread":e=2,t+="marked as unread."}-1!=e&&M(t,"alert",function(){SBF.ajax({function:"update-conversation-status",conversation_id:i,status_code:e},()=>{if([0,3,4,6].includes(e))for(var t=0;t<A.length;t++)if(A[t].conversation_id==i){A[t].conversation_status_code=e;break}SB_ADMIN_SETTINGS["close-message"]&&3==e&&(SBF.ajax({function:"close-message",conversation_id:i,bot_id:SB_ADMIN_SETTINGS["bot-id"]}),SB_ADMIN_SETTINGS["close-message-transcript"])&&P.transcript(i,"email"),[0,2].includes(e)&&(w.find(".sb-active").attr("data-conversation-status",e),P.setReadIcon(e)),"inbox"!=a&&[0,2].includes(e)||(W.eq(0).find("li.sb-active").click(),W.eq(0).find("ul").sbActive(!1)),U.is("slack")&&[3,4].includes(e)&&SBF.ajax({function:"archive-slack-channels",conversation_user_id:SBChat.conversation.get("user_id")})}),SBChat.conversation&&SBChat.conversation.id==i&&SBChat.conversation.set("conversation_status_code",e)})}),k(function(){k(S).on("click",'ul.sorting-by-last-message li[data-conversation-status="2"]',function(){var t=k(this).attr("data-conversation-id");SBF.ajax({function:"update-conversation-status",conversation_id:t,status_code:0},function(){k(this).attr("data-conversation-status",0),w.find(".sb-active").attr("data-conversation-status",0),P.setReadIcon(0)});var t=k(this).find(".sb-name.span-profile-detail"),e=t.text();20<e.length&&t.text(e.slice(0,17)+"...")}),k(S).on("click",".sb-top .open-profile",function(){k([S.find(".sb-user-details"),this]).toggleClass("sb-active")})}),SBF.ajax({function:"saved-replies"},t=>{let e=`<p class="sb-no-results">${D("No saved replies found. Add new saved replies via Settings > Admin")}</p>`;if(Array.isArray(t)&&0<t.length&&t[0]["reply-name"]){e="",T=t;for(var a=0;a<t.length;a++)e+=`<li><div>${"/"+t[a]["reply-name"]}</div><div>${t[a]["reply-text"]}</div></li>`}ot.find(".sb-replies-list > ul").html(e).sbLoading(!1)}),k(S).on("click","#load-saved-replies",function(){ot.sbTogglePopup(this)}),k(ot).on("click",".sb-replies-list li",function(){SBChat.insertText(k(this).find("div:last-child").html()),SBF.deactivateAll(),d.removeClass("sb-popup-active")}),k(ot).on("input",".sb-search-btn input",function(){let i=k(this).val().toLowerCase();SBF.search(i,()=>{let t="";for(var e=!(1<i.length),a=0;a<T.length;a++)(e||T[a]["reply-name"].toLowerCase().includes(i)||T[a]["reply-text"].toLowerCase().includes(i))&&(t+=`<li><div>${T[a]["reply-name"]}</div><div>${T[a]["reply-text"]}</div></li>`);ot.find(".sb-replies-list > ul").html(t)})}),k(S).on("click","#set-status",function(){rt.sbTogglePopup(this)}),k(H).find(".sb-scroll-area").on("scroll",function(){if(!gt&&!P.is_search&&vt(this,!0)&&ct){let t=S.find(".sb-admin-list");var e=P.filters();gt=!0,t.append('<div class="sb-loading-global sb-loading"></div>'),SBF.ajax({function:"get-conversations",pagination:lt,status_code:e[0],user_type:"agent",department:e[1],source:e[2],tag:e[3]},e=>{if(setTimeout(()=>{gt=!1},500),ct=e.length,e.sort(function(t,e){return new Date(e.creation_time).getTime()-new Date(t.creation_time).getTime()}),ct){let t="";for(var a=0;a<ct;a++)t+=P.getListCode(e[a],"append"),A.push(e[a]);lt++,w.append(t),P.positionList(),vt(this,!1,1e3)}t.find(" > .sb-loading").remove(),SBF.event("SBAdminConversationsLoaded",{conversations:e})})}}),k(document).on("SBMessageDeleted",function(){var t=SBChat.conversation.getLastMessage();0!=t?(t.details.conversation_id,new Date(t.details.creation_time).getTime(),P.newMsgTop(t.details,"add"),w.find("li.sb-active p").html(t.message),w.find("li.sb-active .sb-profile .sb-time").html(t.details.creation_time)):(P.newMsgTop({conversation_id:SBChat.conversation.id},"deleted"),w.find("li.sb-active").remove(),P.clickFirst(),P.scrollTo())}),k(document).on("SBMessageSent",function(t,e){let a=e.conversation_id;var i=w.find(`[data-conversation-id="${a}"]`);let s=D("Error. Message not sent to");var n=e.conversation,o=e.user,i=(e.message&&i.find("p").html(e.message),-1!=e.conversation_status_code&&(i.attr("data-conversation-status",e.conversation_status_code),P.updateMenu()),U.messenger.check(n)&&U.messenger.send(o.getExtra("facebook-id").value,n.get("extra"),e.message,e.attachments,e.message_id,t=>{t&&"error"in t&&M(s+" Messenger: "+t.error.message,"info")}),SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"])),i=(U.whatsapp.check(n)&&U.whatsapp.send(U.whatsapp.activeUserPhone(o),"[rating]"===e.message?i:e.message,e.attachments,n.get("extra"),t=>{t&&!t.error?I("<i class='bi-wind'></i> Message ent successfully"):I("<i class='bi-send-exclamation'></i> Message could not be sent to API Cloud","warning")},t=>{I("<i class='bi-info-circle'></i> Failed to send message. Please try again later","warning"),console.error("Error sending message to WhatsApp:",t)}),SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"])),i=(U.whatsmeow.check(n)&&(e.message_id,"[rating]"==e.message&&(e.message=i),U.whatsmeow.send(U.whatsapp.activeUserPhone(o),e.message,e.attachments,n.get("extra"),t=>{t.status?I("<i class='bi-whatsapp'></i> Message Sent to WhatsApp mobile"):I("<i class='bi-send-exclamation'></i> Message could not be sent. Please check your connection. ","warning")},t=>{I("<i class='bi-info-circle'></i> Error with WhatsApp API. Please check your connection. ","error")})),SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"]));U.waweb.check(n)&&(e.message_id,"[rating]"==e.message&&(e.message=i),U.waweb.send(U.whatsapp.activeUserPhone(o),e.message,e.attachments,n.get("extra"),t=>{t.status?I("<i class='bi-whatsapp'></i> Message Sent to WhatsApp mobile"):I("<i class='bi-send-exclamation'></i> Message could not be sent. Please check your connection. ","warning")},t=>{I("<i class='bi-info-circle'></i> Error with WhatsApp API. Please check your connection. ","error")})),U.telegram.check(n)&&("[rating]"==e.message&&(e.message=i),U.telegram.send(n.get("extra"),e.message,e.attachments,t=>{"ok"in t&&t.ok||M(s+" Telegram: "+JSON.stringify(t),"info")})),U.twitter.check(n)&&("[rating]"==e.message&&(e.message=i),U.twitter.send(o.getExtra("twitter-id").value,e.message,e.attachments,t=>{!t||"event"in t?1<e.attachments.length&&I("Only the first attachment was sent to Twitter.","info"):M(JSON.stringify(t),"info")})),U.gbm.check(n)&&("[rating]"==e.message&&(e.message=i),U.gbm.send(o.getExtra("gbm-id").value,e.message,e.attachments,t=>{t[0]&&"error"in t[0]&&M(s+" Google: "+t[0].error.message,"info")})),SB_ADMIN_SETTINGS["smart-reply"]&&Y.html(""),SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&SBF.null(n.get("agent_id"))&&P.assignAgent(a,SB_ACTIVE_AGENT.id,()=>{SBChat.conversation.id==a&&(SBChat.conversation.set("agent_id",SB_ACTIVE_AGENT.id),k(S).find("#conversation-agent > p").attr("data-value",SB_ACTIVE_AGENT.id).html(SB_ACTIVE_AGENT.full_name))})}),k(document).on("SBNewMessagesReceived",function(t,i){var s=i.get("payload");let n=S.find(".sb-conversation");var e=SBF.isAgent(i.get("user_type"));if(setTimeout(function(){n.find(".sb-top .sb-status-typing").remove()},300),SB_ADMIN_SETTINGS["smart-reply"]&&(e?SB_ADMIN_SETTINGS["smart-reply-agent-assistant"]&&U.dialogflow.smartReplyUpdate(i.message):U.dialogflow.smartReply(i.message)),z.must_translate){let e=SBChat.conversation.getMessage(i.id),a=n.find(`[data-id="${i.id}"]`);var o="original-message"in s&&s["original-message"];o?(e.set("translation",o),a.replaceWith(e.getCode(!0)),n.find(`[data-id="${i.id}"] .sb-menu`).prepend(`<li data-value="original">${D("View translation")}</li>`)):i.message&&U.dialogflow.translate([i.message],SB_ADMIN_SETTINGS["active-agent-language"],t=>{t&&(e.set("translation",t[0].translatedText),a.replaceWith(e.getCode(!0)),n.find(`[data-id="${i.id}"] .sb-menu`).prepend(`<li data-value="original">${D("View original message")}</li>`))})}if("queryResult"in s&&"fulfillmentMessages"in s.queryResult)for(var a=s.queryResult.fulfillmentMessages,r=0;r<a.length;r++)if("payload"in a[r]){var l=a[r].payload;if("department"in l){P.setActiveDepartment(l.department);break}if("agent"in l){P.setActiveAgent(l.agent);break}}"ErrorCode"in s&&M("Error. Message not sent to WhatsApp. Error message: "+s.ErrorMessage,"info"),"whatsapp-fallback"in s&&I("Message sent as text message."+("whatsapp-template-fallback"in s?" The user has been notified via WhatsApp Template notification.":"")),"whatsapp-template-fallback"in s&&!("whatsapp-fallback"in s)&&I("The user has been notified via WhatsApp Template notification."),e||SBChat.conversation.id!=i.get("conversation_id")||SBChat.user_online||q.setActiveUserStatus(),P.update()}),k(document).on("SBNewConversationCreated",function(){P.update()}),k(document).on("SBEmailSent",function(){I("The user has been notified by email.")}),k(document).on("SBSMSSent",function(){I("The user has been notified by text message.")}),k(document).on("SBNotificationsSent",function(t,e){I(`The user has been notified by email${e.includes("sms")?" and text message":""}.`)}),k(document).on("SBTyping",function(t,e){P.typing(e)}),k(H).on("input",".sb-search-btn input",function(){P.search(this)}),k(S).on("click",".sb-admin-list .sb-search-btn i",function(){SBF.searchClear(this,()=>{P.search(k(this).next())}),k(".non-hover, .sb-filter-btn").toggleClass("sb-hide"),k("#hideOnSearchClick").toggleClass("sb-hide")}),k(".bi-search").click(function(){k("#hideOnSearchClick li:first-child").toggleClass("sb-invisible").find("div").toggle(),k("#hideOnSearchClick li:nth-child(2)").toggleClass("sb-invisible").css("margin-right",function(t,e){return"80px"===e?"0px":"80px"})}),k(S).on("click",".sb-admin-list .sb-select li",function(){let a=w.parent();N(a)||setTimeout(()=>{let e=P.filters();ct=lt=1,SBF.ajax({function:"get-conversations",status_code:e[0],department:e[1],agent:SB_ACTIVE_AGENT.id,source:e[2],tag:e[3]},t=>{P.populateList(t),S.find(".sb-conversation").attr("data-conversation-status",e[0]),t.length?L||(SBChat.conversation?(t=w.find(`[data-conversation-id="${SBChat.conversation.id}"]`)).length?t.sbActive(!0):e[0]==SBChat.conversation.get("conversation_status_code")&&w.prepend(P.getListCode(SBChat.conversation).replace("<li",'<li class="sb-active"')):(P.clickFirst(),P.scrollTo())):(S.find(".sb-board").addClass("sb-no-conversation"),SBChat.conversation=!1),a.sbLoading(!1)})},100)}),k(S).on("click",".sb-user-details .sb-scroll-area div.sb-profile",function(){var t=w.find(".sb-active").attr("data-user-id");E().id!=t&&E($[t]),O.show(E().id)}),k(d).on("click",'.sb-profile-list [data-id="location"]',function(){M('<iframe src="https://maps.google.com/maps?q='+k(this).find("label").html().replace(", ","+")+'&output=embed"></iframe>',"map")}),k(d).on("click",'.sb-profile-list [data-id="address"], .sb-profile-list [data-id="city"], .sb-profile-list [data-id="country"]',function(){let t="",e="",a="";"address"===k(this).data("id")?(t=k(this).find("label").text(),e=k('.sb-profile-list [data-id="city"] label').text(),a=k('.sb-profile-list [data-id="country"] label').text()):"city"===k(this).data("id")?(t=k('.sb-profile-list [data-id="address"] label').text(),e=k(this).find("label").text(),a=k('.sb-profile-list [data-id="country"] label').text()):"country"===k(this).data("id")&&(t=k('.sb-profile-list [data-id="address"] label').text(),e=k('.sb-profile-list [data-id="city"] label').text(),a=k(this).find("label").text()),M(`<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(`${t}, ${e}, `+a)}&output=embed"></iframe>`,"map")}),k(d).on("click",'.sb-profile-list [data-id="timezone"]',function(){SBF.getLocationTimeString(E().extra,t=>{R(!1),M(t,"info")})}),k(d).on("click",'.sb-profile-list [data-id="current_url"]',function(){var t=k(this).find("label");window.open(SBF.null(t.attr("data-value"))?t.html():t.attr("data-value"))}),k(d).on("click",'.sb-profile-list [data-id="conversation-source"]',function(t){var e=k(this).find("option:selected").html().toLowerCase();"whatsapp"!=e&&"whatsmeow"!=e&&"waweb"!=e||E().getExtra("phone")}),k(S).on("click",'.sb-menu [data-value="bot"]',function(){U.dialogflow.showCreateIntentBox(k(this).closest("[data-id]").attr("data-id"))}),k(p).on("click",'.sb-intent-add [data-value="add"]',function(){p.find("> div > .sb-type-text").last().after('<div class="sb-input-setting sb-type-text"><input type="text"></div>')}),k(p).on("click",'.sb-intent-add [data-value="previous"],.sb-intent-add [data-value="next"]',function(){for(var t=p.find(".sb-first input"),e=t.val(),a="next"==k(this).attr("data-value"),i=SBChat.conversation.getUserMessages(),s=i.length,n=0;n<s;n++)if(i[n].message==e&&(a&&n<s-1||!a&&0<n)){n+=a?1:-1,t.val(i[n].message),p.attr("data-message-id",i[n].id);break}}),k(p).on("click",".sb-send",function(){U.dialogflow.submitIntent(this)}),k(p).on("input",".sb-search-btn input",function(){U.dialogflow.searchIntents(k(this).val())}),k(p).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{U.dialogflow.searchIntents(k(this).val())})}),k(p).on("click","#sb-intent-preview",function(){U.dialogflow.previewIntent(p.find("#sb-intents-select").val())}),k(p).on("change","#sb-intents-select",function(){p.find(".sb-bot-response").css("opacity",k(this).val()?.5:1)}),k(S).on("click","#conversation-department li",function(t){let e=k(this).parent().parent();return k(this).data("value")==e.find(" > p").attr("data-value")||(SBChat.conversation?e.sbLoading()||M(`${D("All agents assigned to the new department will be notified. The new department will be")} ${k(this).html()}.`,"alert",()=>{let t=k(this).data("id");e.sbLoading(!0),P.assignDepartment(SBChat.conversation.id,t,()=>{P.setActiveDepartment(t),e.sbLoading(!1),e.find(" > p").attr("data-value",t)})}):k(this).parent().sbActive(!1),t.preventDefault(),!1)}),k(S).on("click","#conversation-agent li",function(t){let e=k(this).parent().parent(),a=k(this).data("id");return a==e.find(" > p").attr("data-value")||a==SB_ACTIVE_AGENT.id||(SBChat.conversation?e.sbLoading()||M(`${D("The new agent will be")} ${k(this).html()}.`,"alert",()=>{e.sbLoading(!0),P.assignAgent(SBChat.conversation.id,a,()=>{P.setActiveAgent(a),SBChat.conversation.set("conversation_status_code",6);var t=w.find(`[data-conversation-id="${SBChat.conversation.id}"]`),t=(t.attr("data-conversation-status","6"),t.find(".sb-status")),t=(t.length&&t.attr("data-sb-status","6"),A.findIndex(t=>t.id===SBChat.conversation.id));-1!==t&&(A[t].conversation_status_code=6),P.update(),P.updateMenu(),S.find(".sb-conversation-details").sbActive()&&P.updateConversationDetails(),e.sbLoading(!1)})}):k(e).addClass("sb-active sb-responsive-absolute-position"),t.preventDefault(),!1)}),V.on("click","> i",function(t){return d.find(".sb-notes-box").sbShowLightbox(),k.getScript("https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js").done(()=>{i()}).fail(()=>{k.getScript(STMBX_URL+"/vendor/moment.min.js",()=>{i()})}),t.preventDefault(),!1}),V.on("click",".sb-delete-note",function(){let e=k(this).parents().eq(1);P.notes.delete(SBChat.conversation.id,e.attr("data-id"),t=>{!0===t?e.remove():SBF.error(t)})}),V.on("click",".sb-note-contain",function(){var t=k(this).find(".note-content .more"),e=k(this).find(".note-content .dots");"none"==t.css("display")?t.show():t.hide(),"none"==t.css("display")?e.show():e.hide()}),k(d).on("click",".sb-add-note",function(){let e=k(this).parent().parents().eq(1).find("textarea"),a=e.val();0==a.length?SBForm.showErrorMessage(d.find(".sb-notes-box"),"Please write something..."):N(this)||P.notes.add(SBChat.conversation.id,SB_ACTIVE_AGENT.id,SB_ACTIVE_AGENT.full_name,a,t=>{Number.isInteger(t)?(k(this).sbLoading(!1),d.sbHideLightbox(),P.notes.update([{id:t,conversation_id:SBChat.conversation.id,user_id:SB_ACTIVE_AGENT.id,name:SB_ACTIVE_AGENT.full_name,message:a,alert:k("#alertdate").val(),time_zone:k("#zones").val(),status:!1}],!0),e.val(""),I("New note successfully added."),i()):SBForm.showErrorMessage(t)})}),X.on("click","> i",function(t){let e=k(d).find(".sb-tags-box"),a=e.find(".sb-tags-cnt"),i="",s=SBChat.conversation.details.tags,n='<i id="sb-add-tag" class="bi-plus-lg sb-btn-icon"></i>';for(var o=0;o<s.length;o++)i+=`<span class="sb-active">${s[o]}</span>`;return P.tags.list?a.html(i+P.tags.getAll(s)+n):(e.sbLoading(!0),SBF.ajax({function:"get-tags"},t=>{P.tags.list=t,a.html(i+P.tags.getAll(s)+n),e.sbLoading(!1)})),e.sbShowLightbox(),t.preventDefault(),!1}),k(document).on("click","#tags-container.tagged > span",function(){let e=k(this);e.text();var t=SBChat.conversation.id;SBF.ajax({function:"update-tags",conversation_id:t,tags:[null]},t=>{I(!0===t[0]?"The bot is deleting tags in database...":t),!0===t[0]&&(e.remove(),k(".sb-tags-box .sb-tags-cnt span.sb-active").remove())})}),k(d).on("click",".sb-tags-cnt > span",function(){k(this).toggleClass("sb-active")}),k(d).on("click","#sb-add-tag",function(){k('<input type="text">').insertBefore(this)}),k(d).on("click","#sb-save-tags",function(){if(!N(this)){let a=d.find(".sb-tags-box").find("span.sb-active,input").map(function(){return k(this).is("span")?k(this).html():k(this).val()}).toArray(),i=SBChat.conversation.id;SBF.ajax({function:"update-tags",conversation_id:i,tags:a},t=>{var e;k(this).sbLoading(!1),P.tags.list=t[1],!0===t[0]&&(P.tags.update(a),SBChat.conversation)&&i==SBChat.conversation.id&&(e=P.filters()[3],SBChat.conversation.set("tags",a),e)&&!a.includes(e)&&(w.find(`[data-conversation-id="${i}"]`).remove(),P.clickFirst()),d.sbHideLightbox(),I(!0===t[0]?"Tags have been successfully updated.":t)})}}),k(Y).on("click","span",function(){SBChat.insertText(k(this).html()),Y.html("")}),k(S).on("click",".sb-list .sb-menu > li",function(){let t=k(this).closest("[data-id]"),e=t.attr("data-id");var a=SBChat.conversation.getMessage(e).get("user_type"),i=k(this).attr("data-value");switch(i){case"delete":SBChat.user_online?SBF.ajax({function:"update-message",message_id:e,message:"",attachments:[],payload:{event:"delete-message"}},()=>{SBChat.conversation.deleteMessage(e),t.remove()}):SBChat.deleteMessage(e);break;case"translation":case"original":var s="translation"==i,n=SBF.isAgent(a);t.replaceWith(SBChat.conversation.getMessage(e).getCode(s)),S.find(`[data-id="${e}"] .sb-menu`).prepend(`<li data-value="${s?"original":"translation"}">${D(n&&!s||!n&&s?"View original message":"View translation")}</li>`)}}),k(S).on("click",".sb-filter-btn i",function(){k(this).parent().toggleClass("sb-active")}),SBF.getURL("user")&&(u.find(".sb-admin-nav #sb-users").click(),setTimeout(()=>{O.show(SBF.getURL("user"))},500)),k(f).on("click","th :checkbox",function(){f.find("td :checkbox").prop("checked",k(this).prop("checked"))}),k(f).on("click",":checkbox",function(){var t=g.find('[data-value="delete"]');f.find("td input:checked").length?t.removeAttr("style"):t.hide()}),k(b).on("click","li",function(){q.filter(k(this).data("type"))}),k(g).on("input",".sb-search-btn input",function(){q.search(this)}),k(g).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{q.search(k(this).next())})}),k(f).on("click","th:not(:first-child)",function(){var t=k(this).hasClass("sb-order-asc")?"DESC":"ASC";k(this).toggleClass("sb-order-asc"),k(this).siblings().sbActive(!1),k(this).sbActive(!0),q.sort(k(this).data("field"),t)}),k(f).parent().on("scroll",function(){!gt&&!q.search_query&&vt(this,!0)&&ut&&(gt=!0,g.append('<div class="sb-loading-global sb-loading sb-loading-pagination"></div>'),SBF.ajax({function:"get-users",pagination:dt,sorting:q.sorting,user_types:q.user_types,search:q.search_query,extra:q.table_extra},e=>{if(setTimeout(()=>{gt=!1},500),ut=e.length){let t="";for(var a=0;a<ut;a++){var i=new SBUser(e[a],e[a].extra);t+=q.getRow(i),$[i.id]=i}dt++,f.find("tbody").append(t),vt(this,!1,1e3)}g.find(" > .sb-loading-pagination").remove()}))}),k(m).on("click",".sb-delete",function(){M("This user will be deleted permanently including all linked data, conversations, and messages.","alert",function(){q.delete(E().id)})}),k(f).on("click","td:not(:first-child)",function(){O.show(k(this).parent().attr("data-user-id"))}),k(v).on("click",".sb-top-bar .sb-edit",function(){O.showEdit(E())}),k(g).on("click",".sb-new-user",function(){m.addClass("sb-user-new"),m.find(".sb-top-bar .sb-profile span").html(D("Add new user")),m.find(".sb-top-bar .sb-save").html('<i class="bi-check-lg"></i>'+D("Add user")),m.find("input,select,textara").removeClass("sb-error"),"admin"==SB_ACTIVE_AGENT.user_type&&m.find("#user_type").find("select").html(`<option value="lead">${D("Lead")}</option><option value="agent">${D("Agent")}</option><option value="admin">${D("Admin")}</option>`),O.clear(m),O.boxClasses(m),O.updateRequiredFields("user"),m.sbShowLightbox()}),k(m).on("click",".sb-save",function(){if(!N(this)){let e=!!m.hasClass("sb-user-new"),a=m.attr("data-user-id");var t=O.getAll(m.find(".sb-details")),i=O.getAll(m.find(".sb-additional-details"));O.errors(m)?(O.showErrorMessage(m,SBF.isAgent(m.find("#user_type :selected").val())?"First name, last name, password and a valid email are required. Minimum password length is 8 characters.":m.hasClass("sb-user-new")?"First name, last name, and a valid email are required.":`First name and last name ${"user"==t.user_type[0]||"lead"==t.user_type[0]?"email":""} are required.`),k(this).sbLoading(!1)):SBF.ajax({function:e?"add-user":"update-user",user_id:a,settings:t,settings_extra:i},t=>{SBF.errorValidation(t,"duplicate-email")||SBF.errorValidation(t,"duplicate-phone")?(O.showErrorMessage(m,`This ${SBF.errorValidation(t,"duplicate-email")?"email":"phone number"} is already in use.`),k(this).sbLoading(!1)):(e&&(a=t,E(new SBUser({id:a}))),E().update(()=>{$[a]=E(),e?(O.clear(m),q.update()):(q.updateRow(E()),S.sbActive()&&P.updateUserDetails(),a==SB_ACTIVE_AGENT.id&&(SBF.loginCookie(t[1]),SB_ACTIVE_AGENT.full_name=E().name,SB_ACTIVE_AGENT.profile_image=E().image,u.find(".sb-account").setProfile())),k(this).sbLoading(!1),m.find(".sb-profile").setProfile(),I(e?"New user added":"User updated"),d.sbHideLightbox()}),SBF.event("SBUserUpdated",{new_user:e,user_id:a}))})}}),k(".sb-area-users").on("click","#csv_contacts",function(){k("#csvimport").click()}),k("#csvimport").on("change",function(t){var e=new FormData;e.append("csv",this.files[0]),e.append("function","csv-users-add"),event.preventDefault(),k.ajax({url:STMBX_URL+"/include/ajax.php",method:"POST",data:e,dataType:"json",contentType:!1,cache:!1,processData:!1,success:function(t){I(t.success),k("#csvimport").val("")},error:function(t,e,a){SBF.error("csv-users-add",a),k("#csvimport").val("")}})}),k(m).on("change","#user_type",function(){var t=k(this).find("option:selected").val();O.boxClasses(m,t),O.updateRequiredFields(t)}),k(v).on("click",".sb-user-conversations li",function(){P.open(k(this).attr("data-conversation-id"),k(this).find("[data-user-id]").attr("data-user-id"))}),k(v).on("click",".sb-start-qr-conversation",function(){P.open(-1,E().id),P.openConversation(-1,E().id),L&&P.mobileOpenConversation()}),k(v).on("click",".sb-start-tk-conversation",function(){P.open(-1,E().id),P.openConversation(-1,E().id),L&&P.mobileOpenConversation()}),k(v).on("click",".sb-start-conversation",function(){P.open(-1,E().id),P.openConversation(-1,E().id),L&&P.mobileOpenConversation(),SBChat.sendMessage(-1,!1,!1,!1),d.find(".sb-send-template-box").sbShowLightbox()}),k(v).on("click",".sb-top-bar [data-value]",function(){P.showDirectMessageBox(k(this).attr("data-value"),[E().id])}),k(g).on("click",".sb-top-bar [data-value]",function(){var t=k(this).data("value");let e=[];switch(f.find("tr").each(function(){k(this).find('td input[type="checkbox"]').is(":checked")&&e.push(k(this).attr("data-user-id"))}),t){case"message":case"email":case"sms":P.showDirectMessageBox(t,e);break;case"csv":q.csv();break;case"delete":if(e.includes(SB_ACTIVE_AGENT.id))return I("You cannot delete yourself.","error");M("The bot will delete all selected users and their related data, conversations, and messages permanently.","alert",()=>{q.delete(e),k(this).hide(),f.find("th:first-child input").prop("checked",!1)})}}),k(d).on("change",".sb-select",function(){console.log("sb-select change event triggered");var t=k(this).val();k(this).closest(".sb-direct-message-box").attr("data-type",t)}),k(d).on("click",".sb-send-direct-message",function(t){console.log("sb-send-direct-message click event triggered"),t.preventDefault();let i=k(this).closest(".sb-direct-message-box"),s=i.attr("data-type"),n=i.find(".sb-direct-message-subject input").val(),o=i.find("textarea").val(),r=i.find(".sb-direct-message-users").val().replace(/ /g,""),e=null;if(console.log("Type:",s),console.log("Subject:",n),console.log("Message:",o),console.log("User IDs:",r),"template"===s&&(e=(new Metatemplate).payload("#user-template-form"),console.log("Payload:",e)),!N(this))if("message"==s&&SBF.ajax({function:"direct-message",user_ids:r,message:o},t=>{k(this).sbLoading(!1);let e=SB_ADMIN_SETTINGS["notify-user-email"],a=SB_ADMIN_SETTINGS["sms-active-users"];if(SBF.errorValidation(t))return SBForm.showErrorMessage(i,"An error has occurred. Please make sure all user ids are correct.");(e||a)&&SBF.ajax({function:"get-users-with-details",user_ids:r,details:e&&a?["email","phone"]:[e?"email":"phone"]},t=>{e&&t.email.length?c(t.email,o,0,a?t.phone:[],"email",n):a&&t.phone.length?c(t.phone,o,0,[],"sms"):d.sbHideLightbox()}),I(SBF.slugToString(s)+" sent to all users.")}),"template"==s)console.log("Sending messages..."),SBF.ajax({function:"direct-message",user_ids:r,message:o,template:"template"===s,payload:e},t=>{if(console.log("Direct message response:",t),k(this).sbLoading(!1),SBF.errorValidation(t))return console.log("Error validation occurred"),SBForm.showErrorMessage(i,"An error has occurred. Please make sure all user IDs are correct.");if(t.template_phone)c(t.template_phone,e.BodyTemplate,0,[],"template");else{let e=SB_ADMIN_SETTINGS["notify-user-email"],a=SB_ADMIN_SETTINGS["sms-active-users"];(e||a)&&(console.log("Getting users with details..."),SBF.ajax({function:"get-users-with-details",user_ids:r,details:e&&a?["email","phone"]:[e?"email":"phone"]},t=>{console.log("Users with details response:",t),e&&t.email.length?c(t.email,o,0,a?t.phone:[],"email",n):a&&t.phone.length?c(t.phone,o,0,[],"sms"):d.sbHideLightbox()})),I(SBF.slugToString(s)+" sent to all users.")}});else{console.log("Type is not 'message', getting users with details...");let e="email"==s?"email":"phone";SBF.ajax({function:"get-users-with-details",user_ids:r,details:[e]},t=>{if(console.log("Users with details response:",t),!t[e].length)return k(this).sbLoading(!1),SBForm.showErrorMessage(i,"No users found.");c(t[e],o,0,[],"email"==s?"custom-email":"sms",n)})}}),SBF.getURL("setting")&&(u.find(".sb-admin-nav #sb-settings").click(),setTimeout(()=>{_.find("#tab-"+SBF.getURL("setting")).click()},300)),k(_).on("click"," > .sb-tab > .sb-nav [id]",function(){var t=k(this).attr("id").substr(4);SBF.getURL("setting")!=t&&mt("?setting="+t)}),k(_).on("click",'[data-type="upload-image"] .image',function(){et=this,d.find(".sb-upload-form-admin .sb-upload-files").click()}),k(_).on("click",'[data-type="upload-image"] .image > i',function(t){return k(this).parent().removeAttr("data-value").css("background-image",""),t.preventDefault(),!1}),k(_).on("click",".sb-repeater-add",function(){j.repeaterAdd(this)}),k(_).on("click",".repeater-item > i",function(){j.repeaterDelete(this)}),j.initColorPicker(),k(_).find('[data-type="color"]').focusout(function(){let t=k(this).closest(".input-color"),e=t.find("input").val();setTimeout(function(){t.find("input").val(""),t.find(".color-preview").css("background-color",e)},300),j.set(k(this).attr("id"),e)}),k(_).on("click",".sb-type-color .input i",function(t){k(this).parent().find("input").removeAttr("style").val("")}),k(_).on("click",".sb-color-palette span",function(){var t=k(this).hasClass("sb-active");k(this).closest(".sb-repeater").find(".sb-active").sbActive(!1),k(this).sbActive(!t)}),k(_).on("click",".sb-color-palette ul li",function(){k(this).parent().parent().attr("data-value",k(this).data("value")).find("span").sbActive(!1)}),k(_).on("click",'[data-type="select-images"] .input > div',function(){k(this).siblings().sbActive(!1),k(this).sbActive(!0)}),k(_).on("click",".sb-select-checkbox-input",function(){k(this).toggleClass("sb-active")}),k(_).on("click",".sb-select-checkbox input",function(){var t=k(this).closest("[data-type]");t.find(".sb-select-checkbox-input").val(j.get(t)[1].join(", "))}),k(_).on("click",".sb-save-changes",function(){j.save(this)}),k(_).on("change",'#user-additional-fields [data-id="extra-field-slug"], #saved-replies [data-id="reply-name"], [data-id="rich-message-name"]',function(){k(this).val(SBF.stringToSlug(k(this).val()))}),k(_).on("click","#timetable-utc input",function(){""==k(this).val()&&k(this).val(Math.round(pt.getTimezoneOffset()/60))}),k(_).on("click","#test-email-user .sb-btn, #test-email-agent .sb-btn",function(){var t=k(this).parent().find("input").val();t&&0<t.indexOf("@")&&!N(this)&&SBF.ajax({function:"send-test-email",to:t,email_type:"test-email-user"==k(this).parent().parent().attr("id")?"user":"agent"},()=>{M("Email successfully sent. Check your emails!","info"),k(this).sbLoading(!1)})}),k(_).on("click",".sb-timetable > div > div > div",function(){var t=k(this).closest(".sb-timetable"),e=k(this).sbActive();k(t).find(".sb-active").sbActive(!1),e?k(this).sbActive(!1).find(".sb-custom-select").remove():(e=k(t).find("> .sb-custom-select").html(),k(t).find(" > div .sb-custom-select").remove(),k(this).append(`<div class="sb-custom-select">${e}</div>`).sbActive(!0))}),k(_).on("click",".sb-timetable .sb-custom-select span",function(){var t=[k(this).html(),k(this).attr("data-value")];k(this).closest(".sb-timetable").find("> div > div > .sb-active").html(t[0]).attr("data-value",t[1]),k(this).parent().sbActive(!1)}),k(_).on("click","#system-requirements a",function(t){let a=d.find(".sb-requirements-box"),i="";return SBF.ajax({function:"system-requirements"},t=>{for(var e in t)i+=`<div class="sb-input"><span>${D(SBF.slugToString(e))}</span><div${t[e]?' class="sb-green"':""}>${t[e]?D("Success"):D("Error")}</div></div>`;R(!1),a.find(".sb-main").html(i),a.sbShowLightbox()}),a.sbActive(!1),R(!0),t.preventDefault(),!1}),k(_).on("click","#sb-path a",function(t){return SBF.ajax({function:"path"},t=>{M(t,"info")}),t.preventDefault(),!1}),k(_).on("click","#delete-leads a",function(t){return k(this).sbLoading()||M("All leads, including all the linked conversations and messages, will be deleted permanently.","alert",()=>{k(this).sbLoading(!0),SBF.ajax({function:"delete-leads"},()=>{M("Leads and conversations successfully deleted.","info"),k(this).sbLoading(!1)})}),t.preventDefault(),!1}),k(_).on("click","#dialogflow-smart-reply-generate a",function(t){if(!N(this))return SBF.ajax({function:"dialogflow-smart-reply-generate-conversations-data"},t=>{M("Conversations data successfully generated. Folder: "+t,"info"),k(this).sbLoading(!1)}),t.preventDefault(),!1}),k(_).on("click","#sb-export-settings a",function(t){if(!N(this))return SBF.ajax({function:"export-settings"},t=>{window.open(t),M(D("For security reasons, delete the settings file after downloading it. Close this window to automatically delete it. File location:")+`<pre>${t}</pre>`,"info",!1,"sb-export-settings-close","Settings exported"),k(this).sbLoading(!1)}),t.preventDefault(),!1}),k(_).on("click","#sb-import-settings a",function(t){if(!N(this))return et=this,at=t=>{SBF.ajax({function:"import-settings",file_url:t},t=>{t?I("Settings successfully imported. Reload the admin area to apply the new settings."):M(t,"info"),k(this).sbLoading(!1)}),at=!1},d.find(".sb-upload-form-admin .sb-upload-files").click(),t.preventDefault(),!1}),k(d).on("click","#sb-export-settings-close .sb-close",function(){SBF.ajax({function:"delete-file",path:d.find(".sb-dialog-box p pre").html()})}),k(_).on("click","#whatsmeow-go-start .sb-btn",function(t){e(t,"start")}),k(_).on("click","#whatsmeow-go-restart .sb-btn",function(t){e(t,"restart")}),k(_).on("click","#waweb-go-start .sb-btn",function(t){a(t,"start")}),k(_).on("click","#waweb-go-restart .sb-btn",function(t){a(t,"restart")}),k(document).ready(function(){k(document).on("click","#get-templates-api .sb-btn",function(t){t.preventDefault(),k.ajax({type:"GET",url:STMBX_URL+"/include/templates.php",success:function(t){M("Meta's WhatsApp Business API Cloud templates loaded successfully.","info")},error:function(t,e,a){M("Meta Business Manager configuration incomplete. Please provide the Business Manager User ID, save, and retry.","info")}})})}),k(_).on("click","#whatsapp-twilio-btn .sb-btn, #sms-btn .sb-btn, #wechat-btn .sb-btn, #twitter-callback .sb-btn, #gbm-webhook .sb-btn",function(t){var e=k(this).closest("[id]").attr("id");return M(`<code style=" margin: auto; word-break: break-word; text-align: center; font-size: .9rem; ">${STMBX_URL+("sms-btn"==e?"/include/api.php":"/apps/"+("wechat-btn"==e?"wechat":"twitter-callback"==e?"twitter":"gbm-webhook"==e?"gbm":"whatsapp")+"/post.php")+St().replace("&","?")}</code>`,"info"),!1}),k(_).on("click","#telegram-button .sb-btn",function(t){var e=_.find("#telegram-token input").val().trim();return t.preventDefault(),!(!e||N(this)||(SBF.ajax({function:"telegram-synchronization",token:e,cloud_token:St()},()=>{M("Telegram Synchronization completed.","info"),k(this).sbLoading(!1)}),1))}),k(_).on("click","#whatsapp-test-template .sb-btn",function(t){t.preventDefault();t=k(this).parent().find("input").val();if(t&&!N(this))return SBF.ajax({function:"whatsapp-send-template",phone:t},t=>{M(t&&("error"in t?t.error.message:"Message sent, check your WhatsApp!"),"info"),k(this).sbLoading(!1)}),!1}),k(_).on("click","#twitter-subscribe .sb-btn",function(t){return t.preventDefault(),N(this)||SBF.ajax({function:"twitter-subscribe",cloud_token:St()},t=>{M(!0===t?"Synchronization completed.":JSON.stringify(t),"info"),k(this).sbLoading(!1)}),!1}),k(_).on("click","#email-piping-sync a",function(t){N(this)||(SBF.ajax({function:"email-piping",force:!0},t=>{M(!0===t?"Syncronization completed.":t,"info"),k(this).sbLoading(!1)}),t.preventDefault())}),k(_).on("click","#tab-automations",function(){j.automations.get(()=>{j.automations.populate(),R(!1)},!0),R()}),k(y).on("click",".sb-add-condition",function(){j.automations.addCondition()}),k(y).on("change",".sb-condition-1 select",function(){j.automations.updateCondition(this)}),k(K).on("click","li",function(){j.automations.populate(k(this).data("value"))}),k(B).on("click","li",function(){j.automations.show(k(this).attr("data-id"))}),k(y).on("click",".sb-add-automation",function(){j.automations.add()}),k(B).on("click","li i",function(){M("The automation will be deleted permanently.","alert",()=>{j.automations.delete(this)})});const o=document.getElementById("recordButton");var t=document.getElementById("stopButton");const r=document.querySelector(".bi-arrow-up-circle-fill"),l=document.querySelector(".sb-textarea>textarea");function i(){var t=moment();t.local(),k("#alertdate").val(t.format("MM/DD/YY hh:mm A")),P.timeZoneList()}function c(a,i,s=0,n=[],o,r=!1){let l="custom-email"==o?["send-custom-email","emails"," users with an email","direct-emails"]:"sms"==o?["whatsmeow-send-message","waweb-send-message","messages"," with a phone number","direct-sms"]:["create-email","emails"," with an email",!1];l="template"==o?["whatsapp-send-meta-template","template","users a phone number","direct-messages"]:l;var t=(new Metatemplate).payload("#user-template-form"),t=(t.to=a[s],"template"==o?{function:l[0],payload:t}:{function:l[0],to:a[s].value,recipient_id:a[s].id,sender_name:SB_ACTIVE_AGENT.full_name,sender_profile_image:SB_ACTIVE_AGENT.profile_image,subject:r,message:i,template:!1});SBF.ajax(t,t=>{var e=a.length;if(h.find(".sb-bottom > div").html(`${D("Sending")} ${l[1]}... ${s+1} / `+e),t||console.warn(t),!t?.error)return s<e-1?c(a,i,s+1,n,o,r):(n.length?c(n,i,0,[],"sms",!1):(d.sbHideLightbox(),l[3]&&SBF.ajax({function:"reports-update",name:l[3],value:i+" | "+e})),void I(1==e?"Message sent":`${SBF.slugToString(l[1])} sent to all users${l[2]}.`));132e3==t?.error.code||100==t?.error.code?SBForm.showErrorMessage(h,""+t?.error.message):M(""+t?.error.message,"info"),console.warn(t)})}function e(t,e){t.preventDefault();let i=_.find("#whatsmeow-go-qr input").val(),s="start"===e?"/include/get_ww.php?qrurl=":"/include/reset_ww.php";"start"===e?(k("#qr_loading1").show(),fetch(STMBX_URL+s+i).then(t=>{if(t.ok)return t.text();throw new Error("Network response was not ok")}).then(t=>{try{var e=JSON.parse(t);if(e.error)SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"warning");else if(e.image){let t="data:image/png;base64,"+e.image;var a=k("#qr_image1");a.length?a.fadeOut(500,function(){k(this).attr("src",t).fadeIn(500)}):(k("#whatsmeow-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image1" src="${t}" onerror="this.style.display='none';$('#qr_loading1').show();" />`),k("#whatsmeow-go .sb-setting-content").append('<div id="qr_loading1" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>')),k("#qr_loading1").hide()}}catch(t){if(!(t instanceof SyntaxError))throw t;console.error("Response is not JSON, assuming it's an image blob."),fetch(STMBX_URL+s+i).then(t=>{if(t.ok)return t.blob();throw new Error("Network response was not ok")}).then(t=>{let e=URL.createObjectURL(t);t=k("#qr_image1");t.length?t.fadeOut(500,function(){k(this).attr("src",e).fadeIn(500)}):(k("#whatsmeow-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image1" src="${e}" onerror="this.style.display='none';$('#qr_loading1').show();" />`),k("#whatsmeow-go .sb-setting-content").append('<div id="qr_loading1" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>'))}).catch(t=>{console.error("Error during fetch:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")})}}).catch(t=>{console.error("Error during fetch:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}).finally(()=>{k("#qr_loading1").hide()})):"restart"===e&&(console.log("Restarting..."),k.ajax({url:s,method:"GET",data:{qrurl:i},dataType:"json",success:function(t){console.log("Restart successful. Response:",t),SBChat.showResponse('<i style="var(--color-red)" class="bi bi-telephone-x"></i> Disconnecting from WhatsApp...');t=k("#qr_image1");t.length&&t.fadeOut(500,function(){k(this).remove()})},error:function(t){console.error("Restart error. Response:",t.responseText),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}}))}function a(t,e){t.preventDefault();var t=_.find("#waweb-go-qr input").val(),a="start"===e?"/include/get_wx.php?qrurl=":"/include/reset_wx.php";"start"===e?(k("#qr_loading2").show(),fetch(STMBX_URL+a+t).then(t=>{if(t.ok)return t.text();throw new Error("Network response was not ok")}).then(t=>{try{var e=JSON.parse(t);if(e.error)console.error("Error in JSON response:",e.error),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"warning");else if(e.image){let t="data:image/png;base64,"+e.image;var a=k("#qr_image2");a.length?a.fadeOut(500,function(){k(this).attr("src",t).fadeIn(500)}):(k("#waweb-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image2" src="${t}" onerror="this.style.display='none';$('#qr_loading2').show();" />`),k("#waweb-go .sb-setting-content").append('<div id="qr_loading2" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>')),k("#qr_loading2").hide()}}catch(t){console.error("Error parsing JSON response:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}}).catch(t=>{console.error("Error during fetch:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}).finally(()=>{k("#qr_loading2").hide()})):"restart"===e&&k.ajax({url:a,method:"GET",data:{qrurl:t},dataType:"json",success:function(t){console.log("Restart successful. Response:",t),SBChat.showResponse('<i style="var(--color-red)" class="bi bi-telephone-x"></i> Disconnecting from WhatsApp...');t=k("#qr_image2");t.length&&t.fadeOut(500,function(){k(this).remove()})},error:function(t){console.error("Restart error. Response:",t.responseText),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}})}function s(){setTimeout(()=>{document.querySelector(".bi-arrow-up-circle-fill").classList.remove("sb-hide")},500)}r.addEventListener("click",()=>{o.classList.remove("sb-hide"),setTimeout(()=>{r.classList.add("sb-hide")},10)}),l.addEventListener("input",()=>{""===l.value.trim()?(r.classList.add("sb-hide"),o.classList.remove("sb-hide")):(r.classList.remove("sb-hide"),o.classList.add("sb-hide"))}),o.addEventListener("click",()=>{document.querySelector(".bi-mic-fill").classList.add("sb-hide"),s()}),t.addEventListener("click",()=>{document.querySelector(".bi-mic-fill").classList.remove("sb-hide"),s()}),k(C).on("click",".sb-nav [id]",function(){var t=k(this).attr("id");G.active_report=!1,C.find("#sb-date-picker").val(""),C.attr("class","sb-area-reports sb-active sb-report-"+t),G.initReport(k(this).attr("id")),SBF.getURL("report")!=t&&mt("?report="+t)}),k(C).on("change","#sb-date-picker",function(){G.initReport(!1,k(this).val())}),SBF.getURL("report")&&(C.sbActive()||u.find(".sb-admin-nav #sb-reports").click(),setTimeout(()=>{C.find("#"+SBF.getURL("report")).click()},500)),k(d).on("click",".sb-language-switcher > i",function(){let t=k(this).parent(),e=t.find("[data-language]").map(function(){return k(this).attr("data-language")}).get(),a=d.find(".sb-languages-box"),i="";for(var s in e.push("en"),SB_LANGUAGE_CODES)e.includes(s)||(i+=`<div data-language="${s}"><img src="${STMBX_URL}/media/flags/${s}.png" />${D(SB_LANGUAGE_CODES[s])}</div>`);it=t,a.attr("data-source",t.attr("data-source")),a.find(".sb-main").html(i),a.sbShowLightbox()}),k(d).on("click",".sb-language-switcher img",function(){var t=k(this).parent(),e=t.sbActive(),a=!e&&t.attr("data-language");switch(t.parent().attr("data-source")){case"articles":j.articles.show(!1,!1,a);break;case"automations":j.automations.show(!1,a);break;case"settings":var i=t.parent().find("[data-language].sb-active");j.translations.save(t,e?t.attr("data-language"):!!i.length&&i.attr("data-language")),j.translations.activate(t,a)}t.siblings().sbActive(!1),t.sbActive(!e)}),k(d).on("click",".sb-language-switcher span > i",function(){let t=k(this).parent(),e=t.attr("data-language");M(D("The {T} translation will be deleted.").replace("{T}",D(SB_LANGUAGE_CODES[e])),"alert",()=>{switch(t.parent().attr("data-source")){case"articles":j.articles.deleteTranslation(!1,e),j.articles.show();break;case"automations":j.automations.deleteTranslation(!1,e),j.automations.show();break;case"settings":j.translations.delete(t,e)}t.remove()})}),k(d).on("click",".sb-languages-box [data-language]",function(){var t=k(this).parents().eq(1),e=k(this).attr("data-language");switch(t.attr("data-source")){case"articles":j.articles.addTranslation(!1,e),j.articles.show(!1,!1,e);break;case"automations":j.automations.addTranslation(!1,!1,e),j.automations.show(!1,e);break;case"settings":j.translations.add(e)}d.sbHideLightbox()}),k(d).on("click",".sb-lightbox .sb-top-bar .sb-close",function(){d.sbHideLightbox()}),k(d).on("click",".sb-lightbox .sb-info",function(){k(this).sbActive(!1)}),k(d).on("click",".sb-dialog-box a",function(){var t=k(this).closest(".sb-lightbox");k(this).hasClass("sb-confirm")&&st(),1==d.find(".sb-lightbox.sb-active").length&&nt.sbActive(!1),z.open_popup=!1,t.sbActive(!1)}),k(d).on("click",".sb-menu-wide li, .sb-nav li",function(){k(this).siblings().sbActive(!1),k(this).sbActive(!0)}),k(d).on("click",".sb-nav:not(.sb-nav-only) li:not(.sb-tab-nav-title)",function(){var t=k(this).closest(".sb-tab"),e=k(t).find(" > .sb-content > div").sbActive(!1).eq(k(this).parent().find("li:not(.sb-tab-nav-title)").index(this));e.sbActive(!0),e.find("textarea").each(function(){k(this).autoExpandTextarea(),k(this).manualExpandTextarea()}),t.find(".sb-scroll-area").scrollTop(0)}),k(d).sbInitTooltips(),k(d).on("click",'[data-button="toggle"]',function(){var t=d.find("."+k(this).data("show")),e=d.find("."+k(this).data("hide"));t.addClass("sb-show-animation").show(),e.hide(),z.open_popup=!(!t.hasClass("sb-lightbox")&&!t.hasClass("sb-popup"))&&t}),k(d).on("click",".sb-info-card",function(){k(this).sbActive(!1)}),k(d).on("change",".sb-upload-form-admin .sb-upload-files",function(t){k(this).sbUploadFiles(function(t){"success"==(t=JSON.parse(t))[0]?("upload-image"==k(et).closest("[data-type]").data("type")&&k(et).attr("data-value",t[1]).css("background-image",`url("${t[1]}")`),at&&at(t[1])):console.log(t[1])})}),k(d).on("click",".sb-accordion > div > span",function(t){var e=k(this).parent(),a=k(e).sbActive();k(t.target).is("span")&&(e.siblings().sbActive(!1),e.sbActive(!a))}),k(d).on("mousedown",function(t){var e;!k(z.open_popup).length||(e=k(z.open_popup)).is(t.target)||0!==e.has(t.target).length||["sb-btn-saved-replies","bi-emoji-grin"].includes(k(t.target).attr("class"))||(e.hasClass("sb-popup")?e.sbTogglePopup():e.hasClass("sb-select")?e.find("ul").sbActive(!1):e.hasClass("sb-menu-mobile")?e.find("i").sbActive(!1):e.hasClass("sb-menu")?e.sbActive(!1):d.sbHideLightbox(),z.open_popup=!1)})}})}(jQuery),function(t,e){"object"==typeof exports?module.exports=e(t):"function"==typeof define&&define.amd?define("colors",[],function(){return e(t)}):t.Colors=e(t)}(this,function(t,c){function n(t,e,a,i,s){if("string"==typeof e){e=k.txt2color(e);B[a=e.type]=e[a],s=s!==c?s:e.alpha}else if(e)for(var n in e)t[a][n]=r(e[n]/w[a][n][1],0,1);return s!==c&&(t.alpha=r(+s,0,1)),o(a,i?t:c)}function o(t,e){var a,i,s=e||B,n=k,o=y.options,r=w,l=s.RND,c="",d={hsl:"hsv",rgb:t},u=l.rgb;if("alpha"!==t){for(var h in r)if(!r[h][h])for(c in t!==h&&(i=d[h]||"rgb",s[h]=n[i+"2"+h](s[i])),l[h]||(l[h]={}),a=s[h])l[h][c]=x(a[c]*r[h][c][1]);u=l.rgb,s.HEX=n.RGB2HEX(u),s.equivalentGrey=o.grey.r*s.rgb.r+o.grey.g*s.rgb.g+o.grey.b*s.rgb.b,s.webSave=f=v(u,51),s.webSmart=b=v(u,17),s.saveColor=u.r===f.r&&u.g===f.g&&u.b===f.b?"web save":u.r===b.r&&u.g===b.g&&u.b===b.b?"web smart":"",s.hueRGB=k.hue2RGB(s.hsv.h),e&&(s.background=(f=u,b=s.rgb,e=s.alpha,g=y.options.grey,(p={}).RGB={r:f.r,g:f.g,b:f.b},p.rgb={r:b.r,g:b.g,b:b.b},p.alpha=e,p.equivalentGrey=x(g.r*f.r+g.g*f.g+g.b*f.b),p.rgbaMixBlack=S(b,{r:0,g:0,b:0},e,1),p.rgbaMixWhite=S(b,{r:1,g:1,b:1},e,1),p.rgbaMixBlack.luminance=m(p.rgbaMixBlack,!0),p.rgbaMixWhite.luminance=m(p.rgbaMixWhite,!0),y.options.customBG&&(p.rgbaMixCustom=S(b,y.options.customBG,e,1),p.rgbaMixCustom.luminance=m(p.rgbaMixCustom,!0),y.options.customBG.luminance=m(y.options.customBG,!0)),p))}var p,g=s.rgb,f=s.alpha,b="luminance",e=s.background;return(p=S(g,{r:0,g:0,b:0},f,1))[b]=m(p,!0),s.rgbaMixBlack=p,(p=S(g,{r:1,g:1,b:1},f,1))[b]=m(p,!0),s.rgbaMixWhite=p,o.customBG&&((p=S(g,e.rgbaMixCustom,f,1))[b]=m(p,!0),p.WCAG2Ratio=(g=p[b],f=e.rgbaMixCustom[b],x(100*(f<=g?(g+.05)/(f+.05):(f+.05)/(g+.05)))/100),(s.rgbaMixBGMixCustom=p).luminanceDelta=_.abs(p[b]-e.rgbaMixCustom[b]),p.hueDelta=(f=e.rgbaMixCustom,g=p,255*(_.max(f.r-g.r,g.r-f.r)+_.max(f.g-g.g,g.g-f.g)+_.max(f.b-g.b,g.b-f.b))/765)),s.RGBLuminance=m(u),s.HUELuminance=m(s.hueRGB),o.convertCallback&&o.convertCallback(s,t),s}function v(t,e){var a,i,s={},n=e/2;for(i in t)a=t[i]%e,s[i]=t[i]+(n<a?e-a:-a);return s}function m(t,e){for(var e=e?1:255,a=[t.r/e,t.g/e,t.b/e],t=y.options.luminance,i=a.length;i--;)a[i]=a[i]<=.03928?a[i]/12.92:_.pow((a[i]+.055)/1.055,2.4);return t.r*a[0]+t.g*a[1]+t.b*a[2]}function S(t,e,a,i){var s,n={},o=a!==c?a:1,r=i!==c?i:1,l=o+r*(1-o);for(s in t)n[s]=(t[s]*o+e[s]*r*(1-o))/l;return n.a=l,n}function r(t,e,a){return a<t?a:t<e?e:t}function e(t){this.colors={RND:{}},this.options={color:"rgba(0,0,0,0)",grey:l,luminance:d,valueRanges:w};var e,a=this,i=t||{},s=a.options;for(e in u(a),i)i[e]!==c&&(s[e]=i[e]);t=s.customBG,s.customBG="string"==typeof t?k.txt2color(t).rgb:t,B=n(a.colors,s.color,c,!0)}var w={rgb:{r:[0,255],g:[0,255],b:[0,255]},hsv:{h:[0,360],s:[0,100],v:[0,100]},hsl:{h:[0,360],s:[0,100],l:[0,100]},alpha:{alpha:[0,1]},HEX:{HEX:[0,16777215]}},_=t.Math,x=_.round,y={},B={},l={r:.298954,g:.586434,b:.114612},d={r:.2126,g:.7152,b:.0722},u=function(t){y!==t&&(B=(y=t).colors)},k=(e.prototype.setColor=function(t,e,a){return u(this),t?n(this.colors,t,e,c,a):(a!==c&&(this.colors.alpha=r(a,0,1)),o(e))},e.prototype.setCustomBackground=function(t){return u(this),this.options.customBG="string"==typeof t?k.txt2color(t).rgb:t,n(this.colors,c,"rgb")},e.prototype.saveAsBackground=function(){return u(this),n(this.colors,c,"rgb",!0)},e.prototype.toString=function(t,e){return k.color2text((t||"rgb").toLowerCase(),this.colors,e)},{txt2color:function(t){var e,a={},t=t.replace(/(?:#|\)|%)/g,"").split("("),i=(t[1]||"").split(/,\s*/),s=t[1]?t[0].substr(0,3):"rgb";if(a.type=s,a[s]={},t[1])for(var n=3;n--;)e=s[n]||s.charAt(n),a[s][e]=+i[n]/w[s][e][1];else a.rgb=k.HEX2rgb(t[0]);return a.alpha=i[3]?+i[3]:1,a},color2text:function(t,e,a){var i=!1!==a&&x(100*e.alpha)/100,a="number"==typeof i&&!1!==a&&(a||1!==i),s=e.RND.rgb,n=e.RND.hsl,o="hex"===t&&a,r="hex"===t&&!o,s="rgb"===t||o?s.r+", "+s.g+", "+s.b:r?"#"+e.HEX:n.h+", "+n.s+"%, "+n.l+"%";return r?s:(o?"rgb":t)+(a?"a":"")+"("+s+(a?", "+i:"")+")"},RGB2HEX:function(t){return((t.r<16?"0":"")+t.r.toString(16)+(t.g<16?"0":"")+t.g.toString(16)+(t.b<16?"0":"")+t.b.toString(16)).toUpperCase()},HEX2rgb:function(t){return{r:("0x"+(t=t.split(""))[0]+t[t[3]?1:0])/255,g:("0x"+t[t[3]?2:1]+(t[3]||t[1]))/255,b:("0x"+(t[4]||t[2])+(t[5]||t[2]))/255}},hue2RGB:function(t){var t=6*t,e=~~t%6,t=6==t?0:t-e;return{r:x(255*[1,1-t,0,0,t,1][e]),g:x(255*[t,1,1,1-t,0,0][e]),b:x(255*[0,0,t,1,1,1-t][e])}},rgb2hsv:function(t){var e,a=t.r,i=t.g,t=t.b,s=0;return i<t&&(i=t+(t=i,0),s=-1),e=t,a<i&&(a=i+(i=a,0),s=-2/6-s,e=_.min(i,t)),e=a-e,{h:(a?e/a:0)<1e-15?B&&B.hsl&&B.hsl.h||0:e?_.abs(s+(i-t)/(6*e)):0,s:a?e/a:B&&B.hsv&&B.hsv.s||0,v:a}},hsv2rgb:function(t){var e=6*t.h,a=t.s,t=t.v,i=~~e,e=e-i,s=t*(1-a),n=t*(1-e*a),e=t*(1-(1-e)*a),a=i%6;return{r:[t,n,s,s,e,t][a],g:[e,t,t,n,s,s][a],b:[s,s,e,t,t,n][a]}},hsv2hsl:function(t){var e=(2-t.s)*t.v,a=t.s*t.v,a=t.s?e<1?e?a/e:0:a/(2-e):0;return{h:t.h,s:t.v||a?a:B&&B.hsl&&B.hsl.s||0,l:e/2}},rgb2hsl:function(t,e){t=k.rgb2hsv(t);return k.hsv2hsl(e?t:B.hsv=t)},hsl2rgb:function(t){var e=6*t.h,a=t.s,t=t.l,a=t<.5?t*(1+a):t+a-a*t,t=t+t-a,i=~~e,e=a*(a?(a-t)/a:0)*(e-i),s=t+e,e=a-e,i=i%6;return{r:[a,e,t,t,s,a][i],g:[s,a,a,e,t,t][i],b:[t,t,s,a,a,e][i]}}});return e}),function(a,i){"object"==typeof exports?module.exports=i(a,require("jquery"),require("colors")):"function"==typeof define&&define.amd?define(["jquery","colors"],function(t,e){return i(a,t,e)}):i(a,a.jQuery,a.Colors)}(this,function(n,o,e,f){function r(t){return t.value||t.getAttribute("value")||o(t).css("background-color")||"#FFF"}function a(t){return(t=t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches[0]:t).originalEvent?t.originalEvent:t}function l(t){return o(t.find(m.doRender)[0]||t[0])}function s(t){var e=o(this),a=e.offset(),i=o(n),s=m.gap;t?((S=l(e))._colorMode=S.data("colorMode"),g.$trigger=e,(w||(o("head")[m.cssPrepend?"prepend":"append"]('<style type="text/css" id="tinyColorPickerStyles">'+(m.css||".cp-color-picker{position:absolute;overflow:hidden;padding:6px 6px 0;background-color:#444;color:#bbb;font-family:Arial,Helvetica,sans-serif;font-size: var(--chat-text-size-8);font-weight:400;cursor:default;border-radius:5px}.cp-color-picker>div{position:relative;overflow:hidden}.cp-xy-slider{float:left;height:128px;width:128px;margin-bottom:6px;background:linear-gradient(to right,#FFF,rgba(255,255,255,0))}.cp-white{height:100%;width:100%;background:linear-gradient(rgba(0,0,0,0),#000)}.cp-xy-cursor{position:absolute;top:0;width:10px;height:10px;margin:-5px;border:1px solid #fff;border-radius:100%;box-sizing:border-box}.cp-z-slider{float:right;margin-left:6px;height:128px;width:20px;background:linear-gradient(red 0,#f0f 17%,#00f 33%,#0ff 50%,#0f0 67%,#ff0 83%,red 100%)}.cp-z-cursor{position:absolute;margin-top:-4px;width:100%;border:4px solid #fff;border-color:transparent #fff;box-sizing:border-box}.cp-alpha{clear:both;width:100%;height:16px;margin:6px 0;background:linear-gradient(to right,#444,rgba(0,0,0,0))}.cp-alpha-cursor{position:absolute;margin-left:-4px;height:100%;border:4px solid #fff;border-color:#fff transparent;box-sizing:border-box}")+(m.cssAddon||"")+"</style>"),o('<div class="cp-color-picker"><div class="cp-z-slider"><div class="cp-z-cursor"></div></div><div class="cp-xy-slider"><div class="cp-white"></div><div class="cp-xy-cursor"></div></div><div class="cp-alpha"><div class="cp-alpha-cursor"></div></div></div>').css({margin:m.margin}).appendTo("body").show(0,function(){g.$UI=w=o(this),I=m.GPU&&w.css("perspective")!==f,_=o(".cp-z-slider",this),x=o(".cp-xy-slider",this),y=o(".cp-xy-cursor",this),B=o(".cp-z-cursor",this),k=o(".cp-alpha",this),C=o(".cp-alpha-cursor",this),m.buildCallback.call(g,w),w.prepend("<div>").children().eq(0).css("width",w.children().eq(0).width()),w._width=this.offsetWidth,w._height=this.offsetHeight}).hide())).css(m.positionCallback.call(g,e)||{left:(w._left=a.left)-(0<(w._left+=w._width-(i.scrollLeft()+i.width()))+s?w._left+s:0),top:(w._top=a.top+e.outerHeight())-(0<(w._top+=w._height-(i.scrollTop()+i.height()))+s?w._top+s:0)}).show(m.animationSpeed,function(){!0!==t&&(k.toggle(!!m.opacity)._width=k.width(),x._width=x.width(),x._height=x.height(),_._height=_.height(),v.setColor(r(S[0])),h(!0))}).off(".tcp").on(L,".cp-xy-slider,.cp-z-slider,.cp-alpha",c)):g.$trigger&&o(w).hide(m.animationSpeed,function(){h(!1),g.$trigger=null}).off(".tcp")}function c(t){var e=this.className.replace(/cp-(.*?)(?:\s*|$)/,"$1").replace("-","_");1<(t.button||t.which)||(t.preventDefault&&t.preventDefault(),t.returnValue=!1,S._offset=o(this).offset(),(e="xy_slider"===e?i:"z_slider"===e?d:u)(t),h(),A.on(F,function(){A.off(".tcp")}).on($,function(t){e(t),h()}))}function i(t){var t=a(t),e=t.pageX-S._offset.left,t=t.pageY-S._offset.top;v.setColor({s:e/x._width*100,v:100-t/x._height*100},"hsv")}function d(t){t=a(t).pageY-S._offset.top;v.setColor({h:360-t/_._height*360},"hsv")}function u(t){t=(a(t).pageX-S._offset.left)/k._width;v.setColor({},"rgb",t)}function h(t){var e=v.colors,a=e.hueRGB,i=(e.RND.rgb,e.RND.hsl,m.dark),s=m.light,n=v.toString(S._colorMode,m.forceAlpha),o=.22<e.HUELuminance?i:s,r=.22<e.rgbaMixBlack.luminance?i:s,l=(1-e.hsv.h)*_._height,c=e.hsv.s*x._width,d=(1-e.hsv.v)*x._height,u=e.alpha*k._width,h=I?"translate3d":"",p=S[0].value,g=S[0].hasAttribute("value")&&""===p&&t!==f;x._css={backgroundColor:"rgb("+a.r+","+a.g+","+a.b+")"},y._css={transform:h+"("+c+"px, "+d+"px, 0)",left:I?"":c,top:I?"":d,borderColor:.22<e.RGBLuminance?i:s},B._css={transform:h+"(0, "+l+"px, 0)",top:I?"":l,borderColor:"transparent "+o},k._css={backgroundColor:"#"+e.HEX},C._css={transform:h+"("+u+"px, 0, 0)",left:I?"":u,borderColor:r+" transparent"},S._css={backgroundColor:g?"":n,color:g?"":.22<e.rgbaMixBGMixCustom.luminance?i:s},S.text=!g&&p!==n?n:"",t!==f?b(t):E(b)}function b(t){x.css(x._css),y.css(y._css),B.css(B._css),k.css(k._css),C.css(C._css),m.doRender&&S.css(S._css),S.text&&S.val(S.text),m.renderCallback.call(g,S,"boolean"==typeof t?t:f)}function p(t){m=(v=this.color=new e(t)).options,g=this}var g,v,m,S,w,_,x,y,B,k,C,A=o(document),T=o(),$="touchmove.tcp mousemove.tcp pointermove.tcp",L="touchstart.tcp mousedown.tcp pointerdown.tcp",F="touchend.tcp mouseup.tcp pointerup.tcp",I=!1,E=n.requestAnimationFrame||n.webkitRequestAnimationFrame||function(t){t()};p.prototype={render:h,toggle:s},o.fn.colorPicker=function(i){function t(){}var e=this;return i=o.extend({animationSpeed:150,GPU:!0,doRender:!0,customBG:"#FFF",opacity:!0,renderCallback:t,buildCallback:t,positionCallback:t,body:document.body,scrollResize:!0,gap:4,dark:"#222",light:"#DDD"},i),!g&&i.scrollResize&&o(n).on("resize.tcp scroll.tcp",function(){g.$trigger&&g.toggle.call(g.$trigger[0],!0)}),T=T.add(this),this.colorPicker=g||new p(i),this.options=i,o(i.body).off(".tcp").on(L,function(t){-1===T.add(w).add(o(w).find(t.target)).index(t.target)&&s()}),this.on("focusin.tcp click.tcp",function(t){g.color.options=o.extend(g.color.options,m=e.options),s.call(this,t)}).on("change.tcp",function(){v.setColor(this.value||"#FFF"),e.colorPicker.render(!0)}).each(function(){var t=r(this),e=t.split("("),a=l(o(this));a.data("colorMode",e[1]?e[0].substr(0,3):"HEX").attr("readonly",m.preventFocus),i.doRender&&a.css({"background-color":t,color:function(){return.22<v.setColor(t).rgbaMixBGMixCustom.luminance?i.dark:i.light}})})},o.fn.colorPicker.destroy=function(){o("*").off(".tcp"),g.toggle(!1),T=o()}}),window.addEventListener("load",function(){initLoadingAnimation()}),document.addEventListener("click",t=>{var e,a;t.target.classList.contains("settings-button")?(a=(e=t.target.closest(".sb-setting")).querySelector(".active")).classList.contains("sb-hide")?(a.classList.remove("sb-hide"),e.querySelector(".input").classList.remove("sb-hide")):(a.classList.add("sb-hide"),e.querySelector(".input").classList.add("sb-hide")):t.target.classList.contains("sb-revert")&&((a=t.target.closest(".sb-setting")).querySelector(".active").classList.add("sb-hide"),a.querySelector(".input").classList.add("sb-hide"))}),window.onclick=function(t){if(!t.target.matches(".cst-btn"))for(var e=document.getElementsByClassName("cstdown-content"),a=0;a<e.length;a++){var i=e[a];i.classList.contains("show")&&i.classList.remove("show")}};