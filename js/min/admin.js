"use strict";function showContent(){const t=document.getElementById("overlay"),e=document.documentElement;t.style.display="none",e.style.animation="fade-in .2s ease-out"}function initLoadingAnimation(){const t=document.getElementById("overlay");document.getElementById("loader");t.style.animation="load 1.6s ease-out",t.addEventListener("animationend",(function(){showContent()}))}function ExtraButton(){document.getElementById("CstBtn").classList.toggle("show")}!function(t){var e,s,i,a,n,o,r,l,c,d,u,h,p,f,g,b,v,m,S,w,_,y,x,B,k,C,A,T,$,L,F,I,E,M=[],R=!1,N=!1,D=!1,U=1,j=1,G={},q=1,O=1,P=t(window).width()<555,z={last:0,header:!0,always_hidden:!1},H="localhost"===location.hostname||"127.0.0.1"===location.hostname,W=new Date,V=!1,X=!0,J=!1,Y="undefined",Z=!1,Q=!1,K=!1,tt=["Abierto","Presupuesto","Consulta","Contactado","Visitado","Calificado","Confirmado","Pendiente","Resuelto","Pagado","VIP","Descartado","NA"];function et(t,s=!1){var i=e.find(".sb-info-card");s?"error"===s?(i.addClass("sb-info-card-error"),L=setTimeout((()=>{i.sbActive(!1)}),4e3)):"warning"===s?(i.addClass("sb-info-card-warning"),L=setTimeout((()=>{i.sbActive(!1)}),3e3)):i.addClass("sb-info-card-info"):(i.removeClass("sb-info-card-error sb-info-card-warning sb-info-card-info"),clearTimeout(L),L=setTimeout((()=>{i.sbActive(!1)}),1500)),i.html(`<h3>${ot(t)}</h3>`).sbActive(!0)}function st(t){if(typeof t==Y)return window.sb_current_user;window.sb_current_user=t}function it(s,i,a=!1,n="",o="",r=!1){let l=e.find(".sb-dialog-box").attr("data-type",i),c=l.find("p");l.attr("id",n).setClass("sb-scroll-area",r).css("height",r?parseInt(t(window).height())-200+"px":""),l.find(".sb-title").html(o),c.html(("alert"==i?'<strong style="font-size: var(--chat-text-size-1-1);color: var(--chat-text-primary">'+ot("Are you sure?")+"</strong> ":"")+ot(s)),l.sbActive(!0).css({"margin-top":l.outerHeight()/-2+"px","margin-left":l.outerWidth()/-2+"px"}),E.sbActive(!0),F=a,setTimeout((()=>{_t.open_popup=l}),500)}function at(s=!1,i=!0){e.find(".sb-loading-global").sbActive(s),i&&(E.sbActive(s),t("body").setClass("sb-lightbox-active",s))}function nt(e){return!!t(e).sbLoading()||(t(e).sbLoading(!0),!1)}function ot(t){return SB_TRANSLATIONS&&t in SB_TRANSLATIONS?SB_TRANSLATIONS[t]:t}function rt(e,s){let i=(e=t(e)).find("> div, > ul");i.css({height:"","max-height":""}),e.hasClass("sb-collapse")&&t(i).prop("scrollHeight")>s&&(e.sbActive(!0).attr("data-height",s),e.find(".bi-chevron-down").remove(),e.append(`<a class="sb-btn-text bi-chevron-down">${ot("View more")}</a>`),i.css({height:s+"px","max-height":s+"px"}))}function lt(e,s){let i=t(e).parent().find("i"),a=t(e).val();i.sbLoading()||SBF.search(a,(()=>{i.sbLoading(!0),s(a,i)}))}function ct(e,s=!1,i=0){if(s)return t(e).scrollTop()+t(e).innerHeight()>=t(e)[0].scrollHeight-1;t(e).scrollTop(t(e)[0].scrollHeight-i)}function dt(t){window.history.pushState("","",t)}function ut(){return SB_ADMIN_SETTINGS.cloud?"&cloud="+SB_ADMIN_SETTINGS.cloud.token:""}function ht(e=!1){if(!K){if(!1===Z)return Z=!0,void t.getScript(STMBX_URL+"/vendor/editorjs.js",(()=>{ht(e)}));ft(),K=!0,Z=new EditorJS({data:"string"==typeof e?{time:Date.now(),blocks:[e?{id:"sb",type:"raw",data:{html:e}}:{id:"sb",type:"paragraph",data:{text:""}}]}:e,i18n:{messages:{ui:{blockTunes:{toggler:{"Click to tune":ot("Click to tune")}},inlineToolbar:{converter:{"Convert to":ot("Convert to")}},toolbar:{toolbox:{Add:ot("Add")}}},toolNames:{Text:ot("Text"),Heading:ot("Heading"),List:ot("List"),Image:ot("Image"),Code:ot("Code"),"Raw HTML":ot("Raw HTML"),Bold:ot("Bold"),Italic:ot("Italic"),Link:ot("Link")},tools:{list:{Ordered:ot("Ordered"),Unordered:ot("Unordered")}},blockTunes:{delete:{Delete:ot("Delete")},moveUp:{"Move up":ot("Move up")},moveDown:{"Move down":ot("Move down")}}}},tools:{list:{class:List,inlineToolbar:!0},image:{class:ImageTool,config:{uploader:{uploadByFile(e){let s=new FormData;return s.append("file",e),new Promise((e=>{t.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:s,type:"POST",success:function(t){"success"==(t=JSON.parse(t))[0]?e({success:1,file:{url:t[1]}}):console.log(t)}})}))}}}},header:Header,code:CodeTool,raw:RawTool},onReady:()=>{K=!1},minHeight:50})}}function pt(t){let e="";return t.map((t=>{switch(t.type){case"header":e+=`<h${t.data.level}>${t.data.text}</h${t.data.level}>`;break;case"paragraph":e+=`<p>${t.data.text}</p>`;break;case"image":e+=`<img class="img-fluid" src="${t.data.file.url}" title="${t.data.caption}" /><em>${t.data.caption}</em>`;break;case"list":e+='<ul class="sb-ul-'+t.data.style+'">',t.data.items.forEach((function(t){e+=`<li>${t}</li>`})),e+="</ul>";break;case"code":e+=`<code>${t.data.code}</code>`;break;case"raw":e+=`<div class="bxc-raw-html">${t.data.html}</div>`}})),e}function ft(){typeof Z.destroy!==Y&&(Z.destroy(),Z=!1)}t.fn.miniTip=function(s){var i=t.extend({title:"",content:!1,delay:100,anchor:"n",event:"hover",fadeIn:100,fadeOut:300,aHide:!0,maxW:"250px",offset:4,stemOff:0,doHide:!1},s);0==e.find("#miniTip").length&&e.append('<div id="miniTip" class="sb-tooltip"><div></div></div>');var a=e.find("#miniTip"),n=a.find("div");return i.doHide?(a.stop(!0,!0).fadeOut(i.fadeOut),!1):this.each((function(){var e=t(this),s=i.content?i.content:e.attr("title");if(""!=s&&void 0!==s){window.delay=!1;var o=!1,r=!0;i.content||e.removeAttr("title"),"hover"==i.event?(e.hover((function(){a.removeAttr("click"),r=!0,l.call(this)}),(function(){r=!1,c()})),i.aHide||a.hover((function(){o=!0}),(function(){o=!1,setTimeout((function(){r||a.attr("click")||c()}),20)}))):"click"==i.event&&(i.aHide=!0,e.click((function(){return a.attr("click","t"),a.data("last_target")!==e||"none"==a.css("display")?l.call(this):c(),a.data("last_target",e),t("html").unbind("click").click((function(e){"block"!=a.css("display")||t(e.target).closest("#miniTip").length||(t("html").unbind("click"),c())})),!1})));var l=function(){i.show&&i.show.call(this,i),i.content&&""!=i.content&&(s=i.content),n.html(s),i.render&&i.render(a),a.hide().width("").width(a.width()).css("max-width",i.maxW);var o=e.is("area");if(o){var r,l=[],c=[],d=e.attr("coords").split(",");function A(t,e){return t-e}for(r=0;r<d.length;r++)l.push(d[r++]),c.push(d[r]);var u=t("img[usemap=\\#"+e.parent().attr("name")+"]").offset(),h=parseInt(u.left,10)+parseInt((parseInt(l.sort(A)[0],10)+parseInt(l.sort(A)[l.length-1],10))/2,10),p=parseInt(u.top,10)+parseInt((parseInt(c.sort(A)[0],10)+parseInt(c.sort(A)[c.length-1],10))/2,10)}else p=parseInt(e.offset().top,10),h=parseInt(e.offset().left,10);var f=o?0:parseInt(e.outerWidth(),10),g=o?0:parseInt(e.outerHeight(),10),b=a.outerWidth(),v=a.outerHeight(),m=Math.round(h+Math.round((f-b)/2)),S=Math.round(p+g+i.offset+8),w=Math.round(b-16)/2-parseInt(a.css("borderLeftWidth"),10),_=0,y=h+f+b+i.offset+8>parseInt(t(window).width(),10),x=b+i.offset+8>h,B=v+i.offset+8>p-t(window).scrollTop(),k=p+g+v+i.offset+8>parseInt(t(window).height()+t(window).scrollTop(),10),C=i.anchor;x||"e"==i.anchor&&!y?"w"!=i.anchor&&"e"!=i.anchor||(C="e",_=Math.round(v/2-8-parseInt(a.css("borderRightWidth"),10)),w=-8-parseInt(a.css("borderRightWidth"),10),m=h+f+i.offset+8,S=Math.round(p+g/2-v/2)):(y||"w"==i.anchor&&!x)&&("w"!=i.anchor&&"e"!=i.anchor||(C="w",_=Math.round(v/2-8-parseInt(a.css("borderLeftWidth"),10)),w=b-parseInt(a.css("borderLeftWidth"),10),m=h-b-i.offset-8,S=Math.round(p+g/2-v/2))),k||"n"==i.anchor&&!B?"n"!=i.anchor&&"s"!=i.anchor||(C="n",_=v-parseInt(a.css("borderTopWidth"),10),S=p-(v+i.offset+8)):(B||"s"==i.anchor&&!k)&&("n"!=i.anchor&&"s"!=i.anchor||(C="s",_=-8-parseInt(a.css("borderBottomWidth"),10),S=p+g+i.offset+8)),"n"==i.anchor||"s"==i.anchor?b/2>h?(m=m<0?w+m:w,w=0):h+b/2>parseInt(t(window).width(),10)&&(m-=w,w*=2):B?(S+=_,_=0):k&&(S-=_,_*=2),delay&&clearTimeout(delay),delay=setTimeout((function(){a.css({"margin-left":m+"px","margin-top":S+"px"}).stop(!0,!0).fadeIn(i.fadeIn)}),i.delay),a.attr("class","sb-tooltip "+C)},c=function(){(i.aHide||o)&&!i.aHide||(delay&&clearTimeout(delay),delay=setTimeout((function(){d()}),i.delay))},d=function(){!i.aHide&&!o||i.aHide?(a.stop(!0,!0).fadeOut(i.fadeOut),i.hide&&i.hide.call(this)):setTimeout((function(){c()}),200)}}}))},t.fn.sbLanguageSwitcher=function(e=[],s="",i=!1){let a=`<div class="sb-language-switcher" data-source="${s}">`,n=[],o=t(this).hasClass("sb-language-switcher-cnt")?t(this):t(this).find(".sb-language-switcher-cnt");for(var r=0;r<e.length;r++)n.includes(e[r])||(a+=`<span ${i==e[r]?'class="sb-active" ':""}data-language="${e[r]}"><i class="bi-x-lg"></i><img src="${STMBX_URL}/media/flags/${e[r].toLowerCase()}.png" /></span>`,n.push(e[r]));return o.find(".sb-language-switcher").remove(),o.append(a+`<i data-sb-tooltip="${ot("Add translation")}" class="bi-plus-lg"></i></div>`),o.sbInitTooltips(),this},t.fn.sbShowLightbox=function(s=!1,i=""){function a(){const e=t(this),s=e.outerHeight()/-2-25;e.css({"margin-top":s+"px","margin-left":e.outerWidth()/-2+"px"})}return e.find(".sb-lightbox").sbActive(!1),E.sbActive(!0),t(this).sbActive(!0),s?t(this).addClass("sb-popup-lightbox").attr("data-action",i):(a.call(this),t(window).on("resize",(function(){a.call(this)}))),t("body").addClass("sb-lightbox-active"),setTimeout((()=>{_t.open_popup=this}),300),this.preventDefault,this},t.fn.sbHideLightbox=function(){return t(this).find(".sb-lightbox,.sb-popup-lightbox").sbActive(!1).removeClass("sb-popup-lightbox").removeAttr("data-action"),E.sbActive(!1),t("body").removeClass("sb-lightbox-active"),_t.open_popup=!1,this},t.fn.sbInitTooltips=function(){return t(this).find("[data-sb-tooltip]").each((function(){var e=this.getBoundingClientRect().top<window.innerHeight/2?"s":"w";t(this).miniTip({content:t(this).attr("data-sb-tooltip"),anchor:e,delay:100})}))};var gt={dialogflow:{intents:!1,token:SBF.storage("dialogflow-token"),smart_reply_data:!1,smartReply:function(t){SBF.ajax({function:"dialogflow-smart-reply",message:t,smart_reply_data:this.smart_reply_data?this.smart_reply_data:{conversation_id:SBChat.conversation.id},token:this.token,dialogflow_language:[st().language?st().language:"en"],language_detection:SB_ADMIN_SETTINGS["smart-reply-language-detection"]&&SBChat.conversation&&!SBChat.conversation.getLastUserMessage(!1,!0)&&(!SB_ADMIN_SETTINGS["smart-reply-language-detection-bot"]||!SBChat.conversation.getLastUserMessage(!1,"bot"))},(t=>{let e=t.suggestions,s="",a=i.find(".sb-conversation .sb-list"),n=a[0].scrollTop===a[0].scrollHeight-a[0].offsetHeight,o=!(!SBChat.conversation||!SBChat.conversation.getLastMessage())&&SBChat.conversation.getLastMessage().message;t.token&&this.token!=t.token&&(this.token=t.token,SBF.storage("dialogflow-token",t.token));for(var r=0;r<e.length;r++)e[r]!=o&&(s+=`<span>${e[r]}</span>`);this.smart_reply_data=t.smart_reply,h.html(s),n&&SBChat.scrollBottom()}))},smartReplyUpdate:function(t,e="agent"){SBF.ajax({function:"dialogflow-smart-reply-update",message:t,smart_reply_data:this.smart_reply_data?this.smart_reply_data:{conversation_id:SBChat.conversation.id},token:this.token,dialogflow_language:[st().language],user_type:e})},showCreateIntentBox:function(t){let e="",s=SBChat.conversation.getMessage(t),i=s.message;if(SBF.isAgent(s.get("user_type")))e=SBChat.conversation.getLastUserMessage(s.get("index")),e&&e.payload("sb-human-takeover")&&(e=SBChat.conversation.getLastUserMessage(e.get("index"))),e=0==e?"":e.message;else{e=i;let t=SBChat.conversation.messages;for(var a=s.get("index");a<t.length;a++)if(["agent","admin"].includes(t[a].get("user_type"))){i=t[a].message;break}}!1===this.intents&&SBF.ajax({function:"dialogflow-get-intents"},(t=>{let e="";if(Array.isArray(t)){for(var s=0;s<t.length;s++)e+=`<option value="${t[s].name}">${t[s].displayName}</option>`;u.find("#sb-intents-select").append(e),this.intents=t}else this.intents=[]})),u.attr("data-message-id",s.id),u.find(".sb-type-text:not(.sb-first)").remove(),u.find(".sb-type-text input").val(e),u.find("textarea").val(i),u.find("#sb-intents-select").val(""),u.find(".sb-search-btn").sbActive(!1).find("input").val(""),this.searchIntents(""),u.sbShowLightbox()},submitIntent:function(s){if(nt(s))return;let i=[],a=u.find("textarea").val(),n=u.find("#sb-intents-select").val();u.find(".sb-type-text input").each((function(){t(this).val()&&i.push(t(this).val())})),""==a&&!n||0==i.length?(SBForm.showErrorMessage(u,"Please insert the bot response and at least one user expression."),t(s).sbLoading(!1)):SBF.ajax({function:""==n?"dialogflow-create-intent":"dialogflow-update-intent",expressions:i,response:a,agent_language:u.find(".sb-dialogflow-languages select").val(),conversation_id:SBChat.conversation.id,intent_name:n},(i=>{if(t(s).sbLoading(!1),!0===i)e.sbHideLightbox(),et(""==n?"Intent created":"Intent updated");else{let t="Error";"error"in i&&"message"in i.error&&(t=i.error.message),SBForm.showErrorMessage(u,t)}}))},searchIntents:function(t){t=t.toLowerCase(),SBF.search(t,(()=>{let e=!(t.length>1),s=e?`<option value="">${ot("New Intent")}</option>`:"",i=this.intents;for(var a=0;a<i.length;a++){let r=e||i[a].displayName.toLowerCase().includes(t);if(!r&&"trainingPhrases"in i[a]){let e=i[a].trainingPhrases;for(var n=0;n<e.length;n++){for(var o=0;o<e[n].parts.length;o++)if(e[n].parts[o].text.toLowerCase().includes(t)){r=!0;break}if(r)break}}r&&(s+=`<option value="${i[a].name}">${i[a].displayName}</option>`)}u.find("#sb-intents-select").html(s).change()}))},previewIntent:function(t){let e="";for(var s=0;s<this.intents.length;s++)if(this.intents[s].name==t){let t="trainingPhrases"in this.intents[s]?this.intents[s].trainingPhrases:[],n=t.length;if(n>1){for(var i=0;i<n;i++)for(var a=0;a<t[i].parts.length&&(e+=`<span>${t[i].parts[a].text}</span>`,15!=a);a++);it(e,"info",!1,"intent-preview-box","",n>10)}break}},translate:function(t,e,s){t.length&&SBF.ajax({function:"google-translate",strings:t,language_code:e,token:this.token},(t=>{if(this.token=t[1],!Array.isArray(t[0]))return SBF.error(JSON.stringify(t[0]),"SBApps.dialogflow.translate"),!1;s(t[0])}))}},messenger:{check:function(t){return["fb","ig"].includes(t.get("source"))},send:function(t,e,s="",i=[],a,n=!1){SBF.ajax({function:"messenger-send-message",psid:t,facebook_page_id:e,message:s,attachments:i,metadata:a},(t=>{n&&n(t)}))}},whatsmeow:{check:function(t){return"ww"==t.get("source")},send:function(t,e="",s=[],i=!1,a=!1,n=!1){SBF.ajax({function:"whatsmeow-send-message",to:t,message:e,attachments:s,phone_id:i},(t=>{a&&a(t)}))},activeUserPhone:function(t=st()){return!!t.getExtra("phone")&&t.getExtra("phone").value.replace("+","")}},waweb:{check:function(t){return"wx"==t.get("source")},send:function(t,e="",s=[],i=!1,a=!1,n=!1){SBF.ajax({function:"waweb-send-message",to:t,message:e,attachments:s,phone_id:i},(t=>{a&&a(t)}))},activeUserPhone:function(t=st()){return!!t.getExtra("phone")&&t.getExtra("phone").value.replace("+","")}},whatsapp:{check:function(t){return"wa"==t.get("source")},send:function(t,e="",s=[],i=!1,a=!1){SBF.ajax({function:"whatsapp-send-message",to:t,message:e,attachments:s,phone_id:i},(t=>{a&&a(t)}))},activeUserPhone:function(t=st()){return!!t.getExtra("phone")&&t.getExtra("phone").value.replace("+","")}},telegram:{check:function(t){return"tg"==t.get("source")},send:function(t,e="",s=[],i=!1){SBF.ajax({function:"telegram-send-message",chat_id:t,message:e,attachments:s},(t=>{i&&i(t)}))}},gbm:{token:!1,check:function(t){return"bm"==t.get("source")},send:function(t,e="",s=[],i=!1){SBF.ajax({function:"gbm-send-message",google_conversation_id:t,message:e,attachments:s,token:this.token},(t=>{i&&i(t),this.token=t[2]}))}},twitter:{check:function(t){return"tw"==t.get("source")},send:function(t,e="",s=[],i=!1){SBF.ajax({function:"twitter-send-message",twitter_id:t,message:e,attachments:s},(t=>{i&&i(t)}))}},is:function(t){if(typeof SB_VERSIONS==Y)return!1;switch(t){case"gbm":case"twitter":case"telegram":case"messenger":case"whatsapp":case"waweb":case"whatsmeow":case"dialogflow":case"sb":return!0}return!1}},bt={init:!1,save:function(e){if(nt(e))return;let s={},i={};switch(m.find(" > .sb-tab > .sb-nav .sb-active").attr("id")){case"tab-articles":this.articles.save((s=>{et(!0===s?"Articles and categories saved":s),t(e).sbLoading(!1)}));break;case"tab-automations":let a=B.find(".sb-active").attr("data-id");bt.automations.save((s=>{et(!0===s?"Automations saved":s),bt.automations.populate(),B.find(`[data-id="${a}"]`).click(),t(e).sbLoading(!1)}));break;case"tab-translations":this.translations.updateActive(),SBF.ajax({function:"save-translations",translations:JSON.stringify(this.translations.to_update)},(()=>{et("Translations saved"),t(e).sbLoading(!1)}));break;default:m.find(".sb-setting").each(((e,a)=>{let n=this.get(a),o=t(a).data("setting");if(n[0])if(typeof o!=Y){let e=!1;if(t(a).find("[data-language]").length){let s=t(a).find("[data-language].sb-active");if(e=n[0]in this.translations.originals&&this.translations.originals[n[0]],this.translations.save(a,!!s.length&&s.attr("data-language")),e&&"string"!=typeof e)for(var r in e)e[r]=[e[r],n[1][r][1]]}o in s||(s[o]={}),s[o][n[0]]=[e||n[1],n[2]]}else i[n[0]]=[n[1],n[2]]})),SBF.ajax({function:"save-settings",settings:JSON.stringify(i),external_settings:s,external_settings_translations:this.translations.translations},(()=>{et("Settings saved"),t(e).sbLoading(!1),setTimeout((()=>{location.reload()}),600)}))}},initPlugins:function(){m.find("textarea").each((function(){t(this).autoExpandTextarea(),t(this).manualExpandTextarea()})),m.find("[data-setting] .sb-language-switcher-cnt").each((function(){t(this).sbLanguageSwitcher(bt.translations.getLanguageCodes(t(this).closest("[data-setting]").attr("id")),"settings")}))},initColorPicker:function(e=!1){t(e||m).find(".sb-type-color input").colorPicker({renderCallback:function(e,s){t(e.context).closest(".input").find("input").css("background-color",e.text)}})},initHTML:function(t){if("slack-agents"in t){let s="";for(var e in t["slack-agents"][0])s+=`<div data-id="${e}"><select><option value="${t["slack-agents"][0][e]}"></option></select></div>`;m.find("#slack-agents .input").html(s)}},get:function(e){let s=(e=t(e)).attr("id"),i=e.data("type");e.attr("value");switch(i){case"upload":case"range":case"number":case"text":case"password":case"color":return[s,e.find("input").val(),i];case"textarea":return[s,e.find("textarea").val(),i];case"select":return[s,e.find("select").val(),i];case"checkbox":return[s,e.find("input").is(":checked"),i];case"radio":let a=e.find("input:checked").val();return SBF.null(a)&&(a=""),[s,a,i];case"upload-image":let n=e.find(".image").attr("data-value");return SBF.null(n)&&(n=""),[s,n,i];case"multi-input":let o={};return e.find(".input > div").each(((t,e)=>{let s=this.get(e);s[0]&&(o[s[0]]=[s[1],s[2]])})),[s,o,i];case"select-images":return[s,e.find(".input > .sb-active").data("value"),i];case"repeater":return[s,this.repeater("get",e.find(".repeater-item"),""),i];case"double-select":let r={};return e.find(".input > div").each((function(){let e=t(this).find("select").val();-1!=e&&(r[t(this).attr("data-id")]=[e])})),[s,r,i];case"select-checkbox":return[s,e.find(".sb-select-checkbox input:checked").map((function(){return t(this).attr("id")})).get(),i];case"timetable":let l={};return e.find(".sb-timetable > [data-day]").each((function(){let e=t(this).attr("data-day"),s=[];t(this).find("> div > div").each((function(){let e=t(this).html(),i=t(this).attr("data-value");SBF.null(i)?s.push(["",""]):"closed"==i?s.push(["closed","Closed"]):s.push([i,e])})),l[e]=s})),[s,l,i];case"color-palette":return[s,e.attr("data-value"),i]}return["","",""]},set:function(e,s){let i=t(s)[1],a=t(s)[0];switch(e=`#${e}`,i){case"color":case"upload":case"number":case"text":case"password":m.find(`${e} input`).val(a);break;case"textarea":m.find(`${e} textarea`).val(a);break;case"select":m.find(`${e} select`).val(a);break;case"checkbox":m.find(`${e} input`).prop("checked","false"!=a&&a);break;case"radio":m.find(`${e} input[value="${a}"]`).prop("checked",!0);break;case"upload-image":a&&m.find(e+" .image").attr("data-value",a).css("background-image",`url("${a}")`);break;case"multi-input":for(var n in a)this.set(n,a[n]);break;case"range":let s=a;m.find(e+" input").val(s),m.find(e+" .range-value").html(s);break;case"select-images":m.find(e+" .input > div").sbActive(!1),m.find(e+` .input > [data-value="${a}"]`).sbActive(!0);break;case"select-checkbox":for(var o=0;o<a.length;o++)m.find(`input[id="${a[o]}"]`).prop("checked",!0);m.find(e+" .sb-select-checkbox-input").val(a.join(", "));break;case"repeater":let i=this.repeater("set",a,m.find(e+" .repeater-item:last-child"));i&&m.find(e+" .sb-repeater").html(i);break;case"double-select":for(var n in a)m.find(`${e} .input > [data-id="${n}"] select`).val(a[n]);break;case"timetable":for(var n in a){let s=m.find(`${e} [data-day="${n}"] > div > div`);for(o=0;o<s.length;o++)t(s[o]).attr("data-value",a[n][o][0]).html(a[n][o][1])}break;case"color-palette":a&&m.find(e).attr("data-value",a)}},repeater:function(e,s,i){if(i=t(i).html(),"set"==e){var a="";if(s.length>0){t(i).find(".bi-x-lg").remove();for(var n=0;n<s.length;n++){let e=t(t.parseHTML(`<div>${i}</div>`));for(var o in s[n])this.setInput(e.find(`[data-id="${o}"]`),s[n][o]);a+=`<div class="repeater-item">${e.html()}<i class="bi-x-lg"></i></div>`}}return a}if("get"==e){let e=[],i=this;return t(s).each((function(){let s={},a=!0;t(this).find("[data-id]").each((function(){let e=i.getInput(this);a&&e&&"hidden"!=t(this).attr("type")&&"auto-id"!=t(this).attr("data-type")&&(a=!1),s[t(this).attr("data-id")]=e})),a||e.push(s)})),e}},repeaterAdd:function(e){let s=t(e).parent();(e=t(t.parseHTML(`<div>${s.find(".repeater-item:last-child").html()}</div>`))).find("[data-id]").each((function(){if(bt.resetInput(this),"auto-id"==t(this).data("type")){let e=1;s.find('[data-type="auto-id"]').each((function(){let s=parseInt(t(this).val());s>e&&(e=s)})),t(this).attr("value",e+1)}})),s.find(".sb-repeater").append(`<div class="repeater-item">${e.html()}</div>`)},repeaterDelete:function(e){let s=t(e).parent();s.parent().find(".repeater-item").length>1?s.remove():s.find("[data-id]").each(((t,e)=>{this.resetInput(e)}))},setInput:function(e,s){if(s=t.trim(s),(e=t(e)).is("select"))e.find(`option[value="${s}"]`).attr("selected","");else if(e.is(":checkbox")&&s&&"false"!=s)e.attr("checked","");else if(e.is("textarea"))e.html(s);else{let t=e.is("div");t||e.is("i")||e.is("li")?(e.attr("data-value",s),t&&e.hasClass("image")&&e.css("background-image",s?`url("${s}")`:"")):e.attr("value",s)}},getInput:function(e){if((e=t(e)).is(":checkbox"))return e.is(":checked");if(e.is("div")||e.is("i")||e.is("li")){let t=e.attr("data-value");return SBF.null(t)?"":t}return e.val()},resetInput:function(e){(e=t(e)).is("select")?e.val("").find("[selected]").removeAttr("selected"):e.is("checkbox")&&value?e.removeAttr("checked").prop("checked",!1):e.is("textarea")?e.html(""):e.removeAttr("value").removeAttr("style").removeAttr("data-value").val("")},getSettingObject:function(e){return t(e)[0].hasAttribute("data-setting")?t(e):t(e).closest("[data-setting]")},articles:{categories:[],articles:[],translations:{},get:function(t,e=!1,s=!0){SBF.ajax({function:"get-articles",categories:e,articles_language:"all",full:s},(e=>{t(e)}))},save:function(e=!1){if(this.updateActiveArticle(),Z)if(Q)Q=!1;else if(this.activeID()&&-1!=this.activeID())return void(Q=e);S.find(".sb-new-category-cnt input").each(((e,s)=>{let i=t.trim(t(s).val());i&&this.categories.push({id:SBF.random(),title:i}),t(s).parents().eq(1).remove()})),this.categories.length&&this.categories.sort((function(t,e){return t.title.localeCompare(e.title)})),SBF.ajax({function:"save-articles",articles:this.articles,translations:this.translations,categories:this.categories.length?this.categories:"delete_all"},(t=>{S.find(".sb-menu-wide .sb-active").click(),S.find(`.sb-nav [data-id="${this.activeID()}"]`).click(),this.updateSelect(),e&&e(t)})),gt.is("dialogflow")&&SBF.ajax({function:"dialogflow-knowledge",articles:this.articles})},show:function(e=!1,s=!1,i=!1){let a=[-1,"","","",""];this.updateActiveArticle(),this.hide(!1);let n=i?i in this.translations?this.translations[i]:[]:this.articles;!1===e&&(e=this.activeID());for(var o=0;o<n.length;o++)if(n[o].id==e){a=[e,n[o].title,n[o].content,n[o].link,SBF.null(n[o].categories)?[""]:n[o].categories,SBF.null(n[o].parent_category)?"":n[o].parent_category,n[o].editor_js],s&&(t(s).siblings().sbActive(!1),t(s).sbActive(!0));break}w.val(""),_.val(a[5]);for(o=0;o<a[4].length;o++)w.eq(o).val(a[4][o]);S.sbLanguageSwitcher(this.getTranslations(e),"articles",i),S.find(".sb-content").attr("data-id",a[0]),S.find(".sb-article-title input").val(a[1]),S.find(".sb-article-link input").val(a[3]),S.find("#sb-article-id").html(`ID <span>${a[0]}</span>`),Z||S.find("#editorjs").length?ht(a[6]?a[6]:a[2]):S.find(".sb-article-content textarea").val(a[2])},add:function(){let t=S.find(".sb-nav > ul"),e=SBF.random();this.updateActiveArticle(),this.articles.push({id:e,title:"",content:"",link:"",categories:[]}),this.hide(!1),t.find(".sb-active").sbActive(!1),t.find(".sb-no-results").remove(),t.append(`<li class="sb-active" data-id="${e}">${ot("Article")} ${t.find("li").length+1}<i class="bi-trash"></i></li>`),S.find("input, textarea, select").val(""),S.find(".sb-content").attr("data-id",e),S.sbLanguageSwitcher([],"articles"),ht()},addCategory:function(){S.find('[data-type="categories"] .sb-no-results').remove(),S.find(".sb-new-category-cnt").append('<div class="sb-input-setting sb-type-text"><div><input type="text"></div></div>')},delete:function(e,s=!1){let i=t(e).closest(".sb-nav").find(" > ul"),a=t(e).parent(),n=a.attr("data-id");for(var o in this[s?"categories":"articles"].splice(a.index(),1),this.hide(),i.find("li").length>1?t(e).parent().remove():i.html(`<li class="sb-no-results">${ot("No results found.")}</li>`),this.translations)for(var r=0;r<this.translations[o].length;r++)this.translations[o][r].id===n&&this.translations[o].splice(r,1);s||ft()},populate:function(t=!1,e=!1){if(!1===t&&(t=e?this.categories:this.articles),Array.isArray(t)){let i="";if(e?this.categories=t:this.articles=t,t.length)for(var s=0;s<t.length;s++)i+=`<li data-id="${t[s].id}">${e?"<span>"+t[s].id+"</span>":""}${t[s].title}<i class="bi-trash${e?" sb-category":""}"></i></li>`;else i=`<li class="sb-no-results">${ot("No results found.")}</li>`;S.find(".sb-add-category,.sb-new-category-cnt").sbActive(e),S.find(".sb-add-article").sbActive(!e),S.find(".sb-nav").attr("data-type",e?"categories":"articles"),S.find(".sb-nav > ul").html(i),this.hide()}else SBF.error(t,"SBSettings.articles.populate")},updateActiveArticle:function(){let e=this.activeID();if(-1!=e){let i=S.find(".sb-language-switcher [data-language].sb-active").attr("data-language"),a=i?i in this.translations?this.translations[i]:[]:this.articles,n=[];w.each((function(){t(this).val()&&n.push(t(this).val())}));for(var s=0;s<a.length;s++)if(a[s].id==e){article={id:e,title:S.find(".sb-article-title input").val(),content:S.find(".sb-article-content textarea").val(),link:S.find(".sb-article-link input").val(),categories:n,parent_category:_.val()},Z&&typeof Z.save!==Y?Z.save().then((t=>{article.editor_js=t,article.content=pt(t.blocks),a[s]=article,Q&&this.save(Q)})).catch((t=>{console.log(t)})):a[s]=article,SBF.null(article.title)&&this.delete(S.find(`.sb-nav [data-id="${e}"] i`));break}}},updateSelect:function(){let e=[],s=_.val(),i='<option value=""></option>';w.each((function(){e.push(t(this).val())}));for(var a=0;a<this.categories.length;a++)i+=`<option value="${this.categories[a].id}">${this.categories[a].title}</option>`;w.html(i),_.html(i),_.val(s);for(a=0;a<e.length;a++)w.eq(a).val(e[a])},addTranslation:function(t=!1,e){if(!1===t&&(t=this.activeID()),this.getTranslations(t).includes(t))return console.warn("Article translation already in array.");e in this.translations||(this.translations[e]=[]),this.translations[e].push({id:t,title:"",content:"",link:"",categories:[]})},getTranslations:function(t=!1){let e=[];for(var s in!1===t&&(t=this.activeID()),this.translations){let a=this.translations[s];for(var i=0;i<a.length;i++)if(a[i].id==t){e.push(s);break}}return e},deleteTranslation:function(t=!1,e){if(!1===t&&(t=this.activeID()),e in this.translations){let i=this.translations[e];for(var s=0;s<i.length;s++)if(i[s].id==t)return this.translations[e].splice(s,1),!0}return!1},activeID:function(){return S.find(".sb-content").attr("data-id")},hide:function(t=!0){S.find(".sb-content").setClass("sb-hide",t)}},automations:{items:{messages:[],emails:[],sms:[],popups:[],design:[],more:[]},translations:{},conditions:{datetime:["Date time",["Is between","Is exactly"],"dd/mm/yyy hh:mm - dd/mm/yyy hh:mm"],repeat:["Repeat",["Every day","Every week","Every month","Every year"]],browsing_time:["Browsing time",[],"seconds"],scroll_position:["Scroll position",[],"px"],include_urls:["Include URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],exclude_urls:["Exclude URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],referring:["Referring URLs",["Contains","Does not contain","Is exactly","Is not"],"URLs parts separated by commas"],user_type:["User type",["Is visitor","Is lead","Is user","Is not visitor","Is not lead","Is not user"]],returning_visitor:["Returning visitor",["First time visitor","Returning visitor"]],countries:["Countries",[],"Country codes separated by commas"],languages:["Languages",[],"Language codes separated by commas"],cities:["Cities",[],"Cities separated by commas"],custom_variable:["Custom variable",[],"variable=value"]},get:function(t){SBF.ajax({function:"automations-get"},(e=>{this.items=e[0],this.translations=Array.isArray(e[1])&&!e[1].length?{}:e[1],t(e)}))},save:function(t=!1){this.updateActiveItem(),SBF.ajax({function:"automations-save",automations:this.items,translations:this.translations},(e=>{t&&t(e)}))},show:function(t=!1,e=!1){this.updateActiveItem();let s=e?e in this.translations?this.translations[e]:[]:this.items,i=y.find(" > .sb-tab > .sb-content");for(var a in!1===t&&(t=this.activeID()),this.hide(!1),s)for(var n=0;n<s[a].length;n++){let o=s[a][n],r=o.conditions;if(o.id==t){for(var a in k.html(""),o){let t=i.find(`[data-id="${a}"]`);t.hasClass("image")?(t.css("background-image",`url(${o[a]})`).attr("data-value",o[a]),""==o[a]&&t.removeAttr("data-value")):"checkbox"==t.attr("type")?t.prop("checked",o[a]):t.val(o[a])}if(r)for(var a in r){this.addCondition();let t=k.find(" > div:last-child");t.find("select").val(r[a][0]),this.updateCondition(t.find("select")),t.find(" > div").eq(1).find("select,input").val(r[a][1]),r[a].length>2&&t.find(" > div").eq(2).find("input").val(r[a][2])}return k.parent().setClass("sb-hide",e),i.sbLanguageSwitcher(this.getTranslations(t),"automations",e),!0}}return!1},add:function(){let t=SBF.random(),e=`${ot("Item")} ${B.find("li:not(.sb-no-results)").length+1}`;this.updateActiveItem(),this.items[this.activeType()].push(this.itemArray(this.activeType(),t,e)),this.hide(!1),B.find(".sb-active").sbActive(!1),B.find(".sb-no-results").remove(),B.append(`<li class="sb-active" data-id="${t}">${e}<i class="bi-trash"></i></li>`),y.find(".sb-automation-values").find("input, textarea").val(""),y.sbLanguageSwitcher([],"automations"),k.html("")},delete:function(e){this.items[this.activeType()].splice(t(e).parent().index(),1),t(e).parent().remove(),this.hide(),0==this.items[this.activeType()].length&&B.html(`<li class="sb-no-results">${ot("No results found.")}</li>`)},populate:function(t=!1){!1===t&&(t=this.activeType());let e="",s=this.items[t];if(this.updateActiveItem(),s.length)for(var i=0;i<s.length;i++)e+=`<li data-id="${s[i].id}">${s[i].name}<i class="bi-trash"></i></li>`;else e=`<li class="sb-no-results">${ot("No results found.")}</li>`;switch(B.html(e),e="",t){case"emails":e=`<h2>${ot("Subject")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="subject" type="text"></div></div>`;break;case"popups":e=`<h2>${ot("Title")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="title" type="text"></div></div><h2>${ot("Profile image")}</h2><div data-type="upload-image" class="sb-input-setting sb-type-upload-image"><div class="input"><div data-id="profile_image" class="image"><i class="bi-x-lg"></i></div></div></div><h2>${ot("Message fallback")}</h2><div class="sb-input-setting sb-type-checkbox"><div><input data-id="fallback" type="checkbox"></div></div>`;break;case"design":e=`<h2>${ot("Header title")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="title" type="text"></div></div>`;for(i=1;i<4;i++)e+=`<h2>${ot((1==i?"Primary":2==i?"Secondary":"Tertiary")+" color")}</h2><div data-type="color" class="sb-input-setting sb-type-color"><div class="input"><input data-id="color_${i}" type="text"><i class="sb-close bi-x-lg"></i></div></div>`;for(i=1;i<4;i++)e+=`<h2>${ot(1==i?"Header background image":2==i?"Header brand image":"Chat button icon")}</h2><div data-type="upload-image" class="sb-input-setting sb-type-upload-image"><div class="input"><div data-id="${1==i?"background":2==i?"brand":"icon"}" class="image"><i class="bi-x-lg"></i></div></div></div>`;break;case"more":e=`<h2>${ot("Department ID")}</h2><div class="sb-input-setting sb-type-number"><div><input data-id="department" type="number"></div></div><h2>${ot("Agent ID")}</h2><div class="sb-input-setting sb-type-number"><div><input data-id="agent" type="number"></div></div><h2>${ot("Tags")}</h2><div class="sb-input-setting sb-type-text"><div><input data-id="tags" type="text"></div></div>`}y.find(".sb-automation-extra").html(e),y.attr("data-automation-type",t),bt.initColorPicker(y),this.hide()},updateActiveItem:function(){let e=this.activeID();if(e){let i=y.find(".sb-language-switcher [data-language].sb-active").attr("data-language"),a=this.activeType(),n=i?i in this.translations?this.translations[i][a]:[]:this.items[a],o=k.find(" > div");for(var s=0;s<n.length;s++)if(n[s].id==e){n[s]={id:e,conditions:[]},y.find(".sb-automation-values").find('input,textarea,[data-type="upload-image"] .image').each((function(){n[s][t(this).attr("data-id")]=t(this).hasClass("image")&&t(this)[0].hasAttribute("data-value")?t(this).attr("data-value"):"checkbox"==t(this).attr("type")?t(this).is(":checked"):t(this).val()})),o.each((function(){let e=[];t(this).find("input,select").each((function(){e.push(t(this).val())})),e[0]&&e[1]&&(2==e.length||e[2])&&n[s].conditions.push(e)})),SBF.null(n[s].name)&&this.delete(B.find(`[data-id="${e}"] i`));break}}},addCondition:function(){k.append(`<div><div class="sb-input-setting sb-type-select sb-condition-1"><select>${this.getAvailableConditions()}</select></div></div>`)},updateCondition:function(e){t(e).parent().siblings().remove();let s=t(e).parents().eq(1);if(t(e).val()){let a=this.conditions[t(e).val()],n="";if(a[1].length){n='<div class="sb-input-setting sb-type-select sb-condition-2"><select>';for(var i=0;i<a[1].length;i++)n+=`<option value="${SBF.stringToSlug(a[1][i])}">${ot(a[1][i])}</option>`;n+="</select></div>"}s.append(n+(a.length>2?`<div class="sb-input-setting sb-type-text"><input placeholder="${ot(a[2])}" type="text"></div>`:"")),s.siblings().find(".sb-condition-1 select").each((function(){let e=t(this).val();t(this).html(bt.automations.getAvailableConditions(e)),t(this).val(e)}))}else s.remove()},getAvailableConditions:function(e=""){let s='<option value=""></option>',i=[];for(var a in k.find(".sb-condition-1 select").each((function(){i.push(t(this).val())})),this.conditions)i.includes(a)&&a!=e||(s+=`<option value="${a}">${ot(this.conditions[a][0])}</option>`);return s},addTranslation:function(t=!1,e=!1,s){if(!1===t&&(t=this.activeID()),!1===e&&(e=this.activeType()),this.getTranslations(t).includes(t))return console.warn("Automation translation already in array.");s in this.translations||(this.translations[s]={messages:[],emails:[],sms:[],popups:[],design:[]}),e in this.translations[s]||(this.translations[s][e]=[]),this.translations[s][e].push(this.itemArray(e,t))},getTranslations:function(t=!1){let e=[];for(var s in!1===t&&(t=this.activeID()),this.translations){let n=this.translations[s];for(var i in n){let o=n[i];for(var a=0;a<o.length;a++)if(o[a].id==t){e.push(s);break}}}return e},deleteTranslation:function(t=!1,e){if(!1===t&&(t=this.activeID()),e in this.translations){let a=this.translations[e];for(var s in a){let n=a[s];for(var i=0;i<n.length;i++)if(n[i].id==t)return this.translations[e][s].splice(i,1),!0}}return!1},activeID:function(){let t=B.find(".sb-active");return!!t.length&&t.attr("data-id")},activeType:function(){return x.find("li.sb-active").data("value")},itemArray:function(e,s,i="",a=""){return t.extend({id:s,name:i,message:a},"emails"==e?{subject:""}:"popups"==e?{title:"",profile_image:""}:"design"==e?{title:"",color_1:"",color_2:"",color_3:"",background:"",brand:"",icon:""}:{})},hide:function(t=!0){y.find(" > .sb-tab > .sb-content").setClass("sb-hide",t)}},translations:{translations:{},originals:{},to_update:{},add:function(t){let e=bt.getSettingObject($),s=e.attr("id"),i=$.find("[data-language].sb-active");this.save(e,!!i.length&&i.attr("data-language")),e.find('textarea,input[type="text"]').val(""),this.save(e,t),$.remove(),e.sbLanguageSwitcher(this.getLanguageCodes(s),"settings",t)},delete:function(t,e){let s=(t=bt.getSettingObject(t)).attr("id");delete this.translations[e][s],t.find(`.sb-language-switcher [data-language="${e}"]`).remove(),this.activate(t)},activate:function(t,e=!1){let s=(t=bt.getSettingObject(t)).attr("id"),i=e?this.translations[e][s]:this.originals[s];if("string"==typeof i)t.find("input, textarea").val(i);else for(var a in i)t.find("#"+a).find("input, textarea").val("string"==typeof i[a]?i[a]:i[a][0])},updateActive:function(){let e=m.find(".sb-translations-list"),s={front:{},admin:{},"admin/js":{},"admin/settings":{}},i=e.attr("data-value");if(!SBF.null(i)){for(var a in s)e.find(' > [data-area="'+a+'"] .sb-input-setting:not(.sb-new-translation)').each((function(){s[a][t(this).find("label").html()]=t(this).find("input").val()})),e.find('> [data-area="'+a+'"] .sb-new-translation').each((function(){let e=t(this).find("input:first-child").val(),i=t(this).find("input:last-child").val();e&&i&&(s[a][e]=i)}));this.to_update[i]=s}},save:function(e,s=!1){e=bt.getSettingObject(e);let i={},a=t(e).attr("id");"multi-input"==e.data("type")?e.find(".multi-input-textarea,.multi-input-text").each((function(){i[t(this).attr("id")]=t(this).find("input, textarea").val()})):i=e.find("input, textarea").val(),s?(s in this.translations||(this.translations[s]={}),this.translations[s][a]=i):this.originals[a]=i},load:function(t){let e=m.find(".sb-translations > .sb-content");e.find(" > .sb-hide").removeClass("sb-hide"),this.updateActive(),SBF.ajax({function:"get-translation",language_code:t},(s=>{t in this.to_update&&(s=this.to_update[t]);let i="",a=["front","admin","admin/js","admin/settings"];for(var n=0;n<a.length;n++){let t=s[a[n]];for(var o in i+=`<div${n?"":' class="sb-active"'} data-area="${a[n]}">`,t)i+=`<div class="sb-input-setting sb-type-text"><label>${o}</label><div><input type="text" value="${t[o]}"></div></div>`;i+="</div>"}e.find(".sb-translations-list").attr("data-value",t).html(i),e.find(".sb-menu-wide li").sbActive(!1).eq(0).sbActive(!0),e.sbLoading(!1)})),e.sbLoading(!0)},getLanguageCodes:function(t){let e=[];for(var s in this.translations)t in this.translations[s]&&e.push(s);return e}}},vt={chart:!1,active_report:!1,initChart:function(t,e="line",s=1){let i=[],a=[],n=["#0eacb2","#299fb1","#4492b0","#5d86ae","#7379ac","#867cae","#9b70ad","#b06bae","#c465af","#d65fb1"];for(var o in t)i.push(t[o][0]),a.push(o);if("line"!=e&&i.length>6)for(var r=0;r<i.length;r++)n.push("hsl(210, "+Math.floor(100*Math.random())+"%, "+Math.floor(100*Math.random())+"%)");this.chart&&this.chart.destroy(),this.chart=new Chart(C.find("canvas"),{type:e,data:{labels:a,datasets:[{data:i,backgroundColor:"line"==e?"#d4e7e952":n,borderColor:"line"==e?"#5c00ff":n,borderWidth:1}]},options:{legend:{display:!1},scales:{yAxes:[{ticks:{callback:function(t,e,i){return 1==s?t:2==s?new Date(1e3*t).toISOString().substr(11,8):t},beginAtZero:!0}}],xAxes:[{ticks:{beginAtZero:!0}}]},tooltips:{callbacks:{label:function(t,e){let a=t.index,n=e.datasets[0].data[a];switch(s){case 1:return n;case 2:return new Date(1e3*i[a]).toISOString().substr(11,8);case 3:return n+"%";case 4:let t=C.find(".sb-table tbody tr").eq(a).find("td");return t.eq(0).text()+" "+t.eq(1).text()}}},displayColors:!1}}})},initTable:function(t,e,s=!1){let i="<thead><tr>",a=e[Object.keys(e)[0]].length-1,n=[];for(var o=0;o<t.length;o++)i+=`<th>${t[o]}</th>`;for(var r in i+="</tr></thead><tbody>",e)0!=e[r][a]&&n.push([r,e[r][a]]);s&&n.reverse();for(o=0;o<n.length;o++)i+=`<tr><td><div>${n[o][0]}</div></td><td>${n[o][1]}</td></tr>`;i+="</tbody>",C.find("table").html(i)},initReport:function(e=!1,s=!1){let i=C.find(".sb-tab > .sb-content");s=SBF.null(s)?[!1,!1]:s.split(" - "),i.sbLoading(!0),e&&(this.active_report=e),this.active_report&&this.getData(this.active_report,s[0],s[1],(e=>{0==e?i.addClass("sb-no-results-active"):(i.removeClass("sb-no-results-active"),"status-client"==this.active_report?(i.addClass("sb-results-active"),i.find("#"+this.active_report).attr("style","display:block!important"),i.find(".sb-reports-tags .sb-tags").html(""),tt.forEach((s=>{let a=s,n=e.data.filter((t=>t.label==a)),o="";n.map((t=>{let s="";e.extra.map((e=>{e.user_id==t.user_id&&(s+=`<li class="add-user agent-name-tags">${e.first_name}</li>`)})),o+=`<div class="sb-responsive-tags">${t.first_name} ${t.last_name}<section class="flex-agents">${s}</section></div>`}));let r=t('<div style="min-width: 180px;max-width: 554px;" class="sb-tags-details sb-hide"></div>');""!==o.trim()&&r.removeClass("sb-hide"),r.append(`<div>\n\t\t\t\t\t\t\t\t<h4 class="title-tags tags-${a}">\n\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t<i class="sb-icon bi-crosshair tags-${a}"></i>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="white-title-elements">\n\t\t\t\t\t\t\t\t\t\t${a.toUpperCase()}(${n.length})\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t\t\t<div class="arrow-down-tags white-title-elements">\n\t\t\t\t\t\t\t\t\t\t\t<i class="bi-check-lg"></i>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</h4>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div style="overflow: scroll;max-height: 420px;">${o}</div>`),i.find(".sb-reports-tags .sb-tags").append(r)}))):(i.removeClass("sb-results-active"),i.find("#status-client").attr("style","display:none!important")),e.chart_type&&(this.initChart(e.data,e.chart_type,e.label_type),this.initTable(e.table,e.data,e["table-inverse"])),C.find(".sb-reports-title").html(e.title),C.find(".sb-reports-text").html(e.description),C.find(".bi-chevron-down").remove(),P||rt(C.find(".sb-collapse"),C.find("canvas").outerHeight()-135)),i.sbLoading(!1)}))},getData:function(t,e=!1,s=!1,i){SBF.ajax({function:"reports",name:t,date_start:e,date_end:s},(t=>{i(t)}))},initDatePicker:function(){let t={ranges:{},applyClass:"reports-datepicker",locale:{format:"DD/MM/YYYY",separator:" - ",applyClass:"reports-datepicker",applyLabel:ot("Apply"),cancelLabel:ot("Cancel"),fromLabel:ot("From"),toLabel:ot("To"),weekLabel:ot("W"),daysOfWeek:[ot("Su"),ot("Mo"),ot("Tu"),ot("We"),ot("Th"),ot("Fr"),ot("Sa")],monthNames:[ot("January"),ot("February"),ot("March"),ot("April"),ot("May"),ot("June"),ot("July"),ot("August"),ot("September"),ot("October"),ot("November"),ot("December")],firstDay:1},showCustomRangeLabel:!1,alwaysShowCalendars:!0,autoApply:!0};t.ranges[ot("Today")]=[moment(),moment()],t.ranges[ot("Yesterday")]=[moment().subtract(1,"days"),moment().subtract(1,"days")],t.ranges[ot("Last 3 Days")]=[moment().subtract(2,"days"),moment()],t.ranges[ot("Last 5 Days")]=[moment().subtract(4,"days"),moment()],t.ranges[ot("Last 7 Days")]=[moment().subtract(6,"days"),moment()],t.ranges[ot("Last 15 Days")]=[moment().subtract(14,"days"),moment()],t.ranges[ot("This Month")]=[moment().startOf("month"),moment().endOf("month")],C.find("#sb-date-picker").daterangepicker(t).val("")}},mt={real_time:null,datetime_last_user:"2000-01-01 00:00:00",sorting:["creation_time","DESC"],user_types:["visitor","lead","user"],user_main_fields:["id","first_name","last_name","email","password","profile_image","user_type","creation_time","token","last_activity","department"],search_query:"",init:!1,busy:!1,table_extra:!1,history:[],filter:function(t){t="all"==t?["visitor","lead","user"]:"agent"==t?["agent","admin"]:[t],this.user_types=t,this.loading(),q=1,O=1;let e="online"==t[0]?["get-online-users",SB_ACTIVE_AGENT.id,this.sorting[0]]:["get-users",-1,this.sorting];SBF.ajax({function:e[0],sorting:e[2],user_types:t,search:this.search_query,extra:this.table_extra},(t=>{this.populate(t),this.loading(!1)}))},sort:function(t,e="DESC"){this.sorting=[t,e],this.loading(),q=1,O=1,SBF.ajax({function:"get-users",sorting:this.sorting,user_types:this.user_types,search:this.search_query,extra:this.table_extra},(t=>{this.populate(t),this.loading(!1),console.log("Sorting completed successfully:",t)}))},search:function(e){lt(e,((e,s)=>{q=1,O=1,SBF.ajax({function:e.length>1?"search-users":"get-users",search:e,user_types:this.user_types,sorting:this.sorting,extra:this.table_extra},(i=>{this.user_types=["lead"],this.populate(i),this.search_query=e,t(s).sbLoading(!1),g.find("li").sbActive(!1).eq(0).sbActive(!0)}))}))},populate:function(e){let s="",i=e.length;if(i)for(var a=0;a<i;a++)s+=this.getRow(new SBUser(e[a],e[a].extra));else s=`<p class="sb-no-results">${ot("No users found.")}</p>`;f.parent().scrollTop(0),f.find("tbody").html(s),this.user_types.includes("agent")&&SBF.ajax({function:"get-online-users",agents:!0},(e=>{let s=[];for(var i=0;i<e.length;i++)s.push(e[i].id);f.find("[data-user-id]").each((function(){t(this).find(".sb-td-profile").addClass("sb-"+(s.includes(t(this).attr("data-user-id"))?"online":"offline"))}))}))},update:function(){if(!this.busy){let t=["user","visitor","lead","agent"],e=t.includes(this.user_types[0])&&""==this.search_query,s=g.find(".sb-active").data("type");"online"==s?this.filter(s):(this.busy=!0,SBF.ajax({function:"get-new-users",datetime:this.datetime_last_user},(i=>{let a=i.length;if(this.busy=!1,a>0){let o="";for(var n=0;n<a;n++){let t=new SBUser(i[n]);G[t.id]=t,this.updateMenu("add",t.type),e&&(o+=this.getRow(t))}if(e&&(f.find("tbody").prepend(o),t.includes(s))){let e="";for(n=0;n<t.length;n++)e+=t[n]==s?"":`[data-user-type="${t[n]}"],`;f.find(e.slice(0,-1)).remove()}this.datetime_last_user=i[0].creation_time}})))}},getRow:function(t,e){if(e=e||"",t instanceof SBUser){let e="";for(var s=0;s<this.table_extra.length;s++){let i=this.table_extra[s];e+=`<td class="sb-td-${i}">${this.user_main_fields.includes(i)?t.get(i):t.getExtra(i)}</td>`}return`<tr data-user-id="${t.id}" data-user-type="${t.type}"><td><input type="checkbox" /></td><td class="sb-td-profile"><a class="sb-profile"><img loading="lazy" src="${t.image}" class="sb-tags tags-${t.details.label}" style="max-width: 27px;max-height: 27px;padding: 2px;border:none;" /><span style="margin:0px 1px">${t.name.length>25?t.name.slice(0,25)+"...":t.name}</span></a></td>${e}<td style="overflow: hidden;max-width: 80px;text-overflow: ellipsis;overflow-wrap: break-word;" class="sb-td-email"class="sb-td-email">${t.get("email")}</td><td class="sb-td-ut">${ot(t.type)}</td><td>${SBF.beautifyTime(t.get("last_activity"),!0)}</td><td>${SBF.beautifyTime(t.get("creation_time"),!0)}</td></tr>`}return SBF.error("User not of type SBUser","SBUsers.getRow"),!1},updateRow:function(t){let s=f.find(`[data-user-id="${t.id}"]`);if(s.length){let i=g.find(".sb-active").data("type");if(i===t.type||"admin"===t.type&&"agent"===i||"all"===i){let e=this.getRow(t);s.replaceWith(e),this.updateTagsLabel(t)}else{let i=e.find(`[data-type="${"admin"===t.type?"agent":t.type}"] span`),a=parseInt(i.attr("data-count"));i.html(a+1).attr("data-count",a+1),s.remove()}}else f.find("tbody").append(this.getRow(t))},updateTagsLabel:function(e){t(`[data-user-id="${e.id}"] .sb-tags`).removeClass().addClass(`sb-tags tags-${e.details.label}`)},updateMenu:function(t="all",e=!1){let s=["all","user","agent","lead","visitor"];"all"==t?SBF.ajax({function:"count-users"},(t=>{for(var e=0;e<s.length;e++)this.updateMenuItem("set",s[e],t[s[e]])})):this.updateMenuItem(t,e)},updateMenuItem:function(t="set",e=!1,s=1){let i=g.find(`[data-type="${e}"] span`),a=["user","lead","visitor","agent"];"set"!==t&&(s=parseInt(i.attr("data-count"))+1*("add"===t?1:-1)),i.html(`<span style="vertical-align: sub;color: var(--chat-text-primary); font-weight:bold;">(${s})</span>`).attr("data-count",s),s=0;for(let t=0;t<a.length;t++)s+=parseInt(g.find(`[data-type="${a[t]}"] span`).attr("data-count"));g.find('[data-type="all"] span').html(`<span style="vertical-align: sub;color: var(--color-red); font-weight:bold;">(${s})</span>`).attr("data-count",s)},delete:function(t){this.loading(),Array.isArray(t)?SBF.ajax({function:"delete-users",user_ids:t},(()=>{for(var e=0;e<t.length;e++)delete G[t[e]],f.find(`[data-user-id="${t[e]}"]`).remove(),n.find(`[data-user-id="${t[e]}"]`).remove();0==f.find("[data-user-id]").length&&this.filter(g.find(".sb-active").data("type")),et("Users deleted"),this.updateMenu(),this.loading(!1)})):G[t].delete((()=>{let s=n.find(`[data-user-id="${t}"]`);st().id==t&&st(!1),s.sbActive()&&(SBChat.conversation=!1,setTimeout((()=>{St.clickFirst()}),300)),delete G[t],f.find(`[data-user-id="${t}"]`).remove(),s.remove(),e.sbHideLightbox(),et("User deleted"),this.updateMenu(),this.loading(!1)}))},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval((()=>{this.update()}),1e4))},stopRealTime:function(){clearInterval(this.real_time)},loading:function(t=!0){let e=p.find(".sb-loading-table");t?e.sbActive(!0):e.sbActive(!1)},csv:function(){SBF.ajax({function:"csv-users"},(t=>{const e=JSON.parse(t);let s=atob(e.file);let i=new Blob([s],{type:"data:application/octet-stream;base64"});const a=document.createElement("a");a.href=window.URL.createObjectURL(i),a.download=e.filename,document.body.appendChild(a),a.click(),document.body.removeChild(a)}))},updateUsersActivity:function(){SBF.updateUsersActivity(X?SB_ACTIVE_AGENT.id:-1,st()?st().id:-1,(function(t){mt.setActiveUserStatus("online"==t)}))},setActiveAgentStatus:function(t=!0){let e=t?"online":"offline";X=t,s.find('[data-value="status"]').html(ot(SBF.slugToString(e))).attr("class","sb-"+e),SBPusher.active&&(t?SBPusher.presence():SBPusher.presenceUnsubscribe()),SB_ADMIN_SETTINGS.reports_disabled||SBF.ajax({function:"reports-update",name:e})},setActiveUserStatus:function(t=!0){let e=i.find(".sb-conversation .sb-top > .sb-labels");e.find(".sb-status-online").remove(),t&&e.prepend(`<span class="sb-status-online">${ot("Online")}</span>`),SBChat.user_online=t},onlineUserNotification:function(t){let e=SB_ADMIN_SETTINGS["online-users-notification"];if(e){let s=t.info.first_name+" "+t.info.last_name,i=this.userProfileImage(t.info.profile_image);SB_ADMIN_SETTINGS["push-notifications"]&&"id"in t.info&&!this.history.includes(t.info.id)?SBF.ajax({function:"push-notification",title:e,message:s,icon:i,interests:SB_ACTIVE_AGENT.id,user_id:t.info.id}):St.desktop_notifications&&SBChat.desktopNotification(e,s,i,!1,t.info.id),this.history.push(t.info.id)}},userProfileImage:function(t){return!t||t.indexOf("user.svg")?SB_ADMIN_SETTINGS["notifications-icon"]:t}},St={real_time:null,datetime_last_conversation:"2000-01-01 00:00:00",user_typing:!1,desktop_notifications:!1,flash_notifications:!1,busy:!1,is_search:!1,menu_count_ajax:!1,chat_tops:[{}],open:function(t=-1,a){-1!=t&&this.openConversation(t,a),e.sbHideLightbox(),s.find(".sb-admin-nav a").sbActive(!1).parent().find("#sb-conversations").sbActive(!0),e.find(" > main > div").sbActive(!1),i.sbActive(!0).find(".sb-board").removeClass("sb-no-conversation"),this.startRealTime()},openConversation:function(e,s=!1,r=!0){if(!1===s&&e)SBF.ajax({function:"get-user-from-conversation",conversation_id:e},(t=>{SBF.null(t.id)?SBF.error("Conversation not found","SBAdmin.openConversation"):this.openConversation(e,t.id,r)}));else{let l=i.find(".sb-conversation .sb-list"),c=SBF.null(G[s])||!("email"in G[s].details),d=i.find(`[data-conversation-id="${e}"]`);l.html(""),l.sbLoading(!0),c?(st(new SBUser({id:s})),st().update((()=>{G[s]=st(),this.updateUserDetails()}))):(st(G[s]),this.updateCurrentURL()),SBPusher.active&&(SBPusher.event("client-typing",(t=>{t.user_id==st().id&&(St.typing(!0),clearTimeout(I),I=setTimeout((()=>{St.typing(!1)}),1e3))})),SBPusher.event("new-message",(()=>{SBChat.update()})),SBPusher.event("agent-active-conversation-changed",(t=>{t.previous_conversation_id==e&&i.find(".sb-conversation-busy").remove()}),"agents"),SBPusher.event("init",(t=>{St.updateCurrentURL(t.current_url)})),SBPusher.event("message-status-update",(t=>{SBChat.conversation&&SBChat.conversation.updateMessagesStatus(t.message_ids)}))),SB_ADMIN_SETTINGS["smart-reply"]&&h.html(""),n.find("li").sbActive(!1),d.sbActive(!0),-1!=e?st().getFullConversation(e,(e=>{let s=e.get("conversation_status_code"),c=o.eq(0),u=c.find(".sb-active").attr("data-value");SBChat.setConversation(e),SBChat.populate(),this.setReadIcon(s),i.find(".sb-conversation-busy").remove(),this.updateUserDetails();let p,f=e.get("profile_image"),g=e.get("first_name"),b=t(window).width();p=b<555?g.length>18?g.slice(0,18)+"...":g:g.length>27?g.slice(0,27)+"...":g;let v=st().getExtra("phone").value,m=`\n    <span style="padding-right:5px;" class="open-profile-name">\n        <img src="${f}" class="top-image-profile">\n    </span> \n    <span style="margin: 0px 10px 0px 0px;">${p}</span>\n    <span class="additional-info">${v?`<a alt="Call from your Phone" href="tel:${v}"><i class="styling-caller bi ${b<555?"bi-telephone-fill":"bi-skype"}"></i></a>`:""}</span>\n`;i.find(".sb-top > a").html(m);let S=!1;if(i.find(".sb-top > a > span").on("click",(function(){let e=t(this).next(".additional-info");S?e.hide():e.show(),S=!S})),i.find(".open-profile-name").on("click",(function(){wt.showEdit(st())})),t(".sb-list").prepend('<div class="load-more"><span id="load-more" ><i style="vertical-align:middle;font-size: var(--chat-text-size-1-0);" class="bi-arrow-up-circle"></i> </div>'),_t.must_translate=SB_ADMIN_SETTINGS.translation&&st().language&&SB_ADMIN_SETTINGS["active-agent-language"]!=st().language,_t.must_translate){let t=[],s=[],i=[];for(var w=0;w<e.messages.length;w++){let a=e.messages[w];"bot"!=a.get("user_type")&&a.message&&(t.push(a.message),s.push(a.id),i.push(a.get("user_type")))}t.length&&gt.dialogflow.translate(t,SB_ADMIN_SETTINGS["active-agent-language"],(t=>{if(t)for(var e=0;e<t.length;e++){let a=SBChat.conversation.getMessage(s[e]);a&&(a.set("translation",t[e].translatedText),l.find(`[data-id="${s[e]}"]`).replaceWith(a.getCode(!0)),l.find(`[data-id="${s[e]}"] .sb-menu`).prepend(`<li data-value="original">${ot(SBF.isAgent(i[e])?"View translation":"View original message")}</li>`))}}))}let _=i.find("#conversation-department");if(_.length){let t=_.find(`[data-id="${e.get("department")}"]`);_.find(" > p").attr("data-value",t.data("value")).html(t.html())}let y=i.find("#conversation-agent");if(y.length){let t=y.find(`[data-id="${e.get("agent_id")}"]`);y.find(" > p").attr("data-value",t.data("id")).html(t.html())}[1,2].includes(s)&&(s=0),u==s||t(a).find(".sb-search-btn").sbActive()||(c.find(`[data-value="${s}"]`).click(),c.find("ul").sbActive(!1)),P&&this.mobileOpenConversation(),d.length||u!=s&&(0!=u||1!=s)||n.prepend(St.getListCode(e).replace("<li",'<li class="sb-active"')),d.sbActive(!0),r&&this.scrollTo();let x=e.get("busy");if(x&&i.find(".sb-editor > .sb-agent-label").html(`<span data-agent="${x.id}" style="border-radius: 10px 10px 0px 0px;position: absolute;bottom: calc(100% - -1px);background: #006eff;color: #ffffff;padding: 4px 10px;font-size: var(--chat-text-size-9);left: 4px;right: 4px;text-align: center;"><b>${x.first_name} ${x.last_name}</b> ${ot("was viewing the conversation.")} <i class="bi-check-all" style="vertical-align: middle;"></i></span>`),this.tags.update(e.details.tags),this.notes.update(e.details.notes),this.attachments(),SB_ADMIN_SETTINGS["smart-reply"]){let t=e.getLastUserMessage();h.html(""),t&&t.payload("sb-human-takeover")&&(t=e.getLastUserMessage(t.get("index"))),t&&(gt.dialogflow.smart_reply_data=!1,gt.dialogflow.smartReply(t.message))}for(w=e.messages.length-1;w>0;w--){let t=e.messages[w].get("payload"),s=!1;if(t&&"rich-messages"in t)for(var B in t["rich-messages"]){let e=t["rich-messages"][B];if("rating"==e.type){i.find(".sb-profile-list > ul").append(`<li data-id="rating"><i class="sb-icon bi-${1==e.result.rating?"hand-thumbs-up-fill":"hand-thumbs-down-fill"}"></i><span>${ot("User rating")}</span></li>`),s=!0;break}}if(s)break}st().getConversations((function(t){i.find(".sb-user-conversations").html(st().getConversationsCode(t))})),l.sbLoading(!1)})):(SBChat.clear(),n.find("li").sbActive(!1),l.sbLoading(!1)),c||this.updateUserDetails(),i.find(".sb-board").removeClass("sb-no-conversation"),mt.updateUsersActivity(),this.startRealTime(),SBF.getURL("conversation")!=e&&dt("?conversation="+e)}},populate:function(t,e,s){this.openConversation(t,e,s)},populateList:function(t){let e="";M=[];let s=t;s=s.sort((function(t,e){return new Date(e.creation_time).getTime()-new Date(t.creation_time).getTime()}));for(var i=0;i<s.length;i++)e+=this.getListCode(s[i]),M.push(s[i]);""==e&&(e=`<p class="sb-no-results">${ot("No conversations found.")}</p>`),n.html(e),n.css("position","relative"),n.css("bottom","15px"),St.positionList(),this.updateMenu(),SBF.event("SBAdminConversationsLoaded",{conversations:t})},positionList(){let t=document.querySelectorAll("ul.sorting-by-last-message li"),e=0;t.forEach(((t,s)=>{let i=t.offsetHeight,a=t.getAttribute("data-conversation-id");this.chat_tops[0][a]=t.getAttribute("data-time");t.style="\n\t\t\t\tposition:relative;\n\t\t\t\twidth: -webkit-fill-available;\n\t\t\t\twidth: -moz-available;\n\t\t\t  ",e+=i}))},update:function(){if(!this.busy&&0==o.eq(0).find("p").attr("data-value")&&(this.busy=!0,SBF.ajax({function:"get-new-conversations",datetime:this.datetime_last_conversation},(e=>{if(this.busy=!1,e.length){let a,o="",r="",l=SBChat.conversation?SBChat.conversation.id:-1,c=!1,d=[];this.datetime_last_conversation=e[0].creation_time;for(var s=0;s<e.length;s++)if(!d.includes(e[s].conversation_id)){let t=e[s],u=t.conversation_status_code,h=t.user_id,p=t.conversation_id,f=l==p,g=this.getListCode(t,null),b=n.find(`[data-conversation-id="${p}"]`),v=b.index(),m=b.length,S=SBF.null(e[s].payload)?{}:JSON.parse(e[s].payload),w=t.message;const _=40;if(w.length>_){const e=w.substring(0,_)+"...";t.message=e}if(f?(g=g.replace("<li",'<li class="sb-active"'),m?(t.message&&b.replaceWith(g),M[v].conversation_status_code=u,this.setReadIcon(u)):c=!0):m&&(M[v]=t,n.find(`[data-conversation-id="${p}"]`).remove()),h in G||(G[h]=new SBUser({id:h,first_name:t.first_name,last_name:t.last_name,profile_image:t.profile_image,user_type:t.user_type})),f&&m||(2==u?(o+=g,M.unshift(t)):0!=u&&1!=u||(a=n.find('[data-conversation-status="2"]').last(),0==a.length?o+=g:(M.splice(a.index()+1,0,t),r+=g)),h==st().id&&st().getConversations((function(t){i.find(".sb-user-conversations").html(st().getConversationsCode(t))})),SBF.event("SBAdminNewConversation",{conversation:t})),st()&&("event"in S&&"update-user"==S.event||G[h].type!=t.user_type)&&st().update((()=>{this.updateUserDetails(),G[st().id]=st()})),""==t.message&&""==t.attachments||St.newMsgTop(e[s],"add"),!(SBChat.tab_active||2!=t.conversation_status_code||SBF.isAgent(t.message_user_type)&&!("preview"in S)||SBF.null(t.message)&&SBF.null(t.attachments)&&!("preview"in S))){if(this.desktop_notifications){let e=[t.first_name+" "+t.last_name,mt.userProfileImage(t.profile_image)],s=("preview"in S?S.preview:"notfimy").replace(/\*(.*?)\*/g,"*$1*").replace(/_(.*?)_/g,"_$1_").replace(/~(.*?)~/g,"~$1~").replace(/```(.*?)```/g,"```\n$1\n```").replace(/`(.*?)`/g,"`$1`").replace(/(.*?)/g,"$1");SBChat.desktopNotification(e[0],s,e[1],p,h)}this.flash_notifications&&SBChat.flashNotification(),SBChat.audio&&["a","c","ic","ag"].includes(SB_ADMIN_SETTINGS.sounds)&&SBChat.audio.play()}d.push(p)}o&&n.prepend(o),r&&t(r).insertAfter(a),c&&this.scrollTo(),this.updateMenu()}})),SB_ADMIN_SETTINGS["assign-conversation-to-agent"]||SB_ACTIVE_AGENT.department)){let e=n.find(" > li").map((function(){return t(this).attr("data-conversation-id")})).get();e.length&&SBF.ajax({function:"check-conversations-assignment",conversations_ids:e,agent_id:!!SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&SB_ACTIVE_AGENT.id,department:SB_ACTIVE_AGENT.department},(t=>{if(t)for(var e=0;e<t.length;e++)n.find(`[data-conversation-id="${t[e]}"]`).remove()}))}},updateMenu:function(){let t=n.find('[data-conversation-status="2"]').length,e=o.eq(0),s=e.find(" > a").find(" > p span"),i=document.getElementById("floatingElement");if(100==t||this.menu_count_ajax){let t=e.find("li.sb-active").data("value");this.menu_count_ajax=!0,SBF.ajax({function:"count-conversations",status_code:0==t?2:t},(t=>{s.html(`(${t})`)}))}else{if(i){i.querySelector(".notif").textContent=t}else{let e=document.createElement("div");e.id="floatingElement",e.style.cssText="position: relative; top: 10px; margin: auto; display: flex; justify-content: center; z-index: 33;";let s=document.createElement("small");s.className="notif",s.style.cssText="font-size: medium; padding: 6px 10px; border-radius: 30px;",s.textContent=t,e.appendChild(s),document.getElementById("sb-conversations").appendChild(e)}let e=document.getElementById("sb-conversations").querySelector("div");e.style.visibility=0===t?"hidden":"visible"}},messageMenu:function(t){let s=`<li style="padding: 6px 15px; line-height:20px" data-value="read-text"> <i class="bi-volume-up-fill"></i> ${ot("Leer")}</li>`;return`\n\t\t\t\t<i class="sb-menu-btn bi-three-dots"></i>\n\t\t\t\t<ul style="right: 0rem;padding: .4rem;" class="message-menu sb-menu">\n\t\t\t\t\t${e&&!SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS["allow-agent-delete-message"]||SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS["allow-supervisor-delete-message"]?`<li style="padding: 6px 15px; line-height:20px" data-value="delete"><i class="bi-trash"></i> ${ot("Delete")}</li><hr>`:""}\n\t\t\t\t\t${s}\n\t\t\t\t</ul>`},updateUserDetails(){if(st()){var e=t(".sb-top > a"),s=st().name,a=s.length>15?s.slice(0,15)+"...":s;e.find("span").eq(1).html(a),i.find(".sb-user-details .sb-profile").setProfile(),wt.populate(st(),i.find(".sb-profile-list"))}},setReadIcon(t){let e=2==t;i.find('.sb-top [data-value="read"],.sb-top [data-value="unread"]').sbActive([0,1,2].includes(parseInt(t))).attr("data-value",e?"read":"unread").attr("data-sb-tooltip",ot(e?"Mark as read":"Mark as unread")).parent().sbInitTooltips().find("i").attr("class",e?"bi-check-lg":"bi-check-all")},getListCode:function(t,e){if(t instanceof SBConversation){const e=t.getLastMessage();t={message:e.message,attachments:e.attachments,user_id:t.get("user_id"),conversation_id:t.id,conversation_status_code:t.get("conversation_status_code"),conversation_source:t.get("source"),label:t.get("label"),profile_image:t.get("profile_image"),first_name:t.get("first_name"),last_name:t.get("last_name"),creation_time:t.get("creation_time"),payload:t.get("payload")}}let s=t.message,i=[];s=s.replace(/- /g," "),s=s.replace(/[\[\]"\,}]/g,"");const a=/[{,+0-9]+@s\.whatsapp\.net/g;s=s.replace(a,""),s=s.replace(/\[buttons\s+options="([^"]+)"\s+message="([^"]+)"\]/g,'<i class="bi-file-text" data-options="$1" data-message="$2"></i>'),s=s.replace(/\[card[^\]]*\]/g,'<i class="bi-file-text"></i>'),s=s.replace(//g,"").replace(//g,"  ");if(s.length>40){const t=s.split(" ");let e=0,a=0;for(const s of t){if(a>=5||e+s.length+1>40)break;i.push(s),e+=s.length+1,a++}s=i.join(" ")+"..."}t.label,SBF.admin_set("whatsapp-cloud")["cloud-active"];a.test(s)&&(i=s.replace(/^.*?]/,""));let n=new SBMessage,o=!SBF.null(t.title);if(t.payload.includes("preview")){const e=JSON.parse(t.payload.replace("\\'","'"));e&&"preview"in e&&(s=e.preview)}const r={"*":"strong","~":"s","```":"code"};if(Object.keys(r).forEach((t=>{const e=new RegExp(`\\${t}(.*?)\\${t}`,"g");s.includes(t)&&(s=s.replace(e,((e,s)=>`<${r[t]}>${s}</${r[t]}>`)))})),SBF.null(e)&&(e=t.conversation_status_code),!s&&!SBF.null(t.attachments)){const e=JSON.parse(t.attachments);if(Array.isArray(e)){const t=/\.(jpg|jpeg|png|webp|mp4)\b/g,i=/\.(docx?|xlsx?|pdf)\b/g,a=/\.(mp3|ogg)\b/g,n=e.filter((e=>t.test(e))),o=e.filter((t=>i.test(t))),r=e.filter((t=>a.test(t)));let l="",c="",d="";n.length>0&&(l='<i class="bi-box"></i> '+ot("Media")+": "+(n.length>1?"+"+(n.length-1):n.length)),o.length>0&&(c='<i class="bi-file-text"></i> '+ot("Doc")+": "+(o.length>1?"+"+(o.length-1):o.length)),r.length>0&&(d='<i class="bi-mic-fill vertical-align"></i> '+ot("Voice")+": "+(r.length>1?"+"+(r.length-1):r.length)),(l||c||d)&&(s=[l,c,d].filter(Boolean).join(" "))}}return`<li style="\n\t\t\t " data-user-id="${t.user_id}" data-conversation-id="${t.conversation_id}"  data-time="${new Date(t.creation_time).getTime()}" data-conversation-status="${e}"${SBF.null(t.conversation_source)?"":` data-conversation-source="${t.conversation_source}"`}>\n\t\t\t<small class="source-conversation-icon"><img id="conversation-source-icon" class="source-buttons" src="../media/apps/${t.conversation_source}.svg">\n      </small>\n\t\t\t<div class="sb-profile client-status"><img class="client-icon-status sb-icon tags-${t.label} bi-crosshair loading="lazy" src="${t.profile_image}">\n    \n\t\t\t<h3 class="sb-name${o?" sb-custom-name":""}">${o?t.title:t.first_name+" "+t.last_name} </h3>\n\t\t\t<div class="sb-info-conversations" style="min-width: 60px;text-align:right;flex: auto;font-size: .75rem;letter-spacing: .3px;margin: -2px 0px;">${SBF.beautifyTime(t.creation_time)}</div>\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t<a class="phone-number" style="color:inherit">${t.phone}</a>\n\t\t\t</div>\n\t\t\t<p class="message-received" style="max-width:calc(100% - 145px);">${n.strip(s).replace(/_/g," ")}</p>\n\t\t\t<div class="conversation-bar">\n\n\t\t\t<div class="no-read-icon sb-hide" style="margin: 0px 1px;">\n\t\t\t\t<svg width="20" height="20" viewBox="0 0 24.5 24.5" data-name="Flat Color"\n\t\t\t\t\txmlns="http://www.w3.org/2000/svg" class="icon flat-color">\n\t\t\t\t\t<circle cx="12" cy="12" r="10" class="check-circle" />\n\t\t\t\t\t<path\n\t\t\t\t\t\td="M11 16a1 1 0 0 1-.71-.29l-3-3a1 1 0 1 1 1.42-1.42l2.29 2.3 4.29-4.3a1 1 0 0 1 1.42 1.42l-5 5A1 1 0 0 1 11 16Z"\n\t\t\t\t\t\tclass="check-inside" />\n\t\t\t\t</svg>\n\t\t\t</div>\n\t\t</div>\n\t\t</div>\n\t\t</li> \n\t\t`},newMsgTop(e=!1,s){document.querySelectorAll("ul.sorting-by-last-message li");const i=t(".sb-scroll-area");if(e){(M=this.getUniqueChat(M,"user_id")).slice().sort(((t,e)=>new Date(e.creation_time).getTime()-new Date(t.creation_time).getTime())).forEach(((e,s)=>{t(`.sorting-by-last-message li[data-conversation-id='${e.conversation_id}']`).attr("style","\n\t\t\t\t  transition: all .5s ease;\n          webkit-transition: all .5s ease;\n\t\t\t\t  width:-webkit-fill-available;width:-moz-available;\n          \n\t\t\t\t")})),i.scrollTop()>0&&"add"===s&&requestAnimationFrame((()=>this.newMsgTop(e,s)))}},getUniqueChat:function(t,e){let s=[];return t.filter((function(t){s.findIndex((s=>s[e]==t[e]))<=-1&&s.push(t)})),s},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval((()=>{this.update(),this.updateCurrentURL()}),1e4),SBChat.startRealTime())},stopRealTime:function(){clearInterval(this.real_time),SBChat.stopRealTime()},timeZoneList:function(){Intl.supportedValuesOf("timeZone");let t=document.querySelector("#zones"),e=Intl.DateTimeFormat().resolvedOptions().timeZone;if(Intl.supportedValuesOf){t.innerHTML+="";for(const s of Intl.supportedValuesOf("timeZone"))t.innerHTML+=`<option ${e==s?"selected":""}>${s}</option>`}else{let e=new Option("Your browser does not support Intl.supportedValuesOf().",null,!0,!0);e.disabled=!0,t.options.add(e)}},transcript:function(t,e=!1){if(!("email"!=e||st()&&st().get("email")))return!1;SBF.ajax({function:"transcript",conversation_id:t},(t=>{"email"==e?SBChat.sendEmail(SB_ADMIN_SETTINGS["transcript-message"],[[t,t]],!0):window.open(t)}))},typing:function(t){t?(SBChat.user_online||mt.setActiveUserStatus(!0),this.user_typing||(i.find(".sb-conversation .sb-top > .sb-labels").append('<span class="sb-status-typing" style="font-size: var(--chat-text-size-7);">'+ot("Typing")+"</span>"),this.user_typing=!0)):this.user_typing&&(i.find(".sb-conversation .sb-top .sb-status-typing").remove(),this.user_typing=!1)},scrollTo:function(){let t=n.find(".sb-active"),e=t.length?t[0].offsetTop:0;n.parent().scrollTop(e-(P?120:70))},search:function(e){e&&lt(e,((e,s)=>{if(j=1,e.length>1)SBF.ajax({function:"search-conversations",search:e},(e=>{St.populateList(e),t(s).sbLoading(!1),this.scrollTo(),this.is_search=!0}));else{let e=St.filters();U=1,SBF.ajax({function:"get-conversations",status_code:e[0],tag:e[3]},(e=>{St.populateList(e),t(s).sbLoading(!1),this.is_search=!1}))}}))},updateCurrentURL:function(t=!1){t?this.ucurl(t):SBChat.user_online&&st()&&st().getExtra("current_url")&&SBF.ajax({function:"current-url"},(t=>{t&&this.ucurl(t)}))},ucurl(t){let e=st().getExtra("current_url");t=function(t){return t.replace("https://","").replace("http://","").replace("www.","").replace(/\/$/,"")}(t),i.find('.sb-profile-list [data-id="current_url"] label').attr("data-value",t).html(t),e&&(e.value=t,st().setExtra("current_url",e))},assignDepartment:function(t,e,s){SBF.ajax({function:"update-conversation-department",conversation_id:t,department:e,message:SBChat.conversation.getLastMessage().message},(t=>{s(t)}))},assignAgent:function(t,e,s=!1){SBF.ajax({function:"update-conversation-agent",conversation_id:t,agent_id:e,status_code:6,message:SBChat.conversation.getLastMessage().message},(t=>{s&&s(t)}))},setActiveDepartment:function(t){if(SBChat.conversation&&SBChat.conversation.get("department")==t)return;let e=i.find("#conversation-department"),s=e.find(`[data-id="${t}"]`);e.find(" > p").attr("data-value",s.data("value")).html(s.html()).next().sbActive(!1),SBChat.conversation.set("department",t),"agent"==SB_ACTIVE_AGENT.user_type&&SB_ACTIVE_AGENT.department&&SB_ACTIVE_AGENT.department!=t&&(n.find(`[data-conversation-id="${SBChat.conversation.id}"]`).remove(),St.clickFirst()),et("Department updated. The agents have been notified.")},setActiveAgent:function(t){let e=i.find("#conversation-agent"),s=e.find(`[data-id="${t}"]`);SBChat.conversation.set("agent_id",t),e.find(" > p").attr("data-value",s.data("value")).html(s.html()).next().sbActive(!1),"agent"!=SB_ACTIVE_AGENT.user_type||SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&!t||(n.find(`[data-conversation-id="${SBChat.conversation.id}"]`).remove(),St.clickFirst()),t&&et("Agent assigned. The agent has been notified.")},mobileOpenConversation:function(){i.find(".sb-admin-list").sbActive(!1),i.find(".sb-conversation").sbActive(!0),s.addClass("sb-hide")},mobileCloseConversation:function(){n.find("li.sb-active").sbActive(!1),i.find(".sb-admin-list").sbActive(!0),i.find(".sb-conversation").sbActive(!1),s.removeClass("sb-hide"),window.history.replaceState({},document.title,SBF.URL())},clickFirst:function(){n.find("li:first-child").length?(n.find("li:first-child").click(),St.scrollTo()):i.find(".sb-board").addClass("sb-no-conversation")},savedReplies:function(e,s){let i=s.charAt(e.selectionStart-1);if("/"==i&&(SBChat.editor_listening=!0),SBChat.editor_listening&&" "==i){let i=s.substr(s.lastIndexOf("/")+1).replace(" ","");SBChat.editor_listening=!1;for(var a=0;a<D.length;a++)if(D[a]["reply-name"]==i)return void t(e).val(s.substr(0,s.lastIndexOf("/"))+D[a]["reply-text"])}},attachments:function(){if(c.length){let s=SBChat.conversation.getAttachments(),i="";for(var e=0;e<s.length;e++){let t=s[e][0].slice(0,20);i+=`<a href="${s[e][1]}" class="bg-attachment" target="_blank"><i class="sb-icon bi-file-earmark-arrow-down"></i>${t+"..."} </a>`}t(c).html(""==i?"":`<h3>${ot("Attachments")}</h3><div class="sb-list-items sb-list-links sb-list-icon">${i}</div>`),rt(c,160)}},filters:function(){let t=[];for(var e=0;e<o.length;e++)t.push(o.eq(e).find("li.sb-active").data("value"));return(t[1]||t[3])&&(t[0]="all"),t},notes:{busy:!1,add:function(e,s,i,a,n=!1){let o=t("#alertdate").val(),r=t("#zones").val();if(o=""!=o&&(SBF.getTimezoneOffset(r)==(new Date).getTimezoneOffset()?o:new Date(o).toUTCString()),navigator.userAgent.indexOf("Firefox")>-1){let t=new Date(o);t.setHours(t.getHours()-3),o=""!=o&&(SBF.getTimezoneOffset(r)==(new Date).getTimezoneOffset()?moment.utc(o).format():new Date(o).toUTCString())}SBF.ajax({function:"add-note",conversation_id:e,user_id:s,name:i,message:a,alert:o,time_zone:r,status:!o},(e=>{n&&n(e),t("#alertdate").val("")}))},update:function(t,e=!1){if(r.length){let i="",a=r.find(" > div");for(var s=0;s<t.length;s++){let e=t[s];i+=`<div data-id="${e.id}"><span class="sb-note-title">${e.name} ${SB_ACTIVE_AGENT.id==e.user_id?'<i class="sb-delete-note bi-x-lg"></i>':""}</span>${e.alert||e.time_zone?`<small class="note-alert-text" style="margin: 0px 6px;">${e.alert?SBF.localTime(e.alert,e.time_zone):""}${null!=e.time_zone?" "+e.time_zone:""}</small>`:""}<span class="note-content">${e.message}</span></div>`}e?a.append(i):a.html(i),a.attr("style","display: flex; flex-direction: column-reverse;"),r.find(".bi-chevron-down").remove(),rt(r,155),this.busy=!1}},delete:function(t,e,s=!1){this.busy||(this.busy=!0,SBF.ajax({function:"delete-note",conversation_id:t,note_id:e},(t=>{this.busy=!1,s&&s(t)})))},readmore:function(e,s){if(e.length<=s)return t(".dots").hide(),e;return`${e.slice(0,s)}<span class="more" style="display:none">${e.slice(s,e.length)}</span><span class="dots">...</span>`}},tags:{busy:!1,list:!1,update:function(t){if(l.length){let s="",i=l.find(" > div");for(var e=0;e<t.length;e++)s+=`<span>${t[e]}</span>`;i.html(s),this.busy=!1}},getAll:function(t=[]){let e="";for(var s=0;s<this.list.length;s++)t.includes(this.list[s])||(e+=`<span>${this.list[s]}</span>`);return e}},showDirectMessageBox:function(e,s=[]){let i="email"==e;SBForm.clear(d),d.find(".sb-direct-message-users").val(s.length?s.join(","):""),d.find(".sb-bottom > div").html(""),d.find(".sb-top-bar > div:first-child").html(ot(`Broadcast ${"sms"==e?"text message":e}`)),d.find(".sb-loading").sbLoading(!1),d.find(".sb-direct-message-subject").sbActive(i).find("input").attr("required",i),d.attr("data-type",e),"email"!==e&&"sms"!==e?(d.find(".sb-selector").removeClass("sb-hide"),(new Metatemplate).init("#user-template-form"),"template"===d.find(".sb-select").val()&&d.find(".sb-select").val(null)):(d.find(".sb-selector").addClass("sb-hide"),t(".sb-bulk-sender").addClass("sb-hide"),t(".sb-direct-message-hide").removeClass("sb-hide")),d.find(".sb-select").on("change",(function(){t(this).find(".active-bulk-sender").is(":selected")?(t(".sb-bulk-sender").removeClass("sb-hide"),t(".sb-direct-message-hide").addClass("sb-hide")):(d.find(".sb-selector").addClass("sb-hide"),t(".sb-bulk-sender").addClass("sb-hide"),t(".sb-direct-message-hide").removeClass("sb-hide"))})),d.sbShowLightbox()}},wt={getAll:function(t){return SBForm.getAll(t)},get:function(t){return SBForm.get(t)},set:function(t,e){return SBForm.set(t,e)},getUserExtra:function(t){SBF.ajax({function:"get-user-extra",user_id:t},(e=>{this.getUserExtra(t,response)}))},show:function(t){at(),st(new SBUser({id:t})),st().update((()=>{this.populate(st(),b.find(".sb-profile-list")),b.find(".sb-profile").setProfile(),st().getConversations((e=>{let s=st().type;SBF.isAgent(s)&&this.agentData(),b.find(".sb-user-conversations").html(st().getConversationsCode(e)),b.find(".sb-top-bar [data-value]").sbActive(!1),SBF.null(st().get("email"))||b.find(".sb-top-bar [data-value=email]").sbActive(!0),st().getExtra("phone")&&SB_ADMIN_SETTINGS.sms&&b.find(".sb-top-bar [data-value=sms]").sbActive(!0),this.boxClasses(b,s),b.attr("data-user-id",st().id).sbShowLightbox(),at(!1,!1),SBF.event("SBProfileBoxOpened",{user_id:t})})),G[t]=st(),SBF.getURL("user")!=t&&dt("?user="+t)}))},showEdit:function(t){if(!(t instanceof SBUser))return SBF.error("User not of type SBUser","SBUsers.showEdit"),!1;{let s=v.find("#password input"),i=t.type,a=v.find("#user_type select");v.removeClass("sb-user-new").attr("data-user-id",t.id),v.find(".sb-top-bar .sb-save").html(`<i class="bi-check-lg"></i>${ot("Save changes")}`),v.find(".sb-profile").setProfile(),v.find(".sb-custom-detail").remove(),v.find("input,select,textara").removeClass("sb-error");let n="",o=v.find(".sb-additional-details [id]").map((function(){return this.id})).get().concat(["facebook-id","ip","os","current_url","country_code","browser_language","browser"]);for(var e in t.extra)o.includes(e)||(n+=`<div id="${e}" data-type="text" class="sb-input sb-custom-detail"><span>${ot(t.extra[e].name)}</span><input type="text"></div>`);v.find(".sb-additional-details .sb-edit-box").append(n),this.populateEdit(t,v),this.updateRequiredFields(i),"admin"==SB_ACTIVE_AGENT.user_type&&SBF.isAgent(i)&&a.html(`<option value="agent">${ot("Agent")}</option><option value="admin"${"admin"==i?" selected":""}>${ot("Admin")}</option>`),s.val()&&s.val("********"),this.boxClasses(v,i),v.sbShowLightbox(),SBF.event("SBProfileEditBoxOpened",{user_id:t.id})}},populate:function(e,s){let i=["first_name","last_name","password","profile_image"],a="";if(s.hasClass("sb-profile-list")&&SBChat.conversation){var n=SBChat.conversation.get("source"),o=SBChat.conversation.get("label");if(a=this.profileRow("conversation-id",SBChat.conversation.id,ot("Conversation ID")),SBF.null(o)?a+=this.profileRow("conversation-label","Unknown",ot("Label")):a+=this.profileRow("conversation-label",o,ot("Client status")),SBF.null(n))a+=this.profileRow("conversation-source","Unknown");else{const t={fb:"Facebook",ww:"Whatsmeow",wx:"waweb",wa:"WhatsApp",tm:"Text message",ig:"Instagram",tg:"Telegram",tk:"Tickets",wc:"WeChat",em:"Email",tw:"Twitter",bm:"Google"}[n]||n;a+=this.profileRow("conversation-source",t,ot("Source"))}}for(var r in"admin"!=SB_ACTIVE_AGENT.user_type&&i.push("token"),e.details)i.includes(r)||(a+=this.profileRow(r,e.get(r)));if(e.isExtraEmpty())SBF.ajax({function:"get-user-extra",user_id:e.id},(t=>{for(var i=1;i<t.length;i++){let s=t[i].slug;e.setExtra(s,t[i]),a+=this.profileRow(s,t[i].value,t[i].name)}s.html(`<ul>${a}</ul>`),rt(s,56)}));else{for(var r in e.extra){let t=e.getExtra(r);a+=this.profileRow(r,t.value,t.name)}s.html(`<h3 class="sb-user-details-info">${ot("User information")}</h3><ul>${a}</ul>`),rt(s,56)}t("#change-conversation-source").change((function(e){const s=e.target.value,i=`${STMBX_URL}/media/apps/${s}.svg`;t("#conversation-source-icon").attr("src",i),SBF.ajax({function:"update-conversation-source",conversation_id:SBChat.conversation.id,source:s},(e=>{et("Required reload"),SBChat.update(),t("#change-conversation-source").val(s)}));const a=`sb-icon bi-${s}`;t('.sb-profile-list [data-id="conversation-source"] i').attr("class",a)})),t("#change-conversation-labels").change((function(e){if("Unknown"!==e.target.value){const s=e.target.options[e.target.selectedIndex].text;let i=`sb-icon bi-crosshair tags-${e.target.value}`;t('.sb-profile-list [data-id="conversation-label"] i').attr("class",i),t(`[data-user-id="${st().id}"] .bi-crosshair`).attr("class",i),t(`[data-user-id="${st().id}"] #label-name`).text(s)}wt.updateLabel(e.target.value)})),t("#CstBtn a").click((function(e){const s=t(this).attr("id"),i=ot(SBF.admin_set("label-names")[s]+" ");let a=`sb-icon bi-crosshair tags-${s}`;t('.sb-profile-list [data-id="conversation-label"] i').attr("class",a),t(`[data-user-id="${st().id}"] .bi-crosshair`).attr("class",a),t(`[data-user-id="${st().id}"] #label-name`).text(i),wt.updateLabelUI(s,i,a),wt.updateLabel(s)}))},updateLabelUI:function(e,s,i){t(`[data-user-id="${st().id}"] .bi-crosshair`).attr("class",i),t(`[data-user-id="${st().id}"] #label-name`).text(s)},getLabel:function(t){SBF.ajax({function:"get-clientStatus-conversations",conversation_id:SBChat.conversation.id,label:t},(t=>{"status-client"==vt.active_report&&vt.initReport("status-client")}))},updateLabel:function(t){SBF.ajax({function:"update-clientStatus-conversations",conversation_id:SBChat.conversation.id,label:t},(t=>{"status-client"==vt.active_report&&vt.initReport("status-client")}))},profileRow:function(t,e,s=t){if(""==e)return"";let i,a={id:"person-vcard","conversation-label":"tag","conversation-source":"tickets","conversation-id":"person-vcard",full_name:"person-bounding-box",email:"envelope",phone:"phone",user_type:"person-bounding-box",last_activity:"calendar",creation_time:"calendar",token:"shuffle",currency:"currency-exchange",location:"pin-map",country:"flag",address:"app",city:"app",postal_code:"app",os:"person-workspace",current_url:"radar",timezone:"clock"},n=`<i class="sb-icon bi-${t in a?a[t]:"app"}"></i>`,o=!1;switch(t){case"last_activity":case"creation_time":e=SBF.beautifyTime(e);break;case"user_type":e=SBF.slugToString(e);break;case"country_code":case"language":case"browser_language":n=`<img src="${STMBX_URL}/media/flags/${e.toLowerCase()}.png" />`;break;case"browser":i=e.toLowerCase(),i.includes("chrome")?o="chrome":i.includes("edge")?o="edge":i.includes("firefox")?o="firefox":i.includes("opera")?o="opera":i.includes("safari")&&(o="safari");break;case"os":i=e.toLowerCase(),i.includes("windows")?o="windows":i.includes("mac")||i.includes("apple")||i.includes("ipad")||i.includes("iphone")?o="apple":i.includes("android")?o="android":i.includes("linux")?o="linux":i.includes("ubuntu")&&(o="ubuntu");break;case"conversation-source":case"browser":case"os":case"conversation-source":o=e.toLowerCase(),e=`<select disabled style="background: transparent;border-color: transparent;" id="change-conversation-source">\n                                <option  value="tk" ${"Tickets"==e?"selected":""} value>Live Chat</option>\n                                <option value="ww" ${"Whatsmeow"==e?"selected":""} value>WhatsApp QR</option>\n                                <option value="wx" ${"waweb"==e?"selected":""} value>WhatsApp Web</option>                                \n                                <option value="wa" ${"WhatsApp"==e?"selected":""} value>WhatsApp API</option>\n                                <option   hidden value="tg" ${"Telegram"==e?"selected":""} value>Telegram</option>\n                                <option  hidden value="bm" ${"Google"==e?"selected":""} value>Google</option>\n                                <option  hidden value="tm" ${"Text message"==e?"selected":""} value>Text message</option>\n                                <option hidden value="un" ${"Unknown"==e?"selected":""} value>Facebook</option>                                \n                                <option hidden value="ig" ${"Instagram"==e?"selected":""} value>Instagram</option>\n                                <option hidden value="wc" ${"WeChat"==e?"selected":""} value>WeChat</option>\n                                <option hidden value="em" ${"Email"==e?"selected":""} value>Email</option>\n                                <option  hidden value="tw" ${"Twitter"==e?"selected":""} value>Twitter</option>\n                             </select>`,o&&"Unknown"!==e&&(n=`<img src="${STMBX_URL}/media/${"conversation-source"==t?"apps":"devices"}/${o}.svg" />`);break;case"conversation-label":let s=e,a=tt,r="";Array.isArray(a)&&a.forEach((function(t){r+=`<option value="${t}" ${e===t?"selected":""}>${ot(SBF.get_value(t)+" ")}</option>`}));let l=`class="sb-icon bi-crosshair tags-${s}"`;e=`<select style="background: transparent; border-color: transparent;" id="change-conversation-labels">\n\t\t\t\t\t\t\t\t<option value='unknown'>${ot("Client status")}</option> ${r} </select>`,n=`<i ${l}></i>`}return`<li data-id="${t}">${n}<span>${ot(SBF.slugToString(s))}</span><label style="overflow-wrap: break-word">${e}</label></li>`},populateEdit:function(e,s){s.find(".sb-details .sb-input").each(((s,i)=>{this.set(i,e.details[t(i).attr("id")])})),s.find(".sb-additional-details .sb-input").each(((s,i)=>{let a=t(i).attr("id");a in e.extra?this.set(i,e.extra[a].value):this.set(i,"")}))},clear:function(t){SBForm.clear(t)},errors:function(t){return SBForm.errors(t.find(".sb-details"))},showErrorMessage:function(t,e){SBForm.showErrorMessage(t,e)},agentData:function(){let t=`<div class="sb-title">${ot("Feedback rating")}</div><div class="sb-rating-area sb-loading"></div>`,e=b.find(".sb-agent-area");e.html(t),SBF.ajax({function:"get-rating"},(s=>{if(0==s[0]&&0==s[1])t=`<p class="sb-no-results">${ot("No ratings yet.")}</p>`;else{let e=s[0]+s[1],i=100*s[0]/e,a=100*s[1]/e;t=`<div><div>${ot("Helpful")}</div><span data-count="${s[0]}" style="width: ${Math.round(2*i)}px"></span><div>${i.toFixed(2)} %</div></div><div><div>${ot("Not helpful")}</div><span data-count="${s[1]}" style="width: ${Math.round(2*a)}px"></span><div>${a.toFixed(2)} %</div></div><p class="sb-rating-count">${e} ${ot("Ratings")}</p>`}e.find(".sb-rating-area").html(t).sbLoading(!1)}))},boxClasses:function(e,s=!1){t(e).removeClass("sb-type-admin sb-type-agent sb-type-lead sb-type-user sb-type-visitor").addClass(`${0!=s?`sb-type-${s}`:""} sb-agent-${SB_ACTIVE_AGENT.user_type}`)},updateRequiredFields:function(t){let e=SBF.isAgent(t);v.find("#password input").prop("required",e),v.find("#email input").prop(e||"user"==t||"lead"==t)}},_t={dialog:it,open_popup:!1,must_translate:!1,is_logout:!1,conversations:St,users:mt,settings:bt,profile:wt,apps:gt};function yt(){SBF.ajax({function:"get-conversations"},(t=>{0==t.length&&i.find(".sb-board").addClass("sb-no-conversation"),St.populateList(t),P&&i.find(".sb-admin-list").sbActive(!0),SBF.getURL("conversation")?(i.sbActive()||s.find(".sb-admin-nav #sb-conversations").click(),St.openConversation(SBF.getURL("conversation"))):P||SBF.getURL("user")||SBF.getURL("setting")||SBF.getURL("report")||SBF.getURL("area")&&"conversations"!=SBF.getURL("area")||St.clickFirst(),St.startRealTime(),St.datetime_last_conversation=SB_ADMIN_SETTINGS["now-db"],at(!1)})),SBPusher.initServiceWorker(),SB_ADMIN_SETTINGS["push-notifications"]&&SBPusher.initPushNotifications()}window.SBAdmin=_t,t(document).ready((function(){if(e=t(".sb-admin"),s=e.find("> .sb-header"),i=e.find(".sb-area-conversations"),a=i.find(".sb-admin-list"),n=a.find(".sb-scroll-area ul"),o=a.find(".sb-select"),p=e.find(".sb-area-users"),f=p.find(".sb-table-users"),g=p.find(".sb-menu-users"),b=e.find(".sb-profile-box"),v=e.find(".sb-profile-edit-box"),m=e.find(".sb-area-settings"),y=m.find(".sb-automations-area"),k=y.find(".sb-conditions"),x=y.find(" > .sb-select"),B=y.find(" > .sb-tab > .sb-nav > ul"),C=e.find(".sb-area-reports"),S=m.find(".sb-articles-area"),w=S.find(".sb-article-categories select"),_=S.find(".sb-article-parent-category select"),R=i.find(".sb-replies"),N=i.find(".sb-status-chat"),E=e.find(".sb-lightbox-overlay"),typeof STMBX_URL!=Y?STMBX_URL.substr(0,STMBX_URL.indexOf("-content")-3):"",r=i.find(".sb-panel-notes"),l=i.find(".sb-panel-tags"),c=i.find(".sb-panel-attachments"),d=e.find(".sb-direct-message-box"),u=e.find(".sb-dialogflow-intent-box"),h=i.find(".sb-editor > .sb-suggestions"),window.onpopstate=function(){e.sbHideLightbox(),P&&i.sbActive()&&i.find(".sb-conversation").sbActive()&&St.mobileCloseConversation(),SBF.getURL("user")?(p.sbActive()||s.find(".sb-admin-nav #sb-users").click(),wt.show(SBF.getURL("user"))):SBF.getURL("area")?s.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click():SBF.getURL("conversation")?(i.sbActive()||s.find(".sb-admin-nav #sb-conversations").click(),St.openConversation(SBF.getURL("conversation"))):SBF.getURL("setting")?(m.sbActive()||s.find(".sb-admin-nav #sb-settings").click(),m.find("#tab-"+SBF.getURL("setting")).click()):SBF.getURL("report")&&(C.sbActive()||s.find(".sb-admin-nav #sb-reports").click(),C.find("#"+SBF.getURL("report")).click())},SBF.getURL("area")&&setTimeout((()=>{s.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click()}),300),typeof SB_ADMIN_SETTINGS==Y){let s=e.find(".sb-intall");return void t(e).on("click",".sb-submit-installation",(function(){if(nt(this))return;let e=!1,i=s.find("#first-name").length;if(SBForm.errors(s))e=i?"All fields are required. Minimum password length is 8 characters. Be sure you have entered a valid email.":"All fields are required.";else if(i&&s.find("#password input").val()!=s.find("#password-check input").val())e="The passwords do not match.";else{let i=window.location.href.replace("/admin","").replace(".php","").replace(/#$|\/$/,"");i.includes("?")&&(i=i.substr(0,i.indexOf("?"))),t.ajax({method:"POST",url:i+"/include/ajax.php",data:{function:"installation",details:t.extend(SBForm.getAll(s),{url:i})}}).done((a=>{if(0!=(a=JSON.parse(a))){if(!0===(a=a[1]))return void setTimeout((()=>{window.location.href=i+"?refresh=true"}),1e3);switch(a){case"connection-error":e="Routin.bot cannot connect to the database. Please check the database information and try again.";break;case"missing-details":e="Missing database details! Please check the database information and try again.";break;case"missing-url":e="We cannot get the plugin URL.";break;default:e=a}}else e=a;!1!==e&&(SBForm.showErrorMessage(s,e),t("html, body").animate({scrollTop:0},500)),t(this).sbLoading(!1)}))}!1!==e&&(SBForm.showErrorMessage(s,e),t("html, body").animate({scrollTop:0},500),t(this).sbLoading(!1))}))}if(!e.length)return;if(at(),e.removeAttr("style"),(window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||document.referrer.includes("android-app://"))&&e.addClass("sb-pwa"),H&&typeof caches!==Y&&caches.delete("sb-pwa-cache"),e.find(" > .sb-rich-login").length)return;SB_ADMIN_SETTINGS.pusher?(SBPusher.active=!0,SBPusher.init((()=>{SBPusher.presence(1,(()=>{mt.updateUsersActivity()})),SBPusher.event("update-conversations",(()=>{St.update(),SBChat.update()}),"agents"),SBPusher.event("set-agent-status",(t=>{t.agent_id==SB_ACTIVE_AGENT.id&&mt.setActiveAgentStatus("online"==t.status)}),"agents"),yt()}))):(yt(),setInterval((function(){mt.updateUsersActivity()}),1e4)),mt.table_extra=f.find("th[data-extra]").map((function(){return t(this).attr("data-field")})).get(),t(window).on("beforeunload",(function(){st()&&SBF.ajax({function:"on-close"})})),t(window).keydown((function(t){let s=t.which,a=!1;if([13,27,46].includes(s)){if(e.find(".sb-dialog-box").sbActive()){let t=e.find(".sb-dialog-box");switch(s){case 46:case 27:t.find(".sb-cancel").click();break;case 32:case 13:t.find("info"!=t.attr("data-type")?".sb-confirm":".sb-close").click()}a=!0}else if([46].includes(s)&&i.sbActive()){if(i.find(".sb-editor textarea").is(":focus"))return;let t=i.find(" > div > .sb-conversation");t.find('.sb-top [data-value="'+(3==t.attr("data-conversation-status")?"delete":"archive")+'"]').click(),a=!0}else if([46,27].includes(s))if(e.find(".sb-lightbox").sbActive())e.sbHideLightbox(),a=!0;else{let t=e.find(".sb-search-btn.sb-active");t.length&&(t.find("i").click(),a=!0)}a&&t.preventDefault()}})),t(document).on("click keydown mousemove",(function(){SBF.debounce((function(){SBChat.tab_active||SBF.visibilityChange(),SBChat.tab_active=!0,clearTimeout(J),J=setTimeout((()=>{SBChat.tab_active=!1}),1e4)}),"#3",8e3)}));var L=0;function I(e){let s=moment();s.local(),t("#alertdate").val(s.format("MM/DD/YY hh:mm A")),St.timeZoneList()}function X(t,s,i=0,a=[],n,o=!1){let r="custom-email"==n?["send-custom-email","emails"," users with an email","direct-emails"]:"sms"==n?["whatsmeow-send-message","waweb-send-message","messages"," with a phone number","direct-sms"]:["create-email","emails"," with an email",!1];r="template"==n?["whatsapp-send-meta-template","template","users a phone number","direct-messages"]:r;let l=(new Metatemplate).payload("#user-template-form");l.to=t[i];let c="template"==n?{function:r[0],payload:l}:{function:r[0],to:t[i].value,recipient_id:t[i].id,sender_name:SB_ACTIVE_AGENT.full_name,sender_profile_image:SB_ACTIVE_AGENT.profile_image,subject:o,message:s,template:!1};SBF.ajax(c,(l=>{let c=t.length;return d.find(".sb-bottom > div").html(`${ot("Sending")} ${r[1]}... ${i+1} / ${c}`),l||console.warn(l),l?.error?(132e3==l?.error.code||100==l?.error.code?SBForm.showErrorMessage(d,`${l?.error.message}`):it(`${l?.error.message}`,"info"),void console.warn(l)):i<c-1?X(t,s,i+1,a,n,o):(a.length?X(a,s,0,[],"sms",!1):(e.sbHideLightbox(),r[3]&&SBF.ajax({function:"reports-update",name:r[3],value:s+" | "+c})),void et(1==c?"Message sent":`${SBF.slugToString(r[1])} sent to all users${r[2]}.`))}))}function Z(e,s){e.preventDefault();let i=m.find("#whatsmeow-go-qr input").val(),a="start"===s?"/get_ww.php?qrurl=":"/reset_ww.php";return"start"===s?fetch(STMBX_URL+a+i).then((t=>{if(!t.ok)throw new Error("Network response was not ok");return t.text()})).then((e=>{try{let t=JSON.parse(e);console.log("Received JSON response:",t),t.error?SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"warning"):SBChat.showResponse('<i class="bi bi-telephone"></i> WhatsApp connected')}catch(e){if(e instanceof SyntaxError)return void fetch(STMBX_URL+a+i).then((t=>{if(!t.ok)throw new Error("Network response was not ok");return t.blob()})).then((e=>{let s=URL.createObjectURL(e),i=t("#qr_image1");i.length?i.fadeOut(500,(function(){t(this).attr("src",s).fadeIn(500)})):(t("#whatsmeow-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image1" src="${s}" onerror="this.style.display='none';$('#qr_loading1').show();" />`),t("#whatsmeow-go .sb-setting-content").append('<div id="qr_loading1" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>'))})).catch((t=>{SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}));throw e}})).catch((t=>{SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")})):"restart"===s&&(console.log("Restarting..."),t.ajax({url:a,method:"GET",data:{qrurl:i},dataType:"json",success:function(e){console.log("Restart successful. Response:",e),SBChat.showResponse('<i style="var(--color-red)" class="bi bi-telephone-x"></i> Disconnecting from WhatsApp...');let s=t("#qr_image1");s.length&&s.fadeOut(500,(function(){t(this).remove()}))},error:function(t){SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}})),!1}function Q(e,s){e.preventDefault();let i=m.find("#waweb-go-qr input").val(),a="start"===s?"/get_wx.php?qrurl=":"/reset_wx.php";return console.log(`QR Input: ${i}`),console.log(`URL: ${a}`),"start"===s?(t("#qr_loading2").show(),fetch(STMBX_URL+a+i).then((t=>{if(!t.ok)throw new Error("Network response was not ok");return t.text()})).then((e=>{try{let t=JSON.parse(e);console.log("Received JSON response:",t),t.error?(console.error("Error in JSON response:",t.error),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"warning")):SBChat.showResponse('<i class="bi bi-telephone"></i> WhatsApp connected')}catch(e){if(e instanceof SyntaxError)return console.log("Response is not JSON, assuming it's an image blob."),void fetch(STMBX_URL+a+i).then((t=>{if(!t.ok)throw new Error("Network response was not ok");return t.blob()})).then((e=>{let s=URL.createObjectURL(e),i=t("#qr_image2");i.length?i.fadeOut(500,(function(){t(this).attr("src",s).fadeIn(500)})):(t("#waweb-go .sb-setting-content").append(`<img style="max-width: 90%; margin: 10px; border: 4px solid white; border-radius: 15px;" id="qr_image2" src="${s}" onerror="this.style.display='none';$('#qr_loading2').show();" />`),t("#waweb-go .sb-setting-content").append('<div id="qr_loading2" style="display: none; width: 90%; height: 40px; margin: 10px; border-radius: 8px;"><div style="position: relative; top: 50%; transform: translateY(-50%); text-align: center; color: white; font-size: var(--chat-text-size-7);">Loading...</div></div>')),t("#qr_loading2").hide()})).catch((t=>{console.error("Error during fetch:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}));throw e}})).catch((t=>{console.error("Error during fetch:",t),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")})).finally((()=>{t("#qr_loading2").hide()}))):"restart"===s&&(console.log("Restarting..."),t.ajax({url:a,method:"GET",data:{qrurl:i},dataType:"json",success:function(e){console.log("Restart successful. Response:",e),SBChat.showResponse('<i style="var(--color-red)" class="bi bi-telephone-x"></i> Disconnecting from WhatsApp...');let s=t("#qr_image2");s.length&&s.fadeOut(500,(function(){t(this).remove()}))},error:function(t){console.error("Restart error. Response:",t.responseText),SBChat.showResponse('<i class="bi bi-emoji-dizzy-fill"></i> WhatsApp is unresponsive',"error")}})),!1}document.onpaste=function(t){let e=t.clipboardData.items[0];if(0===e.type.indexOf("image")){var s=new FileReader;s.onload=function(t){};var i=new FormData,a=`screenshot-${L++}.png`,n=e.getAsFile();i.append("fname",a),i.append("file",n),jQuery.ajax({url:STMBX_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:i,type:"POST",success:function(t){SBF.uploadResponse(t)}}),s.readAsDataURL(e.getAsFile())}},t(document).ready((function(){t(s).on("click",".help-center",(function(){e.find(".sb-updates-box").sbShowLightbox()}))})),typeof Notification===Y||"all"!=SB_ADMIN_SETTINGS["desktop-notifications"]&&"agents"!=SB_ADMIN_SETTINGS["desktop-notifications"]||SB_ADMIN_SETTINGS["push-notifications"]||(St.desktop_notifications=!0),"all"!=SB_ADMIN_SETTINGS["flash-notifications"]&&"agents"!=SB_ADMIN_SETTINGS["flash-notifications"]||(St.flash_notifications=!0),W.getDate()!=SBF.storage("admin-clean")&&setTimeout((function(){SBF.ajax({function:"cron-jobs"}),SBF.storage("admin-clean",W.getDate())}),1e4),t(e).on("click",".bi-chevron-down",(function(){let e=t(this).sbActive(),s=e?t(this).parent().data("height")+"px":"";t(this).html(ot(e?"View more":"Close")),t(this).parent().find("> div, > ul").css({height:s,"max-height":s}),t(this).sbActive(!e)})),t(e).on("click",".sb-popup-close",(function(){e.sbHideLightbox()})),e&&(t(document).on("click",(function(e){t(e.target).closest(".sb-menu-mobile").length||(t(".sb-menu-mobile > i").removeClass("sb-active"),t(".open-profile").removeClass("sb-hide"))})),t(e).on("click",".sb-menu-mobile > i",(function(){t(this).toggleClass("sb-active"),_t.open_popup=t(this).parent()})),t(e).on("click",".sb-menu-mobile a",(function(){t(this).closest(".sb-menu-mobile").find(" > i").sbActive(!1)})),t(e).on("click",".sb-menu-wide,.sb-nav",(function(){t(this).toggleClass("sb-active")})),t(e).on("click",".sb-menu-wide > ul > li, .sb-nav > ul > li",(function(s){let i=t(this).parent().parent();return i.find("li").sbActive(!1),i.find("> div:not(.sb-menu-wide):not(.sb-btn)").html(t(this).html()),i.sbActive(!1),i.find("> .sb-menu-wide").length&&i.closest(".sb-scroll-area").scrollTop(i.next()[0].offsetTop-(e.hasClass("sb-header-hidden")?70:130)),s.preventDefault(),!1})),t(e).find(".sb-admin-list .sb-scroll-area, main > div > .sb-scroll-area,.sb-area-settings > .sb-tab > .sb-scroll-area,.sb-area-reports > .sb-tab > .sb-scroll-area").on("scroll",(function(){let s=t(this).scrollTop();z.last<s-10&&z.header?(e.addClass("sb-header-hidden"),z.header=!1):z.last>s+10&&!z.header&&!z.always_hidden&&(e.removeClass("sb-header-hidden"),z.header=!0),z.last=s})),t(e).on("click",".sb-search-btn i, .sb-filter-btn i",(function(){t(this).parent().sbActive()?(t(".sb-top").css("top","+=0px"),t(this).parent().hasClass("sb-filter-btn")&&t(".sb-search-btn, .inbox, .non-hover").addClass("sb-hide"),t(this).hasClass("bi-search")?t(this).removeClass("bi-search").addClass("bi-x-lg"):t(this).hasClass("bi-x-lg")?t(this).removeClass("bi-x-lg").addClass("bi-filter"):t(this).hasClass("bi-filter")&&t(this).removeClass("bi-filter").addClass("bi-filter-circle")):(z.always_hidden=!1,n.parent().scrollTop()<10&&(e.removeClass("sb-header-hidden"),t(this).parent().hasClass("sb-filter-btn")&&t(".sb-search-btn, .inbox, .non-hover").removeClass("sb-hide"),t(this).hasClass("bi-filter-circle")?t(this).removeClass("bi-filter-circle").addClass("bi-filter"):t(this).hasClass("bi-filter")?t(this).removeClass("bi-filter").addClass("bi-x-lg"):t(this).hasClass("bi-x-lg")&&t(this).removeClass("bi-x-lg").addClass("bi-search")))})),t(e).on("click","#open-modal-button",(function(){console.log("open",e.find(".sb-send-template-box")),e.find(".sb-send-template-box").sbShowLightbox()})),t(e).on("click","#meta-broadcast-button",(function(){console.log("open"),e.find(".meta-broadcast-box").sbShowLightbox()})),t(e).on("click",".sb-top .sb-btn-back",(function(){St.mobileCloseConversation()})),t(window).width()<555&&t(f).find("th:first-child").html(ot("Order by")),t(f).on("click","th:first-child",(function(){t(this).parent().toggleClass("sb-active")}))),t(i).on("click","> .sb-btn-collapse, .collapse",(function(){t(this).toggleClass("sb-active"),i.find(t(this).hasClass("sb-left")?".sb-admin-list":".sb-top").toggleClass("sb-active")})),t(i).on("click",".sb-conversation",(function(){t(".sb-admin-list, .sb-btn-collapse.sb-left.bi-arrow-left-short.sb-active").removeClass("sb-active")})),t(i).on("click",".sb-list, .sb-editor",(function(){t(".sb-admin-list, .sb-btn-collapse.sb-left.bi-arrow-left-short.sb-active").removeClass("sb-active"),t(".sb-user-details.sb-top.sb-active, .sb-top.sb-active").removeClass("sb-active")})),t(s).on("click"," .sb-admin-nav a",(function(){let i=t(this).attr("id");switch(s.find(".sb-admin-nav a").sbActive(!1),e.find(" > main > div").sbActive(!1),e.find("."+t(this).attr("id").replace("sb-","sb-area-")).sbActive(!0),t(this).sbActive(!0),SBF.deactivateAll(),i){case"sb-conversations":P||SBF.getURL("conversation")||St.clickFirst(),St.update(),St.startRealTime(),mt.stopRealTime();break;case"sb-users":mt.startRealTime(),St.stopRealTime(),mt.init||(at(),q=1,O=1,SBF.ajax({function:"get-users",user_types:["user","visitor","lead"],extra:mt.table_extra},(t=>{mt.populate(t),mt.updateMenu(),mt.init=!0,mt.datetime_last_user=SBF.dateDB("now"),at(!1)})));break;case"sb-settings":bt.init||(at(),SBF.ajax({function:"get-all-settings"},(t=>{if(t){let s=t["external-settings-translations"];for(var e in bt.initHTML(t),bt.translations.translations=Array.isArray(s)&&!s.length?{}:s,delete t["external-settings-translations"],t)bt.set(e,t[e])}bt.initPlugins(),bt.init=!0,at(!1)}))),mt.stopRealTime(),St.stopRealTime();break;case"sb-reports":C.sbLoading()&&t.getScript(STMBX_URL+"/vendor/moment.min.js",(()=>{t.getScript(STMBX_URL+"/vendor/daterangepicker.min.js",(()=>{t.getScript(STMBX_URL+"/vendor/chart.min.js",(()=>{vt.initDatePicker(),vt.initReport("conversations"),C.sbLoading(!1)}))}))})),mt.stopRealTime(),St.stopRealTime()}let a=i.substr(3),n=SBF.getURL("area");"reports"==a&&t("#"+vt.active_report).click(),n!=a&&("conversations"==a&&!SBF.getURL("conversation")||"users"==a&&!SBF.getURL("user")||"settings"==a&&!SBF.getURL("setting")||"reports"==a&&!SBF.getURL("report"))&&dt("?area="+a)})),t(s).on("click",".sb-profile",(function(){t(this).next().toggleClass("sb-active")})),t(s).on("click",'[data-value="logout"],.logout',(function(){_t.is_logout=!0,SBF.ajax({function:"on-close"}),mt.stopRealTime(),St.stopRealTime(),SBF.logout()})),t(s).on("click",'[data-value="edit-profile"],.edit-profile',(function(){at();let t=new SBUser({id:SB_ACTIVE_AGENT.id});t.update((()=>{st(t),i.find(".sb-board").addClass("sb-no-conversation"),n.find(".sb-active").sbActive(!1),wt.showEdit(t)}))})),t(s).on("click",'[data-value="status"]',(function(){mt.setActiveAgentStatus(!t(this).hasClass("sb-online"))})),t(s).find(".sb-account").setProfile(SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image),t(n).on("click","li",(function(){(new SBMessage).setLoad(30),St.openConversation(t(this).attr("data-conversation-id"),t(this).attr("data-user-id"),!1),SBF.deactivateAll()})),t(e).on("click",".sb-user-conversations li",(function(){St.openConversation(t(this).attr("data-conversation-id"),st().id,t(this).attr("data-conversation-status"))})),t(i).on("click",".sb-top ul a",(function(){let e=-1,s="The conversation will be ",i=t(this).attr("data-value"),a=(document.querySelectorAll("ul.sorting-by-last-message li"),SBChat.conversation.id);switch(i){case"inbox":e=0,s+="restored.";break;case"archive":s+="archived.",e=3;break;case"follow-up":s+="assigned for follow-up.",e=6;break;case"delete":s+="moved to the Bot container. Bot flow restarted.",e=4;break;case"empty-trash":e=5,s="The bot will permanently delete all conversations in the container, including their messages.";break;case"transcript":St.transcript(a,t(this).attr("data-action"));break;case"read":e=0,s+="marked as read.";break;case"unread":e=2,s+="marked as unread."}-1!=e&&it(s,"alert",(function(){SBF.ajax({function:"update-conversation-status",conversation_id:a,status_code:e},(()=>{if([0,3,4,6].includes(e))for(var t=0;t<M.length;t++)if(M[t].conversation_id==a){M[t].conversation_status_code=e;break}SB_ADMIN_SETTINGS["close-message"]&&3==e&&(SBF.ajax({function:"close-message",conversation_id:a,bot_id:SB_ADMIN_SETTINGS["bot-id"]}),SB_ADMIN_SETTINGS["close-message-transcript"]&&St.transcript(a,"email")),[0,2].includes(e)&&(n.find(".sb-active").attr("data-conversation-status",e),St.setReadIcon(e)),"inbox"!=i&&[0,2].includes(e)||(o.eq(0).find("li.sb-active").click(),o.eq(0).find("ul").sbActive(!1)),gt.is("slack")&&[3,4].includes(e)&&SBF.ajax({function:"archive-slack-channels",conversation_user_id:SBChat.conversation.get("user_id")})})),SBChat.conversation&&SBChat.conversation.id==a&&SBChat.conversation.set("conversation_status_code",e)}))})),t((function(){t(i).on("click",'ul.sorting-by-last-message li[data-conversation-status="2"]',(function(){const e=t(this).attr("data-conversation-id");SBF.ajax({function:"update-conversation-status",conversation_id:e,status_code:0},(function(){t(this).attr("data-conversation-status",0),n.find(".sb-active").attr("data-conversation-status",0),St.setReadIcon(0)}));const s=t(this).find(".sb-name.span-profile-detail"),i=s.text();i.length>20&&s.text(i.slice(0,17)+"...")})),t(i).on("click",".sb-top .open-profile",(function(){t([i.find(".sb-user-details"),this]).toggleClass("sb-active")}))})),SBF.ajax({function:"saved-replies"},(t=>{let e=`<p class="sb-no-results">${ot("No saved replies found. Add new saved replies via Settings > Admin")}</p>`;if(Array.isArray(t)&&t.length>0&&t[0]["reply-name"]){e="",D=t;for(var s=0;s<t.length;s++)e+=`<li><div>${"/"+t[s]["reply-name"]}</div><div>${t[s]["reply-text"]}</div></li>`}R.find(".sb-replies-list > ul").html(e).sbLoading(!1)})),t(i).on("click",".bi-envelope-arrow-up",(function(){R.sbTogglePopup(this)})),t(R).on("click",".sb-replies-list li",(function(){SBChat.insertText(t(this).find("div:last-child").html()),SBF.deactivateAll(),e.removeClass("sb-popup-active")})),t(R).on("input",".sb-search-btn input",(function(){let e=t(this).val().toLowerCase();SBF.search(e,(()=>{let t="",s=!(e.length>1);for(var i=0;i<D.length;i++)(s||D[i]["reply-name"].toLowerCase().includes(e)||D[i]["reply-text"].toLowerCase().includes(e))&&(t+=`<li><div>${D[i]["reply-name"]}</div><div>${D[i]["reply-text"]}</div></li>`);R.find(".sb-replies-list > ul").html(t)}))})),t(i).on("click",".bi-crosshair",(function(){N.sbTogglePopup(this)})),t(a).find(".sb-scroll-area").on("scroll",(function(){if(!V&&!St.is_search&&ct(this,!0)&&j){let t=i.find(".sb-admin-list"),e=St.filters();V=!0,t.append('<div class="sb-loading-global sb-loading"></div>'),SBF.ajax({function:"get-conversations",pagination:U,status_code:e[0],user_type:"agent",department:e[1],source:e[2],tag:e[3]},(e=>{if(setTimeout((()=>{V=!1}),500),j=e.length,e.sort((function(t,e){return new Date(e.creation_time).getTime()-new Date(t.creation_time).getTime()})),j){let t="";for(var s=0;s<j;s++)t+=St.getListCode(e[s],"append"),M.push(e[s]);U++,n.append(t),St.positionList(),ct(this,!1,1e3)}t.find(" > .sb-loading").remove(),SBF.event("SBAdminConversationsLoaded",{conversations:e})}))}})),t(document).on("SBMessageDeleted",(function(){let t=SBChat.conversation.getLastMessage();if(0!=t){t.details.conversation_id,new Date(t.details.creation_time).getTime();St.newMsgTop(t.details,"add"),n.find("li.sb-active p").html(t.message),n.find("li.sb-active .sb-profile .sb-time").html(t.details.creation_time)}else St.newMsgTop({conversation_id:SBChat.conversation.id},"deleted"),n.find("li.sb-active").remove(),St.clickFirst(),St.scrollTo()})),t(document).on("SBMessageSent",(function(e,s){let a=s.conversation_id,o=n.find(`[data-conversation-id="${a}"]`),r=ot("Error. Message not sent to"),l=s.conversation,c=s.user;s.message&&o.find("p").html(s.message),-1!=s.conversation_status_code&&(o.attr("data-conversation-status",s.conversation_status_code),St.updateMenu()),gt.messenger.check(l)&&gt.messenger.send(c.getExtra("facebook-id").value,l.get("extra"),s.message,s.attachments,s.message_id,(t=>{t&&"error"in t&&it(r+" Messenger: "+t.error.message,"info")}));var d=SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"]);gt.whatsapp.check(l)&&gt.whatsapp.send(gt.whatsapp.activeUserPhone(c),"[rating]"===s.message?d:s.message,s.attachments,l.get("extra"),(t=>{t&&!t.error?et("<i class='bi-wind'></i> Message ent successfully"):et("<i class='bi-send-exclamation'></i> Message could not be sent to API Cloud","warning")}),(t=>{et("<i class='bi-info-circle'></i> Failed to send message. Please try again later","warning"),console.error("Error sending message to WhatsApp:",t)}));d=SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"]);if(gt.whatsmeow.check(l)){s.message_id;"[rating]"==s.message&&(s.message=d),gt.whatsmeow.send(gt.whatsapp.activeUserPhone(c),s.message,s.attachments,l.get("extra"),(t=>{t.status?et("<i class='bi-whatsapp'></i> Message Sent to WhatsApp mobile"):et("<i class='bi-send-exclamation'></i> Message could not be sent. Please check your connection. ","warning")}),(t=>{et("<i class='bi-info-circle'></i> Error with WhatsApp API. Please check your connection. ","error")}))}d=SBF.get_value(SBF.admin_set("rate-and-review")["rate-review"]);if(gt.waweb.check(l)){s.message_id;"[rating]"==s.message&&(s.message=d),gt.waweb.send(gt.whatsapp.activeUserPhone(c),s.message,s.attachments,l.get("extra"),(t=>{t.status?et("<i class='bi-whatsapp'></i> Message Sent to WhatsApp mobile"):et("<i class='bi-send-exclamation'></i> Message could not be sent. Please check your connection. ","warning")}),(t=>{et("<i class='bi-info-circle'></i> Error with WhatsApp API. Please check your connection. ","error")}))}gt.telegram.check(l)&&("[rating]"==s.message&&(s.message=d),gt.telegram.send(l.get("extra"),s.message,s.attachments,(t=>{"ok"in t&&t.ok||it(r+" Telegram: "+JSON.stringify(t),"info")}))),gt.twitter.check(l)&&("[rating]"==s.message&&(s.message=d),gt.twitter.send(c.getExtra("twitter-id").value,s.message,s.attachments,(t=>{t&&!("event"in t)?it(JSON.stringify(t),"info"):s.attachments.length>1&&et("Only the first attachment was sent to Twitter.","info")}))),gt.gbm.check(l)&&("[rating]"==s.message&&(s.message=d),gt.gbm.send(c.getExtra("gbm-id").value,s.message,s.attachments,(t=>{t[0]&&"error"in t[0]&&it(r+" Google: "+t[0].error.message,"info")}))),SB_ADMIN_SETTINGS["smart-reply"]&&h.html(""),SB_ADMIN_SETTINGS["assign-conversation-to-agent"]&&SBF.null(l.get("agent_id"))&&St.assignAgent(a,SB_ACTIVE_AGENT.id,(()=>{SBChat.conversation.id==a&&(SBChat.conversation.set("agent_id",SB_ACTIVE_AGENT.id),t(i).find("#conversation-agent > p").attr("data-value",SB_ACTIVE_AGENT.id).html(SB_ACTIVE_AGENT.full_name))}))})),t(document).on("SBNewMessagesReceived",(function(t,e){let s=e.get("payload"),a=i.find(".sb-conversation"),n=SBF.isAgent(e.get("user_type"));if(setTimeout((function(){a.find(".sb-top .sb-status-typing").remove()}),300),SB_ADMIN_SETTINGS["smart-reply"]&&(n?SB_ADMIN_SETTINGS["smart-reply-agent-assistant"]&&gt.dialogflow.smartReplyUpdate(e.message):gt.dialogflow.smartReply(e.message)),_t.must_translate){let t=SBChat.conversation.getMessage(e.id),i=a.find(`[data-id="${e.id}"]`),n="original-message"in s&&s["original-message"];n?(t.set("translation",n),i.replaceWith(t.getCode(!0)),a.find(`[data-id="${e.id}"] .sb-menu`).prepend(`<li data-value="original">${ot("View translation")}</li>`)):e.message&&gt.dialogflow.translate([e.message],SB_ADMIN_SETTINGS["active-agent-language"],(s=>{s&&(t.set("translation",s[0].translatedText),i.replaceWith(t.getCode(!0)),a.find(`[data-id="${e.id}"] .sb-menu`).prepend(`<li data-value="original">${ot("View original message")}</li>`))}))}if("queryResult"in s&&"fulfillmentMessages"in s.queryResult){let t=s.queryResult.fulfillmentMessages;for(var o=0;o<t.length;o++)if("payload"in t[o]){let e=t[o].payload;if("department"in e){St.setActiveDepartment(e.department);break}if("agent"in e){St.setActiveAgent(e.agent);break}}}"ErrorCode"in s&&it("Error. Message not sent to WhatsApp. Error message: "+s.ErrorMessage,"info"),"whatsapp-fallback"in s&&et("Message sent as text message."+("whatsapp-template-fallback"in s?" The user has been notified via WhatsApp Template notification.":"")),"whatsapp-template-fallback"in s&&!("whatsapp-fallback"in s)&&et("The user has been notified via WhatsApp Template notification."),n||SBChat.conversation.id!=e.get("conversation_id")||SBChat.user_online||mt.setActiveUserStatus(),St.update()})),t(document).on("SBNewConversationCreated",(function(){St.update()})),t(document).on("SBEmailSent",(function(){et("The user has been notified by email.")})),t(document).on("SBSMSSent",(function(){et("The user has been notified by text message.")})),t(document).on("SBNotificationsSent",(function(t,e){et(`The user has been notified by email${e.includes("sms")?" and text message":""}.`)})),t(document).on("SBTyping",(function(t,e){St.typing(e)})),t(a).on("input",".sb-search-btn input",(function(){St.search(this)})),t(i).on("click",".sb-admin-list .sb-search-btn i",(function(){SBF.searchClear(this,(()=>{St.search(t(this).next())})),t(".non-hover, .sb-filter-btn").toggleClass("sb-hide"),t("#hideOnSearchClick").toggleClass("sb-hide")})),t(".bi-search").click((function(){t("#hideOnSearchClick li:first-child").toggleClass("sb-invisible").find("div").toggle(),t("#hideOnSearchClick li:nth-child(2)").toggleClass("sb-invisible").css("margin-right",(function(t,e){return"80px"===e?"0px":"80px"}))})),t(i).on("click",".sb-admin-list .sb-select li",(function(){let t=n.parent();nt(t)||setTimeout((()=>{let e=St.filters();U=1,j=1,SBF.ajax({function:"get-conversations",status_code:e[0],department:e[1],agent:SB_ACTIVE_AGENT.id,source:e[2],tag:e[3]},(s=>{if(St.populateList(s),i.find(".sb-conversation").attr("data-conversation-status",e[0]),s.length){if(!P)if(SBChat.conversation){let t=n.find(`[data-conversation-id="${SBChat.conversation.id}"]`);t.length?t.sbActive(!0):e[0]==SBChat.conversation.get("conversation_status_code")&&n.prepend(St.getListCode(SBChat.conversation).replace("<li",'<li class="sb-active"'))}else St.clickFirst(),St.scrollTo()}else i.find(".sb-board").addClass("sb-no-conversation"),SBChat.conversation=!1;t.sbLoading(!1)}))}),100)})),t(i).on("click",".sb-user-details .sb-scroll-area div.sb-profile",(function(){let t=n.find(".sb-active").attr("data-user-id");st().id!=t&&st(G[t]),wt.show(st().id)})),t(e).on("click",'.sb-profile-list [data-id="location"]',(function(){it('<iframe src="https://maps.google.com/maps?q='+t(this).find("label").html().replace(", ","+")+'&output=embed"></iframe>',"map")})),t(e).on("click",'.sb-profile-list [data-id="address"], .sb-profile-list [data-id="city"], .sb-profile-list [data-id="country"]',(function(){let e="",s="",i="";"address"===t(this).data("id")?(e=t(this).find("label").text(),s=t('.sb-profile-list [data-id="city"] label').text(),i=t('.sb-profile-list [data-id="country"] label').text()):"city"===t(this).data("id")?(e=t('.sb-profile-list [data-id="address"] label').text(),s=t(this).find("label").text(),i=t('.sb-profile-list [data-id="country"] label').text()):"country"===t(this).data("id")&&(e=t('.sb-profile-list [data-id="address"] label').text(),s=t('.sb-profile-list [data-id="city"] label').text(),i=t(this).find("label").text()),it(`<iframe src="https://maps.google.com/maps?q=${encodeURIComponent(`${e}, ${s}, ${i}`)}&output=embed"></iframe>`,"map")})),t(e).on("click",'.sb-profile-list [data-id="timezone"]',(function(){SBF.getLocationTimeString(st().extra,(t=>{at(!1),it(t,"info")}))})),t(e).on("click",'.sb-profile-list [data-id="current_url"]',(function(){let e=t(this).find("label");window.open(SBF.null(e.attr("data-value"))?e.html():e.attr("data-value"))})),t(e).on("click",'.sb-profile-list [data-id="conversation-source"]',(function(e){let s=t(this).find("option:selected").html().toLowerCase();("whatsapp"==s||"whatsmeow"==s||"waweb"==s)&&st().getExtra("phone")})),t(i).on("click",'.sb-menu [data-value="bot"]',(function(){gt.dialogflow.showCreateIntentBox(t(this).closest("[data-id]").attr("data-id"))})),t(u).on("click",'.sb-intent-add [data-value="add"]',(function(){u.find("> div > .sb-type-text").last().after('<div class="sb-input-setting sb-type-text"><input type="text"></div>')})),t(u).on("click",'.sb-intent-add [data-value="previous"],.sb-intent-add [data-value="next"]',(function(){let e=u.find(".sb-first input"),s=e.val(),i="next"==t(this).attr("data-value"),a=SBChat.conversation.getUserMessages(),n=a.length;for(var o=0;o<n;o++)if(a[o].message==s&&(i&&o<n-1||!i&&o>0)){o+=i?1:-1,e.val(a[o].message),u.attr("data-message-id",a[o].id);break}})),t(u).on("click",".sb-send",(function(){gt.dialogflow.submitIntent(this)})),t(u).on("input",".sb-search-btn input",(function(){gt.dialogflow.searchIntents(t(this).val())})),t(u).on("click",".sb-search-btn i",(function(){SBF.searchClear(this,(()=>{gt.dialogflow.searchIntents(t(this).val())}))})),t(u).on("click","#sb-intent-preview",(function(){gt.dialogflow.previewIntent(u.find("#sb-intents-select").val())})),t(u).on("change","#sb-intents-select",(function(){u.find(".sb-bot-response").css("opacity",t(this).val()?.5:1)})),t(i).on("click","#conversation-department li",(function(e){let s=t(this).parent().parent();return t(this).data("value")==s.find(" > p").attr("data-value")||(SBChat.conversation?(s.sbLoading()||it(`${ot("All agents assigned to the new department will be notified. The new department will be")} ${t(this).html()}.`,"alert",(()=>{let e=t(this).data("id");s.sbLoading(!0),St.assignDepartment(SBChat.conversation.id,e,(()=>{St.setActiveDepartment(e),s.sbLoading(!1),s.find(" > p").attr("data-value",e)}))})),e.preventDefault(),!1):(t(this).parent().sbActive(!1),e.preventDefault(),!1))})),t(i).on("click","#conversation-agent li",(function(e){let s=t(this).parent().parent(),i=t(this).data("id");return i==s.find(" > p").attr("data-value")||i==SB_ACTIVE_AGENT.id||(SBChat.conversation?(s.sbLoading()||it(`${ot("The new agent will be")} ${t(this).html()}.`,"alert",(()=>{s.sbLoading(!0),St.assignAgent(SBChat.conversation.id,i,(()=>{St.setActiveAgent(i),s.sbLoading(!1)}))})),e.preventDefault(),!1):(t(s).addClass("sb-active sb-responsive-absolute-position"),e.preventDefault(),!1))})),r.on("click","> i",(function(s){return e.find(".sb-notes-box").sbShowLightbox(),t.getScript("https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js").done((()=>{I()})).fail((()=>{t.getScript(STMBX_URL+"/vendor/moment.min.js",(()=>{I()}))})),s.preventDefault(),!1})),r.on("click",".sb-delete-note",(function(){let e=t(this).parents().eq(1);St.notes.delete(SBChat.conversation.id,e.attr("data-id"),(t=>{!0===t?e.remove():SBF.error(t)}))})),r.on("click",".sb-note-contain",(function(){const e=t(this).find(".note-content .more"),s=t(this).find(".note-content .dots");"none"==e.css("display")?e.show():e.hide(),"none"==e.css("display")?s.show():s.hide()})),t(e).on("click",".sb-add-note",(function(){let s=t(this).parent().parents().eq(1).find("textarea"),i=s.val();if(0==i.length)SBForm.showErrorMessage(e.find(".sb-notes-box"),"Please write something...");else{if(nt(this))return;St.notes.add(SBChat.conversation.id,SB_ACTIVE_AGENT.id,SB_ACTIVE_AGENT.full_name,i,(a=>{Number.isInteger(a)?(t(this).sbLoading(!1),e.sbHideLightbox(),St.notes.update([{id:a,conversation_id:SBChat.conversation.id,user_id:SB_ACTIVE_AGENT.id,name:SB_ACTIVE_AGENT.full_name,message:i,alert:t("#alertdate").val(),time_zone:t("#zones").val(),status:!1}],!0),s.val(""),et("New note successfully added."),I()):SBForm.showErrorMessage(a)}))}})),l.on("click","> i",(function(s){let i=t(e).find(".sb-tags-box"),a=i.find(".sb-tags-cnt"),n="",o=SBChat.conversation.details.tags,r='<i id="sb-add-tag" class="bi-plus-lg sb-btn-icon"></i>';for(var l=0;l<o.length;l++)n+=`<span class="sb-active">${o[l]}</span>`;return St.tags.list?a.html(n+St.tags.getAll(o)+r):(i.sbLoading(!0),SBF.ajax({function:"get-tags"},(t=>{St.tags.list=t,a.html(n+St.tags.getAll(o)+r),i.sbLoading(!1)}))),i.sbShowLightbox(),s.preventDefault(),!1})),t(document).on("click","#tags-container.tagged > span",(function(){let e=t(this),s=(e.text(),SBChat.conversation.id);SBF.ajax({function:"update-tags",conversation_id:s,tags:[null]},(s=>{et(!0===s[0]?"The bot is deleting tags in database...":s),!0===s[0]&&(e.remove(),t(".sb-tags-box .sb-tags-cnt span.sb-active").remove())}))})),t(e).on("click",".sb-tags-cnt > span",(function(){t(this).toggleClass("sb-active")})),t(e).on("click","#sb-add-tag",(function(){t('<input type="text">').insertBefore(this)})),t(e).on("click","#sb-save-tags",(function(){if(nt(this))return;let s=e.find(".sb-tags-box").find("span.sb-active,input").map((function(){return t(this).is("span")?t(this).html():t(this).val()})).toArray(),i=SBChat.conversation.id;SBF.ajax({function:"update-tags",conversation_id:i,tags:s},(a=>{if(t(this).sbLoading(!1),St.tags.list=a[1],!0===a[0]&&(St.tags.update(s),SBChat.conversation&&i==SBChat.conversation.id)){let t=St.filters()[3];SBChat.conversation.set("tags",s),t&&!s.includes(t)&&(n.find(`[data-conversation-id="${i}"]`).remove(),St.clickFirst())}e.sbHideLightbox(),et(!0===a[0]?"Tags have been successfully updated.":a)}))})),t(h).on("click","span",(function(){SBChat.insertText(t(this).html()),h.html("")})),t(i).on("click",".sb-list .sb-menu > li",(function(){let e=t(this).closest("[data-id]"),s=e.attr("data-id"),a=SBChat.conversation.getMessage(s).get("user_type"),n=t(this).attr("data-value");switch(n){case"delete":SBChat.user_online?SBF.ajax({function:"update-message",message_id:s,message:"",attachments:[],payload:{event:"delete-message"}},(()=>{SBChat.conversation.deleteMessage(s),e.remove()})):SBChat.deleteMessage(s);break;case"translation":case"original":let t="translation"==n,o=SBF.isAgent(a);e.replaceWith(SBChat.conversation.getMessage(s).getCode(t)),i.find(`[data-id="${s}"] .sb-menu`).prepend(`<li data-value="${t?"original":"translation"}">${ot(o&&!t||!o&&t?"View original message":"View translation")}</li>`)}})),t(i).on("click",".sb-filter-btn i",(function(){t(this).parent().toggleClass("sb-active")})),SBF.getURL("user")&&(s.find(".sb-admin-nav #sb-users").click(),setTimeout((()=>{wt.show(SBF.getURL("user"))}),500)),t(f).on("click","th :checkbox",(function(){f.find("td :checkbox").prop("checked",t(this).prop("checked"))})),t(f).on("click",":checkbox",(function(){let t=p.find('[data-value="delete"]');f.find("td input:checked").length?t.removeAttr("style"):t.hide()})),t(g).on("click","li",(function(){mt.filter(t(this).data("type"))})),t(p).on("input",".sb-search-btn input",(function(){mt.search(this)})),t(p).on("click",".sb-search-btn i",(function(){SBF.searchClear(this,(()=>{mt.search(t(this).next())}))})),t(f).on("click","th:not(:first-child)",(function(){let e=t(this).hasClass("sb-order-asc")?"DESC":"ASC";t(this).toggleClass("sb-order-asc"),t(this).siblings().sbActive(!1),t(this).sbActive(!0),mt.sort(t(this).data("field"),e)})),t(f).parent().on("scroll",(function(){!V&&!mt.search_query&&ct(this,!0)&&O&&(V=!0,p.append('<div class="sb-loading-global sb-loading sb-loading-pagination"></div>'),SBF.ajax({function:"get-users",pagination:q,sorting:mt.sorting,user_types:mt.user_types,search:mt.search_query,extra:mt.table_extra},(t=>{if(setTimeout((()=>{V=!1}),500),O=t.length){let s="";for(var e=0;e<O;e++){let i=new SBUser(t[e],t[e].extra);s+=mt.getRow(i),G[i.id]=i}q++,f.find("tbody").append(s),ct(this,!1,1e3)}p.find(" > .sb-loading-pagination").remove()})))})),t(v).on("click",".sb-delete",(function(){it("This user will be deleted permanently including all linked data, conversations, and messages.","alert",(function(){mt.delete(st().id)}))})),t(f).on("click","td:not(:first-child)",(function(){wt.show(t(this).parent().attr("data-user-id"))})),t(b).on("click",".sb-top-bar .sb-edit",(function(){wt.showEdit(st())})),t(p).on("click",".sb-new-user",(function(){v.addClass("sb-user-new"),v.find(".sb-top-bar .sb-profile span").html(ot("Add new user")),v.find(".sb-top-bar .sb-save").html(`<i class="bi-check-lg"></i>${ot("Add user")}`),v.find("input,select,textara").removeClass("sb-error"),"admin"==SB_ACTIVE_AGENT.user_type&&v.find("#user_type").find("select").html(`<option value="lead">${ot("Lead")}</option><option value="agent">${ot("Agent")}</option><option value="admin">${ot("Admin")}</option>`),wt.clear(v),wt.boxClasses(v),wt.updateRequiredFields("user"),v.sbShowLightbox()})),t(v).on("click",".sb-save",(function(){if(nt(this))return;let a=!!v.hasClass("sb-user-new"),n=v.attr("data-user-id"),o=wt.getAll(v.find(".sb-details")),r=wt.getAll(v.find(".sb-additional-details"));if(wt.errors(v))return wt.showErrorMessage(v,SBF.isAgent(v.find("#user_type :selected").val())?"First name, last name, password and a valid email are required. Minimum password length is 8 characters.":v.hasClass("sb-user-new")?"First name, last name, and a valid email are required.":`First name and last name ${"user"==o.user_type[0]||"lead"==o.user_type[0]?"email":""} are required.`),void t(this).sbLoading(!1);SBF.ajax({function:a?"add-user":"update-user",user_id:n,settings:o,settings_extra:r},(o=>{if(SBF.errorValidation(o,"duplicate-email")||SBF.errorValidation(o,"duplicate-phone"))return wt.showErrorMessage(v,`This ${SBF.errorValidation(o,"duplicate-email")?"email":"phone number"} is already in use.`),void t(this).sbLoading(!1);a&&(n=o,st(new SBUser({id:n}))),st().update((()=>{G[n]=st(),a?(wt.clear(v),mt.update()):(mt.updateRow(st()),i.sbActive()&&St.updateUserDetails(),n==SB_ACTIVE_AGENT.id&&(SBF.loginCookie(o[1]),SB_ACTIVE_AGENT.full_name=st().name,SB_ACTIVE_AGENT.profile_image=st().image,s.find(".sb-account").setProfile())),t(this).sbLoading(!1),v.find(".sb-profile").setProfile(),et(a?"New user added":"User updated"),e.sbHideLightbox()})),SBF.event("SBUserUpdated",{new_user:a,user_id:n})}))})),t(".sb-area-users").on("click","#csv_contacts",(function(){t("#csvimport").click()})),t("#csvimport").on("change",(function(e){var s=new FormData;s.append("csv",this.files[0]),s.append("function","csv-users-add"),event.preventDefault(),t.ajax({url:STMBX_URL+"/include/ajax.php",method:"POST",data:s,dataType:"json",contentType:!1,cache:!1,processData:!1,success:function(e){et(e.success),t("#csvimport").val("")},error:function(e,s,i){SBF.error("csv-users-add",i),t("#csvimport").val("")}})})),t(v).on("change","#user_type",(function(){let e=t(this).find("option:selected").val();wt.boxClasses(v,e),wt.updateRequiredFields(e)})),t(b).on("click",".sb-user-conversations li",(function(){St.open(t(this).attr("data-conversation-id"),t(this).find("[data-user-id]").attr("data-user-id"))})),t(b).on("click",".sb-start-qr-conversation",(function(){St.open(-1,st().id),St.openConversation(-1,st().id),P&&St.mobileOpenConversation()})),t(b).on("click",".sb-start-tk-conversation",(function(){St.open(-1,st().id),St.openConversation(-1,st().id),P&&St.mobileOpenConversation()})),t(b).on("click",".sb-start-conversation",(function(){St.open(-1,st().id),St.openConversation(-1,st().id),P&&St.mobileOpenConversation(),SBChat.sendMessage(-1,!1,!1,!1),e.find(".sb-send-template-box").sbShowLightbox()})),t(b).on("click",".sb-top-bar [data-value]",(function(){St.showDirectMessageBox(t(this).attr("data-value"),[st().id])})),t(p).on("click",".sb-top-bar [data-value]",(function(){let e=t(this).data("value"),s=[];switch(f.find("tr").each((function(){t(this).find('td input[type="checkbox"]').is(":checked")&&s.push(t(this).attr("data-user-id"))})),e){case"message":case"email":case"sms":St.showDirectMessageBox(e,s);break;case"csv":mt.csv();break;case"delete":if(s.includes(SB_ACTIVE_AGENT.id))return et("You cannot delete yourself.","error");it("The bot will delete all selected users and their related data, conversations, and messages permanently.","alert",(()=>{mt.delete(s),t(this).hide(),f.find("th:first-child input").prop("checked",!1)}))}})),t(e).on("change",".sb-select",(function(){console.log("sb-select change event triggered");let e=t(this).val();t(this).closest(".sb-direct-message-box").attr("data-type",e)})),t(e).on("click",".sb-send-direct-message",(function(s){console.log("sb-send-direct-message click event triggered"),s.preventDefault();let i=t(this).closest(".sb-direct-message-box"),a=i.attr("data-type"),n=i.find(".sb-direct-message-subject input").val(),o=i.find("textarea").val(),r=i.find(".sb-direct-message-users").val().replace(/ /g,""),l=null;if(console.log("Type:",a),console.log("Subject:",n),console.log("Message:",o),console.log("User IDs:",r),"template"===a&&(l=(new Metatemplate).payload("#user-template-form"),console.log("Payload:",l)),!nt(this))if("message"==a&&SBF.ajax({function:"direct-message",user_ids:r,message:o},(s=>{t(this).sbLoading(!1);let l=SB_ADMIN_SETTINGS["notify-user-email"],c=SB_ADMIN_SETTINGS["sms-active-users"];if(SBF.errorValidation(s))return SBForm.showErrorMessage(i,"An error has occurred. Please make sure all user ids are correct.");(l||c)&&SBF.ajax({function:"get-users-with-details",user_ids:r,details:l&&c?["email","phone"]:[l?"email":"phone"]},(t=>{l&&t.email.length?X(t.email,o,0,c?t.phone:[],"email",n):c&&t.phone.length?X(t.phone,o,0,[],"sms"):e.sbHideLightbox()})),et(`${SBF.slugToString(a)} sent to all users.`)})),"template"==a)console.log("Sending messages..."),SBF.ajax({function:"direct-message",user_ids:r,message:o,template:"template"===a,payload:l},(s=>{if(console.log("Direct message response:",s),t(this).sbLoading(!1),SBF.errorValidation(s))return console.log("Error validation occurred"),SBForm.showErrorMessage(i,"An error has occurred. Please make sure all user IDs are correct.");if(s.template_phone)return void X(s.template_phone,l.BodyTemplate,0,[],"template");let c=SB_ADMIN_SETTINGS["notify-user-email"],d=SB_ADMIN_SETTINGS["sms-active-users"];(c||d)&&(console.log("Getting users with details..."),SBF.ajax({function:"get-users-with-details",user_ids:r,details:c&&d?["email","phone"]:[c?"email":"phone"]},(t=>{console.log("Users with details response:",t),c&&t.email.length?X(t.email,o,0,d?t.phone:[],"email",n):d&&t.phone.length?X(t.phone,o,0,[],"sms"):e.sbHideLightbox()}))),et(`${SBF.slugToString(a)} sent to all users.`)}));else{console.log("Type is not 'message', getting users with details...");let e="email"==a?"email":"phone";SBF.ajax({function:"get-users-with-details",user_ids:r,details:[e]},(s=>{if(console.log("Users with details response:",s),!s[e].length)return t(this).sbLoading(!1),SBForm.showErrorMessage(i,"No users found.");X(s[e],o,0,[],"email"==a?"custom-email":"sms",n)}))}})),SBF.getURL("setting")&&(s.find(".sb-admin-nav #sb-settings").click(),setTimeout((()=>{m.find("#tab-"+SBF.getURL("setting")).click()}),300)),t(m).on("click"," > .sb-tab > .sb-nav [id]",(function(){let e=t(this).attr("id").substr(4);SBF.getURL("setting")!=e&&dt("?setting="+e)})),t(m).on("click",'[data-type="upload-image"] .image',(function(){A=this,e.find(".sb-upload-form-admin .sb-upload-files").click()})),t(m).on("click",'[data-type="upload-image"] .image > i',(function(e){return t(this).parent().removeAttr("data-value").css("background-image",""),e.preventDefault(),!1})),t(m).on("click",".sb-repeater-add",(function(){bt.repeaterAdd(this)})),t(m).on("click",".repeater-item > i",(function(){bt.repeaterDelete(this)})),bt.initColorPicker(),t(m).find('[data-type="color"]').focusout((function(){let e=t(this).closest(".input-color"),s=e.find("input").val();setTimeout((function(){e.find("input").val(""),e.find(".color-preview").css("background-color",s)}),300),bt.set(t(this).attr("id"),s)})),t(m).on("click",".sb-type-color .input i",(function(e){t(this).parent().find("input").removeAttr("style").val("")})),t(m).on("click",".sb-color-palette span",(function(){let e=t(this).hasClass("sb-active");t(this).closest(".sb-repeater").find(".sb-active").sbActive(!1),t(this).sbActive(!e)})),t(m).on("click",".sb-color-palette ul li",(function(){t(this).parent().parent().attr("data-value",t(this).data("value")).find("span").sbActive(!1)})),t(m).on("click",'[data-type="select-images"] .input > div',(function(){t(this).siblings().sbActive(!1),t(this).sbActive(!0)})),t(m).on("click",".sb-select-checkbox-input",(function(){t(this).toggleClass("sb-active")})),t(m).on("click",".sb-select-checkbox input",(function(){let e=t(this).closest("[data-type]");e.find(".sb-select-checkbox-input").val(bt.get(e)[1].join(", "))})),t(m).on("click",".sb-save-changes",(function(){bt.save(this)})),t(m).on("change",'#user-additional-fields [data-id="extra-field-slug"], #saved-replies [data-id="reply-name"], [data-id="rich-message-name"]',(function(){t(this).val(SBF.stringToSlug(t(this).val()))})),t(m).on("click","#timetable-utc input",(function(){""==t(this).val()&&t(this).val(Math.round(W.getTimezoneOffset()/60))})),t(m).on("click","#test-email-user .sb-btn, #test-email-agent .sb-btn",(function(){let e=t(this).parent().find("input").val();e&&e.indexOf("@")>0&&!nt(this)&&SBF.ajax({function:"send-test-email",to:e,email_type:"test-email-user"==t(this).parent().parent().attr("id")?"user":"agent"},(()=>{it("Email successfully sent. Check your emails!","info"),t(this).sbLoading(!1)}))})),t(m).on("click",".sb-timetable > div > div > div",(function(){let e=t(this).closest(".sb-timetable"),s=t(this).sbActive();if(t(e).find(".sb-active").sbActive(!1),s)t(this).sbActive(!1).find(".sb-custom-select").remove();else{let s=t(e).find("> .sb-custom-select").html();t(e).find(" > div .sb-custom-select").remove(),t(this).append(`<div class="sb-custom-select">${s}</div>`).sbActive(!0)}})),t(m).on("click",".sb-timetable .sb-custom-select span",(function(){let e=[t(this).html(),t(this).attr("data-value")];t(this).closest(".sb-timetable").find("> div > div > .sb-active").html(e[0]).attr("data-value",e[1]),t(this).parent().sbActive(!1)})),t(m).on("click","#system-requirements a",(function(t){let s=e.find(".sb-requirements-box"),i="";return SBF.ajax({function:"system-requirements"},(t=>{for(var e in t)i+=`<div class="sb-input"><span>${ot(SBF.slugToString(e))}</span><div${t[e]?' class="sb-green"':""}>${t[e]?ot("Success"):ot("Error")}</div></div>`;at(!1),s.find(".sb-main").html(i),s.sbShowLightbox()})),s.sbActive(!1),at(!0),t.preventDefault(),!1})),t(m).on("click","#sb-path a",(function(t){return SBF.ajax({function:"path"},(t=>{it(t,"info")})),t.preventDefault(),!1})),t(m).on("click","#delete-leads a",(function(e){return t(this).sbLoading()||it("All leads, including all the linked conversations and messages, will be deleted permanently.","alert",(()=>{t(this).sbLoading(!0),SBF.ajax({function:"delete-leads"},(()=>{it("Leads and conversations successfully deleted.","info"),t(this).sbLoading(!1)}))})),e.preventDefault(),!1})),t(m).on("click","#dialogflow-smart-reply-generate a",(function(e){if(!nt(this))return SBF.ajax({function:"dialogflow-smart-reply-generate-conversations-data"},(e=>{it("Conversations data successfully generated. Folder: "+e,"info"),t(this).sbLoading(!1)})),e.preventDefault(),!1})),t(m).on("click","#sb-export-settings a",(function(e){if(!nt(this))return SBF.ajax({function:"export-settings"},(e=>{window.open(e),it(`${ot("For security reasons, delete the settings file after downloading it. Close this window to automatically delete it. File location:")}<pre>${e}</pre>`,"info",!1,"sb-export-settings-close","Settings exported"),t(this).sbLoading(!1)})),e.preventDefault(),!1})),t(m).on("click","#sb-import-settings a",(function(s){if(!nt(this))return A=this,T=e=>{SBF.ajax({function:"import-settings",file_url:e},(e=>{e?et("Settings successfully imported. Reload the admin area to apply the new settings."):it(e,"info"),t(this).sbLoading(!1)})),T=!1},e.find(".sb-upload-form-admin .sb-upload-files").click(),s.preventDefault(),!1})),t(e).on("click","#sb-export-settings-close .sb-close",(function(){SBF.ajax({function:"delete-file",path:e.find(".sb-dialog-box p pre").html()})})),t(m).on("click","#whatsmeow-go-start .sb-btn",(function(t){Z(t,"start")})),t(m).on("click","#whatsmeow-go-restart .sb-btn",(function(t){Z(t,"restart")})),t(m).on("click","#waweb-go-start .sb-btn",(function(t){Q(t,"start")})),t(m).on("click","#waweb-go-restart .sb-btn",(function(t){Q(t,"restart")})),t(document).ready((function(){t(document).on("click","#get-templates-api .sb-btn",(function(e){e.preventDefault(),t.ajax({type:"GET",url:STMBX_URL+"/include/templates.php",success:function(t){it("Meta's WhatsApp Business API Cloud templates loaded successfully.","info")},error:function(t,e,s){it("Meta Business Manager configuration incomplete. Please provide the Business Manager User ID, save, and retry.","info")}})}))})),t(m).on("click","#whatsapp-twilio-btn .sb-btn, #sms-btn .sb-btn, #wechat-btn .sb-btn, #twitter-callback .sb-btn, #gbm-webhook .sb-btn",(function(e){let s=t(this).closest("[id]").attr("id");return it(`<code style=" margin: auto; word-break: break-word; text-align: center; font-size: .9rem; ">${STMBX_URL+("sms-btn"==s?"/include/api.php":"/apps/"+("wechat-btn"==s?"wechat":"twitter-callback"==s?"twitter":"gbm-webhook"==s?"gbm":"whatsapp")+"/post.php")+ut().replace("&","?")}</code>`,"info"),!1})),t(m).on("click","#telegram-button .sb-btn",(function(e){let s=m.find("#telegram-token input").val().trim();return e.preventDefault(),!(!s||nt(this)||(SBF.ajax({function:"telegram-synchronization",token:s,cloud_token:ut()},(()=>{it("Telegram Synchronization completed.","info"),t(this).sbLoading(!1)})),1))})),t(m).on("click","#whatsapp-test-template .sb-btn",(function(e){e.preventDefault();let s=t(this).parent().find("input").val();if(s&&!nt(this))return SBF.ajax({function:"whatsapp-send-template",phone:s},(e=>{it(e?"error"in e?e.error.message:"Message sent, check your WhatsApp!":e,"info"),t(this).sbLoading(!1)})),!1})),t(m).on("click","#twitter-subscribe .sb-btn",(function(e){return e.preventDefault(),nt(this)||SBF.ajax({function:"twitter-subscribe",cloud_token:ut()},(e=>{it(!0===e?"Synchronization completed.":JSON.stringify(e),"info"),t(this).sbLoading(!1)})),!1})),t(m).on("click","#email-piping-sync a",(function(e){nt(this)||(SBF.ajax({function:"email-piping",force:!0},(e=>{it(!0===e?"Syncronization completed.":e,"info"),t(this).sbLoading(!1)})),e.preventDefault())})),t(m).on("click","#tab-automations",(function(){bt.automations.get((()=>{bt.automations.populate(),at(!1)}),!0),at()})),t(y).on("click",".sb-add-condition",(function(){bt.automations.addCondition()})),t(y).on("change",".sb-condition-1 select",(function(){bt.automations.updateCondition(this)})),t(x).on("click","li",(function(){bt.automations.populate(t(this).data("value"))})),t(B).on("click","li",(function(){bt.automations.show(t(this).attr("data-id"))})),t(y).on("click",".sb-add-automation",(function(){bt.automations.add()})),t(B).on("click","li i",(function(){it("The automation will be deleted permanently.","alert",(()=>{bt.automations.delete(this)}))}));const K=document.getElementById("recordButton"),tt=document.getElementById("stopButton"),rt=document.querySelector(".bi-arrow-up-circle-fill"),lt=document.querySelector(".sb-textarea>textarea");function ht(){setTimeout((()=>{document.querySelector(".bi-arrow-up-circle-fill").classList.remove("sb-hide")}),500)}rt.addEventListener("click",(()=>{K.classList.remove("sb-hide"),setTimeout((()=>{rt.classList.add("sb-hide")}),10)})),lt.addEventListener("input",(()=>{""===lt.value.trim()?rt.classList.add("sb-hide"):(rt.classList.remove("sb-hide"),K.classList.remove("sb-hide"))})),K.addEventListener("click",(()=>{document.querySelector(".bi-mic-fill").classList.add("sb-hide"),ht()})),tt.addEventListener("click",(()=>{document.querySelector(".bi-mic-fill").classList.remove("sb-hide"),ht()})),t(C).on("click",".sb-nav [id]",(function(){let e=t(this).attr("id");vt.active_report=!1,C.find("#sb-date-picker").val(""),C.attr("class","sb-area-reports sb-active sb-report-"+e),vt.initReport(t(this).attr("id")),SBF.getURL("report")!=e&&dt("?report="+e)})),t(C).on("change","#sb-date-picker",(function(){vt.initReport(!1,t(this).val())})),SBF.getURL("report")&&(C.sbActive()||s.find(".sb-admin-nav #sb-reports").click(),setTimeout((()=>{C.find("#"+SBF.getURL("report")).click()}),500)),t(e).on("click",".sb-language-switcher > i",(function(){let s=t(this).parent(),i=s.find("[data-language]").map((function(){return t(this).attr("data-language")})).get(),a=e.find(".sb-languages-box"),n="";for(var o in i.push("en"),SB_LANGUAGE_CODES)i.includes(o)||(n+=`<div data-language="${o}"><img src="${STMBX_URL}/media/flags/${o}.png" />${ot(SB_LANGUAGE_CODES[o])}</div>`);$=s,a.attr("data-source",s.attr("data-source")),a.find(".sb-main").html(n),a.sbShowLightbox()})),t(e).on("click",".sb-language-switcher img",(function(){let e=t(this).parent(),s=e.sbActive(),i=!s&&e.attr("data-language");switch(e.parent().attr("data-source")){case"articles":bt.articles.show(!1,!1,i);break;case"automations":bt.automations.show(!1,i);break;case"settings":let t=e.parent().find("[data-language].sb-active");bt.translations.save(e,s?e.attr("data-language"):!!t.length&&t.attr("data-language")),bt.translations.activate(e,i)}e.siblings().sbActive(!1),e.sbActive(!s)})),t(e).on("click",".sb-language-switcher span > i",(function(){let e=t(this).parent(),s=e.attr("data-language");it(ot("The {T} translation will be deleted.").replace("{T}",ot(SB_LANGUAGE_CODES[s])),"alert",(()=>{switch(e.parent().attr("data-source")){case"articles":bt.articles.deleteTranslation(!1,s),bt.articles.show();break;case"automations":bt.automations.deleteTranslation(!1,s),bt.automations.show();break;case"settings":bt.translations.delete(e,s)}e.remove()}))})),t(e).on("click",".sb-languages-box [data-language]",(function(){let s=t(this).parents().eq(1),i=t(this).attr("data-language");switch(s.attr("data-source")){case"articles":bt.articles.addTranslation(!1,i),bt.articles.show(!1,!1,i);break;case"automations":bt.automations.addTranslation(!1,!1,i),bt.automations.show(!1,i);break;case"settings":bt.translations.add(i)}e.sbHideLightbox()})),t(e).on("click",".sb-lightbox .sb-top-bar .sb-close",(function(){e.sbHideLightbox()})),t(e).on("click",".sb-lightbox .sb-info",(function(){t(this).sbActive(!1)})),t(e).on("click",".sb-dialog-box a",(function(){let s=t(this).closest(".sb-lightbox");t(this).hasClass("sb-confirm")&&F(),1==e.find(".sb-lightbox.sb-active").length&&E.sbActive(!1),_t.open_popup=!1,s.sbActive(!1)})),t(e).on("click",".sb-menu-wide li, .sb-nav li",(function(){t(this).siblings().sbActive(!1),t(this).sbActive(!0)})),t(e).on("click",".sb-nav:not(.sb-nav-only) li:not(.sb-tab-nav-title)",(function(){let e=t(this).closest(".sb-tab"),s=t(e).find(" > .sb-content > div").sbActive(!1).eq(t(this).parent().find("li:not(.sb-tab-nav-title)").index(this));s.sbActive(!0),s.find("textarea").each((function(){t(this).autoExpandTextarea(),t(this).manualExpandTextarea()})),e.find(".sb-scroll-area").scrollTop(0)})),t(e).sbInitTooltips(),t(e).on("click",'[data-button="toggle"]',(function(){let s=e.find("."+t(this).data("show")),i=e.find("."+t(this).data("hide"));s.addClass("sb-show-animation").show(),i.hide(),_t.open_popup=!(!s.hasClass("sb-lightbox")&&!s.hasClass("sb-popup"))&&s})),t(e).on("click",".sb-info-card",(function(){t(this).sbActive(!1)})),t(e).on("change",".sb-upload-form-admin .sb-upload-files",(function(e){t(this).sbUploadFiles((function(e){"success"==(e=JSON.parse(e))[0]?("upload-image"==t(A).closest("[data-type]").data("type")&&t(A).attr("data-value",e[1]).css("background-image",`url("${e[1]}")`),T&&T(e[1])):console.log(e[1])}))})),t(e).on("click",".sb-accordion > div > span",(function(e){let s=t(this).parent(),i=t(s).sbActive();t(e.target).is("span")&&(s.siblings().sbActive(!1),s.sbActive(!i))})),t(e).on("mousedown",(function(s){if(t(_t.open_popup).length){let i=t(_t.open_popup);i.is(s.target)||0!==i.has(s.target).length||["sb-btn-saved-replies","bi-emoji-grin"].includes(t(s.target).attr("class"))||(i.hasClass("sb-popup")?i.sbTogglePopup():i.hasClass("sb-select")?i.find("ul").sbActive(!1):i.hasClass("sb-menu-mobile")?i.find("i").sbActive(!1):i.hasClass("sb-menu")?i.sbActive(!1):e.sbHideLightbox(),_t.open_popup=!1)}}))}))}(jQuery),function(t,e){"object"==typeof exports?module.exports=e(t):"function"==typeof define&&define.amd?define("colors",[],(function(){return e(t)})):t.Colors=e(t)}(this,(function(t,e){function s(t,s,a,n,o){if("string"==typeof s){s=m.txt2color(s);h[a=s.type]=s[a],o=o!==e?o:s.alpha}else if(s)for(var c in s)t[a][c]=r(s[c]/l[a][c][1],0,1);return o!==e&&(t.alpha=r(+o,0,1)),i(a,n?t:e)}function i(t,e){var s,i,r,p=e||h,f=m,g=u.options,b=l,v=p.RND,S="",w="",_={hsl:"hsv",rgb:t},y=v.rgb;if("alpha"!==t){for(var x in b)if(!b[x][x])for(S in t!==x&&(w=_[x]||"rgb",p[x]=f[w+"2"+x](p[w])),v[x]||(v[x]={}),s=p[x])v[x][S]=d(s[S]*b[x][S][1]);y=v.rgb,p.HEX=f.RGB2HEX(y),p.equivalentGrey=g.grey.r*p.rgb.r+g.grey.g*p.rgb.g+g.grey.b*p.rgb.b,p.webSave=i=a(y,51),p.webSmart=r=a(y,17),p.saveColor=y.r===i.r&&y.g===i.g&&y.b===i.b?"web save":y.r===r.r&&y.g===r.g&&y.b===r.b?"web smart":"",p.hueRGB=m.hue2RGB(p.hsv.h),e&&(p.background=(B=y,k=p.rgb,C=p.alpha,A=u.options.grey,(T={}).RGB={r:B.r,g:B.g,b:B.b},T.rgb={r:k.r,g:k.g,b:k.b},T.alpha=C,T.equivalentGrey=d(A.r*B.r+A.g*B.g+A.b*B.b),T.rgbaMixBlack=o(k,{r:0,g:0,b:0},C,1),T.rgbaMixWhite=o(k,{r:1,g:1,b:1},C,1),T.rgbaMixBlack.luminance=n(T.rgbaMixBlack,!0),T.rgbaMixWhite.luminance=n(T.rgbaMixWhite,!0),u.options.customBG&&(T.rgbaMixCustom=o(k,u.options.customBG,C,1),T.rgbaMixCustom.luminance=n(T.rgbaMixCustom,!0),u.options.customBG.luminance=n(u.options.customBG,!0)),T))}var B,k,C,A,T,$,L,F,I,E,M,R,N=p.rgb,D=p.alpha,U="luminance",j=p.background;return($=o(N,{r:0,g:0,b:0},D,1))[U]=n($,!0),p.rgbaMixBlack=$,(L=o(N,{r:1,g:1,b:1},D,1))[U]=n(L,!0),p.rgbaMixWhite=L,g.customBG&&((F=o(N,j.rgbaMixCustom,D,1))[U]=n(F,!0),F.WCAG2Ratio=(I=F[U],E=j.rgbaMixCustom[U],d(100*(I>=E?(I+.05)/(E+.05):(E+.05)/(I+.05)))/100),p.rgbaMixBGMixCustom=F,F.luminanceDelta=c.abs(F[U]-j.rgbaMixCustom[U]),F.hueDelta=(M=j.rgbaMixCustom,R=F,255*(c.max(M.r-R.r,R.r-M.r)+c.max(M.g-R.g,R.g-M.g)+c.max(M.b-R.b,R.b-M.b))/765)),p.RGBLuminance=n(y),p.HUELuminance=n(p.hueRGB),g.convertCallback&&g.convertCallback(p,t),p}function a(t,e){var s={},i=0,a=e/2;for(var n in t)i=t[n]%e,s[n]=t[n]+(i>a?e-i:-i);return s}function n(t,e){for(var s=e?1:255,i=[t.r/s,t.g/s,t.b/s],a=u.options.luminance,n=i.length;n--;)i[n]=i[n]<=.03928?i[n]/12.92:c.pow((i[n]+.055)/1.055,2.4);return a.r*i[0]+a.g*i[1]+a.b*i[2]}function o(t,s,i,a){var n={},o=i!==e?i:1,r=a!==e?a:1,l=o+r*(1-o);for(var c in t)n[c]=(t[c]*o+s[c]*r*(1-o))/l;return n.a=l,n}function r(t,e,s){return t>s?s:e>t?e:t}var l={rgb:{r:[0,255],g:[0,255],b:[0,255]},hsv:{h:[0,360],s:[0,100],v:[0,100]},hsl:{h:[0,360],s:[0,100],l:[0,100]},alpha:{alpha:[0,1]},HEX:{HEX:[0,16777215]}},c=t.Math,d=c.round,u={},h={},p={r:.298954,g:.586434,b:.114612},f={r:.2126,g:.7152,b:.0722},g=function(t){this.colors={RND:{}},this.options={color:"rgba(0,0,0,0)",grey:p,luminance:f,valueRanges:l},b(this,t||{})},b=function(t,i){var a,n=t.options;for(var o in v(t),i)i[o]!==e&&(n[o]=i[o]);a=n.customBG,n.customBG="string"==typeof a?m.txt2color(a).rgb:a,h=s(t.colors,n.color,e,!0)},v=function(t){u!==t&&(u=t,h=t.colors)};g.prototype.setColor=function(t,a,n){return v(this),t?s(this.colors,t,a,e,n):(n!==e&&(this.colors.alpha=r(n,0,1)),i(a))},g.prototype.setCustomBackground=function(t){return v(this),this.options.customBG="string"==typeof t?m.txt2color(t).rgb:t,s(this.colors,e,"rgb")},g.prototype.saveAsBackground=function(){return v(this),s(this.colors,e,"rgb",!0)},g.prototype.toString=function(t,e){return m.color2text((t||"rgb").toLowerCase(),this.colors,e)};var m={txt2color:function(t){var e={},s=t.replace(/(?:#|\)|%)/g,"").split("("),i=(s[1]||"").split(/,\s*/),a=s[1]?s[0].substr(0,3):"rgb",n="";if(e.type=a,e[a]={},s[1])for(var o=3;o--;)n=a[o]||a.charAt(o),e[a][n]=+i[o]/l[a][n][1];else e.rgb=m.HEX2rgb(s[0]);return e.alpha=i[3]?+i[3]:1,e},color2text:function(t,e,s){var i=!1!==s&&d(100*e.alpha)/100,a="number"==typeof i&&!1!==s&&(s||1!==i),n=e.RND.rgb,o=e.RND.hsl,r="hex"===t&&a,l="hex"===t&&!r,c="rgb"===t||r?n.r+", "+n.g+", "+n.b:l?"#"+e.HEX:o.h+", "+o.s+"%, "+o.l+"%";return l?c:(r?"rgb":t)+(a?"a":"")+"("+c+(a?", "+i:"")+")"},RGB2HEX:function(t){return((t.r<16?"0":"")+t.r.toString(16)+(t.g<16?"0":"")+t.g.toString(16)+(t.b<16?"0":"")+t.b.toString(16)).toUpperCase()},HEX2rgb:function(t){return{r:+("0x"+(t=t.split(""))[0]+t[t[3]?1:0])/255,g:+("0x"+t[t[3]?2:1]+(t[3]||t[1]))/255,b:+("0x"+(t[4]||t[2])+(t[5]||t[2]))/255}},hue2RGB:function(t){var e=6*t,s=~~e%6,i=6===e?0:e-s;return{r:d(255*[1,1-i,0,0,i,1][s]),g:d(255*[i,1,1,1-i,0,0][s]),b:d(255*[0,0,i,1,1,1-i][s])}},rgb2hsv:function(t){var e,s,i=t.r,a=t.g,n=t.b,o=0;return n>a&&(a=n+(n=a,0),o=-1),s=n,a>i&&(i=a+(a=i,0),o=-2/6-o,s=c.min(a,n)),e=i-s,{h:1e-15>(i?e/i:0)?h&&h.hsl&&h.hsl.h||0:e?c.abs(o+(a-n)/(6*e)):0,s:i?e/i:h&&h.hsv&&h.hsv.s||0,v:i}},hsv2rgb:function(t){var e=6*t.h,s=t.s,i=t.v,a=~~e,n=e-a,o=i*(1-s),r=i*(1-n*s),l=i*(1-(1-n)*s),c=a%6;return{r:[i,r,o,o,l,i][c],g:[l,i,i,r,o,o][c],b:[o,o,l,i,i,r][c]}},hsv2hsl:function(t){var e=(2-t.s)*t.v,s=t.s*t.v;return s=t.s?1>e?e?s/e:0:s/(2-e):0,{h:t.h,s:t.v||s?s:h&&h.hsl&&h.hsl.s||0,l:e/2}},rgb2hsl:function(t,e){var s=m.rgb2hsv(t);return m.hsv2hsl(e?s:h.hsv=s)},hsl2rgb:function(t){var e=6*t.h,s=t.s,i=t.l,a=.5>i?i*(1+s):i+s-s*i,n=i+i-a,o=~~e,r=a*(a?(a-n)/a:0)*(e-o),l=n+r,c=a-r,d=o%6;return{r:[a,c,n,n,l,a][d],g:[l,a,a,c,n,n][d],b:[n,n,l,a,a,c][d]}}};return g})),function(t,e){"object"==typeof exports?module.exports=e(t,require("jquery"),require("colors")):"function"==typeof define&&define.amd?define(["jquery","colors"],(function(s,i){return e(t,s,i)})):e(t,t.jQuery,t.Colors)}(this,(function(t,e,s,i){function a(t){return t.value||t.getAttribute("value")||e(t).css("background-color")||"#FFF"}function n(t){return(t=t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches[0]:t).originalEvent?t.originalEvent:t}function o(t){return e(t.find(b.doRender)[0]||t[0])}function r(s){var n=e(this),r=n.offset(),c=e(t),d=b.gap;s?((v=o(n))._colorMode=v.data("colorMode"),f.$trigger=n,(m||(e("head")[b.cssPrepend?"prepend":"append"]('<style type="text/css" id="tinyColorPickerStyles">'+(b.css||E)+(b.cssAddon||"")+"</style>"),e(I).css({margin:b.margin}).appendTo("body").show(0,(function(){f.$UI=m=e(this),L=b.GPU&&m.css("perspective")!==i,S=e(".cp-z-slider",this),w=e(".cp-xy-slider",this),_=e(".cp-xy-cursor",this),y=e(".cp-z-cursor",this),x=e(".cp-alpha",this),B=e(".cp-alpha-cursor",this),b.buildCallback.call(f,m),m.prepend("<div>").children().eq(0).css("width",m.children().eq(0).width()),m._width=this.offsetWidth,m._height=this.offsetHeight})).hide())).css(b.positionCallback.call(f,n)||{left:(m._left=r.left)-((m._left+=m._width-(c.scrollLeft()+c.width()))+d>0?m._left+d:0),top:(m._top=r.top+n.outerHeight())-((m._top+=m._height-(c.scrollTop()+c.height()))+d>0?m._top+d:0)}).show(b.animationSpeed,(function(){!0!==s&&(x.toggle(!!b.opacity)._width=x.width(),w._width=w.width(),w._height=w.height(),S._height=S.height(),g.setColor(a(v[0])),h(!0))})).off(".tcp").on(T,".cp-xy-slider,.cp-z-slider,.cp-alpha",l)):f.$trigger&&e(m).hide(b.animationSpeed,(function(){h(!1),f.$trigger=null})).off(".tcp")}function l(t){var s=this.className.replace(/cp-(.*?)(?:\s*|$)/,"$1").replace("-","_");(t.button||t.which)>1||(t.preventDefault&&t.preventDefault(),t.returnValue=!1,v._offset=e(this).offset(),(s="xy_slider"===s?c:"z_slider"===s?d:u)(t),h(),k.on($,(function(){k.off(".tcp")})).on(A,(function(t){s(t),h()})))}function c(t){var e=n(t),s=e.pageX-v._offset.left,i=e.pageY-v._offset.top;g.setColor({s:s/w._width*100,v:100-i/w._height*100},"hsv")}function d(t){var e=n(t).pageY-v._offset.top;g.setColor({h:360-e/S._height*360},"hsv")}function u(t){var e=(n(t).pageX-v._offset.left)/x._width;g.setColor({},"rgb",e)}function h(t){var e=g.colors,s=e.hueRGB,a=(e.RND.rgb,e.RND.hsl,b.dark),n=b.light,o=g.toString(v._colorMode,b.forceAlpha),r=e.HUELuminance>.22?a:n,l=e.rgbaMixBlack.luminance>.22?a:n,c=(1-e.hsv.h)*S._height,d=e.hsv.s*w._width,u=(1-e.hsv.v)*w._height,h=e.alpha*x._width,f=L?"translate3d":"",m=v[0].value,k=v[0].hasAttribute("value")&&""===m&&t!==i;w._css={backgroundColor:"rgb("+s.r+","+s.g+","+s.b+")"},_._css={transform:f+"("+d+"px, "+u+"px, 0)",left:L?"":d,top:L?"":u,borderColor:e.RGBLuminance>.22?a:n},y._css={transform:f+"(0, "+c+"px, 0)",top:L?"":c,borderColor:"transparent "+r},x._css={backgroundColor:"#"+e.HEX},B._css={transform:f+"("+h+"px, 0, 0)",left:L?"":h,borderColor:l+" transparent"},v._css={backgroundColor:k?"":o,color:k?"":e.rgbaMixBGMixCustom.luminance>.22?a:n},v.text=k?"":m!==o?o:"",t!==i?p(t):F(p)}function p(t){w.css(w._css),_.css(_._css),y.css(y._css),x.css(x._css),B.css(B._css),b.doRender&&v.css(v._css),v.text&&v.val(v.text),b.renderCallback.call(f,v,"boolean"==typeof t?t:i)}var f,g,b,v,m,S,w,_,y,x,B,k=e(document),C=e(),A="touchmove.tcp mousemove.tcp pointermove.tcp",T="touchstart.tcp mousedown.tcp pointerdown.tcp",$="touchend.tcp mouseup.tcp pointerup.tcp",L=!1,F=t.requestAnimationFrame||t.webkitRequestAnimationFrame||function(t){t()},I='<div class="cp-color-picker"><div class="cp-z-slider"><div class="cp-z-cursor"></div></div><div class="cp-xy-slider"><div class="cp-white"></div><div class="cp-xy-cursor"></div></div><div class="cp-alpha"><div class="cp-alpha-cursor"></div></div></div>',E=".cp-color-picker{position:absolute;overflow:hidden;padding:6px 6px 0;background-color:#444;color:#bbb;font-family:Arial,Helvetica,sans-serif;font-size: var(--chat-text-size-8);font-weight:400;cursor:default;border-radius:5px}.cp-color-picker>div{position:relative;overflow:hidden}.cp-xy-slider{float:left;height:128px;width:128px;margin-bottom:6px;background:linear-gradient(to right,#FFF,rgba(255,255,255,0))}.cp-white{height:100%;width:100%;background:linear-gradient(rgba(0,0,0,0),#000)}.cp-xy-cursor{position:absolute;top:0;width:10px;height:10px;margin:-5px;border:1px solid #fff;border-radius:100%;box-sizing:border-box}.cp-z-slider{float:right;margin-left:6px;height:128px;width:20px;background:linear-gradient(red 0,#f0f 17%,#00f 33%,#0ff 50%,#0f0 67%,#ff0 83%,red 100%)}.cp-z-cursor{position:absolute;margin-top:-4px;width:100%;border:4px solid #fff;border-color:transparent #fff;box-sizing:border-box}.cp-alpha{clear:both;width:100%;height:16px;margin:6px 0;background:linear-gradient(to right,#444,rgba(0,0,0,0))}.cp-alpha-cursor{position:absolute;margin-left:-4px;height:100%;border:4px solid #fff;border-color:#fff transparent;box-sizing:border-box}",M=function(t){b=(g=this.color=new s(t)).options,f=this};M.prototype={render:h,toggle:r},e.fn.colorPicker=function(s){var i=this,n=function(){};return s=e.extend({animationSpeed:150,GPU:!0,doRender:!0,customBG:"#FFF",opacity:!0,renderCallback:n,buildCallback:n,positionCallback:n,body:document.body,scrollResize:!0,gap:4,dark:"#222",light:"#DDD"},s),!f&&s.scrollResize&&e(t).on("resize.tcp scroll.tcp",(function(){f.$trigger&&f.toggle.call(f.$trigger[0],!0)})),C=C.add(this),this.colorPicker=f||new M(s),this.options=s,e(s.body).off(".tcp").on(T,(function(t){-1===C.add(m).add(e(m).find(t.target)).index(t.target)&&r()})),this.on("focusin.tcp click.tcp",(function(t){f.color.options=e.extend(f.color.options,b=i.options),r.call(this,t)})).on("change.tcp",(function(){g.setColor(this.value||"#FFF"),i.colorPicker.render(!0)})).each((function(){var t=a(this),i=t.split("("),n=o(e(this));n.data("colorMode",i[1]?i[0].substr(0,3):"HEX").attr("readonly",b.preventFocus),s.doRender&&n.css({"background-color":t,color:function(){return g.setColor(t).rgbaMixBGMixCustom.luminance>.22?s.dark:s.light}})}))},e.fn.colorPicker.destroy=function(){e("*").off(".tcp"),f.toggle(!1),C=e()}})),window.addEventListener("load",(function(){initLoadingAnimation()})),document.addEventListener("click",(t=>{if(t.target.classList.contains("settings-button")){let e=t.target.closest(".sb-setting"),s=e.querySelector(".active");s.classList.contains("sb-hide")?(s.classList.remove("sb-hide"),e.querySelector(".input").classList.remove("sb-hide")):(s.classList.add("sb-hide"),e.querySelector(".input").classList.add("sb-hide"))}else if(t.target.classList.contains("sb-revert")){let e=t.target.closest(".sb-setting");e.querySelector(".active").classList.add("sb-hide"),e.querySelector(".input").classList.add("sb-hide")}})),window.onclick=function(t){if(!t.target.matches(".cst-btn")){var e,s=document.getElementsByClassName("cstdown-content");for(e=0;e<s.length;e++){var i=s[e];i.classList.contains("show")&&i.classList.remove("show")}}};